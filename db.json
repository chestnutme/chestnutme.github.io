{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/images/avatar.jpg","path":"images/avatar.jpg","modified":0,"renderable":0},{"_id":"source/images/automaton.png","path":"images/automaton.png","modified":0,"renderable":0},{"_id":"source/images/b-heap2.jpg","path":"images/b-heap2.jpg","modified":0,"renderable":0},{"_id":"source/images/b-heap1.jpg","path":"images/b-heap1.jpg","modified":0,"renderable":0},{"_id":"source/images/bellman-ford.png","path":"images/bellman-ford.png","modified":0,"renderable":0},{"_id":"source/images/bitonic-sorter2.png","path":"images/bitonic-sorter2.png","modified":0,"renderable":0},{"_id":"source/images/comparsion.png","path":"images/comparsion.png","modified":0,"renderable":0},{"_id":"source/images/dag.png","path":"images/dag.png","modified":0,"renderable":0},{"_id":"source/images/fib.jpg","path":"images/fib.jpg","modified":0,"renderable":0},{"_id":"source/images/find-set1.gif","path":"images/find-set1.gif","modified":0,"renderable":0},{"_id":"source/images/dijkstra.png","path":"images/dijkstra.png","modified":0,"renderable":0},{"_id":"source/images/find-set2.gif","path":"images/find-set2.gif","modified":0,"renderable":0},{"_id":"source/images/graph1.png","path":"images/graph1.png","modified":0,"renderable":0},{"_id":"source/images/graph2.png","path":"images/graph2.png","modified":0,"renderable":0},{"_id":"source/images/kmp1.png","path":"images/kmp1.png","modified":0,"renderable":0},{"_id":"source/images/kmp2.png","path":"images/kmp2.png","modified":0,"renderable":0},{"_id":"source/images/lu.png","path":"images/lu.png","modified":0,"renderable":0},{"_id":"source/images/matrix.png","path":"images/matrix.png","modified":0,"renderable":0},{"_id":"source/images/matrix2.png","path":"images/matrix2.png","modified":0,"renderable":0},{"_id":"source/images/matrix3.png","path":"images/matrix3.png","modified":0,"renderable":0},{"_id":"source/images/mst-path.png","path":"images/mst-path.png","modified":0,"renderable":0},{"_id":"source/images/mst.png","path":"images/mst.png","modified":0,"renderable":0},{"_id":"source/images/n-path.png","path":"images/n-path.png","modified":0,"renderable":0},{"_id":"source/images/robin-karp.png","path":"images/robin-karp.png","modified":0,"renderable":0},{"_id":"source/images/string-match1.png","path":"images/string-match1.png","modified":0,"renderable":0},{"_id":"source/images/union.jpg","path":"images/union.jpg","modified":0,"renderable":0},{"_id":"source/images/b-tree.png","path":"images/b-tree.png","modified":0,"renderable":0},{"_id":"source/images/bitonic-sorter.png","path":"images/bitonic-sorter.png","modified":0,"renderable":0},{"_id":"source/images/dag-path.png","path":"images/dag-path.png","modified":0,"renderable":0},{"_id":"source/images/half-cleaner.png","path":"images/half-cleaner.png","modified":0,"renderable":0},{"_id":"source/images/bfs.png","path":"images/bfs.png","modified":0,"renderable":0},{"_id":"source/images/dfs.png","path":"images/dfs.png","modified":0,"renderable":0},{"_id":"source/images/kruskal.png","path":"images/kruskal.png","modified":0,"renderable":0},{"_id":"source/images/merger1.png","path":"images/merger1.png","modified":0,"renderable":0},{"_id":"source/images/merger2.png","path":"images/merger2.png","modified":0,"renderable":0},{"_id":"source/images/prim.png","path":"images/prim.png","modified":0,"renderable":0},{"_id":"source/images/scc.png","path":"images/scc.png","modified":0,"renderable":0},{"_id":"source/images/sorter.png","path":"images/sorter.png","modified":0,"renderable":0},{"_id":"source/images/sortnet.png","path":"images/sortnet.png","modified":0,"renderable":0},{"_id":"source/images/imgs/javaMemArc.png","path":"images/imgs/javaMemArc.png","modified":0,"renderable":0},{"_id":"source/images/imgs/memoryLayoutC.jpg","path":"images/imgs/memoryLayoutC.jpg","modified":0,"renderable":0},{"_id":"source/images/lab4/UStack2.png","path":"images/lab4/UStack2.png","modified":0,"renderable":0},{"_id":"source/images/lab4/UStack3.png","path":"images/lab4/UStack3.png","modified":0,"renderable":0},{"_id":"source/images/lab4/Ustack1.png","path":"images/lab4/Ustack1.png","modified":0,"renderable":0},{"_id":"source/images/lab4/p1.png","path":"images/lab4/p1.png","modified":0,"renderable":0},{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/algolia-search.js","path":"js/src/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/exturl.js","path":"js/src/exturl.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/hook-duoshuo.js","path":"js/src/hook-duoshuo.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","path":"lib/algolia-instant-search/instantsearch.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","path":"lib/canvas-nest/canvas-nest.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/LICENSE","path":"lib/fastclick/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/README.md","path":"lib/fastclick/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/bower.json","path":"lib/fastclick/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","path":"lib/font-awesome/HELP-US-OUT.txt","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/bower.json","path":"lib/font-awesome/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","path":"lib/jquery_lazyload/CONTRIBUTING.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","path":"lib/jquery_lazyload/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","path":"lib/jquery_lazyload/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","path":"lib/jquery_lazyload/jquery.lazyload.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","path":"lib/jquery_lazyload/jquery.scrollstop.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three-waves.min.js","path":"lib/three/three-waves.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/bower.json","path":"lib/velocity/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","path":"lib/velocity/velocity.ui.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery/index.js","path":"lib/jquery/index.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","path":"lib/fancybox/source/blank.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","path":"lib/fancybox/source/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","path":"lib/fancybox/source/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","path":"lib/fancybox/source/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","path":"lib/fancybox/source/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","path":"lib/fancybox/source/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","path":"lib/fancybox/source/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","path":"lib/fastclick/lib/fastclick.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","path":"lib/fastclick/lib/fastclick.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","path":"lib/font-awesome/css/font-awesome.css.map","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","path":"lib/ua-parser-js/dist/ua-parser.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","path":"lib/ua-parser-js/dist/ua-parser.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.js","path":"lib/velocity/velocity.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","path":"lib/fancybox/source/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","path":"lib/fancybox/source/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","path":"lib/font-awesome/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","path":"lib/font-awesome/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","path":"lib/algolia-instant-search/instantsearch.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three.min.js","path":"lib/three/three.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","path":"lib/font-awesome/fonts/fontawesome-webfont.svg","modified":0,"renderable":1}],"Cache":[{"_id":"source/404.html","hash":"d6cd47ba4ab178269d9e7be773e521a3f74a738b","modified":1503718701598},{"_id":"themes/next/.bowerrc","hash":"3228a58ed0ece9f85e1e3136352094080b8dece1","modified":1503718701954},{"_id":"themes/next/.editorconfig","hash":"792fd2bd8174ece1a75d5fd24ab16594886f3a7f","modified":1503718701954},{"_id":"themes/next/.gitattributes","hash":"44bd4729c74ccb88110804f41746fec07bf487d4","modified":1503718701954},{"_id":"themes/next/.gitignore","hash":"5f09fca02e030b7676c1d312cd88ce8fbccf381c","modified":1503718701958},{"_id":"themes/next/.hound.yml","hash":"b76daa84c9ca3ad292c78412603370a367cc2bc3","modified":1503718701958},{"_id":"themes/next/.javascript_ignore","hash":"f9ea3c5395f8feb225a24e2c32baa79afda30c16","modified":1503718701958},{"_id":"themes/next/.jshintrc","hash":"9928f81bd822f6a8d67fdbc909b517178533bca9","modified":1503718701958},{"_id":"themes/next/.stylintrc","hash":"b28e24704a5d8de08346c45286574c8e76cc109f","modified":1503718701962},{"_id":"themes/next/.travis.yml","hash":"c42d9608c8c7fe90de7b1581a8dc3886e90c179e","modified":1503718701962},{"_id":"themes/next/LICENSE","hash":"f293bcfcdc06c0b77ba13570bb8af55eb5c059fd","modified":1503718701962},{"_id":"themes/next/README.en.md","hash":"4ece25ee5f64447cd522e54cb0fffd9a375f0bd4","modified":1503718701962},{"_id":"themes/next/README.md","hash":"500b5606eb6a09c979d16128f8b00f4bf9bc95ac","modified":1503718701966},{"_id":"themes/next/bower.json","hash":"5abc236d9cc2512f5457ed57c1fba76669eb7399","modified":1503718701966},{"_id":"themes/next/_config.yml","hash":"fdaae9b66220f700a0b2573aca58e0c4cdfda27a","modified":1503718701966},{"_id":"themes/next/gulpfile.coffee","hash":"031bffc483e417b20e90eceb6cf358e7596d2e69","modified":1503718701966},{"_id":"themes/next/package.json","hash":"7e87b2621104b39a30488654c2a8a0c6a563574b","modified":1503718701970},{"_id":"source/_posts/6.828-notes.md","hash":"9f8ae03d464915b197d317e0dabc77ffcd1f710c","modified":1503718701606},{"_id":"source/_posts/CLRS-notes.md","hash":"c9f0721f7fa69e3a3f9264ac0015e2e09560e105","modified":1503718701602},{"_id":"source/_posts/CLRS-notes2.md","hash":"86aa5d562b3e1eb15331c315ec49caa52e4b1145","modified":1503718701618},{"_id":"source/_posts/CLRS-notes4.md","hash":"2f35986a09a021cf6a0fd93babe7e0bf78a3822b","modified":1503718701618},{"_id":"source/_posts/CLRS-notes5.md","hash":"181de8d7cf972037a4528227d566576ac3ca6450","modified":1503718701610},{"_id":"source/_posts/CLRS-notes6.md","hash":"8da080300e0463033a843fbbf45507de98f0b525","modified":1503718701614},{"_id":"source/_posts/Linux in play.md","hash":"217a48b6be33117268a5875c69ad85997a482fe0","modified":1527787497806},{"_id":"source/_posts/CLRS-notes3.md","hash":"65c2112887ce643d18b4bba6f79afaa058d0eaf8","modified":1503718701610},{"_id":"source/_posts/cs-update.md","hash":"19abf811198a076c22e79d95d135e93d6449a273","modified":1503718701618},{"_id":"source/_posts/hw1.md","hash":"01cd6ba20b725e7a110809a9e5f906bfc1b2625b","modified":1527783793373},{"_id":"source/_posts/hw2.md","hash":"46f88f1805de1884944a1cb537be362b1842f7b7","modified":1503718701614},{"_id":"source/_posts/hw3.md","hash":"aade1bb2c93c5fe101c6352f45e143f5e0da8e10","modified":1503718701618},{"_id":"source/_posts/hw4.md","hash":"eaae79bec0a0d52c40f58f6e9d555ea4eaa8d8e0","modified":1503718701598},{"_id":"source/_posts/hw5.md","hash":"524fef5136d3f28d2df70587abb28b4e762d05e9","modified":1503718701602},{"_id":"source/_posts/hw6.md","hash":"03c2baeef9ee62099dceb269a4347d77d3a1e9f6","modified":1503718701614},{"_id":"source/_posts/lab0.md","hash":"2fc46422554add487ceecf4b0c1a5569f74f6dd4","modified":1503718701606},{"_id":"source/_posts/lab1.md","hash":"7ac105205b466e5f8b111964c91598a944f5cf38","modified":1503718701606},{"_id":"source/_posts/lab2.md","hash":"e0abaf2ec36e37951ee8c3ffa485e0a130cdd3ef","modified":1503718701622},{"_id":"source/_posts/lab3_part2.md","hash":"624c8c1e0f7c13cf999f59a053440f13a67deb23","modified":1503718701614},{"_id":"source/_posts/lab3_part1.md","hash":"ac4cc747d06aa8decf5351c27b62d588c329da44","modified":1503718701610},{"_id":"source/_posts/lab4.md","hash":"a35026af51828fab9fbd127632eacbde281f4f06","modified":1503718701602},{"_id":"source/_posts/lab4_part23.md","hash":"234ce0fd2d1ba4cdbcdcec24799cbaa92239e104","modified":1503718701606},{"_id":"source/_posts/return.md","hash":"9887e0385f5092295fca1fa0e94f62a4e7a0d962","modified":1523100082486},{"_id":"source/images/avatar.jpg","hash":"9abebba82d1b9d36875818d14c066aaf85c65148","modified":1503718701630},{"_id":"source/images/automaton.png","hash":"6f79ea132a1a14247f5d2fa04b6fc0bd50ef4f69","modified":1503718701670},{"_id":"source/images/b-heap2.jpg","hash":"2810f01713b2b4750e95f692a53f8aa6221338ca","modified":1503718701638},{"_id":"source/images/b-heap1.jpg","hash":"11cb960c0aad9040002b8fb815de8f5c2daa5cec","modified":1503718701634},{"_id":"source/images/bellman-ford.png","hash":"2052caa51949b78cf573dfdccbc0a8fc715a245e","modified":1503718701650},{"_id":"source/images/bitonic-sorter2.png","hash":"9635fd8894bf49a8d2b9b0d9b8dddf9eb08f7128","modified":1503718701658},{"_id":"source/images/comparsion.png","hash":"6ec0050adb25833b8661b1f2528650023bf4169f","modified":1503718701654},{"_id":"source/images/dag.png","hash":"88499953802f73912c247d5e3c413cc463c64d27","modified":1503718701642},{"_id":"source/images/fib.jpg","hash":"b25244a5b62e294806d6e8a69cb97c6937e83600","modified":1503718701630},{"_id":"source/images/find-set1.gif","hash":"d6ef2995c3a9be1d5d4178be58b7449a5b6ca755","modified":1503718701630},{"_id":"source/images/dijkstra.png","hash":"118d3806def1dd2b913f8acf385f02eab7f6b77d","modified":1503718701650},{"_id":"source/images/find-set2.gif","hash":"93d6d46dda4ce12562130f134763fe3eb471134a","modified":1503718701626},{"_id":"source/images/graph1.png","hash":"cd990c4878c9bc4af830a3198f5d21b5ae52594c","modified":1503718701630},{"_id":"source/images/graph2.png","hash":"49d64b08fe605f9c83bef78b52a0d867561c5104","modified":1503718701634},{"_id":"source/images/kmp1.png","hash":"ff85e355401d65df97221ad21e8be05e614eb7dc","modified":1503718701670},{"_id":"source/images/kmp2.png","hash":"66fe36b7a09940562f4fc9793715fd7939a657e2","modified":1503718701670},{"_id":"source/images/lu.png","hash":"36f681b84c3dfa979fcfcfa9729d4ece9ce1c873","modified":1503718701666},{"_id":"source/images/matrix.png","hash":"b8ff8041a8b36b2c5e694e4fe892bd346de1d65d","modified":1503718701662},{"_id":"source/images/matrix2.png","hash":"4e751b8c530ce491c855f9ad36b339b73247d48a","modified":1503718701662},{"_id":"source/images/matrix3.png","hash":"50e3fc0e1d545b1f8a9934c28c6f4c23b0acdb85","modified":1503718701662},{"_id":"source/images/mst-path.png","hash":"1c6f58595a83ba717a9096752a74e288360eacaf","modified":1503718701646},{"_id":"source/images/mst.png","hash":"c052a7d95918fb4abb1510ace6b7bcdbbee7564b","modified":1503718701642},{"_id":"source/images/n-path.png","hash":"b7c3b652f99507899060ce76ea7ebff93427fd6c","modified":1503718701646},{"_id":"source/images/robin-karp.png","hash":"8e477c91210172cebb43aaeffa05ddfc3316f505","modified":1503718701666},{"_id":"source/images/string-match1.png","hash":"5858d374995f4d519eb7009e9622466cb6b0e3f0","modified":1503718701666},{"_id":"source/images/union.jpg","hash":"8c704e662d21467fa9e23898b2f957ad4283e9a5","modified":1503718701638},{"_id":"source/categories/index.md","hash":"3af594c06478b0c6a7186af3e9ae433efc0006af","modified":1503718701626},{"_id":"source/tags/index.md","hash":"784cd51c7b554f427bbc465795dba19f72f6f51a","modified":1503718701622},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"3b5eafd32abb718e56ccf8d1cee0607ad8ce611d","modified":1503718701970},{"_id":"themes/next/.github/ISSUE_TEMPLATE.md","hash":"fdd63b77472612337309eb93ec415a059b90756b","modified":1503718701970},{"_id":"themes/next/languages/de.yml","hash":"306db8c865630f32c6b6260ade9d3209fbec8011","modified":1503718701974},{"_id":"themes/next/languages/default.yml","hash":"4cc6aeb1ac09a58330e494c8771773758ab354af","modified":1503718701974},{"_id":"themes/next/languages/en.yml","hash":"e7def07a709ef55684490b700a06998c67f35f39","modified":1503718701974},{"_id":"themes/next/languages/fr-FR.yml","hash":"24180322c83587a153cea110e74e96eacc3355ad","modified":1503718701978},{"_id":"themes/next/languages/id.yml","hash":"2835ea80dadf093fcf47edd957680973f1fb6b85","modified":1503718701978},{"_id":"themes/next/languages/ja.yml","hash":"1c3a05ab80a6f8be63268b66da6f19da7aa2c638","modified":1503718701978},{"_id":"themes/next/languages/ko.yml","hash":"be150543379150f78329815af427bf152c0e9431","modified":1503718701982},{"_id":"themes/next/languages/pt-BR.yml","hash":"958e49571818a34fdf4af3232a07a024050f8f4e","modified":1503718701982},{"_id":"themes/next/languages/pt.yml","hash":"36c8f60dacbe5d27d84d0e0d6974d7679f928da0","modified":1503718701982},{"_id":"themes/next/languages/ru.yml","hash":"7462c3017dae88e5f80ff308db0b95baf960c83f","modified":1503718701982},{"_id":"themes/next/languages/zh-Hans.yml","hash":"3c0c7dfd0256457ee24df9e9879226c58cb084b5","modified":1503718701986},{"_id":"themes/next/languages/zh-hk.yml","hash":"1c917997413bf566cb79e0975789f3c9c9128ccd","modified":1503718701986},{"_id":"themes/next/languages/zh-tw.yml","hash":"0b2c18aa76570364003c8d1cd429fa158ae89022","modified":1503718701986},{"_id":"themes/next/layout/_layout.swig","hash":"909d68b164227fe7601d82e2303bf574eb754172","modified":1503718701990},{"_id":"themes/next/layout/archive.swig","hash":"b5b59d70fc1563f482fa07afd435752774ad5981","modified":1503718701990},{"_id":"themes/next/layout/index.swig","hash":"427d0b95b854e311ae363088ab39a393bf8fdc8b","modified":1503718701994},{"_id":"themes/next/layout/page.swig","hash":"3727fab9dadb967e9c2204edca787dc72264674a","modified":1503718701994},{"_id":"themes/next/layout/category.swig","hash":"6422d196ceaff4220d54b8af770e7e957f3364ad","modified":1503718701994},{"_id":"themes/next/layout/post.swig","hash":"e2e512142961ddfe77eba29eaa88f4a2ee43ae18","modified":1503718701994},{"_id":"themes/next/layout/schedule.swig","hash":"234dc8c3b9e276e7811c69011efd5d560519ef19","modified":1503718701998},{"_id":"themes/next/layout/tag.swig","hash":"07cf49c49c39a14dfbe9ce8e7d7eea3d4d0a4911","modified":1503718701998},{"_id":"themes/next/scripts/merge-configs.js","hash":"13c8b3a2d9fce06c2488820d9248d190c8100e0a","modified":1503718702098},{"_id":"themes/next/scripts/merge.js","hash":"9130dabe6a674c54b535f322b17d75fe6081472f","modified":1503718702098},{"_id":"themes/next/test/.jshintrc","hash":"19f93d13d1689fe033c82eb2d5f3ce30b6543cc0","modified":1503718702434},{"_id":"themes/next/test/helpers.js","hash":"a1f5de25154c3724ffc24a91ddc576cdbd60864f","modified":1503718702434},{"_id":"themes/next/test/intern.js","hash":"11fa8a4f5c3b4119a179ae0a2584c8187f907a73","modified":1503718702438},{"_id":"source/images/b-tree.png","hash":"f65efadfad7016210184ff003275bce43de4d4e1","modified":1503718701634},{"_id":"source/images/bitonic-sorter.png","hash":"4a770b7ed0c1d3bc129b195837d78b3321eea8e0","modified":1503718701654},{"_id":"source/images/dag-path.png","hash":"8d26ea640b51da474976f18f6c1db7ef4bf32cd0","modified":1503718701650},{"_id":"source/images/half-cleaner.png","hash":"c6a64cfd38d698df214d1b5c990ccfe98c5a948c","modified":1503718701654},{"_id":"source/images/bfs.png","hash":"9b6f3a804ba7dc0a0399755112bd77a875b41bab","modified":1503718701638},{"_id":"source/images/dfs.png","hash":"4f32d19213e3b55c471f5bfdaff21eb2876c3fa1","modified":1503718701638},{"_id":"source/images/kruskal.png","hash":"e0556819081afe44664c72516c28a576102989e3","modified":1503718701646},{"_id":"source/images/merger1.png","hash":"7c2817c3dd25f0a23c8fbe0c0480066083b5d430","modified":1503718701658},{"_id":"source/images/merger2.png","hash":"95118af35d013e089e7c2a33abdf6f3fa7030d7a","modified":1503718701658},{"_id":"source/images/prim.png","hash":"d0aed0c7469a8d306f6d193c4096cf47209b3fdf","modified":1503718701646},{"_id":"source/images/scc.png","hash":"c9ac4c58fe3020416a4a36200cf97b609786f575","modified":1503718701642},{"_id":"source/images/sorter.png","hash":"346d1f8d4155345ace91c9c39a0cd2ad5b9467eb","modified":1503718701662},{"_id":"source/images/sortnet.png","hash":"499bcc93c8fa2b1d72c2d9861dfe3c41994d6fe5","modified":1503718701654},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1503718702110},{"_id":"source/images/imgs/javaMemArc.png","hash":"3bacc204df73c6c609959620ad03eaa2df828450","modified":1527786082824},{"_id":"source/images/imgs/memoryLayoutC.jpg","hash":"0f16b90f76fa7c4a0676ab3e568c6b595a9576a7","modified":1527786082824},{"_id":"source/images/lab4/UStack2.png","hash":"916e53b1f052c9608f7de59d04d4e690042cb8f2","modified":1503718701674},{"_id":"source/images/lab4/UStack3.png","hash":"b4afe0730b4c3dffd9ceef016114c2340eab5e16","modified":1503718701678},{"_id":"source/images/lab4/Ustack1.png","hash":"1133abd46fbbe2e5ec4e61fca1a0d65ee7ac48bd","modified":1503718701674},{"_id":"source/images/lab4/p1.png","hash":"16dd97cc783455efa25ec07555633434924a3a2c","modified":1503718701674},{"_id":"themes/next/layout/_custom/header.swig","hash":"adc83b19e793491b1c6ea0fd8b46cd9f32e592fc","modified":1503718702002},{"_id":"themes/next/layout/_custom/sidebar.swig","hash":"adc83b19e793491b1c6ea0fd8b46cd9f32e592fc","modified":1503718702002},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"5864f5567ba5efeabcf6ea355013c0b603ee07f2","modified":1503718702002},{"_id":"themes/next/layout/_macro/post-copyright.swig","hash":"b16fcbf0efd20c018d7545257a8533c497ea7647","modified":1503718702006},{"_id":"themes/next/layout/_macro/post.swig","hash":"640b431eccbbd27f10c6781f33db5ea9a6e064de","modified":1503718702006},{"_id":"themes/next/layout/_macro/reward.swig","hash":"37e5b7c42ec17b9b6b786c5512bcc481a21c974e","modified":1503718702006},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"911b99ba0445b2c07373128d87a4ef2eb7de341a","modified":1503718702010},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"14e785adeb0e671ba0ff9a553e6f0d8def6c670c","modified":1503718702010},{"_id":"themes/next/layout/_partials/comments.swig","hash":"1c7d3c975e499b9aa3119d6724b030b7b00fc87e","modified":1503718702014},{"_id":"themes/next/layout/_partials/footer.swig","hash":"7172c6053118b7c291a56a7860128a652ae66b83","modified":1503718702014},{"_id":"themes/next/layout/_partials/head.swig","hash":"a0eafe24d1dae30c790ae35612154b3ffbbd5cce","modified":1503718702014},{"_id":"themes/next/layout/_partials/header.swig","hash":"a1ffbb691dfad3eaf2832a11766e58a179003b8b","modified":1503718702014},{"_id":"themes/next/layout/_partials/page-header.swig","hash":"1efd925d34a5d4ba2dc0838d9c86ba911e705fc9","modified":1503718702018},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"9e8e21d194ef44d271b1cca0bc1448c14d7edf4f","modified":1503718702018},{"_id":"themes/next/layout/_partials/search.swig","hash":"9dbd378e94abfcb3f864a5b8dbbf18d212ca2ee0","modified":1503718702018},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"03aaebe9d50f6acb007ec38cc04acd1cfceb404d","modified":1503718702038},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"766b2bdda29523ed6cd8d7aa197f996022f8fd94","modified":1503718702038},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"9de352a32865869e7ed6863db271c46db5853e5a","modified":1503718702042},{"_id":"themes/next/layout/_third-party/duoshuo-hot-articles.swig","hash":"5d4638c46aef65bf32a01681495b62416ccc98db","modified":1503718702050},{"_id":"themes/next/layout/_third-party/exturl.swig","hash":"7c04a42319d728be356746363aff8ea247791d24","modified":1503718702050},{"_id":"themes/next/layout/_third-party/mathjax.swig","hash":"6d25596d6a7c57700d37b607f8d9a62d89708683","modified":1503718702054},{"_id":"themes/next/layout/_third-party/schedule.swig","hash":"22369026c87fc23893c35a7f250b42f3bb1b60f1","modified":1503718702054},{"_id":"themes/next/scripts/tags/button.js","hash":"62e6dbeb53d07627a048132c79630b45d9a8f2cc","modified":1503718702098},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"535fc542781021c4326dec24d8495cbb1387634a","modified":1503718702102},{"_id":"themes/next/scripts/tags/exturl.js","hash":"8d7e60f60779bde050d20fd76f6fdc36fc85e06d","modified":1503718702102},{"_id":"themes/next/scripts/tags/full-image.js","hash":"8eeb3fb89540299bdbb799edfdfdac3743b50596","modified":1503718702102},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"49252824cd53184dc9b97b2f2d87ff28e1b3ef27","modified":1503718702106},{"_id":"themes/next/scripts/tags/note.js","hash":"6752925eedbdb939d8ec4d11bdfb75199f18dd70","modified":1503718702106},{"_id":"themes/next/source/css/main.styl","hash":"20702c48d6053c92c5bcdbc68e8d0ef1369848a0","modified":1503718702254},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"90035272fa31a3f65b3c0e2cb8a633876ef457dc","modified":1503718702110},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1503718702114},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1503718702114},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1503718702114},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1503718702118},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1503718702118},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1503718702118},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1503718702122},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1503718702122},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1503718702126},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1503718702122},{"_id":"themes/next/source/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1503718702126},{"_id":"themes/next/source/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1503718702126},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1503718702126},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1503718702046},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1503718702046},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1503718702258},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1503718702262},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1503718702266},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1503718702310},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1503718702314},{"_id":"source/images/imgs/.git/COMMIT_EDITMSG","hash":"b15ebf7c8916ffacb683fa03de2f703926c07c9f","modified":1527786082824},{"_id":"source/images/imgs/.git/FETCH_HEAD","hash":"0d4dfda2779f0e41e80eb98b5b47a71d4ccf2920","modified":1527786082844},{"_id":"source/images/imgs/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1527786082832},{"_id":"source/images/imgs/.git/config","hash":"4d3b687dd258e4b3ae121844ad6da14f7608be83","modified":1527786082828},{"_id":"source/images/imgs/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1527786082828},{"_id":"source/images/imgs/.git/index","hash":"38d7710c1eda8a0a8063b1b0184b69cd034b204d","modified":1527786082824},{"_id":"themes/next/layout/_partials/head/custom-head.swig","hash":"9e1b9666efa77f4cf8d8261bcfa445a9ac608e53","modified":1503718702022},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"7ce76358411184482bb0934e70037949dd0da8ca","modified":1503718702022},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"2d1075f4cabcb3956b7b84a8e210f5a66f0a5562","modified":1503718702026},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"959b7e04a96a5596056e4009b73b6489c117597e","modified":1503718702026},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"eefe2388ff3d424694045eda21346989b123977c","modified":1503718702030},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"1f1107468aaf03f7d0dcd7eb2b653e2813a675b4","modified":1503718702034},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"23e23dc0f76ef3c631f24c65277adf7ea517b383","modified":1503718702030},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"89c5a5240ecb223acfe1d12377df5562a943fd5d","modified":1503718702034},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"63315fcf210799f894208c9f512737096df84962","modified":1503718702034},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"069d1357c717572256e5cdee09574ebce529cbae","modified":1503718702042},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a44acf9b0d0f44ef3dfc767376a95c984cc127de","modified":1503718702046},{"_id":"themes/next/layout/_third-party/analytics/application-insights.swig","hash":"60426bf73f8a89ba61fb1be2df3ad5398e32c4ef","modified":1503718702058},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"deda6a814ed48debc694c4e0c466f06c127163d0","modified":1503718702058},{"_id":"themes/next/layout/_third-party/analytics/busuanzi-counter.swig","hash":"18e7bef8923d83ea42df6c97405e515a876cede4","modified":1503718702058},{"_id":"themes/next/layout/_third-party/analytics/cnzz-analytics.swig","hash":"8160b27bee0aa372c7dc7c8476c05bae57f58d0f","modified":1503718702062},{"_id":"themes/next/layout/_third-party/analytics/facebook-sdk.swig","hash":"394d008e5e94575280407ad8a1607a028026cbc3","modified":1503718702062},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"5d9943d74cc2e0a91badcf4f755c6de77eab193a","modified":1503718702062},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"3358d11b9a26185a2d36c96049e4340e701646e4","modified":1503718702066},{"_id":"themes/next/layout/_third-party/analytics/lean-analytics.swig","hash":"92dc60821307fc9769bea9b2d60adaeb798342af","modified":1503718702066},{"_id":"themes/next/layout/_third-party/analytics/tencent-analytics.swig","hash":"3658414379e0e8a34c45c40feadc3edc8dc55f88","modified":1503718702066},{"_id":"themes/next/layout/_third-party/analytics/tencent-mta.swig","hash":"a652f202bd5b30c648c228ab8f0e997eb4928e44","modified":1503718702070},{"_id":"themes/next/layout/_third-party/analytics/vkontakte-api.swig","hash":"c3971fd154d781088e1cc665035f8561a4098f4c","modified":1503718702070},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"0e3378f7c39b2b0f69638290873ede6b6b6825c0","modified":1503718702074},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"c316758546dc9ba6c60cb4d852c17ca6bb6d6724","modified":1503718702074},{"_id":"themes/next/layout/_third-party/comments/duoshuo.swig","hash":"a356b2185d40914447fde817eb3d358ab6b3e4c3","modified":1503718702074},{"_id":"themes/next/layout/_third-party/comments/gentie.swig","hash":"03592d1d731592103a41ebb87437fe4b0a4c78ca","modified":1503718702078},{"_id":"themes/next/layout/_third-party/comments/hypercomments.swig","hash":"3e8dc5c6c912628a37e3b5f886bec7b2e5ed14ea","modified":1503718702078},{"_id":"themes/next/layout/_third-party/comments/index.swig","hash":"abb92620197a16ed2c0775edf18a0f044a82256e","modified":1503718702078},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"7240f2e5ec7115f8abbbc4c9ef73d4bed180fdc7","modified":1503718702082},{"_id":"themes/next/layout/_third-party/comments/youyan.swig","hash":"af9dd8a4aed7d06cf47b363eebff48850888566c","modified":1503718702082},{"_id":"themes/next/layout/_third-party/search/index.swig","hash":"c747fb5c6b1f500e8f0c583e44195878b66e4e29","modified":1503718702086},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"f4dbd4c896e6510ded8ebe05394c28f8a86e71bf","modified":1503718702086},{"_id":"themes/next/layout/_third-party/search/tinysou.swig","hash":"cb3a5d36dbe1630bab84e03a52733a46df7c219b","modified":1503718702086},{"_id":"themes/next/layout/_third-party/seo/baidu-push.swig","hash":"c057b17f79e8261680fbae8dc4e81317a127c799","modified":1503718702094},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"328d9a9696cc2ccf59c67d3c26000d569f46344c","modified":1503718702258},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"715d5b40dc52f319fe4bff0325beb874774d9bd9","modified":1503718702262},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"78a83c38f69a8747bb74e420e6c9eeef1ea76525","modified":1503718702266},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"c8d35a6b9e3bff6d8fdb66de853065af9d37562d","modified":1503718702310},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"06f432f328a5b8a9ef0dbd5301b002aba600b4ce","modified":1503718702310},{"_id":"themes/next/source/css/_variables/base.styl","hash":"28a7f84242ca816a6452a0a79669ca963d824607","modified":1503718702314},{"_id":"themes/next/source/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1503718702130},{"_id":"themes/next/source/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1503718702134},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"aab7be0a6e2724b3faa9338db93c19556c559625","modified":1503718702134},{"_id":"themes/next/source/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1503718702134},{"_id":"themes/next/source/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1503718702138},{"_id":"themes/next/source/js/src/motion.js","hash":"269414e84df544a4ccb88519f6abae4943db3c67","modified":1503718702138},{"_id":"themes/next/source/js/src/post-details.js","hash":"af7a417dd1cb02465a7b98211653e7c6192e6d55","modified":1503718702138},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1503718702142},{"_id":"themes/next/source/js/src/utils.js","hash":"e13c9ccf70d593bdf3b8cc1d768f595abd610e6e","modified":1503718702142},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1503718702150},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1503718702154},{"_id":"themes/next/source/lib/fancybox/.bower.json","hash":"cc40a9b11e52348e554c84e4a5c058056f6b7aeb","modified":1503718702154},{"_id":"themes/next/source/lib/fancybox/.gitattributes","hash":"2db21acfbd457452462f71cc4048a943ee61b8e0","modified":1503718702158},{"_id":"themes/next/source/lib/fastclick/.bower.json","hash":"93ebd5b35e632f714dcf1753e1f6db77ec74449b","modified":1503718702186},{"_id":"themes/next/source/lib/fastclick/LICENSE","hash":"dcd5b6b43095d9e90353a28b09cb269de8d4838e","modified":1503718702186},{"_id":"themes/next/source/lib/fastclick/README.md","hash":"1decd8e1adad2cd6db0ab50cf56de6035156f4ea","modified":1503718702190},{"_id":"themes/next/source/lib/fastclick/bower.json","hash":"13379463c7463b4b96d13556b46faa4cc38d81e6","modified":1503718702190},{"_id":"themes/next/source/lib/font-awesome/.bower.json","hash":"a2aaaf12378db56bd10596ba3daae30950eac051","modified":1503718702198},{"_id":"themes/next/source/lib/font-awesome/.gitignore","hash":"69d152fa46b517141ec3b1114dd6134724494d83","modified":1503718702198},{"_id":"themes/next/source/lib/font-awesome/.npmignore","hash":"dcf470ab3a358103bb896a539cc03caeda10fa8b","modified":1503718702198},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1503718702202},{"_id":"themes/next/source/lib/font-awesome/bower.json","hash":"279a8a718ab6c930a67c41237f0aac166c1b9440","modified":1503718702202},{"_id":"themes/next/source/lib/jquery/.bower.json","hash":"91745c2cc6c946c7275f952b2b0760b880cea69e","modified":1503718702222},{"_id":"themes/next/source/lib/jquery_lazyload/.bower.json","hash":"b7638afc93e9cd350d0783565ee9a7da6805ad8e","modified":1503718702226},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","hash":"4891864c24c28efecd81a6a8d3f261145190f901","modified":1503718702226},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","hash":"65bc85d12197e71c40a55c0cd7f6823995a05222","modified":1503718702230},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","hash":"895d50fa29759af7835256522e9dd7dac597765c","modified":1503718702230},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1503718702230},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1503718702234},{"_id":"themes/next/source/lib/three/three-waves.min.js","hash":"5b38ae00297ffc07f433c632c3dbf7bde4cdf39a","modified":1503718702234},{"_id":"themes/next/source/lib/velocity/.bower.json","hash":"05f960846f1c7a93dab1d3f9a1121e86812e8c88","modified":1503718702246},{"_id":"themes/next/source/lib/velocity/bower.json","hash":"2ec99573e84c7117368beccb9e94b6bf35d2db03","modified":1503718702246},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1503718702250},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1503718702250},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1503718702254},{"_id":"themes/next/source/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1503718702222},{"_id":"source/images/imgs/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1527786082832},{"_id":"source/images/imgs/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1527786082832},{"_id":"source/images/imgs/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1527786082832},{"_id":"source/images/imgs/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1527786082832},{"_id":"source/images/imgs/.git/hooks/pre-commit.sample","hash":"36aed8976dcc08b5076844f0ec645b18bc37758f","modified":1527786082832},{"_id":"source/images/imgs/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1527786082832},{"_id":"source/images/imgs/.git/hooks/pre-rebase.sample","hash":"18be3eb275c1decd3614e139f5a311b75f1b0ab8","modified":1527786082832},{"_id":"source/images/imgs/.git/hooks/prepare-commit-msg.sample","hash":"2b6275eda365cad50d167fe3a387c9bc9fedd54f","modified":1527786082832},{"_id":"source/images/imgs/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1527786082832},{"_id":"source/images/imgs/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1527786082832},{"_id":"source/images/imgs/.git/logs/HEAD","hash":"92e416d806992b99a8239a5c56cb501f166d90f4","modified":1527786082828},{"_id":"themes/next/layout/_third-party/search/algolia-search/assets.swig","hash":"28ff4ed6714c59124569ffcbd10f1173d53ca923","modified":1503718702090},{"_id":"themes/next/layout/_third-party/search/algolia-search/dom.swig","hash":"ba698f49dd3a868c95b240d802f5b1b24ff287e4","modified":1503718702090},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"59ad08bcc6fe9793594869ac2b4c525021453e78","modified":1503718702330},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"ef089a407c90e58eca10c49bc47ec978f96e03ba","modified":1503718702330},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"0dfb4b3ba3180d7285e66f270e1d3fa0f132c3d2","modified":1503718702334},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"471f1627891aca5c0e1973e09fbcb01e1510d193","modified":1503718702334},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"a6bb5256be6195e76addbda12f4ed7c662d65e7a","modified":1503718702334},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"711c8830886619d4f4a0598b0cde5499dce50c62","modified":1503718702338},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"dd8a3b22fc2f222ac6e6c05bd8a773fb039169c0","modified":1503718702338},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"2186be20e317505cd31886f1291429cc21f76703","modified":1503718702318},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"7804e31c44717c9a9ddf0f8482b9b9c1a0f74538","modified":1503718702322},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"9c25c75311e1bd4d68df031d3f2ae6d141a90766","modified":1503718702322},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"ece571f38180febaf02ace8187ead8318a300ea7","modified":1503718702326},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"013619c472c7e4b08311c464fcbe9fcf5edde603","modified":1503718702326},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"64f5d56c08d74a338813df1265580ca0cbf0190b","modified":1503718702326},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"c2d079788d6fc2e9a191ccdae94e50d55bf849dc","modified":1503718702270},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"5ae7906dc7c1d9468c7f4b4a6feddddc555797a1","modified":1503718702270},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"38e5df90c8689a71c978fd83ba74af3d4e4e5386","modified":1503718702274},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"b0dcca862cd0cc6e732e33d975b476d744911742","modified":1503718702274},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"fda14bc35be2e1b332809b55b3d07155a833dbf4","modified":1503718702274},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1503718702278},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"9a5581a770af8964064fef7afd3e16963e45547f","modified":1503718702278},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"0efa036a15c18f5abb058b7c0fad1dd9ac5eed4c","modified":1503718702286},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"8829bc556ca38bfec4add4f15a2f028092ac6d46","modified":1503718702290},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"82bbaa6322764779a1ac2e2c8390ce901c7972e2","modified":1503718702290},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1503718702290},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"a0e2030a606c934fb2c5c7373aaae04a1caac4c5","modified":1503718702294},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"c4ed249798296f60bda02351fe6404fb3ef2126f","modified":1503718702298},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"5b93958239d3d2bf9aeaede44eced2434d784462","modified":1503718702302},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"215de948be49bcf14f06d500cef9f7035e406a43","modified":1503718702302},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"2f878213cb24c5ddc18877f6d15ec5c5f57745ac","modified":1503718702302},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"e3e23751d4ad24e8714b425d768cf68e37de7ded","modified":1503718702306},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"69ecd6c97e7cdfd822ac8102b45ad0ede85050db","modified":1503718702306},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"79da92119bc246fe05d1626ac98426a83ec90a94","modified":1503718702146},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1503718702158},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1503718702162},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1503718702162},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1503718702166},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1503718702166},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1503718702166},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1503718702170},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1503718702170},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1503718702170},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1503718702194},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1503718702194},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1503718702206},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1503718702206},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1503718702210},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1503718702242},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1503718702242},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1503718702218},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1503718702218},{"_id":"themes/next/source/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1503718702250},{"_id":"source/images/imgs/.git/objects/70/d5a10003b8e0fb807fb3f3d0fc86a895ebbb0c","hash":"3d339bccd08552243de7644d0f7b16ea68e49608","modified":1527786082840},{"_id":"source/images/imgs/.git/objects/0b/154c63970dad96f7f5b8e09944e7d9d4450a1b","hash":"e61b1b77fdc17bc39ce8d401c375243a8c25ea9c","modified":1527786082840},{"_id":"source/images/imgs/.git/objects/7b/dcd0dbb813369c59294007e950c08507a106f7","hash":"a5bfc3b76e17fe0ee81e6e1d3ba15e19fb288310","modified":1527786082844},{"_id":"source/images/imgs/.git/objects/86/1def8761623a44787b6f9510bda4f539f1cc57","hash":"507eb6742e40ef5010c6b5807c017fa197755b83","modified":1527786082840},{"_id":"source/images/imgs/.git/objects/89/83445eede487f4b11b0a114b7040436be8dd71","hash":"9dedcded8ab0f7c942213c3ff9972623b82f159e","modified":1527786082844},{"_id":"source/images/imgs/.git/objects/8d/60d2eb3c5b3be1776e698362c3c1446bebbf2b","hash":"746cce60203b27e4944eb07a64795741ad95aa2f","modified":1527786082840},{"_id":"source/images/imgs/.git/refs/heads/master","hash":"e76e2c6cfba3ebe1ecf694add500efb8d0b8b8f3","modified":1527786082828},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"8994ffcce84deac0471532f270f97c44fea54dc0","modified":1503718702342},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"ae1ca14e51de67b07dba8f61ec79ee0e2e344574","modified":1503718702346},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d27448f199fc2f9980b601bc22b87f08b5d64dd1","modified":1503718702346},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"8a2421cb9005352905fae9d41a847ae56957247e","modified":1503718702350},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"6c00f6e0978f4d8f9a846a15579963728aaa6a17","modified":1503718702350},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"49c2b2c14a1e7fcc810c6be4b632975d0204c281","modified":1503718702350},{"_id":"themes/next/source/css/_common/components/highlight/diff.styl","hash":"96f32ea6c3265a3889e6abe57587f6e2a2a40dfb","modified":1503718702354},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"740d37f428b8f4574a76fc95cc25e50e0565f45e","modified":1503718702358},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"b76387934fb6bb75212b23c1a194486892cc495e","modified":1503718702358},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"7778920dd105fa4de3a7ab206eeba30b1a7bac45","modified":1503718702362},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"4eff5b252d7b614e500fc7d52c97ce325e57d3ab","modified":1503718702362},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"2039590632bba3943c39319d80ef630af7928185","modified":1503718702366},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"9bf4362a4d0ae151ada84b219d39fbe5bb8c790e","modified":1503718702366},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"a82afbb72d83ee394aedc7b37ac0008a9823b4f4","modified":1503718702366},{"_id":"themes/next/source/css/_common/components/post/post-button.styl","hash":"beccb53dcd658136fb91a0c5678dea8f37d6e0b6","modified":1503718702370},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"8fae54591877a73dff0b29b2be2e8935e3c63575","modified":1503718702374},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"f54367c0feda6986c030cc4d15a0ca6ceea14bcb","modified":1503718702374},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"2cdc094ecf907a02fce25ad4a607cd5c40da0f2b","modified":1503718702374},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"c196401747019d389da09b7a0fe7f27e3a0ec01f","modified":1503718702378},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"387ce23bba52b22a586b2dfb4ec618fe1ffd3926","modified":1503718702378},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"b9a2e76f019a5941191f1263b54aef7b69c48789","modified":1503718702382},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"a5d8617a24d7cb6c5ad91ea621183ca2c0917331","modified":1503718702382},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"e792c8dc41561c96d128e9b421187f1c3dc978a0","modified":1503718702382},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"a352ae5b1f8857393bf770d2e638bf15f0c9585d","modified":1503718702386},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"963105a531403d7aad6d9e5e23e3bfabb8ec065a","modified":1503718702386},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"10251257aceecb117233c9554dcf8ecfef8e2104","modified":1503718702390},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"8c0276883398651336853d5ec0e9da267a00dd86","modified":1503718702390},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"2e7ec9aaa3293941106b1bdd09055246aa3c3dc6","modified":1503718702394},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"920343e41c124221a17f050bbb989494d44f7a24","modified":1503718702394},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"5f6ea57aabfa30a437059bf8352f1ad829dbd4ff","modified":1503718702398},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"9486ddd2cb255227db102d09a7df4cae0fabad72","modified":1503718702398},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"45fa7193435a8eae9960267438750b4c9fa9587f","modified":1503718702398},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"7690b9596ec3a49befbe529a5a2649abec0faf76","modified":1503718702402},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"a2ec22ef4a6817bbb2abe8660fcd99fe4ca0cc5e","modified":1503718702402},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"234facd038f144bd0fe09a31ed1357c5d74c517f","modified":1503718702406},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"3623e7fa4324ec1307370f33d8f287a9e20a5578","modified":1503718702406},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"c2abe4d87148e23e15d49ee225bc650de60baf46","modified":1503718702410},{"_id":"themes/next/source/css/_common/components/tags/exturl.styl","hash":"1b3cc9f4e5a7f6e05b4100e9990b37b20d4a2005","modified":1503718702410},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"b8969e1654eec89a0fd10d88b337fee9cb03cd44","modified":1503718702414},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"4851b981020c5cbc354a1af9b831a2dcb3cf9d39","modified":1503718702414},{"_id":"themes/next/source/css/_common/components/tags/note.styl","hash":"74d0ba86f698165d13402670382a822c8736a556","modified":1503718702414},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"dd310c2d999185e881db007360176ee2f811df10","modified":1503718702418},{"_id":"themes/next/source/css/_common/components/third-party/algolia-search.styl","hash":"fd42777b9125fd8969dc39d4f15473e2b91b4142","modified":1503718702422},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"93b08815c4d17e2b96fef8530ec1f1064dede6ef","modified":1503718702422},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"d4e6d8d7b34dc69994593c208f875ae8f7e8a3ae","modified":1503718702422},{"_id":"themes/next/source/css/_common/components/third-party/duoshuo.styl","hash":"2340dd9b3202c61d73cc708b790fac5adddbfc7f","modified":1503718702426},{"_id":"themes/next/source/css/_common/components/third-party/gentie.styl","hash":"586a3ec0f1015e7207cd6a2474362e068c341744","modified":1503718702426},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"327b5f63d55ec26f7663185c1a778440588d9803","modified":1503718702430},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"42348219db93a85d2ee23cb06cebd4d8ab121726","modified":1503718702430},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"173490e21bece35a34858e8e534cf86e34561350","modified":1503718702430},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"5dc4859c66305f871e56cba78f64bfe3bf1b5f01","modified":1503718702282},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1503718702286},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1503718702298},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1503718702174},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1503718702178},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1503718702178},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1503718702178},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1503718702182},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1503718702182},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1503718702210},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1503718702214},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1503718702218},{"_id":"source/images/imgs/.git/objects/10/8ff377702c1b2a74dd7bb3adcf70f0ae27426c","hash":"8879c0fd8728899699988c54b93a115554019d20","modified":1527786082836},{"_id":"source/images/imgs/.git/objects/b6/4344ef527868c7e6ce2fdc658c45d07981ff2d","hash":"526ab7b42d22ecbd8343d00346e54a1b5415990a","modified":1527786082836},{"_id":"source/images/imgs/.git/objects/da/496304147886e6f1760ad6297c016a73c2f436","hash":"8157d4540a27d85592ea33f95d6bc9136c804488","modified":1527786082836},{"_id":"source/images/imgs/.git/objects/e7/4e16f2c704f850f08d4f01b2d6fefeb2c20a79","hash":"7b7a8b52d27e6e719f03f51f1b7be60f49520b6b","modified":1527786082836},{"_id":"source/images/imgs/.git/logs/refs/heads/master","hash":"92e416d806992b99a8239a5c56cb501f166d90f4","modified":1527786082828},{"_id":"source/images/imgs/.git/refs/remotes/origin/master","hash":"e76e2c6cfba3ebe1ecf694add500efb8d0b8b8f3","modified":1527786082828},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","hash":"9ccc6f8144f54e86df9a3fd33a18368d81cf3a4f","modified":1503718702150},{"_id":"themes/next/source/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1503718702238},{"_id":"source/images/imgs/.git/logs/refs/remotes/origin/master","hash":"5a40a9d462063693747b3c6e64f1c9ead4ba8f54","modified":1527786082828},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1503718702214},{"_id":"public/404.html","hash":"4f3bc02b71136a1de4c2db62412cddbaf7048f72","modified":1527787716931},{"_id":"public/categories/index.html","hash":"740b8478358999a3c0fed4c268bfb1e7831116a2","modified":1527787716932},{"_id":"public/tags/index.html","hash":"7ba4976856084b4d6692918de0ebb05cfca0dac8","modified":1527787716932},{"_id":"public/2018/04/07/return/index.html","hash":"47a11a4070679d06463f4e92a8d36c3b16353830","modified":1527787632469},{"_id":"public/archives/page/2/index.html","hash":"492c00b2baea21375eabcfe82f3317e26daf4717","modified":1527787716933},{"_id":"public/archives/2017/page/2/index.html","hash":"27130bccfa6e6cb3fda4552e4cd45ed998925ff9","modified":1527787716933},{"_id":"public/archives/2017/05/index.html","hash":"69960f886971ec8b37a3c71c3ccf1252ad310453","modified":1527787716933},{"_id":"public/archives/2018/index.html","hash":"8108d86b85d5931e90af719c19e8f60c7ecf62fb","modified":1527787716933},{"_id":"public/archives/2018/04/index.html","hash":"11a1807d243380d4ab43d79c8c8e04d2b0da2273","modified":1527787632469},{"_id":"public/archives/2018/05/index.html","hash":"48e8138048bf9a679e90511e0d5a6e3f6483fd3e","modified":1527787716933},{"_id":"public/tags/os/page/2/index.html","hash":"41e9213e6c54ad941c6f0f4223469a87ec2e2049","modified":1527787716933},{"_id":"public/tags/xv6/page/2/index.html","hash":"88c8411221f64205e968d52577484784d686efbe","modified":1527787716933},{"_id":"public/tags/algorithm/index.html","hash":"5e14096a8b227f7c734b1ffb22773951b687e878","modified":1527787716933},{"_id":"public/tags/data-structure/index.html","hash":"128b19c1437eecd63fec5159f74a8d50adad9dea","modified":1527787716933},{"_id":"public/tags/CS/index.html","hash":"3ba1fc209b66b242cfbf69af8866205c0864ed72","modified":1527787716933},{"_id":"public/tags/misc/index.html","hash":"106effe9892ffd91f09ad662803edc995960299e","modified":1527787632470},{"_id":"public/2017/05/18/CLRS-notes6/index.html","hash":"4809721bffc0cb819ffd2de5fc8f37798b89c291","modified":1527787716933},{"_id":"public/2017/05/13/lab4_part23/index.html","hash":"b3d584cfda4e2b946498c22fec2b8839f52c18fc","modified":1527787716933},{"_id":"public/2017/05/09/CLRS-notes5/index.html","hash":"cc042819c3c8c8f2ec8f406d18728f2086136440","modified":1527787716933},{"_id":"public/2017/05/04/lab4/index.html","hash":"261043f0a9682bc42a0a49653221415a8d1f3129","modified":1527787716934},{"_id":"public/2017/05/02/CLRS-notes4/index.html","hash":"5d22171bcd63c28cbb57cc933502016bd21d4f74","modified":1527787716934},{"_id":"public/2017/04/30/hw6/index.html","hash":"b9332d8a352ce1afa8e06fd61da10e362e76f9cb","modified":1527787716934},{"_id":"public/2017/04/26/lab3_part1/index.html","hash":"87c4d8220f499e4825d37f03261fe641faf3d6fc","modified":1527787716934},{"_id":"public/2017/04/29/lab3_part2/index.html","hash":"5026415b1e7baba159ba48bb0fe4c52772e19b62","modified":1527787716934},{"_id":"public/2017/04/24/hw5/index.html","hash":"a3d92f4fd27d1ee0f22b80b8f24460c0d6991721","modified":1527787716934},{"_id":"public/2017/04/22/CLRS-notes3/index.html","hash":"3faad53a50025a82668f412da7ab942865ae0de7","modified":1527787716934},{"_id":"public/2017/04/21/hw4/index.html","hash":"0f318b84a83b26eede7ed4f3a68ffe29b29460d0","modified":1527787716934},{"_id":"public/2017/04/19/hw3/index.html","hash":"e3e343c6c7c58d2ca3511620da1d1c7121a39043","modified":1527787716934},{"_id":"public/2017/04/18/lab2/index.html","hash":"2831c73acf2e24d52a5b75bd7243073d70549053","modified":1527787716934},{"_id":"public/2017/04/17/CLRS-notes2/index.html","hash":"ceba0c30d7e531009837c757a9946d0901e3d98f","modified":1527787716934},{"_id":"public/2017/04/16/hw2/index.html","hash":"f982fa47d9cf81b78c521a068c0d3b4b6bc78a18","modified":1527787716934},{"_id":"public/2017/04/11/CLRS-notes/index.html","hash":"1656afab3df91841f45ac871fef6f38fd0a0523d","modified":1527787716934},{"_id":"public/2017/04/10/lab1/index.html","hash":"945055a99a540f85de289c8edb7ea5bf4eceed0f","modified":1527787716935},{"_id":"public/2017/04/09/hw1/index.html","hash":"0487ea19c27fc0d04d24b410bbd8cddd20a5b17d","modified":1527787716935},{"_id":"public/2017/04/08/lab0/index.html","hash":"7555b29e95caa0eef99a69591f4ede124fe3761b","modified":1527787716935},{"_id":"public/2017/04/08/6.828-notes/index.html","hash":"be50745cfc6a4828d9f7f7eafdb22a60f9bd566d","modified":1527787716935},{"_id":"public/2017/04/02/cs-update/index.html","hash":"e3028b22a969bbba376d1b8c5e688ce141861da2","modified":1527787716935},{"_id":"public/archives/index.html","hash":"bd3a511d69b3ff506271727af310393795145408","modified":1527787716935},{"_id":"public/archives/2017/index.html","hash":"49afbd91cd1b7f1d7cca995d8f726aba399dc1fc","modified":1527787716935},{"_id":"public/archives/2017/04/index.html","hash":"ba605d9b26fa36f5b0fcf14ef93793591bc7d078","modified":1527787716935},{"_id":"public/index.html","hash":"c801bc5e857e507d478b8dd13e13165733e9d3e6","modified":1527787917360},{"_id":"public/page/2/index.html","hash":"8ae1757e7e114ba83c6efae31ba4f3c46c350eb6","modified":1527787716935},{"_id":"public/page/3/index.html","hash":"5c38d91fb9b43e9ab30b51603bf84efdbdab0610","modified":1527787716935},{"_id":"public/page/4/index.html","hash":"45fd8ae606d5731466b37f30a0ba9b7765688552","modified":1527787716935},{"_id":"public/page/5/index.html","hash":"c8169df2e4198adb5c617b3f48d95396b587bca1","modified":1527787716935},{"_id":"public/tags/os/index.html","hash":"e2c91373ab7555337f67d77f5582c61febdc901e","modified":1527787716935},{"_id":"public/tags/xv6/index.html","hash":"b0661ff7169af6be6f82da61590db9b44dfad5a8","modified":1527787716935},{"_id":"public/2018/05/05/Linux in play/index.html","hash":"be321afc03e9a729b0d3ed5fd9ecfa5f1e98d754","modified":1527787632481},{"_id":"public/tags/Linux/index.html","hash":"d33c6789684e47ddc0cc9d23d9fd003ab8b77b0a","modified":1527787632481},{"_id":"public/images/avatar.jpg","hash":"9abebba82d1b9d36875818d14c066aaf85c65148","modified":1527787632489},{"_id":"public/images/b-heap2.jpg","hash":"2810f01713b2b4750e95f692a53f8aa6221338ca","modified":1527787632489},{"_id":"public/images/b-heap1.jpg","hash":"11cb960c0aad9040002b8fb815de8f5c2daa5cec","modified":1527787632490},{"_id":"public/images/bitonic-sorter2.png","hash":"9635fd8894bf49a8d2b9b0d9b8dddf9eb08f7128","modified":1527787632490},{"_id":"public/images/bellman-ford.png","hash":"2052caa51949b78cf573dfdccbc0a8fc715a245e","modified":1527787632490},{"_id":"public/images/comparsion.png","hash":"6ec0050adb25833b8661b1f2528650023bf4169f","modified":1527787632490},{"_id":"public/images/automaton.png","hash":"6f79ea132a1a14247f5d2fa04b6fc0bd50ef4f69","modified":1527787632490},{"_id":"public/images/dag.png","hash":"88499953802f73912c247d5e3c413cc463c64d27","modified":1527787632490},{"_id":"public/images/fib.jpg","hash":"b25244a5b62e294806d6e8a69cb97c6937e83600","modified":1527787632490},{"_id":"public/images/find-set1.gif","hash":"d6ef2995c3a9be1d5d4178be58b7449a5b6ca755","modified":1527787632490},{"_id":"public/images/find-set2.gif","hash":"93d6d46dda4ce12562130f134763fe3eb471134a","modified":1527787632490},{"_id":"public/images/dijkstra.png","hash":"118d3806def1dd2b913f8acf385f02eab7f6b77d","modified":1527787632490},{"_id":"public/images/graph1.png","hash":"cd990c4878c9bc4af830a3198f5d21b5ae52594c","modified":1527787632490},{"_id":"public/images/graph2.png","hash":"49d64b08fe605f9c83bef78b52a0d867561c5104","modified":1527787632490},{"_id":"public/images/kmp1.png","hash":"ff85e355401d65df97221ad21e8be05e614eb7dc","modified":1527787632491},{"_id":"public/images/kmp2.png","hash":"66fe36b7a09940562f4fc9793715fd7939a657e2","modified":1527787632491},{"_id":"public/images/lu.png","hash":"36f681b84c3dfa979fcfcfa9729d4ece9ce1c873","modified":1527787632491},{"_id":"public/images/matrix.png","hash":"b8ff8041a8b36b2c5e694e4fe892bd346de1d65d","modified":1527787632491},{"_id":"public/images/matrix2.png","hash":"4e751b8c530ce491c855f9ad36b339b73247d48a","modified":1527787632491},{"_id":"public/images/matrix3.png","hash":"50e3fc0e1d545b1f8a9934c28c6f4c23b0acdb85","modified":1527787632491},{"_id":"public/images/mst-path.png","hash":"1c6f58595a83ba717a9096752a74e288360eacaf","modified":1527787632491},{"_id":"public/images/mst.png","hash":"c052a7d95918fb4abb1510ace6b7bcdbbee7564b","modified":1527787632491},{"_id":"public/images/n-path.png","hash":"b7c3b652f99507899060ce76ea7ebff93427fd6c","modified":1527787632491},{"_id":"public/images/robin-karp.png","hash":"8e477c91210172cebb43aaeffa05ddfc3316f505","modified":1527787632491},{"_id":"public/images/string-match1.png","hash":"5858d374995f4d519eb7009e9622466cb6b0e3f0","modified":1527787632491},{"_id":"public/images/union.jpg","hash":"8c704e662d21467fa9e23898b2f957ad4283e9a5","modified":1527787632491},{"_id":"public/images/lab4/UStack2.png","hash":"916e53b1f052c9608f7de59d04d4e690042cb8f2","modified":1527787632491},{"_id":"public/images/lab4/UStack3.png","hash":"b4afe0730b4c3dffd9ceef016114c2340eab5e16","modified":1527787632491},{"_id":"public/images/lab4/Ustack1.png","hash":"1133abd46fbbe2e5ec4e61fca1a0d65ee7ac48bd","modified":1527787632491},{"_id":"public/images/lab4/p1.png","hash":"16dd97cc783455efa25ec07555633434924a3a2c","modified":1527787632492},{"_id":"public/images/algolia_logo.svg","hash":"90035272fa31a3f65b3c0e2cb8a633876ef457dc","modified":1527787632492},{"_id":"public/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1527787632492},{"_id":"public/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1527787632492},{"_id":"public/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1527787632492},{"_id":"public/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1527787632492},{"_id":"public/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1527787632492},{"_id":"public/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1527787632492},{"_id":"public/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1527787632492},{"_id":"public/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1527787632492},{"_id":"public/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1527787632492},{"_id":"public/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1527787632492},{"_id":"public/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1527787632492},{"_id":"public/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1527787632492},{"_id":"public/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1527787632492},{"_id":"public/lib/fastclick/LICENSE","hash":"dcd5b6b43095d9e90353a28b09cb269de8d4838e","modified":1527787632492},{"_id":"public/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1527787632493},{"_id":"public/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1527787632493},{"_id":"public/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1527787632493},{"_id":"public/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1527787632493},{"_id":"public/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1527787632493},{"_id":"public/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1527787632493},{"_id":"public/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1527787632493},{"_id":"public/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1527787632493},{"_id":"public/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1527787632493},{"_id":"public/images/imgs/javaMemArc.png","hash":"3bacc204df73c6c609959620ad03eaa2df828450","modified":1527787632493},{"_id":"public/images/imgs/memoryLayoutC.jpg","hash":"0f16b90f76fa7c4a0676ab3e568c6b595a9576a7","modified":1527787632493},{"_id":"public/images/b-tree.png","hash":"f65efadfad7016210184ff003275bce43de4d4e1","modified":1527787632935},{"_id":"public/images/dag-path.png","hash":"8d26ea640b51da474976f18f6c1db7ef4bf32cd0","modified":1527787632935},{"_id":"public/images/bitonic-sorter.png","hash":"4a770b7ed0c1d3bc129b195837d78b3321eea8e0","modified":1527787632941},{"_id":"public/images/half-cleaner.png","hash":"c6a64cfd38d698df214d1b5c990ccfe98c5a948c","modified":1527787632941},{"_id":"public/images/bfs.png","hash":"9b6f3a804ba7dc0a0399755112bd77a875b41bab","modified":1527787632941},{"_id":"public/images/dfs.png","hash":"4f32d19213e3b55c471f5bfdaff21eb2876c3fa1","modified":1527787632942},{"_id":"public/images/kruskal.png","hash":"e0556819081afe44664c72516c28a576102989e3","modified":1527787632942},{"_id":"public/images/merger1.png","hash":"7c2817c3dd25f0a23c8fbe0c0480066083b5d430","modified":1527787632942},{"_id":"public/images/merger2.png","hash":"95118af35d013e089e7c2a33abdf6f3fa7030d7a","modified":1527787632942},{"_id":"public/images/prim.png","hash":"d0aed0c7469a8d306f6d193c4096cf47209b3fdf","modified":1527787632942},{"_id":"public/images/sorter.png","hash":"346d1f8d4155345ace91c9c39a0cd2ad5b9467eb","modified":1527787632942},{"_id":"public/images/scc.png","hash":"c9ac4c58fe3020416a4a36200cf97b609786f575","modified":1527787632942},{"_id":"public/images/sortnet.png","hash":"499bcc93c8fa2b1d72c2d9861dfe3c41994d6fe5","modified":1527787632942},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1527787632942},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1527787632942},{"_id":"public/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1527787632950},{"_id":"public/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1527787632951},{"_id":"public/js/src/bootstrap.js","hash":"aab7be0a6e2724b3faa9338db93c19556c559625","modified":1527787632951},{"_id":"public/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1527787632951},{"_id":"public/js/src/motion.js","hash":"269414e84df544a4ccb88519f6abae4943db3c67","modified":1527787632951},{"_id":"public/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1527787632951},{"_id":"public/js/src/utils.js","hash":"e13c9ccf70d593bdf3b8cc1d768f595abd610e6e","modified":1527787632952},{"_id":"public/js/src/post-details.js","hash":"af7a417dd1cb02465a7b98211653e7c6192e6d55","modified":1527787632952},{"_id":"public/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1527787632952},{"_id":"public/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1527787632952},{"_id":"public/lib/fastclick/bower.json","hash":"4dcecf83afddba148464d5339c93f6d0aa9f42e9","modified":1527787632952},{"_id":"public/lib/font-awesome/bower.json","hash":"64394a2a9aa00f8e321d8daa5e51a420f0e96dad","modified":1527787632952},{"_id":"public/lib/jquery_lazyload/bower.json","hash":"ae3c3b61e6e7f9e1d7e3585ad854380ecc04cf53","modified":1527787632952},{"_id":"public/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1527787632952},{"_id":"public/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1527787632952},{"_id":"public/lib/velocity/bower.json","hash":"0ef14e7ccdfba5db6eb3f8fc6aa3b47282c36409","modified":1527787632952},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1527787632952},{"_id":"public/js/src/schemes/pisces.js","hash":"79da92119bc246fe05d1626ac98426a83ec90a94","modified":1527787632952},{"_id":"public/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1527787632952},{"_id":"public/lib/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1527787632952},{"_id":"public/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1527787632952},{"_id":"public/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1527787632952},{"_id":"public/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1527787632953},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1527787632953},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1527787632953},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1527787632953},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1527787632953},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1527787632953},{"_id":"public/lib/fastclick/README.html","hash":"da3c74d484c73cc7df565e8abbfa4d6a5a18d4da","modified":1527787632953},{"_id":"public/lib/jquery_lazyload/CONTRIBUTING.html","hash":"a6358170d346af13b1452ac157b60505bec7015c","modified":1527787632953},{"_id":"public/lib/jquery_lazyload/README.html","hash":"bde24335f6bc09d8801c0dcd7274f71b466552bd","modified":1527787632953},{"_id":"public/css/main.css","hash":"39392a9d310f5ce3862f1163ffb9e6f5d0177bf2","modified":1527787632954},{"_id":"public/lib/three/three-waves.min.js","hash":"5b38ae00297ffc07f433c632c3dbf7bde4cdf39a","modified":1527787632954},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1527787632954},{"_id":"public/lib/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1527787632954},{"_id":"public/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1527787632954},{"_id":"public/lib/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1527787632954},{"_id":"public/lib/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1527787632954},{"_id":"public/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1527787632954},{"_id":"public/lib/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1527787632954},{"_id":"public/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1527787632954},{"_id":"public/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1527787632954},{"_id":"public/lib/algolia-instant-search/instantsearch.min.js","hash":"9ccc6f8144f54e86df9a3fd33a18368d81cf3a4f","modified":1527787632955},{"_id":"public/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1527787632955},{"_id":"public/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1527787632955},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1527787632955},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1527787632955},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1527787632970},{"_id":"source/_posts/go internal: memory model.md","hash":"51ce28d5486d70d58896f979cfd2a3fd067596dc","modified":1527788104875},{"_id":"public/tags/go/index.html","hash":"68fe64a6043f9090d944ee3d4b5adfc2b0157068","modified":1527787716938},{"_id":"public/2018/05/31/go internal: memory model/index.html","hash":"f8b626d100d34f3896e3754e234465905541c08b","modified":1527788113278}],"Category":[],"Data":[],"Page":[{"_content":"<!DOCTYPE HTML>\n<html>\n<head>\n  <meta http-equiv=\"content-type\" content=\"text/html;charset=utf-8;\"/>\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\" />\n  <meta name=\"robots\" content=\"all\" />\n  <meta name=\"robots\" content=\"index,follow\"/>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"https://qzone.qq.com/gy/404/style/404style.css\">\n</head>\n<body>\n  <script type=\"text/plain\" src=\"http://www.qq.com/404/search_children.js\"\n          charset=\"utf-8\" homePageUrl=\"/\"\n          homePageName=\"\">\n  </script>\n  <script src=\"https://qzone.qq.com/gy/404/data.js\" charset=\"utf-8\"></script>\n  <script src=\"https://qzone.qq.com/gy/404/page.js\" charset=\"utf-8\"></script>\n</body>\n</html>","source":"404.html","raw":"<!DOCTYPE HTML>\n<html>\n<head>\n  <meta http-equiv=\"content-type\" content=\"text/html;charset=utf-8;\"/>\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\" />\n  <meta name=\"robots\" content=\"all\" />\n  <meta name=\"robots\" content=\"index,follow\"/>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"https://qzone.qq.com/gy/404/style/404style.css\">\n</head>\n<body>\n  <script type=\"text/plain\" src=\"http://www.qq.com/404/search_children.js\"\n          charset=\"utf-8\" homePageUrl=\"/\"\n          homePageName=\"\">\n  </script>\n  <script src=\"https://qzone.qq.com/gy/404/data.js\" charset=\"utf-8\"></script>\n  <script src=\"https://qzone.qq.com/gy/404/page.js\" charset=\"utf-8\"></script>\n</body>\n</html>","date":"2017-08-26T03:38:21.598Z","updated":"2017-08-26T03:38:21.598Z","path":"404.html","title":"","comments":1,"layout":"page","_id":"cjhutb3b40000s7amjcclhiv0","content":"<!DOCTYPE HTML>\n<html>\n<head>\n  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta http-equiv=\"content-type\" content=\"text/html;charset=utf-8;\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\">\n  <meta name=\"robots\" content=\"all\">\n  <meta name=\"robots\" content=\"index,follow\">\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"https://qzone.qq.com/gy/404/style/404style.css\"><!-- hexo-inject:begin --><!-- hexo-inject:end -->\n</head>\n<body>\n  <!-- hexo-inject:begin --><!-- hexo-inject:end --><script type=\"text/plain\" src=\"http://www.qq.com/404/search_children.js\" charset=\"utf-8\" homepageurl=\"/\" homepagename=\"\">\n  </script>\n  <script src=\"https://qzone.qq.com/gy/404/data.js\" charset=\"utf-8\"></script>\n  <script src=\"https://qzone.qq.com/gy/404/page.js\" charset=\"utf-8\"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->\n</body>\n</html>","site":{"data":{}},"excerpt":"","more":"<!DOCTYPE HTML>\n<html>\n<head>\n  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta http-equiv=\"content-type\" content=\"text/html;charset=utf-8;\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\">\n  <meta name=\"robots\" content=\"all\">\n  <meta name=\"robots\" content=\"index,follow\">\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"https://qzone.qq.com/gy/404/style/404style.css\"><!-- hexo-inject:begin --><!-- hexo-inject:end -->\n</head>\n<body>\n  <!-- hexo-inject:begin --><!-- hexo-inject:end --><script type=\"text/plain\" src=\"http://www.qq.com/404/search_children.js\" charset=\"utf-8\" homepageurl=\"/\" homepagename=\"\">\n  </script>\n  <script src=\"https://qzone.qq.com/gy/404/data.js\" charset=\"utf-8\"></script>\n  <script src=\"https://qzone.qq.com/gy/404/page.js\" charset=\"utf-8\"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->\n</body>\n</html>"},{"title":"","date":"2017-04-21T09:11:35.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: \ndate: 2017-04-21 17:11:35\ntype: \"categories\"\n---\n","updated":"2017-08-26T03:38:21.626Z","path":"categories/index.html","comments":1,"layout":"page","_id":"cjhutb3gg0002s7ambe0zt258","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"","date":"2017-04-21T09:10:29.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: \ndate: 2017-04-21 17:10:29\ntype: \"tags\"\n---\n","updated":"2017-08-26T03:38:21.622Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cjhutb3gi0004s7amd3z49xw2","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"MIT-6.828-notes","date":"2017-04-07T16:00:00.000Z","_content":"\n# MIT 6.828\n\n### \nMIT[6.828 Operating System Engineering](https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-828-operating-system-engineering-fall-2012/index.htm) os,2006MITSixth Edition Unix(V6)os,ucorexv6[Operating Systems Concepts](https://book.douban.com/subject/10076960/)ospeojectos,6.828.\n\n### \n> 1. os, kernel\n> 2. C\n> 3. ,\n\n### \n\n6.828:\n> * xv6 -> \n> * JOS -> lab\n\n,\n> * note x: xv6\n> * lab x:  project\n> * hw x:   homework\n\n### :\n#### Lab:\n> * lab 0: [](https://chestnutme.github.io/2017/04/08/lab0/)\n> * lab 1: [pc](https://chestnutme.github.io/2017/04/10/lab1/)\n> * lab 2: [](https://chestnutme.github.io/2017/04/18/lab2/)\n> * lab 3: \n>> * [Part1](https://chestnutme.github.io/2017/04/26/lab3-part1)\n>> * [Part2](https://chestnutme.github.io/2017/04/29/lab3-part2)\n>> *\n#### Homework:\n> * hw1: [boot xv6](https://chestnutme.github.io/2017/04/09/hw1/)\n> * hw2: [shell](https://chestnutme.github.io/2017/04/16/hw2/)\n> * hw3: [system call](https://chestnutme.github.io/2017/04/19/hw3/)\n> * hw4: [lazy page allocation](https://chestnutme.github.io/2017/04/21/hw4/)\n> * hw5: [cpu alarm](https://chestnutme.github.io/2017/04/24/hw5/)\n#### Note\n> * note 1: [chapter0](https://chestnutme.github.io/2017/04/16/note1/)\n### \n> 1. [MIT 6.868](https://pdos.csail.mit.edu/6.828/2016/schedule.html), 2016, (lecture video).\n> 2. [OCW](https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-828-operating-system-engineering-fall-2012/index.htm) MIT,2012.\n> 3. [ on youtube](https://www.youtube.com/watch?v=kDRHsNauoxk&list=PLfciLKR3SgqNJKKIKUliWoNBBH1VHL3AP)\n","source":"_posts/6.828-notes.md","raw":"title: MIT-6.828-notes\ndate: 2017/04/08\ntags:\n\t- os\n\t- xv6\n\n---\n\n# MIT 6.828\n\n### \nMIT[6.828 Operating System Engineering](https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-828-operating-system-engineering-fall-2012/index.htm) os,2006MITSixth Edition Unix(V6)os,ucorexv6[Operating Systems Concepts](https://book.douban.com/subject/10076960/)ospeojectos,6.828.\n\n### \n> 1. os, kernel\n> 2. C\n> 3. ,\n\n### \n\n6.828:\n> * xv6 -> \n> * JOS -> lab\n\n,\n> * note x: xv6\n> * lab x:  project\n> * hw x:   homework\n\n### :\n#### Lab:\n> * lab 0: [](https://chestnutme.github.io/2017/04/08/lab0/)\n> * lab 1: [pc](https://chestnutme.github.io/2017/04/10/lab1/)\n> * lab 2: [](https://chestnutme.github.io/2017/04/18/lab2/)\n> * lab 3: \n>> * [Part1](https://chestnutme.github.io/2017/04/26/lab3-part1)\n>> * [Part2](https://chestnutme.github.io/2017/04/29/lab3-part2)\n>> *\n#### Homework:\n> * hw1: [boot xv6](https://chestnutme.github.io/2017/04/09/hw1/)\n> * hw2: [shell](https://chestnutme.github.io/2017/04/16/hw2/)\n> * hw3: [system call](https://chestnutme.github.io/2017/04/19/hw3/)\n> * hw4: [lazy page allocation](https://chestnutme.github.io/2017/04/21/hw4/)\n> * hw5: [cpu alarm](https://chestnutme.github.io/2017/04/24/hw5/)\n#### Note\n> * note 1: [chapter0](https://chestnutme.github.io/2017/04/16/note1/)\n### \n> 1. [MIT 6.868](https://pdos.csail.mit.edu/6.828/2016/schedule.html), 2016, (lecture video).\n> 2. [OCW](https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-828-operating-system-engineering-fall-2012/index.htm) MIT,2012.\n> 3. [ on youtube](https://www.youtube.com/watch?v=kDRHsNauoxk&list=PLfciLKR3SgqNJKKIKUliWoNBBH1VHL3AP)\n","slug":"6.828-notes","published":1,"updated":"2017-08-26T03:38:21.606Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3g90001s7ambo7063nd","content":"<h1 id=\"MIT-6-828\"><a href=\"#MIT-6-828\" class=\"headerlink\" title=\"MIT 6.828\"></a>MIT 6.828</h1><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>MIT<a href=\"https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-828-operating-system-engineering-fall-2012/index.htm\" target=\"_blank\" rel=\"noopener\">6.828 Operating System Engineering</a> os,2006MITSixth Edition Unix(V6)os,ucorexv6<a href=\"https://book.douban.com/subject/10076960/\" target=\"_blank\" rel=\"noopener\">Operating Systems Concepts</a>ospeojectos,6.828.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<ol>\n<li>os, kernel</li>\n<li>C</li>\n<li>,</li>\n</ol>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>6.828:</p>\n<blockquote>\n<ul>\n<li>xv6 -&gt; </li>\n<li>JOS -&gt; lab</li>\n</ul>\n</blockquote>\n<p>,</p>\n<blockquote>\n<ul>\n<li>note x: xv6</li>\n<li>lab x:  project</li>\n<li>hw x:   homework</li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\":\"></a>:</h3><h4 id=\"Lab\"><a href=\"#Lab\" class=\"headerlink\" title=\"Lab:\"></a>Lab:</h4><blockquote>\n<ul>\n<li>lab 0: <a href=\"https://chestnutme.github.io/2017/04/08/lab0/\" target=\"_blank\" rel=\"noopener\"></a></li>\n<li>lab 1: <a href=\"https://chestnutme.github.io/2017/04/10/lab1/\" target=\"_blank\" rel=\"noopener\">pc</a></li>\n<li>lab 2: <a href=\"https://chestnutme.github.io/2017/04/18/lab2/\" target=\"_blank\" rel=\"noopener\"></a></li>\n<li>lab 3: <blockquote>\n<ul>\n<li><a href=\"https://chestnutme.github.io/2017/04/26/lab3-part1\" target=\"_blank\" rel=\"noopener\">Part1</a></li>\n<li><a href=\"https://chestnutme.github.io/2017/04/29/lab3-part2\" target=\"_blank\" rel=\"noopener\">Part2</a><br>*</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<h4 id=\"Homework\"><a href=\"#Homework\" class=\"headerlink\" title=\"Homework:\"></a>Homework:</h4><blockquote>\n<ul>\n<li>hw1: <a href=\"https://chestnutme.github.io/2017/04/09/hw1/\" target=\"_blank\" rel=\"noopener\">boot xv6</a></li>\n<li>hw2: <a href=\"https://chestnutme.github.io/2017/04/16/hw2/\" target=\"_blank\" rel=\"noopener\">shell</a></li>\n<li>hw3: <a href=\"https://chestnutme.github.io/2017/04/19/hw3/\" target=\"_blank\" rel=\"noopener\">system call</a></li>\n<li>hw4: <a href=\"https://chestnutme.github.io/2017/04/21/hw4/\" target=\"_blank\" rel=\"noopener\">lazy page allocation</a></li>\n<li>hw5: <a href=\"https://chestnutme.github.io/2017/04/24/hw5/\" target=\"_blank\" rel=\"noopener\">cpu alarm</a></li>\n</ul>\n</blockquote>\n<h4 id=\"Note\"><a href=\"#Note\" class=\"headerlink\" title=\"Note\"></a>Note</h4><blockquote>\n<ul>\n<li>note 1: <a href=\"https://chestnutme.github.io/2017/04/16/note1/\" target=\"_blank\" rel=\"noopener\">chapter0</a></li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<ol>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/schedule.html\" target=\"_blank\" rel=\"noopener\">MIT 6.868</a>, 2016, (lecture video).</li>\n<li><a href=\"https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-828-operating-system-engineering-fall-2012/index.htm\" target=\"_blank\" rel=\"noopener\">OCW</a> MIT,2012.</li>\n<li><a href=\"https://www.youtube.com/watch?v=kDRHsNauoxk&amp;list=PLfciLKR3SgqNJKKIKUliWoNBBH1VHL3AP\" target=\"_blank\" rel=\"noopener\"> on youtube</a></li>\n</ol>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"MIT-6-828\"><a href=\"#MIT-6-828\" class=\"headerlink\" title=\"MIT 6.828\"></a>MIT 6.828</h1><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>MIT<a href=\"https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-828-operating-system-engineering-fall-2012/index.htm\" target=\"_blank\" rel=\"noopener\">6.828 Operating System Engineering</a> os,2006MITSixth Edition Unix(V6)os,ucorexv6<a href=\"https://book.douban.com/subject/10076960/\" target=\"_blank\" rel=\"noopener\">Operating Systems Concepts</a>ospeojectos,6.828.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<ol>\n<li>os, kernel</li>\n<li>C</li>\n<li>,</li>\n</ol>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>6.828:</p>\n<blockquote>\n<ul>\n<li>xv6 -&gt; </li>\n<li>JOS -&gt; lab</li>\n</ul>\n</blockquote>\n<p>,</p>\n<blockquote>\n<ul>\n<li>note x: xv6</li>\n<li>lab x:  project</li>\n<li>hw x:   homework</li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\":\"></a>:</h3><h4 id=\"Lab\"><a href=\"#Lab\" class=\"headerlink\" title=\"Lab:\"></a>Lab:</h4><blockquote>\n<ul>\n<li>lab 0: <a href=\"https://chestnutme.github.io/2017/04/08/lab0/\" target=\"_blank\" rel=\"noopener\"></a></li>\n<li>lab 1: <a href=\"https://chestnutme.github.io/2017/04/10/lab1/\" target=\"_blank\" rel=\"noopener\">pc</a></li>\n<li>lab 2: <a href=\"https://chestnutme.github.io/2017/04/18/lab2/\" target=\"_blank\" rel=\"noopener\"></a></li>\n<li>lab 3: <blockquote>\n<ul>\n<li><a href=\"https://chestnutme.github.io/2017/04/26/lab3-part1\" target=\"_blank\" rel=\"noopener\">Part1</a></li>\n<li><a href=\"https://chestnutme.github.io/2017/04/29/lab3-part2\" target=\"_blank\" rel=\"noopener\">Part2</a><br>*</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<h4 id=\"Homework\"><a href=\"#Homework\" class=\"headerlink\" title=\"Homework:\"></a>Homework:</h4><blockquote>\n<ul>\n<li>hw1: <a href=\"https://chestnutme.github.io/2017/04/09/hw1/\" target=\"_blank\" rel=\"noopener\">boot xv6</a></li>\n<li>hw2: <a href=\"https://chestnutme.github.io/2017/04/16/hw2/\" target=\"_blank\" rel=\"noopener\">shell</a></li>\n<li>hw3: <a href=\"https://chestnutme.github.io/2017/04/19/hw3/\" target=\"_blank\" rel=\"noopener\">system call</a></li>\n<li>hw4: <a href=\"https://chestnutme.github.io/2017/04/21/hw4/\" target=\"_blank\" rel=\"noopener\">lazy page allocation</a></li>\n<li>hw5: <a href=\"https://chestnutme.github.io/2017/04/24/hw5/\" target=\"_blank\" rel=\"noopener\">cpu alarm</a></li>\n</ul>\n</blockquote>\n<h4 id=\"Note\"><a href=\"#Note\" class=\"headerlink\" title=\"Note\"></a>Note</h4><blockquote>\n<ul>\n<li>note 1: <a href=\"https://chestnutme.github.io/2017/04/16/note1/\" target=\"_blank\" rel=\"noopener\">chapter0</a></li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<ol>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/schedule.html\" target=\"_blank\" rel=\"noopener\">MIT 6.868</a>, 2016, (lecture video).</li>\n<li><a href=\"https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-828-operating-system-engineering-fall-2012/index.htm\" target=\"_blank\" rel=\"noopener\">OCW</a> MIT,2012.</li>\n<li><a href=\"https://www.youtube.com/watch?v=kDRHsNauoxk&amp;list=PLfciLKR3SgqNJKKIKUliWoNBBH1VHL3AP\" target=\"_blank\" rel=\"noopener\"> on youtube</a></li>\n</ol>\n</blockquote>\n"},{"title":"introduction to algorithms note1","date":"2017-04-10T16:00:00.000Z","_content":"\n# Introduction to algorithms\n\n### \nintroduction to algorithms,//;,;,;MIT,.CLRS,, -.\n\n\n### Part1 \n///\n\n####  Chapter1 ?\n\n>   :\n    $\\require{AMScd}$\n    \\begin{CD}\n    input @>\\text{computing procedure}>> ouput\n    \\end{CD}\n> * , -\n> * : \n\n<!-- more -->\n\n#### Chapter2 ?\n> 1.:\n,.,.:\n    >> a. : (base case)\n    >> b. : n, n(recursive formula)\n    >> c. : \n\n> \n\\begin{align}\nA[1] \\\\\\\\\nA[1] \\ldots A[i], A[1] \\ldots A[i+1] \\\\\\\\\n\\mapsto A[1] \\ldots A[n] \n\\end{align}\n> 2.\n>> a.  n\n>> b. : (n)\n>> c. (), ()\n>> d. (rate of growth)\n\n> 3.\n>> a. (increment), (bottom up)\n>> b. (divide and conquer), (top down)\n    divide -> conquer -> combine\nmerge sort:\n\\begin{align}\n\\{A[1] \\ldots A[n]\\}= \\{A[1] \\ldots A[n/2]\\} + \\{A[n/2+1] \\ldots A[n]\\} \\\\\\\\\nrecusively \\, merge \\{A[1] \\ldots A[n/2]\\} or \\{A[n/2+1] \\ldots A[n]\\} \\\\\\\\\nmerge \\{A[1] \\ldots A[n/2]\\} with \\{A[n/2+1] \\ldots A[n]\\}\n\\end{align}\n\n> 4.\n, ,:\n$$\nT(n) =\n\\begin{cases}\n\\Theta(1), & \\text {if n <= c} \\\\\\\\\naT(n/b) + D(n) + C(n), & else \\\\\\\\\n\\end{cases}\n$$\nmerge sort\n$$\nT(n) =\n\\begin{cases}\nc, & \\text {if n = 1} \\\\\\\\\n2T(n/2) + cn, & \\text {if n > 1} \\\\\\\\\n\\end{cases}\n$$\n?\n, , (),,. **$log_m n$*:\n>> mm(m), n, $log_m n$(m)\n\n\n#### Chapter3 ?()\n\n> 1.:\n>>:\n$\\Theta(g(n)) = \\\\{f(n): \\exists c\\_1, c\\_2, n\\_0, \\forall n \\geq n\\_0, 0 \\leq c\\_1g(n) \\leq f(n) \\leq c\\_2g(n) \\\\}$\n:\n$O(g(n)) = \\\\{f(n): \\exists c, n\\_0, \\forall n \\geq n\\_0, 0 \\leq f(n) \\leq cg(n)\\\\}$\n:\n$\\Omega(g(n)) = \\\\{f(n): \\exists c, n\\_0, \\forall n \\geq n\\_0, 0 \\leq cg(n) \\leq f(n)\\\\}$\n\n> 2.,:\n>> $ 2n^2 + 3n + 1 = 2n^2 + \\Theta(n) = \\Theta(n^2)$\n\n> 3.:\n>> $1 < \\log n < n < n\\log n < n^2 < n^3 < a^n < n!$\n\n#### Chapter4 (recurrence)?\n\n> 1.:\n,.\n\n> 2.:\n>> a. : merge sort:\n$$\nT(n) =\n\\begin{cases}\n\\Theta(1), & \\text {if n = 1} \\\\\\\\\nT(\\lceil n/2 \\rceil) + + T(\\lfloor n/2 \\rfloor) + \\Theta(n), & \\text {if n > 1} \\\\\\\\\n\\end{cases}\n$$\n>> b., \n\n> 3.: , , \n\n> 3.1 (Substitution method)\n>> :,\n:\n:,\n1: n, $T(n)=2T(\\lfloor n/2\\rfloor + 17) + n$  $T(\\lfloor n/2 \\rfloor + 17)$  $T(\\lfloor n/2\\rfloor)$\n2:\n\\begin{align}\nT(n)=2T(\\lfloor n/2\\rfloor) + \\log n, m=\\log n \\\\\\\\\nT(2^m)=2T(2^{m/2}) + m, S(m) = T(2^m) \\\\\\\\\n S(m) = 2S(m/2)+m \\\\\\\\\nS(m) = O(m\\log m) : \\\\\\\\\nT(n) = T(2^m) = S(m) = O(m\\log m) = O(\\log n\\log \\log n)\n\\end{align}\n\n> 3.2 (Recursion-tree method)\n>> :\n:\n():,,\n:,,,,, .\n\n> 3.3 (Master method)\n>> recipe ,,. f(n) $N^{\\log_b^a}$ ,\n:\n a1  b1 f(n)T(n),$T(n)=aT(n/b)+f(n)$  $T(n)=aT(n/b)+f(n)$  $n/b$ $\\lceil n/b\\rceil$, $\\lfloor n/b \\rfloor$,$f(n)$, T(n):\n: T(n)=aT(n/b)+f(n):\n\\begin{align}\n1) \\epsilon > 0, f(n)=O(n^{\\log_b^a-\\epsilon}) \\to T(n)=\\Theta(n^{\\log_b^a}) \\\\\\\\\n2) f(n) = \\Theta(n^{\\log_b^a}) \\to T(n)=\\Theta(n^{\\log_b^a}\\log n) \\\\\\\\\n3) \\epsilon > 0,f(n)=O(n^{\\log_b^a-\\epsilon}) c < 1 n > N, af(n/b) \\leq cf(n) \\to T(n)=\\Theta(f(n))\n\\end{align}\n: 1 223,\n\n#### Chapter5 ?\n> 1.: input,  - \n> 2.input,:\n,,\n> 3.-- \n$$\nA  A \\\\\\\\\nI\\\\{A\\\\} =\n\\begin{cases}\n    1, if \\, A \\, happens \\\\\\\\\n    0, else\n\\end{cases}\n$$\n:\n\\begin{align}\nX = \\sum\\_{i=1}^n X\\_i \\\\\\\\\nE[x] = E[\\sum\\_{i=1}^n X\\_i] = \\sum\\_{i=1}^n E[X\\_i]\n\\end{align}\n\n> 4.?\na. :,\nb. :A[i] A[Random(i+1, Length(A))] swap,\n>> ```\nfor i  1 to n\n    do swap A[i]  A\n```\n\n>,(b),,\n\n### Part2 \n\n/i\n\n> 1.\n:n$[a\\_1,a\\_2, \\ldots, a\\_n]$ \\\n:$[a\\_1',a\\_2',\\ldots a\\_n'], a\\_1' \\leq a\\_2' \\leq \\ldots \\leq a\\_n'$\n2.:\n3.6,\n4.7,\n5.8$\\Theta(n\\log n)$,$\\Omega(n\\log n)$: \n6.9:ii:\na.$O(n^2)$$O(n)$\nb.$O(n)$\n\n#### Chapter6 ?\n\n> 1.heapsort:$O(n\\log n)$, (in place)\n    heap(maxmin)\n> 2.heap:\n>> a., $\\log_2(n)$\n>> b.(, )\n>> c.():$A[Parent(i)] \\geq A[i]$\n>> d.:\n* max-heapify(A, i): i, c, $O(\\log n)$\n* build-max-heap(A): max-heapifyA, $O(n)$\n* heapsort: , $O(n\\log n)$\n\n>>```\nmax-heapify(A, i)\nl <- Left(i)\nr <- Right(i)\nif l <= heap-size[A] and A[l] > A[i]\n    then largest <- l\n    else largest <- i\nif r <= heap-size[A] and A[r] > A[largest]\n    then largest <- r\nif largest not = i\n    then exchange A[i] <-> A[largest]\n    max-heapify(A, largest)\n```\n\n\n>> ```\nbulid-max-heap(A)\nheap-size[A] <- length[A]\nfor i <- length[A] / 2 downto 1\n    do max-heapity(A, i)\n```\n\n>> ```\nheapsort(A)\nbuild-max-heap(A)\nfor i <- length[A] downto 2\n    do exchange A[i] <-> A[i]\n    heap-size[A] <- heap-size[A] - 1\n    max-heapify(A, 1)\n```\n\n> 3.()\n>> a. :\n    * maximum(S):key -> \n    * insert(S, x): x -> max-heapify(A, n + 1)\n    * extract-max: maximummax -> swap(A[1], A[n]), max-heaptify(A, 1)\nb. : , \n\n#### Chapter7 ?\n> 1.: , $\\Theta(n^2)$, $O(n\\log n)$,  $O(n\\log n)$,().\n:\n\n> 2.partition: A[p..r]A[q]A[p..q-1]  A[q] A[q+1..r]\n>```\npartition(A, p, r)\nx <- A[r]\ni <- p-1\nfor j <- p to r-1\n    do if A[j] <= x\n        then i <- i+1\n            exchange A[i]<-> A[j]\nexchange A[i+1] <-> A[r]\nreturn i+1\n```\n\n> 3., \n>```\nquicksort(A, p, r)\nif p < r\n    then q <- partition(A, p, r)\n        quicksort(A, p, q - 1)\n        quicksort(A, q + 1, r)\n```\n\n> 4.:\n, ,merge sort;\n, , n, insert sort;\n,$O(n^2)$,.\n5,,.\n>> a.\n>> b.\n(2)(random sampling):key\n>```\nrandomized-partition(A, p, r)\ni <- random(p, r)\nexchange A[r] <-> A[i]\nreturn partition(A, p, r)\n```\n\n#### Chapter8 ?\n> 1.$\\Theta(n\\log n)$,\n:\n\\begin{align}\nh, ln \\\\\\\\\n\\because n n! \\to  n! \\leq l \\\\\\\\\n\\because l \\leq 2^h \\\\\\\\\n\\therefore n! \\leq l \\leq 2^h \\\\\\\\\n\\therefore h \\geq \\log(n!) = \\Omega(n\\log n)\n\\end{align}\n:,$O(n^2)$\n\n> 2.:\n\n> 2.1 : , , $\\Theta(n)$\n>```\ncounting-sort(A, B, k)\nfor i <- 0 to k\n    do C[i] = 1\nfor j <- 1 to length[A]\n    do C[A[j]] <- C[A[j]] + 1\nC[i]: i\nfor i <- 1 to k\n    do C[i] <- C[i] + C[i-1]\nC[i]: i\nfor j <- lenght[A]\n    do B[C[A[j]]] <- A[j]\n        C[A[j]] <- C[A[j]] - 1\n```\n>a. ,\nb. \nc. :\n>>i. ()\nii. ,int(double)\niii.:\n\n> 2.2 : (k), $\\Theta(d(n+k))$\n>```\nradix-sort(A, d)\nfor i <- 1 to d\n    do use a stable sort array A on digit i\n```\n>a. ,, Key, .\nb. :\n\n> 2.3 :(),  $\\Theta(n)$\n>```\nbucket-sort\nn <- length[A]\nfor i <- 1 to n\n    do insert A[i] into list B[nA[i]]\nfor i <- 0 to n-1\n    do sort list B[i] with insert sort\noutput the lists B[0], B[1],..B[n-1] in order\n```\n>a.,,,\n O(nlgn)\nb.:[0, 1]\n\n\n> 3.: ,, .\n\n\n#### Chapter9 i?\n> 1.the i-th order statistic: i\n    , A[i].i,, ,?\n\n> 2.\n>> min(max): , $\\Theta(n)$\n>>```\nminimum(A)\nmin <- A[1]\nfor i <- 2 to length[A]\n        do if min > A[i]\n            then min <- A[i]\nreturn min\n```\n>> i-th:: , $\\Theta(n)$\n>>```\nrandomized-select(A, p, r, i)\nif p = r\n        then return A[p]\nq <- randomized-partition(A, p, r)\nk <- q - p + 1\nif i = k\n        then return A[q]\nelseif i < k\n        then return randomized-select(A, p, q-1, i)\nelse\n        return randomized-select(A, q+1, r, i-k)\n```\n\n> 3.8,$\\Theta(n\\log n)$, $O(n)$.i-th,,,,randomized-select,$O(n\\log n)$$O(n)$\n\n### Part3 \n\n####\n","source":"_posts/CLRS-notes.md","raw":"\ntitle: introduction to algorithms note1\ndate: 2017/04/11\ntags:\n    - algorithm\n    - data_structure\n\n---\n\n# Introduction to algorithms\n\n### \nintroduction to algorithms,//;,;,;MIT,.CLRS,, -.\n\n\n### Part1 \n///\n\n####  Chapter1 ?\n\n>   :\n    $\\require{AMScd}$\n    \\begin{CD}\n    input @>\\text{computing procedure}>> ouput\n    \\end{CD}\n> * , -\n> * : \n\n<!-- more -->\n\n#### Chapter2 ?\n> 1.:\n,.,.:\n    >> a. : (base case)\n    >> b. : n, n(recursive formula)\n    >> c. : \n\n> \n\\begin{align}\nA[1] \\\\\\\\\nA[1] \\ldots A[i], A[1] \\ldots A[i+1] \\\\\\\\\n\\mapsto A[1] \\ldots A[n] \n\\end{align}\n> 2.\n>> a.  n\n>> b. : (n)\n>> c. (), ()\n>> d. (rate of growth)\n\n> 3.\n>> a. (increment), (bottom up)\n>> b. (divide and conquer), (top down)\n    divide -> conquer -> combine\nmerge sort:\n\\begin{align}\n\\{A[1] \\ldots A[n]\\}= \\{A[1] \\ldots A[n/2]\\} + \\{A[n/2+1] \\ldots A[n]\\} \\\\\\\\\nrecusively \\, merge \\{A[1] \\ldots A[n/2]\\} or \\{A[n/2+1] \\ldots A[n]\\} \\\\\\\\\nmerge \\{A[1] \\ldots A[n/2]\\} with \\{A[n/2+1] \\ldots A[n]\\}\n\\end{align}\n\n> 4.\n, ,:\n$$\nT(n) =\n\\begin{cases}\n\\Theta(1), & \\text {if n <= c} \\\\\\\\\naT(n/b) + D(n) + C(n), & else \\\\\\\\\n\\end{cases}\n$$\nmerge sort\n$$\nT(n) =\n\\begin{cases}\nc, & \\text {if n = 1} \\\\\\\\\n2T(n/2) + cn, & \\text {if n > 1} \\\\\\\\\n\\end{cases}\n$$\n?\n, , (),,. **$log_m n$*:\n>> mm(m), n, $log_m n$(m)\n\n\n#### Chapter3 ?()\n\n> 1.:\n>>:\n$\\Theta(g(n)) = \\\\{f(n): \\exists c\\_1, c\\_2, n\\_0, \\forall n \\geq n\\_0, 0 \\leq c\\_1g(n) \\leq f(n) \\leq c\\_2g(n) \\\\}$\n:\n$O(g(n)) = \\\\{f(n): \\exists c, n\\_0, \\forall n \\geq n\\_0, 0 \\leq f(n) \\leq cg(n)\\\\}$\n:\n$\\Omega(g(n)) = \\\\{f(n): \\exists c, n\\_0, \\forall n \\geq n\\_0, 0 \\leq cg(n) \\leq f(n)\\\\}$\n\n> 2.,:\n>> $ 2n^2 + 3n + 1 = 2n^2 + \\Theta(n) = \\Theta(n^2)$\n\n> 3.:\n>> $1 < \\log n < n < n\\log n < n^2 < n^3 < a^n < n!$\n\n#### Chapter4 (recurrence)?\n\n> 1.:\n,.\n\n> 2.:\n>> a. : merge sort:\n$$\nT(n) =\n\\begin{cases}\n\\Theta(1), & \\text {if n = 1} \\\\\\\\\nT(\\lceil n/2 \\rceil) + + T(\\lfloor n/2 \\rfloor) + \\Theta(n), & \\text {if n > 1} \\\\\\\\\n\\end{cases}\n$$\n>> b., \n\n> 3.: , , \n\n> 3.1 (Substitution method)\n>> :,\n:\n:,\n1: n, $T(n)=2T(\\lfloor n/2\\rfloor + 17) + n$  $T(\\lfloor n/2 \\rfloor + 17)$  $T(\\lfloor n/2\\rfloor)$\n2:\n\\begin{align}\nT(n)=2T(\\lfloor n/2\\rfloor) + \\log n, m=\\log n \\\\\\\\\nT(2^m)=2T(2^{m/2}) + m, S(m) = T(2^m) \\\\\\\\\n S(m) = 2S(m/2)+m \\\\\\\\\nS(m) = O(m\\log m) : \\\\\\\\\nT(n) = T(2^m) = S(m) = O(m\\log m) = O(\\log n\\log \\log n)\n\\end{align}\n\n> 3.2 (Recursion-tree method)\n>> :\n:\n():,,\n:,,,,, .\n\n> 3.3 (Master method)\n>> recipe ,,. f(n) $N^{\\log_b^a}$ ,\n:\n a1  b1 f(n)T(n),$T(n)=aT(n/b)+f(n)$  $T(n)=aT(n/b)+f(n)$  $n/b$ $\\lceil n/b\\rceil$, $\\lfloor n/b \\rfloor$,$f(n)$, T(n):\n: T(n)=aT(n/b)+f(n):\n\\begin{align}\n1) \\epsilon > 0, f(n)=O(n^{\\log_b^a-\\epsilon}) \\to T(n)=\\Theta(n^{\\log_b^a}) \\\\\\\\\n2) f(n) = \\Theta(n^{\\log_b^a}) \\to T(n)=\\Theta(n^{\\log_b^a}\\log n) \\\\\\\\\n3) \\epsilon > 0,f(n)=O(n^{\\log_b^a-\\epsilon}) c < 1 n > N, af(n/b) \\leq cf(n) \\to T(n)=\\Theta(f(n))\n\\end{align}\n: 1 223,\n\n#### Chapter5 ?\n> 1.: input,  - \n> 2.input,:\n,,\n> 3.-- \n$$\nA  A \\\\\\\\\nI\\\\{A\\\\} =\n\\begin{cases}\n    1, if \\, A \\, happens \\\\\\\\\n    0, else\n\\end{cases}\n$$\n:\n\\begin{align}\nX = \\sum\\_{i=1}^n X\\_i \\\\\\\\\nE[x] = E[\\sum\\_{i=1}^n X\\_i] = \\sum\\_{i=1}^n E[X\\_i]\n\\end{align}\n\n> 4.?\na. :,\nb. :A[i] A[Random(i+1, Length(A))] swap,\n>> ```\nfor i  1 to n\n    do swap A[i]  A\n```\n\n>,(b),,\n\n### Part2 \n\n/i\n\n> 1.\n:n$[a\\_1,a\\_2, \\ldots, a\\_n]$ \\\n:$[a\\_1',a\\_2',\\ldots a\\_n'], a\\_1' \\leq a\\_2' \\leq \\ldots \\leq a\\_n'$\n2.:\n3.6,\n4.7,\n5.8$\\Theta(n\\log n)$,$\\Omega(n\\log n)$: \n6.9:ii:\na.$O(n^2)$$O(n)$\nb.$O(n)$\n\n#### Chapter6 ?\n\n> 1.heapsort:$O(n\\log n)$, (in place)\n    heap(maxmin)\n> 2.heap:\n>> a., $\\log_2(n)$\n>> b.(, )\n>> c.():$A[Parent(i)] \\geq A[i]$\n>> d.:\n* max-heapify(A, i): i, c, $O(\\log n)$\n* build-max-heap(A): max-heapifyA, $O(n)$\n* heapsort: , $O(n\\log n)$\n\n>>```\nmax-heapify(A, i)\nl <- Left(i)\nr <- Right(i)\nif l <= heap-size[A] and A[l] > A[i]\n    then largest <- l\n    else largest <- i\nif r <= heap-size[A] and A[r] > A[largest]\n    then largest <- r\nif largest not = i\n    then exchange A[i] <-> A[largest]\n    max-heapify(A, largest)\n```\n\n\n>> ```\nbulid-max-heap(A)\nheap-size[A] <- length[A]\nfor i <- length[A] / 2 downto 1\n    do max-heapity(A, i)\n```\n\n>> ```\nheapsort(A)\nbuild-max-heap(A)\nfor i <- length[A] downto 2\n    do exchange A[i] <-> A[i]\n    heap-size[A] <- heap-size[A] - 1\n    max-heapify(A, 1)\n```\n\n> 3.()\n>> a. :\n    * maximum(S):key -> \n    * insert(S, x): x -> max-heapify(A, n + 1)\n    * extract-max: maximummax -> swap(A[1], A[n]), max-heaptify(A, 1)\nb. : , \n\n#### Chapter7 ?\n> 1.: , $\\Theta(n^2)$, $O(n\\log n)$,  $O(n\\log n)$,().\n:\n\n> 2.partition: A[p..r]A[q]A[p..q-1]  A[q] A[q+1..r]\n>```\npartition(A, p, r)\nx <- A[r]\ni <- p-1\nfor j <- p to r-1\n    do if A[j] <= x\n        then i <- i+1\n            exchange A[i]<-> A[j]\nexchange A[i+1] <-> A[r]\nreturn i+1\n```\n\n> 3., \n>```\nquicksort(A, p, r)\nif p < r\n    then q <- partition(A, p, r)\n        quicksort(A, p, q - 1)\n        quicksort(A, q + 1, r)\n```\n\n> 4.:\n, ,merge sort;\n, , n, insert sort;\n,$O(n^2)$,.\n5,,.\n>> a.\n>> b.\n(2)(random sampling):key\n>```\nrandomized-partition(A, p, r)\ni <- random(p, r)\nexchange A[r] <-> A[i]\nreturn partition(A, p, r)\n```\n\n#### Chapter8 ?\n> 1.$\\Theta(n\\log n)$,\n:\n\\begin{align}\nh, ln \\\\\\\\\n\\because n n! \\to  n! \\leq l \\\\\\\\\n\\because l \\leq 2^h \\\\\\\\\n\\therefore n! \\leq l \\leq 2^h \\\\\\\\\n\\therefore h \\geq \\log(n!) = \\Omega(n\\log n)\n\\end{align}\n:,$O(n^2)$\n\n> 2.:\n\n> 2.1 : , , $\\Theta(n)$\n>```\ncounting-sort(A, B, k)\nfor i <- 0 to k\n    do C[i] = 1\nfor j <- 1 to length[A]\n    do C[A[j]] <- C[A[j]] + 1\nC[i]: i\nfor i <- 1 to k\n    do C[i] <- C[i] + C[i-1]\nC[i]: i\nfor j <- lenght[A]\n    do B[C[A[j]]] <- A[j]\n        C[A[j]] <- C[A[j]] - 1\n```\n>a. ,\nb. \nc. :\n>>i. ()\nii. ,int(double)\niii.:\n\n> 2.2 : (k), $\\Theta(d(n+k))$\n>```\nradix-sort(A, d)\nfor i <- 1 to d\n    do use a stable sort array A on digit i\n```\n>a. ,, Key, .\nb. :\n\n> 2.3 :(),  $\\Theta(n)$\n>```\nbucket-sort\nn <- length[A]\nfor i <- 1 to n\n    do insert A[i] into list B[nA[i]]\nfor i <- 0 to n-1\n    do sort list B[i] with insert sort\noutput the lists B[0], B[1],..B[n-1] in order\n```\n>a.,,,\n O(nlgn)\nb.:[0, 1]\n\n\n> 3.: ,, .\n\n\n#### Chapter9 i?\n> 1.the i-th order statistic: i\n    , A[i].i,, ,?\n\n> 2.\n>> min(max): , $\\Theta(n)$\n>>```\nminimum(A)\nmin <- A[1]\nfor i <- 2 to length[A]\n        do if min > A[i]\n            then min <- A[i]\nreturn min\n```\n>> i-th:: , $\\Theta(n)$\n>>```\nrandomized-select(A, p, r, i)\nif p = r\n        then return A[p]\nq <- randomized-partition(A, p, r)\nk <- q - p + 1\nif i = k\n        then return A[q]\nelseif i < k\n        then return randomized-select(A, p, q-1, i)\nelse\n        return randomized-select(A, q+1, r, i-k)\n```\n\n> 3.8,$\\Theta(n\\log n)$, $O(n)$.i-th,,,,randomized-select,$O(n\\log n)$$O(n)$\n\n### Part3 \n\n####\n","slug":"CLRS-notes","published":1,"updated":"2017-08-26T03:38:21.602Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3gg0003s7amg71wi1f9","content":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>introduction to algorithms,//;,;,;MIT,.CLRS,, -.</p>\n<h3 id=\"Part1-\"><a href=\"#Part1-\" class=\"headerlink\" title=\"Part1 \"></a>Part1 </h3><p>///</p>\n<h4 id=\"Chapter1-\"><a href=\"#Chapter1-\" class=\"headerlink\" title=\"Chapter1 ?\"></a>Chapter1 ?</h4><blockquote>\n<p>  :<br>    $\\require{AMScd}$<br>    \\begin{CD}<br>    input @&gt;\\text{computing procedure}&gt;&gt; ouput<br>    \\end{CD}</p>\n<ul>\n<li>, -</li>\n<li>: </li>\n</ul>\n</blockquote>\n<a id=\"more\"></a>\n<h4 id=\"Chapter2-\"><a href=\"#Chapter2-\" class=\"headerlink\" title=\"Chapter2 ?\"></a>Chapter2 ?</h4><blockquote>\n<p>1.:<br>,.,.:</p>\n<blockquote>\n<p>a. : (base case)<br>b. : n, n(recursive formula)<br>c. : </p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p><br>\\begin{align}<br>A[1] \\\\<br>A[1] \\ldots A[i], A[1] \\ldots A[i+1] \\\\<br>\\mapsto A[1] \\ldots A[n] <br>\\end{align}<br>2.</p>\n<blockquote>\n<p>a.  n<br>b. : (n)<br>c. (), ()<br>d. (rate of growth)</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.</p>\n<blockquote>\n<p>a. (increment), (bottom up)<br>b. (divide and conquer), (top down)<br>    divide -&gt; conquer -&gt; combine<br>merge sort:<br>\\begin{align}<br>{A[1] \\ldots A[n]}= {A[1] \\ldots A[n/2]} + {A[n/2+1] \\ldots A[n]} \\\\<br>recusively \\, merge {A[1] \\ldots A[n/2]} or {A[n/2+1] \\ldots A[n]} \\\\<br>merge {A[1] \\ldots A[n/2]} with {A[n/2+1] \\ldots A[n]}<br>\\end{align}</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>4.<br>, ,:<br>$$<br>T(n) =<br>\\begin{cases}<br>\\Theta(1), &amp; \\text {if n &lt;= c} \\\\<br>aT(n/b) + D(n) + C(n), &amp; else \\\\<br>\\end{cases}<br>$$<br>merge sort<br>$$<br>T(n) =<br>\\begin{cases}<br>c, &amp; \\text {if n = 1} \\\\<br>2T(n/2) + cn, &amp; \\text {if n &gt; 1} \\\\<br>\\end{cases}<br>$$<br>?<br>, , (),,. *<em>$log_m n$</em>:</p>\n<blockquote>\n<p>mm(m), n, $log_m n$(m)</p>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter3--\"><a href=\"#Chapter3--\" class=\"headerlink\" title=\"Chapter3 ?()\"></a>Chapter3 ?()</h4><blockquote>\n<p>1.:</p>\n<blockquote>\n<p>:<br>$\\Theta(g(n)) = \\{f(n): \\exists c_1, c_2, n_0, \\forall n \\geq n_0, 0 \\leq c_1g(n) \\leq f(n) \\leq c_2g(n) \\}$<br>:<br>$O(g(n)) = \\{f(n): \\exists c, n_0, \\forall n \\geq n_0, 0 \\leq f(n) \\leq cg(n)\\}$<br>:<br>$\\Omega(g(n)) = \\{f(n): \\exists c, n_0, \\forall n \\geq n_0, 0 \\leq cg(n) \\leq f(n)\\}$</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>2.,:</p>\n<blockquote>\n<p>$ 2n^2 + 3n + 1 = 2n^2 + \\Theta(n) = \\Theta(n^2)$</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.:</p>\n<blockquote>\n<p>$1 &lt; \\log n &lt; n &lt; n\\log n &lt; n^2 &lt; n^3 &lt; a^n &lt; n!$</p>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter4--recurrence\"><a href=\"#Chapter4--recurrence\" class=\"headerlink\" title=\"Chapter4 (recurrence)?\"></a>Chapter4 (recurrence)?</h4><blockquote>\n<p>1.:<br>,.</p>\n</blockquote>\n<blockquote>\n<p>2.:</p>\n<blockquote>\n<p>a. : merge sort:<br>$$<br>T(n) =<br>\\begin{cases}<br>\\Theta(1), &amp; \\text {if n = 1} \\\\<br>T(\\lceil n/2 \\rceil) + + T(\\lfloor n/2 \\rfloor) + \\Theta(n), &amp; \\text {if n &gt; 1} \\\\<br>\\end{cases}<br>$$<br>b., </p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.: , , </p>\n</blockquote>\n<blockquote>\n<p>3.1 (Substitution method)</p>\n<blockquote>\n<p>:,<br>:<br>:,<br>1: n, $T(n)=2T(\\lfloor n/2\\rfloor + 17) + n$  $T(\\lfloor n/2 \\rfloor + 17)$  $T(\\lfloor n/2\\rfloor)$<br>2:<br>\\begin{align}<br>T(n)=2T(\\lfloor n/2\\rfloor) + \\log n, m=\\log n \\\\<br>T(2^m)=2T(2^{m/2}) + m, S(m) = T(2^m) \\\\<br> S(m) = 2S(m/2)+m \\\\<br>S(m) = O(m\\log m) : \\\\<br>T(n) = T(2^m) = S(m) = O(m\\log m) = O(\\log n\\log \\log n)<br>\\end{align}</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.2 (Recursion-tree method)</p>\n<blockquote>\n<p>:<br>:<br>():,,<br>:,,,,, .</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.3 (Master method)</p>\n<blockquote>\n<p>recipe ,,. f(n) $N^{\\log_b^a}$ ,<br>:<br> a1  b1 f(n)T(n),$T(n)=aT(n/b)+f(n)$  $T(n)=aT(n/b)+f(n)$  $n/b$ $\\lceil n/b\\rceil$, $\\lfloor n/b \\rfloor$,$f(n)$, T(n):<br>: T(n)=aT(n/b)+f(n):<br>\\begin{align}<br>1) \\epsilon &gt; 0, f(n)=O(n^{\\log_b^a-\\epsilon}) \\to T(n)=\\Theta(n^{\\log_b^a}) \\\\<br>2) f(n) = \\Theta(n^{\\log_b^a}) \\to T(n)=\\Theta(n^{\\log_b^a}\\log n) \\\\<br>3) \\epsilon &gt; 0,f(n)=O(n^{\\log_b^a-\\epsilon}) c &lt; 1 n &gt; N, af(n/b) \\leq cf(n) \\to T(n)=\\Theta(f(n))<br>\\end{align}<br>: 1 223,</p>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter5-\"><a href=\"#Chapter5-\" class=\"headerlink\" title=\"Chapter5 ?\"></a>Chapter5 ?</h4><blockquote>\n<p>1.: input,  - <br>2.input,:<br>,,<br>3. <br>$$<br>A  A \\\\<br>I\\{A\\} =<br>\\begin{cases}<br>    1, if \\, A \\, happens \\\\<br>    0, else<br>\\end{cases}<br>$$<br>:<br>\\begin{align}<br>X = \\sum_{i=1}^n X_i \\\\<br>E[x] = E[\\sum_{i=1}^n X_i] = \\sum_{i=1}^n E[X_i]<br>\\end{align}</p>\n</blockquote>\n<blockquote>\n<p>4.?<br>a. :,<br>b. :A[i] A[Random(i+1, Length(A))] swap,</p>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for i  1 to n</span><br><span class=\"line\">    do swap A[i]  A</span><br></pre></td></tr></table></figure>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>,(b),,</p>\n</blockquote>\n<h3 id=\"Part2-\"><a href=\"#Part2-\" class=\"headerlink\" title=\"Part2 \"></a>Part2 </h3><p>/i</p>\n<blockquote>\n<p>1.<br>:n$[a_1,a_2, \\ldots, a_n]$ \\<br>:$[a_1,a_2,\\ldots a_n], a_1 \\leq a_2 \\leq \\ldots \\leq a_n$<br>2.:<br>3.6,<br>4.7,<br>5.8$\\Theta(n\\log n)$,$\\Omega(n\\log n)$: <br>6.9:ii:<br>a.$O(n^2)$$O(n)$<br>b.$O(n)$</p>\n</blockquote>\n<h4 id=\"Chapter6-\"><a href=\"#Chapter6-\" class=\"headerlink\" title=\"Chapter6 ?\"></a>Chapter6 ?</h4><blockquote>\n<p>1.heapsort:$O(n\\log n)$, (in place)<br>    heap(maxmin)<br>2.heap:</p>\n<blockquote>\n<p>a., $\\log_2(n)$<br>b.(, )<br>c.():$A[Parent(i)] \\geq A[i]$<br>d.:</p>\n<ul>\n<li>max-heapify(A, i): i, c, $O(\\log n)$</li>\n<li>build-max-heap(A): max-heapifyA, $O(n)$</li>\n<li>heapsort: , $O(n\\log n)$</li>\n</ul>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">max-heapify(A, i)</span><br><span class=\"line\">l &lt;- Left(i)</span><br><span class=\"line\">r &lt;- Right(i)</span><br><span class=\"line\">if l &lt;= heap-size[A] and A[l] &gt; A[i]</span><br><span class=\"line\">    then largest &lt;- l</span><br><span class=\"line\">    else largest &lt;- i</span><br><span class=\"line\">if r &lt;= heap-size[A] and A[r] &gt; A[largest]</span><br><span class=\"line\">    then largest &lt;- r</span><br><span class=\"line\">if largest not = i</span><br><span class=\"line\">    then exchange A[i] &lt;-&gt; A[largest]</span><br><span class=\"line\">    max-heapify(A, largest)</span><br></pre></td></tr></table></figure>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bulid-max-heap(A)</span><br><span class=\"line\">heap-size[A] &lt;- length[A]</span><br><span class=\"line\">for i &lt;- length[A] / 2 downto 1</span><br><span class=\"line\">    do max-heapity(A, i)</span><br></pre></td></tr></table></figure>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">heapsort(A)</span><br><span class=\"line\">build-max-heap(A)</span><br><span class=\"line\">for i &lt;- length[A] downto 2</span><br><span class=\"line\">    do exchange A[i] &lt;-&gt; A[i]</span><br><span class=\"line\">    heap-size[A] &lt;- heap-size[A] - 1</span><br><span class=\"line\">    max-heapify(A, 1)</span><br></pre></td></tr></table></figure>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.()</p>\n<blockquote>\n<p>a. :</p>\n<pre><code>* maximum(S):key -&gt; \n* insert(S, x): x -&gt; max-heapify(A, n + 1)\n* extract-max: maximummax -&gt; swap(A[1], A[n]), max-heaptify(A, 1)\n</code></pre><p>b. : , </p>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter7-\"><a href=\"#Chapter7-\" class=\"headerlink\" title=\"Chapter7 ?\"></a>Chapter7 ?</h4><blockquote>\n<p>1.: , $\\Theta(n^2)$, $O(n\\log n)$,  $O(n\\log n)$,().<br>:</p>\n</blockquote>\n<blockquote>\n<p>2.partition: A[p..r]A[q]A[p..q-1]  A[q] A[q+1..r]<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">partition(A, p, r)</span><br><span class=\"line\">x &lt;- A[r]</span><br><span class=\"line\">i &lt;- p-1</span><br><span class=\"line\">for j &lt;- p to r-1</span><br><span class=\"line\">    do if A[j] &lt;= x</span><br><span class=\"line\">        then i &lt;- i+1</span><br><span class=\"line\">            exchange A[i]&lt;-&gt; A[j]</span><br><span class=\"line\">exchange A[i+1] &lt;-&gt; A[r]</span><br><span class=\"line\">return i+1</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>3., <br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">quicksort(A, p, r)</span><br><span class=\"line\">if p &lt; r</span><br><span class=\"line\">    then q &lt;- partition(A, p, r)</span><br><span class=\"line\">        quicksort(A, p, q - 1)</span><br><span class=\"line\">        quicksort(A, q + 1, r)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>4.:<br>, ,merge sort;<br>, , n, insert sort;<br>,$O(n^2)$,.<br>5,,.</p>\n<blockquote>\n<p>a.<br>b.<br>(2)(random sampling):key<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">randomized-partition(A, p, r)</span><br><span class=\"line\">i &lt;- random(p, r)</span><br><span class=\"line\">exchange A[r] &lt;-&gt; A[i]</span><br><span class=\"line\">return partition(A, p, r)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter8-\"><a href=\"#Chapter8-\" class=\"headerlink\" title=\"Chapter8 ?\"></a>Chapter8 ?</h4><blockquote>\n<p>1.$\\Theta(n\\log n)$,<br>:<br>\\begin{align}<br>h, ln \\\\<br>\\because n n! \\to  n! \\leq l \\\\<br>\\because l \\leq 2^h \\\\<br>\\therefore n! \\leq l \\leq 2^h \\\\<br>\\therefore h \\geq \\log(n!) = \\Omega(n\\log n)<br>\\end{align}<br>:,$O(n^2)$</p>\n</blockquote>\n<blockquote>\n<p>2.:</p>\n</blockquote>\n<blockquote>\n<p>2.1 : , , $\\Theta(n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">counting-sort(A, B, k)</span><br><span class=\"line\">for i &lt;- 0 to k</span><br><span class=\"line\">    do C[i] = 1</span><br><span class=\"line\">for j &lt;- 1 to length[A]</span><br><span class=\"line\">    do C[A[j]] &lt;- C[A[j]] + 1</span><br><span class=\"line\">C[i]: i</span><br><span class=\"line\">for i &lt;- 1 to k</span><br><span class=\"line\">    do C[i] &lt;- C[i] + C[i-1]</span><br><span class=\"line\">C[i]: i</span><br><span class=\"line\">for j &lt;- lenght[A]</span><br><span class=\"line\">    do B[C[A[j]]] &lt;- A[j]</span><br><span class=\"line\">        C[A[j]] &lt;- C[A[j]] - 1</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>a. ,<br>b. <br>c. :</p>\n<blockquote>\n<p>i. ()<br>ii. ,int(double)<br>iii.:</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>2.2 : (k), $\\Theta(d(n+k))$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">radix-sort(A, d)</span><br><span class=\"line\">for i &lt;- 1 to d</span><br><span class=\"line\">    do use a stable sort array A on digit i</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>a. ,, Key, .<br>b. :</p>\n</blockquote>\n<blockquote>\n<p>2.3 :(),  $\\Theta(n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bucket-sort</span><br><span class=\"line\">n &lt;- length[A]</span><br><span class=\"line\">for i &lt;- 1 to n</span><br><span class=\"line\">    do insert A[i] into list B[nA[i]]</span><br><span class=\"line\">for i &lt;- 0 to n-1</span><br><span class=\"line\">    do sort list B[i] with insert sort</span><br><span class=\"line\">output the lists B[0], B[1],..B[n-1] in order</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>a.,,,<br> O(nlgn)<br>b.:[0, 1]</p>\n</blockquote>\n<blockquote>\n<p>3.: ,, .</p>\n</blockquote>\n<h4 id=\"Chapter9-i\"><a href=\"#Chapter9-i\" class=\"headerlink\" title=\"Chapter9 i?\"></a>Chapter9 i?</h4><blockquote>\n<p>1.the i-th order statistic: i<br>    , A[i].i,, ,?</p>\n</blockquote>\n<blockquote>\n<p>2.</p>\n<blockquote>\n<p>min(max): , $\\Theta(n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">minimum(A)</span><br><span class=\"line\">min &lt;- A[1]</span><br><span class=\"line\">for i &lt;- 2 to length[A]</span><br><span class=\"line\">        do if min &gt; A[i]</span><br><span class=\"line\">            then min &lt;- A[i]</span><br><span class=\"line\">return min</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>i-th:: , $\\Theta(n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">randomized-select(A, p, r, i)</span><br><span class=\"line\">if p = r</span><br><span class=\"line\">        then return A[p]</span><br><span class=\"line\">q &lt;- randomized-partition(A, p, r)</span><br><span class=\"line\">k &lt;- q - p + 1</span><br><span class=\"line\">if i = k</span><br><span class=\"line\">        then return A[q]</span><br><span class=\"line\">elseif i &lt; k</span><br><span class=\"line\">        then return randomized-select(A, p, q-1, i)</span><br><span class=\"line\">else</span><br><span class=\"line\">        return randomized-select(A, q+1, r, i-k)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.8,$\\Theta(n\\log n)$, $O(n)$.i-th,,,,randomized-select,$O(n\\log n)$$O(n)$</p>\n</blockquote>\n<h3 id=\"Part3-\"><a href=\"#Part3-\" class=\"headerlink\" title=\"Part3 \"></a>Part3 </h3><p>####</p>\n","site":{"data":{}},"excerpt":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>introduction to algorithms,//;,;,;MIT,.CLRS,, -.</p>\n<h3 id=\"Part1-\"><a href=\"#Part1-\" class=\"headerlink\" title=\"Part1 \"></a>Part1 </h3><p>///</p>\n<h4 id=\"Chapter1-\"><a href=\"#Chapter1-\" class=\"headerlink\" title=\"Chapter1 ?\"></a>Chapter1 ?</h4><blockquote>\n<p>  :<br>    $\\require{AMScd}$<br>    \\begin{CD}<br>    input @&gt;\\text{computing procedure}&gt;&gt; ouput<br>    \\end{CD}</p>\n<ul>\n<li>, -</li>\n<li>: </li>\n</ul>\n</blockquote>","more":"<h4 id=\"Chapter2-\"><a href=\"#Chapter2-\" class=\"headerlink\" title=\"Chapter2 ?\"></a>Chapter2 ?</h4><blockquote>\n<p>1.:<br>,.,.:</p>\n<blockquote>\n<p>a. : (base case)<br>b. : n, n(recursive formula)<br>c. : </p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p><br>\\begin{align}<br>A[1] \\\\<br>A[1] \\ldots A[i], A[1] \\ldots A[i+1] \\\\<br>\\mapsto A[1] \\ldots A[n] <br>\\end{align}<br>2.</p>\n<blockquote>\n<p>a.  n<br>b. : (n)<br>c. (), ()<br>d. (rate of growth)</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.</p>\n<blockquote>\n<p>a. (increment), (bottom up)<br>b. (divide and conquer), (top down)<br>    divide -&gt; conquer -&gt; combine<br>merge sort:<br>\\begin{align}<br>{A[1] \\ldots A[n]}= {A[1] \\ldots A[n/2]} + {A[n/2+1] \\ldots A[n]} \\\\<br>recusively \\, merge {A[1] \\ldots A[n/2]} or {A[n/2+1] \\ldots A[n]} \\\\<br>merge {A[1] \\ldots A[n/2]} with {A[n/2+1] \\ldots A[n]}<br>\\end{align}</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>4.<br>, ,:<br>$$<br>T(n) =<br>\\begin{cases}<br>\\Theta(1), &amp; \\text {if n &lt;= c} \\\\<br>aT(n/b) + D(n) + C(n), &amp; else \\\\<br>\\end{cases}<br>$$<br>merge sort<br>$$<br>T(n) =<br>\\begin{cases}<br>c, &amp; \\text {if n = 1} \\\\<br>2T(n/2) + cn, &amp; \\text {if n &gt; 1} \\\\<br>\\end{cases}<br>$$<br>?<br>, , (),,. *<em>$log_m n$</em>:</p>\n<blockquote>\n<p>mm(m), n, $log_m n$(m)</p>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter3--\"><a href=\"#Chapter3--\" class=\"headerlink\" title=\"Chapter3 ?()\"></a>Chapter3 ?()</h4><blockquote>\n<p>1.:</p>\n<blockquote>\n<p>:<br>$\\Theta(g(n)) = \\{f(n): \\exists c_1, c_2, n_0, \\forall n \\geq n_0, 0 \\leq c_1g(n) \\leq f(n) \\leq c_2g(n) \\}$<br>:<br>$O(g(n)) = \\{f(n): \\exists c, n_0, \\forall n \\geq n_0, 0 \\leq f(n) \\leq cg(n)\\}$<br>:<br>$\\Omega(g(n)) = \\{f(n): \\exists c, n_0, \\forall n \\geq n_0, 0 \\leq cg(n) \\leq f(n)\\}$</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>2.,:</p>\n<blockquote>\n<p>$ 2n^2 + 3n + 1 = 2n^2 + \\Theta(n) = \\Theta(n^2)$</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.:</p>\n<blockquote>\n<p>$1 &lt; \\log n &lt; n &lt; n\\log n &lt; n^2 &lt; n^3 &lt; a^n &lt; n!$</p>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter4--recurrence\"><a href=\"#Chapter4--recurrence\" class=\"headerlink\" title=\"Chapter4 (recurrence)?\"></a>Chapter4 (recurrence)?</h4><blockquote>\n<p>1.:<br>,.</p>\n</blockquote>\n<blockquote>\n<p>2.:</p>\n<blockquote>\n<p>a. : merge sort:<br>$$<br>T(n) =<br>\\begin{cases}<br>\\Theta(1), &amp; \\text {if n = 1} \\\\<br>T(\\lceil n/2 \\rceil) + + T(\\lfloor n/2 \\rfloor) + \\Theta(n), &amp; \\text {if n &gt; 1} \\\\<br>\\end{cases}<br>$$<br>b., </p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.: , , </p>\n</blockquote>\n<blockquote>\n<p>3.1 (Substitution method)</p>\n<blockquote>\n<p>:,<br>:<br>:,<br>1: n, $T(n)=2T(\\lfloor n/2\\rfloor + 17) + n$  $T(\\lfloor n/2 \\rfloor + 17)$  $T(\\lfloor n/2\\rfloor)$<br>2:<br>\\begin{align}<br>T(n)=2T(\\lfloor n/2\\rfloor) + \\log n, m=\\log n \\\\<br>T(2^m)=2T(2^{m/2}) + m, S(m) = T(2^m) \\\\<br> S(m) = 2S(m/2)+m \\\\<br>S(m) = O(m\\log m) : \\\\<br>T(n) = T(2^m) = S(m) = O(m\\log m) = O(\\log n\\log \\log n)<br>\\end{align}</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.2 (Recursion-tree method)</p>\n<blockquote>\n<p>:<br>:<br>():,,<br>:,,,,, .</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.3 (Master method)</p>\n<blockquote>\n<p>recipe ,,. f(n) $N^{\\log_b^a}$ ,<br>:<br> a1  b1 f(n)T(n),$T(n)=aT(n/b)+f(n)$  $T(n)=aT(n/b)+f(n)$  $n/b$ $\\lceil n/b\\rceil$, $\\lfloor n/b \\rfloor$,$f(n)$, T(n):<br>: T(n)=aT(n/b)+f(n):<br>\\begin{align}<br>1) \\epsilon &gt; 0, f(n)=O(n^{\\log_b^a-\\epsilon}) \\to T(n)=\\Theta(n^{\\log_b^a}) \\\\<br>2) f(n) = \\Theta(n^{\\log_b^a}) \\to T(n)=\\Theta(n^{\\log_b^a}\\log n) \\\\<br>3) \\epsilon &gt; 0,f(n)=O(n^{\\log_b^a-\\epsilon}) c &lt; 1 n &gt; N, af(n/b) \\leq cf(n) \\to T(n)=\\Theta(f(n))<br>\\end{align}<br>: 1 223,</p>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter5-\"><a href=\"#Chapter5-\" class=\"headerlink\" title=\"Chapter5 ?\"></a>Chapter5 ?</h4><blockquote>\n<p>1.: input,  - <br>2.input,:<br>,,<br>3. <br>$$<br>A  A \\\\<br>I\\{A\\} =<br>\\begin{cases}<br>    1, if \\, A \\, happens \\\\<br>    0, else<br>\\end{cases}<br>$$<br>:<br>\\begin{align}<br>X = \\sum_{i=1}^n X_i \\\\<br>E[x] = E[\\sum_{i=1}^n X_i] = \\sum_{i=1}^n E[X_i]<br>\\end{align}</p>\n</blockquote>\n<blockquote>\n<p>4.?<br>a. :,<br>b. :A[i] A[Random(i+1, Length(A))] swap,</p>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for i  1 to n</span><br><span class=\"line\">    do swap A[i]  A</span><br></pre></td></tr></table></figure>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>,(b),,</p>\n</blockquote>\n<h3 id=\"Part2-\"><a href=\"#Part2-\" class=\"headerlink\" title=\"Part2 \"></a>Part2 </h3><p>/i</p>\n<blockquote>\n<p>1.<br>:n$[a_1,a_2, \\ldots, a_n]$ \\<br>:$[a_1,a_2,\\ldots a_n], a_1 \\leq a_2 \\leq \\ldots \\leq a_n$<br>2.:<br>3.6,<br>4.7,<br>5.8$\\Theta(n\\log n)$,$\\Omega(n\\log n)$: <br>6.9:ii:<br>a.$O(n^2)$$O(n)$<br>b.$O(n)$</p>\n</blockquote>\n<h4 id=\"Chapter6-\"><a href=\"#Chapter6-\" class=\"headerlink\" title=\"Chapter6 ?\"></a>Chapter6 ?</h4><blockquote>\n<p>1.heapsort:$O(n\\log n)$, (in place)<br>    heap(maxmin)<br>2.heap:</p>\n<blockquote>\n<p>a., $\\log_2(n)$<br>b.(, )<br>c.():$A[Parent(i)] \\geq A[i]$<br>d.:</p>\n<ul>\n<li>max-heapify(A, i): i, c, $O(\\log n)$</li>\n<li>build-max-heap(A): max-heapifyA, $O(n)$</li>\n<li>heapsort: , $O(n\\log n)$</li>\n</ul>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">max-heapify(A, i)</span><br><span class=\"line\">l &lt;- Left(i)</span><br><span class=\"line\">r &lt;- Right(i)</span><br><span class=\"line\">if l &lt;= heap-size[A] and A[l] &gt; A[i]</span><br><span class=\"line\">    then largest &lt;- l</span><br><span class=\"line\">    else largest &lt;- i</span><br><span class=\"line\">if r &lt;= heap-size[A] and A[r] &gt; A[largest]</span><br><span class=\"line\">    then largest &lt;- r</span><br><span class=\"line\">if largest not = i</span><br><span class=\"line\">    then exchange A[i] &lt;-&gt; A[largest]</span><br><span class=\"line\">    max-heapify(A, largest)</span><br></pre></td></tr></table></figure>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bulid-max-heap(A)</span><br><span class=\"line\">heap-size[A] &lt;- length[A]</span><br><span class=\"line\">for i &lt;- length[A] / 2 downto 1</span><br><span class=\"line\">    do max-heapity(A, i)</span><br></pre></td></tr></table></figure>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">heapsort(A)</span><br><span class=\"line\">build-max-heap(A)</span><br><span class=\"line\">for i &lt;- length[A] downto 2</span><br><span class=\"line\">    do exchange A[i] &lt;-&gt; A[i]</span><br><span class=\"line\">    heap-size[A] &lt;- heap-size[A] - 1</span><br><span class=\"line\">    max-heapify(A, 1)</span><br></pre></td></tr></table></figure>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.()</p>\n<blockquote>\n<p>a. :</p>\n<pre><code>* maximum(S):key -&gt; \n* insert(S, x): x -&gt; max-heapify(A, n + 1)\n* extract-max: maximummax -&gt; swap(A[1], A[n]), max-heaptify(A, 1)\n</code></pre><p>b. : , </p>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter7-\"><a href=\"#Chapter7-\" class=\"headerlink\" title=\"Chapter7 ?\"></a>Chapter7 ?</h4><blockquote>\n<p>1.: , $\\Theta(n^2)$, $O(n\\log n)$,  $O(n\\log n)$,().<br>:</p>\n</blockquote>\n<blockquote>\n<p>2.partition: A[p..r]A[q]A[p..q-1]  A[q] A[q+1..r]<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">partition(A, p, r)</span><br><span class=\"line\">x &lt;- A[r]</span><br><span class=\"line\">i &lt;- p-1</span><br><span class=\"line\">for j &lt;- p to r-1</span><br><span class=\"line\">    do if A[j] &lt;= x</span><br><span class=\"line\">        then i &lt;- i+1</span><br><span class=\"line\">            exchange A[i]&lt;-&gt; A[j]</span><br><span class=\"line\">exchange A[i+1] &lt;-&gt; A[r]</span><br><span class=\"line\">return i+1</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>3., <br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">quicksort(A, p, r)</span><br><span class=\"line\">if p &lt; r</span><br><span class=\"line\">    then q &lt;- partition(A, p, r)</span><br><span class=\"line\">        quicksort(A, p, q - 1)</span><br><span class=\"line\">        quicksort(A, q + 1, r)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>4.:<br>, ,merge sort;<br>, , n, insert sort;<br>,$O(n^2)$,.<br>5,,.</p>\n<blockquote>\n<p>a.<br>b.<br>(2)(random sampling):key<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">randomized-partition(A, p, r)</span><br><span class=\"line\">i &lt;- random(p, r)</span><br><span class=\"line\">exchange A[r] &lt;-&gt; A[i]</span><br><span class=\"line\">return partition(A, p, r)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter8-\"><a href=\"#Chapter8-\" class=\"headerlink\" title=\"Chapter8 ?\"></a>Chapter8 ?</h4><blockquote>\n<p>1.$\\Theta(n\\log n)$,<br>:<br>\\begin{align}<br>h, ln \\\\<br>\\because n n! \\to  n! \\leq l \\\\<br>\\because l \\leq 2^h \\\\<br>\\therefore n! \\leq l \\leq 2^h \\\\<br>\\therefore h \\geq \\log(n!) = \\Omega(n\\log n)<br>\\end{align}<br>:,$O(n^2)$</p>\n</blockquote>\n<blockquote>\n<p>2.:</p>\n</blockquote>\n<blockquote>\n<p>2.1 : , , $\\Theta(n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">counting-sort(A, B, k)</span><br><span class=\"line\">for i &lt;- 0 to k</span><br><span class=\"line\">    do C[i] = 1</span><br><span class=\"line\">for j &lt;- 1 to length[A]</span><br><span class=\"line\">    do C[A[j]] &lt;- C[A[j]] + 1</span><br><span class=\"line\">C[i]: i</span><br><span class=\"line\">for i &lt;- 1 to k</span><br><span class=\"line\">    do C[i] &lt;- C[i] + C[i-1]</span><br><span class=\"line\">C[i]: i</span><br><span class=\"line\">for j &lt;- lenght[A]</span><br><span class=\"line\">    do B[C[A[j]]] &lt;- A[j]</span><br><span class=\"line\">        C[A[j]] &lt;- C[A[j]] - 1</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>a. ,<br>b. <br>c. :</p>\n<blockquote>\n<p>i. ()<br>ii. ,int(double)<br>iii.:</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>2.2 : (k), $\\Theta(d(n+k))$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">radix-sort(A, d)</span><br><span class=\"line\">for i &lt;- 1 to d</span><br><span class=\"line\">    do use a stable sort array A on digit i</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>a. ,, Key, .<br>b. :</p>\n</blockquote>\n<blockquote>\n<p>2.3 :(),  $\\Theta(n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bucket-sort</span><br><span class=\"line\">n &lt;- length[A]</span><br><span class=\"line\">for i &lt;- 1 to n</span><br><span class=\"line\">    do insert A[i] into list B[nA[i]]</span><br><span class=\"line\">for i &lt;- 0 to n-1</span><br><span class=\"line\">    do sort list B[i] with insert sort</span><br><span class=\"line\">output the lists B[0], B[1],..B[n-1] in order</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>a.,,,<br> O(nlgn)<br>b.:[0, 1]</p>\n</blockquote>\n<blockquote>\n<p>3.: ,, .</p>\n</blockquote>\n<h4 id=\"Chapter9-i\"><a href=\"#Chapter9-i\" class=\"headerlink\" title=\"Chapter9 i?\"></a>Chapter9 i?</h4><blockquote>\n<p>1.the i-th order statistic: i<br>    , A[i].i,, ,?</p>\n</blockquote>\n<blockquote>\n<p>2.</p>\n<blockquote>\n<p>min(max): , $\\Theta(n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">minimum(A)</span><br><span class=\"line\">min &lt;- A[1]</span><br><span class=\"line\">for i &lt;- 2 to length[A]</span><br><span class=\"line\">        do if min &gt; A[i]</span><br><span class=\"line\">            then min &lt;- A[i]</span><br><span class=\"line\">return min</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>i-th:: , $\\Theta(n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">randomized-select(A, p, r, i)</span><br><span class=\"line\">if p = r</span><br><span class=\"line\">        then return A[p]</span><br><span class=\"line\">q &lt;- randomized-partition(A, p, r)</span><br><span class=\"line\">k &lt;- q - p + 1</span><br><span class=\"line\">if i = k</span><br><span class=\"line\">        then return A[q]</span><br><span class=\"line\">elseif i &lt; k</span><br><span class=\"line\">        then return randomized-select(A, p, q-1, i)</span><br><span class=\"line\">else</span><br><span class=\"line\">        return randomized-select(A, q+1, r, i-k)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>3.8,$\\Theta(n\\log n)$, $O(n)$.i-th,,,,randomized-select,$O(n\\log n)$$O(n)$</p>\n</blockquote>\n<h3 id=\"Part3-\"><a href=\"#Part3-\" class=\"headerlink\" title=\"Part3 \"></a>Part3 </h3><p>####</p>"},{"title":"introduction to algorithms note2","date":"2017-04-16T16:00:00.000Z","_content":"\n# Introduction to algorithms\n\n### Part3: \n> 1. :\n> 2. (keyword) -> ()\n> 3. \n>> * `search(S, k)`\n>> * `insert(S, x)`\n>> * `delete(S, x)`\n>> * `maximum/minimum(S)`\n>> * `successor/predecessor(S, x)`\n\n<!-- more -->\n\n#### Chapter10 ?\n1. stack\n> - LIFO: \n> - data\n>> ```\nSequence S; #\nint top;\n```\n> - method\n>> ```\nstack-empty(S): O(1)\n  if top[S] = 0\n    then return true\n    else return false\n\npush(S, x): O(1)\n  top[S] <- top[S] + 1\n  S[top[S]] <- x\n\npop(S): O(1)\n   if stack-empty(S)\n    then error \"underflow\"\n    else top[S] <- top[S] - 1\n      return S[top[S] + 1]\n\n#stack, ,\nstack-full(S): O(1)\n if top[S] == size(S)\n    then return true\n    else return false\n\n```\n> - apply:\n>> -\n>> \n\n2. queue\n6heappriority_queue, queue:queue.queue:\n> - FIFO: \n> - data:\n>> ```\nSequence S;\nint head, tail;\nint length;\n```\n> - method\n>> ```\nenqueue(Q, x): O(1)\n  Q[tail[Q]] <- x\n  if tail[Q] = length[Q]\n    then tail[Q] <- 1\n    else tail[Q] <- tail[Q] + 1\n\ndequeue(Q): O(1)\n  x <- Q[head[Q]]\n  if head[Q] = length[Q]\n    then head[Q] <- 1\n    else head[Q] <- head[Q] + 1\n  return x\n>> ```\n> - apply:\n>> * FIFO; \n* : , BFS\n\n3. linkedlist\n(, ), ()\n> - data:\n>> ```\nDatatype data\npointer next, prev\n```\n> - method:\n```\nsearch(L, k): O(n)\n  x <- head[L]\n  while x  != NULL and key[x] != k\n    do x <- next[x]\n  return x\n\ninsert(L, x): O(1) \n  next[x] <- head[L]\n  if head[L] != NULL\n    then prev[head[L]] <- x\n  head[L] <- x\n  prev[x] <- NULL\n\ndelete(L, x): x is pointer, O(1); x is key, O(n)\n  if prev[x] != NULL\n    then next[prev[x]] <- next[x]\n    else head[L] <- next[x]\n  if next[x] != NULL\n    then prev[next[x]] <- prev[x]\n```\n> - techique: (sentinel)\n>> - , ,\n>> ```\nsearch(L, k)\n  x <- next[nil[L]]\n  while x != nil[L] and key[x] != k\n    do x <- next[x]\n  return x\n\ninsert(L, x)\n  next[x] <- next[nil[L]]\n  prev[next[nil[L]]] <- x\n  next[nil[L]] <- x\n  prev[x] <- nil[L]\n\ndelete(L, x)\n  next[prev[x]] <- next[x]\n  prev[next[x]] <- prev[x]\n```\n> - apply:\n, , :, ,, ,;, , ,, .\n\n4. \n(fortran), 2prev, next,.\n,, tag, , Cmalloc/free,.\n\n5. \n, , :\n> - binary tree\n>> - node:\n>> ```\ndata\npointer left, right\n```\n\n>> - multi tree\n>> - node:\n>>> * data:\n>>> * pointer left-child, right-sibling #\n\n#### Chapter10 ?\n1. hash table: key ->(mapto) identifier\n> , $O(n)$, $O(1)$.,,$O(1)$, $O(1)$.\n(),\"\"$O(1)$(), O(1)\n\n. \n> 1. \n  ()\n  U,k, .\n> ```\nsearch(T, k)\n  return T[k]\n\ninsert(T, x)\n  T[key[x]] <- x\n\ndelete(T, x)\n  T[key[x]] <- NULL\n```\n\n> 2. \nkmT,:\n\\begin{align}\nhash-func: h: U -> \\{0, 1, \\ldots ,m-1\\} \\\\\\\\\n k \\mapsto h(k)\n\\end{align}\n: (collision)two key -> one position\n> :\n>> 1. hash-func, \n>> 2. (chaining): \n>> ```\nsearch(T, x): O(1)\n  search for an element with key in list T[h(k)]\n\ninsert(T, x): O(1)\n  insert x at the head of list T[h(key[x])]\n\ndelete(T, x): O(1)\n  delete x from the list T[h(key[x])]\n```\n,, O(n),,,\n\n\n3. hash-func\n> 1. hash-func\n\\begin{align}\nrandom \\, k \\, 0 \\leq k < 1,\\\\\\\\\nh(k) = \\lfloor km \\rfloor\n\\end{align}\n\n> 2. $N$,,\n>> a. :\n m 2\n>> $$h(k) = k\\mod m$$\n>> b. :\n: A(0<A<1), kA ;m,\n>> $$h(k) = \\lfloor m(kA \\mod 1) \\rfloor$$\n>> c.:,,\ni. \nii. ,\niii. :$H$,$U${0,1,...,m-1},.$H$,KJ,1/m\niv.:\np,k0p-1,0p-1.015, p17Zp {0, 1, 2, ,...,p-1},Zp'{1, 2, 3,...,p-1} p ,\n\n$h(a, b, k) = ((a*k + b) \\mod p) \\mod m$\naZp,bZp'ab,,\nv.,:,a,b,,a,b\n\n4. :\n> * ,pos,,pos,,\n> * , O(n),\n> * ,,pos,tag,.\n> * \n.\n>> 1.  linear probing\n>> $$h(k,i) = (h'(k)+i) \\mod m$$\n>> $$h' = U \\mapsto [0, 1, \\ldots, m-1]$$\n>> 2.  quadrating probing\n>> $$h(k,i) = (h'(k) + c_1i+ c_2i^2) \\mod m$$\n>> 3. \n,.\n>> $$h(k,i) = (h_1(k) + ih_2(k)) \\mod m$$\n\n\n5. :\n> ,$O(1)$,,.,.\n:.\n\n#### Chapter12 ?\n1.  binary search tree\n> * define:\n> $$key[left[x]] \\leq key[x] \\bigcup key[right[x]] \\geq key[x]$$\n> * method\n> ```\ninorder-walk(x): $O(n)$\n  if x != NULL\n    then inorder-walk(left[x])\n      visit key[x]\n      inorder-walk[right[x]]\n\nsearch(x, k): $O(h)$\n  if x = NULL or k = key[x]\n    then return x\n  if k < key[x]\n    then return search(left[x], k)\n    else return search(right[x], k)\n\nminimum(x): $O(h)$\n  while left[x] != NULL\n    do x <- left[x]\n  return x\n\nmaximum(x): $O(h)$\n  while right[x] != NULL\n    do x <- right[x]\n  return x\n\nsuccessor(x): $O(h)$, \n  if right[x] != NULL\n    then return minimum(right[x])\n  y <- p[x]\n  while y != NULL and x = right[y]\n    do x <- y\n      y <- p[y]\n  return y\n\npredecessor(x): $O(h)$ \n  if left[x] != NULL\n    then return maxinum(left[x])\n  y < p[x]\n  while y != NUll and x = left[y]\n    do x <- y\n      y <- p[y]\n  return y\n\ninsert(T, k): $O(h)$\n  y <- NUll\n  x <- root[T]\n  while x != NUll\n    do y <- x\n      if key[k] < key[x]\n        then x <- left[x]\n        else x <- right[x]\n  p[x] <- u\n  if y = NUll\n    then root[T] <- x #tree T is empty\n    else if key[k] < key[y]\n      then left[y] <- k\n      else right[y] <- k\n\ndelete(T, k): $O(h)$\n  if left[k] = NUll or right[k] = NUll\n    then y <- k\n    else y <- successor(k)\n  if left[y] != NUll\n    then x <- left[y]\n    else x <- right[y]\n  if x != NUll\n    then p[x] <- p[y]\n  if p[y] = NUll\n    then root[T] <- x\n    else if y = left[p[y]]\n      then left[p[y]] <- x\n      else right[p[y]] <- de\n  if y != k\n    then key[k] <- key[y]\n      copy y's satellite date into k\n  return y\n```\n> BST, .: x, x ()y, x  y , y  y (),\n\n\n#### Chapter13 ,?\n12, BST.BST,$O(n)$, , $O(\\log n)$., .\n> - define\n>> * node: color, key, left, right, p\n>> * :\n>>> 1. ,\n>>> 2. \n>>> 3. (NULL)(NULL , NULL , NULL )\n>>> 4. ,\n>>> 5. ,\n>>> 6. : (),x..\n> -  nil[T] , color=black\n\n> - :\n),, O(lgn),,\n:,.\n\n> - method\n>> *  ():\n\n,\n```\nleft-rotate(T, x)\n  y <- right[x]\n  right[x] <- left[y]\n  p[left[y]] <- x\n  p[y] <- p[x]\n  if p[x] = nil[T]\n    then root[t] <- y\n    else if x = left[p[x]]\n      then ledt[p[x]] <- y\n      else right[p[x]] <- y\n  left[y] <- y\n  p[x] <- y\n```\n>> * :\nZT,T,Z,Z,;Z,5,5;,24,\n:\ni. 2:;\nii. 4:;\n```\ninsert(T, k)\n  y <- nil[T]\n  x <- root[T]\n  while x != nil[T]\n    do y <- x\n      if key[k] < key[x]\n        then x <- left[x]\n        else x <- right[x]\n  p[x] <- y\n  if y = nil[T]\n    then root[T] <- k\n    else if key[k] < key[y]\n      then left[y] <- k\n      else right[y] <- k\n  left[k] <- nil[T]\n  right[k] <- nil[T]\n  color[k] <- red\n  insert-fixup(T, k)\n```\n\n>> * :\n,BST,\n,:\ni. \nii. \niii. ,,\n,5,5,,,5,\n:\ni. 2:y, y ,;\nii. 4:xp[y];\niii.5:y,;\n>> ```\ndelete(T, k)\n  if left[k] = nil[T] or right[k] = nil[T]\n    then y <- k\n    else y <- successor(k)\n  if left[y] != nil[T]\n    then x <- left[y]\n    else x <- right[y]\n  p[x] <- p[y]\n    then root[T] <- x\n    else if y = left[p[y]]\n      then left[p[y]] <- x\n      else right[p[y]] <- x\n  if y != k\n    then key[k] <- key[y]\n      copy y's satelite date into z\n  if color[y] = black\n    then delete-fixup(T, x)\n  return y\n```\n\n> - :C++STL map,set(,;Linux \n\n#### Chapter14 ,?\n> 1. ,,,\n> 2. (Dynamic order statistics)\nO(n)ii$O(\\log n)$(order statistic tree)\nxsize.sizex(x)\n> $$x.size=x.left.size+x.right.size+1$$\n>  i\n> ```\nOS-SELECT(x, i)\n    r = x.left.size + i\n    if i == r\n        return x\n    else if i < r\n        return OS-SELECT(x.left, i)\n    else\n        return OS-SELECT(x.right, i - r)\n```\n>  x r,x\nr = x.left.size + 1\nririxxixiriri-rxi-rO(lg n):\n> ```\nOS-RANK(T, x)\n    r = x.left.size + 1\n    y = x\n    while y != T.root\n        if y == y.p.right\n            r = r+ y.p.left.size + 1\n        y = y.p\n    return r\n```\n> size()xsizex\n,size,\n\n> 2. :\n> 3. :\n>> 1. \n>> 2. \n>> 3. \n>> 4. \n> 5. :,\n","source":"_posts/CLRS-notes2.md","raw":"title: introduction to algorithms note2\ntags:\n  - algorithm\n  - data_structure\ndate: 2017/04/17\n\n---\n\n# Introduction to algorithms\n\n### Part3: \n> 1. :\n> 2. (keyword) -> ()\n> 3. \n>> * `search(S, k)`\n>> * `insert(S, x)`\n>> * `delete(S, x)`\n>> * `maximum/minimum(S)`\n>> * `successor/predecessor(S, x)`\n\n<!-- more -->\n\n#### Chapter10 ?\n1. stack\n> - LIFO: \n> - data\n>> ```\nSequence S; #\nint top;\n```\n> - method\n>> ```\nstack-empty(S): O(1)\n  if top[S] = 0\n    then return true\n    else return false\n\npush(S, x): O(1)\n  top[S] <- top[S] + 1\n  S[top[S]] <- x\n\npop(S): O(1)\n   if stack-empty(S)\n    then error \"underflow\"\n    else top[S] <- top[S] - 1\n      return S[top[S] + 1]\n\n#stack, ,\nstack-full(S): O(1)\n if top[S] == size(S)\n    then return true\n    else return false\n\n```\n> - apply:\n>> -\n>> \n\n2. queue\n6heappriority_queue, queue:queue.queue:\n> - FIFO: \n> - data:\n>> ```\nSequence S;\nint head, tail;\nint length;\n```\n> - method\n>> ```\nenqueue(Q, x): O(1)\n  Q[tail[Q]] <- x\n  if tail[Q] = length[Q]\n    then tail[Q] <- 1\n    else tail[Q] <- tail[Q] + 1\n\ndequeue(Q): O(1)\n  x <- Q[head[Q]]\n  if head[Q] = length[Q]\n    then head[Q] <- 1\n    else head[Q] <- head[Q] + 1\n  return x\n>> ```\n> - apply:\n>> * FIFO; \n* : , BFS\n\n3. linkedlist\n(, ), ()\n> - data:\n>> ```\nDatatype data\npointer next, prev\n```\n> - method:\n```\nsearch(L, k): O(n)\n  x <- head[L]\n  while x  != NULL and key[x] != k\n    do x <- next[x]\n  return x\n\ninsert(L, x): O(1) \n  next[x] <- head[L]\n  if head[L] != NULL\n    then prev[head[L]] <- x\n  head[L] <- x\n  prev[x] <- NULL\n\ndelete(L, x): x is pointer, O(1); x is key, O(n)\n  if prev[x] != NULL\n    then next[prev[x]] <- next[x]\n    else head[L] <- next[x]\n  if next[x] != NULL\n    then prev[next[x]] <- prev[x]\n```\n> - techique: (sentinel)\n>> - , ,\n>> ```\nsearch(L, k)\n  x <- next[nil[L]]\n  while x != nil[L] and key[x] != k\n    do x <- next[x]\n  return x\n\ninsert(L, x)\n  next[x] <- next[nil[L]]\n  prev[next[nil[L]]] <- x\n  next[nil[L]] <- x\n  prev[x] <- nil[L]\n\ndelete(L, x)\n  next[prev[x]] <- next[x]\n  prev[next[x]] <- prev[x]\n```\n> - apply:\n, , :, ,, ,;, , ,, .\n\n4. \n(fortran), 2prev, next,.\n,, tag, , Cmalloc/free,.\n\n5. \n, , :\n> - binary tree\n>> - node:\n>> ```\ndata\npointer left, right\n```\n\n>> - multi tree\n>> - node:\n>>> * data:\n>>> * pointer left-child, right-sibling #\n\n#### Chapter10 ?\n1. hash table: key ->(mapto) identifier\n> , $O(n)$, $O(1)$.,,$O(1)$, $O(1)$.\n(),\"\"$O(1)$(), O(1)\n\n. \n> 1. \n  ()\n  U,k, .\n> ```\nsearch(T, k)\n  return T[k]\n\ninsert(T, x)\n  T[key[x]] <- x\n\ndelete(T, x)\n  T[key[x]] <- NULL\n```\n\n> 2. \nkmT,:\n\\begin{align}\nhash-func: h: U -> \\{0, 1, \\ldots ,m-1\\} \\\\\\\\\n k \\mapsto h(k)\n\\end{align}\n: (collision)two key -> one position\n> :\n>> 1. hash-func, \n>> 2. (chaining): \n>> ```\nsearch(T, x): O(1)\n  search for an element with key in list T[h(k)]\n\ninsert(T, x): O(1)\n  insert x at the head of list T[h(key[x])]\n\ndelete(T, x): O(1)\n  delete x from the list T[h(key[x])]\n```\n,, O(n),,,\n\n\n3. hash-func\n> 1. hash-func\n\\begin{align}\nrandom \\, k \\, 0 \\leq k < 1,\\\\\\\\\nh(k) = \\lfloor km \\rfloor\n\\end{align}\n\n> 2. $N$,,\n>> a. :\n m 2\n>> $$h(k) = k\\mod m$$\n>> b. :\n: A(0<A<1), kA ;m,\n>> $$h(k) = \\lfloor m(kA \\mod 1) \\rfloor$$\n>> c.:,,\ni. \nii. ,\niii. :$H$,$U${0,1,...,m-1},.$H$,KJ,1/m\niv.:\np,k0p-1,0p-1.015, p17Zp {0, 1, 2, ,...,p-1},Zp'{1, 2, 3,...,p-1} p ,\n\n$h(a, b, k) = ((a*k + b) \\mod p) \\mod m$\naZp,bZp'ab,,\nv.,:,a,b,,a,b\n\n4. :\n> * ,pos,,pos,,\n> * , O(n),\n> * ,,pos,tag,.\n> * \n.\n>> 1.  linear probing\n>> $$h(k,i) = (h'(k)+i) \\mod m$$\n>> $$h' = U \\mapsto [0, 1, \\ldots, m-1]$$\n>> 2.  quadrating probing\n>> $$h(k,i) = (h'(k) + c_1i+ c_2i^2) \\mod m$$\n>> 3. \n,.\n>> $$h(k,i) = (h_1(k) + ih_2(k)) \\mod m$$\n\n\n5. :\n> ,$O(1)$,,.,.\n:.\n\n#### Chapter12 ?\n1.  binary search tree\n> * define:\n> $$key[left[x]] \\leq key[x] \\bigcup key[right[x]] \\geq key[x]$$\n> * method\n> ```\ninorder-walk(x): $O(n)$\n  if x != NULL\n    then inorder-walk(left[x])\n      visit key[x]\n      inorder-walk[right[x]]\n\nsearch(x, k): $O(h)$\n  if x = NULL or k = key[x]\n    then return x\n  if k < key[x]\n    then return search(left[x], k)\n    else return search(right[x], k)\n\nminimum(x): $O(h)$\n  while left[x] != NULL\n    do x <- left[x]\n  return x\n\nmaximum(x): $O(h)$\n  while right[x] != NULL\n    do x <- right[x]\n  return x\n\nsuccessor(x): $O(h)$, \n  if right[x] != NULL\n    then return minimum(right[x])\n  y <- p[x]\n  while y != NULL and x = right[y]\n    do x <- y\n      y <- p[y]\n  return y\n\npredecessor(x): $O(h)$ \n  if left[x] != NULL\n    then return maxinum(left[x])\n  y < p[x]\n  while y != NUll and x = left[y]\n    do x <- y\n      y <- p[y]\n  return y\n\ninsert(T, k): $O(h)$\n  y <- NUll\n  x <- root[T]\n  while x != NUll\n    do y <- x\n      if key[k] < key[x]\n        then x <- left[x]\n        else x <- right[x]\n  p[x] <- u\n  if y = NUll\n    then root[T] <- x #tree T is empty\n    else if key[k] < key[y]\n      then left[y] <- k\n      else right[y] <- k\n\ndelete(T, k): $O(h)$\n  if left[k] = NUll or right[k] = NUll\n    then y <- k\n    else y <- successor(k)\n  if left[y] != NUll\n    then x <- left[y]\n    else x <- right[y]\n  if x != NUll\n    then p[x] <- p[y]\n  if p[y] = NUll\n    then root[T] <- x\n    else if y = left[p[y]]\n      then left[p[y]] <- x\n      else right[p[y]] <- de\n  if y != k\n    then key[k] <- key[y]\n      copy y's satellite date into k\n  return y\n```\n> BST, .: x, x ()y, x  y , y  y (),\n\n\n#### Chapter13 ,?\n12, BST.BST,$O(n)$, , $O(\\log n)$., .\n> - define\n>> * node: color, key, left, right, p\n>> * :\n>>> 1. ,\n>>> 2. \n>>> 3. (NULL)(NULL , NULL , NULL )\n>>> 4. ,\n>>> 5. ,\n>>> 6. : (),x..\n> -  nil[T] , color=black\n\n> - :\n),, O(lgn),,\n:,.\n\n> - method\n>> *  ():\n\n,\n```\nleft-rotate(T, x)\n  y <- right[x]\n  right[x] <- left[y]\n  p[left[y]] <- x\n  p[y] <- p[x]\n  if p[x] = nil[T]\n    then root[t] <- y\n    else if x = left[p[x]]\n      then ledt[p[x]] <- y\n      else right[p[x]] <- y\n  left[y] <- y\n  p[x] <- y\n```\n>> * :\nZT,T,Z,Z,;Z,5,5;,24,\n:\ni. 2:;\nii. 4:;\n```\ninsert(T, k)\n  y <- nil[T]\n  x <- root[T]\n  while x != nil[T]\n    do y <- x\n      if key[k] < key[x]\n        then x <- left[x]\n        else x <- right[x]\n  p[x] <- y\n  if y = nil[T]\n    then root[T] <- k\n    else if key[k] < key[y]\n      then left[y] <- k\n      else right[y] <- k\n  left[k] <- nil[T]\n  right[k] <- nil[T]\n  color[k] <- red\n  insert-fixup(T, k)\n```\n\n>> * :\n,BST,\n,:\ni. \nii. \niii. ,,\n,5,5,,,5,\n:\ni. 2:y, y ,;\nii. 4:xp[y];\niii.5:y,;\n>> ```\ndelete(T, k)\n  if left[k] = nil[T] or right[k] = nil[T]\n    then y <- k\n    else y <- successor(k)\n  if left[y] != nil[T]\n    then x <- left[y]\n    else x <- right[y]\n  p[x] <- p[y]\n    then root[T] <- x\n    else if y = left[p[y]]\n      then left[p[y]] <- x\n      else right[p[y]] <- x\n  if y != k\n    then key[k] <- key[y]\n      copy y's satelite date into z\n  if color[y] = black\n    then delete-fixup(T, x)\n  return y\n```\n\n> - :C++STL map,set(,;Linux \n\n#### Chapter14 ,?\n> 1. ,,,\n> 2. (Dynamic order statistics)\nO(n)ii$O(\\log n)$(order statistic tree)\nxsize.sizex(x)\n> $$x.size=x.left.size+x.right.size+1$$\n>  i\n> ```\nOS-SELECT(x, i)\n    r = x.left.size + i\n    if i == r\n        return x\n    else if i < r\n        return OS-SELECT(x.left, i)\n    else\n        return OS-SELECT(x.right, i - r)\n```\n>  x r,x\nr = x.left.size + 1\nririxxixiriri-rxi-rO(lg n):\n> ```\nOS-RANK(T, x)\n    r = x.left.size + 1\n    y = x\n    while y != T.root\n        if y == y.p.right\n            r = r+ y.p.left.size + 1\n        y = y.p\n    return r\n```\n> size()xsizex\n,size,\n\n> 2. :\n> 3. :\n>> 1. \n>> 2. \n>> 3. \n>> 4. \n> 5. :,\n","slug":"CLRS-notes2","published":1,"updated":"2017-08-26T03:38:21.618Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3gm0006s7amwot9aejt","content":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h3 id=\"Part3-\"><a href=\"#Part3-\" class=\"headerlink\" title=\"Part3: \"></a>Part3: </h3><blockquote>\n<ol>\n<li>:</li>\n<li>(keyword) -&gt; ()</li>\n<li><blockquote>\n<ul>\n<li><code>search(S, k)</code></li>\n<li><code>insert(S, x)</code></li>\n<li><code>delete(S, x)</code></li>\n<li><code>maximum/minimum(S)</code></li>\n<li><code>successor/predecessor(S, x)</code></li>\n</ul>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<a id=\"more\"></a>\n<h4 id=\"Chapter10-\"><a href=\"#Chapter10-\" class=\"headerlink\" title=\"Chapter10 ?\"></a>Chapter10 ?</h4><ol>\n<li>stack<blockquote>\n<ul>\n<li>LIFO: </li>\n<li>data<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Sequence S; #</span><br><span class=\"line\">int top;</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<ul>\n<li>method<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">stack-empty(S): O(1)</span><br><span class=\"line\">  if top[S] = 0</span><br><span class=\"line\">    then return true</span><br><span class=\"line\">    else return false</span><br><span class=\"line\"></span><br><span class=\"line\">push(S, x): O(1)</span><br><span class=\"line\">  top[S] &lt;- top[S] + 1</span><br><span class=\"line\">  S[top[S]] &lt;- x</span><br><span class=\"line\"></span><br><span class=\"line\">pop(S): O(1)</span><br><span class=\"line\">   if stack-empty(S)</span><br><span class=\"line\">    then error &quot;underflow&quot;</span><br><span class=\"line\">    else top[S] &lt;- top[S] - 1</span><br><span class=\"line\">      return S[top[S] + 1]</span><br><span class=\"line\"></span><br><span class=\"line\">#stack, ,</span><br><span class=\"line\">stack-full(S): O(1)</span><br><span class=\"line\"> if top[S] == size(S)</span><br><span class=\"line\">    then return true</span><br><span class=\"line\">    else return false</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>apply:<blockquote>\n<p>-<br></p>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<ol start=\"2\">\n<li>queue<br>6heappriority_queue, queue:queue.queue:<blockquote>\n<ul>\n<li>FIFO: </li>\n<li>data:<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Sequence S;</span><br><span class=\"line\">int head, tail;</span><br><span class=\"line\">int length;</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<ul>\n<li>method<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">enqueue(Q, x): O(1)</span><br><span class=\"line\">  Q[tail[Q]] &lt;- x</span><br><span class=\"line\">  if tail[Q] = length[Q]</span><br><span class=\"line\">    then tail[Q] &lt;- 1</span><br><span class=\"line\">    else tail[Q] &lt;- tail[Q] + 1</span><br><span class=\"line\"></span><br><span class=\"line\">dequeue(Q): O(1)</span><br><span class=\"line\">  x &lt;- Q[head[Q]]</span><br><span class=\"line\">  if head[Q] = length[Q]</span><br><span class=\"line\">    then head[Q] &lt;- 1</span><br><span class=\"line\">    else head[Q] &lt;- head[Q] + 1</span><br><span class=\"line\">  return x</span><br><span class=\"line\">&gt;&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>apply:<blockquote>\n<ul>\n<li>FIFO; </li>\n</ul>\n</blockquote>\n</li>\n</ul>\n<ul>\n<li>: , BFS</li>\n</ul>\n</blockquote>\n<ol start=\"3\">\n<li>linkedlist<br>(, ), ()<blockquote>\n<ul>\n<li>data:<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Datatype data</span><br><span class=\"line\">pointer next, prev</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<ul>\n<li>method:<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">search(L, k): O(n)</span><br><span class=\"line\">  x &lt;- head[L]</span><br><span class=\"line\">  while x  != NULL and key[x] != k</span><br><span class=\"line\">    do x &lt;- next[x]</span><br><span class=\"line\">  return x</span><br><span class=\"line\"></span><br><span class=\"line\">insert(L, x): O(1) </span><br><span class=\"line\">  next[x] &lt;- head[L]</span><br><span class=\"line\">  if head[L] != NULL</span><br><span class=\"line\">    then prev[head[L]] &lt;- x</span><br><span class=\"line\">  head[L] &lt;- x</span><br><span class=\"line\">  prev[x] &lt;- NULL</span><br><span class=\"line\"></span><br><span class=\"line\">delete(L, x): x is pointer, O(1); x is key, O(n)</span><br><span class=\"line\">  if prev[x] != NULL</span><br><span class=\"line\">    then next[prev[x]] &lt;- next[x]</span><br><span class=\"line\">    else head[L] &lt;- next[x]</span><br><span class=\"line\">  if next[x] != NULL</span><br><span class=\"line\">    then prev[next[x]] &lt;- prev[x]</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>techique: (sentinel)<blockquote>\n<ul>\n<li>, ,<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">search(L, k)</span><br><span class=\"line\">  x &lt;- next[nil[L]]</span><br><span class=\"line\">  while x != nil[L] and key[x] != k</span><br><span class=\"line\">    do x &lt;- next[x]</span><br><span class=\"line\">  return x</span><br><span class=\"line\"></span><br><span class=\"line\">insert(L, x)</span><br><span class=\"line\">  next[x] &lt;- next[nil[L]]</span><br><span class=\"line\">  prev[next[nil[L]]] &lt;- x</span><br><span class=\"line\">  next[nil[L]] &lt;- x</span><br><span class=\"line\">  prev[x] &lt;- nil[L]</span><br><span class=\"line\"></span><br><span class=\"line\">delete(L, x)</span><br><span class=\"line\">  next[prev[x]] &lt;- next[x]</span><br><span class=\"line\">  prev[next[x]] &lt;- prev[x]</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>apply:<br>, , :, ,, ,;, , ,, .</li>\n</ul>\n</blockquote>\n<ol start=\"4\">\n<li><p><br>(fortran), 2prev, next,.<br>,, tag, , Cmalloc/free,.</p>\n</li>\n<li><p><br>, , :</p>\n<blockquote>\n<ul>\n<li>binary tree<blockquote>\n<ul>\n<li>node:<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data</span><br><span class=\"line\">pointer left, right</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<blockquote>\n<ul>\n<li>multi tree</li>\n<li>node:<blockquote>\n<ul>\n<li>data:</li>\n<li>pointer left-child, right-sibling #</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter10-\"><a href=\"#Chapter10-\" class=\"headerlink\" title=\"Chapter10 ?\"></a>Chapter10 ?</h4><ol>\n<li>hash table: key -&gt;(mapto) identifier<blockquote>\n<p>, $O(n)$, $O(1)$.,,$O(1)$, $O(1)$.<br>(),$O(1)$(), O(1)</p>\n</blockquote>\n</li>\n</ol>\n<p>. </p>\n<blockquote>\n<ol>\n<li><br>()<br>U,k, .<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">search(T, k)</span><br><span class=\"line\">  return T[k]</span><br><span class=\"line\"></span><br><span class=\"line\">insert(T, x)</span><br><span class=\"line\">  T[key[x]] &lt;- x</span><br><span class=\"line\"></span><br><span class=\"line\">delete(T, x)</span><br><span class=\"line\">  T[key[x]] &lt;- NULL</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li><br>kmT,:<br>\\begin{align}<br>hash-func: h: U -&gt; {0, 1, \\ldots ,m-1} \\\\<br> k \\mapsto h(k)<br>\\end{align}<br>: (collision)two key -&gt; one position<br>:<blockquote>\n<ol>\n<li>hash-func, </li>\n<li>(chaining): <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">search(T, x): O(1)</span><br><span class=\"line\">  search for an element with key in list T[h(k)]</span><br><span class=\"line\"></span><br><span class=\"line\">insert(T, x): O(1)</span><br><span class=\"line\">  insert x at the head of list T[h(key[x])]</span><br><span class=\"line\"></span><br><span class=\"line\">delete(T, x): O(1)</span><br><span class=\"line\">  delete x from the list T[h(key[x])]</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<p>,, O(n),,,</p>\n<ol start=\"3\">\n<li>hash-func<blockquote>\n<ol>\n<li>hash-func<br>\\begin{align}<br>random \\, k \\, 0 \\leq k &lt; 1,\\\\<br>h(k) = \\lfloor km \\rfloor<br>\\end{align}</li>\n</ol>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<ol start=\"2\">\n<li>$N$,,<blockquote>\n<p>a. :<br> m 2<br>$$h(k) = k\\mod m$$<br>b. :<br>: A(0&lt;A&lt;1), kA ;m,<br>$$h(k) = \\lfloor m(kA \\mod 1) \\rfloor$$<br>c.:,,<br>i. <br>ii. ,<br>iii. :$H$,$U${0,1,,m-1},.$H$,KJ,1/m<br>iv.:<br>p,k0p-1,0p-1.015, p17Zp {0, 1, 2, ,,p-1},Zp{1, 2, 3,,p-1} p ,<br><br>$h(a, b, k) = ((a*k + b) \\mod p) \\mod m$<br>aZp,bZpab,,<br>v.,:,a,b,,a,b</p>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<ol start=\"4\">\n<li>:<blockquote>\n<ul>\n<li>,pos,,pos,,</li>\n<li>, O(n),</li>\n<li>,,pos,tag,.</li>\n<li><br>.<blockquote>\n<ol>\n<li> linear probing<br>$$h(k,i) = (h(k)+i) \\mod m$$<br>$$h = U \\mapsto [0, 1, \\ldots, m-1]$$</li>\n<li> quadrating probing<br>$$h(k,i) = (h(k) + c_1i+ c_2i^2) \\mod m$$</li>\n<li><br>,.<br>$$h(k,i) = (h_1(k) + ih_2(k)) \\mod m$$</li>\n</ol>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<ol start=\"5\">\n<li>:<blockquote>\n<p>,$O(1)$,,.,.<br>:.</p>\n</blockquote>\n</li>\n</ol>\n<h4 id=\"Chapter12-\"><a href=\"#Chapter12-\" class=\"headerlink\" title=\"Chapter12 ?\"></a>Chapter12 ?</h4><ol>\n<li> binary search tree<blockquote>\n<ul>\n<li>define:<br>$$key[left[x]] \\leq key[x] \\bigcup key[right[x]] \\geq key[x]$$</li>\n<li>method<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">inorder-walk(x): $O(n)$</span><br><span class=\"line\">  if x != NULL</span><br><span class=\"line\">    then inorder-walk(left[x])</span><br><span class=\"line\">      visit key[x]</span><br><span class=\"line\">      inorder-walk[right[x]]</span><br><span class=\"line\"></span><br><span class=\"line\">search(x, k): $O(h)$</span><br><span class=\"line\">  if x = NULL or k = key[x]</span><br><span class=\"line\">    then return x</span><br><span class=\"line\">  if k &lt; key[x]</span><br><span class=\"line\">    then return search(left[x], k)</span><br><span class=\"line\">    else return search(right[x], k)</span><br><span class=\"line\"></span><br><span class=\"line\">minimum(x): $O(h)$</span><br><span class=\"line\">  while left[x] != NULL</span><br><span class=\"line\">    do x &lt;- left[x]</span><br><span class=\"line\">  return x</span><br><span class=\"line\"></span><br><span class=\"line\">maximum(x): $O(h)$</span><br><span class=\"line\">  while right[x] != NULL</span><br><span class=\"line\">    do x &lt;- right[x]</span><br><span class=\"line\">  return x</span><br><span class=\"line\"></span><br><span class=\"line\">successor(x): $O(h)$, </span><br><span class=\"line\">  if right[x] != NULL</span><br><span class=\"line\">    then return minimum(right[x])</span><br><span class=\"line\">  y &lt;- p[x]</span><br><span class=\"line\">  while y != NULL and x = right[y]</span><br><span class=\"line\">    do x &lt;- y</span><br><span class=\"line\">      y &lt;- p[y]</span><br><span class=\"line\">  return y</span><br><span class=\"line\"></span><br><span class=\"line\">predecessor(x): $O(h)$ </span><br><span class=\"line\">  if left[x] != NULL</span><br><span class=\"line\">    then return maxinum(left[x])</span><br><span class=\"line\">  y &lt; p[x]</span><br><span class=\"line\">  while y != NUll and x = left[y]</span><br><span class=\"line\">    do x &lt;- y</span><br><span class=\"line\">      y &lt;- p[y]</span><br><span class=\"line\">  return y</span><br><span class=\"line\"></span><br><span class=\"line\">insert(T, k): $O(h)$</span><br><span class=\"line\">  y &lt;- NUll</span><br><span class=\"line\">  x &lt;- root[T]</span><br><span class=\"line\">  while x != NUll</span><br><span class=\"line\">    do y &lt;- x</span><br><span class=\"line\">      if key[k] &lt; key[x]</span><br><span class=\"line\">        then x &lt;- left[x]</span><br><span class=\"line\">        else x &lt;- right[x]</span><br><span class=\"line\">  p[x] &lt;- u</span><br><span class=\"line\">  if y = NUll</span><br><span class=\"line\">    then root[T] &lt;- x #tree T is empty</span><br><span class=\"line\">    else if key[k] &lt; key[y]</span><br><span class=\"line\">      then left[y] &lt;- k</span><br><span class=\"line\">      else right[y] &lt;- k</span><br><span class=\"line\"></span><br><span class=\"line\">delete(T, k): $O(h)$</span><br><span class=\"line\">  if left[k] = NUll or right[k] = NUll</span><br><span class=\"line\">    then y &lt;- k</span><br><span class=\"line\">    else y &lt;- successor(k)</span><br><span class=\"line\">  if left[y] != NUll</span><br><span class=\"line\">    then x &lt;- left[y]</span><br><span class=\"line\">    else x &lt;- right[y]</span><br><span class=\"line\">  if x != NUll</span><br><span class=\"line\">    then p[x] &lt;- p[y]</span><br><span class=\"line\">  if p[y] = NUll</span><br><span class=\"line\">    then root[T] &lt;- x</span><br><span class=\"line\">    else if y = left[p[y]]</span><br><span class=\"line\">      then left[p[y]] &lt;- x</span><br><span class=\"line\">      else right[p[y]] &lt;- de</span><br><span class=\"line\">  if y != k</span><br><span class=\"line\">    then key[k] &lt;- key[y]</span><br><span class=\"line\">      copy y&apos;s satellite date into k</span><br><span class=\"line\">  return y</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<p>BST, .: x, x ()y, x  y , y  y (),</p>\n</blockquote>\n<h4 id=\"Chapter13--\"><a href=\"#Chapter13--\" class=\"headerlink\" title=\"Chapter13 ,?\"></a>Chapter13 ,?</h4><p>12, BST.BST,$O(n)$, , $O(\\log n)$., .</p>\n<blockquote>\n<ul>\n<li>define<blockquote>\n<ul>\n<li>node: color, key, left, right, p</li>\n<li>:<blockquote>\n<ol>\n<li>,</li>\n<li></li>\n<li>(NULL)(NULL , NULL , NULL )</li>\n<li>,</li>\n<li>,</li>\n<li>: (),x..</li>\n</ol>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n<li> nil[T] , color=black</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>:<br>),, O(lgn),,<br>:,.</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>method<blockquote>\n<ul>\n<li>():<br><br>,<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">left-rotate(T, x)</span><br><span class=\"line\">  y &lt;- right[x]</span><br><span class=\"line\">  right[x] &lt;- left[y]</span><br><span class=\"line\">  p[left[y]] &lt;- x</span><br><span class=\"line\">  p[y] &lt;- p[x]</span><br><span class=\"line\">  if p[x] = nil[T]</span><br><span class=\"line\">    then root[t] &lt;- y</span><br><span class=\"line\">    else if x = left[p[x]]</span><br><span class=\"line\">      then ledt[p[x]] &lt;- y</span><br><span class=\"line\">      else right[p[x]] &lt;- y</span><br><span class=\"line\">  left[y] &lt;- y</span><br><span class=\"line\">  p[x] &lt;- y</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<blockquote>\n<ul>\n<li>:<br>ZT,T,Z,Z,;Z,5,5;,24,<br>:<br>i. 2:;<br>ii. 4:;<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insert(T, k)</span><br><span class=\"line\">  y &lt;- nil[T]</span><br><span class=\"line\">  x &lt;- root[T]</span><br><span class=\"line\">  while x != nil[T]</span><br><span class=\"line\">    do y &lt;- x</span><br><span class=\"line\">      if key[k] &lt; key[x]</span><br><span class=\"line\">        then x &lt;- left[x]</span><br><span class=\"line\">        else x &lt;- right[x]</span><br><span class=\"line\">  p[x] &lt;- y</span><br><span class=\"line\">  if y = nil[T]</span><br><span class=\"line\">    then root[T] &lt;- k</span><br><span class=\"line\">    else if key[k] &lt; key[y]</span><br><span class=\"line\">      then left[y] &lt;- k</span><br><span class=\"line\">      else right[y] &lt;- k</span><br><span class=\"line\">  left[k] &lt;- nil[T]</span><br><span class=\"line\">  right[k] &lt;- nil[T]</span><br><span class=\"line\">  color[k] &lt;- red</span><br><span class=\"line\">  insert-fixup(T, k)</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<ul>\n<li>:<br>,BST,<br>,:<br>i. <br>ii. <br>iii. ,,<br>,5,5,,,5,<br>:<br>i. 2:y, y ,;<br>ii. 4:xp[y];<br>iii.5:y,;<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delete(T, k)</span><br><span class=\"line\">  if left[k] = nil[T] or right[k] = nil[T]</span><br><span class=\"line\">    then y &lt;- k</span><br><span class=\"line\">    else y &lt;- successor(k)</span><br><span class=\"line\">  if left[y] != nil[T]</span><br><span class=\"line\">    then x &lt;- left[y]</span><br><span class=\"line\">    else x &lt;- right[y]</span><br><span class=\"line\">  p[x] &lt;- p[y]</span><br><span class=\"line\">    then root[T] &lt;- x</span><br><span class=\"line\">    else if y = left[p[y]]</span><br><span class=\"line\">      then left[p[y]] &lt;- x</span><br><span class=\"line\">      else right[p[y]] &lt;- x</span><br><span class=\"line\">  if y != k</span><br><span class=\"line\">    then key[k] &lt;- key[y]</span><br><span class=\"line\">      copy y&apos;s satelite date into z</span><br><span class=\"line\">  if color[y] = black</span><br><span class=\"line\">    then delete-fixup(T, x)</span><br><span class=\"line\">  return y</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</blockquote>\n<blockquote>\n<ul>\n<li>:C++STL map,set(,;Linux </li>\n</ul>\n</blockquote>\n<h4 id=\"Chapter14--\"><a href=\"#Chapter14--\" class=\"headerlink\" title=\"Chapter14 ,?\"></a>Chapter14 ,?</h4><blockquote>\n<ol>\n<li>,,,</li>\n<li>(Dynamic order statistics)<br>O(n)ii$O(\\log n)$(order statistic tree)<br>xsize.sizex(x)<br>$$x.size=x.left.size+x.right.size+1$$<br> i<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OS-SELECT(x, i)</span><br><span class=\"line\">    r = x.left.size + i</span><br><span class=\"line\">    if i == r</span><br><span class=\"line\">        return x</span><br><span class=\"line\">    else if i &lt; r</span><br><span class=\"line\">        return OS-SELECT(x.left, i)</span><br><span class=\"line\">    else</span><br><span class=\"line\">        return OS-SELECT(x.right, i - r)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<p> x r,x<br>r = x.left.size + 1<br>ririxxixiriri-rxi-rO(lg n):<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OS-RANK(T, x)</span><br><span class=\"line\">    r = x.left.size + 1</span><br><span class=\"line\">    y = x</span><br><span class=\"line\">    while y != T.root</span><br><span class=\"line\">        if y == y.p.right</span><br><span class=\"line\">            r = r+ y.p.left.size + 1</span><br><span class=\"line\">        y = y.p</span><br><span class=\"line\">    return r</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>size()xsizex<br>,size,</p>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li>:</li>\n<li>:<blockquote>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n</blockquote>\n</li>\n<li>:,</li>\n</ol>\n</blockquote>\n","site":{"data":{}},"excerpt":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h3 id=\"Part3-\"><a href=\"#Part3-\" class=\"headerlink\" title=\"Part3: \"></a>Part3: </h3><blockquote>\n<ol>\n<li>:</li>\n<li>(keyword) -&gt; ()</li>\n<li><blockquote>\n<ul>\n<li><code>search(S, k)</code></li>\n<li><code>insert(S, x)</code></li>\n<li><code>delete(S, x)</code></li>\n<li><code>maximum/minimum(S)</code></li>\n<li><code>successor/predecessor(S, x)</code></li>\n</ul>\n</blockquote>\n</li>\n</ol>\n</blockquote>","more":"<h4 id=\"Chapter10-\"><a href=\"#Chapter10-\" class=\"headerlink\" title=\"Chapter10 ?\"></a>Chapter10 ?</h4><ol>\n<li>stack<blockquote>\n<ul>\n<li>LIFO: </li>\n<li>data<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Sequence S; #</span><br><span class=\"line\">int top;</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<ul>\n<li>method<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">stack-empty(S): O(1)</span><br><span class=\"line\">  if top[S] = 0</span><br><span class=\"line\">    then return true</span><br><span class=\"line\">    else return false</span><br><span class=\"line\"></span><br><span class=\"line\">push(S, x): O(1)</span><br><span class=\"line\">  top[S] &lt;- top[S] + 1</span><br><span class=\"line\">  S[top[S]] &lt;- x</span><br><span class=\"line\"></span><br><span class=\"line\">pop(S): O(1)</span><br><span class=\"line\">   if stack-empty(S)</span><br><span class=\"line\">    then error &quot;underflow&quot;</span><br><span class=\"line\">    else top[S] &lt;- top[S] - 1</span><br><span class=\"line\">      return S[top[S] + 1]</span><br><span class=\"line\"></span><br><span class=\"line\">#stack, ,</span><br><span class=\"line\">stack-full(S): O(1)</span><br><span class=\"line\"> if top[S] == size(S)</span><br><span class=\"line\">    then return true</span><br><span class=\"line\">    else return false</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>apply:<blockquote>\n<p>-<br></p>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<ol start=\"2\">\n<li>queue<br>6heappriority_queue, queue:queue.queue:<blockquote>\n<ul>\n<li>FIFO: </li>\n<li>data:<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Sequence S;</span><br><span class=\"line\">int head, tail;</span><br><span class=\"line\">int length;</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<ul>\n<li>method<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">enqueue(Q, x): O(1)</span><br><span class=\"line\">  Q[tail[Q]] &lt;- x</span><br><span class=\"line\">  if tail[Q] = length[Q]</span><br><span class=\"line\">    then tail[Q] &lt;- 1</span><br><span class=\"line\">    else tail[Q] &lt;- tail[Q] + 1</span><br><span class=\"line\"></span><br><span class=\"line\">dequeue(Q): O(1)</span><br><span class=\"line\">  x &lt;- Q[head[Q]]</span><br><span class=\"line\">  if head[Q] = length[Q]</span><br><span class=\"line\">    then head[Q] &lt;- 1</span><br><span class=\"line\">    else head[Q] &lt;- head[Q] + 1</span><br><span class=\"line\">  return x</span><br><span class=\"line\">&gt;&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>apply:<blockquote>\n<ul>\n<li>FIFO; </li>\n</ul>\n</blockquote>\n</li>\n</ul>\n<ul>\n<li>: , BFS</li>\n</ul>\n</blockquote>\n<ol start=\"3\">\n<li>linkedlist<br>(, ), ()<blockquote>\n<ul>\n<li>data:<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Datatype data</span><br><span class=\"line\">pointer next, prev</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<ul>\n<li>method:<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">search(L, k): O(n)</span><br><span class=\"line\">  x &lt;- head[L]</span><br><span class=\"line\">  while x  != NULL and key[x] != k</span><br><span class=\"line\">    do x &lt;- next[x]</span><br><span class=\"line\">  return x</span><br><span class=\"line\"></span><br><span class=\"line\">insert(L, x): O(1) </span><br><span class=\"line\">  next[x] &lt;- head[L]</span><br><span class=\"line\">  if head[L] != NULL</span><br><span class=\"line\">    then prev[head[L]] &lt;- x</span><br><span class=\"line\">  head[L] &lt;- x</span><br><span class=\"line\">  prev[x] &lt;- NULL</span><br><span class=\"line\"></span><br><span class=\"line\">delete(L, x): x is pointer, O(1); x is key, O(n)</span><br><span class=\"line\">  if prev[x] != NULL</span><br><span class=\"line\">    then next[prev[x]] &lt;- next[x]</span><br><span class=\"line\">    else head[L] &lt;- next[x]</span><br><span class=\"line\">  if next[x] != NULL</span><br><span class=\"line\">    then prev[next[x]] &lt;- prev[x]</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>techique: (sentinel)<blockquote>\n<ul>\n<li>, ,<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">search(L, k)</span><br><span class=\"line\">  x &lt;- next[nil[L]]</span><br><span class=\"line\">  while x != nil[L] and key[x] != k</span><br><span class=\"line\">    do x &lt;- next[x]</span><br><span class=\"line\">  return x</span><br><span class=\"line\"></span><br><span class=\"line\">insert(L, x)</span><br><span class=\"line\">  next[x] &lt;- next[nil[L]]</span><br><span class=\"line\">  prev[next[nil[L]]] &lt;- x</span><br><span class=\"line\">  next[nil[L]] &lt;- x</span><br><span class=\"line\">  prev[x] &lt;- nil[L]</span><br><span class=\"line\"></span><br><span class=\"line\">delete(L, x)</span><br><span class=\"line\">  next[prev[x]] &lt;- next[x]</span><br><span class=\"line\">  prev[next[x]] &lt;- prev[x]</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>apply:<br>, , :, ,, ,;, , ,, .</li>\n</ul>\n</blockquote>\n<ol start=\"4\">\n<li><p><br>(fortran), 2prev, next,.<br>,, tag, , Cmalloc/free,.</p>\n</li>\n<li><p><br>, , :</p>\n<blockquote>\n<ul>\n<li>binary tree<blockquote>\n<ul>\n<li>node:<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data</span><br><span class=\"line\">pointer left, right</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<blockquote>\n<ul>\n<li>multi tree</li>\n<li>node:<blockquote>\n<ul>\n<li>data:</li>\n<li>pointer left-child, right-sibling #</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</blockquote>\n<h4 id=\"Chapter10-\"><a href=\"#Chapter10-\" class=\"headerlink\" title=\"Chapter10 ?\"></a>Chapter10 ?</h4><ol>\n<li>hash table: key -&gt;(mapto) identifier<blockquote>\n<p>, $O(n)$, $O(1)$.,,$O(1)$, $O(1)$.<br>(),$O(1)$(), O(1)</p>\n</blockquote>\n</li>\n</ol>\n<p>. </p>\n<blockquote>\n<ol>\n<li><br>()<br>U,k, .<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">search(T, k)</span><br><span class=\"line\">  return T[k]</span><br><span class=\"line\"></span><br><span class=\"line\">insert(T, x)</span><br><span class=\"line\">  T[key[x]] &lt;- x</span><br><span class=\"line\"></span><br><span class=\"line\">delete(T, x)</span><br><span class=\"line\">  T[key[x]] &lt;- NULL</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li><br>kmT,:<br>\\begin{align}<br>hash-func: h: U -&gt; {0, 1, \\ldots ,m-1} \\\\<br> k \\mapsto h(k)<br>\\end{align}<br>: (collision)two key -&gt; one position<br>:<blockquote>\n<ol>\n<li>hash-func, </li>\n<li>(chaining): <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">search(T, x): O(1)</span><br><span class=\"line\">  search for an element with key in list T[h(k)]</span><br><span class=\"line\"></span><br><span class=\"line\">insert(T, x): O(1)</span><br><span class=\"line\">  insert x at the head of list T[h(key[x])]</span><br><span class=\"line\"></span><br><span class=\"line\">delete(T, x): O(1)</span><br><span class=\"line\">  delete x from the list T[h(key[x])]</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<p>,, O(n),,,</p>\n<ol start=\"3\">\n<li>hash-func<blockquote>\n<ol>\n<li>hash-func<br>\\begin{align}<br>random \\, k \\, 0 \\leq k &lt; 1,\\\\<br>h(k) = \\lfloor km \\rfloor<br>\\end{align}</li>\n</ol>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<ol start=\"2\">\n<li>$N$,,<blockquote>\n<p>a. :<br> m 2<br>$$h(k) = k\\mod m$$<br>b. :<br>: A(0&lt;A&lt;1), kA ;m,<br>$$h(k) = \\lfloor m(kA \\mod 1) \\rfloor$$<br>c.:,,<br>i. <br>ii. ,<br>iii. :$H$,$U${0,1,,m-1},.$H$,KJ,1/m<br>iv.:<br>p,k0p-1,0p-1.015, p17Zp {0, 1, 2, ,,p-1},Zp{1, 2, 3,,p-1} p ,<br><br>$h(a, b, k) = ((a*k + b) \\mod p) \\mod m$<br>aZp,bZpab,,<br>v.,:,a,b,,a,b</p>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<ol start=\"4\">\n<li>:<blockquote>\n<ul>\n<li>,pos,,pos,,</li>\n<li>, O(n),</li>\n<li>,,pos,tag,.</li>\n<li><br>.<blockquote>\n<ol>\n<li> linear probing<br>$$h(k,i) = (h(k)+i) \\mod m$$<br>$$h = U \\mapsto [0, 1, \\ldots, m-1]$$</li>\n<li> quadrating probing<br>$$h(k,i) = (h(k) + c_1i+ c_2i^2) \\mod m$$</li>\n<li><br>,.<br>$$h(k,i) = (h_1(k) + ih_2(k)) \\mod m$$</li>\n</ol>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<ol start=\"5\">\n<li>:<blockquote>\n<p>,$O(1)$,,.,.<br>:.</p>\n</blockquote>\n</li>\n</ol>\n<h4 id=\"Chapter12-\"><a href=\"#Chapter12-\" class=\"headerlink\" title=\"Chapter12 ?\"></a>Chapter12 ?</h4><ol>\n<li> binary search tree<blockquote>\n<ul>\n<li>define:<br>$$key[left[x]] \\leq key[x] \\bigcup key[right[x]] \\geq key[x]$$</li>\n<li>method<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">inorder-walk(x): $O(n)$</span><br><span class=\"line\">  if x != NULL</span><br><span class=\"line\">    then inorder-walk(left[x])</span><br><span class=\"line\">      visit key[x]</span><br><span class=\"line\">      inorder-walk[right[x]]</span><br><span class=\"line\"></span><br><span class=\"line\">search(x, k): $O(h)$</span><br><span class=\"line\">  if x = NULL or k = key[x]</span><br><span class=\"line\">    then return x</span><br><span class=\"line\">  if k &lt; key[x]</span><br><span class=\"line\">    then return search(left[x], k)</span><br><span class=\"line\">    else return search(right[x], k)</span><br><span class=\"line\"></span><br><span class=\"line\">minimum(x): $O(h)$</span><br><span class=\"line\">  while left[x] != NULL</span><br><span class=\"line\">    do x &lt;- left[x]</span><br><span class=\"line\">  return x</span><br><span class=\"line\"></span><br><span class=\"line\">maximum(x): $O(h)$</span><br><span class=\"line\">  while right[x] != NULL</span><br><span class=\"line\">    do x &lt;- right[x]</span><br><span class=\"line\">  return x</span><br><span class=\"line\"></span><br><span class=\"line\">successor(x): $O(h)$, </span><br><span class=\"line\">  if right[x] != NULL</span><br><span class=\"line\">    then return minimum(right[x])</span><br><span class=\"line\">  y &lt;- p[x]</span><br><span class=\"line\">  while y != NULL and x = right[y]</span><br><span class=\"line\">    do x &lt;- y</span><br><span class=\"line\">      y &lt;- p[y]</span><br><span class=\"line\">  return y</span><br><span class=\"line\"></span><br><span class=\"line\">predecessor(x): $O(h)$ </span><br><span class=\"line\">  if left[x] != NULL</span><br><span class=\"line\">    then return maxinum(left[x])</span><br><span class=\"line\">  y &lt; p[x]</span><br><span class=\"line\">  while y != NUll and x = left[y]</span><br><span class=\"line\">    do x &lt;- y</span><br><span class=\"line\">      y &lt;- p[y]</span><br><span class=\"line\">  return y</span><br><span class=\"line\"></span><br><span class=\"line\">insert(T, k): $O(h)$</span><br><span class=\"line\">  y &lt;- NUll</span><br><span class=\"line\">  x &lt;- root[T]</span><br><span class=\"line\">  while x != NUll</span><br><span class=\"line\">    do y &lt;- x</span><br><span class=\"line\">      if key[k] &lt; key[x]</span><br><span class=\"line\">        then x &lt;- left[x]</span><br><span class=\"line\">        else x &lt;- right[x]</span><br><span class=\"line\">  p[x] &lt;- u</span><br><span class=\"line\">  if y = NUll</span><br><span class=\"line\">    then root[T] &lt;- x #tree T is empty</span><br><span class=\"line\">    else if key[k] &lt; key[y]</span><br><span class=\"line\">      then left[y] &lt;- k</span><br><span class=\"line\">      else right[y] &lt;- k</span><br><span class=\"line\"></span><br><span class=\"line\">delete(T, k): $O(h)$</span><br><span class=\"line\">  if left[k] = NUll or right[k] = NUll</span><br><span class=\"line\">    then y &lt;- k</span><br><span class=\"line\">    else y &lt;- successor(k)</span><br><span class=\"line\">  if left[y] != NUll</span><br><span class=\"line\">    then x &lt;- left[y]</span><br><span class=\"line\">    else x &lt;- right[y]</span><br><span class=\"line\">  if x != NUll</span><br><span class=\"line\">    then p[x] &lt;- p[y]</span><br><span class=\"line\">  if p[y] = NUll</span><br><span class=\"line\">    then root[T] &lt;- x</span><br><span class=\"line\">    else if y = left[p[y]]</span><br><span class=\"line\">      then left[p[y]] &lt;- x</span><br><span class=\"line\">      else right[p[y]] &lt;- de</span><br><span class=\"line\">  if y != k</span><br><span class=\"line\">    then key[k] &lt;- key[y]</span><br><span class=\"line\">      copy y&apos;s satellite date into k</span><br><span class=\"line\">  return y</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<blockquote>\n<p>BST, .: x, x ()y, x  y , y  y (),</p>\n</blockquote>\n<h4 id=\"Chapter13--\"><a href=\"#Chapter13--\" class=\"headerlink\" title=\"Chapter13 ,?\"></a>Chapter13 ,?</h4><p>12, BST.BST,$O(n)$, , $O(\\log n)$., .</p>\n<blockquote>\n<ul>\n<li>define<blockquote>\n<ul>\n<li>node: color, key, left, right, p</li>\n<li>:<blockquote>\n<ol>\n<li>,</li>\n<li></li>\n<li>(NULL)(NULL , NULL , NULL )</li>\n<li>,</li>\n<li>,</li>\n<li>: (),x..</li>\n</ol>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n</li>\n<li> nil[T] , color=black</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>:<br>),, O(lgn),,<br>:,.</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>method<blockquote>\n<ul>\n<li>():<br><br>,<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">left-rotate(T, x)</span><br><span class=\"line\">  y &lt;- right[x]</span><br><span class=\"line\">  right[x] &lt;- left[y]</span><br><span class=\"line\">  p[left[y]] &lt;- x</span><br><span class=\"line\">  p[y] &lt;- p[x]</span><br><span class=\"line\">  if p[x] = nil[T]</span><br><span class=\"line\">    then root[t] &lt;- y</span><br><span class=\"line\">    else if x = left[p[x]]</span><br><span class=\"line\">      then ledt[p[x]] &lt;- y</span><br><span class=\"line\">      else right[p[x]] &lt;- y</span><br><span class=\"line\">  left[y] &lt;- y</span><br><span class=\"line\">  p[x] &lt;- y</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<blockquote>\n<ul>\n<li>:<br>ZT,T,Z,Z,;Z,5,5;,24,<br>:<br>i. 2:;<br>ii. 4:;<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insert(T, k)</span><br><span class=\"line\">  y &lt;- nil[T]</span><br><span class=\"line\">  x &lt;- root[T]</span><br><span class=\"line\">  while x != nil[T]</span><br><span class=\"line\">    do y &lt;- x</span><br><span class=\"line\">      if key[k] &lt; key[x]</span><br><span class=\"line\">        then x &lt;- left[x]</span><br><span class=\"line\">        else x &lt;- right[x]</span><br><span class=\"line\">  p[x] &lt;- y</span><br><span class=\"line\">  if y = nil[T]</span><br><span class=\"line\">    then root[T] &lt;- k</span><br><span class=\"line\">    else if key[k] &lt; key[y]</span><br><span class=\"line\">      then left[y] &lt;- k</span><br><span class=\"line\">      else right[y] &lt;- k</span><br><span class=\"line\">  left[k] &lt;- nil[T]</span><br><span class=\"line\">  right[k] &lt;- nil[T]</span><br><span class=\"line\">  color[k] &lt;- red</span><br><span class=\"line\">  insert-fixup(T, k)</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<ul>\n<li>:<br>,BST,<br>,:<br>i. <br>ii. <br>iii. ,,<br>,5,5,,,5,<br>:<br>i. 2:y, y ,;<br>ii. 4:xp[y];<br>iii.5:y,;<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delete(T, k)</span><br><span class=\"line\">  if left[k] = nil[T] or right[k] = nil[T]</span><br><span class=\"line\">    then y &lt;- k</span><br><span class=\"line\">    else y &lt;- successor(k)</span><br><span class=\"line\">  if left[y] != nil[T]</span><br><span class=\"line\">    then x &lt;- left[y]</span><br><span class=\"line\">    else x &lt;- right[y]</span><br><span class=\"line\">  p[x] &lt;- p[y]</span><br><span class=\"line\">    then root[T] &lt;- x</span><br><span class=\"line\">    else if y = left[p[y]]</span><br><span class=\"line\">      then left[p[y]] &lt;- x</span><br><span class=\"line\">      else right[p[y]] &lt;- x</span><br><span class=\"line\">  if y != k</span><br><span class=\"line\">    then key[k] &lt;- key[y]</span><br><span class=\"line\">      copy y&apos;s satelite date into z</span><br><span class=\"line\">  if color[y] = black</span><br><span class=\"line\">    then delete-fixup(T, x)</span><br><span class=\"line\">  return y</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n</blockquote>\n<blockquote>\n<ul>\n<li>:C++STL map,set(,;Linux </li>\n</ul>\n</blockquote>\n<h4 id=\"Chapter14--\"><a href=\"#Chapter14--\" class=\"headerlink\" title=\"Chapter14 ,?\"></a>Chapter14 ,?</h4><blockquote>\n<ol>\n<li>,,,</li>\n<li>(Dynamic order statistics)<br>O(n)ii$O(\\log n)$(order statistic tree)<br>xsize.sizex(x)<br>$$x.size=x.left.size+x.right.size+1$$<br> i<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OS-SELECT(x, i)</span><br><span class=\"line\">    r = x.left.size + i</span><br><span class=\"line\">    if i == r</span><br><span class=\"line\">        return x</span><br><span class=\"line\">    else if i &lt; r</span><br><span class=\"line\">        return OS-SELECT(x.left, i)</span><br><span class=\"line\">    else</span><br><span class=\"line\">        return OS-SELECT(x.right, i - r)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<p> x r,x<br>r = x.left.size + 1<br>ririxxixiriri-rxi-rO(lg n):<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OS-RANK(T, x)</span><br><span class=\"line\">    r = x.left.size + 1</span><br><span class=\"line\">    y = x</span><br><span class=\"line\">    while y != T.root</span><br><span class=\"line\">        if y == y.p.right</span><br><span class=\"line\">            r = r+ y.p.left.size + 1</span><br><span class=\"line\">        y = y.p</span><br><span class=\"line\">    return r</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>size()xsizex<br>,size,</p>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li>:</li>\n<li>:<blockquote>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n</blockquote>\n</li>\n<li>:,</li>\n</ol>\n</blockquote>"},{"title":"introduction to algorithms note4","date":"2017-05-01T16:00:00.000Z","_content":"\n# Introduction to algorithms\n## Part5 \n[part3](https://chestnutme.github.io/2017/04/17/CLRS-notes2/),,stack/queue/bst/rbt.[part4](https://chestnutme.github.io/2017/04/22/CLRS-notes3/)/,.,part5\n* B:., B ,B B+,B+.\n* :`Insert,Mininum,Extract-Min,union,delete,decrease-key`.\n> *  $O(\\log n)$ . `union`,,, $O(n)$ .\n> * `extract-min,delete` O(1),`extract-min,delete` $O(\\log n)$ .`decrease-key` O(1).,.(part6,),.\n* ():n.`union, find-set`,:m $O(n\\alpha (n) )$, n,(n)<=4, $O(n)$.\n\n<!-- more -->\n### Chapter18 \n1.B-tree \n> ,,,(,), I/O,(),(),:.,.,,,.\n> ,B `disk-read``disk-write` ,,., B ,.,B.\n, ,.,.,,,.\n> B.\n\n[b-tree](/images/b-tree.png)\n\n2.B-tree\n> B,B,.part3red-black-tree),I/0.BB,B+,B*.B,B,.B?,nB $O(\\log n)$,,.,B$O(\\log n)$,`insert,delete`.\n\n> root[T])B\n> 1. x\n>> a. n[x], x\n>> b. n[x],, $key\\_1[x] \\leq key\\_2[x] \\leq \\dots \\leq key\\_{n[x]}[x]$\n>> c. leaf[x], bool,true\n> 2. n[x] + 1 $c\\_1[x], c\\_2[x], \\dots, c\\_{n[x]+1}$\n> 3. $key\\_i[x]$ , $k\\_i$ $c\\_i[x]$ , \n> $$ k\\_1 \\leq key\\_1[x] \\leq k\\_2 \\leq key\\_2[x] \\leq \\dots key\\_{n[x]}[x] \\leq k\\_{n[x]+1}$$\n> 4. , h\n> 5. t\n>> a. 2m-1.2m.2m-1,\n>> b. 2m-1.2m.2m-1,\n\nn,h, $t \\geq 2$B\n>Bh,,t-1,\n2, 2t, $2t^2$,\n$$ n \\geq 1 + (t-1)\\sum\\_{i=1}^h 2t^{i-1} = 1 + 2(t-1)(\\frac{t^h-1}{t-1}) =  2t^h - 1 $$\n$$ h \\leq \\log\\_t \\frac{n+1}{2} $$\n\n3.B:\n\n> 1.  $O(t \\log_t n)$bst\n```\nb-tree-search(x, k):\ni <- 1\nwhile i \u0002<= n[x] and k > keyi[x]\n  do i <- i + 1\nif i <= n[x] and k= keyi[x]\n  then return (x,i)\nif leaf[x]\n  then return NULL\n  else disk-read(ci[x])\n    return b-tree-search(ci[x], k)\n```\n\n> 2.  $O(t \\log_t n)$\n,B,,,,,,,,,,,,,.,,,,.\n```\nb-tree-split-child(x, i, y)\nz <- allocate-node()\nlead[z] <- leaf[y]\nn[z] <- t - 1\nfor j <- 1 ot t - 1\n  do keyi[z] <- key[j+i][y]\nif not leaf[y]\n  then for j <- 1 to t\n    do cj[z] <- c[j+i][y]\nn[y] <- t - 1\nfor j <- n[x] + 1 downto i + 1\n  do c[j+1][x] <- cj[x]\nc[i+1][x] <- z\nfor j <- n[x] downto i\n  do key[j+1][x] <- keyj[x]\nkeyi[x] <- keyi[y]\nn[x] <- n[x] + 1\ndisk-write(y)\ndisk-write(z)\ndisk-write(x)\n\nb-tree-insert(T, k)\nr <- root[T]\nif n[r] = 2t - 1\n  then s <- allocate-node()\n    root[T] <- s\n    leaf[s] <- False\n    n[s] <- 0\n    c1[s] <- r\n    b-tree-split-child(s, 1, r)\n    b-tree-insert-nonfull(s, k)\nelse b-tree-insert-nonfull(r, k)\n\nb-tree-insert-nonfull(x, k): #kx\ni <- n[x]\nif leaf[x]\n  then while i >= 1 and k < keyi[x]\n      do key[i+1][x] <- keyi[x]\n        i<- i - 1\n    key[i+1][x] <- k\n    n[x] <- n[x] + 1\n    disk-write(x)\n  else while i >= 1 and k < keyi[x]\n      do i <- i + 1\n      i <- i + 1\n      disk-read(ci[x])\n      if n[ci[x]] = 2t - 1\n        then b-tree-split-child(x, i, ci[x])\n          if k > keyi[x]\n            then i <- i + 1\n        b-tree-insert-nonfull(ci[x], k)\n```\n\n> 3.  $O(t \\log_t n)$\n,,,.,,,\n:\n K () K ()()(). B :B\n[t-1, 2*t-1],Min = t - 1.K, K()K' K, K'.*x K:\n>> a.  x->keynum>Min,K(x,K).\n>> b.  x->keynum=Min,,KB3.x()y Min,y()parent ,parent x .;y ,keynum1,Min,1keynumMin;x, K x Min . B-3.\n,.\n>> c.x() Min,,x.xy(),xK,parentxyK,,xy\"\"xy.xyMin,K'x K, 2Min(2t-2 <= 2t-1),B3. K',parentK',parent->keynum Min,;,*parent parent B.,,,,.\n,hB, $O(h)$ ,, $O(1)$ `disk-read,disk-write`, $O(th)=O(tlog_tn)$.\n\n### Chapter19 \n1.(Binomial Heaps)\n> Binomial Heap(Binary Heap).,,Mergeable Heap.x.,(Binomial Tree)(Binary Trees).,,,.\n\n. $B_k$. $B\\_0$. $B\\_k$ $B\\_{k-1}$.\n> 1.2k.\n> 2.k.\n> 3.i $C_i^k$.\n> 4.k,k-1, k-2, , 0,i$B_i$.\n\n![b-heap1](/images/b-heap1.jpg)\n\n> ,\n> 1. ., <= .\n> 2. k,k.\n. n  $\\log n + 1$\n\n2.\n,(heap[H]),, .x\n> 1. p[x],x\n> 2. child[x],x\n> 3. sibling[x], x\n![b-heap2](/images/b-heap2.jpg)\n\n3.\n> 1.: $O(1)$\n```\nmake\nhead[H] = NULL\n```\n\n> 2. $O(\\log n)$\n```\nbinomial-heap-minimum(H)\ny <- NULL\nx <- heap[H]\nmin <- INT\nwhile x != NULL\n  do if key[x] < min\n    then min <- key[y]\n      y <- x\n  x <- sibling[x]\nreturn y\n```\n\n> 3.\n`union`,`union`.\n:,,.K,.K,K+1,.K.\n\n```\nbinomial-link(y, z)#Bk-1Bk\np[y] <- z\nsibling[y] <- child[z]\nchild[z] <- y\ndegree[z] <- degree[z] + 1\nbinomial-heap-merge #H1H2\nbinomial-heap-union #\nH <- make-binomial-heap()\nhead[H] <- binomial-heap-merge(H1, H2)\nfree the objects H1 and H2 but not the lists they point to\nif head[H] = NULL\n  then return H\nprev-x <- NULL\nx <- head[H]\nnext-x <- sibling[x]\nwhile next-x  NULL\n  do if (degree[x]  degree[next-x]) or (sibling[next-x]  NULL and degree[sibling[next-x]] = degree[x])\n    then prev-x <- x  Cases 1 and 2                #case1 and 2\n      x <- next-x  Cases 1 and 2\n    else if key[x]  key[next-x]\n      then sibling[x] <- sibling[next-x]  Case 3   #case3\n        binomial-link(next-x, x)  Case 3\n    else if prev-x = NULL  Case 4                  #case4\n      then head[H] <- next-x  Case 4\n      else sibling[prev-x] <- next-x  Case 4\n      binomial-link(x, next-x)  Case 4\n      x <- next-x  Case 4\n  next-x <- sibling[x]\nreturn H\n```\n>> `union`\n`binomial-heap-merge`,H1H2H,.MERGE $O(\\log n)$.nH1H2.,,.\n,.,H.,, $O(1)$,,n,lg(n), $O(\\log n)$,merge $O(\\log n)$, $O(\\log n)$.mergeH,,,\nx,:\n>> Case1degree[x] != degree[sibling[x]].,,.\n>> Case2degree[x] == degree[sibling[x]] == degree[sibling[sibling[x]]].,,.\n>> Case3 & Case4degree[x] = degree[sibling[x]] != degree[sibling[sibling[x]]]\nCase3key[x] <= key[sibling[x]].,sibling[x]x.\nCase4key[x] > key[sibling[x]].,xsibling[x].\n\n> 4.: $O(\\log n)$\n```\nbinomial-heap-insert(H, x)\nH <- make-binomial-heap()\np[x] <- NULL\nchild[x] <- NULL\nsibling[x] <- NULL\ndegree[x] <- 0\nhead[H] <- x\nH <- binomial-heap-union(H, H)\n```\n\n> 5. $O(\\log n)$\n```\nbinomial-heap-extract-min(H):\nfind the root x with the minimum key in the root list of H,\nand remove x from the root list of H\nH <- make-binomial-heap()\nreverse the order of the linked list of xs children,\nand set head[H] to point to the head of the resulting list\nH <- binomial-heap-union(H, H)\n```\n\n> 6.\n,key[y]yz.ykey[y] >= key[z],.,z,\n```\nbinomial-heap-decrease-key(H, x, k)\nif k > key[x]\n  then error \"new key is greater than current key\"\nkey[x] <- k\ny <- x\nz <- p[y]\nwhile z  NULL and key[y] < key[z]\n  do exchange key[y]  key[z]\n  y <- z\n  z <- p[y]\n```\n\n> 7.\n```\nbinomial-heap-delete(H, x)\n1 binomial-heap-decrease-key(H, x, -INT)\n2 binomial-heap-extract-min(H)\n```\n\n4.\n>  =  + `decrease-key,union`\n, `union`.`union`,.\n:.`search`,`search`!`decrease-key``delete`.\n\n### Chapter20 \n1.\n> (Fibonacci heap),,.,O(1).\n,,.\n,,.\n\n[fib-heap](/images/fib.jpg)\n\n> .,min[H].\n\n>> 1. p[x],x\n>> 2. child[x], x\n>> 3. x\n>> 4. degree,x\n>> 5. mark,x,,TRUE\n\n2.\n> 1. \n```\nmake-fib-heap()\nH <- allocate-node()\nn[H] = 0\nmin[h] = NULL\nreturn H\n```\n\n> 2. : $O(1)$\n```\nfib-heap-insert(H, x)\ndegree[x] <- 0\np[x] <- NUll\nchild[x] <- NULL\nleft[x] <- x\nright[x] <- x\nmark[x] = false\nconcatenate the root list containing x with root list H\nif min[H] = NULL or key[x] < key[min[H]]\n  then min[H] <- x\nn[H] <- n[H] + 1\n```\n\n> 3. : $O(1)$\n,\n>> 1.\n>> 2.min[H],min[H],\n```\nfib-heap-union(H1, H2)\nH <- make-fib-heap()\nmin[H] <- min[H1]\nconcatenate the root list of H@ with the root list of H\nif (min[H1] = NULL) or (min[H2] != NULL) and min[H2] < min[H1])\n  then min[H1] <- min[H2]\nn[H] <- n[H1] + n[H2]\nfree the objects H1 and H2\nreturn H\n```\n\n> 4. : $O(\\log n)$\n,\n>> 1. ,,\n>> 2. ,\n,,, K .(,.)\n1: x  y, key[x]<key[y]\n2:yx. y , x,degree[x].,y.\n```\nfib-heap-extract-min(H)\nz <- min[H]\nif z != NULL\n  then for each child x of z\n    do add x to the root list of H\n      p[x] <- NULL\n    remove z from the root list of H\n    if z = right[z]\n      then min[H] <- NULL\n      else min[H] <- right[z]\n        consolidate(H)\n    n[H] <- n[H] - 1\n\nconsolidate(H): #H,\n```\n> 5. : $O(1)$\n,,.,.\n>> 1.,;\n>> 2.,,, mark ; false,, true; true,,; mark  false .\n```\nfib-heap-decrease-key(H, x, k)\nif k > key[x]\n  then return error \"new key is greater than current key\"\nkey[x] <- k\ny <- p[x]\nif y != NULL and key[x] < key[y]\n  then cut(H, x, y)\n    cascading-cut\nif key[x] < key[min[h]]\n  then min[h] <- x\n\ncut(H, x, y)\nremove x from the child list of y, decrementing degree[y]\nadd x to the root list of H\np[x] <- NULL\nmark[x] <- False\n\ncascading-cut(H, y)\nz <- p[y]\nif z != NULL\n   then if mark[y] = False\n      mark[y] <- true\n      else cut(H, y, z)\n        cascading-cut(H, z)\n```\n\n> 6. \n```\nfib-heap-delete(H, x)\nfib-heap-decrease-key(H, x, -INT)\nfib-heap-extract-min(H)\n```\n\n3.\n,,`extract-min`  `delete`.,,,., `extract-min`  `delete` .\n,,,.,.\n,, `extract-min` `delete` .Prime  Djikstra .\n\n### Chapter21 -\n1.\ndisjoing-set data structure) $S = \\\\{S_1,S_2,S_3, \\dots, S_k\\\\}$.,.\n\n> 1. `make-set(x)` ,x,.,x.\n> 2. `union(x,y)` xy $S_xS_y$..,$Sx \\bigcup Sy$,`union`,SxSy.,SxSy,S.\n> 3. `find-set(x)`,x.\n\n2.\n,.\n> 1.\n>> a. \n>> b. , $O(1)$\n>> c. ,,, $O(n)$.\n>> d. :,.\n\n> 2.\n> ,,.,.,.,,,,\n```\nmake-set(x)\np[x] <- x\nrank[x] <- 0\n```\n>> 1.,.,.,.`union`.\n![tree-set](/images/union.jpg)\n```\nunion(x, y)\nlink(find-set(x), find-set(y))\n\nlink(x, y)\nif rank[x] > rank[y]\n  then p[y] <- x\n  else p[x] <- y\n    if rank[x] = rank[y]\n      then rank[y] <- rank[y] + 1\n```\n>> 2.,.,`find-set`,,.\n[find-set1](find-set1.gif)\n```\nfind-set(x)\nif x != p[x]\n  then p[x] <- find-set(p[x])\nreturn p[x]\n```\n\n3.\n,.`connected-components`,.`connected-components`,`same-component`.\n```\nconnected-components(G) #G,V[G],E[G]\nfor each vertex v in V[G]\n    do make-set(v)\nfor each edge(u, v) in E[G]\n    do if find-set(u) != find-set(v)\n        then union(u, v)\n\nsame-component(u, v)\nif find-set(u) = find-set(v)\n    then return true\n    else return false\n```\n![find-set2](find-set2.gif)\n","source":"_posts/CLRS-notes4.md","raw":"title: introduction to algorithms note4\ntags:\n  - algorithm\n  - data_structure\ndate: 2017/05/02\n\n----\n\n# Introduction to algorithms\n## Part5 \n[part3](https://chestnutme.github.io/2017/04/17/CLRS-notes2/),,stack/queue/bst/rbt.[part4](https://chestnutme.github.io/2017/04/22/CLRS-notes3/)/,.,part5\n* B:., B ,B B+,B+.\n* :`Insert,Mininum,Extract-Min,union,delete,decrease-key`.\n> *  $O(\\log n)$ . `union`,,, $O(n)$ .\n> * `extract-min,delete` O(1),`extract-min,delete` $O(\\log n)$ .`decrease-key` O(1).,.(part6,),.\n* ():n.`union, find-set`,:m $O(n\\alpha (n) )$, n,(n)<=4, $O(n)$.\n\n<!-- more -->\n### Chapter18 \n1.B-tree \n> ,,,(,), I/O,(),(),:.,.,,,.\n> ,B `disk-read``disk-write` ,,., B ,.,B.\n, ,.,.,,,.\n> B.\n\n[b-tree](/images/b-tree.png)\n\n2.B-tree\n> B,B,.part3red-black-tree),I/0.BB,B+,B*.B,B,.B?,nB $O(\\log n)$,,.,B$O(\\log n)$,`insert,delete`.\n\n> root[T])B\n> 1. x\n>> a. n[x], x\n>> b. n[x],, $key\\_1[x] \\leq key\\_2[x] \\leq \\dots \\leq key\\_{n[x]}[x]$\n>> c. leaf[x], bool,true\n> 2. n[x] + 1 $c\\_1[x], c\\_2[x], \\dots, c\\_{n[x]+1}$\n> 3. $key\\_i[x]$ , $k\\_i$ $c\\_i[x]$ , \n> $$ k\\_1 \\leq key\\_1[x] \\leq k\\_2 \\leq key\\_2[x] \\leq \\dots key\\_{n[x]}[x] \\leq k\\_{n[x]+1}$$\n> 4. , h\n> 5. t\n>> a. 2m-1.2m.2m-1,\n>> b. 2m-1.2m.2m-1,\n\nn,h, $t \\geq 2$B\n>Bh,,t-1,\n2, 2t, $2t^2$,\n$$ n \\geq 1 + (t-1)\\sum\\_{i=1}^h 2t^{i-1} = 1 + 2(t-1)(\\frac{t^h-1}{t-1}) =  2t^h - 1 $$\n$$ h \\leq \\log\\_t \\frac{n+1}{2} $$\n\n3.B:\n\n> 1.  $O(t \\log_t n)$bst\n```\nb-tree-search(x, k):\ni <- 1\nwhile i \u0002<= n[x] and k > keyi[x]\n  do i <- i + 1\nif i <= n[x] and k= keyi[x]\n  then return (x,i)\nif leaf[x]\n  then return NULL\n  else disk-read(ci[x])\n    return b-tree-search(ci[x], k)\n```\n\n> 2.  $O(t \\log_t n)$\n,B,,,,,,,,,,,,,.,,,,.\n```\nb-tree-split-child(x, i, y)\nz <- allocate-node()\nlead[z] <- leaf[y]\nn[z] <- t - 1\nfor j <- 1 ot t - 1\n  do keyi[z] <- key[j+i][y]\nif not leaf[y]\n  then for j <- 1 to t\n    do cj[z] <- c[j+i][y]\nn[y] <- t - 1\nfor j <- n[x] + 1 downto i + 1\n  do c[j+1][x] <- cj[x]\nc[i+1][x] <- z\nfor j <- n[x] downto i\n  do key[j+1][x] <- keyj[x]\nkeyi[x] <- keyi[y]\nn[x] <- n[x] + 1\ndisk-write(y)\ndisk-write(z)\ndisk-write(x)\n\nb-tree-insert(T, k)\nr <- root[T]\nif n[r] = 2t - 1\n  then s <- allocate-node()\n    root[T] <- s\n    leaf[s] <- False\n    n[s] <- 0\n    c1[s] <- r\n    b-tree-split-child(s, 1, r)\n    b-tree-insert-nonfull(s, k)\nelse b-tree-insert-nonfull(r, k)\n\nb-tree-insert-nonfull(x, k): #kx\ni <- n[x]\nif leaf[x]\n  then while i >= 1 and k < keyi[x]\n      do key[i+1][x] <- keyi[x]\n        i<- i - 1\n    key[i+1][x] <- k\n    n[x] <- n[x] + 1\n    disk-write(x)\n  else while i >= 1 and k < keyi[x]\n      do i <- i + 1\n      i <- i + 1\n      disk-read(ci[x])\n      if n[ci[x]] = 2t - 1\n        then b-tree-split-child(x, i, ci[x])\n          if k > keyi[x]\n            then i <- i + 1\n        b-tree-insert-nonfull(ci[x], k)\n```\n\n> 3.  $O(t \\log_t n)$\n,,,.,,,\n:\n K () K ()()(). B :B\n[t-1, 2*t-1],Min = t - 1.K, K()K' K, K'.*x K:\n>> a.  x->keynum>Min,K(x,K).\n>> b.  x->keynum=Min,,KB3.x()y Min,y()parent ,parent x .;y ,keynum1,Min,1keynumMin;x, K x Min . B-3.\n,.\n>> c.x() Min,,x.xy(),xK,parentxyK,,xy\"\"xy.xyMin,K'x K, 2Min(2t-2 <= 2t-1),B3. K',parentK',parent->keynum Min,;,*parent parent B.,,,,.\n,hB, $O(h)$ ,, $O(1)$ `disk-read,disk-write`, $O(th)=O(tlog_tn)$.\n\n### Chapter19 \n1.(Binomial Heaps)\n> Binomial Heap(Binary Heap).,,Mergeable Heap.x.,(Binomial Tree)(Binary Trees).,,,.\n\n. $B_k$. $B\\_0$. $B\\_k$ $B\\_{k-1}$.\n> 1.2k.\n> 2.k.\n> 3.i $C_i^k$.\n> 4.k,k-1, k-2, , 0,i$B_i$.\n\n![b-heap1](/images/b-heap1.jpg)\n\n> ,\n> 1. ., <= .\n> 2. k,k.\n. n  $\\log n + 1$\n\n2.\n,(heap[H]),, .x\n> 1. p[x],x\n> 2. child[x],x\n> 3. sibling[x], x\n![b-heap2](/images/b-heap2.jpg)\n\n3.\n> 1.: $O(1)$\n```\nmake\nhead[H] = NULL\n```\n\n> 2. $O(\\log n)$\n```\nbinomial-heap-minimum(H)\ny <- NULL\nx <- heap[H]\nmin <- INT\nwhile x != NULL\n  do if key[x] < min\n    then min <- key[y]\n      y <- x\n  x <- sibling[x]\nreturn y\n```\n\n> 3.\n`union`,`union`.\n:,,.K,.K,K+1,.K.\n\n```\nbinomial-link(y, z)#Bk-1Bk\np[y] <- z\nsibling[y] <- child[z]\nchild[z] <- y\ndegree[z] <- degree[z] + 1\nbinomial-heap-merge #H1H2\nbinomial-heap-union #\nH <- make-binomial-heap()\nhead[H] <- binomial-heap-merge(H1, H2)\nfree the objects H1 and H2 but not the lists they point to\nif head[H] = NULL\n  then return H\nprev-x <- NULL\nx <- head[H]\nnext-x <- sibling[x]\nwhile next-x  NULL\n  do if (degree[x]  degree[next-x]) or (sibling[next-x]  NULL and degree[sibling[next-x]] = degree[x])\n    then prev-x <- x  Cases 1 and 2                #case1 and 2\n      x <- next-x  Cases 1 and 2\n    else if key[x]  key[next-x]\n      then sibling[x] <- sibling[next-x]  Case 3   #case3\n        binomial-link(next-x, x)  Case 3\n    else if prev-x = NULL  Case 4                  #case4\n      then head[H] <- next-x  Case 4\n      else sibling[prev-x] <- next-x  Case 4\n      binomial-link(x, next-x)  Case 4\n      x <- next-x  Case 4\n  next-x <- sibling[x]\nreturn H\n```\n>> `union`\n`binomial-heap-merge`,H1H2H,.MERGE $O(\\log n)$.nH1H2.,,.\n,.,H.,, $O(1)$,,n,lg(n), $O(\\log n)$,merge $O(\\log n)$, $O(\\log n)$.mergeH,,,\nx,:\n>> Case1degree[x] != degree[sibling[x]].,,.\n>> Case2degree[x] == degree[sibling[x]] == degree[sibling[sibling[x]]].,,.\n>> Case3 & Case4degree[x] = degree[sibling[x]] != degree[sibling[sibling[x]]]\nCase3key[x] <= key[sibling[x]].,sibling[x]x.\nCase4key[x] > key[sibling[x]].,xsibling[x].\n\n> 4.: $O(\\log n)$\n```\nbinomial-heap-insert(H, x)\nH <- make-binomial-heap()\np[x] <- NULL\nchild[x] <- NULL\nsibling[x] <- NULL\ndegree[x] <- 0\nhead[H] <- x\nH <- binomial-heap-union(H, H)\n```\n\n> 5. $O(\\log n)$\n```\nbinomial-heap-extract-min(H):\nfind the root x with the minimum key in the root list of H,\nand remove x from the root list of H\nH <- make-binomial-heap()\nreverse the order of the linked list of xs children,\nand set head[H] to point to the head of the resulting list\nH <- binomial-heap-union(H, H)\n```\n\n> 6.\n,key[y]yz.ykey[y] >= key[z],.,z,\n```\nbinomial-heap-decrease-key(H, x, k)\nif k > key[x]\n  then error \"new key is greater than current key\"\nkey[x] <- k\ny <- x\nz <- p[y]\nwhile z  NULL and key[y] < key[z]\n  do exchange key[y]  key[z]\n  y <- z\n  z <- p[y]\n```\n\n> 7.\n```\nbinomial-heap-delete(H, x)\n1 binomial-heap-decrease-key(H, x, -INT)\n2 binomial-heap-extract-min(H)\n```\n\n4.\n>  =  + `decrease-key,union`\n, `union`.`union`,.\n:.`search`,`search`!`decrease-key``delete`.\n\n### Chapter20 \n1.\n> (Fibonacci heap),,.,O(1).\n,,.\n,,.\n\n[fib-heap](/images/fib.jpg)\n\n> .,min[H].\n\n>> 1. p[x],x\n>> 2. child[x], x\n>> 3. x\n>> 4. degree,x\n>> 5. mark,x,,TRUE\n\n2.\n> 1. \n```\nmake-fib-heap()\nH <- allocate-node()\nn[H] = 0\nmin[h] = NULL\nreturn H\n```\n\n> 2. : $O(1)$\n```\nfib-heap-insert(H, x)\ndegree[x] <- 0\np[x] <- NUll\nchild[x] <- NULL\nleft[x] <- x\nright[x] <- x\nmark[x] = false\nconcatenate the root list containing x with root list H\nif min[H] = NULL or key[x] < key[min[H]]\n  then min[H] <- x\nn[H] <- n[H] + 1\n```\n\n> 3. : $O(1)$\n,\n>> 1.\n>> 2.min[H],min[H],\n```\nfib-heap-union(H1, H2)\nH <- make-fib-heap()\nmin[H] <- min[H1]\nconcatenate the root list of H@ with the root list of H\nif (min[H1] = NULL) or (min[H2] != NULL) and min[H2] < min[H1])\n  then min[H1] <- min[H2]\nn[H] <- n[H1] + n[H2]\nfree the objects H1 and H2\nreturn H\n```\n\n> 4. : $O(\\log n)$\n,\n>> 1. ,,\n>> 2. ,\n,,, K .(,.)\n1: x  y, key[x]<key[y]\n2:yx. y , x,degree[x].,y.\n```\nfib-heap-extract-min(H)\nz <- min[H]\nif z != NULL\n  then for each child x of z\n    do add x to the root list of H\n      p[x] <- NULL\n    remove z from the root list of H\n    if z = right[z]\n      then min[H] <- NULL\n      else min[H] <- right[z]\n        consolidate(H)\n    n[H] <- n[H] - 1\n\nconsolidate(H): #H,\n```\n> 5. : $O(1)$\n,,.,.\n>> 1.,;\n>> 2.,,, mark ; false,, true; true,,; mark  false .\n```\nfib-heap-decrease-key(H, x, k)\nif k > key[x]\n  then return error \"new key is greater than current key\"\nkey[x] <- k\ny <- p[x]\nif y != NULL and key[x] < key[y]\n  then cut(H, x, y)\n    cascading-cut\nif key[x] < key[min[h]]\n  then min[h] <- x\n\ncut(H, x, y)\nremove x from the child list of y, decrementing degree[y]\nadd x to the root list of H\np[x] <- NULL\nmark[x] <- False\n\ncascading-cut(H, y)\nz <- p[y]\nif z != NULL\n   then if mark[y] = False\n      mark[y] <- true\n      else cut(H, y, z)\n        cascading-cut(H, z)\n```\n\n> 6. \n```\nfib-heap-delete(H, x)\nfib-heap-decrease-key(H, x, -INT)\nfib-heap-extract-min(H)\n```\n\n3.\n,,`extract-min`  `delete`.,,,., `extract-min`  `delete` .\n,,,.,.\n,, `extract-min` `delete` .Prime  Djikstra .\n\n### Chapter21 -\n1.\ndisjoing-set data structure) $S = \\\\{S_1,S_2,S_3, \\dots, S_k\\\\}$.,.\n\n> 1. `make-set(x)` ,x,.,x.\n> 2. `union(x,y)` xy $S_xS_y$..,$Sx \\bigcup Sy$,`union`,SxSy.,SxSy,S.\n> 3. `find-set(x)`,x.\n\n2.\n,.\n> 1.\n>> a. \n>> b. , $O(1)$\n>> c. ,,, $O(n)$.\n>> d. :,.\n\n> 2.\n> ,,.,.,.,,,,\n```\nmake-set(x)\np[x] <- x\nrank[x] <- 0\n```\n>> 1.,.,.,.`union`.\n![tree-set](/images/union.jpg)\n```\nunion(x, y)\nlink(find-set(x), find-set(y))\n\nlink(x, y)\nif rank[x] > rank[y]\n  then p[y] <- x\n  else p[x] <- y\n    if rank[x] = rank[y]\n      then rank[y] <- rank[y] + 1\n```\n>> 2.,.,`find-set`,,.\n[find-set1](find-set1.gif)\n```\nfind-set(x)\nif x != p[x]\n  then p[x] <- find-set(p[x])\nreturn p[x]\n```\n\n3.\n,.`connected-components`,.`connected-components`,`same-component`.\n```\nconnected-components(G) #G,V[G],E[G]\nfor each vertex v in V[G]\n    do make-set(v)\nfor each edge(u, v) in E[G]\n    do if find-set(u) != find-set(v)\n        then union(u, v)\n\nsame-component(u, v)\nif find-set(u) = find-set(v)\n    then return true\n    else return false\n```\n![find-set2](find-set2.gif)\n","slug":"CLRS-notes4","published":1,"updated":"2017-08-26T03:38:21.618Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3gn0007s7ambw0cp1r4","content":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h2 id=\"Part5-\"><a href=\"#Part5-\" class=\"headerlink\" title=\"Part5 \"></a>Part5 </h2><p><a href=\"https://chestnutme.github.io/2017/04/17/CLRS-notes2/\" target=\"_blank\" rel=\"noopener\">part3</a>,,stack/queue/bst/rbt.<a href=\"https://chestnutme.github.io/2017/04/22/CLRS-notes3/\" target=\"_blank\" rel=\"noopener\">part4</a>/,.,part5</p>\n<ul>\n<li>B:., B ,B B+,B+.</li>\n<li>:<code>Insert,Mininum,Extract-Min,union,delete,decrease-key</code>.<blockquote>\n<ul>\n<li> $O(\\log n)$ . <code>union</code>,,, $O(n)$ .</li>\n<li><code>extract-min,delete</code> O(1),<code>extract-min,delete</code> $O(\\log n)$ .<code>decrease-key</code> O(1).,.(part6,),.</li>\n</ul>\n</blockquote>\n</li>\n<li>():n.<code>union, find-set</code>,:m $O(n\\alpha (n) )$, n,(n)&lt;=4, $O(n)$.</li>\n</ul>\n<a id=\"more\"></a>\n<h3 id=\"Chapter18-\"><a href=\"#Chapter18-\" class=\"headerlink\" title=\"Chapter18 \"></a>Chapter18 </h3><p>1.B-tree </p>\n<blockquote>\n<p>,,,(,), I/O,(),(),:.,.,,,.<br>,B <code>disk-read</code><code>disk-write</code> ,,., B ,.,B.<br>, ,.,.,,,.<br>B.</p>\n</blockquote>\n<p><a href=\"/images/b-tree.png\">b-tree</a></p>\n<p>2.B-tree</p>\n<blockquote>\n<p>B,B,.part3red-black-tree),I/0.BB,B+,B*.B,B,.B?,nB $O(\\log n)$,,.,B$O(\\log n)$,<code>insert,delete</code>.</p>\n</blockquote>\n<blockquote>\n<p>root[T])B</p>\n<ol>\n<li>x<blockquote>\n<p>a. n[x], x<br>b. n[x],, $key_1[x] \\leq key_2[x] \\leq \\dots \\leq key_{n[x]}[x]$<br>c. leaf[x], bool,true</p>\n</blockquote>\n</li>\n<li>n[x] + 1 $c_1[x], c_2[x], \\dots, c_{n[x]+1}$</li>\n<li>$key_i[x]$ , $k_i$ $c_i[x]$ , <br>$$ k_1 \\leq key_1[x] \\leq k_2 \\leq key_2[x] \\leq \\dots key_{n[x]}[x] \\leq k_{n[x]+1}$$</li>\n<li>, h</li>\n<li>t<blockquote>\n<p>a. 2m-1.2m.2m-1,<br>b. 2m-1.2m.2m-1,</p>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<p>n,h, $t \\geq 2$B</p>\n<blockquote>\n<p>Bh,,t-1,<br>2, 2t, $2t^2$,<br>$$ n \\geq 1 + (t-1)\\sum_{i=1}^h 2t^{i-1} = 1 + 2(t-1)(\\frac{t^h-1}{t-1}) =  2t^h - 1 $$<br>$$ h \\leq \\log_t \\frac{n+1}{2} $$</p>\n</blockquote>\n<p>3.B:</p>\n<blockquote>\n<ol>\n<li> $O(t \\log_t n)$bst<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b-tree-search(x, k):</span><br><span class=\"line\">i &lt;- 1</span><br><span class=\"line\">while i \u0002&lt;= n[x] and k &gt; keyi[x]</span><br><span class=\"line\">  do i &lt;- i + 1</span><br><span class=\"line\">if i &lt;= n[x] and k= keyi[x]</span><br><span class=\"line\">  then return (x,i)</span><br><span class=\"line\">if leaf[x]</span><br><span class=\"line\">  then return NULL</span><br><span class=\"line\">  else disk-read(ci[x])</span><br><span class=\"line\">    return b-tree-search(ci[x], k)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li> $O(t \\log_t n)$<br>,B,,,,,,,,,,,,,.,,,,.<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b-tree-split-child(x, i, y)</span><br><span class=\"line\">z &lt;- allocate-node()</span><br><span class=\"line\">lead[z] &lt;- leaf[y]</span><br><span class=\"line\">n[z] &lt;- t - 1</span><br><span class=\"line\">for j &lt;- 1 ot t - 1</span><br><span class=\"line\">  do keyi[z] &lt;- key[j+i][y]</span><br><span class=\"line\">if not leaf[y]</span><br><span class=\"line\">  then for j &lt;- 1 to t</span><br><span class=\"line\">    do cj[z] &lt;- c[j+i][y]</span><br><span class=\"line\">n[y] &lt;- t - 1</span><br><span class=\"line\">for j &lt;- n[x] + 1 downto i + 1</span><br><span class=\"line\">  do c[j+1][x] &lt;- cj[x]</span><br><span class=\"line\">c[i+1][x] &lt;- z</span><br><span class=\"line\">for j &lt;- n[x] downto i</span><br><span class=\"line\">  do key[j+1][x] &lt;- keyj[x]</span><br><span class=\"line\">keyi[x] &lt;- keyi[y]</span><br><span class=\"line\">n[x] &lt;- n[x] + 1</span><br><span class=\"line\">disk-write(y)</span><br><span class=\"line\">disk-write(z)</span><br><span class=\"line\">disk-write(x)</span><br><span class=\"line\"></span><br><span class=\"line\">b-tree-insert(T, k)</span><br><span class=\"line\">r &lt;- root[T]</span><br><span class=\"line\">if n[r] = 2t - 1</span><br><span class=\"line\">  then s &lt;- allocate-node()</span><br><span class=\"line\">    root[T] &lt;- s</span><br><span class=\"line\">    leaf[s] &lt;- False</span><br><span class=\"line\">    n[s] &lt;- 0</span><br><span class=\"line\">    c1[s] &lt;- r</span><br><span class=\"line\">    b-tree-split-child(s, 1, r)</span><br><span class=\"line\">    b-tree-insert-nonfull(s, k)</span><br><span class=\"line\">else b-tree-insert-nonfull(r, k)</span><br><span class=\"line\"></span><br><span class=\"line\">b-tree-insert-nonfull(x, k): #kx</span><br><span class=\"line\">i &lt;- n[x]</span><br><span class=\"line\">if leaf[x]</span><br><span class=\"line\">  then while i &gt;= 1 and k &lt; keyi[x]</span><br><span class=\"line\">      do key[i+1][x] &lt;- keyi[x]</span><br><span class=\"line\">        i&lt;- i - 1</span><br><span class=\"line\">    key[i+1][x] &lt;- k</span><br><span class=\"line\">    n[x] &lt;- n[x] + 1</span><br><span class=\"line\">    disk-write(x)</span><br><span class=\"line\">  else while i &gt;= 1 and k &lt; keyi[x]</span><br><span class=\"line\">      do i &lt;- i + 1</span><br><span class=\"line\">      i &lt;- i + 1</span><br><span class=\"line\">      disk-read(ci[x])</span><br><span class=\"line\">      if n[ci[x]] = 2t - 1</span><br><span class=\"line\">        then b-tree-split-child(x, i, ci[x])</span><br><span class=\"line\">          if k &gt; keyi[x]</span><br><span class=\"line\">            then i &lt;- i + 1</span><br><span class=\"line\">        b-tree-insert-nonfull(ci[x], k)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"3\">\n<li> $O(t \\log_t n)$<br>,,,.,,,<br>:<br> K () K ()()(). B :B<br>[t-1, 2<em>t-1],Min = t - 1.K, K()K K, K.</em>x K:<blockquote>\n<p>a.  x-&gt;keynum&gt;Min,K(x,K).<br>b.  x-&gt;keynum=Min,,KB3.x()y Min,y()parent ,parent x .;y ,keynum1,Min,1keynumMin;x, K x Min . B-3.<br>,.<br>c.x() Min,,x.xy(),xK,parentxyK,,xyxy.xyMin,Kx K, 2Min(2t-2 &lt;= 2t-1),B3. K,parentK,parent-&gt;keynum Min,;,*parent parent B.,,,,.<br>,hB, $O(h)$ ,, $O(1)$ <code>disk-read,disk-write</code>, $O(th)=O(tlog_tn)$.</p>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"Chapter19-\"><a href=\"#Chapter19-\" class=\"headerlink\" title=\"Chapter19 \"></a>Chapter19 </h3><p>1.(Binomial Heaps)</p>\n<blockquote>\n<p>Binomial Heap(Binary Heap).,,Mergeable Heap.x.,(Binomial Tree)(Binary Trees).,,,.<br><br>. $B_k$. $B_0$. $B_k$ $B_{k-1}$.<br>1.2k.<br>2.k.<br>3.i $C_i^k$.<br>4.k,k-1, k-2, , 0,i$B_i$.</p>\n</blockquote>\n<p><img src=\"/images/b-heap1.jpg\" alt=\"b-heap1\"></p>\n<blockquote>\n<p>,</p>\n<ol>\n<li>., &lt;= .</li>\n<li>k,k.<br>. n  $\\log n + 1$</li>\n</ol>\n</blockquote>\n<p>2.<br>,(heap[H]),, .x</p>\n<blockquote>\n<ol>\n<li>p[x],x</li>\n<li>child[x],x</li>\n<li>sibling[x], x<br><img src=\"/images/b-heap2.jpg\" alt=\"b-heap2\"></li>\n</ol>\n</blockquote>\n<p>3.</p>\n<blockquote>\n<p>1.: $O(1)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make</span><br><span class=\"line\">head[H] = NULL</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>2. $O(\\log n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-heap-minimum(H)</span><br><span class=\"line\">y &lt;- NULL</span><br><span class=\"line\">x &lt;- heap[H]</span><br><span class=\"line\">min &lt;- INT</span><br><span class=\"line\">while x != NULL</span><br><span class=\"line\">  do if key[x] &lt; min</span><br><span class=\"line\">    then min &lt;- key[y]</span><br><span class=\"line\">      y &lt;- x</span><br><span class=\"line\">  x &lt;- sibling[x]</span><br><span class=\"line\">return y</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>3.<br><code>union</code>,<code>union</code>.<br>:,,.K,.K,K+1,.K.<br><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-link(y, z)#Bk-1Bk</span><br><span class=\"line\">p[y] &lt;- z</span><br><span class=\"line\">sibling[y] &lt;- child[z]</span><br><span class=\"line\">child[z] &lt;- y</span><br><span class=\"line\">degree[z] &lt;- degree[z] + 1</span><br><span class=\"line\">binomial-heap-merge #H1H2</span><br><span class=\"line\">binomial-heap-union #</span><br><span class=\"line\">H &lt;- make-binomial-heap()</span><br><span class=\"line\">head[H] &lt;- binomial-heap-merge(H1, H2)</span><br><span class=\"line\">free the objects H1 and H2 but not the lists they point to</span><br><span class=\"line\">if head[H] = NULL</span><br><span class=\"line\">  then return H</span><br><span class=\"line\">prev-x &lt;- NULL</span><br><span class=\"line\">x &lt;- head[H]</span><br><span class=\"line\">next-x &lt;- sibling[x]</span><br><span class=\"line\">while next-x  NULL</span><br><span class=\"line\">  do if (degree[x]  degree[next-x]) or (sibling[next-x]  NULL and degree[sibling[next-x]] = degree[x])</span><br><span class=\"line\">    then prev-x &lt;- x  Cases 1 and 2                #case1 and 2</span><br><span class=\"line\">      x &lt;- next-x  Cases 1 and 2</span><br><span class=\"line\">    else if key[x]  key[next-x]</span><br><span class=\"line\">      then sibling[x] &lt;- sibling[next-x]  Case 3   #case3</span><br><span class=\"line\">        binomial-link(next-x, x)  Case 3</span><br><span class=\"line\">    else if prev-x = NULL  Case 4                  #case4</span><br><span class=\"line\">      then head[H] &lt;- next-x  Case 4</span><br><span class=\"line\">      else sibling[prev-x] &lt;- next-x  Case 4</span><br><span class=\"line\">      binomial-link(x, next-x)  Case 4</span><br><span class=\"line\">      x &lt;- next-x  Case 4</span><br><span class=\"line\">  next-x &lt;- sibling[x]</span><br><span class=\"line\">return H</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><code>union</code><br><code>binomial-heap-merge</code>,H1H2H,.MERGE $O(\\log n)$.nH1H2.,,.<br>,.,H.,, $O(1)$,,n,lg(n), $O(\\log n)$,merge $O(\\log n)$, $O(\\log n)$.mergeH,,,<br>x,:<br>Case1degree[x] != degree[sibling[x]].,,.<br>Case2degree[x] == degree[sibling[x]] == degree[sibling[sibling[x]]].,,.<br>Case3 &amp; Case4degree[x] = degree[sibling[x]] != degree[sibling[sibling[x]]]<br>Case3key[x] &lt;= key[sibling[x]].,sibling[x]x.<br>Case4key[x] &gt; key[sibling[x]].,xsibling[x].</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>4.: $O(\\log n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-heap-insert(H, x)</span><br><span class=\"line\">H &lt;- make-binomial-heap()</span><br><span class=\"line\">p[x] &lt;- NULL</span><br><span class=\"line\">child[x] &lt;- NULL</span><br><span class=\"line\">sibling[x] &lt;- NULL</span><br><span class=\"line\">degree[x] &lt;- 0</span><br><span class=\"line\">head[H] &lt;- x</span><br><span class=\"line\">H &lt;- binomial-heap-union(H, H)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>5. $O(\\log n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-heap-extract-min(H):</span><br><span class=\"line\">find the root x with the minimum key in the root list of H,</span><br><span class=\"line\">and remove x from the root list of H</span><br><span class=\"line\">H &lt;- make-binomial-heap()</span><br><span class=\"line\">reverse the order of the linked list of xs children,</span><br><span class=\"line\">and set head[H] to point to the head of the resulting list</span><br><span class=\"line\">H &lt;- binomial-heap-union(H, H)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>6.<br>,key[y]yz.ykey[y] &gt;= key[z],.,z,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-heap-decrease-key(H, x, k)</span><br><span class=\"line\">if k &gt; key[x]</span><br><span class=\"line\">  then error &quot;new key is greater than current key&quot;</span><br><span class=\"line\">key[x] &lt;- k</span><br><span class=\"line\">y &lt;- x</span><br><span class=\"line\">z &lt;- p[y]</span><br><span class=\"line\">while z  NULL and key[y] &lt; key[z]</span><br><span class=\"line\">  do exchange key[y]  key[z]</span><br><span class=\"line\">  y &lt;- z</span><br><span class=\"line\">  z &lt;- p[y]</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>7.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-heap-delete(H, x)</span><br><span class=\"line\">1 binomial-heap-decrease-key(H, x, -INT)</span><br><span class=\"line\">2 binomial-heap-extract-min(H)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>4.</p>\n<blockquote>\n<p> =  + <code>decrease-key,union</code><br>, <code>union</code>.<code>union</code>,.<br>:.<code>search</code>,<code>search</code>!<code>decrease-key</code><code>delete</code>.</p>\n</blockquote>\n<h3 id=\"Chapter20-\"><a href=\"#Chapter20-\" class=\"headerlink\" title=\"Chapter20 \"></a>Chapter20 </h3><p>1.</p>\n<blockquote>\n<p>(Fibonacci heap),,.,O(1).<br>,,.<br>,,.</p>\n</blockquote>\n<p><a href=\"/images/fib.jpg\">fib-heap</a></p>\n<blockquote>\n<p>.,min[H].<br></p>\n<blockquote>\n<ol>\n<li>p[x],x</li>\n<li>child[x], x</li>\n<li>x</li>\n<li>degree,x</li>\n<li>mark,x,,TRUE</li>\n</ol>\n</blockquote>\n</blockquote>\n<p>2.</p>\n<blockquote>\n<ol>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make-fib-heap()</span><br><span class=\"line\">H &lt;- allocate-node()</span><br><span class=\"line\">n[H] = 0</span><br><span class=\"line\">min[h] = NULL</span><br><span class=\"line\">return H</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li>: $O(1)$<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib-heap-insert(H, x)</span><br><span class=\"line\">degree[x] &lt;- 0</span><br><span class=\"line\">p[x] &lt;- NUll</span><br><span class=\"line\">child[x] &lt;- NULL</span><br><span class=\"line\">left[x] &lt;- x</span><br><span class=\"line\">right[x] &lt;- x</span><br><span class=\"line\">mark[x] = false</span><br><span class=\"line\">concatenate the root list containing x with root list H</span><br><span class=\"line\">if min[H] = NULL or key[x] &lt; key[min[H]]</span><br><span class=\"line\">  then min[H] &lt;- x</span><br><span class=\"line\">n[H] &lt;- n[H] + 1</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"3\">\n<li>: $O(1)$<br>,<blockquote>\n<p>1.<br>2.min[H],min[H],</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib-heap-union(H1, H2)</span><br><span class=\"line\">H &lt;- make-fib-heap()</span><br><span class=\"line\">min[H] &lt;- min[H1]</span><br><span class=\"line\">concatenate the root list of H@ with the root list of H</span><br><span class=\"line\">if (min[H1] = NULL) or (min[H2] != NULL) and min[H2] &lt; min[H1])</span><br><span class=\"line\">  then min[H1] &lt;- min[H2]</span><br><span class=\"line\">n[H] &lt;- n[H1] + n[H2]</span><br><span class=\"line\">free the objects H1 and H2</span><br><span class=\"line\">return H</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"4\">\n<li>: $O(\\log n)$<br>,<blockquote>\n<ol>\n<li>,,</li>\n<li>,<br>,,, K .(,.)<br>1: x  y, key[x]&lt;key[y]<br>2:yx. y , x,degree[x].,y.<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib-heap-extract-min(H)</span><br><span class=\"line\">z &lt;- min[H]</span><br><span class=\"line\">if z != NULL</span><br><span class=\"line\">  then for each child x of z</span><br><span class=\"line\">    do add x to the root list of H</span><br><span class=\"line\">      p[x] &lt;- NULL</span><br><span class=\"line\">    remove z from the root list of H</span><br><span class=\"line\">    if z = right[z]</span><br><span class=\"line\">      then min[H] &lt;- NULL</span><br><span class=\"line\">      else min[H] &lt;- right[z]</span><br><span class=\"line\">        consolidate(H)</span><br><span class=\"line\">    n[H] &lt;- n[H] - 1</span><br><span class=\"line\"></span><br><span class=\"line\">consolidate(H): #H,</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"5\">\n<li>: $O(1)$<br>,,.,.<blockquote>\n<p>1.,;<br>2.,,, mark ; false,, true; true,,; mark  false .</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib-heap-decrease-key(H, x, k)</span><br><span class=\"line\">if k &gt; key[x]</span><br><span class=\"line\">  then return error &quot;new key is greater than current key&quot;</span><br><span class=\"line\">key[x] &lt;- k</span><br><span class=\"line\">y &lt;- p[x]</span><br><span class=\"line\">if y != NULL and key[x] &lt; key[y]</span><br><span class=\"line\">  then cut(H, x, y)</span><br><span class=\"line\">    cascading-cut</span><br><span class=\"line\">if key[x] &lt; key[min[h]]</span><br><span class=\"line\">  then min[h] &lt;- x</span><br><span class=\"line\"></span><br><span class=\"line\">cut(H, x, y)</span><br><span class=\"line\">remove x from the child list of y, decrementing degree[y]</span><br><span class=\"line\">add x to the root list of H</span><br><span class=\"line\">p[x] &lt;- NULL</span><br><span class=\"line\">mark[x] &lt;- False</span><br><span class=\"line\"></span><br><span class=\"line\">cascading-cut(H, y)</span><br><span class=\"line\">z &lt;- p[y]</span><br><span class=\"line\">if z != NULL</span><br><span class=\"line\">   then if mark[y] = False</span><br><span class=\"line\">      mark[y] &lt;- true</span><br><span class=\"line\">      else cut(H, y, z)</span><br><span class=\"line\">        cascading-cut(H, z)</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"6\">\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib-heap-delete(H, x)</span><br><span class=\"line\">fib-heap-decrease-key(H, x, -INT)</span><br><span class=\"line\">fib-heap-extract-min(H)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<p>3.<br>,,<code>extract-min</code>  <code>delete</code>.,,,., <code>extract-min</code>  <code>delete</code> .<br>,,,.,.<br>,, <code>extract-min</code> <code>delete</code> .Prime  Djikstra .</p>\n<h3 id=\"Chapter21--\"><a href=\"#Chapter21--\" class=\"headerlink\" title=\"Chapter21 -\"></a>Chapter21 -</h3><p>1.<br>disjoing-set data structure) $S = \\{S_1,S_2,S_3, \\dots, S_k\\}$.,.<br></p>\n<blockquote>\n<ol>\n<li><code>make-set(x)</code> ,x,.,x.</li>\n<li><code>union(x,y)</code> xy $S_xS_y$..,$Sx \\bigcup Sy$,<code>union</code>,SxSy.,SxSy,S.</li>\n<li><code>find-set(x)</code>,x.</li>\n</ol>\n</blockquote>\n<p>2.<br>,.</p>\n<blockquote>\n<p>1.</p>\n<blockquote>\n<p>a. <br>b. , $O(1)$<br>c. ,,, $O(n)$.<br>d. :,.</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>2.<br>,,.,.,.,,,,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make-set(x)</span><br><span class=\"line\">p[x] &lt;- x</span><br><span class=\"line\">rank[x] &lt;- 0</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>1.,.,.,.<code>union</code>.<br><img src=\"/images/union.jpg\" alt=\"tree-set\"><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">union(x, y)</span><br><span class=\"line\">link(find-set(x), find-set(y))</span><br><span class=\"line\"></span><br><span class=\"line\">link(x, y)</span><br><span class=\"line\">if rank[x] &gt; rank[y]</span><br><span class=\"line\">  then p[y] &lt;- x</span><br><span class=\"line\">  else p[x] &lt;- y</span><br><span class=\"line\">    if rank[x] = rank[y]</span><br><span class=\"line\">      then rank[y] &lt;- rank[y] + 1</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>2.,.,<code>find-set</code>,,.<br><a href=\"find-set1.gif\">find-set1</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find-set(x)</span><br><span class=\"line\">if x != p[x]</span><br><span class=\"line\">  then p[x] &lt;- find-set(p[x])</span><br><span class=\"line\">return p[x]</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<p>3.<br>,.<code>connected-components</code>,.<code>connected-components</code>,<code>same-component</code>.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">connected-components(G) #G,V[G],E[G]</span><br><span class=\"line\">for each vertex v in V[G]</span><br><span class=\"line\">    do make-set(v)</span><br><span class=\"line\">for each edge(u, v) in E[G]</span><br><span class=\"line\">    do if find-set(u) != find-set(v)</span><br><span class=\"line\">        then union(u, v)</span><br><span class=\"line\"></span><br><span class=\"line\">same-component(u, v)</span><br><span class=\"line\">if find-set(u) = find-set(v)</span><br><span class=\"line\">    then return true</span><br><span class=\"line\">    else return false</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"find-set2.gif\" alt=\"find-set2\"></p>\n","site":{"data":{}},"excerpt":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h2 id=\"Part5-\"><a href=\"#Part5-\" class=\"headerlink\" title=\"Part5 \"></a>Part5 </h2><p><a href=\"https://chestnutme.github.io/2017/04/17/CLRS-notes2/\" target=\"_blank\" rel=\"noopener\">part3</a>,,stack/queue/bst/rbt.<a href=\"https://chestnutme.github.io/2017/04/22/CLRS-notes3/\" target=\"_blank\" rel=\"noopener\">part4</a>/,.,part5</p>\n<ul>\n<li>B:., B ,B B+,B+.</li>\n<li>:<code>Insert,Mininum,Extract-Min,union,delete,decrease-key</code>.<blockquote>\n<ul>\n<li> $O(\\log n)$ . <code>union</code>,,, $O(n)$ .</li>\n<li><code>extract-min,delete</code> O(1),<code>extract-min,delete</code> $O(\\log n)$ .<code>decrease-key</code> O(1).,.(part6,),.</li>\n</ul>\n</blockquote>\n</li>\n<li>():n.<code>union, find-set</code>,:m $O(n\\alpha (n) )$, n,(n)&lt;=4, $O(n)$.</li>\n</ul>","more":"<h3 id=\"Chapter18-\"><a href=\"#Chapter18-\" class=\"headerlink\" title=\"Chapter18 \"></a>Chapter18 </h3><p>1.B-tree </p>\n<blockquote>\n<p>,,,(,), I/O,(),(),:.,.,,,.<br>,B <code>disk-read</code><code>disk-write</code> ,,., B ,.,B.<br>, ,.,.,,,.<br>B.</p>\n</blockquote>\n<p><a href=\"/images/b-tree.png\">b-tree</a></p>\n<p>2.B-tree</p>\n<blockquote>\n<p>B,B,.part3red-black-tree),I/0.BB,B+,B*.B,B,.B?,nB $O(\\log n)$,,.,B$O(\\log n)$,<code>insert,delete</code>.</p>\n</blockquote>\n<blockquote>\n<p>root[T])B</p>\n<ol>\n<li>x<blockquote>\n<p>a. n[x], x<br>b. n[x],, $key_1[x] \\leq key_2[x] \\leq \\dots \\leq key_{n[x]}[x]$<br>c. leaf[x], bool,true</p>\n</blockquote>\n</li>\n<li>n[x] + 1 $c_1[x], c_2[x], \\dots, c_{n[x]+1}$</li>\n<li>$key_i[x]$ , $k_i$ $c_i[x]$ , <br>$$ k_1 \\leq key_1[x] \\leq k_2 \\leq key_2[x] \\leq \\dots key_{n[x]}[x] \\leq k_{n[x]+1}$$</li>\n<li>, h</li>\n<li>t<blockquote>\n<p>a. 2m-1.2m.2m-1,<br>b. 2m-1.2m.2m-1,</p>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<p>n,h, $t \\geq 2$B</p>\n<blockquote>\n<p>Bh,,t-1,<br>2, 2t, $2t^2$,<br>$$ n \\geq 1 + (t-1)\\sum_{i=1}^h 2t^{i-1} = 1 + 2(t-1)(\\frac{t^h-1}{t-1}) =  2t^h - 1 $$<br>$$ h \\leq \\log_t \\frac{n+1}{2} $$</p>\n</blockquote>\n<p>3.B:</p>\n<blockquote>\n<ol>\n<li> $O(t \\log_t n)$bst<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b-tree-search(x, k):</span><br><span class=\"line\">i &lt;- 1</span><br><span class=\"line\">while i \u0002&lt;= n[x] and k &gt; keyi[x]</span><br><span class=\"line\">  do i &lt;- i + 1</span><br><span class=\"line\">if i &lt;= n[x] and k= keyi[x]</span><br><span class=\"line\">  then return (x,i)</span><br><span class=\"line\">if leaf[x]</span><br><span class=\"line\">  then return NULL</span><br><span class=\"line\">  else disk-read(ci[x])</span><br><span class=\"line\">    return b-tree-search(ci[x], k)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li> $O(t \\log_t n)$<br>,B,,,,,,,,,,,,,.,,,,.<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b-tree-split-child(x, i, y)</span><br><span class=\"line\">z &lt;- allocate-node()</span><br><span class=\"line\">lead[z] &lt;- leaf[y]</span><br><span class=\"line\">n[z] &lt;- t - 1</span><br><span class=\"line\">for j &lt;- 1 ot t - 1</span><br><span class=\"line\">  do keyi[z] &lt;- key[j+i][y]</span><br><span class=\"line\">if not leaf[y]</span><br><span class=\"line\">  then for j &lt;- 1 to t</span><br><span class=\"line\">    do cj[z] &lt;- c[j+i][y]</span><br><span class=\"line\">n[y] &lt;- t - 1</span><br><span class=\"line\">for j &lt;- n[x] + 1 downto i + 1</span><br><span class=\"line\">  do c[j+1][x] &lt;- cj[x]</span><br><span class=\"line\">c[i+1][x] &lt;- z</span><br><span class=\"line\">for j &lt;- n[x] downto i</span><br><span class=\"line\">  do key[j+1][x] &lt;- keyj[x]</span><br><span class=\"line\">keyi[x] &lt;- keyi[y]</span><br><span class=\"line\">n[x] &lt;- n[x] + 1</span><br><span class=\"line\">disk-write(y)</span><br><span class=\"line\">disk-write(z)</span><br><span class=\"line\">disk-write(x)</span><br><span class=\"line\"></span><br><span class=\"line\">b-tree-insert(T, k)</span><br><span class=\"line\">r &lt;- root[T]</span><br><span class=\"line\">if n[r] = 2t - 1</span><br><span class=\"line\">  then s &lt;- allocate-node()</span><br><span class=\"line\">    root[T] &lt;- s</span><br><span class=\"line\">    leaf[s] &lt;- False</span><br><span class=\"line\">    n[s] &lt;- 0</span><br><span class=\"line\">    c1[s] &lt;- r</span><br><span class=\"line\">    b-tree-split-child(s, 1, r)</span><br><span class=\"line\">    b-tree-insert-nonfull(s, k)</span><br><span class=\"line\">else b-tree-insert-nonfull(r, k)</span><br><span class=\"line\"></span><br><span class=\"line\">b-tree-insert-nonfull(x, k): #kx</span><br><span class=\"line\">i &lt;- n[x]</span><br><span class=\"line\">if leaf[x]</span><br><span class=\"line\">  then while i &gt;= 1 and k &lt; keyi[x]</span><br><span class=\"line\">      do key[i+1][x] &lt;- keyi[x]</span><br><span class=\"line\">        i&lt;- i - 1</span><br><span class=\"line\">    key[i+1][x] &lt;- k</span><br><span class=\"line\">    n[x] &lt;- n[x] + 1</span><br><span class=\"line\">    disk-write(x)</span><br><span class=\"line\">  else while i &gt;= 1 and k &lt; keyi[x]</span><br><span class=\"line\">      do i &lt;- i + 1</span><br><span class=\"line\">      i &lt;- i + 1</span><br><span class=\"line\">      disk-read(ci[x])</span><br><span class=\"line\">      if n[ci[x]] = 2t - 1</span><br><span class=\"line\">        then b-tree-split-child(x, i, ci[x])</span><br><span class=\"line\">          if k &gt; keyi[x]</span><br><span class=\"line\">            then i &lt;- i + 1</span><br><span class=\"line\">        b-tree-insert-nonfull(ci[x], k)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"3\">\n<li> $O(t \\log_t n)$<br>,,,.,,,<br>:<br> K () K ()()(). B :B<br>[t-1, 2<em>t-1],Min = t - 1.K, K()K K, K.</em>x K:<blockquote>\n<p>a.  x-&gt;keynum&gt;Min,K(x,K).<br>b.  x-&gt;keynum=Min,,KB3.x()y Min,y()parent ,parent x .;y ,keynum1,Min,1keynumMin;x, K x Min . B-3.<br>,.<br>c.x() Min,,x.xy(),xK,parentxyK,,xyxy.xyMin,Kx K, 2Min(2t-2 &lt;= 2t-1),B3. K,parentK,parent-&gt;keynum Min,;,*parent parent B.,,,,.<br>,hB, $O(h)$ ,, $O(1)$ <code>disk-read,disk-write</code>, $O(th)=O(tlog_tn)$.</p>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"Chapter19-\"><a href=\"#Chapter19-\" class=\"headerlink\" title=\"Chapter19 \"></a>Chapter19 </h3><p>1.(Binomial Heaps)</p>\n<blockquote>\n<p>Binomial Heap(Binary Heap).,,Mergeable Heap.x.,(Binomial Tree)(Binary Trees).,,,.<br><br>. $B_k$. $B_0$. $B_k$ $B_{k-1}$.<br>1.2k.<br>2.k.<br>3.i $C_i^k$.<br>4.k,k-1, k-2, , 0,i$B_i$.</p>\n</blockquote>\n<p><img src=\"/images/b-heap1.jpg\" alt=\"b-heap1\"></p>\n<blockquote>\n<p>,</p>\n<ol>\n<li>., &lt;= .</li>\n<li>k,k.<br>. n  $\\log n + 1$</li>\n</ol>\n</blockquote>\n<p>2.<br>,(heap[H]),, .x</p>\n<blockquote>\n<ol>\n<li>p[x],x</li>\n<li>child[x],x</li>\n<li>sibling[x], x<br><img src=\"/images/b-heap2.jpg\" alt=\"b-heap2\"></li>\n</ol>\n</blockquote>\n<p>3.</p>\n<blockquote>\n<p>1.: $O(1)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make</span><br><span class=\"line\">head[H] = NULL</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>2. $O(\\log n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-heap-minimum(H)</span><br><span class=\"line\">y &lt;- NULL</span><br><span class=\"line\">x &lt;- heap[H]</span><br><span class=\"line\">min &lt;- INT</span><br><span class=\"line\">while x != NULL</span><br><span class=\"line\">  do if key[x] &lt; min</span><br><span class=\"line\">    then min &lt;- key[y]</span><br><span class=\"line\">      y &lt;- x</span><br><span class=\"line\">  x &lt;- sibling[x]</span><br><span class=\"line\">return y</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>3.<br><code>union</code>,<code>union</code>.<br>:,,.K,.K,K+1,.K.<br><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-link(y, z)#Bk-1Bk</span><br><span class=\"line\">p[y] &lt;- z</span><br><span class=\"line\">sibling[y] &lt;- child[z]</span><br><span class=\"line\">child[z] &lt;- y</span><br><span class=\"line\">degree[z] &lt;- degree[z] + 1</span><br><span class=\"line\">binomial-heap-merge #H1H2</span><br><span class=\"line\">binomial-heap-union #</span><br><span class=\"line\">H &lt;- make-binomial-heap()</span><br><span class=\"line\">head[H] &lt;- binomial-heap-merge(H1, H2)</span><br><span class=\"line\">free the objects H1 and H2 but not the lists they point to</span><br><span class=\"line\">if head[H] = NULL</span><br><span class=\"line\">  then return H</span><br><span class=\"line\">prev-x &lt;- NULL</span><br><span class=\"line\">x &lt;- head[H]</span><br><span class=\"line\">next-x &lt;- sibling[x]</span><br><span class=\"line\">while next-x  NULL</span><br><span class=\"line\">  do if (degree[x]  degree[next-x]) or (sibling[next-x]  NULL and degree[sibling[next-x]] = degree[x])</span><br><span class=\"line\">    then prev-x &lt;- x  Cases 1 and 2                #case1 and 2</span><br><span class=\"line\">      x &lt;- next-x  Cases 1 and 2</span><br><span class=\"line\">    else if key[x]  key[next-x]</span><br><span class=\"line\">      then sibling[x] &lt;- sibling[next-x]  Case 3   #case3</span><br><span class=\"line\">        binomial-link(next-x, x)  Case 3</span><br><span class=\"line\">    else if prev-x = NULL  Case 4                  #case4</span><br><span class=\"line\">      then head[H] &lt;- next-x  Case 4</span><br><span class=\"line\">      else sibling[prev-x] &lt;- next-x  Case 4</span><br><span class=\"line\">      binomial-link(x, next-x)  Case 4</span><br><span class=\"line\">      x &lt;- next-x  Case 4</span><br><span class=\"line\">  next-x &lt;- sibling[x]</span><br><span class=\"line\">return H</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><code>union</code><br><code>binomial-heap-merge</code>,H1H2H,.MERGE $O(\\log n)$.nH1H2.,,.<br>,.,H.,, $O(1)$,,n,lg(n), $O(\\log n)$,merge $O(\\log n)$, $O(\\log n)$.mergeH,,,<br>x,:<br>Case1degree[x] != degree[sibling[x]].,,.<br>Case2degree[x] == degree[sibling[x]] == degree[sibling[sibling[x]]].,,.<br>Case3 &amp; Case4degree[x] = degree[sibling[x]] != degree[sibling[sibling[x]]]<br>Case3key[x] &lt;= key[sibling[x]].,sibling[x]x.<br>Case4key[x] &gt; key[sibling[x]].,xsibling[x].</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>4.: $O(\\log n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-heap-insert(H, x)</span><br><span class=\"line\">H &lt;- make-binomial-heap()</span><br><span class=\"line\">p[x] &lt;- NULL</span><br><span class=\"line\">child[x] &lt;- NULL</span><br><span class=\"line\">sibling[x] &lt;- NULL</span><br><span class=\"line\">degree[x] &lt;- 0</span><br><span class=\"line\">head[H] &lt;- x</span><br><span class=\"line\">H &lt;- binomial-heap-union(H, H)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>5. $O(\\log n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-heap-extract-min(H):</span><br><span class=\"line\">find the root x with the minimum key in the root list of H,</span><br><span class=\"line\">and remove x from the root list of H</span><br><span class=\"line\">H &lt;- make-binomial-heap()</span><br><span class=\"line\">reverse the order of the linked list of xs children,</span><br><span class=\"line\">and set head[H] to point to the head of the resulting list</span><br><span class=\"line\">H &lt;- binomial-heap-union(H, H)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>6.<br>,key[y]yz.ykey[y] &gt;= key[z],.,z,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-heap-decrease-key(H, x, k)</span><br><span class=\"line\">if k &gt; key[x]</span><br><span class=\"line\">  then error &quot;new key is greater than current key&quot;</span><br><span class=\"line\">key[x] &lt;- k</span><br><span class=\"line\">y &lt;- x</span><br><span class=\"line\">z &lt;- p[y]</span><br><span class=\"line\">while z  NULL and key[y] &lt; key[z]</span><br><span class=\"line\">  do exchange key[y]  key[z]</span><br><span class=\"line\">  y &lt;- z</span><br><span class=\"line\">  z &lt;- p[y]</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>7.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binomial-heap-delete(H, x)</span><br><span class=\"line\">1 binomial-heap-decrease-key(H, x, -INT)</span><br><span class=\"line\">2 binomial-heap-extract-min(H)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>4.</p>\n<blockquote>\n<p> =  + <code>decrease-key,union</code><br>, <code>union</code>.<code>union</code>,.<br>:.<code>search</code>,<code>search</code>!<code>decrease-key</code><code>delete</code>.</p>\n</blockquote>\n<h3 id=\"Chapter20-\"><a href=\"#Chapter20-\" class=\"headerlink\" title=\"Chapter20 \"></a>Chapter20 </h3><p>1.</p>\n<blockquote>\n<p>(Fibonacci heap),,.,O(1).<br>,,.<br>,,.</p>\n</blockquote>\n<p><a href=\"/images/fib.jpg\">fib-heap</a></p>\n<blockquote>\n<p>.,min[H].<br></p>\n<blockquote>\n<ol>\n<li>p[x],x</li>\n<li>child[x], x</li>\n<li>x</li>\n<li>degree,x</li>\n<li>mark,x,,TRUE</li>\n</ol>\n</blockquote>\n</blockquote>\n<p>2.</p>\n<blockquote>\n<ol>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make-fib-heap()</span><br><span class=\"line\">H &lt;- allocate-node()</span><br><span class=\"line\">n[H] = 0</span><br><span class=\"line\">min[h] = NULL</span><br><span class=\"line\">return H</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li>: $O(1)$<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib-heap-insert(H, x)</span><br><span class=\"line\">degree[x] &lt;- 0</span><br><span class=\"line\">p[x] &lt;- NUll</span><br><span class=\"line\">child[x] &lt;- NULL</span><br><span class=\"line\">left[x] &lt;- x</span><br><span class=\"line\">right[x] &lt;- x</span><br><span class=\"line\">mark[x] = false</span><br><span class=\"line\">concatenate the root list containing x with root list H</span><br><span class=\"line\">if min[H] = NULL or key[x] &lt; key[min[H]]</span><br><span class=\"line\">  then min[H] &lt;- x</span><br><span class=\"line\">n[H] &lt;- n[H] + 1</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"3\">\n<li>: $O(1)$<br>,<blockquote>\n<p>1.<br>2.min[H],min[H],</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib-heap-union(H1, H2)</span><br><span class=\"line\">H &lt;- make-fib-heap()</span><br><span class=\"line\">min[H] &lt;- min[H1]</span><br><span class=\"line\">concatenate the root list of H@ with the root list of H</span><br><span class=\"line\">if (min[H1] = NULL) or (min[H2] != NULL) and min[H2] &lt; min[H1])</span><br><span class=\"line\">  then min[H1] &lt;- min[H2]</span><br><span class=\"line\">n[H] &lt;- n[H1] + n[H2]</span><br><span class=\"line\">free the objects H1 and H2</span><br><span class=\"line\">return H</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"4\">\n<li>: $O(\\log n)$<br>,<blockquote>\n<ol>\n<li>,,</li>\n<li>,<br>,,, K .(,.)<br>1: x  y, key[x]&lt;key[y]<br>2:yx. y , x,degree[x].,y.<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib-heap-extract-min(H)</span><br><span class=\"line\">z &lt;- min[H]</span><br><span class=\"line\">if z != NULL</span><br><span class=\"line\">  then for each child x of z</span><br><span class=\"line\">    do add x to the root list of H</span><br><span class=\"line\">      p[x] &lt;- NULL</span><br><span class=\"line\">    remove z from the root list of H</span><br><span class=\"line\">    if z = right[z]</span><br><span class=\"line\">      then min[H] &lt;- NULL</span><br><span class=\"line\">      else min[H] &lt;- right[z]</span><br><span class=\"line\">        consolidate(H)</span><br><span class=\"line\">    n[H] &lt;- n[H] - 1</span><br><span class=\"line\"></span><br><span class=\"line\">consolidate(H): #H,</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"5\">\n<li>: $O(1)$<br>,,.,.<blockquote>\n<p>1.,;<br>2.,,, mark ; false,, true; true,,; mark  false .</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib-heap-decrease-key(H, x, k)</span><br><span class=\"line\">if k &gt; key[x]</span><br><span class=\"line\">  then return error &quot;new key is greater than current key&quot;</span><br><span class=\"line\">key[x] &lt;- k</span><br><span class=\"line\">y &lt;- p[x]</span><br><span class=\"line\">if y != NULL and key[x] &lt; key[y]</span><br><span class=\"line\">  then cut(H, x, y)</span><br><span class=\"line\">    cascading-cut</span><br><span class=\"line\">if key[x] &lt; key[min[h]]</span><br><span class=\"line\">  then min[h] &lt;- x</span><br><span class=\"line\"></span><br><span class=\"line\">cut(H, x, y)</span><br><span class=\"line\">remove x from the child list of y, decrementing degree[y]</span><br><span class=\"line\">add x to the root list of H</span><br><span class=\"line\">p[x] &lt;- NULL</span><br><span class=\"line\">mark[x] &lt;- False</span><br><span class=\"line\"></span><br><span class=\"line\">cascading-cut(H, y)</span><br><span class=\"line\">z &lt;- p[y]</span><br><span class=\"line\">if z != NULL</span><br><span class=\"line\">   then if mark[y] = False</span><br><span class=\"line\">      mark[y] &lt;- true</span><br><span class=\"line\">      else cut(H, y, z)</span><br><span class=\"line\">        cascading-cut(H, z)</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"6\">\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib-heap-delete(H, x)</span><br><span class=\"line\">fib-heap-decrease-key(H, x, -INT)</span><br><span class=\"line\">fib-heap-extract-min(H)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<p>3.<br>,,<code>extract-min</code>  <code>delete</code>.,,,., <code>extract-min</code>  <code>delete</code> .<br>,,,.,.<br>,, <code>extract-min</code> <code>delete</code> .Prime  Djikstra .</p>\n<h3 id=\"Chapter21--\"><a href=\"#Chapter21--\" class=\"headerlink\" title=\"Chapter21 -\"></a>Chapter21 -</h3><p>1.<br>disjoing-set data structure) $S = \\{S_1,S_2,S_3, \\dots, S_k\\}$.,.<br></p>\n<blockquote>\n<ol>\n<li><code>make-set(x)</code> ,x,.,x.</li>\n<li><code>union(x,y)</code> xy $S_xS_y$..,$Sx \\bigcup Sy$,<code>union</code>,SxSy.,SxSy,S.</li>\n<li><code>find-set(x)</code>,x.</li>\n</ol>\n</blockquote>\n<p>2.<br>,.</p>\n<blockquote>\n<p>1.</p>\n<blockquote>\n<p>a. <br>b. , $O(1)$<br>c. ,,, $O(n)$.<br>d. :,.</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>2.<br>,,.,.,.,,,,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make-set(x)</span><br><span class=\"line\">p[x] &lt;- x</span><br><span class=\"line\">rank[x] &lt;- 0</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>1.,.,.,.<code>union</code>.<br><img src=\"/images/union.jpg\" alt=\"tree-set\"><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">union(x, y)</span><br><span class=\"line\">link(find-set(x), find-set(y))</span><br><span class=\"line\"></span><br><span class=\"line\">link(x, y)</span><br><span class=\"line\">if rank[x] &gt; rank[y]</span><br><span class=\"line\">  then p[y] &lt;- x</span><br><span class=\"line\">  else p[x] &lt;- y</span><br><span class=\"line\">    if rank[x] = rank[y]</span><br><span class=\"line\">      then rank[y] &lt;- rank[y] + 1</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>2.,.,<code>find-set</code>,,.<br><a href=\"find-set1.gif\">find-set1</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find-set(x)</span><br><span class=\"line\">if x != p[x]</span><br><span class=\"line\">  then p[x] &lt;- find-set(p[x])</span><br><span class=\"line\">return p[x]</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<p>3.<br>,.<code>connected-components</code>,.<code>connected-components</code>,<code>same-component</code>.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">connected-components(G) #G,V[G],E[G]</span><br><span class=\"line\">for each vertex v in V[G]</span><br><span class=\"line\">    do make-set(v)</span><br><span class=\"line\">for each edge(u, v) in E[G]</span><br><span class=\"line\">    do if find-set(u) != find-set(v)</span><br><span class=\"line\">        then union(u, v)</span><br><span class=\"line\"></span><br><span class=\"line\">same-component(u, v)</span><br><span class=\"line\">if find-set(u) = find-set(v)</span><br><span class=\"line\">    then return true</span><br><span class=\"line\">    else return false</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"find-set2.gif\" alt=\"find-set2\"></p>"},{"title":"introduction to algorithms note5","date":"2017-05-08T16:00:00.000Z","_content":"\n# Introduction to algorithms\n\n## Part6 \n(, , stack, queue), (, , ), -.part6,:\n* ,/\n* \n* \n\n: $G = (V, E)$ G, V[G], |V|;E[G], |E|;, |V||G|., $O(VE)$  $O(|V||E|)$\n\n### Chapter22 ?\n.:\n* \n* \n* \n* \n* \n\n<!-- more -->\n\n#### \n:\n* (adjacency lists)\n|V|*Adj*,  $u \\in V$, Adj[u] Gu.($|E||V|^2$).\n,, $O(V+E)$ ;,.\n\n* (adjacency matrix)\nG|V| * |V| $A = {a\\_{ij}}$, :\n$$ a\\_{ij} =\n\\begin{cases}\n1, \\text {if (i, j)} \\in E \\\\\\\\\n0, else \\\\\\\\\n\\end{cases}\n$$\n,  $O(v^2)$\nA,$A=A^T$ .,,,.\n\n1 \n![directed graph](/images/graph1.png)\n\n2 \n![undirected graph](/images/graph2.png)\n\n,,,.,,:,,.,,.\n\n#### (bread-first search)\nBFS: G=(V, E)s, G, s, s().,sk, sk+1.\nBFS:\n```\nBFS(G, s)\nfor each vertex u in V[G]-{s}\n    do color[u] <- white      #color:\n        d[u] <- INT           #d[u]: us\n        f[u] <- Null          #f[u]: u\ncolor[s] <- gray\nd[s] <- i\nf[s] <- Null\nQ <- Empty                     #Q:\nEnqueue(Q, s)\nwhile Q != Empty\n    do u <- Dequeu(Q)\n    for each v in Adj[u]\n        do if color[u] = white\n            then color[u] <- gray\n            d[v] <- d[u] + 1\n            f[v] <- u\n            Enqueue(Q, v)\n    color[u] <- black\n```\n3\n![BFS](/images/bfs.png)\n\nBFS:\npart4(aggregate analysis), color,vEnqueue,Dequeue.EnqueueDequeue $O(1)$ , $O(V)$.vAdj[v], ,  $O(E)$.  $O(V + E)$.\n\n**BFS, G, s, ,**.,BFS,s****.sv,svGsv().BFSf[u] $G\\_f = (V\\_f, E\\_f)$ G = (V, E):\n\\begin{align}\nV\\_f = \\{v \\in V: f[v] \\neq Null \\} \\bigcup \\{s\\} \\\\\\\\\nE\\_f = \\{(f[v], v): v \\in V\\_f - \\{s\\} \\}\n\\end{align}\n\nBFSsv:\n```\nprint-path(G, s, v)\nif v == s\n    then print s\n    else if f[v] = Null\n        then print \"no path from\" s \"to\" v \"exists\"\n        else print-path(G, s, f[v])\n            print v\n```\n\n### (depth-first search)\nDFS:u, u,.u,u..DFS.\nDFS:\n```\nDFS(G)\nfor each vertex u in V[G]\n    do color[u] <- white\n        f[u] <- Null\ntime <- 0                       #, f[v]\nfor each vertex u in V[G]\n    do if colo[u] = white\n    then DFS-visit[u]\n\nDFS-visit(u)\ncolo[u] <- gray\nd[u] <- time + 1\nd[u] <- time\nfor each v in Adj[u]\n    do if color[v]  = white\n        then f[v] <- u\n        DFS-visit(v)\ncolor[u] <- black\nf[u] <- time <- time + 1\n```\nDFS4\n![dfs](/images/dfs.png)\n\nDFS: , ,  $O(V)$.u, DFS-visit,.DFS-visit(v),|Adj[v]|,:\n$$  \\sum\\_{v \\in V}|Adj[v]| = O(E) $$\nDFS $O(V + E)$.\n\nDFS,. v : v , d[v], v , f[v].,.\n\n####  Topological sort\n(Directed Acyclic GraphDAG)G,G,uv, $(u,v) \\in E[G]$,uv.,(Topological Order),.(Activity On Vertex network,AOV),.\n\ndag.:\n![dag](/images/dag.png)\n\nAOV,0.\n* 0\n* .\n,,,.\n\ntime,.,,BFS.\n```\ntopoligical-sort(G)\ncall DFS(G) to compute finishing times f[v] for each vertex v\nas each vete is finished, insert it onto the front of a linked list\nreturn the linked list of vertices\n```\n\n#### \n(strongly connected component):G=(V,E) $C \\subseteq V$, Cu, v, .\n\nSCC: G:\n$$ G^T = (V, E^T), E^T = \\{(u, v):(v, u) \\in E\\} $$\n $G^{SCC} = (V^{SCC}, E^{SCC})$,G $[C\\_1, C\\_2, \\dots, C\\_k]$. $V^{SCC} = \\{v\\_1, v\\_2, \\dots, v\\_k \\}$,G $C\\_i$, $v\\_i$. $x \\in C\\_i$  $y \\in C\\_i$, G(x, y),  $(v\\_i,v\\_j) \\in E^{SCC}$. G, $G^{SCC}$.  $G^{SCC}$(dag);\n![scc](/images/scc.png)\n\n> 1. G f[x];\n> 2. G $G^T$;\n> 3. f[x]$G^T$,G $G^T$;\n3 G.\n```\nstrongly-connnected-component(G)\ncall DFS(G) to compute finishing times f[u] for each vertex u\ncompute GT\ncall DFS(GT). but in the main loop of DFS, consider the vertices in order of decreasing f[u](as computed in line 1)\noutput the vertices of each tree in the depth-first forest formed in line 3 as a separate strongly connected component\n```\n\n### Chapter23  Minimum Spanning Trees\n(spanning tree)T: TG, T.T, .\n,KruskalPrim.\n\n#### \n(): n-1 , n ,.:\n![mst](/images/mst.png)\n\n,,A, :\n, A.\n,(u, v), A, ,  $A \\bigcup \\{(u, v) \\}$.(u, v)(safe edge).:\n```\ngeneric-mst(G, w)\nA <- Empty\nwhile A does not form a spanning tree\n    do find an edge(u, v) that is safe for A\n        A <- A union (u, v)\nreturn A\n```\n\n#### Kruskal\nKruskal:,,.,A,A.\npart5Kruskal.`find-set(u)``find-set(v)`,uv,`Union`.\n```\nmst-kruskal(G, w)\nA <- Empty\nfor each vertex v in V[G]\n    do make-set(v)\nsort the edges of E into nondecreasing order by weight w\nfor each edge(u, v) in E, taken in nondecreasing order by weight\n    do if find-set(u) != find-set(v)\n        then A <- A union (u, v)\n            Union(u, v)\nreturn A\n```\n\n:\n![kruskal](/images/kruskal.png)\n\nKruskal:\n,. $O(1)$,  $O(E\\log E)$.,  $O(E)$ `find-set``union`, |V|`make-set`,$O((V + E)\\alpha(V)$.G, |E| > |v| - 1,  $O(E\\alpha(v))$.  $\\alpha(|V|) = O(\\log V) = O(\\log E)$, $O(E\\log E)$.  $|E| < |V| ^ 2$,  $\\log |E| = O(\\log V)$, Kruskal $O(E\\log V)$\n\n#### Prim\nPrim:A,A.r, A $G\\_A=(V, A)$ ()A, .:\n![prim](/images/prim.png)\n\nPrimkeyQ,A.key[u]u.f[u]u.\n```\nmst-prim(G, w, r)\nfor each u in V[G]\n    do key[u] <- INT\n        f[u] <- Null\nkey[r] <- 0\nQ <- V[G]\nwhile Q != Empty\n    do u <- extract-min(Q)\n        for each v in Adj[u]\n            do if v in Q and w(u, v) < key[v]\n                then f[u] <- u\n                    key[v] <- w(u, v)\n```\n\nPrim:\nPrimQ, Part5:`build-min-heao`,  $O(V)$. `while`|V|, `extract-min` $O(\\log V)$,  $O(V\\log V)$.`for` $O(E)$ , `decrease-key`key $O(\\log V)$., Prim $O(V\\log V + E\\log V) = O(E\\log V)$., PrimKruskal.\n, Chapter20,|V|, $O(\\log )$ `extract-min`Prim $O(E + V\\log )$.\n\n#### \nPrim:\n> 1. Prim,keyQ;\n> 2. ,Qkey, Kruskal ;\n> 3. Prim ().,, $O(EV)$, $O(E\\log V)$ ,().\n\nKruskal,Kruskal\n\n\n### Chapter24 ?\n:., , ., ,,.\n\n#### \n\nG = (V, E), $w: E \\to R$.\n $p = \\{v\\_0, v\\_1, \\dots, v\\_k\\}$:\n$$ w(p) = \\sum\\_{i=1}^k w(v\\_{i-1}, v\\_i) $$\nuv:\n$$\n\\delta(u, v) =\n\\begin{cases}\nmin\\{w(p): u \\to v \\}, \\text {if path(u, v) exists} \\\\\\\\\n\\infty, else \\\\\\\\\n\\end{cases}\n$$\n $w(p) = \\delta(u, v)$.\n\n:, , //.\n\n\n* : vt, \n* : uv,uv\n* : .\n\n\n1.\n**.**\n$$\\begin{align}\np = < v\\_0, v\\_1, \\dots, v\\_k >v\\_0v\\_k,\\\\\n \\forall i, j, 1 \\leq i \\leq j \\leq k \\\\\np\\_{ij} = < v\\_i, v\\_{i+1}, \\dots, v\\_j> v\\_iv\\_j \\\\\n\\end{align}\n$$\n\n2.\n, ****,., ,.\n![negative path](/images/n-path.png)\n\n3.\n, .,/,.\n\n4.\n,.,vf[v], .`print-path(G, s, v)`.\n![mst-path](/images/mst-path.png)\n\n5.** relaxation**\n $ v \\in V$, d[v]sv,:\n```\ninitialize-single-source(G, s)\nfor each vertex v in V[G]\n    do d[v] <- INT\n        f[v] <- Null\nd[s] <- 0\n```\n, u, v:\n```\nrelax(u, v, w)\nif d[v] > d[u] + w(u, v)\n    then d[v] <- d[u] + w(u, v)\n        f[v] <- u\n```\n, ..Dijkstra, Bellman-Ford.\n\n#### Bellman-Ford\nBellman-Ford, , svd[v].,.:\n```\nbellman-ford(G, w, s)\ninitialize-single-source(G, s)\nfor i <- 1 to |V[G]| - 1\n    do for each edge (u, v) in E[G]\n        do relax(u, v, w)\nfor each edge(u, v) in E[G]\n    do if d[v] > d[u] + w(u, v)\n        then return false\nreturn true\n```\n:\n![bellman-ford](/images/bellman-ford.png)\n\n:\n $O(V)$, |V| - 1,  $O(E)$. $O(E)$.bellman-ford $O(EV)$.\n\n#### dag\n, path(u,v),uv., ., $O(V+E)$ .,,().\n:\n```\ndag-shortest-path(G, w, s)\ntopoligically sort the vertices of G\ninitialize-single-source(G, s)\nfor each vertex u, taken in topoligically sorted order\n    do for each vertex v in Adj[u]\n        do relax(u, v, w)\n```\n\n:\n![dag-path](/images/dag-path.png)\n\n\n#### Dijkstra\nDijkstraS, s. $u \\in V-S$, uS, u.Q,d.\n:\n```\ndijkstra(G, w, s)\ninitialize-single-source(G, s)\ns <- Empty\nQ <- V[G]\nwhile Q != Empty\n    do u <- extract-min(Q)\n        s <- s union {u}\n        for each vertex v in Adj[u]\n            do relax(u, v, w)\n```\n\n:\n![dijkstra](/images/dijkstra.png)\n\n\ndijkstraQ. Q`insert` $O(1)$, ,  $O(V)$;for|E|, |E|`decrease-key` $O(1)$, $O(E)$.S, `extract-min` $O(v)$ |V|, dijkstra $O(V^2 + E) = O(V^2)$.\n, |V|`extract-min` $O(\\log V)$, |E|`decrease-key` $O(1)$.dijkstra $O(V\\log V + E)$.\n","source":"_posts/CLRS-notes5.md","raw":"title: introduction to algorithms note5\ntags:\n  - algorithm\n  - data_structure\ndate: 2017/05/09\n\n---\n\n# Introduction to algorithms\n\n## Part6 \n(, , stack, queue), (, , ), -.part6,:\n* ,/\n* \n* \n\n: $G = (V, E)$ G, V[G], |V|;E[G], |E|;, |V||G|., $O(VE)$  $O(|V||E|)$\n\n### Chapter22 ?\n.:\n* \n* \n* \n* \n* \n\n<!-- more -->\n\n#### \n:\n* (adjacency lists)\n|V|*Adj*,  $u \\in V$, Adj[u] Gu.($|E||V|^2$).\n,, $O(V+E)$ ;,.\n\n* (adjacency matrix)\nG|V| * |V| $A = {a\\_{ij}}$, :\n$$ a\\_{ij} =\n\\begin{cases}\n1, \\text {if (i, j)} \\in E \\\\\\\\\n0, else \\\\\\\\\n\\end{cases}\n$$\n,  $O(v^2)$\nA,$A=A^T$ .,,,.\n\n1 \n![directed graph](/images/graph1.png)\n\n2 \n![undirected graph](/images/graph2.png)\n\n,,,.,,:,,.,,.\n\n#### (bread-first search)\nBFS: G=(V, E)s, G, s, s().,sk, sk+1.\nBFS:\n```\nBFS(G, s)\nfor each vertex u in V[G]-{s}\n    do color[u] <- white      #color:\n        d[u] <- INT           #d[u]: us\n        f[u] <- Null          #f[u]: u\ncolor[s] <- gray\nd[s] <- i\nf[s] <- Null\nQ <- Empty                     #Q:\nEnqueue(Q, s)\nwhile Q != Empty\n    do u <- Dequeu(Q)\n    for each v in Adj[u]\n        do if color[u] = white\n            then color[u] <- gray\n            d[v] <- d[u] + 1\n            f[v] <- u\n            Enqueue(Q, v)\n    color[u] <- black\n```\n3\n![BFS](/images/bfs.png)\n\nBFS:\npart4(aggregate analysis), color,vEnqueue,Dequeue.EnqueueDequeue $O(1)$ , $O(V)$.vAdj[v], ,  $O(E)$.  $O(V + E)$.\n\n**BFS, G, s, ,**.,BFS,s****.sv,svGsv().BFSf[u] $G\\_f = (V\\_f, E\\_f)$ G = (V, E):\n\\begin{align}\nV\\_f = \\{v \\in V: f[v] \\neq Null \\} \\bigcup \\{s\\} \\\\\\\\\nE\\_f = \\{(f[v], v): v \\in V\\_f - \\{s\\} \\}\n\\end{align}\n\nBFSsv:\n```\nprint-path(G, s, v)\nif v == s\n    then print s\n    else if f[v] = Null\n        then print \"no path from\" s \"to\" v \"exists\"\n        else print-path(G, s, f[v])\n            print v\n```\n\n### (depth-first search)\nDFS:u, u,.u,u..DFS.\nDFS:\n```\nDFS(G)\nfor each vertex u in V[G]\n    do color[u] <- white\n        f[u] <- Null\ntime <- 0                       #, f[v]\nfor each vertex u in V[G]\n    do if colo[u] = white\n    then DFS-visit[u]\n\nDFS-visit(u)\ncolo[u] <- gray\nd[u] <- time + 1\nd[u] <- time\nfor each v in Adj[u]\n    do if color[v]  = white\n        then f[v] <- u\n        DFS-visit(v)\ncolor[u] <- black\nf[u] <- time <- time + 1\n```\nDFS4\n![dfs](/images/dfs.png)\n\nDFS: , ,  $O(V)$.u, DFS-visit,.DFS-visit(v),|Adj[v]|,:\n$$  \\sum\\_{v \\in V}|Adj[v]| = O(E) $$\nDFS $O(V + E)$.\n\nDFS,. v : v , d[v], v , f[v].,.\n\n####  Topological sort\n(Directed Acyclic GraphDAG)G,G,uv, $(u,v) \\in E[G]$,uv.,(Topological Order),.(Activity On Vertex network,AOV),.\n\ndag.:\n![dag](/images/dag.png)\n\nAOV,0.\n* 0\n* .\n,,,.\n\ntime,.,,BFS.\n```\ntopoligical-sort(G)\ncall DFS(G) to compute finishing times f[v] for each vertex v\nas each vete is finished, insert it onto the front of a linked list\nreturn the linked list of vertices\n```\n\n#### \n(strongly connected component):G=(V,E) $C \\subseteq V$, Cu, v, .\n\nSCC: G:\n$$ G^T = (V, E^T), E^T = \\{(u, v):(v, u) \\in E\\} $$\n $G^{SCC} = (V^{SCC}, E^{SCC})$,G $[C\\_1, C\\_2, \\dots, C\\_k]$. $V^{SCC} = \\{v\\_1, v\\_2, \\dots, v\\_k \\}$,G $C\\_i$, $v\\_i$. $x \\in C\\_i$  $y \\in C\\_i$, G(x, y),  $(v\\_i,v\\_j) \\in E^{SCC}$. G, $G^{SCC}$.  $G^{SCC}$(dag);\n![scc](/images/scc.png)\n\n> 1. G f[x];\n> 2. G $G^T$;\n> 3. f[x]$G^T$,G $G^T$;\n3 G.\n```\nstrongly-connnected-component(G)\ncall DFS(G) to compute finishing times f[u] for each vertex u\ncompute GT\ncall DFS(GT). but in the main loop of DFS, consider the vertices in order of decreasing f[u](as computed in line 1)\noutput the vertices of each tree in the depth-first forest formed in line 3 as a separate strongly connected component\n```\n\n### Chapter23  Minimum Spanning Trees\n(spanning tree)T: TG, T.T, .\n,KruskalPrim.\n\n#### \n(): n-1 , n ,.:\n![mst](/images/mst.png)\n\n,,A, :\n, A.\n,(u, v), A, ,  $A \\bigcup \\{(u, v) \\}$.(u, v)(safe edge).:\n```\ngeneric-mst(G, w)\nA <- Empty\nwhile A does not form a spanning tree\n    do find an edge(u, v) that is safe for A\n        A <- A union (u, v)\nreturn A\n```\n\n#### Kruskal\nKruskal:,,.,A,A.\npart5Kruskal.`find-set(u)``find-set(v)`,uv,`Union`.\n```\nmst-kruskal(G, w)\nA <- Empty\nfor each vertex v in V[G]\n    do make-set(v)\nsort the edges of E into nondecreasing order by weight w\nfor each edge(u, v) in E, taken in nondecreasing order by weight\n    do if find-set(u) != find-set(v)\n        then A <- A union (u, v)\n            Union(u, v)\nreturn A\n```\n\n:\n![kruskal](/images/kruskal.png)\n\nKruskal:\n,. $O(1)$,  $O(E\\log E)$.,  $O(E)$ `find-set``union`, |V|`make-set`,$O((V + E)\\alpha(V)$.G, |E| > |v| - 1,  $O(E\\alpha(v))$.  $\\alpha(|V|) = O(\\log V) = O(\\log E)$, $O(E\\log E)$.  $|E| < |V| ^ 2$,  $\\log |E| = O(\\log V)$, Kruskal $O(E\\log V)$\n\n#### Prim\nPrim:A,A.r, A $G\\_A=(V, A)$ ()A, .:\n![prim](/images/prim.png)\n\nPrimkeyQ,A.key[u]u.f[u]u.\n```\nmst-prim(G, w, r)\nfor each u in V[G]\n    do key[u] <- INT\n        f[u] <- Null\nkey[r] <- 0\nQ <- V[G]\nwhile Q != Empty\n    do u <- extract-min(Q)\n        for each v in Adj[u]\n            do if v in Q and w(u, v) < key[v]\n                then f[u] <- u\n                    key[v] <- w(u, v)\n```\n\nPrim:\nPrimQ, Part5:`build-min-heao`,  $O(V)$. `while`|V|, `extract-min` $O(\\log V)$,  $O(V\\log V)$.`for` $O(E)$ , `decrease-key`key $O(\\log V)$., Prim $O(V\\log V + E\\log V) = O(E\\log V)$., PrimKruskal.\n, Chapter20,|V|, $O(\\log )$ `extract-min`Prim $O(E + V\\log )$.\n\n#### \nPrim:\n> 1. Prim,keyQ;\n> 2. ,Qkey, Kruskal ;\n> 3. Prim ().,, $O(EV)$, $O(E\\log V)$ ,().\n\nKruskal,Kruskal\n\n\n### Chapter24 ?\n:., , ., ,,.\n\n#### \n\nG = (V, E), $w: E \\to R$.\n $p = \\{v\\_0, v\\_1, \\dots, v\\_k\\}$:\n$$ w(p) = \\sum\\_{i=1}^k w(v\\_{i-1}, v\\_i) $$\nuv:\n$$\n\\delta(u, v) =\n\\begin{cases}\nmin\\{w(p): u \\to v \\}, \\text {if path(u, v) exists} \\\\\\\\\n\\infty, else \\\\\\\\\n\\end{cases}\n$$\n $w(p) = \\delta(u, v)$.\n\n:, , //.\n\n\n* : vt, \n* : uv,uv\n* : .\n\n\n1.\n**.**\n$$\\begin{align}\np = < v\\_0, v\\_1, \\dots, v\\_k >v\\_0v\\_k,\\\\\n \\forall i, j, 1 \\leq i \\leq j \\leq k \\\\\np\\_{ij} = < v\\_i, v\\_{i+1}, \\dots, v\\_j> v\\_iv\\_j \\\\\n\\end{align}\n$$\n\n2.\n, ****,., ,.\n![negative path](/images/n-path.png)\n\n3.\n, .,/,.\n\n4.\n,.,vf[v], .`print-path(G, s, v)`.\n![mst-path](/images/mst-path.png)\n\n5.** relaxation**\n $ v \\in V$, d[v]sv,:\n```\ninitialize-single-source(G, s)\nfor each vertex v in V[G]\n    do d[v] <- INT\n        f[v] <- Null\nd[s] <- 0\n```\n, u, v:\n```\nrelax(u, v, w)\nif d[v] > d[u] + w(u, v)\n    then d[v] <- d[u] + w(u, v)\n        f[v] <- u\n```\n, ..Dijkstra, Bellman-Ford.\n\n#### Bellman-Ford\nBellman-Ford, , svd[v].,.:\n```\nbellman-ford(G, w, s)\ninitialize-single-source(G, s)\nfor i <- 1 to |V[G]| - 1\n    do for each edge (u, v) in E[G]\n        do relax(u, v, w)\nfor each edge(u, v) in E[G]\n    do if d[v] > d[u] + w(u, v)\n        then return false\nreturn true\n```\n:\n![bellman-ford](/images/bellman-ford.png)\n\n:\n $O(V)$, |V| - 1,  $O(E)$. $O(E)$.bellman-ford $O(EV)$.\n\n#### dag\n, path(u,v),uv., ., $O(V+E)$ .,,().\n:\n```\ndag-shortest-path(G, w, s)\ntopoligically sort the vertices of G\ninitialize-single-source(G, s)\nfor each vertex u, taken in topoligically sorted order\n    do for each vertex v in Adj[u]\n        do relax(u, v, w)\n```\n\n:\n![dag-path](/images/dag-path.png)\n\n\n#### Dijkstra\nDijkstraS, s. $u \\in V-S$, uS, u.Q,d.\n:\n```\ndijkstra(G, w, s)\ninitialize-single-source(G, s)\ns <- Empty\nQ <- V[G]\nwhile Q != Empty\n    do u <- extract-min(Q)\n        s <- s union {u}\n        for each vertex v in Adj[u]\n            do relax(u, v, w)\n```\n\n:\n![dijkstra](/images/dijkstra.png)\n\n\ndijkstraQ. Q`insert` $O(1)$, ,  $O(V)$;for|E|, |E|`decrease-key` $O(1)$, $O(E)$.S, `extract-min` $O(v)$ |V|, dijkstra $O(V^2 + E) = O(V^2)$.\n, |V|`extract-min` $O(\\log V)$, |E|`decrease-key` $O(1)$.dijkstra $O(V\\log V + E)$.\n","slug":"CLRS-notes5","published":1,"updated":"2017-08-26T03:38:21.610Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3go0008s7amscg7le0v","content":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h2 id=\"Part6-\"><a href=\"#Part6-\" class=\"headerlink\" title=\"Part6 \"></a>Part6 </h2><p>(, , stack, queue), (, , ), -.part6,:</p>\n<ul>\n<li>,/</li>\n<li></li>\n<li></li>\n</ul>\n<p>: $G = (V, E)$ G, V[G], |V|;E[G], |E|;, |V||G|., $O(VE)$  $O(|V||E|)$</p>\n<h3 id=\"Chapter22-\"><a href=\"#Chapter22-\" class=\"headerlink\" title=\"Chapter22 ?\"></a>Chapter22 ?</h3><p>.:</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<a id=\"more\"></a>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>:</p>\n<ul>\n<li><p>(adjacency lists)<br>|V|<em>Adj</em>,  $u \\in V$, Adj[u] Gu.($|E||V|^2$).<br>,, $O(V+E)$ ;,.</p>\n</li>\n<li><p>(adjacency matrix)<br>G|V| * |V| $A = {a_{ij}}$, :<br>$$ a_{ij} =<br>\\begin{cases}<br>1, \\text {if (i, j)} \\in E \\\\<br>0, else \\\\<br>\\end{cases}<br>$$<br>,  $O(v^2)$<br>A,$A=A^T$ .,,,.</p>\n</li>\n</ul>\n<p>1 <br><img src=\"/images/graph1.png\" alt=\"directed graph\"></p>\n<p>2 <br><img src=\"/images/graph2.png\" alt=\"undirected graph\"></p>\n<p>,,,.,,:,,.,,.</p>\n<h4 id=\"-bread-first-search\"><a href=\"#-bread-first-search\" class=\"headerlink\" title=\"(bread-first search)\"></a>(bread-first search)</h4><p>BFS: G=(V, E)s, G, s, s().,sk, sk+1.<br>BFS:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BFS(G, s)</span><br><span class=\"line\">for each vertex u in V[G]-&#123;s&#125;</span><br><span class=\"line\">    do color[u] &lt;- white      #color:</span><br><span class=\"line\">        d[u] &lt;- INT           #d[u]: us</span><br><span class=\"line\">        f[u] &lt;- Null          #f[u]: u</span><br><span class=\"line\">color[s] &lt;- gray</span><br><span class=\"line\">d[s] &lt;- i</span><br><span class=\"line\">f[s] &lt;- Null</span><br><span class=\"line\">Q &lt;- Empty                     #Q:</span><br><span class=\"line\">Enqueue(Q, s)</span><br><span class=\"line\">while Q != Empty</span><br><span class=\"line\">    do u &lt;- Dequeu(Q)</span><br><span class=\"line\">    for each v in Adj[u]</span><br><span class=\"line\">        do if color[u] = white</span><br><span class=\"line\">            then color[u] &lt;- gray</span><br><span class=\"line\">            d[v] &lt;- d[u] + 1</span><br><span class=\"line\">            f[v] &lt;- u</span><br><span class=\"line\">            Enqueue(Q, v)</span><br><span class=\"line\">    color[u] &lt;- black</span><br></pre></td></tr></table></figure></p>\n<p>3<br><img src=\"/images/bfs.png\" alt=\"BFS\"></p>\n<p>BFS:<br>part4(aggregate analysis), color,vEnqueue,Dequeue.EnqueueDequeue $O(1)$ , $O(V)$.vAdj[v], ,  $O(E)$.  $O(V + E)$.</p>\n<p><strong>BFS, G, s, ,</strong>.,BFS,s<strong></strong>.sv,svGsv().BFSf[u] $G_f = (V_f, E_f)$ G = (V, E):<br>\\begin{align}<br>V_f = {v \\in V: f[v] \\neq Null } \\bigcup {s} \\\\<br>E_f = {(f[v], v): v \\in V_f - {s} }<br>\\end{align}</p>\n<p>BFSsv:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">print-path(G, s, v)</span><br><span class=\"line\">if v == s</span><br><span class=\"line\">    then print s</span><br><span class=\"line\">    else if f[v] = Null</span><br><span class=\"line\">        then print &quot;no path from&quot; s &quot;to&quot; v &quot;exists&quot;</span><br><span class=\"line\">        else print-path(G, s, f[v])</span><br><span class=\"line\">            print v</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"-depth-first-search\"><a href=\"#-depth-first-search\" class=\"headerlink\" title=\"(depth-first search)\"></a>(depth-first search)</h3><p>DFS:u, u,.u,u..DFS.<br>DFS:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DFS(G)</span><br><span class=\"line\">for each vertex u in V[G]</span><br><span class=\"line\">    do color[u] &lt;- white</span><br><span class=\"line\">        f[u] &lt;- Null</span><br><span class=\"line\">time &lt;- 0                       #, f[v]</span><br><span class=\"line\">for each vertex u in V[G]</span><br><span class=\"line\">    do if colo[u] = white</span><br><span class=\"line\">    then DFS-visit[u]</span><br><span class=\"line\"></span><br><span class=\"line\">DFS-visit(u)</span><br><span class=\"line\">colo[u] &lt;- gray</span><br><span class=\"line\">d[u] &lt;- time + 1</span><br><span class=\"line\">d[u] &lt;- time</span><br><span class=\"line\">for each v in Adj[u]</span><br><span class=\"line\">    do if color[v]  = white</span><br><span class=\"line\">        then f[v] &lt;- u</span><br><span class=\"line\">        DFS-visit(v)</span><br><span class=\"line\">color[u] &lt;- black</span><br><span class=\"line\">f[u] &lt;- time &lt;- time + 1</span><br></pre></td></tr></table></figure></p>\n<p>DFS4<br><img src=\"/images/dfs.png\" alt=\"dfs\"></p>\n<p>DFS: , ,  $O(V)$.u, DFS-visit,.DFS-visit(v),|Adj[v]|,:<br>$$  \\sum_{v \\in V}|Adj[v]| = O(E) $$<br>DFS $O(V + E)$.</p>\n<p>DFS,. v : v , d[v], v , f[v].,.</p>\n<h4 id=\"-Topological-sort\"><a href=\"#-Topological-sort\" class=\"headerlink\" title=\" Topological sort\"></a> Topological sort</h4><p>(Directed Acyclic GraphDAG)G,G,uv, $(u,v) \\in E[G]$,uv.,(Topological Order),.(Activity On Vertex network,AOV),.</p>\n<p>dag.:<br><img src=\"/images/dag.png\" alt=\"dag\"></p>\n<p>AOV,0.</p>\n<ul>\n<li>0</li>\n<li>.<br>,,,.</li>\n</ul>\n<p>time,.,,BFS.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">topoligical-sort(G)</span><br><span class=\"line\">call DFS(G) to compute finishing times f[v] for each vertex v</span><br><span class=\"line\">as each vete is finished, insert it onto the front of a linked list</span><br><span class=\"line\">return the linked list of vertices</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>(strongly connected component):G=(V,E) $C \\subseteq V$, Cu, v, .</p>\n<p>SCC: G:<br>$$ G^T = (V, E^T), E^T = {(u, v):(v, u) \\in E} $$<br> $G^{SCC} = (V^{SCC}, E^{SCC})$,G $[C_1, C_2, \\dots, C_k]$. $V^{SCC} = {v_1, v_2, \\dots, v_k }$,G $C_i$, $v_i$. $x \\in C_i$  $y \\in C_i$, G(x, y),  $(v_i,v_j) \\in E^{SCC}$. G, $G^{SCC}$.  $G^{SCC}$(dag);<br><img src=\"/images/scc.png\" alt=\"scc\"></p>\n<blockquote>\n<ol>\n<li>G f[x];</li>\n<li>G $G^T$;</li>\n<li>f[x]$G^T$,G $G^T$;<br>3 G.<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">strongly-connnected-component(G)</span><br><span class=\"line\">call DFS(G) to compute finishing times f[u] for each vertex u</span><br><span class=\"line\">compute GT</span><br><span class=\"line\">call DFS(GT). but in the main loop of DFS, consider the vertices in order of decreasing f[u](as computed in line 1)</span><br><span class=\"line\">output the vertices of each tree in the depth-first forest formed in line 3 as a separate strongly connected component</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"Chapter23--Minimum-Spanning-Trees\"><a href=\"#Chapter23--Minimum-Spanning-Trees\" class=\"headerlink\" title=\"Chapter23  Minimum Spanning Trees\"></a>Chapter23  Minimum Spanning Trees</h3><p>(spanning tree)T: TG, T.T, .<br>,KruskalPrim.</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>(): n-1 , n ,.:<br><img src=\"/images/mst.png\" alt=\"mst\"></p>\n<p>,,A, :<br>, A.<br>,(u, v), A, ,  $A \\bigcup {(u, v) }$.(u, v)(safe edge).:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">generic-mst(G, w)</span><br><span class=\"line\">A &lt;- Empty</span><br><span class=\"line\">while A does not form a spanning tree</span><br><span class=\"line\">    do find an edge(u, v) that is safe for A</span><br><span class=\"line\">        A &lt;- A union (u, v)</span><br><span class=\"line\">return A</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"Kruskal\"><a href=\"#Kruskal\" class=\"headerlink\" title=\"Kruskal\"></a>Kruskal</h4><p>Kruskal:,,.,A,A.<br>part5Kruskal.<code>find-set(u)</code><code>find-set(v)</code>,uv,<code>Union</code>.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mst-kruskal(G, w)</span><br><span class=\"line\">A &lt;- Empty</span><br><span class=\"line\">for each vertex v in V[G]</span><br><span class=\"line\">    do make-set(v)</span><br><span class=\"line\">sort the edges of E into nondecreasing order by weight w</span><br><span class=\"line\">for each edge(u, v) in E, taken in nondecreasing order by weight</span><br><span class=\"line\">    do if find-set(u) != find-set(v)</span><br><span class=\"line\">        then A &lt;- A union (u, v)</span><br><span class=\"line\">            Union(u, v)</span><br><span class=\"line\">return A</span><br></pre></td></tr></table></figure></p>\n<p>:<br><img src=\"/images/kruskal.png\" alt=\"kruskal\"></p>\n<p>Kruskal:<br>,. $O(1)$,  $O(E\\log E)$.,  $O(E)$ <code>find-set</code><code>union</code>, |V|<code>make-set</code>,$O((V + E)\\alpha(V)$.G, |E| &gt; |v| - 1,  $O(E\\alpha(v))$.  $\\alpha(|V|) = O(\\log V) = O(\\log E)$, $O(E\\log E)$.  $|E| &lt; |V| ^ 2$,  $\\log |E| = O(\\log V)$, Kruskal $O(E\\log V)$</p>\n<h4 id=\"Prim\"><a href=\"#Prim\" class=\"headerlink\" title=\"Prim\"></a>Prim</h4><p>Prim:A,A.r, A $G_A=(V, A)$ ()A, .:<br><img src=\"/images/prim.png\" alt=\"prim\"></p>\n<p>PrimkeyQ,A.key[u]u.f[u]u.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mst-prim(G, w, r)</span><br><span class=\"line\">for each u in V[G]</span><br><span class=\"line\">    do key[u] &lt;- INT</span><br><span class=\"line\">        f[u] &lt;- Null</span><br><span class=\"line\">key[r] &lt;- 0</span><br><span class=\"line\">Q &lt;- V[G]</span><br><span class=\"line\">while Q != Empty</span><br><span class=\"line\">    do u &lt;- extract-min(Q)</span><br><span class=\"line\">        for each v in Adj[u]</span><br><span class=\"line\">            do if v in Q and w(u, v) &lt; key[v]</span><br><span class=\"line\">                then f[u] &lt;- u</span><br><span class=\"line\">                    key[v] &lt;- w(u, v)</span><br></pre></td></tr></table></figure></p>\n<p>Prim:<br>PrimQ, Part5:<code>build-min-heao</code>,  $O(V)$. <code>while</code>|V|, <code>extract-min</code> $O(\\log V)$,  $O(V\\log V)$.<code>for</code> $O(E)$ , <code>decrease-key</code>key $O(\\log V)$., Prim $O(V\\log V + E\\log V) = O(E\\log V)$., PrimKruskal.<br>, Chapter20,|V|, $O(\\log )$ <code>extract-min</code>Prim $O(E + V\\log )$.</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Prim:</p>\n<blockquote>\n<ol>\n<li>Prim,keyQ;</li>\n<li>,Qkey, Kruskal ;</li>\n<li>Prim ().,, $O(EV)$, $O(E\\log V)$ ,().</li>\n</ol>\n</blockquote>\n<p>Kruskal,Kruskal</p>\n<h3 id=\"Chapter24-\"><a href=\"#Chapter24-\" class=\"headerlink\" title=\"Chapter24 ?\"></a>Chapter24 ?</h3><p>:., , ., ,,.</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><br>G = (V, E), $w: E \\to R$.<br> $p = {v_0, v_1, \\dots, v_k}$:<br>$$ w(p) = \\sum_{i=1}^k w(v_{i-1}, v_i) $$<br>uv:<br>$$<br>\\delta(u, v) =<br>\\begin{cases}<br>min{w(p): u \\to v }, \\text {if path(u, v) exists} \\\\<br>\\infty, else \\\\<br>\\end{cases}<br>$$<br> $w(p) = \\delta(u, v)$.</p>\n<p>:, , //.</p>\n<p></p>\n<ul>\n<li>: vt, </li>\n<li>: uv,uv</li>\n<li>: .</li>\n</ul>\n<p><br>1.<br><strong>.</strong><br>$$\\begin{align}<br>p = &lt; v_0, v_1, \\dots, v_k &gt;v_0v_k,\\<br> \\forall i, j, 1 \\leq i \\leq j \\leq k \\<br>p_{ij} = &lt; v_i, v_{i+1}, \\dots, v_j&gt; v_iv_j \\<br>\\end{align}<br>$$</p>\n<p>2.<br>, <strong></strong>,., ,.<br><img src=\"/images/n-path.png\" alt=\"negative path\"></p>\n<p>3.<br>, .,/,.</p>\n<p>4.<br>,.,vf[v], .<code>print-path(G, s, v)</code>.<br><img src=\"/images/mst-path.png\" alt=\"mst-path\"></p>\n<p>5.<strong> relaxation</strong><br> $ v \\in V$, d[v]sv,:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">initialize-single-source(G, s)</span><br><span class=\"line\">for each vertex v in V[G]</span><br><span class=\"line\">    do d[v] &lt;- INT</span><br><span class=\"line\">        f[v] &lt;- Null</span><br><span class=\"line\">d[s] &lt;- 0</span><br></pre></td></tr></table></figure></p>\n<p>, u, v:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">relax(u, v, w)</span><br><span class=\"line\">if d[v] &gt; d[u] + w(u, v)</span><br><span class=\"line\">    then d[v] &lt;- d[u] + w(u, v)</span><br><span class=\"line\">        f[v] &lt;- u</span><br></pre></td></tr></table></figure></p>\n<p>, ..Dijkstra, Bellman-Ford.</p>\n<h4 id=\"Bellman-Ford\"><a href=\"#Bellman-Ford\" class=\"headerlink\" title=\"Bellman-Ford\"></a>Bellman-Ford</h4><p>Bellman-Ford, , svd[v].,.:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bellman-ford(G, w, s)</span><br><span class=\"line\">initialize-single-source(G, s)</span><br><span class=\"line\">for i &lt;- 1 to |V[G]| - 1</span><br><span class=\"line\">    do for each edge (u, v) in E[G]</span><br><span class=\"line\">        do relax(u, v, w)</span><br><span class=\"line\">for each edge(u, v) in E[G]</span><br><span class=\"line\">    do if d[v] &gt; d[u] + w(u, v)</span><br><span class=\"line\">        then return false</span><br><span class=\"line\">return true</span><br></pre></td></tr></table></figure></p>\n<p>:<br><img src=\"/images/bellman-ford.png\" alt=\"bellman-ford\"></p>\n<p>:<br> $O(V)$, |V| - 1,  $O(E)$. $O(E)$.bellman-ford $O(EV)$.</p>\n<h4 id=\"dag\"><a href=\"#dag\" class=\"headerlink\" title=\"dag\"></a>dag</h4><p>, path(u,v),uv., ., $O(V+E)$ .,,().<br>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dag-shortest-path(G, w, s)</span><br><span class=\"line\">topoligically sort the vertices of G</span><br><span class=\"line\">initialize-single-source(G, s)</span><br><span class=\"line\">for each vertex u, taken in topoligically sorted order</span><br><span class=\"line\">    do for each vertex v in Adj[u]</span><br><span class=\"line\">        do relax(u, v, w)</span><br></pre></td></tr></table></figure></p>\n<p>:<br><img src=\"/images/dag-path.png\" alt=\"dag-path\"></p>\n<h4 id=\"Dijkstra\"><a href=\"#Dijkstra\" class=\"headerlink\" title=\"Dijkstra\"></a>Dijkstra</h4><p>DijkstraS, s. $u \\in V-S$, uS, u.Q,d.<br>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dijkstra(G, w, s)</span><br><span class=\"line\">initialize-single-source(G, s)</span><br><span class=\"line\">s &lt;- Empty</span><br><span class=\"line\">Q &lt;- V[G]</span><br><span class=\"line\">while Q != Empty</span><br><span class=\"line\">    do u &lt;- extract-min(Q)</span><br><span class=\"line\">        s &lt;- s union &#123;u&#125;</span><br><span class=\"line\">        for each vertex v in Adj[u]</span><br><span class=\"line\">            do relax(u, v, w)</span><br></pre></td></tr></table></figure></p>\n<p>:<br><img src=\"/images/dijkstra.png\" alt=\"dijkstra\"></p>\n<p><br>dijkstraQ. Q<code>insert</code> $O(1)$, ,  $O(V)$;for|E|, |E|<code>decrease-key</code> $O(1)$, $O(E)$.S, <code>extract-min</code> $O(v)$ |V|, dijkstra $O(V^2 + E) = O(V^2)$.<br>, |V|<code>extract-min</code> $O(\\log V)$, |E|<code>decrease-key</code> $O(1)$.dijkstra $O(V\\log V + E)$.</p>\n","site":{"data":{}},"excerpt":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h2 id=\"Part6-\"><a href=\"#Part6-\" class=\"headerlink\" title=\"Part6 \"></a>Part6 </h2><p>(, , stack, queue), (, , ), -.part6,:</p>\n<ul>\n<li>,/</li>\n<li></li>\n<li></li>\n</ul>\n<p>: $G = (V, E)$ G, V[G], |V|;E[G], |E|;, |V||G|., $O(VE)$  $O(|V||E|)$</p>\n<h3 id=\"Chapter22-\"><a href=\"#Chapter22-\" class=\"headerlink\" title=\"Chapter22 ?\"></a>Chapter22 ?</h3><p>.:</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>","more":"<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>:</p>\n<ul>\n<li><p>(adjacency lists)<br>|V|<em>Adj</em>,  $u \\in V$, Adj[u] Gu.($|E||V|^2$).<br>,, $O(V+E)$ ;,.</p>\n</li>\n<li><p>(adjacency matrix)<br>G|V| * |V| $A = {a_{ij}}$, :<br>$$ a_{ij} =<br>\\begin{cases}<br>1, \\text {if (i, j)} \\in E \\\\<br>0, else \\\\<br>\\end{cases}<br>$$<br>,  $O(v^2)$<br>A,$A=A^T$ .,,,.</p>\n</li>\n</ul>\n<p>1 <br><img src=\"/images/graph1.png\" alt=\"directed graph\"></p>\n<p>2 <br><img src=\"/images/graph2.png\" alt=\"undirected graph\"></p>\n<p>,,,.,,:,,.,,.</p>\n<h4 id=\"-bread-first-search\"><a href=\"#-bread-first-search\" class=\"headerlink\" title=\"(bread-first search)\"></a>(bread-first search)</h4><p>BFS: G=(V, E)s, G, s, s().,sk, sk+1.<br>BFS:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BFS(G, s)</span><br><span class=\"line\">for each vertex u in V[G]-&#123;s&#125;</span><br><span class=\"line\">    do color[u] &lt;- white      #color:</span><br><span class=\"line\">        d[u] &lt;- INT           #d[u]: us</span><br><span class=\"line\">        f[u] &lt;- Null          #f[u]: u</span><br><span class=\"line\">color[s] &lt;- gray</span><br><span class=\"line\">d[s] &lt;- i</span><br><span class=\"line\">f[s] &lt;- Null</span><br><span class=\"line\">Q &lt;- Empty                     #Q:</span><br><span class=\"line\">Enqueue(Q, s)</span><br><span class=\"line\">while Q != Empty</span><br><span class=\"line\">    do u &lt;- Dequeu(Q)</span><br><span class=\"line\">    for each v in Adj[u]</span><br><span class=\"line\">        do if color[u] = white</span><br><span class=\"line\">            then color[u] &lt;- gray</span><br><span class=\"line\">            d[v] &lt;- d[u] + 1</span><br><span class=\"line\">            f[v] &lt;- u</span><br><span class=\"line\">            Enqueue(Q, v)</span><br><span class=\"line\">    color[u] &lt;- black</span><br></pre></td></tr></table></figure></p>\n<p>3<br><img src=\"/images/bfs.png\" alt=\"BFS\"></p>\n<p>BFS:<br>part4(aggregate analysis), color,vEnqueue,Dequeue.EnqueueDequeue $O(1)$ , $O(V)$.vAdj[v], ,  $O(E)$.  $O(V + E)$.</p>\n<p><strong>BFS, G, s, ,</strong>.,BFS,s<strong></strong>.sv,svGsv().BFSf[u] $G_f = (V_f, E_f)$ G = (V, E):<br>\\begin{align}<br>V_f = {v \\in V: f[v] \\neq Null } \\bigcup {s} \\\\<br>E_f = {(f[v], v): v \\in V_f - {s} }<br>\\end{align}</p>\n<p>BFSsv:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">print-path(G, s, v)</span><br><span class=\"line\">if v == s</span><br><span class=\"line\">    then print s</span><br><span class=\"line\">    else if f[v] = Null</span><br><span class=\"line\">        then print &quot;no path from&quot; s &quot;to&quot; v &quot;exists&quot;</span><br><span class=\"line\">        else print-path(G, s, f[v])</span><br><span class=\"line\">            print v</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"-depth-first-search\"><a href=\"#-depth-first-search\" class=\"headerlink\" title=\"(depth-first search)\"></a>(depth-first search)</h3><p>DFS:u, u,.u,u..DFS.<br>DFS:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DFS(G)</span><br><span class=\"line\">for each vertex u in V[G]</span><br><span class=\"line\">    do color[u] &lt;- white</span><br><span class=\"line\">        f[u] &lt;- Null</span><br><span class=\"line\">time &lt;- 0                       #, f[v]</span><br><span class=\"line\">for each vertex u in V[G]</span><br><span class=\"line\">    do if colo[u] = white</span><br><span class=\"line\">    then DFS-visit[u]</span><br><span class=\"line\"></span><br><span class=\"line\">DFS-visit(u)</span><br><span class=\"line\">colo[u] &lt;- gray</span><br><span class=\"line\">d[u] &lt;- time + 1</span><br><span class=\"line\">d[u] &lt;- time</span><br><span class=\"line\">for each v in Adj[u]</span><br><span class=\"line\">    do if color[v]  = white</span><br><span class=\"line\">        then f[v] &lt;- u</span><br><span class=\"line\">        DFS-visit(v)</span><br><span class=\"line\">color[u] &lt;- black</span><br><span class=\"line\">f[u] &lt;- time &lt;- time + 1</span><br></pre></td></tr></table></figure></p>\n<p>DFS4<br><img src=\"/images/dfs.png\" alt=\"dfs\"></p>\n<p>DFS: , ,  $O(V)$.u, DFS-visit,.DFS-visit(v),|Adj[v]|,:<br>$$  \\sum_{v \\in V}|Adj[v]| = O(E) $$<br>DFS $O(V + E)$.</p>\n<p>DFS,. v : v , d[v], v , f[v].,.</p>\n<h4 id=\"-Topological-sort\"><a href=\"#-Topological-sort\" class=\"headerlink\" title=\" Topological sort\"></a> Topological sort</h4><p>(Directed Acyclic GraphDAG)G,G,uv, $(u,v) \\in E[G]$,uv.,(Topological Order),.(Activity On Vertex network,AOV),.</p>\n<p>dag.:<br><img src=\"/images/dag.png\" alt=\"dag\"></p>\n<p>AOV,0.</p>\n<ul>\n<li>0</li>\n<li>.<br>,,,.</li>\n</ul>\n<p>time,.,,BFS.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">topoligical-sort(G)</span><br><span class=\"line\">call DFS(G) to compute finishing times f[v] for each vertex v</span><br><span class=\"line\">as each vete is finished, insert it onto the front of a linked list</span><br><span class=\"line\">return the linked list of vertices</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>(strongly connected component):G=(V,E) $C \\subseteq V$, Cu, v, .</p>\n<p>SCC: G:<br>$$ G^T = (V, E^T), E^T = {(u, v):(v, u) \\in E} $$<br> $G^{SCC} = (V^{SCC}, E^{SCC})$,G $[C_1, C_2, \\dots, C_k]$. $V^{SCC} = {v_1, v_2, \\dots, v_k }$,G $C_i$, $v_i$. $x \\in C_i$  $y \\in C_i$, G(x, y),  $(v_i,v_j) \\in E^{SCC}$. G, $G^{SCC}$.  $G^{SCC}$(dag);<br><img src=\"/images/scc.png\" alt=\"scc\"></p>\n<blockquote>\n<ol>\n<li>G f[x];</li>\n<li>G $G^T$;</li>\n<li>f[x]$G^T$,G $G^T$;<br>3 G.<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">strongly-connnected-component(G)</span><br><span class=\"line\">call DFS(G) to compute finishing times f[u] for each vertex u</span><br><span class=\"line\">compute GT</span><br><span class=\"line\">call DFS(GT). but in the main loop of DFS, consider the vertices in order of decreasing f[u](as computed in line 1)</span><br><span class=\"line\">output the vertices of each tree in the depth-first forest formed in line 3 as a separate strongly connected component</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"Chapter23--Minimum-Spanning-Trees\"><a href=\"#Chapter23--Minimum-Spanning-Trees\" class=\"headerlink\" title=\"Chapter23  Minimum Spanning Trees\"></a>Chapter23  Minimum Spanning Trees</h3><p>(spanning tree)T: TG, T.T, .<br>,KruskalPrim.</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>(): n-1 , n ,.:<br><img src=\"/images/mst.png\" alt=\"mst\"></p>\n<p>,,A, :<br>, A.<br>,(u, v), A, ,  $A \\bigcup {(u, v) }$.(u, v)(safe edge).:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">generic-mst(G, w)</span><br><span class=\"line\">A &lt;- Empty</span><br><span class=\"line\">while A does not form a spanning tree</span><br><span class=\"line\">    do find an edge(u, v) that is safe for A</span><br><span class=\"line\">        A &lt;- A union (u, v)</span><br><span class=\"line\">return A</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"Kruskal\"><a href=\"#Kruskal\" class=\"headerlink\" title=\"Kruskal\"></a>Kruskal</h4><p>Kruskal:,,.,A,A.<br>part5Kruskal.<code>find-set(u)</code><code>find-set(v)</code>,uv,<code>Union</code>.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mst-kruskal(G, w)</span><br><span class=\"line\">A &lt;- Empty</span><br><span class=\"line\">for each vertex v in V[G]</span><br><span class=\"line\">    do make-set(v)</span><br><span class=\"line\">sort the edges of E into nondecreasing order by weight w</span><br><span class=\"line\">for each edge(u, v) in E, taken in nondecreasing order by weight</span><br><span class=\"line\">    do if find-set(u) != find-set(v)</span><br><span class=\"line\">        then A &lt;- A union (u, v)</span><br><span class=\"line\">            Union(u, v)</span><br><span class=\"line\">return A</span><br></pre></td></tr></table></figure></p>\n<p>:<br><img src=\"/images/kruskal.png\" alt=\"kruskal\"></p>\n<p>Kruskal:<br>,. $O(1)$,  $O(E\\log E)$.,  $O(E)$ <code>find-set</code><code>union</code>, |V|<code>make-set</code>,$O((V + E)\\alpha(V)$.G, |E| &gt; |v| - 1,  $O(E\\alpha(v))$.  $\\alpha(|V|) = O(\\log V) = O(\\log E)$, $O(E\\log E)$.  $|E| &lt; |V| ^ 2$,  $\\log |E| = O(\\log V)$, Kruskal $O(E\\log V)$</p>\n<h4 id=\"Prim\"><a href=\"#Prim\" class=\"headerlink\" title=\"Prim\"></a>Prim</h4><p>Prim:A,A.r, A $G_A=(V, A)$ ()A, .:<br><img src=\"/images/prim.png\" alt=\"prim\"></p>\n<p>PrimkeyQ,A.key[u]u.f[u]u.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mst-prim(G, w, r)</span><br><span class=\"line\">for each u in V[G]</span><br><span class=\"line\">    do key[u] &lt;- INT</span><br><span class=\"line\">        f[u] &lt;- Null</span><br><span class=\"line\">key[r] &lt;- 0</span><br><span class=\"line\">Q &lt;- V[G]</span><br><span class=\"line\">while Q != Empty</span><br><span class=\"line\">    do u &lt;- extract-min(Q)</span><br><span class=\"line\">        for each v in Adj[u]</span><br><span class=\"line\">            do if v in Q and w(u, v) &lt; key[v]</span><br><span class=\"line\">                then f[u] &lt;- u</span><br><span class=\"line\">                    key[v] &lt;- w(u, v)</span><br></pre></td></tr></table></figure></p>\n<p>Prim:<br>PrimQ, Part5:<code>build-min-heao</code>,  $O(V)$. <code>while</code>|V|, <code>extract-min</code> $O(\\log V)$,  $O(V\\log V)$.<code>for</code> $O(E)$ , <code>decrease-key</code>key $O(\\log V)$., Prim $O(V\\log V + E\\log V) = O(E\\log V)$., PrimKruskal.<br>, Chapter20,|V|, $O(\\log )$ <code>extract-min</code>Prim $O(E + V\\log )$.</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Prim:</p>\n<blockquote>\n<ol>\n<li>Prim,keyQ;</li>\n<li>,Qkey, Kruskal ;</li>\n<li>Prim ().,, $O(EV)$, $O(E\\log V)$ ,().</li>\n</ol>\n</blockquote>\n<p>Kruskal,Kruskal</p>\n<h3 id=\"Chapter24-\"><a href=\"#Chapter24-\" class=\"headerlink\" title=\"Chapter24 ?\"></a>Chapter24 ?</h3><p>:., , ., ,,.</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><br>G = (V, E), $w: E \\to R$.<br> $p = {v_0, v_1, \\dots, v_k}$:<br>$$ w(p) = \\sum_{i=1}^k w(v_{i-1}, v_i) $$<br>uv:<br>$$<br>\\delta(u, v) =<br>\\begin{cases}<br>min{w(p): u \\to v }, \\text {if path(u, v) exists} \\\\<br>\\infty, else \\\\<br>\\end{cases}<br>$$<br> $w(p) = \\delta(u, v)$.</p>\n<p>:, , //.</p>\n<p></p>\n<ul>\n<li>: vt, </li>\n<li>: uv,uv</li>\n<li>: .</li>\n</ul>\n<p><br>1.<br><strong>.</strong><br>$$\\begin{align}<br>p = &lt; v_0, v_1, \\dots, v_k &gt;v_0v_k,\\<br> \\forall i, j, 1 \\leq i \\leq j \\leq k \\<br>p_{ij} = &lt; v_i, v_{i+1}, \\dots, v_j&gt; v_iv_j \\<br>\\end{align}<br>$$</p>\n<p>2.<br>, <strong></strong>,., ,.<br><img src=\"/images/n-path.png\" alt=\"negative path\"></p>\n<p>3.<br>, .,/,.</p>\n<p>4.<br>,.,vf[v], .<code>print-path(G, s, v)</code>.<br><img src=\"/images/mst-path.png\" alt=\"mst-path\"></p>\n<p>5.<strong> relaxation</strong><br> $ v \\in V$, d[v]sv,:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">initialize-single-source(G, s)</span><br><span class=\"line\">for each vertex v in V[G]</span><br><span class=\"line\">    do d[v] &lt;- INT</span><br><span class=\"line\">        f[v] &lt;- Null</span><br><span class=\"line\">d[s] &lt;- 0</span><br></pre></td></tr></table></figure></p>\n<p>, u, v:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">relax(u, v, w)</span><br><span class=\"line\">if d[v] &gt; d[u] + w(u, v)</span><br><span class=\"line\">    then d[v] &lt;- d[u] + w(u, v)</span><br><span class=\"line\">        f[v] &lt;- u</span><br></pre></td></tr></table></figure></p>\n<p>, ..Dijkstra, Bellman-Ford.</p>\n<h4 id=\"Bellman-Ford\"><a href=\"#Bellman-Ford\" class=\"headerlink\" title=\"Bellman-Ford\"></a>Bellman-Ford</h4><p>Bellman-Ford, , svd[v].,.:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bellman-ford(G, w, s)</span><br><span class=\"line\">initialize-single-source(G, s)</span><br><span class=\"line\">for i &lt;- 1 to |V[G]| - 1</span><br><span class=\"line\">    do for each edge (u, v) in E[G]</span><br><span class=\"line\">        do relax(u, v, w)</span><br><span class=\"line\">for each edge(u, v) in E[G]</span><br><span class=\"line\">    do if d[v] &gt; d[u] + w(u, v)</span><br><span class=\"line\">        then return false</span><br><span class=\"line\">return true</span><br></pre></td></tr></table></figure></p>\n<p>:<br><img src=\"/images/bellman-ford.png\" alt=\"bellman-ford\"></p>\n<p>:<br> $O(V)$, |V| - 1,  $O(E)$. $O(E)$.bellman-ford $O(EV)$.</p>\n<h4 id=\"dag\"><a href=\"#dag\" class=\"headerlink\" title=\"dag\"></a>dag</h4><p>, path(u,v),uv., ., $O(V+E)$ .,,().<br>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dag-shortest-path(G, w, s)</span><br><span class=\"line\">topoligically sort the vertices of G</span><br><span class=\"line\">initialize-single-source(G, s)</span><br><span class=\"line\">for each vertex u, taken in topoligically sorted order</span><br><span class=\"line\">    do for each vertex v in Adj[u]</span><br><span class=\"line\">        do relax(u, v, w)</span><br></pre></td></tr></table></figure></p>\n<p>:<br><img src=\"/images/dag-path.png\" alt=\"dag-path\"></p>\n<h4 id=\"Dijkstra\"><a href=\"#Dijkstra\" class=\"headerlink\" title=\"Dijkstra\"></a>Dijkstra</h4><p>DijkstraS, s. $u \\in V-S$, uS, u.Q,d.<br>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dijkstra(G, w, s)</span><br><span class=\"line\">initialize-single-source(G, s)</span><br><span class=\"line\">s &lt;- Empty</span><br><span class=\"line\">Q &lt;- V[G]</span><br><span class=\"line\">while Q != Empty</span><br><span class=\"line\">    do u &lt;- extract-min(Q)</span><br><span class=\"line\">        s &lt;- s union &#123;u&#125;</span><br><span class=\"line\">        for each vertex v in Adj[u]</span><br><span class=\"line\">            do relax(u, v, w)</span><br></pre></td></tr></table></figure></p>\n<p>:<br><img src=\"/images/dijkstra.png\" alt=\"dijkstra\"></p>\n<p><br>dijkstraQ. Q<code>insert</code> $O(1)$, ,  $O(V)$;for|E|, |E|<code>decrease-key</code> $O(1)$, $O(E)$.S, <code>extract-min</code> $O(v)$ |V|, dijkstra $O(V^2 + E) = O(V^2)$.<br>, |V|<code>extract-min</code> $O(\\log V)$, |E|<code>decrease-key</code> $O(1)$.dijkstra $O(V\\log V + E)$.</p>"},{"title":"introduction to algorithms note3","date":"2017-04-21T16:00:00.000Z","_content":"\n# Introduction to algorithms\n\n### Part4 \npart1-3:\n*  divide and conquer\n*  randomize\n*  recursion\n\n, ,.,,., \n:\n1. :,\n2. :\n3. ,.\n\n*  dynamic programming\n> * ,.,.,.\n\n*  greedy algorithm\n> * ,.,.\n\n*  amortized analysis\n> * .,,,.,.\n\n<!-- more -->\n#### Chapter15 ?\n\n1.:\n* ,,\n* ,.\n,,,,.\n\nfib(5)\n- :\n```\nfib(n):\n  return fib(n-1) + fib(n-2)\nfib(5) = fib(4) + fib(3)\n       = (fib(3) + fib(2)) + (fib(2) + fib(1))\n       = ((fib(2) + fib(1)) + fib(2)) + (fib(2) + fib(1))\n```\n, fib(2)fib(1), $O(2^n)$\n- \n```\narray Fib[];\nFib[1] = 1, Fib[2] = 1;\nfib(n):\n  if Fib(n) != 0\n    return Fib(n)\n    else return fib(n-1) + fib(n-2)\n```\nFib(n), , , $O(n)$\n\n2.****:\n, ,(Max or Min).\n,  4 :\n> 1. \n> 2. \n> 3. \n> 4. \n> \n\n****:\n> 1.:\nn $(A\\_1, A\\_2, \\ldots, A\\_n)$, :\n> $$A\\_1 A\\_2 \\ldots A\\_n \\qquad (15.1)$$\n> (15.1), `matrix-multiply(A, B)`\n```\nmatrix-multiply(A, B)\nif columns[A] != rows[B]\n  then error \"imcompatible dimensions\"\n  else for i <- 1 to rows[A]\n    do for j <- 1 to columns[B]\n      do C[i, j] <- 0\n        for k <- 1 to columns[A]\n          do C[i, j] <- C[i, j] + A[i, k] * B[k, j]\n```\n> ,  $(A\\_1, A\\_2, A\\_3, A\\_4)$ , 5:\n> \\begin{align}\n(A\\_1(A\\_2(A\\_3A\\_4))) \\\\\\\\\n(A\\_1((A\\_2A\\_3)A\\_4)) \\\\\\\\\n...\n\\end{align}\n> , `matrix-multiply(A, B)`,\n> Ap*q, Bq*r -> $O(pqr)$\n> , ()?\n\n> 2.\n,, .P(n), :\n> $$\nP(N) =\n\\begin{cases}\n1, \\text {if n = 1} \\\\\\\\\n\\sum\\_{k=1}^{n=1}P(k)P(n-k),\\text {if n >= 2}\n\\end{cases}\n$$\n>  $O(2^n)$,, .\n> a. \n> \\begin{align}\nA\\_{i \\dots j} A\\_iA\\_{i+1} \\dots A\\_j \\\\\\\\\n i\\leq k < j,  \\\\\\\\\nO(A\\_{i \\dots j}) = O(A\\_{i \\dots k}) + O(A\\_{k+1 \\dots j}) + O(A\\_{i \\dots k} * A\\_{k+1 \\dots j}) \\\\\\\\\n\\because A\\_{k+1} \\dots A\\_jA\\_iA\\_{i+1} \\dots A\\_j,\\\\\\\\\nA\\_{k+1} \\dots A\\_jO(A\\_{i \\dots j}) \\\\\\\\\n\\therefore : \\\\\\\\\nA\\_{k+1} \\dots A\\_jA\\_iA\\_{i+1} \\dots A\\_j\n\\end{align}\n\n> b. \n> \n> \\begin{align}\nm[i,j]A\\_{i \\dots j} \\\\\\\\\nm[i, j] =\n\\begin{cases}\n0, \\text {if i = j} \\\\\\\\\nmin\\_{i \\leq k < j}\\\\{m[i,k] + m[k+1,j] + p\\_{i-1} p\\_k p\\_j \\\\},else\n\\end{cases}\ns[i, j] = k k\n\\end{align}\n\n> c. \n> (,), ****.,,, \n> \\begin{align}\nA\\_ip\\_{i-1}\\*p\\_i, i = 1,2,\\dots,n \\\\\\\\\n[A\\_1, A\\_2, \\ldots, A\\_n p=[p\\_0,p\\_1,\\dots,p\\_n] \\\\\\\\\nm[1\\dots n, 1\\dots n]m[i, j] \\\\\\\\\ns[1\\dots n, 1\\dots n]m[i,j]k \\\\\\\\\n\\end{align}\n```\nmatrix-chain-order(p)\n  n <- length[p] - 1 # n\n  for i <- 1 to n\n    do m[i,i] <- 0 #10\n  for l <- 2 to n #l\n    do for i <- 1 to n - l + 1\n      do j <- i + l - 1\n        m[i,j] <- INT\n        for k <- i to j - 1\n          do q <- m[i,k] + m[k+1,j] + p(i-1)p(k)p(j)\n            if q < m[i,j]\n              then m[i,j] <- q;s[i,j] <- k\n  return m and s\n```\n> `matrix-chain-order`1, m[i,j]m[i,k]m[k+1,j], ,.\n\n> d. \n  `matirx-chain-order`,.s[i,j],$A\\_{1 \\dots n}$, $A\\_{1 \\dots s[1,n]}A\\_{s[1,n]+1 \\dots n}$, .\n```\nprint-optimal-parens(s, i, j)\n  if i = j\n    then print \"A\"(i)\n    else print \"(\"\n      print-optimal-parens(s, i, s[i,j])\n      print-optimal-parens(s, s[i,j]+1, j)\n      print \")\"\n```\n\n3.****\n,:\n* ** Optimal substructure**\n\n> ,;,.,$A\\_iA\\_{i+1} \\dots A\\_j$$A\\_iA\\_{i+1} \\dots A\\_k$$A\\_kA\\_{k+1} \\dots A\\_j$.\n?:\n> 1. .\n> 2. ,\n> 3. ,,\n> 4. (cut and paste),\n\n> .,\"\"\"\",,.\n(,):\n> 1. \n> 2. \n\n> ::..,,$A\\_k$, $p\\_{i-1}p\\_kp\\_j$.\n,.:\n1. 2.2,.\n> ****: ,.\n\n* ** Overlapping subproblems**\n\n> ,.\n,.,,.,,.\n> ,`matrix-chain-order`,.m[3,4]:m[2,4],m[1,4],m[3,5]m[3,6].,,m[i,j],$O(2^n)$\n```\nrecursive-matirc-chain(p, i, j)\n  if i = j\n    then return 0\n  m[i,j] <- INT\n  for k <- i to j - 1\n    do q <- recursive-matirc-chain(p, i, k) + recursive-matirc-chain(p, k+1, j) + p(i-1)p(k)p(i)\n    if q < m[i, j]\n      then m[i,j] <- q\n  return m[i,j]\n```\n\n4.** memorandum method**\n> :,,.:\n1. ,.\n2. ,.,.\n\n> :,,,.\n\n> :\n```\nmemoized-matirx-chain(p)\n  n <- length[p] - 1\n  for i <- i to n\n    do for j <- i to n\n      do m[i,j] <- INT\n  return lookup-chain(p, 1, n)\n\n#\nlookup-chain(p, i, j)\n  if m[i,j] < INT\n    then return m[i,j]\n  if i = j\n    then m[i,j] <- 0\n    else for k <- i to j - 1\n      do q <- lookup-chain(p,i,k) + lookup-chain(p,k+1,j)+p(i-1)p(k)p(j)\n      if q < m[i,j]\n        then m[i,j] <- q\n  return m[i,j]\n```\n> :\n> 1. ,.,,.\n> 2. ,,;,\n,.(,)\n\n> :.,;.\n\n\n#### Chapter16 ?\n\n,.\n,.,,.\n\n1.\n> n$S= {a\\_1,a\\_2,\\dots,a\\_n}$,.$a\\_i$$s\\_i$$f\\_i$, $0 < s\\_i < f\\_i < \\infty$.,$a\\_i$ $[s\\_i,f\\_i)$ . $[s\\_i,f\\_i] [s\\_j,f\\_j)$ , $a\\_i$ $a\\_j$..\n> \n> a. \n:\n> $$S\\_{ij} = \\\\{a\\_k \\in S: f\\_i \\leq s\\_k < f\\_k \\leq s\\_j \\\\}$$\n>  $S\\_{ij}$ S,. $a\\_i$ , $a\\_i$ ., $a\\_0$  $a\\_{n+1}$ ,$f\\_0=0,s\\_{n+1}= \\infty$.\n\n> $$f\\_0 \\leq f\\_1 \\leq \\dots \\leq f\\_n \\leq f\\_{n+1}$$\n> $i \\geq j$,$S\\_{i,j}$ ., $S\\_{i,j}$ , $0ijn+1$, $S\\_{i,j}$ .\n> : $S\\_{ij}$  $A\\_{ij}$  $a\\_k$, $S\\_{ik}$  $A\\_{ik}$  $S\\_{kj}$  $A\\_{kj}$ . $a\\_k$ ,$S\\_{ij}$ $A\\_{ij}$:\n> $$A\\_{ij} = A\\_{ik} \\bigcup \\\\{a\\_k\\\\} \\bigcup A\\_{kj}$$\n\n> b.\nc[i, j] $S\\_{ij}$ , $S\\_{ij}$ ,c[i, j]=0$S\\_{ij}$, $a\\_k$  $S\\_{ij}$ , $S\\_{ik}$  $S\\_{kj}$ ,$c[i, j] = c[i, k] + c[k, j] + 1$\n\n> $$\nc[i, j] =\n\\begin{cases}\n0, if \\, S\\_{ij} = \\emptyset \\\\\\\\\nmax\\_{i<k<j}\\\\{c[i,k]+c[j,k]+1\\\\},else\n\\end{cases}$$\n\n> c.\n, $S\\_{ij}$  $a\\_m$  $S\\_{ij}$ ,\n> $$f\\_m = min \\\\{ f\\_k: a\\_k \\in  S\\_{ij} \\\\}$$\n> :\n> 1.  $a\\_m$  $S\\_{ij}$ .\n> 2.  $S\\_{im}$  $a\\_m$  $S\\_{mj}$ .\n\n>  $S\\_{ij}$  $S\\_{ij}$ .,,.\n $S\\_{ij}$  $S\\_{ij}$  $a\\_m$  $a\\_m$  $S\\_{mj}$ .\n:\n```\nrecursive-activity-selector(s, f, i, j)\n  m <- i + 1\n  while m < j and s(m) < f(i)\n    do m <- m + 1\n  if m < j\n    then return {a(m)} and recursive-activity-selector(s, f, m, j)\n    else return none\n```\n> :\n```\ngreedy-activity-selector(s, f)\n  n <- length[s]\n  A <- {a(i)}\n  i <- 1\n  for m <- 2 to n\n    do if s(m) > f(i)\n      then A <- A and {a(m)}\n        i <- m\n  return A\n```\n\n2.\n> , , ,, .,()..,,.,,.\n\n3.:\n> 1. ,(),.\n> 2. ,.\n> 3. ,.,.\n\n> 2: .\n> 1. ****:();,.\n> 2. ****:.\n\n> ,:\n> 1. .,,,.\n> 2. ,.\n\n4.\n > ,,..\n\n#### Chapter17 ?\n1.** amortized analysis**\n,.,,.\n> ;,.,,.\n `C++ STL`  `vector.push_back` ,`push_back``vector`$O(1)$, `vector`,`vector`,`push_back`,$O(n)$,,,`push_back` $O(1)$.\n\n2.:\n> * :$T(n)$, $T(n)/n$\n> * :,\n> * :,,\n\n\n3.**: aggregate analysis**\n> N$T(n)$,()$T(n)/n$.,N.\n: -> \n> `stack`(`multipop`, )\n```\npush(S, x): O(1)\npop(S): O(1)\nmultipop(S, k): O(n)\n  while not stack-empty(S) and k != 0\n    do pop(s)\n      k <- k - 1\n```\n> n`push``pop` $O(n)$ ,  $O(n)$ `multipop`,?\nstack$O(n)$, N $O(2^n)$., n`multipop`.\n`pop``push`,\n, `multipop``pop`\n`pop` $\\leq$ `push`\nn$O(n)$,$O(n)/n=O(1)$\n\n\n4.**: bookkeeping method**\n> ,(credit),:().:\n> 1. .\n> 2. ,.,.\n> 3. ,,.\n\n> stack,:\n\n|             |         |       |\n|----------------|----------------|------------- |\n|push            |1               |2             |\n|pop             |1               |0             |\n|multipop        |min(k, s)       |0             |\n> 2,1`push`,1`pop`.,`pop`.\n\n\n5.**: potential method**\n> ,,.., ,2)\n> \\begin{align}\nD\\_0, c\\_ii \\\\\\\\\nD\\_iD\\_{i-1}i \\\\\\\\\n\\Phi: D\\_i \\mapsto \\Phi(D\\_i) \\\\\\\\\n \\hat{c\\_i} = c\\_i + \\Phi(D\\_i) - \\Phi(D\\_{i-1}) \\\\\\\\\n \\sum\\_{i=1}^n\\hat{c\\_i} = \\sum\\_{i=1}^n(c\\_i + \\Phi(D\\_i) - \\Phi(D\\_{i-1})) = \\sum\\_{i=1}^n c\\_i + \\Phi(D\\_n) - \\Phi(D\\_0)\n\\end{align}\n\n> `stack`,\n> \\begin{align}\n\\Phi stack \\\\\\\\\nstack D\\_0, \\Phi(D\\_0) = 0 \\\\\\\\\npush: \\\\\\\\\n\\hat{c\\_i} = c\\_i + \\Phi(D\\_i) - \\Phi(D\\_{i-1}) = 1 + (s+1) - s = 2 \\\\\\\\\nmultipop: \\\\\\\\\n\\hat{c\\_i} = c\\_i + \\Phi(D\\_i) - \\Phi(D\\_{i-1}) = k + (s -k) - s = 0 \\\\\\\\\n\\therefore O(1) \\\\\\\\\n\\therefore nO(n)\n\\end{align}\n","source":"_posts/CLRS-notes3.md","raw":"title: introduction to algorithms note3\ntags:\n  - algorithm\n  - data_structure\ndate: 2017/04/22\n\n----\n\n# Introduction to algorithms\n\n### Part4 \npart1-3:\n*  divide and conquer\n*  randomize\n*  recursion\n\n, ,.,,., \n:\n1. :,\n2. :\n3. ,.\n\n*  dynamic programming\n> * ,.,.,.\n\n*  greedy algorithm\n> * ,.,.\n\n*  amortized analysis\n> * .,,,.,.\n\n<!-- more -->\n#### Chapter15 ?\n\n1.:\n* ,,\n* ,.\n,,,,.\n\nfib(5)\n- :\n```\nfib(n):\n  return fib(n-1) + fib(n-2)\nfib(5) = fib(4) + fib(3)\n       = (fib(3) + fib(2)) + (fib(2) + fib(1))\n       = ((fib(2) + fib(1)) + fib(2)) + (fib(2) + fib(1))\n```\n, fib(2)fib(1), $O(2^n)$\n- \n```\narray Fib[];\nFib[1] = 1, Fib[2] = 1;\nfib(n):\n  if Fib(n) != 0\n    return Fib(n)\n    else return fib(n-1) + fib(n-2)\n```\nFib(n), , , $O(n)$\n\n2.****:\n, ,(Max or Min).\n,  4 :\n> 1. \n> 2. \n> 3. \n> 4. \n> \n\n****:\n> 1.:\nn $(A\\_1, A\\_2, \\ldots, A\\_n)$, :\n> $$A\\_1 A\\_2 \\ldots A\\_n \\qquad (15.1)$$\n> (15.1), `matrix-multiply(A, B)`\n```\nmatrix-multiply(A, B)\nif columns[A] != rows[B]\n  then error \"imcompatible dimensions\"\n  else for i <- 1 to rows[A]\n    do for j <- 1 to columns[B]\n      do C[i, j] <- 0\n        for k <- 1 to columns[A]\n          do C[i, j] <- C[i, j] + A[i, k] * B[k, j]\n```\n> ,  $(A\\_1, A\\_2, A\\_3, A\\_4)$ , 5:\n> \\begin{align}\n(A\\_1(A\\_2(A\\_3A\\_4))) \\\\\\\\\n(A\\_1((A\\_2A\\_3)A\\_4)) \\\\\\\\\n...\n\\end{align}\n> , `matrix-multiply(A, B)`,\n> Ap*q, Bq*r -> $O(pqr)$\n> , ()?\n\n> 2.\n,, .P(n), :\n> $$\nP(N) =\n\\begin{cases}\n1, \\text {if n = 1} \\\\\\\\\n\\sum\\_{k=1}^{n=1}P(k)P(n-k),\\text {if n >= 2}\n\\end{cases}\n$$\n>  $O(2^n)$,, .\n> a. \n> \\begin{align}\nA\\_{i \\dots j} A\\_iA\\_{i+1} \\dots A\\_j \\\\\\\\\n i\\leq k < j,  \\\\\\\\\nO(A\\_{i \\dots j}) = O(A\\_{i \\dots k}) + O(A\\_{k+1 \\dots j}) + O(A\\_{i \\dots k} * A\\_{k+1 \\dots j}) \\\\\\\\\n\\because A\\_{k+1} \\dots A\\_jA\\_iA\\_{i+1} \\dots A\\_j,\\\\\\\\\nA\\_{k+1} \\dots A\\_jO(A\\_{i \\dots j}) \\\\\\\\\n\\therefore : \\\\\\\\\nA\\_{k+1} \\dots A\\_jA\\_iA\\_{i+1} \\dots A\\_j\n\\end{align}\n\n> b. \n> \n> \\begin{align}\nm[i,j]A\\_{i \\dots j} \\\\\\\\\nm[i, j] =\n\\begin{cases}\n0, \\text {if i = j} \\\\\\\\\nmin\\_{i \\leq k < j}\\\\{m[i,k] + m[k+1,j] + p\\_{i-1} p\\_k p\\_j \\\\},else\n\\end{cases}\ns[i, j] = k k\n\\end{align}\n\n> c. \n> (,), ****.,,, \n> \\begin{align}\nA\\_ip\\_{i-1}\\*p\\_i, i = 1,2,\\dots,n \\\\\\\\\n[A\\_1, A\\_2, \\ldots, A\\_n p=[p\\_0,p\\_1,\\dots,p\\_n] \\\\\\\\\nm[1\\dots n, 1\\dots n]m[i, j] \\\\\\\\\ns[1\\dots n, 1\\dots n]m[i,j]k \\\\\\\\\n\\end{align}\n```\nmatrix-chain-order(p)\n  n <- length[p] - 1 # n\n  for i <- 1 to n\n    do m[i,i] <- 0 #10\n  for l <- 2 to n #l\n    do for i <- 1 to n - l + 1\n      do j <- i + l - 1\n        m[i,j] <- INT\n        for k <- i to j - 1\n          do q <- m[i,k] + m[k+1,j] + p(i-1)p(k)p(j)\n            if q < m[i,j]\n              then m[i,j] <- q;s[i,j] <- k\n  return m and s\n```\n> `matrix-chain-order`1, m[i,j]m[i,k]m[k+1,j], ,.\n\n> d. \n  `matirx-chain-order`,.s[i,j],$A\\_{1 \\dots n}$, $A\\_{1 \\dots s[1,n]}A\\_{s[1,n]+1 \\dots n}$, .\n```\nprint-optimal-parens(s, i, j)\n  if i = j\n    then print \"A\"(i)\n    else print \"(\"\n      print-optimal-parens(s, i, s[i,j])\n      print-optimal-parens(s, s[i,j]+1, j)\n      print \")\"\n```\n\n3.****\n,:\n* ** Optimal substructure**\n\n> ,;,.,$A\\_iA\\_{i+1} \\dots A\\_j$$A\\_iA\\_{i+1} \\dots A\\_k$$A\\_kA\\_{k+1} \\dots A\\_j$.\n?:\n> 1. .\n> 2. ,\n> 3. ,,\n> 4. (cut and paste),\n\n> .,\"\"\"\",,.\n(,):\n> 1. \n> 2. \n\n> ::..,,$A\\_k$, $p\\_{i-1}p\\_kp\\_j$.\n,.:\n1. 2.2,.\n> ****: ,.\n\n* ** Overlapping subproblems**\n\n> ,.\n,.,,.,,.\n> ,`matrix-chain-order`,.m[3,4]:m[2,4],m[1,4],m[3,5]m[3,6].,,m[i,j],$O(2^n)$\n```\nrecursive-matirc-chain(p, i, j)\n  if i = j\n    then return 0\n  m[i,j] <- INT\n  for k <- i to j - 1\n    do q <- recursive-matirc-chain(p, i, k) + recursive-matirc-chain(p, k+1, j) + p(i-1)p(k)p(i)\n    if q < m[i, j]\n      then m[i,j] <- q\n  return m[i,j]\n```\n\n4.** memorandum method**\n> :,,.:\n1. ,.\n2. ,.,.\n\n> :,,,.\n\n> :\n```\nmemoized-matirx-chain(p)\n  n <- length[p] - 1\n  for i <- i to n\n    do for j <- i to n\n      do m[i,j] <- INT\n  return lookup-chain(p, 1, n)\n\n#\nlookup-chain(p, i, j)\n  if m[i,j] < INT\n    then return m[i,j]\n  if i = j\n    then m[i,j] <- 0\n    else for k <- i to j - 1\n      do q <- lookup-chain(p,i,k) + lookup-chain(p,k+1,j)+p(i-1)p(k)p(j)\n      if q < m[i,j]\n        then m[i,j] <- q\n  return m[i,j]\n```\n> :\n> 1. ,.,,.\n> 2. ,,;,\n,.(,)\n\n> :.,;.\n\n\n#### Chapter16 ?\n\n,.\n,.,,.\n\n1.\n> n$S= {a\\_1,a\\_2,\\dots,a\\_n}$,.$a\\_i$$s\\_i$$f\\_i$, $0 < s\\_i < f\\_i < \\infty$.,$a\\_i$ $[s\\_i,f\\_i)$ . $[s\\_i,f\\_i] [s\\_j,f\\_j)$ , $a\\_i$ $a\\_j$..\n> \n> a. \n:\n> $$S\\_{ij} = \\\\{a\\_k \\in S: f\\_i \\leq s\\_k < f\\_k \\leq s\\_j \\\\}$$\n>  $S\\_{ij}$ S,. $a\\_i$ , $a\\_i$ ., $a\\_0$  $a\\_{n+1}$ ,$f\\_0=0,s\\_{n+1}= \\infty$.\n\n> $$f\\_0 \\leq f\\_1 \\leq \\dots \\leq f\\_n \\leq f\\_{n+1}$$\n> $i \\geq j$,$S\\_{i,j}$ ., $S\\_{i,j}$ , $0ijn+1$, $S\\_{i,j}$ .\n> : $S\\_{ij}$  $A\\_{ij}$  $a\\_k$, $S\\_{ik}$  $A\\_{ik}$  $S\\_{kj}$  $A\\_{kj}$ . $a\\_k$ ,$S\\_{ij}$ $A\\_{ij}$:\n> $$A\\_{ij} = A\\_{ik} \\bigcup \\\\{a\\_k\\\\} \\bigcup A\\_{kj}$$\n\n> b.\nc[i, j] $S\\_{ij}$ , $S\\_{ij}$ ,c[i, j]=0$S\\_{ij}$, $a\\_k$  $S\\_{ij}$ , $S\\_{ik}$  $S\\_{kj}$ ,$c[i, j] = c[i, k] + c[k, j] + 1$\n\n> $$\nc[i, j] =\n\\begin{cases}\n0, if \\, S\\_{ij} = \\emptyset \\\\\\\\\nmax\\_{i<k<j}\\\\{c[i,k]+c[j,k]+1\\\\},else\n\\end{cases}$$\n\n> c.\n, $S\\_{ij}$  $a\\_m$  $S\\_{ij}$ ,\n> $$f\\_m = min \\\\{ f\\_k: a\\_k \\in  S\\_{ij} \\\\}$$\n> :\n> 1.  $a\\_m$  $S\\_{ij}$ .\n> 2.  $S\\_{im}$  $a\\_m$  $S\\_{mj}$ .\n\n>  $S\\_{ij}$  $S\\_{ij}$ .,,.\n $S\\_{ij}$  $S\\_{ij}$  $a\\_m$  $a\\_m$  $S\\_{mj}$ .\n:\n```\nrecursive-activity-selector(s, f, i, j)\n  m <- i + 1\n  while m < j and s(m) < f(i)\n    do m <- m + 1\n  if m < j\n    then return {a(m)} and recursive-activity-selector(s, f, m, j)\n    else return none\n```\n> :\n```\ngreedy-activity-selector(s, f)\n  n <- length[s]\n  A <- {a(i)}\n  i <- 1\n  for m <- 2 to n\n    do if s(m) > f(i)\n      then A <- A and {a(m)}\n        i <- m\n  return A\n```\n\n2.\n> , , ,, .,()..,,.,,.\n\n3.:\n> 1. ,(),.\n> 2. ,.\n> 3. ,.,.\n\n> 2: .\n> 1. ****:();,.\n> 2. ****:.\n\n> ,:\n> 1. .,,,.\n> 2. ,.\n\n4.\n > ,,..\n\n#### Chapter17 ?\n1.** amortized analysis**\n,.,,.\n> ;,.,,.\n `C++ STL`  `vector.push_back` ,`push_back``vector`$O(1)$, `vector`,`vector`,`push_back`,$O(n)$,,,`push_back` $O(1)$.\n\n2.:\n> * :$T(n)$, $T(n)/n$\n> * :,\n> * :,,\n\n\n3.**: aggregate analysis**\n> N$T(n)$,()$T(n)/n$.,N.\n: -> \n> `stack`(`multipop`, )\n```\npush(S, x): O(1)\npop(S): O(1)\nmultipop(S, k): O(n)\n  while not stack-empty(S) and k != 0\n    do pop(s)\n      k <- k - 1\n```\n> n`push``pop` $O(n)$ ,  $O(n)$ `multipop`,?\nstack$O(n)$, N $O(2^n)$., n`multipop`.\n`pop``push`,\n, `multipop``pop`\n`pop` $\\leq$ `push`\nn$O(n)$,$O(n)/n=O(1)$\n\n\n4.**: bookkeeping method**\n> ,(credit),:().:\n> 1. .\n> 2. ,.,.\n> 3. ,,.\n\n> stack,:\n\n|             |         |       |\n|----------------|----------------|------------- |\n|push            |1               |2             |\n|pop             |1               |0             |\n|multipop        |min(k, s)       |0             |\n> 2,1`push`,1`pop`.,`pop`.\n\n\n5.**: potential method**\n> ,,.., ,2)\n> \\begin{align}\nD\\_0, c\\_ii \\\\\\\\\nD\\_iD\\_{i-1}i \\\\\\\\\n\\Phi: D\\_i \\mapsto \\Phi(D\\_i) \\\\\\\\\n \\hat{c\\_i} = c\\_i + \\Phi(D\\_i) - \\Phi(D\\_{i-1}) \\\\\\\\\n \\sum\\_{i=1}^n\\hat{c\\_i} = \\sum\\_{i=1}^n(c\\_i + \\Phi(D\\_i) - \\Phi(D\\_{i-1})) = \\sum\\_{i=1}^n c\\_i + \\Phi(D\\_n) - \\Phi(D\\_0)\n\\end{align}\n\n> `stack`,\n> \\begin{align}\n\\Phi stack \\\\\\\\\nstack D\\_0, \\Phi(D\\_0) = 0 \\\\\\\\\npush: \\\\\\\\\n\\hat{c\\_i} = c\\_i + \\Phi(D\\_i) - \\Phi(D\\_{i-1}) = 1 + (s+1) - s = 2 \\\\\\\\\nmultipop: \\\\\\\\\n\\hat{c\\_i} = c\\_i + \\Phi(D\\_i) - \\Phi(D\\_{i-1}) = k + (s -k) - s = 0 \\\\\\\\\n\\therefore O(1) \\\\\\\\\n\\therefore nO(n)\n\\end{align}\n","slug":"CLRS-notes3","published":1,"updated":"2017-08-26T03:38:21.610Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3gp000bs7amd9ul8d0t","content":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h3 id=\"Part4-\"><a href=\"#Part4-\" class=\"headerlink\" title=\"Part4 \"></a>Part4 </h3><p>part1-3:</p>\n<ul>\n<li> divide and conquer</li>\n<li> randomize</li>\n<li> recursion</li>\n</ul>\n<p>, ,.,,., <br>:</p>\n<ol>\n<li>:,</li>\n<li>:</li>\n<li>,.</li>\n</ol>\n<ul>\n<li><p> dynamic programming</p>\n<blockquote>\n<ul>\n<li>,.,.,.</li>\n</ul>\n</blockquote>\n</li>\n<li><p> greedy algorithm</p>\n<blockquote>\n<ul>\n<li>,.,.</li>\n</ul>\n</blockquote>\n</li>\n<li><p> amortized analysis</p>\n<blockquote>\n<ul>\n<li>.,,,.,.</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n<a id=\"more\"></a>\n<h4 id=\"Chapter15-\"><a href=\"#Chapter15-\" class=\"headerlink\" title=\"Chapter15 ?\"></a>Chapter15 ?</h4><p>1.:</p>\n<ul>\n<li>,,</li>\n<li>,.<br>,,,,.</li>\n</ul>\n<p>fib(5)</p>\n<ul>\n<li>:<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib(n):</span><br><span class=\"line\">  return fib(n-1) + fib(n-2)</span><br><span class=\"line\">fib(5) = fib(4) + fib(3)</span><br><span class=\"line\">       = (fib(3) + fib(2)) + (fib(2) + fib(1))</span><br><span class=\"line\">       = ((fib(2) + fib(1)) + fib(2)) + (fib(2) + fib(1))</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>, fib(2)fib(1), $O(2^n)$</p>\n<ul>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">array Fib[];</span><br><span class=\"line\">Fib[1] = 1, Fib[2] = 1;</span><br><span class=\"line\">fib(n):</span><br><span class=\"line\">  if Fib(n) != 0</span><br><span class=\"line\">    return Fib(n)</span><br><span class=\"line\">    else return fib(n-1) + fib(n-2)</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Fib(n), , , $O(n)$</p>\n<p>2.<strong></strong>:<br>, ,(Max or Min).<br>,  4 :</p>\n<blockquote>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n<li><br></li>\n</ol>\n</blockquote>\n<p><strong></strong>:</p>\n<blockquote>\n<p>1.:<br>n $(A_1, A_2, \\ldots, A_n)$, :<br>$$A_1 A_2 \\ldots A_n \\qquad (15.1)$$<br>(15.1), <code>matrix-multiply(A, B)</code><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">matrix-multiply(A, B)</span><br><span class=\"line\">if columns[A] != rows[B]</span><br><span class=\"line\">  then error &quot;imcompatible dimensions&quot;</span><br><span class=\"line\">  else for i &lt;- 1 to rows[A]</span><br><span class=\"line\">    do for j &lt;- 1 to columns[B]</span><br><span class=\"line\">      do C[i, j] &lt;- 0</span><br><span class=\"line\">        for k &lt;- 1 to columns[A]</span><br><span class=\"line\">          do C[i, j] &lt;- C[i, j] + A[i, k] * B[k, j]</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>,  $(A_1, A_2, A_3, A_4)$ , 5:<br>\\begin{align}<br>(A_1(A_2(A_3A_4))) \\\\<br>(A_1((A_2A_3)A_4)) \\\\<br><br>\\end{align}<br>, <code>matrix-multiply(A, B)</code>,<br>Ap<em>q, Bq</em>r -&gt; $O(pqr)$<br>, ()?</p>\n</blockquote>\n<blockquote>\n<p>2.<br>,, .P(n), :<br>$$<br>P(N) =<br>\\begin{cases}<br>1, \\text {if n = 1} \\\\<br>\\sum_{k=1}^{n=1}P(k)P(n-k),\\text {if n &gt;= 2}<br>\\end{cases}<br>$$<br> $O(2^n)$,, .<br>a. <br>\\begin{align}<br>A_{i \\dots j} A_iA_{i+1} \\dots A_j \\\\<br> i\\leq k &lt; j,  \\\\<br>O(A_{i \\dots j}) = O(A_{i \\dots k}) + O(A_{k+1 \\dots j}) + O(A_{i \\dots k} * A_{k+1 \\dots j}) \\\\<br>\\because A_{k+1} \\dots A_jA_iA_{i+1} \\dots A_j,\\\\<br>A_{k+1} \\dots A_jO(A_{i \\dots j}) \\\\<br>\\therefore : \\\\<br>A_{k+1} \\dots A_jA_iA_{i+1} \\dots A_j<br>\\end{align}</p>\n</blockquote>\n<blockquote>\n<p>b. <br><br>\\begin{align}<br>m[i,j]A_{i \\dots j} \\\\<br>m[i, j] =<br>\\begin{cases}<br>0, \\text {if i = j} \\\\<br>min_{i \\leq k &lt; j}\\{m[i,k] + m[k+1,j] + p_{i-1} p_k p_j \\},else<br>\\end{cases}<br>s[i, j] = k k<br>\\end{align}</p>\n</blockquote>\n<blockquote>\n<p>c. <br>(,), <strong></strong>.,,, <br>\\begin{align}<br>A_ip_{i-1}*p_i, i = 1,2,\\dots,n \\\\<br>[A_1, A_2, \\ldots, A_n p=[p_0,p_1,\\dots,p_n] \\\\<br>m[1\\dots n, 1\\dots n]m[i, j] \\\\<br>s[1\\dots n, 1\\dots n]m[i,j]k \\\\<br>\\end{align}<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">matrix-chain-order(p)</span><br><span class=\"line\">  n &lt;- length[p] - 1 # n</span><br><span class=\"line\">  for i &lt;- 1 to n</span><br><span class=\"line\">    do m[i,i] &lt;- 0 #10</span><br><span class=\"line\">  for l &lt;- 2 to n #l</span><br><span class=\"line\">    do for i &lt;- 1 to n - l + 1</span><br><span class=\"line\">      do j &lt;- i + l - 1</span><br><span class=\"line\">        m[i,j] &lt;- INT</span><br><span class=\"line\">        for k &lt;- i to j - 1</span><br><span class=\"line\">          do q &lt;- m[i,k] + m[k+1,j] + p(i-1)p(k)p(j)</span><br><span class=\"line\">            if q &lt; m[i,j]</span><br><span class=\"line\">              then m[i,j] &lt;- q;s[i,j] &lt;- k</span><br><span class=\"line\">  return m and s</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>matrix-chain-order</code>1, m[i,j]m[i,k]m[k+1,j], ,.</p>\n</blockquote>\n<blockquote>\n<p>d. <br>  <code>matirx-chain-order</code>,.s[i,j],$A_{1 \\dots n}$, $A_{1 \\dots s[1,n]}A_{s[1,n]+1 \\dots n}$, .<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">print-optimal-parens(s, i, j)</span><br><span class=\"line\">  if i = j</span><br><span class=\"line\">    then print &quot;A&quot;(i)</span><br><span class=\"line\">    else print &quot;(&quot;</span><br><span class=\"line\">      print-optimal-parens(s, i, s[i,j])</span><br><span class=\"line\">      print-optimal-parens(s, s[i,j]+1, j)</span><br><span class=\"line\">      print &quot;)&quot;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>3.<strong></strong><br>,:</p>\n<ul>\n<li><strong> Optimal substructure</strong></li>\n</ul>\n<blockquote>\n<p>,;,.,$A_iA_{i+1} \\dots A_j$$A_iA_{i+1} \\dots A_k$$A_kA_{k+1} \\dots A_j$.<br>?:</p>\n<ol>\n<li>.</li>\n<li>,</li>\n<li>,,</li>\n<li>(cut and paste),</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>.,,,.<br>(,):</p>\n<ol>\n<li></li>\n<li></li>\n</ol>\n</blockquote>\n<blockquote>\n<p>::..,,$A_k$, $p_{i-1}p_kp_j$.<br>,.:<br>1. 2.2,.<br><strong></strong>: ,.</p>\n</blockquote>\n<ul>\n<li><strong> Overlapping subproblems</strong></li>\n</ul>\n<blockquote>\n<p>,.<br>,.,,.,,.<br>,<code>matrix-chain-order</code>,.m[3,4]:m[2,4],m[1,4],m[3,5]m[3,6].,,m[i,j],$O(2^n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">recursive-matirc-chain(p, i, j)</span><br><span class=\"line\">  if i = j</span><br><span class=\"line\">    then return 0</span><br><span class=\"line\">  m[i,j] &lt;- INT</span><br><span class=\"line\">  for k &lt;- i to j - 1</span><br><span class=\"line\">    do q &lt;- recursive-matirc-chain(p, i, k) + recursive-matirc-chain(p, k+1, j) + p(i-1)p(k)p(i)</span><br><span class=\"line\">    if q &lt; m[i, j]</span><br><span class=\"line\">      then m[i,j] &lt;- q</span><br><span class=\"line\">  return m[i,j]</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>4.<strong> memorandum method</strong></p>\n<blockquote>\n<p>:,,.:</p>\n<ol>\n<li>,.</li>\n<li>,.,.</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>:,,,.</p>\n</blockquote>\n<blockquote>\n<p>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memoized-matirx-chain(p)</span><br><span class=\"line\">  n &lt;- length[p] - 1</span><br><span class=\"line\">  for i &lt;- i to n</span><br><span class=\"line\">    do for j &lt;- i to n</span><br><span class=\"line\">      do m[i,j] &lt;- INT</span><br><span class=\"line\">  return lookup-chain(p, 1, n)</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\">lookup-chain(p, i, j)</span><br><span class=\"line\">  if m[i,j] &lt; INT</span><br><span class=\"line\">    then return m[i,j]</span><br><span class=\"line\">  if i = j</span><br><span class=\"line\">    then m[i,j] &lt;- 0</span><br><span class=\"line\">    else for k &lt;- i to j - 1</span><br><span class=\"line\">      do q &lt;- lookup-chain(p,i,k) + lookup-chain(p,k+1,j)+p(i-1)p(k)p(j)</span><br><span class=\"line\">      if q &lt; m[i,j]</span><br><span class=\"line\">        then m[i,j] &lt;- q</span><br><span class=\"line\">  return m[i,j]</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>:</p>\n<ol>\n<li>,.,,.</li>\n<li>,,;,<br>,.(,)</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>:.,;.</p>\n</blockquote>\n<h4 id=\"Chapter16-\"><a href=\"#Chapter16-\" class=\"headerlink\" title=\"Chapter16 ?\"></a>Chapter16 ?</h4><p>,.<br>,.,,.</p>\n<p>1.</p>\n<blockquote>\n<p>n$S= {a_1,a_2,\\dots,a_n}$,.$a_i$$s_i$$f_i$, $0 &lt; s_i &lt; f_i &lt; \\infty$.,$a_i$ $[s_i,f_i)$ . $[s_i,f_i] [s_j,f_j)$ , $a_i$ $a_j$..<br><br>a. <br>:<br>$$S_{ij} = \\{a_k \\in S: f_i \\leq s_k &lt; f_k \\leq s_j \\}$$<br> $S_{ij}$ S,. $a_i$ , $a_i$ ., $a_0$  $a_{n+1}$ ,$f_0=0,s_{n+1}= \\infty$.<br><br>$$f_0 \\leq f_1 \\leq \\dots \\leq f_n \\leq f_{n+1}$$<br>$i \\geq j$,$S_{i,j}$ ., $S_{i,j}$ , $0ijn+1$, $S_{i,j}$ .<br>: $S_{ij}$  $A_{ij}$  $a_k$, $S_{ik}$  $A_{ik}$  $S_{kj}$  $A_{kj}$ . $a_k$ ,$S_{ij}$ $A_{ij}$:<br>$$A_{ij} = A_{ik} \\bigcup \\{a_k\\} \\bigcup A_{kj}$$</p>\n</blockquote>\n<blockquote>\n<p>b.<br>c[i, j] $S_{ij}$ , $S_{ij}$ ,c[i, j]=0$S_{ij}$, $a_k$  $S_{ij}$ , $S_{ik}$  $S_{kj}$ ,$c[i, j] = c[i, k] + c[k, j] + 1$<br><br>$$<br>c[i, j] =<br>\\begin{cases}<br>0, if \\, S_{ij} = \\emptyset \\\\<br>max_{i&lt;k&lt;j}\\{c[i,k]+c[j,k]+1\\},else<br>\\end{cases}$$</p>\n</blockquote>\n<blockquote>\n<p>c.<br>, $S_{ij}$  $a_m$  $S_{ij}$ ,<br>$$f_m = min \\{ f_k: a_k \\in  S_{ij} \\}$$<br>:</p>\n<ol>\n<li>$a_m$  $S_{ij}$ .</li>\n<li>$S_{im}$  $a_m$  $S_{mj}$ .</li>\n</ol>\n</blockquote>\n<blockquote>\n<p> $S_{ij}$  $S_{ij}$ .,,.<br> $S_{ij}$  $S_{ij}$  $a_m$  $a_m$  $S_{mj}$ .<br>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">recursive-activity-selector(s, f, i, j)</span><br><span class=\"line\">  m &lt;- i + 1</span><br><span class=\"line\">  while m &lt; j and s(m) &lt; f(i)</span><br><span class=\"line\">    do m &lt;- m + 1</span><br><span class=\"line\">  if m &lt; j</span><br><span class=\"line\">    then return &#123;a(m)&#125; and recursive-activity-selector(s, f, m, j)</span><br><span class=\"line\">    else return none</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">greedy-activity-selector(s, f)</span><br><span class=\"line\">  n &lt;- length[s]</span><br><span class=\"line\">  A &lt;- &#123;a(i)&#125;</span><br><span class=\"line\">  i &lt;- 1</span><br><span class=\"line\">  for m &lt;- 2 to n</span><br><span class=\"line\">    do if s(m) &gt; f(i)</span><br><span class=\"line\">      then A &lt;- A and &#123;a(m)&#125;</span><br><span class=\"line\">        i &lt;- m</span><br><span class=\"line\">  return A</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>2.</p>\n<blockquote>\n<p>, , ,, .,()..,,.,,.</p>\n</blockquote>\n<p>3.:</p>\n<blockquote>\n<ol>\n<li>,(),.</li>\n<li>,.</li>\n<li>,.,.</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>2: .</p>\n<ol>\n<li><strong></strong>:();,.</li>\n<li><strong></strong>:.</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>,:</p>\n<ol>\n<li>.,,,.</li>\n<li>,.</li>\n</ol>\n</blockquote>\n<p>4.</p>\n<blockquote>\n<p>,,..</p>\n</blockquote>\n<h4 id=\"Chapter17-\"><a href=\"#Chapter17-\" class=\"headerlink\" title=\"Chapter17 ?\"></a>Chapter17 ?</h4><p>1.<strong> amortized analysis</strong><br>,.,,.</p>\n<blockquote>\n<p>;,.,,.<br> <code>C++ STL</code>  <code>vector.push_back</code> ,<code>push_back</code><code>vector</code>$O(1)$, <code>vector</code>,<code>vector</code>,<code>push_back</code>,$O(n)$,,,<code>push_back</code> $O(1)$.</p>\n</blockquote>\n<p>2.:</p>\n<blockquote>\n<ul>\n<li>:$T(n)$, $T(n)/n$</li>\n<li>:,</li>\n<li>:,,</li>\n</ul>\n</blockquote>\n<p>3.<strong>: aggregate analysis</strong></p>\n<blockquote>\n<p>N$T(n)$,()$T(n)/n$.,N.<br>: -&gt; <br><code>stack</code>(<code>multipop</code>, )<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push(S, x): O(1)</span><br><span class=\"line\">pop(S): O(1)</span><br><span class=\"line\">multipop(S, k): O(n)</span><br><span class=\"line\">  while not stack-empty(S) and k != 0</span><br><span class=\"line\">    do pop(s)</span><br><span class=\"line\">      k &lt;- k - 1</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>n<code>push</code><code>pop</code> $O(n)$ ,  $O(n)$ <code>multipop</code>,?<br>stack$O(n)$, N $O(2^n)$., n<code>multipop</code>.<br><code>pop</code><code>push</code>,<br>, <code>multipop</code><code>pop</code><br><code>pop</code> $\\leq$ <code>push</code><br>n$O(n)$,$O(n)/n=O(1)$</p>\n</blockquote>\n<p>4.<strong>: bookkeeping method</strong></p>\n<blockquote>\n<p>,(credit),:().:</p>\n<ol>\n<li>.</li>\n<li>,.,.</li>\n<li>,,.</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>stack,:</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>push</td>\n<td>1</td>\n<td>2</td>\n</tr>\n<tr>\n<td>pop</td>\n<td>1</td>\n<td>0</td>\n</tr>\n<tr>\n<td>multipop</td>\n<td>min(k, s)</td>\n<td>0</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>2,1<code>push</code>,1<code>pop</code>.,<code>pop</code>.</p>\n</blockquote>\n<p>5.<strong>: potential method</strong></p>\n<blockquote>\n<p>,,.., ,2)<br>\\begin{align}<br>D_0, c_ii \\\\<br>D_iD_{i-1}i \\\\<br>\\Phi: D_i \\mapsto \\Phi(D_i) \\\\<br> \\hat{c_i} = c_i + \\Phi(D_i) - \\Phi(D_{i-1}) \\\\<br> \\sum_{i=1}^n\\hat{c_i} = \\sum_{i=1}^n(c_i + \\Phi(D_i) - \\Phi(D_{i-1})) = \\sum_{i=1}^n c_i + \\Phi(D_n) - \\Phi(D_0)<br>\\end{align}</p>\n</blockquote>\n<blockquote>\n<p><code>stack</code>,<br>\\begin{align}<br>\\Phi stack \\\\<br>stack D_0, \\Phi(D_0) = 0 \\\\<br>push: \\\\<br>\\hat{c_i} = c_i + \\Phi(D_i) - \\Phi(D_{i-1}) = 1 + (s+1) - s = 2 \\\\<br>multipop: \\\\<br>\\hat{c_i} = c_i + \\Phi(D_i) - \\Phi(D_{i-1}) = k + (s -k) - s = 0 \\\\<br>\\therefore O(1) \\\\<br>\\therefore nO(n)<br>\\end{align}</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h3 id=\"Part4-\"><a href=\"#Part4-\" class=\"headerlink\" title=\"Part4 \"></a>Part4 </h3><p>part1-3:</p>\n<ul>\n<li> divide and conquer</li>\n<li> randomize</li>\n<li> recursion</li>\n</ul>\n<p>, ,.,,., <br>:</p>\n<ol>\n<li>:,</li>\n<li>:</li>\n<li>,.</li>\n</ol>\n<ul>\n<li><p> dynamic programming</p>\n<blockquote>\n<ul>\n<li>,.,.,.</li>\n</ul>\n</blockquote>\n</li>\n<li><p> greedy algorithm</p>\n<blockquote>\n<ul>\n<li>,.,.</li>\n</ul>\n</blockquote>\n</li>\n<li><p> amortized analysis</p>\n<blockquote>\n<ul>\n<li>.,,,.,.</li>\n</ul>\n</blockquote>\n</li>\n</ul>","more":"<h4 id=\"Chapter15-\"><a href=\"#Chapter15-\" class=\"headerlink\" title=\"Chapter15 ?\"></a>Chapter15 ?</h4><p>1.:</p>\n<ul>\n<li>,,</li>\n<li>,.<br>,,,,.</li>\n</ul>\n<p>fib(5)</p>\n<ul>\n<li>:<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fib(n):</span><br><span class=\"line\">  return fib(n-1) + fib(n-2)</span><br><span class=\"line\">fib(5) = fib(4) + fib(3)</span><br><span class=\"line\">       = (fib(3) + fib(2)) + (fib(2) + fib(1))</span><br><span class=\"line\">       = ((fib(2) + fib(1)) + fib(2)) + (fib(2) + fib(1))</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>, fib(2)fib(1), $O(2^n)$</p>\n<ul>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">array Fib[];</span><br><span class=\"line\">Fib[1] = 1, Fib[2] = 1;</span><br><span class=\"line\">fib(n):</span><br><span class=\"line\">  if Fib(n) != 0</span><br><span class=\"line\">    return Fib(n)</span><br><span class=\"line\">    else return fib(n-1) + fib(n-2)</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Fib(n), , , $O(n)$</p>\n<p>2.<strong></strong>:<br>, ,(Max or Min).<br>,  4 :</p>\n<blockquote>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n<li><br></li>\n</ol>\n</blockquote>\n<p><strong></strong>:</p>\n<blockquote>\n<p>1.:<br>n $(A_1, A_2, \\ldots, A_n)$, :<br>$$A_1 A_2 \\ldots A_n \\qquad (15.1)$$<br>(15.1), <code>matrix-multiply(A, B)</code><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">matrix-multiply(A, B)</span><br><span class=\"line\">if columns[A] != rows[B]</span><br><span class=\"line\">  then error &quot;imcompatible dimensions&quot;</span><br><span class=\"line\">  else for i &lt;- 1 to rows[A]</span><br><span class=\"line\">    do for j &lt;- 1 to columns[B]</span><br><span class=\"line\">      do C[i, j] &lt;- 0</span><br><span class=\"line\">        for k &lt;- 1 to columns[A]</span><br><span class=\"line\">          do C[i, j] &lt;- C[i, j] + A[i, k] * B[k, j]</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>,  $(A_1, A_2, A_3, A_4)$ , 5:<br>\\begin{align}<br>(A_1(A_2(A_3A_4))) \\\\<br>(A_1((A_2A_3)A_4)) \\\\<br><br>\\end{align}<br>, <code>matrix-multiply(A, B)</code>,<br>Ap<em>q, Bq</em>r -&gt; $O(pqr)$<br>, ()?</p>\n</blockquote>\n<blockquote>\n<p>2.<br>,, .P(n), :<br>$$<br>P(N) =<br>\\begin{cases}<br>1, \\text {if n = 1} \\\\<br>\\sum_{k=1}^{n=1}P(k)P(n-k),\\text {if n &gt;= 2}<br>\\end{cases}<br>$$<br> $O(2^n)$,, .<br>a. <br>\\begin{align}<br>A_{i \\dots j} A_iA_{i+1} \\dots A_j \\\\<br> i\\leq k &lt; j,  \\\\<br>O(A_{i \\dots j}) = O(A_{i \\dots k}) + O(A_{k+1 \\dots j}) + O(A_{i \\dots k} * A_{k+1 \\dots j}) \\\\<br>\\because A_{k+1} \\dots A_jA_iA_{i+1} \\dots A_j,\\\\<br>A_{k+1} \\dots A_jO(A_{i \\dots j}) \\\\<br>\\therefore : \\\\<br>A_{k+1} \\dots A_jA_iA_{i+1} \\dots A_j<br>\\end{align}</p>\n</blockquote>\n<blockquote>\n<p>b. <br><br>\\begin{align}<br>m[i,j]A_{i \\dots j} \\\\<br>m[i, j] =<br>\\begin{cases}<br>0, \\text {if i = j} \\\\<br>min_{i \\leq k &lt; j}\\{m[i,k] + m[k+1,j] + p_{i-1} p_k p_j \\},else<br>\\end{cases}<br>s[i, j] = k k<br>\\end{align}</p>\n</blockquote>\n<blockquote>\n<p>c. <br>(,), <strong></strong>.,,, <br>\\begin{align}<br>A_ip_{i-1}*p_i, i = 1,2,\\dots,n \\\\<br>[A_1, A_2, \\ldots, A_n p=[p_0,p_1,\\dots,p_n] \\\\<br>m[1\\dots n, 1\\dots n]m[i, j] \\\\<br>s[1\\dots n, 1\\dots n]m[i,j]k \\\\<br>\\end{align}<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">matrix-chain-order(p)</span><br><span class=\"line\">  n &lt;- length[p] - 1 # n</span><br><span class=\"line\">  for i &lt;- 1 to n</span><br><span class=\"line\">    do m[i,i] &lt;- 0 #10</span><br><span class=\"line\">  for l &lt;- 2 to n #l</span><br><span class=\"line\">    do for i &lt;- 1 to n - l + 1</span><br><span class=\"line\">      do j &lt;- i + l - 1</span><br><span class=\"line\">        m[i,j] &lt;- INT</span><br><span class=\"line\">        for k &lt;- i to j - 1</span><br><span class=\"line\">          do q &lt;- m[i,k] + m[k+1,j] + p(i-1)p(k)p(j)</span><br><span class=\"line\">            if q &lt; m[i,j]</span><br><span class=\"line\">              then m[i,j] &lt;- q;s[i,j] &lt;- k</span><br><span class=\"line\">  return m and s</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>matrix-chain-order</code>1, m[i,j]m[i,k]m[k+1,j], ,.</p>\n</blockquote>\n<blockquote>\n<p>d. <br>  <code>matirx-chain-order</code>,.s[i,j],$A_{1 \\dots n}$, $A_{1 \\dots s[1,n]}A_{s[1,n]+1 \\dots n}$, .<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">print-optimal-parens(s, i, j)</span><br><span class=\"line\">  if i = j</span><br><span class=\"line\">    then print &quot;A&quot;(i)</span><br><span class=\"line\">    else print &quot;(&quot;</span><br><span class=\"line\">      print-optimal-parens(s, i, s[i,j])</span><br><span class=\"line\">      print-optimal-parens(s, s[i,j]+1, j)</span><br><span class=\"line\">      print &quot;)&quot;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>3.<strong></strong><br>,:</p>\n<ul>\n<li><strong> Optimal substructure</strong></li>\n</ul>\n<blockquote>\n<p>,;,.,$A_iA_{i+1} \\dots A_j$$A_iA_{i+1} \\dots A_k$$A_kA_{k+1} \\dots A_j$.<br>?:</p>\n<ol>\n<li>.</li>\n<li>,</li>\n<li>,,</li>\n<li>(cut and paste),</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>.,,,.<br>(,):</p>\n<ol>\n<li></li>\n<li></li>\n</ol>\n</blockquote>\n<blockquote>\n<p>::..,,$A_k$, $p_{i-1}p_kp_j$.<br>,.:<br>1. 2.2,.<br><strong></strong>: ,.</p>\n</blockquote>\n<ul>\n<li><strong> Overlapping subproblems</strong></li>\n</ul>\n<blockquote>\n<p>,.<br>,.,,.,,.<br>,<code>matrix-chain-order</code>,.m[3,4]:m[2,4],m[1,4],m[3,5]m[3,6].,,m[i,j],$O(2^n)$<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">recursive-matirc-chain(p, i, j)</span><br><span class=\"line\">  if i = j</span><br><span class=\"line\">    then return 0</span><br><span class=\"line\">  m[i,j] &lt;- INT</span><br><span class=\"line\">  for k &lt;- i to j - 1</span><br><span class=\"line\">    do q &lt;- recursive-matirc-chain(p, i, k) + recursive-matirc-chain(p, k+1, j) + p(i-1)p(k)p(i)</span><br><span class=\"line\">    if q &lt; m[i, j]</span><br><span class=\"line\">      then m[i,j] &lt;- q</span><br><span class=\"line\">  return m[i,j]</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>4.<strong> memorandum method</strong></p>\n<blockquote>\n<p>:,,.:</p>\n<ol>\n<li>,.</li>\n<li>,.,.</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>:,,,.</p>\n</blockquote>\n<blockquote>\n<p>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">memoized-matirx-chain(p)</span><br><span class=\"line\">  n &lt;- length[p] - 1</span><br><span class=\"line\">  for i &lt;- i to n</span><br><span class=\"line\">    do for j &lt;- i to n</span><br><span class=\"line\">      do m[i,j] &lt;- INT</span><br><span class=\"line\">  return lookup-chain(p, 1, n)</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\">lookup-chain(p, i, j)</span><br><span class=\"line\">  if m[i,j] &lt; INT</span><br><span class=\"line\">    then return m[i,j]</span><br><span class=\"line\">  if i = j</span><br><span class=\"line\">    then m[i,j] &lt;- 0</span><br><span class=\"line\">    else for k &lt;- i to j - 1</span><br><span class=\"line\">      do q &lt;- lookup-chain(p,i,k) + lookup-chain(p,k+1,j)+p(i-1)p(k)p(j)</span><br><span class=\"line\">      if q &lt; m[i,j]</span><br><span class=\"line\">        then m[i,j] &lt;- q</span><br><span class=\"line\">  return m[i,j]</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>:</p>\n<ol>\n<li>,.,,.</li>\n<li>,,;,<br>,.(,)</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>:.,;.</p>\n</blockquote>\n<h4 id=\"Chapter16-\"><a href=\"#Chapter16-\" class=\"headerlink\" title=\"Chapter16 ?\"></a>Chapter16 ?</h4><p>,.<br>,.,,.</p>\n<p>1.</p>\n<blockquote>\n<p>n$S= {a_1,a_2,\\dots,a_n}$,.$a_i$$s_i$$f_i$, $0 &lt; s_i &lt; f_i &lt; \\infty$.,$a_i$ $[s_i,f_i)$ . $[s_i,f_i] [s_j,f_j)$ , $a_i$ $a_j$..<br><br>a. <br>:<br>$$S_{ij} = \\{a_k \\in S: f_i \\leq s_k &lt; f_k \\leq s_j \\}$$<br> $S_{ij}$ S,. $a_i$ , $a_i$ ., $a_0$  $a_{n+1}$ ,$f_0=0,s_{n+1}= \\infty$.<br><br>$$f_0 \\leq f_1 \\leq \\dots \\leq f_n \\leq f_{n+1}$$<br>$i \\geq j$,$S_{i,j}$ ., $S_{i,j}$ , $0ijn+1$, $S_{i,j}$ .<br>: $S_{ij}$  $A_{ij}$  $a_k$, $S_{ik}$  $A_{ik}$  $S_{kj}$  $A_{kj}$ . $a_k$ ,$S_{ij}$ $A_{ij}$:<br>$$A_{ij} = A_{ik} \\bigcup \\{a_k\\} \\bigcup A_{kj}$$</p>\n</blockquote>\n<blockquote>\n<p>b.<br>c[i, j] $S_{ij}$ , $S_{ij}$ ,c[i, j]=0$S_{ij}$, $a_k$  $S_{ij}$ , $S_{ik}$  $S_{kj}$ ,$c[i, j] = c[i, k] + c[k, j] + 1$<br><br>$$<br>c[i, j] =<br>\\begin{cases}<br>0, if \\, S_{ij} = \\emptyset \\\\<br>max_{i&lt;k&lt;j}\\{c[i,k]+c[j,k]+1\\},else<br>\\end{cases}$$</p>\n</blockquote>\n<blockquote>\n<p>c.<br>, $S_{ij}$  $a_m$  $S_{ij}$ ,<br>$$f_m = min \\{ f_k: a_k \\in  S_{ij} \\}$$<br>:</p>\n<ol>\n<li>$a_m$  $S_{ij}$ .</li>\n<li>$S_{im}$  $a_m$  $S_{mj}$ .</li>\n</ol>\n</blockquote>\n<blockquote>\n<p> $S_{ij}$  $S_{ij}$ .,,.<br> $S_{ij}$  $S_{ij}$  $a_m$  $a_m$  $S_{mj}$ .<br>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">recursive-activity-selector(s, f, i, j)</span><br><span class=\"line\">  m &lt;- i + 1</span><br><span class=\"line\">  while m &lt; j and s(m) &lt; f(i)</span><br><span class=\"line\">    do m &lt;- m + 1</span><br><span class=\"line\">  if m &lt; j</span><br><span class=\"line\">    then return &#123;a(m)&#125; and recursive-activity-selector(s, f, m, j)</span><br><span class=\"line\">    else return none</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">greedy-activity-selector(s, f)</span><br><span class=\"line\">  n &lt;- length[s]</span><br><span class=\"line\">  A &lt;- &#123;a(i)&#125;</span><br><span class=\"line\">  i &lt;- 1</span><br><span class=\"line\">  for m &lt;- 2 to n</span><br><span class=\"line\">    do if s(m) &gt; f(i)</span><br><span class=\"line\">      then A &lt;- A and &#123;a(m)&#125;</span><br><span class=\"line\">        i &lt;- m</span><br><span class=\"line\">  return A</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>2.</p>\n<blockquote>\n<p>, , ,, .,()..,,.,,.</p>\n</blockquote>\n<p>3.:</p>\n<blockquote>\n<ol>\n<li>,(),.</li>\n<li>,.</li>\n<li>,.,.</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>2: .</p>\n<ol>\n<li><strong></strong>:();,.</li>\n<li><strong></strong>:.</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>,:</p>\n<ol>\n<li>.,,,.</li>\n<li>,.</li>\n</ol>\n</blockquote>\n<p>4.</p>\n<blockquote>\n<p>,,..</p>\n</blockquote>\n<h4 id=\"Chapter17-\"><a href=\"#Chapter17-\" class=\"headerlink\" title=\"Chapter17 ?\"></a>Chapter17 ?</h4><p>1.<strong> amortized analysis</strong><br>,.,,.</p>\n<blockquote>\n<p>;,.,,.<br> <code>C++ STL</code>  <code>vector.push_back</code> ,<code>push_back</code><code>vector</code>$O(1)$, <code>vector</code>,<code>vector</code>,<code>push_back</code>,$O(n)$,,,<code>push_back</code> $O(1)$.</p>\n</blockquote>\n<p>2.:</p>\n<blockquote>\n<ul>\n<li>:$T(n)$, $T(n)/n$</li>\n<li>:,</li>\n<li>:,,</li>\n</ul>\n</blockquote>\n<p>3.<strong>: aggregate analysis</strong></p>\n<blockquote>\n<p>N$T(n)$,()$T(n)/n$.,N.<br>: -&gt; <br><code>stack</code>(<code>multipop</code>, )<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push(S, x): O(1)</span><br><span class=\"line\">pop(S): O(1)</span><br><span class=\"line\">multipop(S, k): O(n)</span><br><span class=\"line\">  while not stack-empty(S) and k != 0</span><br><span class=\"line\">    do pop(s)</span><br><span class=\"line\">      k &lt;- k - 1</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>n<code>push</code><code>pop</code> $O(n)$ ,  $O(n)$ <code>multipop</code>,?<br>stack$O(n)$, N $O(2^n)$., n<code>multipop</code>.<br><code>pop</code><code>push</code>,<br>, <code>multipop</code><code>pop</code><br><code>pop</code> $\\leq$ <code>push</code><br>n$O(n)$,$O(n)/n=O(1)$</p>\n</blockquote>\n<p>4.<strong>: bookkeeping method</strong></p>\n<blockquote>\n<p>,(credit),:().:</p>\n<ol>\n<li>.</li>\n<li>,.,.</li>\n<li>,,.</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>stack,:</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>push</td>\n<td>1</td>\n<td>2</td>\n</tr>\n<tr>\n<td>pop</td>\n<td>1</td>\n<td>0</td>\n</tr>\n<tr>\n<td>multipop</td>\n<td>min(k, s)</td>\n<td>0</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>2,1<code>push</code>,1<code>pop</code>.,<code>pop</code>.</p>\n</blockquote>\n<p>5.<strong>: potential method</strong></p>\n<blockquote>\n<p>,,.., ,2)<br>\\begin{align}<br>D_0, c_ii \\\\<br>D_iD_{i-1}i \\\\<br>\\Phi: D_i \\mapsto \\Phi(D_i) \\\\<br> \\hat{c_i} = c_i + \\Phi(D_i) - \\Phi(D_{i-1}) \\\\<br> \\sum_{i=1}^n\\hat{c_i} = \\sum_{i=1}^n(c_i + \\Phi(D_i) - \\Phi(D_{i-1})) = \\sum_{i=1}^n c_i + \\Phi(D_n) - \\Phi(D_0)<br>\\end{align}</p>\n</blockquote>\n<blockquote>\n<p><code>stack</code>,<br>\\begin{align}<br>\\Phi stack \\\\<br>stack D_0, \\Phi(D_0) = 0 \\\\<br>push: \\\\<br>\\hat{c_i} = c_i + \\Phi(D_i) - \\Phi(D_{i-1}) = 1 + (s+1) - s = 2 \\\\<br>multipop: \\\\<br>\\hat{c_i} = c_i + \\Phi(D_i) - \\Phi(D_{i-1}) = k + (s -k) - s = 0 \\\\<br>\\therefore O(1) \\\\<br>\\therefore nO(n)<br>\\end{align}</p>\n</blockquote>"},{"title":"introduction to algorithms notes6","date":"2017-05-17T16:00:00.000Z","_content":"\n# Introduction to algorithms\n\n## Part7 \npart1-6, part7, ,,:\n* \n* \n* \n* \n\n### Chapter26 ?\npart2,,,,,.,,??,.\n\n:\n* , .part2\n* , .- \n\n1.\n* \n:\n![comparsion](/images/comparsion.png)\n\n<!-- more -->\n\n* \n* ,nn,.n $a\\_1,a\\_2, \\dots, a\\_n$ ,.,n $b\\_1,b\\_2, \\dots, b\\_n$,.\n> 1. .\n> 2. ,.\n\n,,.\n\n* :\n![sortnet](/images/sortnet.png)\n\n* :\n( $b\\_1 \\leq\n b\\_2, \\dots, b\\_n$ )\n\n* 0-1\nn,2^n01,,.\n0-1{0,1},,,().,01.,01,01,.\n0-1. $a=<a\\_1,a\\_2, \\dots, a\\_n>$  $b=<b\\_1,b\\_2, \\dots, b\\_n>$,f,f(a)=<f(a1),f(a2),,f(an)>f(b)=<f(b1),f(b2),,f(bn)>.\n,af(a),()ab,f(a)f(b).\n0-1,01,,01,.\nn2n01,,.\n0-1,.,,,0-1,.\n\n* \n,.<1,4,6,8,3,2><9,8,3,2,4,6>\n\n\n2.\n*  $log\\_2n$,.1,II+n/2,I=1,2,,n/2(n).88(half-cleaner)\n![half-cleaner](/images/half-cleaner.png)\n\n* 01,\n> 1. ,.\n> 2. .\n> 3. 01.\n\n* (bitonic-sorter)\n,.[n][n],[n].,[n/2],\n![bitonic-sorter](/images/bitonic-sorter.png)\n\nnMERGER[n].,,.,, $a\\_i$$a\\_{n-i+1}.,.,.\n*bitonic-sorter* $\\log n$ 0-1.\n![bitonic-sorter2](/images/bitonic-sorter2.png)\n\n3.(mergin network)\n,.,(),,.:\n![merger1](/images/merger1.png)\n![merger2](/images/merger2.png)\n\n4.0-1,.2,,2;2,(,),4;4, $\\log n$., $O(\\log n)$n.\n![sorter](/images/sorter.png)\n\n:,,.\n\n### Chapter27 \npart4, , Strasssen, $O(n^{\\log 7})$  $n*n$ .\n\n1.,.\n\nA\n, $A=(a\\_{ij})$,ij $a\\_ij$,mXn $R\\_{mXn}$.\n![matrix](/images/matrix.png)\n\nATA.\n\n(Vector),nX1,1Xn.\n\n$e\\_i$10.\n\n0.\n\nij,$a\\_ij$,0.\n\nnXn $I\\_n$1.\n\nT $|i-j|>1$  $t\\_ij$=0,.\n\nUi>j $U\\_ij=0$,0,1,.\n\nLi<j $L\\_ij=0$,0,1,.\n\nP1,0,x,x.\n\nA $A= A^T$.\n\n$C(c\\_ij)=A(a\\_ij)+B(b\\_ij),c\\_ij=a\\_ij+b\\_ij$,mXn.\n\n(AB),$C(c\\_ij)= \\sum\\_{k=1}^{m} A(a\\_ik)*B(b\\_kj)$,,,.\n\nA-1 $A A^{-1} = I\\_n= A^{-1}A$,.\n\n $x\\_1,x\\_2, \\dots, x\\_n$n, $c\\_1,c\\_2, \\dots, c\\_n$, $c\\_1x\\_1+c\\_2x\\_2+ \\dots +c\\_nx\\_n=0$, $x\\_1,x\\_2, \\dots, x\\_n$.\n\nmXnAA,A..mXn0min(m,n).\n\nmXnArmXrBrXnCA=BC.nXnn,,mXnn,.\n.A,A.\nA,A.\n\nn>1,nXnAijAij(n-1)X(n-1)A[ij],det(A[ij]).\n\nAA0,det(A)=0;aA(),aA;A()(),;AAT;(),.\n\nnXnA,nx0$x^TAx>0$,A.\n\nA,$A^TA$.\n\n2.Strassen\n.C = AB,AB n x n .,\n```\nSQUARE-MATRIX-MULTIPLY(A, B)\nn = A.rows\nlet C be a new nxn matrix\nfor i = 1 to n\n    for j = 1 to n\n        c[i][j] = 0\n        for k = 1 to n\n            c[i][j] += a[i][k] * b[k][j]\nreturn C\n```\n, $O(n^3)$.\nStrassennXn, $O(n^3)$ $O(n^{\\log 7}) = O(n^{2.81})$..\n\n> ,C=AB,ABCnXn,n2,ABCn/2Xn/2\n![matrix2](/images/matrix.png)\n\n```\nr=ae+bg\ns=af+bh\nt=ce+dg\nu=cf+dh\n```\n>  $n/2 * n/2$ $n/2 * n/2$, $n * n$ T(n)\n$$T(n)=8T(n/2)+  O(n^2)$$\n\nStrassen,7 $n/2 * n/2$,\n$$T(n)=7T(n/2)+O(n^2)= O(n^{\\log 7}) = O(n^{2.81})$$\n\n\n* 1.AB $n/2 * n/2$;\n* 2. $O(n^2)$,14 $n/2 * n/2$ $A\\_1,B\\_1,A\\_2,B\\_2, \\dots, A\\_7,B\\_7$;\n* 3.7 $P\\_i=A\\_i * B\\_i,i=1,2, \\dots, 7$;\n* 4. $O(n^2)$ , $P\\_i$ ,Cr\\s\\t\\u.\n\nStrassen\n $P\\_i$\n $$P\\_i=A\\_iB\\_i=(\\_{i1}a+\\_{i2}b+\\_{i3}c+\\_{i4}d)( \\_{i1}e+\\_{i2}f+\\_{i3}g+\\_{i4}h)$$\n {-1,0,1},,AB,.,,87.Strassen.\n\n.,().Strassen,.\n\n2.(LUP)\n,.,,R.\nnn\n![matrix3](/images/matrix.png)\n $A=(a\\_{ij}),x=(x\\_i),b=(b\\_i)$,Ax=b.\n\nA(n), $A^{-1}$, $x= A^{-1}b$,x.(An),,;,.\nLUP.**LUPn*nLUP,PA=LU,LUP.**\n\ny=Ux,x.($O(n^2)$)Ly=Pb,($O(n^2)$)Ux=y,\n\n$$Ax = P^{-1}LUx = P^{-1}Ly = P^{-1}Pb=b$$\n\nLUPLUPx.\n\nLU.AnXn,P$I\\_n$,A=LU,LUALU.LULUP,,,P1..LUP\n```\nlu-decomposition(A)\nn <- rows[A]\nfor k <- 1 to n\n    do u{kk} <- a{kk}\n        for i <- k + 1 to n\n            do l{ik} <- a{ik}/u{kk}\n                u{ki} <- a{ki}\n        for i <- k + 1 to n\n            do for j <- k + 1 to n\n                do a{ij} <- a{ij} - l{ik}u{kj}\nreturn L and U\n```\nLU:\n![lu](/images/lu.png)\n\n:LUP,.,,Strassen.\n\n### Chapter28 \n,..,,.\n1..\n> ,. $a\\_1,a\\_2, \\dots,a\\_n$ $x\\_1,x\\_2, \\dots,x\\_n$,f\n$$ f(x\\_1,x\\_2, \\dots,x\\_n) = a\\_1x\\_1 + a\\_2x\\_2 + \\dots + a\\_nx\\_n = \\sum\\_{j=1}^n a\\_jx\\_j$$\n> bf,\n> $f(x\\_1,x\\_2, \\dots,x\\_n) = b$ .\n> $f(x\\_1,x\\_2, \\dots,x\\_n) \\leq b$  $f(x\\_1,x\\_2, \\dots,x\\_n) \\geq b$ .\n> fb,nm,;.\n\n,.,,m,n,().\n\n2.\n.\n,(),.$x\\_1+x\\_2$,,.,,.,.\n,,,,.,.n,n,,,,.,,,.\n\n3.\n(nm),.,,,.,,.,.\n\n.,;,,.,,,,NP.NP,.,.\n\n:\n1./\n,.,,,.\n\nn $c\\_1,c\\_2, \\dots,c\\_n$;m $b\\_1,b\\_2, \\dots, b\\_m$;m * n $a\\_ij,i=1,2,\\dots, m,j=1,2, \\dots, n$ n$x\\_1,x\\_2, \\dots, x\\_n$\n$$ \\sum\\_{j=1}^n c\\_jx\\_j$$\nn + m, n:\n$$ \\sum\\_{j=1}^n a\\_{ij}x\\_j \\leq b\\_i, i = 1,2, \\dots, m\nx\\_j \\geq 0, j= 1, 2, \\dots, n$$\n\n$$c^Tx,Ax \\leq b,x \\geq 0$$\n\n $x\\_s$, $x\\_s$ .xs $c^Tx\\_s$, $x\\_s$, $c^Tx\\_s$.,,.,.\n,.,.;;;,.\n,,.,.\n\n,,,.,s,,\n$$: z = v + \\sum\\_{j=1}^n c\\_jx\\_j \\\\\\\\\n(: b\\_i - \\sum\\_{j=1}^n a\\_{ij}x\\_j = x\\_i$$\n,.\n\n2.\n,,,,..\n\n.\n\n> ,G=(V,E),w:E->Rst,std[t].,.Belleman-Ford,v,d[v], $(u,v) \\in E$, $d[v] \\leq d[u]+w(u,v)$.d[s]=0,st\nd[t]\n$d[v] \\leq d[u]+w(u,v)$, $(u,v) \\in E$d[s]=0\n|V|d[v],vV,|E|+1,d[s]=0.\n\n3.\n.,..,0,;;,;,,,0,,0,,.\n\n,:\n* 1.;\n* 2.;\n* 3..\n\n:\n```\npivot(N, B, A, b.c. v, l, e)\n#compute the conefficients of the equation ofr new basic variable x\nb{e} <- b{l}/a{le}\nfor each j in N - {e}\n    do a{ej} <- a{lj}/a{le}\na{el} <- 1/a{le}\n#compute the conefficients of the remaining constraints\nfor each i in B - {l}\n    do b{i} <- b{i} - a{ie}b{e}\n    for eahc j in N - {e}\n        do a{ij} <- a{ij} - a{ie}a{ej}\n    a{il} <- a{ie}a{el}\n#compute the objective function\nv <- v + c{e}b{e}\nfor each j in N - {e}\n    do c{j} <- c{j} - c{e}a{ej}\ncl{e} <- -c{e}a{el}\n#compute new ses of basic and nonbasic variables\nN = N - {e} union {l}\nB = B - {l} union {e}\nreturn (N, B, A, b, c, v)\n\n```\n:\n```\nsimple(A, b ,c)\n(N, B, A, b, c, v) <0 initialize-simple(A, b, c)\nwhile some index j in N has c{j} > 0\n    do choose an index e in N for which c{e} > 0\n        for each index i in B\n            do if a{ie} > 0\n                then delta{i} <- b{i}/a{ie}\n                else delta{i} <- INT\n            choose an index l in B that minimizes delta{i}\n            if delta{i} = INT\n                then return \"unbounded\"\n                else (N, B, A, b, c, v) <- pivot(N, B, A, b, c, v, l, e)\nfor i <- 1 to n\n    do if i in B\n        then x{i} <- b{i}\n        else x{i} <- 0\nreturn (x{1}, x{2}, ..., x{n})\n```\n,,(,,),(),.,,,.\n\n\n> ,,,;,,,();,,.\n,.,.,..\n\n1.\n\n\n3x1+x2+2x3\n\nx1+x2+3x330\n2x1+2x2+5x324\n4x1+x2+2x336\nx1,x2,x30\n\n\n\nz=3x1+x2+2x3\n\nx4=30-x1-x2-3x3\nx5=24-2x1-2x2-5x3\nx6=36-4x1-x2-2x3\n\n0,(x1,x2,x3,x4, x5, x6)=(0,0,0,30,24,36),z=0;\n\n2.,x1.x1,x4, x5, x6,,,().\nx130,x4;12,x5;9,x6;,9x1,,x6=36-4x1-x2-2x3x1x6,x1=9- x2/4- x3/2- x6/4,,\n\nz=27+x2/4+ x3/2- 3x6/4\n\nx1=9- x2/4- x3/2-x6/4\nx4=21-3x2/4-5x3/2+x6/4\nx5=6-3x2/2-4x3+x6/2\n,0,(x1,x2,x3,x4, x5, x6)=(9,0,0,21,6,0),z=27;\n\n3.,x3,x5=6-3x2/2-4x3+x6/2,3/2,x5,,x3x5,(x1,x2,x3, x4, x5,x6)=(33/4,0,3/2,69/4,0,0),z=111/4;\n,x2x4,(x1,x2,x3, x4, x5,x6)=(8,4,0,18,0,0),z=28,,(x1,x2,x3)=(8,4,0).\n,,.\n\n4. \n,\n* ,,;\n* ,.\n,,,,.\n\n****\nL\n;\n;\n;\n\nL,;L,,;,,.\n,,,..,,.,.L,,.\n\nL, $L\\_{aux}$n+1\n-x0\n\n$$ \\sum\\_{j-1}^{n} a\\_{ij}x\\_j - x\\_0 \\leq b\\_i, i = 1, 2, \\dots, m \\\\\\\\\nx\\_j \\geq 0, j = 0, 1, \\dots, n\n$$\n $L\\_{aux}$0,L.\n,x0,0.,,...\n\n****.,..,,..,,.\n\n,,,.,\n$$\n: \\sum\\_{i=1}^{m} b\\_iy\\_i \\\\\\\\\n: \\sum\\_{i=1}^{m} a\\_{ij}y\\_i \\geq c\\_j, j = 1,2, \\dots, n \\\\\\\\\ny\\_i \\geq 0, i = 1, 2, \\dots, m\n$$\n,,,.m,yi,n,xj.\n\n\n* ,;\n* ,mm,..\n\n### Chapter28 \n,,.:\n![string-match1](/images/string-match1.png)\n3,,Rabin-Karp,Knuth-Morris-PrattKMP.\n()\n* $O((n-m+1)m)$;\n* Rabin-Karp$O(m)$, $O((n-m+1)m)$,;\n* KMPO(m),O(n).\n,mP,nS,PS.\n\n.\n\n1.(native)\n```\nnavite-string-matcher(T, P)\nn <- length[T]\nm <- length[P]\nfor s <- 0 to n - m\n    do if p[1...m] = T[s+1...s+m]\n        then print \"Pattern occurs with shift\"\n```\n,T,()mP.PS,,PS.\n,,.P=abc,S=abdabc,0, 2,c != d,1, ,,1b0a.P,2,01,P,P10,S1P1,.,,.,,,,.\n\n2.Rabin-Karp\n```\nrabin-karp-matcher(T, P, d, q)\nn <- length[T]\nm <- length[P]\nj <- d^{m-1} mod q\np <- 0\nt{0} <- 0\nfor i <- 1 to m   #\n    do p <- (dp + p[i]) mod q\n        t{0} <- (dt{0} + T[i]) mod q\nfor s <- 0 to n - m  #\n    do if p = t{s}\n        then if P[1..m] = T[s+1...s+m]\n            then print \"Pattern occurs with shift\"s\n        if s <- n - m\n            then t{s+1} <- (d(t{s} - T[s+1]h) + T[s+m+1]) mod q\n```\n:\n![robin-karp](/images/robin-karp.png)\n\n,.,Pm, $O(m)$ ,.Sn-m+1P,$O(m)$ ;k,k+1,,,$O(1)$ ; $O(m)$.n-m+1, $O(n-m+1)$., $O((n-m+1)m)$ \n,,hash,hash,hash,.,hash,hash,,.,. $O((n-m+1)m)$, P, $O(n+ m)$.\n\n\n3.KMP\nKMP,.KMP,,,,,.,,.(,,),,,KMP,.,,.,O(||),O(m).,O(n)..\n,,,.\n```\nkmp-matcher(T,P)\nn <- length[T]\nm <- length[P]\n <- kmp-computer-prefix(P)\nq <- 0               // state , number of char matched\nfor i <- 1 to n\n    while q > 0 && P[q+1] != T[i]  // P and T range from 1 to n, not 0 to n-1\n        do q <- [q]\n        if P[q+1] = T[i]\n            then q <- q+1\n        if q = m\n            then print \"Pattern occurs with shift\" i-m\n                q <- [q]\n```\n,,.KMP,P(),,.,,q+1PqPq+1,Pq.\n```\nkmp-computer-prefix(P)\n\nm <- length[P]\n[1] <- 0\nk <- 0               // just like q above, number of char matched\nfor q <-  2 to m     // like i above, and actually it is state, so its name is q\n    while k>0 && P[k+1] != P[q]  // P range from 1 to n, not 0 to n-1\n        do k <- [k]\n        if P[k+1] = P[q]\n            then k <- k+1\n        [q] <- k\nreturn \n```\nkmp:\n![kmp1](/images/kmp1.png)\n![kmp2](/images/kmp2.png)\n","source":"_posts/CLRS-notes6.md","raw":"title: introduction to algorithms notes6\ntags:\n  - algorithm\n  - data_structure\ndate: 2017/05/18\n\n------\n\n# Introduction to algorithms\n\n## Part7 \npart1-6, part7, ,,:\n* \n* \n* \n* \n\n### Chapter26 ?\npart2,,,,,.,,??,.\n\n:\n* , .part2\n* , .- \n\n1.\n* \n:\n![comparsion](/images/comparsion.png)\n\n<!-- more -->\n\n* \n* ,nn,.n $a\\_1,a\\_2, \\dots, a\\_n$ ,.,n $b\\_1,b\\_2, \\dots, b\\_n$,.\n> 1. .\n> 2. ,.\n\n,,.\n\n* :\n![sortnet](/images/sortnet.png)\n\n* :\n( $b\\_1 \\leq\n b\\_2, \\dots, b\\_n$ )\n\n* 0-1\nn,2^n01,,.\n0-1{0,1},,,().,01.,01,01,.\n0-1. $a=<a\\_1,a\\_2, \\dots, a\\_n>$  $b=<b\\_1,b\\_2, \\dots, b\\_n>$,f,f(a)=<f(a1),f(a2),,f(an)>f(b)=<f(b1),f(b2),,f(bn)>.\n,af(a),()ab,f(a)f(b).\n0-1,01,,01,.\nn2n01,,.\n0-1,.,,,0-1,.\n\n* \n,.<1,4,6,8,3,2><9,8,3,2,4,6>\n\n\n2.\n*  $log\\_2n$,.1,II+n/2,I=1,2,,n/2(n).88(half-cleaner)\n![half-cleaner](/images/half-cleaner.png)\n\n* 01,\n> 1. ,.\n> 2. .\n> 3. 01.\n\n* (bitonic-sorter)\n,.[n][n],[n].,[n/2],\n![bitonic-sorter](/images/bitonic-sorter.png)\n\nnMERGER[n].,,.,, $a\\_i$$a\\_{n-i+1}.,.,.\n*bitonic-sorter* $\\log n$ 0-1.\n![bitonic-sorter2](/images/bitonic-sorter2.png)\n\n3.(mergin network)\n,.,(),,.:\n![merger1](/images/merger1.png)\n![merger2](/images/merger2.png)\n\n4.0-1,.2,,2;2,(,),4;4, $\\log n$., $O(\\log n)$n.\n![sorter](/images/sorter.png)\n\n:,,.\n\n### Chapter27 \npart4, , Strasssen, $O(n^{\\log 7})$  $n*n$ .\n\n1.,.\n\nA\n, $A=(a\\_{ij})$,ij $a\\_ij$,mXn $R\\_{mXn}$.\n![matrix](/images/matrix.png)\n\nATA.\n\n(Vector),nX1,1Xn.\n\n$e\\_i$10.\n\n0.\n\nij,$a\\_ij$,0.\n\nnXn $I\\_n$1.\n\nT $|i-j|>1$  $t\\_ij$=0,.\n\nUi>j $U\\_ij=0$,0,1,.\n\nLi<j $L\\_ij=0$,0,1,.\n\nP1,0,x,x.\n\nA $A= A^T$.\n\n$C(c\\_ij)=A(a\\_ij)+B(b\\_ij),c\\_ij=a\\_ij+b\\_ij$,mXn.\n\n(AB),$C(c\\_ij)= \\sum\\_{k=1}^{m} A(a\\_ik)*B(b\\_kj)$,,,.\n\nA-1 $A A^{-1} = I\\_n= A^{-1}A$,.\n\n $x\\_1,x\\_2, \\dots, x\\_n$n, $c\\_1,c\\_2, \\dots, c\\_n$, $c\\_1x\\_1+c\\_2x\\_2+ \\dots +c\\_nx\\_n=0$, $x\\_1,x\\_2, \\dots, x\\_n$.\n\nmXnAA,A..mXn0min(m,n).\n\nmXnArmXrBrXnCA=BC.nXnn,,mXnn,.\n.A,A.\nA,A.\n\nn>1,nXnAijAij(n-1)X(n-1)A[ij],det(A[ij]).\n\nAA0,det(A)=0;aA(),aA;A()(),;AAT;(),.\n\nnXnA,nx0$x^TAx>0$,A.\n\nA,$A^TA$.\n\n2.Strassen\n.C = AB,AB n x n .,\n```\nSQUARE-MATRIX-MULTIPLY(A, B)\nn = A.rows\nlet C be a new nxn matrix\nfor i = 1 to n\n    for j = 1 to n\n        c[i][j] = 0\n        for k = 1 to n\n            c[i][j] += a[i][k] * b[k][j]\nreturn C\n```\n, $O(n^3)$.\nStrassennXn, $O(n^3)$ $O(n^{\\log 7}) = O(n^{2.81})$..\n\n> ,C=AB,ABCnXn,n2,ABCn/2Xn/2\n![matrix2](/images/matrix.png)\n\n```\nr=ae+bg\ns=af+bh\nt=ce+dg\nu=cf+dh\n```\n>  $n/2 * n/2$ $n/2 * n/2$, $n * n$ T(n)\n$$T(n)=8T(n/2)+  O(n^2)$$\n\nStrassen,7 $n/2 * n/2$,\n$$T(n)=7T(n/2)+O(n^2)= O(n^{\\log 7}) = O(n^{2.81})$$\n\n\n* 1.AB $n/2 * n/2$;\n* 2. $O(n^2)$,14 $n/2 * n/2$ $A\\_1,B\\_1,A\\_2,B\\_2, \\dots, A\\_7,B\\_7$;\n* 3.7 $P\\_i=A\\_i * B\\_i,i=1,2, \\dots, 7$;\n* 4. $O(n^2)$ , $P\\_i$ ,Cr\\s\\t\\u.\n\nStrassen\n $P\\_i$\n $$P\\_i=A\\_iB\\_i=(\\_{i1}a+\\_{i2}b+\\_{i3}c+\\_{i4}d)( \\_{i1}e+\\_{i2}f+\\_{i3}g+\\_{i4}h)$$\n {-1,0,1},,AB,.,,87.Strassen.\n\n.,().Strassen,.\n\n2.(LUP)\n,.,,R.\nnn\n![matrix3](/images/matrix.png)\n $A=(a\\_{ij}),x=(x\\_i),b=(b\\_i)$,Ax=b.\n\nA(n), $A^{-1}$, $x= A^{-1}b$,x.(An),,;,.\nLUP.**LUPn*nLUP,PA=LU,LUP.**\n\ny=Ux,x.($O(n^2)$)Ly=Pb,($O(n^2)$)Ux=y,\n\n$$Ax = P^{-1}LUx = P^{-1}Ly = P^{-1}Pb=b$$\n\nLUPLUPx.\n\nLU.AnXn,P$I\\_n$,A=LU,LUALU.LULUP,,,P1..LUP\n```\nlu-decomposition(A)\nn <- rows[A]\nfor k <- 1 to n\n    do u{kk} <- a{kk}\n        for i <- k + 1 to n\n            do l{ik} <- a{ik}/u{kk}\n                u{ki} <- a{ki}\n        for i <- k + 1 to n\n            do for j <- k + 1 to n\n                do a{ij} <- a{ij} - l{ik}u{kj}\nreturn L and U\n```\nLU:\n![lu](/images/lu.png)\n\n:LUP,.,,Strassen.\n\n### Chapter28 \n,..,,.\n1..\n> ,. $a\\_1,a\\_2, \\dots,a\\_n$ $x\\_1,x\\_2, \\dots,x\\_n$,f\n$$ f(x\\_1,x\\_2, \\dots,x\\_n) = a\\_1x\\_1 + a\\_2x\\_2 + \\dots + a\\_nx\\_n = \\sum\\_{j=1}^n a\\_jx\\_j$$\n> bf,\n> $f(x\\_1,x\\_2, \\dots,x\\_n) = b$ .\n> $f(x\\_1,x\\_2, \\dots,x\\_n) \\leq b$  $f(x\\_1,x\\_2, \\dots,x\\_n) \\geq b$ .\n> fb,nm,;.\n\n,.,,m,n,().\n\n2.\n.\n,(),.$x\\_1+x\\_2$,,.,,.,.\n,,,,.,.n,n,,,,.,,,.\n\n3.\n(nm),.,,,.,,.,.\n\n.,;,,.,,,,NP.NP,.,.\n\n:\n1./\n,.,,,.\n\nn $c\\_1,c\\_2, \\dots,c\\_n$;m $b\\_1,b\\_2, \\dots, b\\_m$;m * n $a\\_ij,i=1,2,\\dots, m,j=1,2, \\dots, n$ n$x\\_1,x\\_2, \\dots, x\\_n$\n$$ \\sum\\_{j=1}^n c\\_jx\\_j$$\nn + m, n:\n$$ \\sum\\_{j=1}^n a\\_{ij}x\\_j \\leq b\\_i, i = 1,2, \\dots, m\nx\\_j \\geq 0, j= 1, 2, \\dots, n$$\n\n$$c^Tx,Ax \\leq b,x \\geq 0$$\n\n $x\\_s$, $x\\_s$ .xs $c^Tx\\_s$, $x\\_s$, $c^Tx\\_s$.,,.,.\n,.,.;;;,.\n,,.,.\n\n,,,.,s,,\n$$: z = v + \\sum\\_{j=1}^n c\\_jx\\_j \\\\\\\\\n(: b\\_i - \\sum\\_{j=1}^n a\\_{ij}x\\_j = x\\_i$$\n,.\n\n2.\n,,,,..\n\n.\n\n> ,G=(V,E),w:E->Rst,std[t].,.Belleman-Ford,v,d[v], $(u,v) \\in E$, $d[v] \\leq d[u]+w(u,v)$.d[s]=0,st\nd[t]\n$d[v] \\leq d[u]+w(u,v)$, $(u,v) \\in E$d[s]=0\n|V|d[v],vV,|E|+1,d[s]=0.\n\n3.\n.,..,0,;;,;,,,0,,0,,.\n\n,:\n* 1.;\n* 2.;\n* 3..\n\n:\n```\npivot(N, B, A, b.c. v, l, e)\n#compute the conefficients of the equation ofr new basic variable x\nb{e} <- b{l}/a{le}\nfor each j in N - {e}\n    do a{ej} <- a{lj}/a{le}\na{el} <- 1/a{le}\n#compute the conefficients of the remaining constraints\nfor each i in B - {l}\n    do b{i} <- b{i} - a{ie}b{e}\n    for eahc j in N - {e}\n        do a{ij} <- a{ij} - a{ie}a{ej}\n    a{il} <- a{ie}a{el}\n#compute the objective function\nv <- v + c{e}b{e}\nfor each j in N - {e}\n    do c{j} <- c{j} - c{e}a{ej}\ncl{e} <- -c{e}a{el}\n#compute new ses of basic and nonbasic variables\nN = N - {e} union {l}\nB = B - {l} union {e}\nreturn (N, B, A, b, c, v)\n\n```\n:\n```\nsimple(A, b ,c)\n(N, B, A, b, c, v) <0 initialize-simple(A, b, c)\nwhile some index j in N has c{j} > 0\n    do choose an index e in N for which c{e} > 0\n        for each index i in B\n            do if a{ie} > 0\n                then delta{i} <- b{i}/a{ie}\n                else delta{i} <- INT\n            choose an index l in B that minimizes delta{i}\n            if delta{i} = INT\n                then return \"unbounded\"\n                else (N, B, A, b, c, v) <- pivot(N, B, A, b, c, v, l, e)\nfor i <- 1 to n\n    do if i in B\n        then x{i} <- b{i}\n        else x{i} <- 0\nreturn (x{1}, x{2}, ..., x{n})\n```\n,,(,,),(),.,,,.\n\n\n> ,,,;,,,();,,.\n,.,.,..\n\n1.\n\n\n3x1+x2+2x3\n\nx1+x2+3x330\n2x1+2x2+5x324\n4x1+x2+2x336\nx1,x2,x30\n\n\n\nz=3x1+x2+2x3\n\nx4=30-x1-x2-3x3\nx5=24-2x1-2x2-5x3\nx6=36-4x1-x2-2x3\n\n0,(x1,x2,x3,x4, x5, x6)=(0,0,0,30,24,36),z=0;\n\n2.,x1.x1,x4, x5, x6,,,().\nx130,x4;12,x5;9,x6;,9x1,,x6=36-4x1-x2-2x3x1x6,x1=9- x2/4- x3/2- x6/4,,\n\nz=27+x2/4+ x3/2- 3x6/4\n\nx1=9- x2/4- x3/2-x6/4\nx4=21-3x2/4-5x3/2+x6/4\nx5=6-3x2/2-4x3+x6/2\n,0,(x1,x2,x3,x4, x5, x6)=(9,0,0,21,6,0),z=27;\n\n3.,x3,x5=6-3x2/2-4x3+x6/2,3/2,x5,,x3x5,(x1,x2,x3, x4, x5,x6)=(33/4,0,3/2,69/4,0,0),z=111/4;\n,x2x4,(x1,x2,x3, x4, x5,x6)=(8,4,0,18,0,0),z=28,,(x1,x2,x3)=(8,4,0).\n,,.\n\n4. \n,\n* ,,;\n* ,.\n,,,,.\n\n****\nL\n;\n;\n;\n\nL,;L,,;,,.\n,,,..,,.,.L,,.\n\nL, $L\\_{aux}$n+1\n-x0\n\n$$ \\sum\\_{j-1}^{n} a\\_{ij}x\\_j - x\\_0 \\leq b\\_i, i = 1, 2, \\dots, m \\\\\\\\\nx\\_j \\geq 0, j = 0, 1, \\dots, n\n$$\n $L\\_{aux}$0,L.\n,x0,0.,,...\n\n****.,..,,..,,.\n\n,,,.,\n$$\n: \\sum\\_{i=1}^{m} b\\_iy\\_i \\\\\\\\\n: \\sum\\_{i=1}^{m} a\\_{ij}y\\_i \\geq c\\_j, j = 1,2, \\dots, n \\\\\\\\\ny\\_i \\geq 0, i = 1, 2, \\dots, m\n$$\n,,,.m,yi,n,xj.\n\n\n* ,;\n* ,mm,..\n\n### Chapter28 \n,,.:\n![string-match1](/images/string-match1.png)\n3,,Rabin-Karp,Knuth-Morris-PrattKMP.\n()\n* $O((n-m+1)m)$;\n* Rabin-Karp$O(m)$, $O((n-m+1)m)$,;\n* KMPO(m),O(n).\n,mP,nS,PS.\n\n.\n\n1.(native)\n```\nnavite-string-matcher(T, P)\nn <- length[T]\nm <- length[P]\nfor s <- 0 to n - m\n    do if p[1...m] = T[s+1...s+m]\n        then print \"Pattern occurs with shift\"\n```\n,T,()mP.PS,,PS.\n,,.P=abc,S=abdabc,0, 2,c != d,1, ,,1b0a.P,2,01,P,P10,S1P1,.,,.,,,,.\n\n2.Rabin-Karp\n```\nrabin-karp-matcher(T, P, d, q)\nn <- length[T]\nm <- length[P]\nj <- d^{m-1} mod q\np <- 0\nt{0} <- 0\nfor i <- 1 to m   #\n    do p <- (dp + p[i]) mod q\n        t{0} <- (dt{0} + T[i]) mod q\nfor s <- 0 to n - m  #\n    do if p = t{s}\n        then if P[1..m] = T[s+1...s+m]\n            then print \"Pattern occurs with shift\"s\n        if s <- n - m\n            then t{s+1} <- (d(t{s} - T[s+1]h) + T[s+m+1]) mod q\n```\n:\n![robin-karp](/images/robin-karp.png)\n\n,.,Pm, $O(m)$ ,.Sn-m+1P,$O(m)$ ;k,k+1,,,$O(1)$ ; $O(m)$.n-m+1, $O(n-m+1)$., $O((n-m+1)m)$ \n,,hash,hash,hash,.,hash,hash,,.,. $O((n-m+1)m)$, P, $O(n+ m)$.\n\n\n3.KMP\nKMP,.KMP,,,,,.,,.(,,),,,KMP,.,,.,O(||),O(m).,O(n)..\n,,,.\n```\nkmp-matcher(T,P)\nn <- length[T]\nm <- length[P]\n <- kmp-computer-prefix(P)\nq <- 0               // state , number of char matched\nfor i <- 1 to n\n    while q > 0 && P[q+1] != T[i]  // P and T range from 1 to n, not 0 to n-1\n        do q <- [q]\n        if P[q+1] = T[i]\n            then q <- q+1\n        if q = m\n            then print \"Pattern occurs with shift\" i-m\n                q <- [q]\n```\n,,.KMP,P(),,.,,q+1PqPq+1,Pq.\n```\nkmp-computer-prefix(P)\n\nm <- length[P]\n[1] <- 0\nk <- 0               // just like q above, number of char matched\nfor q <-  2 to m     // like i above, and actually it is state, so its name is q\n    while k>0 && P[k+1] != P[q]  // P range from 1 to n, not 0 to n-1\n        do k <- [k]\n        if P[k+1] = P[q]\n            then k <- k+1\n        [q] <- k\nreturn \n```\nkmp:\n![kmp1](/images/kmp1.png)\n![kmp2](/images/kmp2.png)\n","slug":"CLRS-notes6","published":1,"updated":"2017-08-26T03:38:21.614Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3gr000ds7amv35zy1ii","content":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h2 id=\"Part7-\"><a href=\"#Part7-\" class=\"headerlink\" title=\"Part7 \"></a>Part7 </h2><p>part1-6, part7, ,,:</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<h3 id=\"Chapter26-\"><a href=\"#Chapter26-\" class=\"headerlink\" title=\"Chapter26 ?\"></a>Chapter26 ?</h3><p>part2,,,,,.,,??,.</p>\n<p>:</p>\n<ul>\n<li>, .part2</li>\n<li>, .- </li>\n</ul>\n<p>1.</p>\n<ul>\n<li><br>:<br><img src=\"/images/comparsion.png\" alt=\"comparsion\"></li>\n</ul>\n<a id=\"more\"></a>\n<ul>\n<li></li>\n<li>,nn,.n $a_1,a_2, \\dots, a_n$ ,.,n $b_1,b_2, \\dots, b_n$,.<blockquote>\n<ol>\n<li>.</li>\n<li>,.</li>\n</ol>\n</blockquote>\n</li>\n</ul>\n<p>,,.</p>\n<ul>\n<li><p>:<br><img src=\"/images/sortnet.png\" alt=\"sortnet\"></p>\n</li>\n<li><p>:<br>( $b_1 \\leq<br>b_2, \\dots, b_n$ )</p>\n</li>\n<li><p>0-1<br>n,2^n01,,.<br>0-1{0,1},,,().,01.,01,01,.<br>0-1. $a=&lt;a_1,a_2, \\dots, a_n&gt;$  $b=&lt;b_1,b_2, \\dots, b_n&gt;$,f,f(a)=&lt;f(a1),f(a2),,f(an)&gt;f(b)=&lt;f(b1),f(b2),,f(bn)&gt;.<br>,af(a),()ab,f(a)f(b).<br>0-1,01,,01,.<br>n2n01,,.<br>0-1,.,,,0-1,.</p>\n</li>\n<li><p><br>,.&lt;1,4,6,8,3,2&gt;&lt;9,8,3,2,4,6&gt;</p>\n</li>\n</ul>\n<p>2.</p>\n<ul>\n<li><p> $log_2n$,.1,II+n/2,I=1,2,,n/2(n).88(half-cleaner)<br><img src=\"/images/half-cleaner.png\" alt=\"half-cleaner\"></p>\n</li>\n<li><p>01,</p>\n<blockquote>\n<ol>\n<li>,.</li>\n<li>.</li>\n<li>01.</li>\n</ol>\n</blockquote>\n</li>\n<li><p>(bitonic-sorter)<br>,.[n][n],[n].,[n/2],<br><img src=\"/images/bitonic-sorter.png\" alt=\"bitonic-sorter\"></p>\n</li>\n</ul>\n<p>nMERGER[n].,,.,, $a_i$$a_{n-i+1}.,.,.<br><em>bitonic-sorter</em> $\\log n$ 0-1.<br><img src=\"/images/bitonic-sorter2.png\" alt=\"bitonic-sorter2\"></p>\n<p>3.(mergin network)<br>,.,(),,.:<br><img src=\"/images/merger1.png\" alt=\"merger1\"><br><img src=\"/images/merger2.png\" alt=\"merger2\"></p>\n<p>4.0-1,.2,,2;2,(,),4;4, $\\log n$., $O(\\log n)$n.<br><img src=\"/images/sorter.png\" alt=\"sorter\"></p>\n<p>:,,.</p>\n<h3 id=\"Chapter27-\"><a href=\"#Chapter27-\" class=\"headerlink\" title=\"Chapter27 \"></a>Chapter27 </h3><p>part4, , Strasssen, $O(n^{\\log 7})$  $n*n$ .</p>\n<p>1.,.</p>\n<p>A<br>, $A=(a_{ij})$,ij $a_ij$,mXn $R_{mXn}$.<br><img src=\"/images/matrix.png\" alt=\"matrix\"></p>\n<p>ATA.</p>\n<p>(Vector),nX1,1Xn.</p>\n<p>$e_i$10.</p>\n<p>0.</p>\n<p>ij,$a_ij$,0.</p>\n<p>nXn $I_n$1.</p>\n<p>T $|i-j|&gt;1$  $t_ij$=0,.</p>\n<p>Ui&gt;j $U_ij=0$,0,1,.</p>\n<p>Li&lt;j $L_ij=0$,0,1,.</p>\n<p>P1,0,x,x.</p>\n<p>A $A= A^T$.</p>\n<p>$C(c_ij)=A(a_ij)+B(b_ij),c_ij=a_ij+b_ij$,mXn.</p>\n<p>(AB),$C(c_ij)= \\sum_{k=1}^{m} A(a_ik)*B(b_kj)$,,,.</p>\n<p>A-1 $A A^{-1} = I_n= A^{-1}A$,.</p>\n<p> $x_1,x_2, \\dots, x_n$n, $c_1,c_2, \\dots, c_n$, $c_1x_1+c_2x_2+ \\dots +c_nx_n=0$, $x_1,x_2, \\dots, x_n$.</p>\n<p>mXnAA,A..mXn0min(m,n).</p>\n<p>mXnArmXrBrXnCA=BC.nXnn,,mXnn,.<br>.A,A.<br>A,A.</p>\n<p>n&gt;1,nXnAijAij(n-1)X(n-1)A[ij],det(A[ij]).</p>\n<p>AA0,det(A)=0;aA(),aA;A()(),;AAT;(),.</p>\n<p>nXnA,nx0$x^TAx&gt;0$,A.</p>\n<p>A,$A^TA$.</p>\n<p>2.Strassen<br>.C = AB,AB n x n .,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SQUARE-MATRIX-MULTIPLY(A, B)</span><br><span class=\"line\">n = A.rows</span><br><span class=\"line\">let C be a new nxn matrix</span><br><span class=\"line\">for i = 1 to n</span><br><span class=\"line\">    for j = 1 to n</span><br><span class=\"line\">        c[i][j] = 0</span><br><span class=\"line\">        for k = 1 to n</span><br><span class=\"line\">            c[i][j] += a[i][k] * b[k][j]</span><br><span class=\"line\">return C</span><br></pre></td></tr></table></figure></p>\n<p>, $O(n^3)$.<br>StrassennXn, $O(n^3)$ $O(n^{\\log 7}) = O(n^{2.81})$..</p>\n<blockquote>\n<p>,C=AB,ABCnXn,n2,ABCn/2Xn/2<br><img src=\"/images/matrix.png\" alt=\"matrix2\"><br><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">r=ae+bg</span><br><span class=\"line\">s=af+bh</span><br><span class=\"line\">t=ce+dg</span><br><span class=\"line\">u=cf+dh</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p> $n/2 <em> n/2$ $n/2 </em> n/2$, $n * n$ T(n)<br>$$T(n)=8T(n/2)+  O(n^2)$$</p>\n</blockquote>\n<p>Strassen,7 $n/2 * n/2$,<br>$$T(n)=7T(n/2)+O(n^2)= O(n^{\\log 7}) = O(n^{2.81})$$<br></p>\n<ul>\n<li>1.AB $n/2 * n/2$;</li>\n<li>2. $O(n^2)$,14 $n/2 * n/2$ $A_1,B_1,A_2,B_2, \\dots, A_7,B_7$;</li>\n<li>3.7 $P_i=A_i * B_i,i=1,2, \\dots, 7$;</li>\n<li>4. $O(n^2)$ , $P_i$ ,Cr\\s\\t\\u.</li>\n</ul>\n<p>Strassen<br> $P_i$<br> $$P_i=A_iB_i=(_{i1}a+_{i2}b+_{i3}c+_{i4}d)( _{i1}e+_{i2}f+_{i3}g+_{i4}h)$$<br> {-1,0,1},,AB,.,,87.Strassen.</p>\n<p>.,().Strassen,.</p>\n<p>2.(LUP)<br>,.,,R.<br>nn<br><img src=\"/images/matrix.png\" alt=\"matrix3\"><br> $A=(a_{ij}),x=(x_i),b=(b_i)$,Ax=b.</p>\n<p>A(n), $A^{-1}$, $x= A^{-1}b$,x.(An),,;,.<br>LUP.<strong>LUPn*nLUP,PA=LU,LUP.</strong></p>\n<p>y=Ux,x.($O(n^2)$)Ly=Pb,($O(n^2)$)Ux=y,</p>\n<p>$$Ax = P^{-1}LUx = P^{-1}Ly = P^{-1}Pb=b$$</p>\n<p>LUPLUPx.</p>\n<p>LU.AnXn,P$I_n$,A=LU,LUALU.LULUP,,,P1..LUP<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lu-decomposition(A)</span><br><span class=\"line\">n &lt;- rows[A]</span><br><span class=\"line\">for k &lt;- 1 to n</span><br><span class=\"line\">    do u&#123;kk&#125; &lt;- a&#123;kk&#125;</span><br><span class=\"line\">        for i &lt;- k + 1 to n</span><br><span class=\"line\">            do l&#123;ik&#125; &lt;- a&#123;ik&#125;/u&#123;kk&#125;</span><br><span class=\"line\">                u&#123;ki&#125; &lt;- a&#123;ki&#125;</span><br><span class=\"line\">        for i &lt;- k + 1 to n</span><br><span class=\"line\">            do for j &lt;- k + 1 to n</span><br><span class=\"line\">                do a&#123;ij&#125; &lt;- a&#123;ij&#125; - l&#123;ik&#125;u&#123;kj&#125;</span><br><span class=\"line\">return L and U</span><br></pre></td></tr></table></figure></p>\n<p>LU:<br><img src=\"/images/lu.png\" alt=\"lu\"></p>\n<p>:LUP,.,,Strassen.</p>\n<h3 id=\"Chapter28-\"><a href=\"#Chapter28-\" class=\"headerlink\" title=\"Chapter28 \"></a>Chapter28 </h3><p>,..,,.<br>1..</p>\n<blockquote>\n<p>,. $a_1,a_2, \\dots,a_n$ $x_1,x_2, \\dots,x_n$,f<br>$$ f(x_1,x_2, \\dots,x_n) = a_1x_1 + a_2x_2 + \\dots + a_nx_n = \\sum_{j=1}^n a_jx_j$$<br>bf,<br>$f(x_1,x_2, \\dots,x_n) = b$ .<br>$f(x_1,x_2, \\dots,x_n) \\leq b$  $f(x_1,x_2, \\dots,x_n) \\geq b$ .<br>fb,nm,;.</p>\n</blockquote>\n<p>,.,,m,n,().</p>\n<p>2.<br>.<br>,(),.$x_1+x_2$,,.,,.,.<br>,,,,.,.n,n,,,,.,,,.</p>\n<p>3.<br>(nm),.,,,.,,.,.</p>\n<p>.,;,,.,,,,NP.NP,.,.</p>\n<p>:<br>1./<br>,.,,,.<br><br>n $c_1,c_2, \\dots,c_n$;m $b_1,b_2, \\dots, b_m$;m * n $a_ij,i=1,2,\\dots, m,j=1,2, \\dots, n$ n$x_1,x_2, \\dots, x_n$<br>$$ \\sum_{j=1}^n c_jx_j$$<br>n + m, n:<br>$$ \\sum_{j=1}^n a_{ij}x_j \\leq b_i, i = 1,2, \\dots, m<br>x_j \\geq 0, j= 1, 2, \\dots, n$$<br><br>$$c^Tx,Ax \\leq b,x \\geq 0$$</p>\n<p> $x_s$, $x_s$ .xs $c^Tx_s$, $x_s$, $c^Tx_s$.,,.,.<br>,.,.;;;,.<br>,,.,.</p>\n<p>,,,.,s,,<br>$$: z = v + \\sum_{j=1}^n c_jx_j \\\\<br>(: b_i - \\sum_{j=1}^n a_{ij}x_j = x_i$$<br>,.</p>\n<p>2.<br>,,,,..</p>\n<p>.</p>\n<blockquote>\n<p>,G=(V,E),w:E-&gt;Rst,std[t].,.Belleman-Ford,v,d[v], $(u,v) \\in E$, $d[v] \\leq d[u]+w(u,v)$.d[s]=0,st<br>d[t]<br>$d[v] \\leq d[u]+w(u,v)$, $(u,v) \\in E$d[s]=0<br>|V|d[v],vV,|E|+1,d[s]=0.</p>\n</blockquote>\n<p>3.<br>.,..,0,;;,;,,,0,,0,,.</p>\n<p>,:</p>\n<ul>\n<li>1.;</li>\n<li>2.;</li>\n<li>3..</li>\n</ul>\n<p>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pivot(N, B, A, b.c. v, l, e)</span><br><span class=\"line\">#compute the conefficients of the equation ofr new basic variable x</span><br><span class=\"line\">b&#123;e&#125; &lt;- b&#123;l&#125;/a&#123;le&#125;</span><br><span class=\"line\">for each j in N - &#123;e&#125;</span><br><span class=\"line\">    do a&#123;ej&#125; &lt;- a&#123;lj&#125;/a&#123;le&#125;</span><br><span class=\"line\">a&#123;el&#125; &lt;- 1/a&#123;le&#125;</span><br><span class=\"line\">#compute the conefficients of the remaining constraints</span><br><span class=\"line\">for each i in B - &#123;l&#125;</span><br><span class=\"line\">    do b&#123;i&#125; &lt;- b&#123;i&#125; - a&#123;ie&#125;b&#123;e&#125;</span><br><span class=\"line\">    for eahc j in N - &#123;e&#125;</span><br><span class=\"line\">        do a&#123;ij&#125; &lt;- a&#123;ij&#125; - a&#123;ie&#125;a&#123;ej&#125;</span><br><span class=\"line\">    a&#123;il&#125; &lt;- a&#123;ie&#125;a&#123;el&#125;</span><br><span class=\"line\">#compute the objective function</span><br><span class=\"line\">v &lt;- v + c&#123;e&#125;b&#123;e&#125;</span><br><span class=\"line\">for each j in N - &#123;e&#125;</span><br><span class=\"line\">    do c&#123;j&#125; &lt;- c&#123;j&#125; - c&#123;e&#125;a&#123;ej&#125;</span><br><span class=\"line\">cl&#123;e&#125; &lt;- -c&#123;e&#125;a&#123;el&#125;</span><br><span class=\"line\">#compute new ses of basic and nonbasic variables</span><br><span class=\"line\">N = N - &#123;e&#125; union &#123;l&#125;</span><br><span class=\"line\">B = B - &#123;l&#125; union &#123;e&#125;</span><br><span class=\"line\">return (N, B, A, b, c, v)</span><br></pre></td></tr></table></figure></p>\n<p>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">simple(A, b ,c)</span><br><span class=\"line\">(N, B, A, b, c, v) &lt;0 initialize-simple(A, b, c)</span><br><span class=\"line\">while some index j in N has c&#123;j&#125; &gt; 0</span><br><span class=\"line\">    do choose an index e in N for which c&#123;e&#125; &gt; 0</span><br><span class=\"line\">        for each index i in B</span><br><span class=\"line\">            do if a&#123;ie&#125; &gt; 0</span><br><span class=\"line\">                then delta&#123;i&#125; &lt;- b&#123;i&#125;/a&#123;ie&#125;</span><br><span class=\"line\">                else delta&#123;i&#125; &lt;- INT</span><br><span class=\"line\">            choose an index l in B that minimizes delta&#123;i&#125;</span><br><span class=\"line\">            if delta&#123;i&#125; = INT</span><br><span class=\"line\">                then return &quot;unbounded&quot;</span><br><span class=\"line\">                else (N, B, A, b, c, v) &lt;- pivot(N, B, A, b, c, v, l, e)</span><br><span class=\"line\">for i &lt;- 1 to n</span><br><span class=\"line\">    do if i in B</span><br><span class=\"line\">        then x&#123;i&#125; &lt;- b&#123;i&#125;</span><br><span class=\"line\">        else x&#123;i&#125; &lt;- 0</span><br><span class=\"line\">return (x&#123;1&#125;, x&#123;2&#125;, ..., x&#123;n&#125;)</span><br></pre></td></tr></table></figure></p>\n<p>,,(,,),(),.,,,.</p>\n<p></p>\n<blockquote>\n<p>,,,;,,,();,,.<br>,.,.,..</p>\n</blockquote>\n<p>1.<br><br><br>3x1+x2+2x3<br><br>x1+x2+3x330<br>2x1+2x2+5x324<br>4x1+x2+2x336<br>x1,x2,x30</p>\n<p><br><br>z=3x1+x2+2x3<br><br>x4=30-x1-x2-3x3<br>x5=24-2x1-2x2-5x3<br>x6=36-4x1-x2-2x3</p>\n<p>0,(x1,x2,x3,x4, x5, x6)=(0,0,0,30,24,36),z=0;</p>\n<p>2.,x1.x1,x4, x5, x6,,,().<br>x130,x4;12,x5;9,x6;,9x1,,x6=36-4x1-x2-2x3x1x6,x1=9- x2/4- x3/2- x6/4,,<br><br>z=27+x2/4+ x3/2- 3x6/4<br><br>x1=9- x2/4- x3/2-x6/4<br>x4=21-3x2/4-5x3/2+x6/4<br>x5=6-3x2/2-4x3+x6/2<br>,0,(x1,x2,x3,x4, x5, x6)=(9,0,0,21,6,0),z=27;</p>\n<p>3.,x3,x5=6-3x2/2-4x3+x6/2,3/2,x5,,x3x5,(x1,x2,x3, x4, x5,x6)=(33/4,0,3/2,69/4,0,0),z=111/4;<br>,x2x4,(x1,x2,x3, x4, x5,x6)=(8,4,0,18,0,0),z=28,,(x1,x2,x3)=(8,4,0).<br>,,.</p>\n<ol start=\"4\">\n<li><br>,</li>\n</ol>\n<ul>\n<li>,,;</li>\n<li>,.<br>,,,,.</li>\n</ul>\n<p><strong></strong><br>L<br>;<br>;<br>;</p>\n<p>L,;L,,;,,.<br>,,,..,,.,.L,,.</p>\n<p>L, $L_{aux}$n+1<br>-x0<br><br>$$ \\sum_{j-1}^{n} a_{ij}x_j - x_0 \\leq b_i, i = 1, 2, \\dots, m \\\\<br>x_j \\geq 0, j = 0, 1, \\dots, n<br>$$<br> $L_{aux}$0,L.<br>,x0,0.,,...</p>\n<p><strong></strong>.,..,,..,,.</p>\n<p>,,,.,<br>$$<br>: \\sum_{i=1}^{m} b_iy_i \\\\<br>: \\sum_{i=1}^{m} a_{ij}y_i \\geq c_j, j = 1,2, \\dots, n \\\\<br>y_i \\geq 0, i = 1, 2, \\dots, m<br>$$<br>,,,.m,yi,n,xj.</p>\n<p></p>\n<ul>\n<li>,;</li>\n<li>,mm,..</li>\n</ul>\n<h3 id=\"Chapter28-\"><a href=\"#Chapter28-\" class=\"headerlink\" title=\"Chapter28 \"></a>Chapter28 </h3><p>,,.:<br><img src=\"/images/string-match1.png\" alt=\"string-match1\"><br>3,,Rabin-Karp,Knuth-Morris-PrattKMP.<br>()</p>\n<ul>\n<li>$O((n-m+1)m)$;</li>\n<li>Rabin-Karp$O(m)$, $O((n-m+1)m)$,;</li>\n<li>KMPO(m),O(n).<br>,mP,nS,PS.</li>\n</ul>\n<p>.</p>\n<p>1.(native)<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">navite-string-matcher(T, P)</span><br><span class=\"line\">n &lt;- length[T]</span><br><span class=\"line\">m &lt;- length[P]</span><br><span class=\"line\">for s &lt;- 0 to n - m</span><br><span class=\"line\">    do if p[1...m] = T[s+1...s+m]</span><br><span class=\"line\">        then print &quot;Pattern occurs with shift&quot;</span><br></pre></td></tr></table></figure></p>\n<p>,T,()mP.PS,,PS.<br>,,.P=abc,S=abdabc,0, 2,c != d,1, ,,1b0a.P,2,01,P,P10,S1P1,.,,.,,,,.</p>\n<p>2.Rabin-Karp<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rabin-karp-matcher(T, P, d, q)</span><br><span class=\"line\">n &lt;- length[T]</span><br><span class=\"line\">m &lt;- length[P]</span><br><span class=\"line\">j &lt;- d^&#123;m-1&#125; mod q</span><br><span class=\"line\">p &lt;- 0</span><br><span class=\"line\">t&#123;0&#125; &lt;- 0</span><br><span class=\"line\">for i &lt;- 1 to m   #</span><br><span class=\"line\">    do p &lt;- (dp + p[i]) mod q</span><br><span class=\"line\">        t&#123;0&#125; &lt;- (dt&#123;0&#125; + T[i]) mod q</span><br><span class=\"line\">for s &lt;- 0 to n - m  #</span><br><span class=\"line\">    do if p = t&#123;s&#125;</span><br><span class=\"line\">        then if P[1..m] = T[s+1...s+m]</span><br><span class=\"line\">            then print &quot;Pattern occurs with shift&quot;s</span><br><span class=\"line\">        if s &lt;- n - m</span><br><span class=\"line\">            then t&#123;s+1&#125; &lt;- (d(t&#123;s&#125; - T[s+1]h) + T[s+m+1]) mod q</span><br></pre></td></tr></table></figure></p>\n<p>:<br><img src=\"/images/robin-karp.png\" alt=\"robin-karp\"></p>\n<p>,.,Pm, $O(m)$ ,.Sn-m+1P,$O(m)$ ;k,k+1,,,$O(1)$ ; $O(m)$.n-m+1, $O(n-m+1)$., $O((n-m+1)m)$ <br>,,hash,hash,hash,.,hash,hash,,.,. $O((n-m+1)m)$, P, $O(n+ m)$.</p>\n<p>3.KMP<br>KMP,.KMP,,,,,.,,.(,,),,,KMP,.,,.,O(||),O(m).,O(n)..<br>,,,.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kmp-matcher(T,P)</span><br><span class=\"line\">n &lt;- length[T]</span><br><span class=\"line\">m &lt;- length[P]</span><br><span class=\"line\"> &lt;- kmp-computer-prefix(P)</span><br><span class=\"line\">q &lt;- 0               // state , number of char matched</span><br><span class=\"line\">for i &lt;- 1 to n</span><br><span class=\"line\">    while q &gt; 0 &amp;&amp; P[q+1] != T[i]  // P and T range from 1 to n, not 0 to n-1</span><br><span class=\"line\">        do q &lt;- [q]</span><br><span class=\"line\">        if P[q+1] = T[i]</span><br><span class=\"line\">            then q &lt;- q+1</span><br><span class=\"line\">        if q = m</span><br><span class=\"line\">            then print &quot;Pattern occurs with shift&quot; i-m</span><br><span class=\"line\">                q &lt;- [q]</span><br></pre></td></tr></table></figure></p>\n<p>,,.KMP,P(),,.,,q+1PqPq+1,Pq.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kmp-computer-prefix(P)</span><br><span class=\"line\"></span><br><span class=\"line\">m &lt;- length[P]</span><br><span class=\"line\">[1] &lt;- 0</span><br><span class=\"line\">k &lt;- 0               // just like q above, number of char matched</span><br><span class=\"line\">for q &lt;-  2 to m     // like i above, and actually it is state, so its name is q</span><br><span class=\"line\">    while k&gt;0 &amp;&amp; P[k+1] != P[q]  // P range from 1 to n, not 0 to n-1</span><br><span class=\"line\">        do k &lt;- [k]</span><br><span class=\"line\">        if P[k+1] = P[q]</span><br><span class=\"line\">            then k &lt;- k+1</span><br><span class=\"line\">        [q] &lt;- k</span><br><span class=\"line\">return </span><br></pre></td></tr></table></figure></p>\n<p>kmp:<br><img src=\"/images/kmp1.png\" alt=\"kmp1\"><br><img src=\"/images/kmp2.png\" alt=\"kmp2\"></p>\n","site":{"data":{}},"excerpt":"<h1 id=\"Introduction-to-algorithms\"><a href=\"#Introduction-to-algorithms\" class=\"headerlink\" title=\"Introduction to algorithms\"></a>Introduction to algorithms</h1><h2 id=\"Part7-\"><a href=\"#Part7-\" class=\"headerlink\" title=\"Part7 \"></a>Part7 </h2><p>part1-6, part7, ,,:</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<h3 id=\"Chapter26-\"><a href=\"#Chapter26-\" class=\"headerlink\" title=\"Chapter26 ?\"></a>Chapter26 ?</h3><p>part2,,,,,.,,??,.</p>\n<p>:</p>\n<ul>\n<li>, .part2</li>\n<li>, .- </li>\n</ul>\n<p>1.</p>\n<ul>\n<li><br>:<br><img src=\"/images/comparsion.png\" alt=\"comparsion\"></li>\n</ul>","more":"<ul>\n<li></li>\n<li>,nn,.n $a_1,a_2, \\dots, a_n$ ,.,n $b_1,b_2, \\dots, b_n$,.<blockquote>\n<ol>\n<li>.</li>\n<li>,.</li>\n</ol>\n</blockquote>\n</li>\n</ul>\n<p>,,.</p>\n<ul>\n<li><p>:<br><img src=\"/images/sortnet.png\" alt=\"sortnet\"></p>\n</li>\n<li><p>:<br>( $b_1 \\leq<br>b_2, \\dots, b_n$ )</p>\n</li>\n<li><p>0-1<br>n,2^n01,,.<br>0-1{0,1},,,().,01.,01,01,.<br>0-1. $a=&lt;a_1,a_2, \\dots, a_n&gt;$  $b=&lt;b_1,b_2, \\dots, b_n&gt;$,f,f(a)=&lt;f(a1),f(a2),,f(an)&gt;f(b)=&lt;f(b1),f(b2),,f(bn)&gt;.<br>,af(a),()ab,f(a)f(b).<br>0-1,01,,01,.<br>n2n01,,.<br>0-1,.,,,0-1,.</p>\n</li>\n<li><p><br>,.&lt;1,4,6,8,3,2&gt;&lt;9,8,3,2,4,6&gt;</p>\n</li>\n</ul>\n<p>2.</p>\n<ul>\n<li><p> $log_2n$,.1,II+n/2,I=1,2,,n/2(n).88(half-cleaner)<br><img src=\"/images/half-cleaner.png\" alt=\"half-cleaner\"></p>\n</li>\n<li><p>01,</p>\n<blockquote>\n<ol>\n<li>,.</li>\n<li>.</li>\n<li>01.</li>\n</ol>\n</blockquote>\n</li>\n<li><p>(bitonic-sorter)<br>,.[n][n],[n].,[n/2],<br><img src=\"/images/bitonic-sorter.png\" alt=\"bitonic-sorter\"></p>\n</li>\n</ul>\n<p>nMERGER[n].,,.,, $a_i$$a_{n-i+1}.,.,.<br><em>bitonic-sorter</em> $\\log n$ 0-1.<br><img src=\"/images/bitonic-sorter2.png\" alt=\"bitonic-sorter2\"></p>\n<p>3.(mergin network)<br>,.,(),,.:<br><img src=\"/images/merger1.png\" alt=\"merger1\"><br><img src=\"/images/merger2.png\" alt=\"merger2\"></p>\n<p>4.0-1,.2,,2;2,(,),4;4, $\\log n$., $O(\\log n)$n.<br><img src=\"/images/sorter.png\" alt=\"sorter\"></p>\n<p>:,,.</p>\n<h3 id=\"Chapter27-\"><a href=\"#Chapter27-\" class=\"headerlink\" title=\"Chapter27 \"></a>Chapter27 </h3><p>part4, , Strasssen, $O(n^{\\log 7})$  $n*n$ .</p>\n<p>1.,.</p>\n<p>A<br>, $A=(a_{ij})$,ij $a_ij$,mXn $R_{mXn}$.<br><img src=\"/images/matrix.png\" alt=\"matrix\"></p>\n<p>ATA.</p>\n<p>(Vector),nX1,1Xn.</p>\n<p>$e_i$10.</p>\n<p>0.</p>\n<p>ij,$a_ij$,0.</p>\n<p>nXn $I_n$1.</p>\n<p>T $|i-j|&gt;1$  $t_ij$=0,.</p>\n<p>Ui&gt;j $U_ij=0$,0,1,.</p>\n<p>Li&lt;j $L_ij=0$,0,1,.</p>\n<p>P1,0,x,x.</p>\n<p>A $A= A^T$.</p>\n<p>$C(c_ij)=A(a_ij)+B(b_ij),c_ij=a_ij+b_ij$,mXn.</p>\n<p>(AB),$C(c_ij)= \\sum_{k=1}^{m} A(a_ik)*B(b_kj)$,,,.</p>\n<p>A-1 $A A^{-1} = I_n= A^{-1}A$,.</p>\n<p> $x_1,x_2, \\dots, x_n$n, $c_1,c_2, \\dots, c_n$, $c_1x_1+c_2x_2+ \\dots +c_nx_n=0$, $x_1,x_2, \\dots, x_n$.</p>\n<p>mXnAA,A..mXn0min(m,n).</p>\n<p>mXnArmXrBrXnCA=BC.nXnn,,mXnn,.<br>.A,A.<br>A,A.</p>\n<p>n&gt;1,nXnAijAij(n-1)X(n-1)A[ij],det(A[ij]).</p>\n<p>AA0,det(A)=0;aA(),aA;A()(),;AAT;(),.</p>\n<p>nXnA,nx0$x^TAx&gt;0$,A.</p>\n<p>A,$A^TA$.</p>\n<p>2.Strassen<br>.C = AB,AB n x n .,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SQUARE-MATRIX-MULTIPLY(A, B)</span><br><span class=\"line\">n = A.rows</span><br><span class=\"line\">let C be a new nxn matrix</span><br><span class=\"line\">for i = 1 to n</span><br><span class=\"line\">    for j = 1 to n</span><br><span class=\"line\">        c[i][j] = 0</span><br><span class=\"line\">        for k = 1 to n</span><br><span class=\"line\">            c[i][j] += a[i][k] * b[k][j]</span><br><span class=\"line\">return C</span><br></pre></td></tr></table></figure></p>\n<p>, $O(n^3)$.<br>StrassennXn, $O(n^3)$ $O(n^{\\log 7}) = O(n^{2.81})$..</p>\n<blockquote>\n<p>,C=AB,ABCnXn,n2,ABCn/2Xn/2<br><img src=\"/images/matrix.png\" alt=\"matrix2\"><br><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">r=ae+bg</span><br><span class=\"line\">s=af+bh</span><br><span class=\"line\">t=ce+dg</span><br><span class=\"line\">u=cf+dh</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p> $n/2 <em> n/2$ $n/2 </em> n/2$, $n * n$ T(n)<br>$$T(n)=8T(n/2)+  O(n^2)$$</p>\n</blockquote>\n<p>Strassen,7 $n/2 * n/2$,<br>$$T(n)=7T(n/2)+O(n^2)= O(n^{\\log 7}) = O(n^{2.81})$$<br></p>\n<ul>\n<li>1.AB $n/2 * n/2$;</li>\n<li>2. $O(n^2)$,14 $n/2 * n/2$ $A_1,B_1,A_2,B_2, \\dots, A_7,B_7$;</li>\n<li>3.7 $P_i=A_i * B_i,i=1,2, \\dots, 7$;</li>\n<li>4. $O(n^2)$ , $P_i$ ,Cr\\s\\t\\u.</li>\n</ul>\n<p>Strassen<br> $P_i$<br> $$P_i=A_iB_i=(_{i1}a+_{i2}b+_{i3}c+_{i4}d)( _{i1}e+_{i2}f+_{i3}g+_{i4}h)$$<br> {-1,0,1},,AB,.,,87.Strassen.</p>\n<p>.,().Strassen,.</p>\n<p>2.(LUP)<br>,.,,R.<br>nn<br><img src=\"/images/matrix.png\" alt=\"matrix3\"><br> $A=(a_{ij}),x=(x_i),b=(b_i)$,Ax=b.</p>\n<p>A(n), $A^{-1}$, $x= A^{-1}b$,x.(An),,;,.<br>LUP.<strong>LUPn*nLUP,PA=LU,LUP.</strong></p>\n<p>y=Ux,x.($O(n^2)$)Ly=Pb,($O(n^2)$)Ux=y,</p>\n<p>$$Ax = P^{-1}LUx = P^{-1}Ly = P^{-1}Pb=b$$</p>\n<p>LUPLUPx.</p>\n<p>LU.AnXn,P$I_n$,A=LU,LUALU.LULUP,,,P1..LUP<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lu-decomposition(A)</span><br><span class=\"line\">n &lt;- rows[A]</span><br><span class=\"line\">for k &lt;- 1 to n</span><br><span class=\"line\">    do u&#123;kk&#125; &lt;- a&#123;kk&#125;</span><br><span class=\"line\">        for i &lt;- k + 1 to n</span><br><span class=\"line\">            do l&#123;ik&#125; &lt;- a&#123;ik&#125;/u&#123;kk&#125;</span><br><span class=\"line\">                u&#123;ki&#125; &lt;- a&#123;ki&#125;</span><br><span class=\"line\">        for i &lt;- k + 1 to n</span><br><span class=\"line\">            do for j &lt;- k + 1 to n</span><br><span class=\"line\">                do a&#123;ij&#125; &lt;- a&#123;ij&#125; - l&#123;ik&#125;u&#123;kj&#125;</span><br><span class=\"line\">return L and U</span><br></pre></td></tr></table></figure></p>\n<p>LU:<br><img src=\"/images/lu.png\" alt=\"lu\"></p>\n<p>:LUP,.,,Strassen.</p>\n<h3 id=\"Chapter28-\"><a href=\"#Chapter28-\" class=\"headerlink\" title=\"Chapter28 \"></a>Chapter28 </h3><p>,..,,.<br>1..</p>\n<blockquote>\n<p>,. $a_1,a_2, \\dots,a_n$ $x_1,x_2, \\dots,x_n$,f<br>$$ f(x_1,x_2, \\dots,x_n) = a_1x_1 + a_2x_2 + \\dots + a_nx_n = \\sum_{j=1}^n a_jx_j$$<br>bf,<br>$f(x_1,x_2, \\dots,x_n) = b$ .<br>$f(x_1,x_2, \\dots,x_n) \\leq b$  $f(x_1,x_2, \\dots,x_n) \\geq b$ .<br>fb,nm,;.</p>\n</blockquote>\n<p>,.,,m,n,().</p>\n<p>2.<br>.<br>,(),.$x_1+x_2$,,.,,.,.<br>,,,,.,.n,n,,,,.,,,.</p>\n<p>3.<br>(nm),.,,,.,,.,.</p>\n<p>.,;,,.,,,,NP.NP,.,.</p>\n<p>:<br>1./<br>,.,,,.<br><br>n $c_1,c_2, \\dots,c_n$;m $b_1,b_2, \\dots, b_m$;m * n $a_ij,i=1,2,\\dots, m,j=1,2, \\dots, n$ n$x_1,x_2, \\dots, x_n$<br>$$ \\sum_{j=1}^n c_jx_j$$<br>n + m, n:<br>$$ \\sum_{j=1}^n a_{ij}x_j \\leq b_i, i = 1,2, \\dots, m<br>x_j \\geq 0, j= 1, 2, \\dots, n$$<br><br>$$c^Tx,Ax \\leq b,x \\geq 0$$</p>\n<p> $x_s$, $x_s$ .xs $c^Tx_s$, $x_s$, $c^Tx_s$.,,.,.<br>,.,.;;;,.<br>,,.,.</p>\n<p>,,,.,s,,<br>$$: z = v + \\sum_{j=1}^n c_jx_j \\\\<br>(: b_i - \\sum_{j=1}^n a_{ij}x_j = x_i$$<br>,.</p>\n<p>2.<br>,,,,..</p>\n<p>.</p>\n<blockquote>\n<p>,G=(V,E),w:E-&gt;Rst,std[t].,.Belleman-Ford,v,d[v], $(u,v) \\in E$, $d[v] \\leq d[u]+w(u,v)$.d[s]=0,st<br>d[t]<br>$d[v] \\leq d[u]+w(u,v)$, $(u,v) \\in E$d[s]=0<br>|V|d[v],vV,|E|+1,d[s]=0.</p>\n</blockquote>\n<p>3.<br>.,..,0,;;,;,,,0,,0,,.</p>\n<p>,:</p>\n<ul>\n<li>1.;</li>\n<li>2.;</li>\n<li>3..</li>\n</ul>\n<p>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pivot(N, B, A, b.c. v, l, e)</span><br><span class=\"line\">#compute the conefficients of the equation ofr new basic variable x</span><br><span class=\"line\">b&#123;e&#125; &lt;- b&#123;l&#125;/a&#123;le&#125;</span><br><span class=\"line\">for each j in N - &#123;e&#125;</span><br><span class=\"line\">    do a&#123;ej&#125; &lt;- a&#123;lj&#125;/a&#123;le&#125;</span><br><span class=\"line\">a&#123;el&#125; &lt;- 1/a&#123;le&#125;</span><br><span class=\"line\">#compute the conefficients of the remaining constraints</span><br><span class=\"line\">for each i in B - &#123;l&#125;</span><br><span class=\"line\">    do b&#123;i&#125; &lt;- b&#123;i&#125; - a&#123;ie&#125;b&#123;e&#125;</span><br><span class=\"line\">    for eahc j in N - &#123;e&#125;</span><br><span class=\"line\">        do a&#123;ij&#125; &lt;- a&#123;ij&#125; - a&#123;ie&#125;a&#123;ej&#125;</span><br><span class=\"line\">    a&#123;il&#125; &lt;- a&#123;ie&#125;a&#123;el&#125;</span><br><span class=\"line\">#compute the objective function</span><br><span class=\"line\">v &lt;- v + c&#123;e&#125;b&#123;e&#125;</span><br><span class=\"line\">for each j in N - &#123;e&#125;</span><br><span class=\"line\">    do c&#123;j&#125; &lt;- c&#123;j&#125; - c&#123;e&#125;a&#123;ej&#125;</span><br><span class=\"line\">cl&#123;e&#125; &lt;- -c&#123;e&#125;a&#123;el&#125;</span><br><span class=\"line\">#compute new ses of basic and nonbasic variables</span><br><span class=\"line\">N = N - &#123;e&#125; union &#123;l&#125;</span><br><span class=\"line\">B = B - &#123;l&#125; union &#123;e&#125;</span><br><span class=\"line\">return (N, B, A, b, c, v)</span><br></pre></td></tr></table></figure></p>\n<p>:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">simple(A, b ,c)</span><br><span class=\"line\">(N, B, A, b, c, v) &lt;0 initialize-simple(A, b, c)</span><br><span class=\"line\">while some index j in N has c&#123;j&#125; &gt; 0</span><br><span class=\"line\">    do choose an index e in N for which c&#123;e&#125; &gt; 0</span><br><span class=\"line\">        for each index i in B</span><br><span class=\"line\">            do if a&#123;ie&#125; &gt; 0</span><br><span class=\"line\">                then delta&#123;i&#125; &lt;- b&#123;i&#125;/a&#123;ie&#125;</span><br><span class=\"line\">                else delta&#123;i&#125; &lt;- INT</span><br><span class=\"line\">            choose an index l in B that minimizes delta&#123;i&#125;</span><br><span class=\"line\">            if delta&#123;i&#125; = INT</span><br><span class=\"line\">                then return &quot;unbounded&quot;</span><br><span class=\"line\">                else (N, B, A, b, c, v) &lt;- pivot(N, B, A, b, c, v, l, e)</span><br><span class=\"line\">for i &lt;- 1 to n</span><br><span class=\"line\">    do if i in B</span><br><span class=\"line\">        then x&#123;i&#125; &lt;- b&#123;i&#125;</span><br><span class=\"line\">        else x&#123;i&#125; &lt;- 0</span><br><span class=\"line\">return (x&#123;1&#125;, x&#123;2&#125;, ..., x&#123;n&#125;)</span><br></pre></td></tr></table></figure></p>\n<p>,,(,,),(),.,,,.</p>\n<p></p>\n<blockquote>\n<p>,,,;,,,();,,.<br>,.,.,..</p>\n</blockquote>\n<p>1.<br><br><br>3x1+x2+2x3<br><br>x1+x2+3x330<br>2x1+2x2+5x324<br>4x1+x2+2x336<br>x1,x2,x30</p>\n<p><br><br>z=3x1+x2+2x3<br><br>x4=30-x1-x2-3x3<br>x5=24-2x1-2x2-5x3<br>x6=36-4x1-x2-2x3</p>\n<p>0,(x1,x2,x3,x4, x5, x6)=(0,0,0,30,24,36),z=0;</p>\n<p>2.,x1.x1,x4, x5, x6,,,().<br>x130,x4;12,x5;9,x6;,9x1,,x6=36-4x1-x2-2x3x1x6,x1=9- x2/4- x3/2- x6/4,,<br><br>z=27+x2/4+ x3/2- 3x6/4<br><br>x1=9- x2/4- x3/2-x6/4<br>x4=21-3x2/4-5x3/2+x6/4<br>x5=6-3x2/2-4x3+x6/2<br>,0,(x1,x2,x3,x4, x5, x6)=(9,0,0,21,6,0),z=27;</p>\n<p>3.,x3,x5=6-3x2/2-4x3+x6/2,3/2,x5,,x3x5,(x1,x2,x3, x4, x5,x6)=(33/4,0,3/2,69/4,0,0),z=111/4;<br>,x2x4,(x1,x2,x3, x4, x5,x6)=(8,4,0,18,0,0),z=28,,(x1,x2,x3)=(8,4,0).<br>,,.</p>\n<ol start=\"4\">\n<li><br>,</li>\n</ol>\n<ul>\n<li>,,;</li>\n<li>,.<br>,,,,.</li>\n</ul>\n<p><strong></strong><br>L<br>;<br>;<br>;</p>\n<p>L,;L,,;,,.<br>,,,..,,.,.L,,.</p>\n<p>L, $L_{aux}$n+1<br>-x0<br><br>$$ \\sum_{j-1}^{n} a_{ij}x_j - x_0 \\leq b_i, i = 1, 2, \\dots, m \\\\<br>x_j \\geq 0, j = 0, 1, \\dots, n<br>$$<br> $L_{aux}$0,L.<br>,x0,0.,,...</p>\n<p><strong></strong>.,..,,..,,.</p>\n<p>,,,.,<br>$$<br>: \\sum_{i=1}^{m} b_iy_i \\\\<br>: \\sum_{i=1}^{m} a_{ij}y_i \\geq c_j, j = 1,2, \\dots, n \\\\<br>y_i \\geq 0, i = 1, 2, \\dots, m<br>$$<br>,,,.m,yi,n,xj.</p>\n<p></p>\n<ul>\n<li>,;</li>\n<li>,mm,..</li>\n</ul>\n<h3 id=\"Chapter28-\"><a href=\"#Chapter28-\" class=\"headerlink\" title=\"Chapter28 \"></a>Chapter28 </h3><p>,,.:<br><img src=\"/images/string-match1.png\" alt=\"string-match1\"><br>3,,Rabin-Karp,Knuth-Morris-PrattKMP.<br>()</p>\n<ul>\n<li>$O((n-m+1)m)$;</li>\n<li>Rabin-Karp$O(m)$, $O((n-m+1)m)$,;</li>\n<li>KMPO(m),O(n).<br>,mP,nS,PS.</li>\n</ul>\n<p>.</p>\n<p>1.(native)<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">navite-string-matcher(T, P)</span><br><span class=\"line\">n &lt;- length[T]</span><br><span class=\"line\">m &lt;- length[P]</span><br><span class=\"line\">for s &lt;- 0 to n - m</span><br><span class=\"line\">    do if p[1...m] = T[s+1...s+m]</span><br><span class=\"line\">        then print &quot;Pattern occurs with shift&quot;</span><br></pre></td></tr></table></figure></p>\n<p>,T,()mP.PS,,PS.<br>,,.P=abc,S=abdabc,0, 2,c != d,1, ,,1b0a.P,2,01,P,P10,S1P1,.,,.,,,,.</p>\n<p>2.Rabin-Karp<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rabin-karp-matcher(T, P, d, q)</span><br><span class=\"line\">n &lt;- length[T]</span><br><span class=\"line\">m &lt;- length[P]</span><br><span class=\"line\">j &lt;- d^&#123;m-1&#125; mod q</span><br><span class=\"line\">p &lt;- 0</span><br><span class=\"line\">t&#123;0&#125; &lt;- 0</span><br><span class=\"line\">for i &lt;- 1 to m   #</span><br><span class=\"line\">    do p &lt;- (dp + p[i]) mod q</span><br><span class=\"line\">        t&#123;0&#125; &lt;- (dt&#123;0&#125; + T[i]) mod q</span><br><span class=\"line\">for s &lt;- 0 to n - m  #</span><br><span class=\"line\">    do if p = t&#123;s&#125;</span><br><span class=\"line\">        then if P[1..m] = T[s+1...s+m]</span><br><span class=\"line\">            then print &quot;Pattern occurs with shift&quot;s</span><br><span class=\"line\">        if s &lt;- n - m</span><br><span class=\"line\">            then t&#123;s+1&#125; &lt;- (d(t&#123;s&#125; - T[s+1]h) + T[s+m+1]) mod q</span><br></pre></td></tr></table></figure></p>\n<p>:<br><img src=\"/images/robin-karp.png\" alt=\"robin-karp\"></p>\n<p>,.,Pm, $O(m)$ ,.Sn-m+1P,$O(m)$ ;k,k+1,,,$O(1)$ ; $O(m)$.n-m+1, $O(n-m+1)$., $O((n-m+1)m)$ <br>,,hash,hash,hash,.,hash,hash,,.,. $O((n-m+1)m)$, P, $O(n+ m)$.</p>\n<p>3.KMP<br>KMP,.KMP,,,,,.,,.(,,),,,KMP,.,,.,O(||),O(m).,O(n)..<br>,,,.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kmp-matcher(T,P)</span><br><span class=\"line\">n &lt;- length[T]</span><br><span class=\"line\">m &lt;- length[P]</span><br><span class=\"line\"> &lt;- kmp-computer-prefix(P)</span><br><span class=\"line\">q &lt;- 0               // state , number of char matched</span><br><span class=\"line\">for i &lt;- 1 to n</span><br><span class=\"line\">    while q &gt; 0 &amp;&amp; P[q+1] != T[i]  // P and T range from 1 to n, not 0 to n-1</span><br><span class=\"line\">        do q &lt;- [q]</span><br><span class=\"line\">        if P[q+1] = T[i]</span><br><span class=\"line\">            then q &lt;- q+1</span><br><span class=\"line\">        if q = m</span><br><span class=\"line\">            then print &quot;Pattern occurs with shift&quot; i-m</span><br><span class=\"line\">                q &lt;- [q]</span><br></pre></td></tr></table></figure></p>\n<p>,,.KMP,P(),,.,,q+1PqPq+1,Pq.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kmp-computer-prefix(P)</span><br><span class=\"line\"></span><br><span class=\"line\">m &lt;- length[P]</span><br><span class=\"line\">[1] &lt;- 0</span><br><span class=\"line\">k &lt;- 0               // just like q above, number of char matched</span><br><span class=\"line\">for q &lt;-  2 to m     // like i above, and actually it is state, so its name is q</span><br><span class=\"line\">    while k&gt;0 &amp;&amp; P[k+1] != P[q]  // P range from 1 to n, not 0 to n-1</span><br><span class=\"line\">        do k &lt;- [k]</span><br><span class=\"line\">        if P[k+1] = P[q]</span><br><span class=\"line\">            then k &lt;- k+1</span><br><span class=\"line\">        [q] &lt;- k</span><br><span class=\"line\">return </span><br></pre></td></tr></table></figure></p>\n<p>kmp:<br><img src=\"/images/kmp1.png\" alt=\"kmp1\"><br><img src=\"/images/kmp2.png\" alt=\"kmp2\"></p>"},{"title":"cs-update","date":"2017-04-01T16:00:00.000Z","_content":"# CSupdate\n\n### \n>, :\n> * 1. ,\n> * 2. ,\n> ,., .,,.\n    \n### 1: \n#### : 2017/03/20 - 2017/04/01\n-----\n#### Q1: ?\n\n: , , , ()\n: C/Python, ,,,,\n\n:\n>> **1. **\n**,/,,,:**\n**a. ().**\n:(x,y),:(x,y)f(x),x{An},{Bn}.f(x).:\n$$f(x)=\\lim\\_{x \\to x-}f(x)=\\lim\\_{x \\to x+}f(x)$$\n**b. .**\n: ,,,.:\n$$\\lim\\_{n \\to \\infty}a\\_n=\\lim_{x \\to x\\_0}f(x)$$\n,().,,.:  ****[ MIT ](https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-042j-mathematics-for-computer-science-spring-2015/index.htm)\n\n<!-- more -->\n\n>>** 2. :**\n**:,,,,,.**\n,,?,,,,,,,,,.,.\n,,.,,,.,,,,,.\n,,.[** MIT Linear Algebra**](https://ocw.mit.edu/courses/mathematics/18-06-linear-algebra-spring-2010/)\n    \n>> **3. :**\n**:(,), (,).**\n,,., ,,,.:\n$$P(A|B) = \\frac {P(B|A) \\times P(A)}{P(B)}$$\n{P(A)P(B)}{P(B|A)},{P(B|A)},.\n,.:?,,,,,...,.[** MIT**](https://ocw.mit.edu/courses/mathematics/18-05-introduction-to-probability-and-statistics-spring-2014/)\n\n>> **4. **\n,{[CODE](https://book.douban.com/subject/1494026/)},.,Shannon[](https://en.wikipedia.org/wiki/A_Symbolic_Analysis_of_Relay_and_Switching_Circuits).,,,,++ALU,CPU.\n,,,,,,.\n\n>> **5. C**\n**C:, , ,**.\nC,C:C,main(),,;,,func(),struct;pointer,,(&\\*)(malloc());.h.c,make.\n,,Ckernel,complier,database,,project,C.\nCswap(),func,void\\*,.,-,(),.\nJava/Python,C,./GNU-lib,,high-level(GUI).,gcc,maketoolchain,C//,C.\n\n>> **6. , **,.\n\n>> **7. **\nRISC,,,,.\n**, CPU(ALU, CU), Mem, I/O,BUS.**CPU,,,;,///,IEEE745;CU,PC,//,/,;{;;},.\n CPUregister - cache - memory - (,),ROM, RAM, FLASH.\nI/O: CPU or mem - I/O - I/O.CPU(), memDMA.\n//,///,,,ISA/PCI/USB.\n,,,?,,,,(Booth);,, ,,,,,,.\n,[Computer Orgianization and Design](https://book.douban.com/subject/1468468/).\n\n>> **8. **\n    **,.**\nTCP/IPOSI,,,,,.\n,,,(iP),//(TCP/UDP),.\n,.SAP,peer,.,,,,,,(),(base case),..\n,(),??.(,)(OSPF,BGP),,.\n,linux[](https://book.douban.com/subject/1756533/).\n\n------\n### Q2:1?\n1:, \n:\n>> **1. **\nMIT[introduction to algorithms](https://book.douban.com/subject/3904676/)[](https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-006-introduction-to-algorithms-fall-2011/index.htm).:\n:,,., .\n(An algorithm is thus a sequence of computational steps that transform the input into the output.),,,.,()//.\n,,.:, ,.,?//,?,?.\n,(,,), (,),(,),,.(,),().\n//O(nlogn),O(n^2),O(n),O(nlogn);//O(n^2);O(d(n+radix)),O(n),.\n(AB),,////,//.\n,,,.,,.,(,,),,;,,.,keykeykey.\n,:top-down,,divide and conquer,;bottom-up,,.\nmitpeek-problem,., $ [a\\_1, a\\_2, a\\_3, \\ldots, a\\_n]$peek $a\\_i$$ a\\_i > a\\_{i-1} \\,  and \\, a\\_i > a\\_{i+1}$ \nO(n)peek,?, \n$$\\begin{align}\nif \\, a\\_{n/2} < a\\_{n/2-1}, peek \\, in \\, [a\\_1, a\\_2, \\ldots, a\\_{n/2-1}]\\\\\\\nif \\, a\\_{n/2} < a\\_{n/2+1}, peek \\, in \\, [a\\_{n/2+1}, \\ldots, a\\_{n-1}, a\\_n]\\\\\\\nelse \\, a\\_{n/2} \\, is \\,peek\n\\end{align}$$\nO(logn).\n(m\\*n),O(mn),.?,max(),,O(mlogn).\n peek-problem,:,(),{,O(n^2)},;{O(logn), O(nlogn)};/(,),,,.**, **.\n \n>> **2. **\n[Operating System Concepts](https://book.douban.com/subject/10076960/),[MIT xv6](https://pdos.csail.mit.edu/6.828/2016/schedule.html).:\n,/,.\n,,/,/.:,(CPU,,);,,.\n,,,,.:\n,(/),:\"\".CPU/mem,,:\n:\n1. ?(,,,,);\n2. ,?,\n3. ,?(,,)\n4. ,,?,,,.\n:\n1. ?,,,.\n2. ,?,.\n3. ,?,(,\n:\n1. ,?(FCB,,,)\n2. ,?(, , )\n3. ?,,(,)\n:\n1. ,CPU/mem?I/O,//DMA\n2. ?I/O(,SPOOLING, )\n  (system call)\nMIT xv6MITupdate.\n                                    \n2017-04-02","source":"_posts/cs-update.md","raw":"title: cs-update\ndate: 2017/04/02\ntags: CS\n\n---\n# CSupdate\n\n### \n>, :\n> * 1. ,\n> * 2. ,\n> ,., .,,.\n    \n### 1: \n#### : 2017/03/20 - 2017/04/01\n-----\n#### Q1: ?\n\n: , , , ()\n: C/Python, ,,,,\n\n:\n>> **1. **\n**,/,,,:**\n**a. ().**\n:(x,y),:(x,y)f(x),x{An},{Bn}.f(x).:\n$$f(x)=\\lim\\_{x \\to x-}f(x)=\\lim\\_{x \\to x+}f(x)$$\n**b. .**\n: ,,,.:\n$$\\lim\\_{n \\to \\infty}a\\_n=\\lim_{x \\to x\\_0}f(x)$$\n,().,,.:  ****[ MIT ](https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-042j-mathematics-for-computer-science-spring-2015/index.htm)\n\n<!-- more -->\n\n>>** 2. :**\n**:,,,,,.**\n,,?,,,,,,,,,.,.\n,,.,,,.,,,,,.\n,,.[** MIT Linear Algebra**](https://ocw.mit.edu/courses/mathematics/18-06-linear-algebra-spring-2010/)\n    \n>> **3. :**\n**:(,), (,).**\n,,., ,,,.:\n$$P(A|B) = \\frac {P(B|A) \\times P(A)}{P(B)}$$\n{P(A)P(B)}{P(B|A)},{P(B|A)},.\n,.:?,,,,,...,.[** MIT**](https://ocw.mit.edu/courses/mathematics/18-05-introduction-to-probability-and-statistics-spring-2014/)\n\n>> **4. **\n,{[CODE](https://book.douban.com/subject/1494026/)},.,Shannon[](https://en.wikipedia.org/wiki/A_Symbolic_Analysis_of_Relay_and_Switching_Circuits).,,,,++ALU,CPU.\n,,,,,,.\n\n>> **5. C**\n**C:, , ,**.\nC,C:C,main(),,;,,func(),struct;pointer,,(&\\*)(malloc());.h.c,make.\n,,Ckernel,complier,database,,project,C.\nCswap(),func,void\\*,.,-,(),.\nJava/Python,C,./GNU-lib,,high-level(GUI).,gcc,maketoolchain,C//,C.\n\n>> **6. , **,.\n\n>> **7. **\nRISC,,,,.\n**, CPU(ALU, CU), Mem, I/O,BUS.**CPU,,,;,///,IEEE745;CU,PC,//,/,;{;;},.\n CPUregister - cache - memory - (,),ROM, RAM, FLASH.\nI/O: CPU or mem - I/O - I/O.CPU(), memDMA.\n//,///,,,ISA/PCI/USB.\n,,,?,,,,(Booth);,, ,,,,,,.\n,[Computer Orgianization and Design](https://book.douban.com/subject/1468468/).\n\n>> **8. **\n    **,.**\nTCP/IPOSI,,,,,.\n,,,(iP),//(TCP/UDP),.\n,.SAP,peer,.,,,,,,(),(base case),..\n,(),??.(,)(OSPF,BGP),,.\n,linux[](https://book.douban.com/subject/1756533/).\n\n------\n### Q2:1?\n1:, \n:\n>> **1. **\nMIT[introduction to algorithms](https://book.douban.com/subject/3904676/)[](https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-006-introduction-to-algorithms-fall-2011/index.htm).:\n:,,., .\n(An algorithm is thus a sequence of computational steps that transform the input into the output.),,,.,()//.\n,,.:, ,.,?//,?,?.\n,(,,), (,),(,),,.(,),().\n//O(nlogn),O(n^2),O(n),O(nlogn);//O(n^2);O(d(n+radix)),O(n),.\n(AB),,////,//.\n,,,.,,.,(,,),,;,,.,keykeykey.\n,:top-down,,divide and conquer,;bottom-up,,.\nmitpeek-problem,., $ [a\\_1, a\\_2, a\\_3, \\ldots, a\\_n]$peek $a\\_i$$ a\\_i > a\\_{i-1} \\,  and \\, a\\_i > a\\_{i+1}$ \nO(n)peek,?, \n$$\\begin{align}\nif \\, a\\_{n/2} < a\\_{n/2-1}, peek \\, in \\, [a\\_1, a\\_2, \\ldots, a\\_{n/2-1}]\\\\\\\nif \\, a\\_{n/2} < a\\_{n/2+1}, peek \\, in \\, [a\\_{n/2+1}, \\ldots, a\\_{n-1}, a\\_n]\\\\\\\nelse \\, a\\_{n/2} \\, is \\,peek\n\\end{align}$$\nO(logn).\n(m\\*n),O(mn),.?,max(),,O(mlogn).\n peek-problem,:,(),{,O(n^2)},;{O(logn), O(nlogn)};/(,),,,.**, **.\n \n>> **2. **\n[Operating System Concepts](https://book.douban.com/subject/10076960/),[MIT xv6](https://pdos.csail.mit.edu/6.828/2016/schedule.html).:\n,/,.\n,,/,/.:,(CPU,,);,,.\n,,,,.:\n,(/),:\"\".CPU/mem,,:\n:\n1. ?(,,,,);\n2. ,?,\n3. ,?(,,)\n4. ,,?,,,.\n:\n1. ?,,,.\n2. ,?,.\n3. ,?,(,\n:\n1. ,?(FCB,,,)\n2. ,?(, , )\n3. ?,,(,)\n:\n1. ,CPU/mem?I/O,//DMA\n2. ?I/O(,SPOOLING, )\n  (system call)\nMIT xv6MITupdate.\n                                    \n2017-04-02","slug":"cs-update","published":1,"updated":"2017-08-26T03:38:21.618Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3gr000fs7amp3dn9ht0","content":"<h1 id=\"CSupdate\"><a href=\"#CSupdate\" class=\"headerlink\" title=\"CSupdate\"></a>CSupdate</h1><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>, :</p>\n<ul>\n<li><ol>\n<li>,</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>,<br>,., .,,.</li>\n</ol>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1: \"></a>1: </h3><h4 id=\"-2017-03-20-2017-04-01\"><a href=\"#-2017-03-20-2017-04-01\" class=\"headerlink\" title=\": 2017/03/20 - 2017/04/01\"></a>: 2017/03/20 - 2017/04/01</h4><hr>\n<h4 id=\"Q1-\"><a href=\"#Q1-\" class=\"headerlink\" title=\"Q1: ?\"></a>Q1: ?</h4><p>: , , , ()<br>: C/Python, ,,,,</p>\n<p>:</p>\n<blockquote>\n<blockquote>\n<p><strong>1. </strong><br><strong>,/,,,:</strong><br><strong>a. ().</strong><br>:(x,y),:(x,y)f(x),x{An},{Bn}.f(x).:<br>$$f(x)=\\lim_{x \\to x-}f(x)=\\lim_{x \\to x+}f(x)$$<br><strong>b. .</strong><br>: ,,,.:<br>$$\\lim_{n \\to \\infty}a_n=\\lim_{x \\to x_0}f(x)$$<br>,().,,.:  <strong></strong><a href=\"https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-042j-mathematics-for-computer-science-spring-2015/index.htm\" target=\"_blank\" rel=\"noopener\"> MIT </a></p>\n</blockquote>\n</blockquote>\n<a id=\"more\"></a>\n<blockquote>\n<blockquote>\n<p><strong> 2. :</strong><br><strong>:,,,,,.</strong><br>,,?,,,,,,,,,.,.<br>,,.,,,.,,,,,.<br>,,.<a href=\"https://ocw.mit.edu/courses/mathematics/18-06-linear-algebra-spring-2010/\" target=\"_blank\" rel=\"noopener\"><strong> MIT Linear Algebra</strong></a></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><strong>3. :</strong><br><strong>:(,), (,).</strong><br>,,., ,,,.:<br>$$P(A|B) = \\frac {P(B|A) \\times P(A)}{P(B)}$$<br>{P(A)P(B)}{P(B|A)},{P(B|A)},.<br>,.:?,,,,,,.<a href=\"https://ocw.mit.edu/courses/mathematics/18-05-introduction-to-probability-and-statistics-spring-2014/\" target=\"_blank\" rel=\"noopener\"><strong> MIT</strong></a></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><strong>4. </strong><br>,{<a href=\"https://book.douban.com/subject/1494026/\" target=\"_blank\" rel=\"noopener\">CODE</a>},.,Shannon<a href=\"https://en.wikipedia.org/wiki/A_Symbolic_Analysis_of_Relay_and_Switching_Circuits\" target=\"_blank\" rel=\"noopener\"></a>.,,,,++ALU,CPU.<br>,,,,,,.</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><strong>5. C</strong><br><strong>C:, , ,</strong>.<br>C,C:C,main(),,;,,func(),struct;pointer,,(&amp;*)(malloc());.h.c,make.<br>,,Ckernel,complier,database,,project,C.<br>Cswap(),func,void*,.,-,(),.<br>Java/Python,C,./GNU-lib,,high-level(GUI).,gcc,maketoolchain,C//,C.<br><br><strong>6. , </strong>,.</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><strong>7. </strong><br>RISC,,,,.<br><strong>, CPU(ALU, CU), Mem, I/O,BUS.</strong>CPU,,,;,///,IEEE745;CU,PC,//,/,;{;;},.<br> CPUregister - cache - memory - (,),ROM, RAM, FLASH.<br>I/O: CPU or mem - I/O - I/O.CPU(), memDMA.<br>//,///,,,ISA/PCI/USB.<br>,,,?,,,,(Booth);,, ,,,,,,.<br>,<a href=\"https://book.douban.com/subject/1468468/\" target=\"_blank\" rel=\"noopener\">Computer Orgianization and Design</a>.</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><strong>8. </strong><br>    <strong>,.</strong><br>TCP/IPOSI,,,,,.<br>,,,(iP),//(TCP/UDP),.<br>,.SAP,peer,.,,,,,,(),(base case),..<br>,(),??.(,)(OSPF,BGP),,.<br>,linux<a href=\"https://book.douban.com/subject/1756533/\" target=\"_blank\" rel=\"noopener\"></a>.</p>\n</blockquote>\n</blockquote>\n<hr>\n<h3 id=\"Q2-1\"><a href=\"#Q2-1\" class=\"headerlink\" title=\"Q2:1?\"></a>Q2:1?</h3><p>1:, <br>:</p>\n<blockquote>\n<blockquote>\n<p><strong>1. </strong><br>MIT<a href=\"https://book.douban.com/subject/3904676/\" target=\"_blank\" rel=\"noopener\">introduction to algorithms</a><a href=\"https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-006-introduction-to-algorithms-fall-2011/index.htm\" target=\"_blank\" rel=\"noopener\"></a>.:<br>:,,., .<br>(An algorithm is thus a sequence of computational steps that transform the input into the output.),,,.,()//.<br>,,.:, ,.,?//,?,?.<br>,(,,), (,),(,),,.(,),().<br>//O(nlogn),O(n^2),O(n),O(nlogn);//O(n^2);O(d(n+radix)),O(n),.<br>(AB),,////,//.<br>,,,.,,.,(,,),,;,,.,keykeykey.<br>,:top-down,,divide and conquer,;bottom-up,,.<br>mitpeek-problem,., $ [a_1, a_2, a_3, \\ldots, a_n]$peek $a_i$$ a_i &gt; a_{i-1} \\,  and \\, a_i &gt; a_{i+1}$ <br>O(n)peek,?, <br>$$\\begin{align}<br>if \\, a_{n/2} &lt; a_{n/2-1}, peek \\, in \\, [a_1, a_2, \\ldots, a_{n/2-1}]\\\\<br>if \\, a_{n/2} &lt; a_{n/2+1}, peek \\, in \\, [a_{n/2+1}, \\ldots, a_{n-1}, a_n]\\\\<br>else \\, a_{n/2} \\, is \\,peek<br>\\end{align}$$<br>O(logn).<br>(m*n),O(mn),.?,max(),,O(mlogn).<br> peek-problem,:,(),{,O(n^2)},;{O(logn), O(nlogn)};/(,),,,.<strong>, </strong>.<br> <br><strong>2. </strong><br><a href=\"https://book.douban.com/subject/10076960/\" target=\"_blank\" rel=\"noopener\">Operating System Concepts</a>,<a href=\"https://pdos.csail.mit.edu/6.828/2016/schedule.html\" target=\"_blank\" rel=\"noopener\">MIT xv6</a>.:<br>,/,.<br>,,/,/.:,(CPU,,);,,.<br>,,,,.:<br>,(/),:.CPU/mem,,:<br>:<br>1. ?(,,,,);<br>2. ,?,<br>3. ,?(,,)<br>4. ,,?,,,.<br>:<br>1. ?,,,.<br>2. ,?,.<br>3. ,?,(,<br>:<br>1. ,?(FCB,,,)<br>2. ,?(, , )<br>3. ?,,(,)<br>:<br>1. ,CPU/mem?I/O,//DMA<br>2. ?I/O(,SPOOLING, )<br>  (system call)<br>MIT xv6MITupdate.</p>\n</blockquote>\n</blockquote>\n<p>2017-04-02</p>\n","site":{"data":{}},"excerpt":"<h1 id=\"CSupdate\"><a href=\"#CSupdate\" class=\"headerlink\" title=\"CSupdate\"></a>CSupdate</h1><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>, :</p>\n<ul>\n<li><ol>\n<li>,</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>,<br>,., .,,.</li>\n</ol>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1: \"></a>1: </h3><h4 id=\"-2017-03-20-2017-04-01\"><a href=\"#-2017-03-20-2017-04-01\" class=\"headerlink\" title=\": 2017/03/20 - 2017/04/01\"></a>: 2017/03/20 - 2017/04/01</h4><hr>\n<h4 id=\"Q1-\"><a href=\"#Q1-\" class=\"headerlink\" title=\"Q1: ?\"></a>Q1: ?</h4><p>: , , , ()<br>: C/Python, ,,,,</p>\n<p>:</p>\n<blockquote>\n<blockquote>\n<p><strong>1. </strong><br><strong>,/,,,:</strong><br><strong>a. ().</strong><br>:(x,y),:(x,y)f(x),x{An},{Bn}.f(x).:<br>$$f(x)=\\lim_{x \\to x-}f(x)=\\lim_{x \\to x+}f(x)$$<br><strong>b. .</strong><br>: ,,,.:<br>$$\\lim_{n \\to \\infty}a_n=\\lim_{x \\to x_0}f(x)$$<br>,().,,.:  <strong></strong><a href=\"https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-042j-mathematics-for-computer-science-spring-2015/index.htm\" target=\"_blank\" rel=\"noopener\"> MIT </a></p>\n</blockquote>\n</blockquote>","more":"<blockquote>\n<blockquote>\n<p><strong> 2. :</strong><br><strong>:,,,,,.</strong><br>,,?,,,,,,,,,.,.<br>,,.,,,.,,,,,.<br>,,.<a href=\"https://ocw.mit.edu/courses/mathematics/18-06-linear-algebra-spring-2010/\" target=\"_blank\" rel=\"noopener\"><strong> MIT Linear Algebra</strong></a></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><strong>3. :</strong><br><strong>:(,), (,).</strong><br>,,., ,,,.:<br>$$P(A|B) = \\frac {P(B|A) \\times P(A)}{P(B)}$$<br>{P(A)P(B)}{P(B|A)},{P(B|A)},.<br>,.:?,,,,,,.<a href=\"https://ocw.mit.edu/courses/mathematics/18-05-introduction-to-probability-and-statistics-spring-2014/\" target=\"_blank\" rel=\"noopener\"><strong> MIT</strong></a></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><strong>4. </strong><br>,{<a href=\"https://book.douban.com/subject/1494026/\" target=\"_blank\" rel=\"noopener\">CODE</a>},.,Shannon<a href=\"https://en.wikipedia.org/wiki/A_Symbolic_Analysis_of_Relay_and_Switching_Circuits\" target=\"_blank\" rel=\"noopener\"></a>.,,,,++ALU,CPU.<br>,,,,,,.</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><strong>5. C</strong><br><strong>C:, , ,</strong>.<br>C,C:C,main(),,;,,func(),struct;pointer,,(&amp;*)(malloc());.h.c,make.<br>,,Ckernel,complier,database,,project,C.<br>Cswap(),func,void*,.,-,(),.<br>Java/Python,C,./GNU-lib,,high-level(GUI).,gcc,maketoolchain,C//,C.<br><br><strong>6. , </strong>,.</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><strong>7. </strong><br>RISC,,,,.<br><strong>, CPU(ALU, CU), Mem, I/O,BUS.</strong>CPU,,,;,///,IEEE745;CU,PC,//,/,;{;;},.<br> CPUregister - cache - memory - (,),ROM, RAM, FLASH.<br>I/O: CPU or mem - I/O - I/O.CPU(), memDMA.<br>//,///,,,ISA/PCI/USB.<br>,,,?,,,,(Booth);,, ,,,,,,.<br>,<a href=\"https://book.douban.com/subject/1468468/\" target=\"_blank\" rel=\"noopener\">Computer Orgianization and Design</a>.</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p><strong>8. </strong><br>    <strong>,.</strong><br>TCP/IPOSI,,,,,.<br>,,,(iP),//(TCP/UDP),.<br>,.SAP,peer,.,,,,,,(),(base case),..<br>,(),??.(,)(OSPF,BGP),,.<br>,linux<a href=\"https://book.douban.com/subject/1756533/\" target=\"_blank\" rel=\"noopener\"></a>.</p>\n</blockquote>\n</blockquote>\n<hr>\n<h3 id=\"Q2-1\"><a href=\"#Q2-1\" class=\"headerlink\" title=\"Q2:1?\"></a>Q2:1?</h3><p>1:, <br>:</p>\n<blockquote>\n<blockquote>\n<p><strong>1. </strong><br>MIT<a href=\"https://book.douban.com/subject/3904676/\" target=\"_blank\" rel=\"noopener\">introduction to algorithms</a><a href=\"https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-006-introduction-to-algorithms-fall-2011/index.htm\" target=\"_blank\" rel=\"noopener\"></a>.:<br>:,,., .<br>(An algorithm is thus a sequence of computational steps that transform the input into the output.),,,.,()//.<br>,,.:, ,.,?//,?,?.<br>,(,,), (,),(,),,.(,),().<br>//O(nlogn),O(n^2),O(n),O(nlogn);//O(n^2);O(d(n+radix)),O(n),.<br>(AB),,////,//.<br>,,,.,,.,(,,),,;,,.,keykeykey.<br>,:top-down,,divide and conquer,;bottom-up,,.<br>mitpeek-problem,., $ [a_1, a_2, a_3, \\ldots, a_n]$peek $a_i$$ a_i &gt; a_{i-1} \\,  and \\, a_i &gt; a_{i+1}$ <br>O(n)peek,?, <br>$$\\begin{align}<br>if \\, a_{n/2} &lt; a_{n/2-1}, peek \\, in \\, [a_1, a_2, \\ldots, a_{n/2-1}]\\\\<br>if \\, a_{n/2} &lt; a_{n/2+1}, peek \\, in \\, [a_{n/2+1}, \\ldots, a_{n-1}, a_n]\\\\<br>else \\, a_{n/2} \\, is \\,peek<br>\\end{align}$$<br>O(logn).<br>(m*n),O(mn),.?,max(),,O(mlogn).<br> peek-problem,:,(),{,O(n^2)},;{O(logn), O(nlogn)};/(,),,,.<strong>, </strong>.<br> <br><strong>2. </strong><br><a href=\"https://book.douban.com/subject/10076960/\" target=\"_blank\" rel=\"noopener\">Operating System Concepts</a>,<a href=\"https://pdos.csail.mit.edu/6.828/2016/schedule.html\" target=\"_blank\" rel=\"noopener\">MIT xv6</a>.:<br>,/,.<br>,,/,/.:,(CPU,,);,,.<br>,,,,.:<br>,(/),:.CPU/mem,,:<br>:<br>1. ?(,,,,);<br>2. ,?,<br>3. ,?(,,)<br>4. ,,?,,,.<br>:<br>1. ?,,,.<br>2. ,?,.<br>3. ,?,(,<br>:<br>1. ,?(FCB,,,)<br>2. ,?(, , )<br>3. ?,,(,)<br>:<br>1. ,CPU/mem?I/O,//DMA<br>2. ?I/O(,SPOOLING, )<br>  (system call)<br>MIT xv6MITupdate.</p>\n</blockquote>\n</blockquote>\n<p>2017-04-02</p>"},{"title":"hw1-boot-xv6","date":"2017-04-08T16:00:00.000Z","_content":"\n# hw1: boot xv6\n### \n>   6.828JOSxv6,JOSxv6,xv6(), JOS(project)os,.\nxv6xv6-bookxv6, homework1xv6.\n\n### answer\n#### 1. xv6\n```bash\ngit clone git://github.com/mit-pdos/xv6-public.git\n```\n#### 2. \n```bash\ncd xv6\nmake\n```\nxv6.img, qemu.\n\n<!-- more -->\n\n#### 3. _start\n```bash\n$ nm kernel | grep _start\n```\n![_start.png](./_start.png)\n_startaddress0x10000c\nxv6, _start,xv6\n, `make qemu-gdb`, `gdb`,gdbqemu,xv6\n```\nbr * 0x10000c\n0x10000c:\tmov    %cr4,%eax\n```\n![br_start](./br_start.png)\n\n#### 4. ?\nboot.Sboot.cboot.asm\n> 1.0x7c00$esp\n2.bootmain\n3.bootmain1\n4.boot.asmeip0x10000c\n\n\n1.bootmainesp0x7c00boot.s\n```asm\nboot.asm  mov    $start,  $esp\n0x7c40:   mov    $0x7c00, $esp\n```\n.bootmain$esp-4\n```asm\nboot.asm\n0x7c45:  call bootmain\nspin:\n0x7c4a:  jmp spin\n```\n\n3.bootmain1`push     $ebp`$ebp\n```asm\nboot.asm\n0x7d0c:  push $ebp\n```\n.eip0x10000cbootmain ","source":"_posts/hw1.md","raw":"title: hw1-boot-xv6\ndate: 2017/04/09\ntags: \n\t- os\n\t- xv6\n\n---\n\n# hw1: boot xv6\n### \n>   6.828JOSxv6,JOSxv6,xv6(), JOS(project)os,.\nxv6xv6-bookxv6, homework1xv6.\n\n### answer\n#### 1. xv6\n```bash\ngit clone git://github.com/mit-pdos/xv6-public.git\n```\n#### 2. \n```bash\ncd xv6\nmake\n```\nxv6.img, qemu.\n\n<!-- more -->\n\n#### 3. _start\n```bash\n$ nm kernel | grep _start\n```\n![_start.png](./_start.png)\n_startaddress0x10000c\nxv6, _start,xv6\n, `make qemu-gdb`, `gdb`,gdbqemu,xv6\n```\nbr * 0x10000c\n0x10000c:\tmov    %cr4,%eax\n```\n![br_start](./br_start.png)\n\n#### 4. ?\nboot.Sboot.cboot.asm\n> 1.0x7c00$esp\n2.bootmain\n3.bootmain1\n4.boot.asmeip0x10000c\n\n\n1.bootmainesp0x7c00boot.s\n```asm\nboot.asm  mov    $start,  $esp\n0x7c40:   mov    $0x7c00, $esp\n```\n.bootmain$esp-4\n```asm\nboot.asm\n0x7c45:  call bootmain\nspin:\n0x7c4a:  jmp spin\n```\n\n3.bootmain1`push     $ebp`$ebp\n```asm\nboot.asm\n0x7d0c:  push $ebp\n```\n.eip0x10000cbootmain ","slug":"hw1","published":1,"updated":"2018-05-31T16:23:13.373Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3gt000is7amr6ciwv2h","content":"<h1 id=\"hw1-boot-xv6\"><a href=\"#hw1-boot-xv6\" class=\"headerlink\" title=\"hw1: boot xv6\"></a>hw1: boot xv6</h1><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>  6.828JOSxv6,JOSxv6,xv6(), JOS(project)os,.<br>xv6xv6-bookxv6, homework1xv6.</p>\n</blockquote>\n<h3 id=\"answer\"><a href=\"#answer\" class=\"headerlink\" title=\"answer\"></a>answer</h3><h4 id=\"1-xv6\"><a href=\"#1-xv6\" class=\"headerlink\" title=\"1. xv6\"></a>1. xv6</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> git://github.com/mit-pdos/xv6-public.git</span><br></pre></td></tr></table></figure>\n<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> xv6</span><br><span class=\"line\">make</span><br></pre></td></tr></table></figure>\n<p>xv6.img, qemu.</p>\n<a id=\"more\"></a>\n<h4 id=\"3--start\"><a href=\"#3--start\" class=\"headerlink\" title=\"3. _start\"></a>3. _start</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ nm kernel | grep _start</span><br></pre></td></tr></table></figure>\n<p><img src=\"./_start.png\" alt=\"_start.png\"><br>_startaddress0x10000c<br>xv6, _start,xv6<br>, <code>make qemu-gdb</code>, <code>gdb</code>,gdbqemu,xv6<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">br * 0x10000c</span><br><span class=\"line\">0x10000c:\tmov    %cr4,%eax</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"./br_start.png\" alt=\"br_start\"></p>\n<h4 id=\"4-\"><a href=\"#4-\" class=\"headerlink\" title=\"4. ?\"></a>4. ?</h4><p>boot.Sboot.cboot.asm</p>\n<blockquote>\n<p>1.0x7c00$esp<br>2.bootmain<br>3.bootmain1<br>4.boot.asmeip0x10000c</p>\n</blockquote>\n<p>1.bootmainesp0x7c00boot.s<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot.asm  mov    $start,  $esp</span><br><span class=\"line\">0x7c40:   mov    $0x7c00, $esp</span><br></pre></td></tr></table></figure></p>\n<p>.bootmain$esp-4<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot.asm</span><br><span class=\"line\">0x7c45:  call bootmain</span><br><span class=\"line\">spin:</span><br><span class=\"line\">0x7c4a:  jmp spin</span><br></pre></td></tr></table></figure></p>\n<p>3.bootmain1<code>push     $ebp</code>$ebp<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot.asm</span><br><span class=\"line\">0x7d0c:  push $ebp</span><br></pre></td></tr></table></figure></p>\n<p>.eip0x10000cbootmain </p>\n","site":{"data":{}},"excerpt":"<h1 id=\"hw1-boot-xv6\"><a href=\"#hw1-boot-xv6\" class=\"headerlink\" title=\"hw1: boot xv6\"></a>hw1: boot xv6</h1><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>  6.828JOSxv6,JOSxv6,xv6(), JOS(project)os,.<br>xv6xv6-bookxv6, homework1xv6.</p>\n</blockquote>\n<h3 id=\"answer\"><a href=\"#answer\" class=\"headerlink\" title=\"answer\"></a>answer</h3><h4 id=\"1-xv6\"><a href=\"#1-xv6\" class=\"headerlink\" title=\"1. xv6\"></a>1. xv6</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> git://github.com/mit-pdos/xv6-public.git</span><br></pre></td></tr></table></figure>\n<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> xv6</span><br><span class=\"line\">make</span><br></pre></td></tr></table></figure>\n<p>xv6.img, qemu.</p>","more":"<h4 id=\"3--start\"><a href=\"#3--start\" class=\"headerlink\" title=\"3. _start\"></a>3. _start</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ nm kernel | grep _start</span><br></pre></td></tr></table></figure>\n<p><img src=\"./_start.png\" alt=\"_start.png\"><br>_startaddress0x10000c<br>xv6, _start,xv6<br>, <code>make qemu-gdb</code>, <code>gdb</code>,gdbqemu,xv6<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">br * 0x10000c</span><br><span class=\"line\">0x10000c:\tmov    %cr4,%eax</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"./br_start.png\" alt=\"br_start\"></p>\n<h4 id=\"4-\"><a href=\"#4-\" class=\"headerlink\" title=\"4. ?\"></a>4. ?</h4><p>boot.Sboot.cboot.asm</p>\n<blockquote>\n<p>1.0x7c00$esp<br>2.bootmain<br>3.bootmain1<br>4.boot.asmeip0x10000c</p>\n</blockquote>\n<p>1.bootmainesp0x7c00boot.s<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot.asm  mov    $start,  $esp</span><br><span class=\"line\">0x7c40:   mov    $0x7c00, $esp</span><br></pre></td></tr></table></figure></p>\n<p>.bootmain$esp-4<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot.asm</span><br><span class=\"line\">0x7c45:  call bootmain</span><br><span class=\"line\">spin:</span><br><span class=\"line\">0x7c4a:  jmp spin</span><br></pre></td></tr></table></figure></p>\n<p>3.bootmain1<code>push     $ebp</code>$ebp<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot.asm</span><br><span class=\"line\">0x7d0c:  push $ebp</span><br></pre></td></tr></table></figure></p>\n<p>.eip0x10000cbootmain </p>"},{"title":"hw3-system-calls","date":"2017-04-18T16:00:00.000Z","_content":"# hw3 xv6 system calls\n## \n[hw1 boot pc],xv6:\n> * xv6\n> * xv6 kernel, \n\n## Part1: \n\n### \n> `systemcall.c`,,.,xv6:\n``` bash\n...\nfork -> 2\nexec -> 0\nopen -> 3\nclose -> 0\n$write -> 1\n write -> 1\n```\n<!-- more -->\n\n### \n> : `syscall[]`.`syscall()`, , ` syscall.h`.`syscall_name`, , `syscall()``cprintf`:\n``` c\nstatic char syscalls_name[][8] = {\n[SYS_fork]    \"fork\",\n[SYS_exit]    \"exit\",\n[SYS_wait]    \"wait\",\n[SYS_pipe]    \"pipe\",\n[SYS_read]    \"read\",\n[SYS_kill]    \"kill\",\n[SYS_exec]    \"exec\",\n[SYS_fstat]   \"fstat\",\n[SYS_chdir]   \"chdir\",\n[SYS_dup]     \"dup\",\n[SYS_getpid]  \"getpid\",\n[SYS_sbrk]    \"sbrk\",\n[SYS_sleep]   \"sleep\",\n[SYS_uptime]  \"uptime\",\n[SYS_open]    \"open\",\n[SYS_write]   \"write\",\n[SYS_mknod]   \"mknod\",\n[SYS_unlink]  \"unlink\",\n[SYS_link]    \"link\",\n[SYS_mkdir]   \"mkdir\",\n[SYS_close]   \"close\",\n[SYS_date]    \"date\",\n};\n\nvoid\nsyscall(void)\n{\n  int num;\n\n  num = proc->tf->eax;  //\n  if(num > 0 && num < NELEM(syscalls) && syscalls[num])\n\t{\n    proc->tf->eax = syscalls[num]();  //\n    cprintf(\"%s -> %d\\n\", syscalls_name[num], proc->tf->eax);\n  } else {\n    cprintf(\"%d %s: unknown sys call %d\\n\",\n            proc->pid, proc->name, num);\n    proc->tf->eax = -1;\n  }\n}\n```\n\n## Part2 \n\n### \n> `date`,UTC.,xv6 shell`date`UTC.\n\n### \n> `cmostime()`(`lapic.c`),`date.h`struct rtcdate,`cmostime()`.\n`uptime`\n``` c\ngrep -n uptime *.[chS]\n#output\nsyscall.c: extern int sys_uptime(void);\nsyscall.c:[SYS_uptime] sys_uptime,\nsyscall.c:[SYS_uptime] \"uptime\",\nsyscall.h:#define SYS_uptime 14\nsysproc.c:sys_uptime(void)\nuser.h:int uptime(void);\nusys.S:SYSCALL(uptime)\n```\n> :\n* `syscall.h`\n* `user.h`\n* `usys.S`\n* `syscall.c`\n* `sysproc.c`\n\n> 'date'\n``` c\nint\nsys_date(void)\n{\n  struct rtcdate *r;\n\n  if (argptr(0, (void *)&r, sizeof(*r)) < 0)\n          return -1;\n  cmostime(r);\n  return 0;\n}\n```\n","source":"_posts/hw3.md","raw":"title: hw3-system-calls\ndate: 2017/04/19\ntags:\n\t- os\n\t- xv6\n\n---\n# hw3 xv6 system calls\n## \n[hw1 boot pc],xv6:\n> * xv6\n> * xv6 kernel, \n\n## Part1: \n\n### \n> `systemcall.c`,,.,xv6:\n``` bash\n...\nfork -> 2\nexec -> 0\nopen -> 3\nclose -> 0\n$write -> 1\n write -> 1\n```\n<!-- more -->\n\n### \n> : `syscall[]`.`syscall()`, , ` syscall.h`.`syscall_name`, , `syscall()``cprintf`:\n``` c\nstatic char syscalls_name[][8] = {\n[SYS_fork]    \"fork\",\n[SYS_exit]    \"exit\",\n[SYS_wait]    \"wait\",\n[SYS_pipe]    \"pipe\",\n[SYS_read]    \"read\",\n[SYS_kill]    \"kill\",\n[SYS_exec]    \"exec\",\n[SYS_fstat]   \"fstat\",\n[SYS_chdir]   \"chdir\",\n[SYS_dup]     \"dup\",\n[SYS_getpid]  \"getpid\",\n[SYS_sbrk]    \"sbrk\",\n[SYS_sleep]   \"sleep\",\n[SYS_uptime]  \"uptime\",\n[SYS_open]    \"open\",\n[SYS_write]   \"write\",\n[SYS_mknod]   \"mknod\",\n[SYS_unlink]  \"unlink\",\n[SYS_link]    \"link\",\n[SYS_mkdir]   \"mkdir\",\n[SYS_close]   \"close\",\n[SYS_date]    \"date\",\n};\n\nvoid\nsyscall(void)\n{\n  int num;\n\n  num = proc->tf->eax;  //\n  if(num > 0 && num < NELEM(syscalls) && syscalls[num])\n\t{\n    proc->tf->eax = syscalls[num]();  //\n    cprintf(\"%s -> %d\\n\", syscalls_name[num], proc->tf->eax);\n  } else {\n    cprintf(\"%d %s: unknown sys call %d\\n\",\n            proc->pid, proc->name, num);\n    proc->tf->eax = -1;\n  }\n}\n```\n\n## Part2 \n\n### \n> `date`,UTC.,xv6 shell`date`UTC.\n\n### \n> `cmostime()`(`lapic.c`),`date.h`struct rtcdate,`cmostime()`.\n`uptime`\n``` c\ngrep -n uptime *.[chS]\n#output\nsyscall.c: extern int sys_uptime(void);\nsyscall.c:[SYS_uptime] sys_uptime,\nsyscall.c:[SYS_uptime] \"uptime\",\nsyscall.h:#define SYS_uptime 14\nsysproc.c:sys_uptime(void)\nuser.h:int uptime(void);\nusys.S:SYSCALL(uptime)\n```\n> :\n* `syscall.h`\n* `user.h`\n* `usys.S`\n* `syscall.c`\n* `sysproc.c`\n\n> 'date'\n``` c\nint\nsys_date(void)\n{\n  struct rtcdate *r;\n\n  if (argptr(0, (void *)&r, sizeof(*r)) < 0)\n          return -1;\n  cmostime(r);\n  return 0;\n}\n```\n","slug":"hw3","published":1,"updated":"2017-08-26T03:38:21.618Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3gu000js7amu5khzr0d","content":"<h1 id=\"hw3-xv6-system-calls\"><a href=\"#hw3-xv6-system-calls\" class=\"headerlink\" title=\"hw3 xv6 system calls\"></a>hw3 xv6 system calls</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>[hw1 boot pc],xv6:</p>\n<blockquote>\n<ul>\n<li>xv6</li>\n<li>xv6 kernel, </li>\n</ul>\n</blockquote>\n<h2 id=\"Part1-\"><a href=\"#Part1-\" class=\"headerlink\" title=\"Part1: \"></a>Part1: </h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>systemcall.c</code>,,.,xv6:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">fork -&gt; 2</span><br><span class=\"line\"><span class=\"built_in\">exec</span> -&gt; 0</span><br><span class=\"line\">open -&gt; 3</span><br><span class=\"line\">close -&gt; 0</span><br><span class=\"line\"><span class=\"variable\">$write</span> -&gt; 1</span><br><span class=\"line\"> write -&gt; 1</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<a id=\"more\"></a>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>: <code>syscall[]</code>.<code>syscall()</code>, , <code>syscall.h</code>.<code>syscall_name</code>, , <code>syscall()</code><code>cprintf</code>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">char</span> syscalls_name[][<span class=\"number\">8</span>] = &#123;</span><br><span class=\"line\">[SYS_fork]    <span class=\"string\">\"fork\"</span>,</span><br><span class=\"line\">[SYS_exit]    <span class=\"string\">\"exit\"</span>,</span><br><span class=\"line\">[SYS_wait]    <span class=\"string\">\"wait\"</span>,</span><br><span class=\"line\">[SYS_pipe]    <span class=\"string\">\"pipe\"</span>,</span><br><span class=\"line\">[SYS_read]    <span class=\"string\">\"read\"</span>,</span><br><span class=\"line\">[SYS_kill]    <span class=\"string\">\"kill\"</span>,</span><br><span class=\"line\">[SYS_exec]    <span class=\"string\">\"exec\"</span>,</span><br><span class=\"line\">[SYS_fstat]   <span class=\"string\">\"fstat\"</span>,</span><br><span class=\"line\">[SYS_chdir]   <span class=\"string\">\"chdir\"</span>,</span><br><span class=\"line\">[SYS_dup]     <span class=\"string\">\"dup\"</span>,</span><br><span class=\"line\">[SYS_getpid]  <span class=\"string\">\"getpid\"</span>,</span><br><span class=\"line\">[SYS_sbrk]    <span class=\"string\">\"sbrk\"</span>,</span><br><span class=\"line\">[SYS_sleep]   <span class=\"string\">\"sleep\"</span>,</span><br><span class=\"line\">[SYS_uptime]  <span class=\"string\">\"uptime\"</span>,</span><br><span class=\"line\">[SYS_open]    <span class=\"string\">\"open\"</span>,</span><br><span class=\"line\">[SYS_write]   <span class=\"string\">\"write\"</span>,</span><br><span class=\"line\">[SYS_mknod]   <span class=\"string\">\"mknod\"</span>,</span><br><span class=\"line\">[SYS_unlink]  <span class=\"string\">\"unlink\"</span>,</span><br><span class=\"line\">[SYS_link]    <span class=\"string\">\"link\"</span>,</span><br><span class=\"line\">[SYS_mkdir]   <span class=\"string\">\"mkdir\"</span>,</span><br><span class=\"line\">[SYS_close]   <span class=\"string\">\"close\"</span>,</span><br><span class=\"line\">[SYS_date]    <span class=\"string\">\"date\"</span>,</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">syscall(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> num;</span><br><span class=\"line\"></span><br><span class=\"line\">  num = proc-&gt;tf-&gt;eax;  <span class=\"comment\">//</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span>(num &gt; <span class=\"number\">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num])</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">    proc-&gt;tf-&gt;eax = syscalls[num]();  <span class=\"comment\">//</span></span><br><span class=\"line\">    cprintf(<span class=\"string\">\"%s -&gt; %d\\n\"</span>, syscalls_name[num], proc-&gt;tf-&gt;eax);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    cprintf(<span class=\"string\">\"%d %s: unknown sys call %d\\n\"</span>,</span><br><span class=\"line\">            proc-&gt;pid, proc-&gt;name, num);</span><br><span class=\"line\">    proc-&gt;tf-&gt;eax = <span class=\"number\">-1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"Part2-\"><a href=\"#Part2-\" class=\"headerlink\" title=\"Part2 \"></a>Part2 </h2><h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>date</code>,UTC.,xv6 shell<code>date</code>UTC.</p>\n</blockquote>\n<h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>cmostime()</code>(<code>lapic.c</code>),<code>date.h</code>struct rtcdate,<code>cmostime()</code>.<br><code>uptime</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grep -n uptime *.[chS]</span><br><span class=\"line\"><span class=\"meta\">#output</span></span><br><span class=\"line\">syscall.c: <span class=\"function\"><span class=\"keyword\">extern</span> <span class=\"keyword\">int</span> <span class=\"title\">sys_uptime</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span>;</span><br><span class=\"line\">syscall.c:[SYS_uptime] sys_uptime,</span><br><span class=\"line\">syscall.c:[SYS_uptime] <span class=\"string\">\"uptime\"</span>,</span><br><span class=\"line\">syscall.h:<span class=\"meta\">#<span class=\"meta-keyword\">define</span> SYS_uptime 14</span></span><br><span class=\"line\">sysproc.c:sys_uptime(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">user.h:<span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">uptime</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span>;</span><br><span class=\"line\">usys.S:SYSCALL(uptime)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>:</p>\n<ul>\n<li><code>syscall.h</code></li>\n<li><code>user.h</code></li>\n<li><code>usys.S</code></li>\n<li><code>syscall.c</code></li>\n<li><code>sysproc.c</code></li>\n</ul>\n</blockquote>\n<blockquote>\n<p>date<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">sys_date(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> rtcdate *r;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (argptr(<span class=\"number\">0</span>, (<span class=\"keyword\">void</span> *)&amp;r, <span class=\"keyword\">sizeof</span>(*r)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">          <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  cmostime(r);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<h1 id=\"hw3-xv6-system-calls\"><a href=\"#hw3-xv6-system-calls\" class=\"headerlink\" title=\"hw3 xv6 system calls\"></a>hw3 xv6 system calls</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>[hw1 boot pc],xv6:</p>\n<blockquote>\n<ul>\n<li>xv6</li>\n<li>xv6 kernel, </li>\n</ul>\n</blockquote>\n<h2 id=\"Part1-\"><a href=\"#Part1-\" class=\"headerlink\" title=\"Part1: \"></a>Part1: </h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>systemcall.c</code>,,.,xv6:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">fork -&gt; 2</span><br><span class=\"line\"><span class=\"built_in\">exec</span> -&gt; 0</span><br><span class=\"line\">open -&gt; 3</span><br><span class=\"line\">close -&gt; 0</span><br><span class=\"line\"><span class=\"variable\">$write</span> -&gt; 1</span><br><span class=\"line\"> write -&gt; 1</span><br></pre></td></tr></table></figure></p>\n</blockquote>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>: <code>syscall[]</code>.<code>syscall()</code>, , <code>syscall.h</code>.<code>syscall_name</code>, , <code>syscall()</code><code>cprintf</code>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">char</span> syscalls_name[][<span class=\"number\">8</span>] = &#123;</span><br><span class=\"line\">[SYS_fork]    <span class=\"string\">\"fork\"</span>,</span><br><span class=\"line\">[SYS_exit]    <span class=\"string\">\"exit\"</span>,</span><br><span class=\"line\">[SYS_wait]    <span class=\"string\">\"wait\"</span>,</span><br><span class=\"line\">[SYS_pipe]    <span class=\"string\">\"pipe\"</span>,</span><br><span class=\"line\">[SYS_read]    <span class=\"string\">\"read\"</span>,</span><br><span class=\"line\">[SYS_kill]    <span class=\"string\">\"kill\"</span>,</span><br><span class=\"line\">[SYS_exec]    <span class=\"string\">\"exec\"</span>,</span><br><span class=\"line\">[SYS_fstat]   <span class=\"string\">\"fstat\"</span>,</span><br><span class=\"line\">[SYS_chdir]   <span class=\"string\">\"chdir\"</span>,</span><br><span class=\"line\">[SYS_dup]     <span class=\"string\">\"dup\"</span>,</span><br><span class=\"line\">[SYS_getpid]  <span class=\"string\">\"getpid\"</span>,</span><br><span class=\"line\">[SYS_sbrk]    <span class=\"string\">\"sbrk\"</span>,</span><br><span class=\"line\">[SYS_sleep]   <span class=\"string\">\"sleep\"</span>,</span><br><span class=\"line\">[SYS_uptime]  <span class=\"string\">\"uptime\"</span>,</span><br><span class=\"line\">[SYS_open]    <span class=\"string\">\"open\"</span>,</span><br><span class=\"line\">[SYS_write]   <span class=\"string\">\"write\"</span>,</span><br><span class=\"line\">[SYS_mknod]   <span class=\"string\">\"mknod\"</span>,</span><br><span class=\"line\">[SYS_unlink]  <span class=\"string\">\"unlink\"</span>,</span><br><span class=\"line\">[SYS_link]    <span class=\"string\">\"link\"</span>,</span><br><span class=\"line\">[SYS_mkdir]   <span class=\"string\">\"mkdir\"</span>,</span><br><span class=\"line\">[SYS_close]   <span class=\"string\">\"close\"</span>,</span><br><span class=\"line\">[SYS_date]    <span class=\"string\">\"date\"</span>,</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">syscall(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> num;</span><br><span class=\"line\"></span><br><span class=\"line\">  num = proc-&gt;tf-&gt;eax;  <span class=\"comment\">//</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span>(num &gt; <span class=\"number\">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num])</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">    proc-&gt;tf-&gt;eax = syscalls[num]();  <span class=\"comment\">//</span></span><br><span class=\"line\">    cprintf(<span class=\"string\">\"%s -&gt; %d\\n\"</span>, syscalls_name[num], proc-&gt;tf-&gt;eax);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    cprintf(<span class=\"string\">\"%d %s: unknown sys call %d\\n\"</span>,</span><br><span class=\"line\">            proc-&gt;pid, proc-&gt;name, num);</span><br><span class=\"line\">    proc-&gt;tf-&gt;eax = <span class=\"number\">-1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"Part2-\"><a href=\"#Part2-\" class=\"headerlink\" title=\"Part2 \"></a>Part2 </h2><h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>date</code>,UTC.,xv6 shell<code>date</code>UTC.</p>\n</blockquote>\n<h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>cmostime()</code>(<code>lapic.c</code>),<code>date.h</code>struct rtcdate,<code>cmostime()</code>.<br><code>uptime</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grep -n uptime *.[chS]</span><br><span class=\"line\"><span class=\"meta\">#output</span></span><br><span class=\"line\">syscall.c: <span class=\"function\"><span class=\"keyword\">extern</span> <span class=\"keyword\">int</span> <span class=\"title\">sys_uptime</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span>;</span><br><span class=\"line\">syscall.c:[SYS_uptime] sys_uptime,</span><br><span class=\"line\">syscall.c:[SYS_uptime] <span class=\"string\">\"uptime\"</span>,</span><br><span class=\"line\">syscall.h:<span class=\"meta\">#<span class=\"meta-keyword\">define</span> SYS_uptime 14</span></span><br><span class=\"line\">sysproc.c:sys_uptime(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">user.h:<span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">uptime</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span>;</span><br><span class=\"line\">usys.S:SYSCALL(uptime)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>:</p>\n<ul>\n<li><code>syscall.h</code></li>\n<li><code>user.h</code></li>\n<li><code>usys.S</code></li>\n<li><code>syscall.c</code></li>\n<li><code>sysproc.c</code></li>\n</ul>\n</blockquote>\n<blockquote>\n<p>date<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">sys_date(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> rtcdate *r;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (argptr(<span class=\"number\">0</span>, (<span class=\"keyword\">void</span> *)&amp;r, <span class=\"keyword\">sizeof</span>(*r)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">          <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  cmostime(r);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>"},{"title":"hw2-shell","date":"2017-04-15T16:00:00.000Z","_content":"# hw2 shell\n## \nhw2xv6,linux,shell.\n:\n> * \n> * \n> * IO\n> * \n\n## part1: command\n### \n#### \n> ,,xv6 shell10.\n`#define MAXARGS 10`\n\n<!-- more -->\n\n#### \n> `struct cmd`cmd`struct`inttype.`struct *cmd`.C++struct cmdexeccmd, redircmd, pipecmd`struct *cmd`\n\n```c\npipecmd {\n\t- left = pipecmd {\n\t\t\t\t   - left: a\n\t\t\t\t   - right: b\n\t\t\t  }\n   - right = execcmd {\n   \t\t\t\t   - cmd: c\n       \t  }\n}\n\n// All commands have at least a type. Have looked at the type, the code\n// typically casts the *cmd to some specific cmd type.\nstruct cmd {\n  int type;          //  ' ' (exec), | (pipe), '<' or '>' for redirection\n};\n```\n#### execcmd\n> IOtype' '\n```c\nstruct execcmd {\n  int type;              // ' '\n  char *argv[MAXARGS];   // arguments to the command to be exec-ed\n};\n```\n#### redircmd\n\n> * \n> * \n> * \n> * \n> * \n```c\nstruct redircmd {\n  int type;          // < or >\n  struct cmd *cmd;   // the command to be run (e.g., an execcmd)\n  char *file;        // the input/output file\n  int mode;          // the mode to open the file with\n  int fd;            // the file descriptor number to use for the file\n};\n```\n#### pipecmd\npipecmd.\n```c\nstruct pipecmd {\n  int type;          // |\n  struct cmd *left;  // left side of pipe\n  struct cmd *right; // right side of pipe\n};\n```\n\n### \nruncmdruncmd:\n> * \n> * execcmd\n> * '>''<'\n> * '|'\n\n```c\n// Execute cmd.  Never returns.\nvoid runcmd(struct cmd *cmd)\n{\n  int p[2], r;\n  struct execcmd *ecmd;\n  struct pipecmd *pcmd;\n  struct redircmd *rcmd;\n  if(cmd == 0)\n    exit(0);\n  switch(cmd->type){\n  default:\n    fprintf(stderr, \"unknown runcmd\\n\");\n    exit(-1);\n  case ' ':\n    ecmd = (struct execcmd*)cmd;\n    if(ecmd->argv[0] == 0)\n      exit(0);\n    fprintf(stderr, \"exec not implemented\\n\");\n    // Your code here ...\n    break;\n  case '>':\n  case '<':\n    rcmd = (struct redircmd*)cmd;\n    fprintf(stderr, \"redir not implemented\\n\");\n    // Your code here ...\n    runcmd(rcmd->cmd);\n    break;\n  case '|':\n    pcmd = (struct pipecmd*)cmd;\n    fprintf(stderr, \"pipe not implemented\\n\");\n    // Your code here ...\n    break;\n  }\n  exit(0);\n}\n```\n\n### \ngetcmd:\n> * \"6.828$\"\n> * \n> * EOF-1\n```c\nint getcmd(char *buf, int nbuf)\n{\n  if (isatty(fileno(stdin)))\n    fprintf(stdout, \"6.828$ \");\n  memset(buf, 0, nbuf);\n  fgets(buf, nbuf, stdin);\n  if(buf[0] == 0) // EOF\n    return -1;\n  return 0;\n}\n```\n\n### \n,\n> * cdchdir\n> * forkrumcmd\n```c\nint main(void)\n{\n  static char buf[100];\n  int fd, r;\n  // Read and run input commands.\n  while(getcmd(buf, sizeof(buf)) >= 0){\n    if(buf[0] == 'c' && buf[1] == 'd' && buf[2] == ' '){\n      // Clumsy but will have to do for now.\n      // Chdir has no effect on the parent if run in the child.\n      buf[strlen(buf)-1] = 0;  // chop \\n\n      if(chdir(buf+3) < 0)\n        fprintf(stderr, \"cannot cd %s\\n\", buf+3);\n      continue;\n    }\n    if(fork1() == 0)\n      runcmd(parsecmd(buf));\n    wait(&r);\n  }\n  exit(0);\n}\n```\n\n### homework\n:\n```c\nvoid runcmd(struct cmd *cmd)\n{\n  int p[2], r;\n  struct execcmd *ecmd;\n  struct pipecmd *pcmd;\n  struct redircmd *rcmd;\n\n  char * path;\n  path = malloc(MAXPATH * sizeof(char*));\n\n  if(cmd == 0)\n    exit(0);\n\n  switch(cmd->type){\n  default:\n    fprintf(stderr, \"unknown runcmd\\n\");\n    exit(-1);\n\n  case ' ':\n    ecmd = (struct execcmd*)cmd;\n    if(ecmd->argv[0] == 0)\n      exit(0);\n\n    //  1: \n    strcat(path, ecmd->argv[0]);\n        // My code here...\n    strcpy(path, \"\");\n    strcat(path, ecmd->argv[0]);\n    if(!access(path, F_OK)) {\n      execv(path, ecmd->argv);\n      break;\n    }\n\n    strcpy(path, \"/bin/\");\n    strcat(path, ecmd->argv[0]);\n    if(!access(path, F_OK)) {\n      execv(path, ecmd->argv);\n      break;\n    }\n\n    strcpy(path, \"/usr/bin/\");\n    strcat(path, ecmd->argv[0]);\n    if(!access(path, F_OK)) {\n      execv(path, ecmd->argv);\n      break;\n    }\n\n    fprintf(stderr, \"exec not implemented\\n\");\n    break;\n\n  //  2: I/O  \n  case '>':\n  case '<':\n    rcmd = (struct redircmd*)cmd;\n\n    // sub 1. \n    close(rcmd->fd);\n\n    // sub 2. , (0777)\n    if (open(rcmd->flie, rcmd->mode, 0777) < 0) {\n      fprintf(stderr, \"open file %s failed.\", rcmd->file);\n      exit(0);\n    }\n\n    runcmd(rcmd->cmd);\n    break;\n\n  //  3. \n  case '|':\n    pcmd = (struct pipecmd*)cmd;\n\n    // sub 1. pipe(), \n    if(pipe(p) < 0){\n        fprintf(stderr, \"create pipe failed!\\n\");\n        exit(0);\n    }\n\n    // sub 2. , \n    if((fork() == 0)) {\n        close(STDOUT_FILENO);\n        dup(p[1]);\n        close(p[0]);\n        close(p[1]);\n        runcmd(pcmd->left);\n    } else {\n        close(0);\n        dup(p[0]);\n        close(p[0]);\n        close(p[1]);\n        runcmd(pcmd->right);\n    }\n    wait(&r);\n    break;\n  }\n  exit(0);\n}\n```\n\n## \n\n![call graph](http://img.blog.csdn.net/20150419132244069)\n> * |{block_a} | {block_b} | {block_c} | {block_d}forblockparseexec\n```c\nstruct cmd*\nparsepipe(char **ps, char *es)\n{\n  struct cmd *cmd;\n  cmd = parseexec(ps, es);\n  if(peek(ps, es, \"|\")){\n    gettoken(ps, es, 0, 0);\n    cmd = pipecmd(cmd, parsepipe(ps, es));\n  }\n  return cmd;\n}\n```\n> * parseexecexeccmd, redircmdC++cmd->execcmd->redircmdblock\n```c\nargc = 0;\nret = parseredirs(ret, ps, es);\nwhile(!peek(ps, es, \"|\")){\n  if((tok=gettoken(ps, es, &q, &eq)) == 0)\n    break;\n  if(tok != 'a') {\n    fprintf(stderr, \"syntax error\\n\");\n    exit(-1);\n  }\n  cmd->argv[argc] = mkcopy(q, eq);\n  argc++;\n  if(argc >= MAXARGS) {\n    fprintf(stderr, \"too many args\\n\");\n    exit(-1);\n  }\n  ret = parseredirs(ret, ps, es);\n}\ncmd->argv[argc] = 0;\n```\n> * IOparseredirs\n> * parseredirsexeccmd<input.txt>output.txt\n```c\nwhile(peek(ps, es, \"<>\")){\n  tok = gettoken(ps, es, 0, 0);\n  if(gettoken(ps, es, &q, &eq) != 'a') {\n    fprintf(stderr, \"missing file for redirection\\n\");\n    exit(-1);\n  }\n  switch(tok){\n  case '<':\n    cmd = redircmd(cmd, mkcopy(q, eq), '<');\n    break;\n  case '>':\n    cmd = redircmd(cmd, mkcopy(q, eq), '>');\n    break;\n  }\n}\n```\n\n## \n1. [hw2 shell](https://pdos.csail.mit.edu/6.828/2016/homework/xv6-shell.html)\n2. [xv6 system call](https://pdos.csail.mit.edu/6.828/2016/xv6/book-rev9.pdf)\n3. [6.828 shell](https://pdos.csail.mit.edu/6.828/2016/homework/sh.c)\n","source":"_posts/hw2.md","raw":"title: hw2-shell\ndate: 2017/04/16\ntags:\n\t- os\n\t- xv6\n\n---\n# hw2 shell\n## \nhw2xv6,linux,shell.\n:\n> * \n> * \n> * IO\n> * \n\n## part1: command\n### \n#### \n> ,,xv6 shell10.\n`#define MAXARGS 10`\n\n<!-- more -->\n\n#### \n> `struct cmd`cmd`struct`inttype.`struct *cmd`.C++struct cmdexeccmd, redircmd, pipecmd`struct *cmd`\n\n```c\npipecmd {\n\t- left = pipecmd {\n\t\t\t\t   - left: a\n\t\t\t\t   - right: b\n\t\t\t  }\n   - right = execcmd {\n   \t\t\t\t   - cmd: c\n       \t  }\n}\n\n// All commands have at least a type. Have looked at the type, the code\n// typically casts the *cmd to some specific cmd type.\nstruct cmd {\n  int type;          //  ' ' (exec), | (pipe), '<' or '>' for redirection\n};\n```\n#### execcmd\n> IOtype' '\n```c\nstruct execcmd {\n  int type;              // ' '\n  char *argv[MAXARGS];   // arguments to the command to be exec-ed\n};\n```\n#### redircmd\n\n> * \n> * \n> * \n> * \n> * \n```c\nstruct redircmd {\n  int type;          // < or >\n  struct cmd *cmd;   // the command to be run (e.g., an execcmd)\n  char *file;        // the input/output file\n  int mode;          // the mode to open the file with\n  int fd;            // the file descriptor number to use for the file\n};\n```\n#### pipecmd\npipecmd.\n```c\nstruct pipecmd {\n  int type;          // |\n  struct cmd *left;  // left side of pipe\n  struct cmd *right; // right side of pipe\n};\n```\n\n### \nruncmdruncmd:\n> * \n> * execcmd\n> * '>''<'\n> * '|'\n\n```c\n// Execute cmd.  Never returns.\nvoid runcmd(struct cmd *cmd)\n{\n  int p[2], r;\n  struct execcmd *ecmd;\n  struct pipecmd *pcmd;\n  struct redircmd *rcmd;\n  if(cmd == 0)\n    exit(0);\n  switch(cmd->type){\n  default:\n    fprintf(stderr, \"unknown runcmd\\n\");\n    exit(-1);\n  case ' ':\n    ecmd = (struct execcmd*)cmd;\n    if(ecmd->argv[0] == 0)\n      exit(0);\n    fprintf(stderr, \"exec not implemented\\n\");\n    // Your code here ...\n    break;\n  case '>':\n  case '<':\n    rcmd = (struct redircmd*)cmd;\n    fprintf(stderr, \"redir not implemented\\n\");\n    // Your code here ...\n    runcmd(rcmd->cmd);\n    break;\n  case '|':\n    pcmd = (struct pipecmd*)cmd;\n    fprintf(stderr, \"pipe not implemented\\n\");\n    // Your code here ...\n    break;\n  }\n  exit(0);\n}\n```\n\n### \ngetcmd:\n> * \"6.828$\"\n> * \n> * EOF-1\n```c\nint getcmd(char *buf, int nbuf)\n{\n  if (isatty(fileno(stdin)))\n    fprintf(stdout, \"6.828$ \");\n  memset(buf, 0, nbuf);\n  fgets(buf, nbuf, stdin);\n  if(buf[0] == 0) // EOF\n    return -1;\n  return 0;\n}\n```\n\n### \n,\n> * cdchdir\n> * forkrumcmd\n```c\nint main(void)\n{\n  static char buf[100];\n  int fd, r;\n  // Read and run input commands.\n  while(getcmd(buf, sizeof(buf)) >= 0){\n    if(buf[0] == 'c' && buf[1] == 'd' && buf[2] == ' '){\n      // Clumsy but will have to do for now.\n      // Chdir has no effect on the parent if run in the child.\n      buf[strlen(buf)-1] = 0;  // chop \\n\n      if(chdir(buf+3) < 0)\n        fprintf(stderr, \"cannot cd %s\\n\", buf+3);\n      continue;\n    }\n    if(fork1() == 0)\n      runcmd(parsecmd(buf));\n    wait(&r);\n  }\n  exit(0);\n}\n```\n\n### homework\n:\n```c\nvoid runcmd(struct cmd *cmd)\n{\n  int p[2], r;\n  struct execcmd *ecmd;\n  struct pipecmd *pcmd;\n  struct redircmd *rcmd;\n\n  char * path;\n  path = malloc(MAXPATH * sizeof(char*));\n\n  if(cmd == 0)\n    exit(0);\n\n  switch(cmd->type){\n  default:\n    fprintf(stderr, \"unknown runcmd\\n\");\n    exit(-1);\n\n  case ' ':\n    ecmd = (struct execcmd*)cmd;\n    if(ecmd->argv[0] == 0)\n      exit(0);\n\n    //  1: \n    strcat(path, ecmd->argv[0]);\n        // My code here...\n    strcpy(path, \"\");\n    strcat(path, ecmd->argv[0]);\n    if(!access(path, F_OK)) {\n      execv(path, ecmd->argv);\n      break;\n    }\n\n    strcpy(path, \"/bin/\");\n    strcat(path, ecmd->argv[0]);\n    if(!access(path, F_OK)) {\n      execv(path, ecmd->argv);\n      break;\n    }\n\n    strcpy(path, \"/usr/bin/\");\n    strcat(path, ecmd->argv[0]);\n    if(!access(path, F_OK)) {\n      execv(path, ecmd->argv);\n      break;\n    }\n\n    fprintf(stderr, \"exec not implemented\\n\");\n    break;\n\n  //  2: I/O  \n  case '>':\n  case '<':\n    rcmd = (struct redircmd*)cmd;\n\n    // sub 1. \n    close(rcmd->fd);\n\n    // sub 2. , (0777)\n    if (open(rcmd->flie, rcmd->mode, 0777) < 0) {\n      fprintf(stderr, \"open file %s failed.\", rcmd->file);\n      exit(0);\n    }\n\n    runcmd(rcmd->cmd);\n    break;\n\n  //  3. \n  case '|':\n    pcmd = (struct pipecmd*)cmd;\n\n    // sub 1. pipe(), \n    if(pipe(p) < 0){\n        fprintf(stderr, \"create pipe failed!\\n\");\n        exit(0);\n    }\n\n    // sub 2. , \n    if((fork() == 0)) {\n        close(STDOUT_FILENO);\n        dup(p[1]);\n        close(p[0]);\n        close(p[1]);\n        runcmd(pcmd->left);\n    } else {\n        close(0);\n        dup(p[0]);\n        close(p[0]);\n        close(p[1]);\n        runcmd(pcmd->right);\n    }\n    wait(&r);\n    break;\n  }\n  exit(0);\n}\n```\n\n## \n\n![call graph](http://img.blog.csdn.net/20150419132244069)\n> * |{block_a} | {block_b} | {block_c} | {block_d}forblockparseexec\n```c\nstruct cmd*\nparsepipe(char **ps, char *es)\n{\n  struct cmd *cmd;\n  cmd = parseexec(ps, es);\n  if(peek(ps, es, \"|\")){\n    gettoken(ps, es, 0, 0);\n    cmd = pipecmd(cmd, parsepipe(ps, es));\n  }\n  return cmd;\n}\n```\n> * parseexecexeccmd, redircmdC++cmd->execcmd->redircmdblock\n```c\nargc = 0;\nret = parseredirs(ret, ps, es);\nwhile(!peek(ps, es, \"|\")){\n  if((tok=gettoken(ps, es, &q, &eq)) == 0)\n    break;\n  if(tok != 'a') {\n    fprintf(stderr, \"syntax error\\n\");\n    exit(-1);\n  }\n  cmd->argv[argc] = mkcopy(q, eq);\n  argc++;\n  if(argc >= MAXARGS) {\n    fprintf(stderr, \"too many args\\n\");\n    exit(-1);\n  }\n  ret = parseredirs(ret, ps, es);\n}\ncmd->argv[argc] = 0;\n```\n> * IOparseredirs\n> * parseredirsexeccmd<input.txt>output.txt\n```c\nwhile(peek(ps, es, \"<>\")){\n  tok = gettoken(ps, es, 0, 0);\n  if(gettoken(ps, es, &q, &eq) != 'a') {\n    fprintf(stderr, \"missing file for redirection\\n\");\n    exit(-1);\n  }\n  switch(tok){\n  case '<':\n    cmd = redircmd(cmd, mkcopy(q, eq), '<');\n    break;\n  case '>':\n    cmd = redircmd(cmd, mkcopy(q, eq), '>');\n    break;\n  }\n}\n```\n\n## \n1. [hw2 shell](https://pdos.csail.mit.edu/6.828/2016/homework/xv6-shell.html)\n2. [xv6 system call](https://pdos.csail.mit.edu/6.828/2016/xv6/book-rev9.pdf)\n3. [6.828 shell](https://pdos.csail.mit.edu/6.828/2016/homework/sh.c)\n","slug":"hw2","published":1,"updated":"2017-08-26T03:38:21.614Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3gz000ms7am464mi479","content":"<h1 id=\"hw2-shell\"><a href=\"#hw2-shell\" class=\"headerlink\" title=\"hw2 shell\"></a>hw2 shell</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>hw2xv6,linux,shell.<br>:</p>\n<blockquote>\n<ul>\n<li></li>\n<li></li>\n<li>IO</li>\n<li></li>\n</ul>\n</blockquote>\n<h2 id=\"part1-command\"><a href=\"#part1-command\" class=\"headerlink\" title=\"part1: command\"></a>part1: command</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>,,xv6 shell10.<br><code>#define MAXARGS 10</code></p>\n</blockquote>\n<a id=\"more\"></a>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p><code>struct cmd</code>cmd<code>struct</code>inttype.<code>struct *cmd</code>.C++struct cmdexeccmd, redircmd, pipecmd<code>struct *cmd</code><br><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipecmd &#123;</span><br><span class=\"line\">\t- left = pipecmd &#123;</span><br><span class=\"line\">\t\t\t\t   - left: a</span><br><span class=\"line\">\t\t\t\t   - right: b</span><br><span class=\"line\">\t\t\t  &#125;</span><br><span class=\"line\">   - right = execcmd &#123;</span><br><span class=\"line\">   \t\t\t\t   - cmd: c</span><br><span class=\"line\">       \t  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// All commands have at least a type. Have looked at the type, the code</span></span><br><span class=\"line\"><span class=\"comment\">// typically casts the *cmd to some specific cmd type.</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> cmd &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> type;          <span class=\"comment\">//  ' ' (exec), | (pipe), '&lt;' or '&gt;' for redirection</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"execcmd\"><a href=\"#execcmd\" class=\"headerlink\" title=\"execcmd\"></a>execcmd</h4><blockquote>\n<p>IOtype <br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> execcmd &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> type;              <span class=\"comment\">// ' '</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> *argv[MAXARGS];   <span class=\"comment\">// arguments to the command to be exec-ed</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"redircmd\"><a href=\"#redircmd\" class=\"headerlink\" title=\"redircmd\"></a>redircmd</h4><p></p>\n<blockquote>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> redircmd &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> type;          <span class=\"comment\">// &lt; or &gt;</span></span><br><span class=\"line\">  <span class=\"keyword\">struct</span> cmd *cmd;   <span class=\"comment\">// the command to be run (e.g., an execcmd)</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> *file;        <span class=\"comment\">// the input/output file</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> mode;          <span class=\"comment\">// the mode to open the file with</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> fd;            <span class=\"comment\">// the file descriptor number to use for the file</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h4 id=\"pipecmd\"><a href=\"#pipecmd\" class=\"headerlink\" title=\"pipecmd\"></a>pipecmd</h4><p>pipecmd.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> pipecmd &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> type;          <span class=\"comment\">// |</span></span><br><span class=\"line\">  <span class=\"keyword\">struct</span> cmd *left;  <span class=\"comment\">// left side of pipe</span></span><br><span class=\"line\">  <span class=\"keyword\">struct</span> cmd *right; <span class=\"comment\">// right side of pipe</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>runcmdruncmd:</p>\n<blockquote>\n<ul>\n<li></li>\n<li>execcmd</li>\n<li>&gt;&lt;</li>\n<li>|<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Execute cmd.  Never returns.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">runcmd</span><span class=\"params\">(<span class=\"keyword\">struct</span> cmd *cmd)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> p[<span class=\"number\">2</span>], r;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> execcmd *ecmd;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> pipecmd *pcmd;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> redircmd *rcmd;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(cmd == <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">switch</span>(cmd-&gt;type)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">default</span>:</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"unknown runcmd\\n\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">' '</span>:</span><br><span class=\"line\">    ecmd = (<span class=\"keyword\">struct</span> execcmd*)cmd;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(ecmd-&gt;argv[<span class=\"number\">0</span>] == <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"exec not implemented\\n\"</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Your code here ...</span></span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&gt;'</span>:</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&lt;'</span>:</span><br><span class=\"line\">    rcmd = (<span class=\"keyword\">struct</span> redircmd*)cmd;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"redir not implemented\\n\"</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Your code here ...</span></span><br><span class=\"line\">    runcmd(rcmd-&gt;cmd);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'|'</span>:</span><br><span class=\"line\">    pcmd = (<span class=\"keyword\">struct</span> pipecmd*)cmd;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"pipe not implemented\\n\"</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Your code here ...</span></span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>getcmd:</p>\n<blockquote>\n<ul>\n<li>6.828$</li>\n<li></li>\n<li>EOF-1<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getcmd</span><span class=\"params\">(<span class=\"keyword\">char</span> *buf, <span class=\"keyword\">int</span> nbuf)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isatty(fileno(<span class=\"built_in\">stdin</span>)))</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stdout</span>, <span class=\"string\">\"6.828$ \"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(buf, <span class=\"number\">0</span>, nbuf);</span><br><span class=\"line\">  fgets(buf, nbuf, <span class=\"built_in\">stdin</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(buf[<span class=\"number\">0</span>] == <span class=\"number\">0</span>) <span class=\"comment\">// EOF</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>,</p>\n<blockquote>\n<ul>\n<li>cdchdir</li>\n<li>forkrumcmd<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">static</span> <span class=\"keyword\">char</span> buf[<span class=\"number\">100</span>];</span><br><span class=\"line\">  <span class=\"keyword\">int</span> fd, r;</span><br><span class=\"line\">  <span class=\"comment\">// Read and run input commands.</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span>(getcmd(buf, <span class=\"keyword\">sizeof</span>(buf)) &gt;= <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(buf[<span class=\"number\">0</span>] == <span class=\"string\">'c'</span> &amp;&amp; buf[<span class=\"number\">1</span>] == <span class=\"string\">'d'</span> &amp;&amp; buf[<span class=\"number\">2</span>] == <span class=\"string\">' '</span>)&#123;</span><br><span class=\"line\">      <span class=\"comment\">// Clumsy but will have to do for now.</span></span><br><span class=\"line\">      <span class=\"comment\">// Chdir has no effect on the parent if run in the child.</span></span><br><span class=\"line\">      buf[<span class=\"built_in\">strlen</span>(buf)<span class=\"number\">-1</span>] = <span class=\"number\">0</span>;  <span class=\"comment\">// chop \\n</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(chdir(buf+<span class=\"number\">3</span>) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"cannot cd %s\\n\"</span>, buf+<span class=\"number\">3</span>);</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(fork1() == <span class=\"number\">0</span>)</span><br><span class=\"line\">      runcmd(parsecmd(buf));</span><br><span class=\"line\">    wait(&amp;r);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"homework\"><a href=\"#homework\" class=\"headerlink\" title=\"homework\"></a>homework</h3><p>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">runcmd</span><span class=\"params\">(<span class=\"keyword\">struct</span> cmd *cmd)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> p[<span class=\"number\">2</span>], r;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> execcmd *ecmd;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> pipecmd *pcmd;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> redircmd *rcmd;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">char</span> * path;</span><br><span class=\"line\">  path = <span class=\"built_in\">malloc</span>(MAXPATH * <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">char</span>*));</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span>(cmd == <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">switch</span>(cmd-&gt;type)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">default</span>:</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"unknown runcmd\\n\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">' '</span>:</span><br><span class=\"line\">    ecmd = (<span class=\"keyword\">struct</span> execcmd*)cmd;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(ecmd-&gt;argv[<span class=\"number\">0</span>] == <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  1: </span></span><br><span class=\"line\">    <span class=\"built_in\">strcat</span>(path, ecmd-&gt;argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        <span class=\"comment\">// My code here...</span></span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(path, <span class=\"string\">\"\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">strcat</span>(path, ecmd-&gt;argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!access(path, F_OK)) &#123;</span><br><span class=\"line\">      execv(path, ecmd-&gt;argv);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(path, <span class=\"string\">\"/bin/\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">strcat</span>(path, ecmd-&gt;argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!access(path, F_OK)) &#123;</span><br><span class=\"line\">      execv(path, ecmd-&gt;argv);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(path, <span class=\"string\">\"/usr/bin/\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">strcat</span>(path, ecmd-&gt;argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!access(path, F_OK)) &#123;</span><br><span class=\"line\">      execv(path, ecmd-&gt;argv);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"exec not implemented\\n\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  2: I/O  </span></span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&gt;'</span>:</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&lt;'</span>:</span><br><span class=\"line\">    rcmd = (<span class=\"keyword\">struct</span> redircmd*)cmd;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sub 1. </span></span><br><span class=\"line\">    close(rcmd-&gt;fd);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sub 2. , (0777)</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (open(rcmd-&gt;flie, rcmd-&gt;mode, <span class=\"number\">0777</span>) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">      <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"open file %s failed.\"</span>, rcmd-&gt;file);</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    runcmd(rcmd-&gt;cmd);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  3. </span></span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'|'</span>:</span><br><span class=\"line\">    pcmd = (<span class=\"keyword\">struct</span> pipecmd*)cmd;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sub 1. pipe(), </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(pipe(p) &lt; <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"create pipe failed!\\n\"</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sub 2. , </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>((fork() == <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">        close(STDOUT_FILENO);</span><br><span class=\"line\">        dup(p[<span class=\"number\">1</span>]);</span><br><span class=\"line\">        close(p[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        close(p[<span class=\"number\">1</span>]);</span><br><span class=\"line\">        runcmd(pcmd-&gt;left);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        close(<span class=\"number\">0</span>);</span><br><span class=\"line\">        dup(p[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        close(p[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        close(p[<span class=\"number\">1</span>]);</span><br><span class=\"line\">        runcmd(pcmd-&gt;right);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    wait(&amp;r);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><br><img src=\"http://img.blog.csdn.net/20150419132244069\" alt=\"call graph\"></p>\n<blockquote>\n<ul>\n<li>|{block_a} | {block_b} | {block_c} | {block_d}forblockparseexec<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> cmd*</span><br><span class=\"line\">parsepipe(<span class=\"keyword\">char</span> **ps, <span class=\"keyword\">char</span> *es)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> cmd *cmd;</span><br><span class=\"line\">  cmd = parseexec(ps, es);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(peek(ps, es, <span class=\"string\">\"|\"</span>))&#123;</span><br><span class=\"line\">    gettoken(ps, es, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    cmd = pipecmd(cmd, parsepipe(ps, es));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> cmd;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>parseexecexeccmd, redircmdC++cmd-&gt;execcmd-&gt;redircmdblock<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">argc = <span class=\"number\">0</span>;</span><br><span class=\"line\">ret = parseredirs(ret, ps, es);</span><br><span class=\"line\"><span class=\"keyword\">while</span>(!peek(ps, es, <span class=\"string\">\"|\"</span>))&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>((tok=gettoken(ps, es, &amp;q, &amp;eq)) == <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(tok != <span class=\"string\">'a'</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"syntax error\\n\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  cmd-&gt;argv[argc] = mkcopy(q, eq);</span><br><span class=\"line\">  argc++;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(argc &gt;= MAXARGS) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"too many args\\n\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ret = parseredirs(ret, ps, es);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">cmd-&gt;argv[argc] = <span class=\"number\">0</span>;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>IOparseredirs</li>\n<li>parseredirsexeccmd&lt;input.txt&gt;output.txt<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span>(peek(ps, es, <span class=\"string\">\"&lt;&gt;\"</span>))&#123;</span><br><span class=\"line\">  tok = gettoken(ps, es, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(gettoken(ps, es, &amp;q, &amp;eq) != <span class=\"string\">'a'</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"missing file for redirection\\n\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">switch</span>(tok)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&lt;'</span>:</span><br><span class=\"line\">    cmd = redircmd(cmd, mkcopy(q, eq), <span class=\"string\">'&lt;'</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&gt;'</span>:</span><br><span class=\"line\">    cmd = redircmd(cmd, mkcopy(q, eq), <span class=\"string\">'&gt;'</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/homework/xv6-shell.html\" target=\"_blank\" rel=\"noopener\">hw2 shell</a></li>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/xv6/book-rev9.pdf\" target=\"_blank\" rel=\"noopener\">xv6 system call</a></li>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/homework/sh.c\" target=\"_blank\" rel=\"noopener\">6.828 shell</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"<h1 id=\"hw2-shell\"><a href=\"#hw2-shell\" class=\"headerlink\" title=\"hw2 shell\"></a>hw2 shell</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>hw2xv6,linux,shell.<br>:</p>\n<blockquote>\n<ul>\n<li></li>\n<li></li>\n<li>IO</li>\n<li></li>\n</ul>\n</blockquote>\n<h2 id=\"part1-command\"><a href=\"#part1-command\" class=\"headerlink\" title=\"part1: command\"></a>part1: command</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>,,xv6 shell10.<br><code>#define MAXARGS 10</code></p>\n</blockquote>","more":"<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p><code>struct cmd</code>cmd<code>struct</code>inttype.<code>struct *cmd</code>.C++struct cmdexeccmd, redircmd, pipecmd<code>struct *cmd</code><br><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipecmd &#123;</span><br><span class=\"line\">\t- left = pipecmd &#123;</span><br><span class=\"line\">\t\t\t\t   - left: a</span><br><span class=\"line\">\t\t\t\t   - right: b</span><br><span class=\"line\">\t\t\t  &#125;</span><br><span class=\"line\">   - right = execcmd &#123;</span><br><span class=\"line\">   \t\t\t\t   - cmd: c</span><br><span class=\"line\">       \t  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// All commands have at least a type. Have looked at the type, the code</span></span><br><span class=\"line\"><span class=\"comment\">// typically casts the *cmd to some specific cmd type.</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> cmd &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> type;          <span class=\"comment\">//  ' ' (exec), | (pipe), '&lt;' or '&gt;' for redirection</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"execcmd\"><a href=\"#execcmd\" class=\"headerlink\" title=\"execcmd\"></a>execcmd</h4><blockquote>\n<p>IOtype <br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> execcmd &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> type;              <span class=\"comment\">// ' '</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> *argv[MAXARGS];   <span class=\"comment\">// arguments to the command to be exec-ed</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"redircmd\"><a href=\"#redircmd\" class=\"headerlink\" title=\"redircmd\"></a>redircmd</h4><p></p>\n<blockquote>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> redircmd &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> type;          <span class=\"comment\">// &lt; or &gt;</span></span><br><span class=\"line\">  <span class=\"keyword\">struct</span> cmd *cmd;   <span class=\"comment\">// the command to be run (e.g., an execcmd)</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> *file;        <span class=\"comment\">// the input/output file</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> mode;          <span class=\"comment\">// the mode to open the file with</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> fd;            <span class=\"comment\">// the file descriptor number to use for the file</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h4 id=\"pipecmd\"><a href=\"#pipecmd\" class=\"headerlink\" title=\"pipecmd\"></a>pipecmd</h4><p>pipecmd.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> pipecmd &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> type;          <span class=\"comment\">// |</span></span><br><span class=\"line\">  <span class=\"keyword\">struct</span> cmd *left;  <span class=\"comment\">// left side of pipe</span></span><br><span class=\"line\">  <span class=\"keyword\">struct</span> cmd *right; <span class=\"comment\">// right side of pipe</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>runcmdruncmd:</p>\n<blockquote>\n<ul>\n<li></li>\n<li>execcmd</li>\n<li>&gt;&lt;</li>\n<li>|<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Execute cmd.  Never returns.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">runcmd</span><span class=\"params\">(<span class=\"keyword\">struct</span> cmd *cmd)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> p[<span class=\"number\">2</span>], r;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> execcmd *ecmd;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> pipecmd *pcmd;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> redircmd *rcmd;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(cmd == <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">switch</span>(cmd-&gt;type)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">default</span>:</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"unknown runcmd\\n\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">' '</span>:</span><br><span class=\"line\">    ecmd = (<span class=\"keyword\">struct</span> execcmd*)cmd;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(ecmd-&gt;argv[<span class=\"number\">0</span>] == <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"exec not implemented\\n\"</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Your code here ...</span></span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&gt;'</span>:</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&lt;'</span>:</span><br><span class=\"line\">    rcmd = (<span class=\"keyword\">struct</span> redircmd*)cmd;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"redir not implemented\\n\"</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Your code here ...</span></span><br><span class=\"line\">    runcmd(rcmd-&gt;cmd);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'|'</span>:</span><br><span class=\"line\">    pcmd = (<span class=\"keyword\">struct</span> pipecmd*)cmd;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"pipe not implemented\\n\"</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Your code here ...</span></span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>getcmd:</p>\n<blockquote>\n<ul>\n<li>6.828$</li>\n<li></li>\n<li>EOF-1<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getcmd</span><span class=\"params\">(<span class=\"keyword\">char</span> *buf, <span class=\"keyword\">int</span> nbuf)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isatty(fileno(<span class=\"built_in\">stdin</span>)))</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stdout</span>, <span class=\"string\">\"6.828$ \"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(buf, <span class=\"number\">0</span>, nbuf);</span><br><span class=\"line\">  fgets(buf, nbuf, <span class=\"built_in\">stdin</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(buf[<span class=\"number\">0</span>] == <span class=\"number\">0</span>) <span class=\"comment\">// EOF</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>,</p>\n<blockquote>\n<ul>\n<li>cdchdir</li>\n<li>forkrumcmd<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">static</span> <span class=\"keyword\">char</span> buf[<span class=\"number\">100</span>];</span><br><span class=\"line\">  <span class=\"keyword\">int</span> fd, r;</span><br><span class=\"line\">  <span class=\"comment\">// Read and run input commands.</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span>(getcmd(buf, <span class=\"keyword\">sizeof</span>(buf)) &gt;= <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(buf[<span class=\"number\">0</span>] == <span class=\"string\">'c'</span> &amp;&amp; buf[<span class=\"number\">1</span>] == <span class=\"string\">'d'</span> &amp;&amp; buf[<span class=\"number\">2</span>] == <span class=\"string\">' '</span>)&#123;</span><br><span class=\"line\">      <span class=\"comment\">// Clumsy but will have to do for now.</span></span><br><span class=\"line\">      <span class=\"comment\">// Chdir has no effect on the parent if run in the child.</span></span><br><span class=\"line\">      buf[<span class=\"built_in\">strlen</span>(buf)<span class=\"number\">-1</span>] = <span class=\"number\">0</span>;  <span class=\"comment\">// chop \\n</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(chdir(buf+<span class=\"number\">3</span>) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"cannot cd %s\\n\"</span>, buf+<span class=\"number\">3</span>);</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(fork1() == <span class=\"number\">0</span>)</span><br><span class=\"line\">      runcmd(parsecmd(buf));</span><br><span class=\"line\">    wait(&amp;r);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"homework\"><a href=\"#homework\" class=\"headerlink\" title=\"homework\"></a>homework</h3><p>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">runcmd</span><span class=\"params\">(<span class=\"keyword\">struct</span> cmd *cmd)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> p[<span class=\"number\">2</span>], r;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> execcmd *ecmd;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> pipecmd *pcmd;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> redircmd *rcmd;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">char</span> * path;</span><br><span class=\"line\">  path = <span class=\"built_in\">malloc</span>(MAXPATH * <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">char</span>*));</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span>(cmd == <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">switch</span>(cmd-&gt;type)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">default</span>:</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"unknown runcmd\\n\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">' '</span>:</span><br><span class=\"line\">    ecmd = (<span class=\"keyword\">struct</span> execcmd*)cmd;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(ecmd-&gt;argv[<span class=\"number\">0</span>] == <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  1: </span></span><br><span class=\"line\">    <span class=\"built_in\">strcat</span>(path, ecmd-&gt;argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        <span class=\"comment\">// My code here...</span></span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(path, <span class=\"string\">\"\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">strcat</span>(path, ecmd-&gt;argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!access(path, F_OK)) &#123;</span><br><span class=\"line\">      execv(path, ecmd-&gt;argv);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(path, <span class=\"string\">\"/bin/\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">strcat</span>(path, ecmd-&gt;argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!access(path, F_OK)) &#123;</span><br><span class=\"line\">      execv(path, ecmd-&gt;argv);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(path, <span class=\"string\">\"/usr/bin/\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">strcat</span>(path, ecmd-&gt;argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!access(path, F_OK)) &#123;</span><br><span class=\"line\">      execv(path, ecmd-&gt;argv);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"exec not implemented\\n\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  2: I/O  </span></span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&gt;'</span>:</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&lt;'</span>:</span><br><span class=\"line\">    rcmd = (<span class=\"keyword\">struct</span> redircmd*)cmd;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sub 1. </span></span><br><span class=\"line\">    close(rcmd-&gt;fd);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sub 2. , (0777)</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (open(rcmd-&gt;flie, rcmd-&gt;mode, <span class=\"number\">0777</span>) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">      <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"open file %s failed.\"</span>, rcmd-&gt;file);</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    runcmd(rcmd-&gt;cmd);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  3. </span></span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'|'</span>:</span><br><span class=\"line\">    pcmd = (<span class=\"keyword\">struct</span> pipecmd*)cmd;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sub 1. pipe(), </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(pipe(p) &lt; <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"create pipe failed!\\n\"</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sub 2. , </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>((fork() == <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">        close(STDOUT_FILENO);</span><br><span class=\"line\">        dup(p[<span class=\"number\">1</span>]);</span><br><span class=\"line\">        close(p[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        close(p[<span class=\"number\">1</span>]);</span><br><span class=\"line\">        runcmd(pcmd-&gt;left);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        close(<span class=\"number\">0</span>);</span><br><span class=\"line\">        dup(p[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        close(p[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        close(p[<span class=\"number\">1</span>]);</span><br><span class=\"line\">        runcmd(pcmd-&gt;right);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    wait(&amp;r);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><br><img src=\"http://img.blog.csdn.net/20150419132244069\" alt=\"call graph\"></p>\n<blockquote>\n<ul>\n<li>|{block_a} | {block_b} | {block_c} | {block_d}forblockparseexec<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> cmd*</span><br><span class=\"line\">parsepipe(<span class=\"keyword\">char</span> **ps, <span class=\"keyword\">char</span> *es)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> cmd *cmd;</span><br><span class=\"line\">  cmd = parseexec(ps, es);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(peek(ps, es, <span class=\"string\">\"|\"</span>))&#123;</span><br><span class=\"line\">    gettoken(ps, es, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    cmd = pipecmd(cmd, parsepipe(ps, es));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> cmd;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>parseexecexeccmd, redircmdC++cmd-&gt;execcmd-&gt;redircmdblock<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">argc = <span class=\"number\">0</span>;</span><br><span class=\"line\">ret = parseredirs(ret, ps, es);</span><br><span class=\"line\"><span class=\"keyword\">while</span>(!peek(ps, es, <span class=\"string\">\"|\"</span>))&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>((tok=gettoken(ps, es, &amp;q, &amp;eq)) == <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(tok != <span class=\"string\">'a'</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"syntax error\\n\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  cmd-&gt;argv[argc] = mkcopy(q, eq);</span><br><span class=\"line\">  argc++;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(argc &gt;= MAXARGS) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"too many args\\n\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ret = parseredirs(ret, ps, es);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">cmd-&gt;argv[argc] = <span class=\"number\">0</span>;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<blockquote>\n<ul>\n<li>IOparseredirs</li>\n<li>parseredirsexeccmd&lt;input.txt&gt;output.txt<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span>(peek(ps, es, <span class=\"string\">\"&lt;&gt;\"</span>))&#123;</span><br><span class=\"line\">  tok = gettoken(ps, es, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(gettoken(ps, es, &amp;q, &amp;eq) != <span class=\"string\">'a'</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"missing file for redirection\\n\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">switch</span>(tok)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&lt;'</span>:</span><br><span class=\"line\">    cmd = redircmd(cmd, mkcopy(q, eq), <span class=\"string\">'&lt;'</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  <span class=\"keyword\">case</span> <span class=\"string\">'&gt;'</span>:</span><br><span class=\"line\">    cmd = redircmd(cmd, mkcopy(q, eq), <span class=\"string\">'&gt;'</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/homework/xv6-shell.html\" target=\"_blank\" rel=\"noopener\">hw2 shell</a></li>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/xv6/book-rev9.pdf\" target=\"_blank\" rel=\"noopener\">xv6 system call</a></li>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/homework/sh.c\" target=\"_blank\" rel=\"noopener\">6.828 shell</a></li>\n</ol>"},{"title":"hw4-lazy-page-allocation","date":"2017-04-20T16:00:00.000Z","_content":"# hw4 lazy page allocation\n## \n> OS ****.,`malloc()`,`sbrk`.`sbrk`,.,,(sparse array).allocation,`page fault`,.  -\n\n## Part1 'sbrk'\n### \n> `sbrk(n)`,`sysproc.c``sys_sbrk()`.`sbrk(n)`n,.\n\n<!-- more -->\n\n### \n> `sbrk``sys_sbrk()`,`growproc()`n,.\n``` c\n//sysproc.c\nint\nsys_sbrk(void)\n{\n  int addr, newsz;\n  int n;\n\n  if(argint(0, &n) < 0)\n    return -1;\n  addr = proc->sz;\n  newsz = addr + n;\n  if (newsz >= KERNBASE)\n      return -1;\n  proc->sz = newsz;\n  return addr;\n}\n```\n> xv6,`echo hi`,\n``` bash\npid 3 sh: trap 14 err 6 on cpu 0 eip 0x12f1 addr 0x4004--kill proc\n```\n> shell`echo`,`malloc`.`malloc`,,cmd,,`sys_sbrk``growproc()`.\n\n## Part2 \n### \n> ,,trap.c.,`echo`.\n\n### \n> `trap.c`,`page fault`,`proc->sz`.`page fault`,(lazy allocation),,`proc->sz`.\n`page fault``malloc`,`proc->sz`,.\n``` c\nif (tf->trapno == T_PGFLT) {\n      char* mem;\n      uint a;\n\n      a = PGROUNDDOWN(rcr2()); //rcr2()\n      mem = kalloc();\n      if (mem == 0) {\n          cprintf(\"run out of memory!\\n\");\n          proc->killed = 1;\n          break;\n      }\n      memset(mem, 0, PGSIZE);\n      mappages(proc->pgdir, (char*)a, PGSIZE, v2p(mem), PTE_W|PTE_U);\n      break;\n}\n```\n","source":"_posts/hw4.md","raw":"title: hw4-lazy-page-allocation\ndate: 2017/04/21\ntags:\n\t- os\n\t- xv6\n\n---\n# hw4 lazy page allocation\n## \n> OS ****.,`malloc()`,`sbrk`.`sbrk`,.,,(sparse array).allocation,`page fault`,.  -\n\n## Part1 'sbrk'\n### \n> `sbrk(n)`,`sysproc.c``sys_sbrk()`.`sbrk(n)`n,.\n\n<!-- more -->\n\n### \n> `sbrk``sys_sbrk()`,`growproc()`n,.\n``` c\n//sysproc.c\nint\nsys_sbrk(void)\n{\n  int addr, newsz;\n  int n;\n\n  if(argint(0, &n) < 0)\n    return -1;\n  addr = proc->sz;\n  newsz = addr + n;\n  if (newsz >= KERNBASE)\n      return -1;\n  proc->sz = newsz;\n  return addr;\n}\n```\n> xv6,`echo hi`,\n``` bash\npid 3 sh: trap 14 err 6 on cpu 0 eip 0x12f1 addr 0x4004--kill proc\n```\n> shell`echo`,`malloc`.`malloc`,,cmd,,`sys_sbrk``growproc()`.\n\n## Part2 \n### \n> ,,trap.c.,`echo`.\n\n### \n> `trap.c`,`page fault`,`proc->sz`.`page fault`,(lazy allocation),,`proc->sz`.\n`page fault``malloc`,`proc->sz`,.\n``` c\nif (tf->trapno == T_PGFLT) {\n      char* mem;\n      uint a;\n\n      a = PGROUNDDOWN(rcr2()); //rcr2()\n      mem = kalloc();\n      if (mem == 0) {\n          cprintf(\"run out of memory!\\n\");\n          proc->killed = 1;\n          break;\n      }\n      memset(mem, 0, PGSIZE);\n      mappages(proc->pgdir, (char*)a, PGSIZE, v2p(mem), PTE_W|PTE_U);\n      break;\n}\n```\n","slug":"hw4","published":1,"updated":"2017-08-26T03:38:21.598Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3h2000os7amc7lrw3f3","content":"<h1 id=\"hw4-lazy-page-allocation\"><a href=\"#hw4-lazy-page-allocation\" class=\"headerlink\" title=\"hw4 lazy page allocation\"></a>hw4 lazy page allocation</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><blockquote>\n<p>OS <strong></strong>.,<code>malloc()</code>,<code>sbrk</code>.<code>sbrk</code>,.,,(sparse array).allocation,<code>page fault</code>,.  -</p>\n</blockquote>\n<h2 id=\"Part1-sbrk\"><a href=\"#Part1-sbrk\" class=\"headerlink\" title=\"Part1 sbrk\"></a>Part1 sbrk</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>sbrk(n)</code>,<code>sysproc.c</code><code>sys_sbrk()</code>.<code>sbrk(n)</code>n,.</p>\n</blockquote>\n<a id=\"more\"></a>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>sbrk</code><code>sys_sbrk()</code>,<code>growproc()</code>n,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//sysproc.c</span></span><br><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">sys_sbrk(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> addr, newsz;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> n;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span>(argint(<span class=\"number\">0</span>, &amp;n) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  addr = proc-&gt;sz;</span><br><span class=\"line\">  newsz = addr + n;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (newsz &gt;= KERNBASE)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  proc-&gt;sz = newsz;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> addr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>xv6,<code>echo hi</code>,<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pid 3 sh: <span class=\"built_in\">trap</span> 14 err 6 on cpu 0 eip 0x12f1 addr 0x4004--kill proc</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>shell<code>echo</code>,<code>malloc</code>.<code>malloc</code>,,cmd,,<code>sys_sbrk</code><code>growproc()</code>.</p>\n</blockquote>\n<h2 id=\"Part2-\"><a href=\"#Part2-\" class=\"headerlink\" title=\"Part2 \"></a>Part2 </h2><h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>,,trap.c.,<code>echo</code>.</p>\n</blockquote>\n<h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>trap.c</code>,<code>page fault</code>,<code>proc-&gt;sz</code>.<code>page fault</code>,(lazy allocation),,<code>proc-&gt;sz</code>.<br><code>page fault</code><code>malloc</code>,<code>proc-&gt;sz</code>,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (tf-&gt;trapno == T_PGFLT) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">char</span>* mem;</span><br><span class=\"line\">      uint a;</span><br><span class=\"line\"></span><br><span class=\"line\">      a = PGROUNDDOWN(rcr2()); <span class=\"comment\">//rcr2()</span></span><br><span class=\"line\">      mem = kalloc();</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (mem == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">          cprintf(<span class=\"string\">\"run out of memory!\\n\"</span>);</span><br><span class=\"line\">          proc-&gt;killed = <span class=\"number\">1</span>;</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"built_in\">memset</span>(mem, <span class=\"number\">0</span>, PGSIZE);</span><br><span class=\"line\">      mappages(proc-&gt;pgdir, (<span class=\"keyword\">char</span>*)a, PGSIZE, v2p(mem), PTE_W|PTE_U);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<h1 id=\"hw4-lazy-page-allocation\"><a href=\"#hw4-lazy-page-allocation\" class=\"headerlink\" title=\"hw4 lazy page allocation\"></a>hw4 lazy page allocation</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><blockquote>\n<p>OS <strong></strong>.,<code>malloc()</code>,<code>sbrk</code>.<code>sbrk</code>,.,,(sparse array).allocation,<code>page fault</code>,.  -</p>\n</blockquote>\n<h2 id=\"Part1-sbrk\"><a href=\"#Part1-sbrk\" class=\"headerlink\" title=\"Part1 sbrk\"></a>Part1 sbrk</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>sbrk(n)</code>,<code>sysproc.c</code><code>sys_sbrk()</code>.<code>sbrk(n)</code>n,.</p>\n</blockquote>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>sbrk</code><code>sys_sbrk()</code>,<code>growproc()</code>n,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//sysproc.c</span></span><br><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">sys_sbrk(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> addr, newsz;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> n;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span>(argint(<span class=\"number\">0</span>, &amp;n) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  addr = proc-&gt;sz;</span><br><span class=\"line\">  newsz = addr + n;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (newsz &gt;= KERNBASE)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">  proc-&gt;sz = newsz;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> addr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>xv6,<code>echo hi</code>,<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pid 3 sh: <span class=\"built_in\">trap</span> 14 err 6 on cpu 0 eip 0x12f1 addr 0x4004--kill proc</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>shell<code>echo</code>,<code>malloc</code>.<code>malloc</code>,,cmd,,<code>sys_sbrk</code><code>growproc()</code>.</p>\n</blockquote>\n<h2 id=\"Part2-\"><a href=\"#Part2-\" class=\"headerlink\" title=\"Part2 \"></a>Part2 </h2><h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>,,trap.c.,<code>echo</code>.</p>\n</blockquote>\n<h3 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><code>trap.c</code>,<code>page fault</code>,<code>proc-&gt;sz</code>.<code>page fault</code>,(lazy allocation),,<code>proc-&gt;sz</code>.<br><code>page fault</code><code>malloc</code>,<code>proc-&gt;sz</code>,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (tf-&gt;trapno == T_PGFLT) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">char</span>* mem;</span><br><span class=\"line\">      uint a;</span><br><span class=\"line\"></span><br><span class=\"line\">      a = PGROUNDDOWN(rcr2()); <span class=\"comment\">//rcr2()</span></span><br><span class=\"line\">      mem = kalloc();</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (mem == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">          cprintf(<span class=\"string\">\"run out of memory!\\n\"</span>);</span><br><span class=\"line\">          proc-&gt;killed = <span class=\"number\">1</span>;</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"built_in\">memset</span>(mem, <span class=\"number\">0</span>, PGSIZE);</span><br><span class=\"line\">      mappages(proc-&gt;pgdir, (<span class=\"keyword\">char</span>*)a, PGSIZE, v2p(mem), PTE_W|PTE_U);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>"},{"title":"hw5-cpu-alarm","date":"2017-04-23T16:00:00.000Z","_content":"# hw5 cpu alarm\n## \n> hwxv6CPU,.CPU.1.\n.1`alarm(interval, handler)`.1`alarm(n, fn)`nCPU`fn`.`fn`.\n\n`alarmtest.c`\n\n<!-- more -->\n\n``` c\n#include \"types.h\"\n#include \"stat.h\"\n#include \"user.h\"\n\nvoid periodic();\n\nint\nmain(int argc, char *argv[])\n{\n  int i;\n  printf(1, \"alarmtest starting\\n\");\n  alarm(10, periodic);\n  for(i = 0; i < 50*500000; i++){\n    if((i++ % 500000) == 0)\n      write(2, \".\", 1);\n  }\n  exit();\n}\n\nvoid\nperiodic()\n{\n  printf(1, \"alarm!\\n\");\n}\n```\n`alarm(10, periodic)`, 10tick`periodic`.:\n``` bash\n$alarmtest\nalarmtest starting\n.....alarm!\n....alarm!\n.....alarm!\n......alarm!\n.....alarm!\n....alarm!\n....alarm!\n......alarm!\n.....alarm!\n...alarm!\n...$\n```\n\n### \n\n\n\n> 1.[hw3 system call](https://chestnutme.github.io/2017/04/19/hw3/),\n``` c\n//user.h\nint alarm(int ticks, void(*hander)());\n//usys.S\nSYSCALL(alarm)\n//Makefile    UPROGS:\n_alarmtest\\\n//syscall.h\n#define SYS_alarm 23\n//syscall.c\nextern int sys_alarm(void);\n//syscall.c syscalls[]\n[SYS_alarm]   sys_alarm,\n//sysproc.c\nint\n    sys_alarm(void)\n    {\n      int ticks;\n      void (*handler)();\n\n      if(argint(0, &ticks) < 0)\n        return -1;\n      if(argptr(1, (char**)&handler, 1) < 0)\n        return -1;\n      proc->alarmticks = ticks;\n      proc->alarmhandler = handler;\n      return 0;\n    }\n```\n\n\n> 2.`proc.c``proc``ticks``ticks``handler`\n``` c\n//struct proc\nint alarmticks;\nint curalarmticks;\nvoid (*alarmhander)();\n```\n\n> 3.`trap.c``handler`\n``` c\ncase T_IRQ0 + IRQ_TIMER:\n    if(cpu->id == 0){\n       acquire(&tickslock);\n       ticks++;\n\n      wakeup(&ticks);\n      release(&tickslock);\n    }\n      if(proc && (tf->cs & 3) == 3){\n        proc->curalarmtick++;\n        if(proc->alarmticks == proc->curalarmtick){  // tick\n          proc->curalarmtick = 0;\n\n          //eip\n          tf->esp -= 4;    \n          *((uint *)(tf->esp)) = tf->eip;\n          // alarmhandlereip\n          tf->eip =(uint) proc->alarmhandler;\n        }\n      }\n    lapiceoi();\n    break;\n````\n","source":"_posts/hw5.md","raw":"title: hw5-cpu-alarm\ndate: 2017/04/24\ntags:\n\t- os\n\t- xv6\n\n---\n# hw5 cpu alarm\n## \n> hwxv6CPU,.CPU.1.\n.1`alarm(interval, handler)`.1`alarm(n, fn)`nCPU`fn`.`fn`.\n\n`alarmtest.c`\n\n<!-- more -->\n\n``` c\n#include \"types.h\"\n#include \"stat.h\"\n#include \"user.h\"\n\nvoid periodic();\n\nint\nmain(int argc, char *argv[])\n{\n  int i;\n  printf(1, \"alarmtest starting\\n\");\n  alarm(10, periodic);\n  for(i = 0; i < 50*500000; i++){\n    if((i++ % 500000) == 0)\n      write(2, \".\", 1);\n  }\n  exit();\n}\n\nvoid\nperiodic()\n{\n  printf(1, \"alarm!\\n\");\n}\n```\n`alarm(10, periodic)`, 10tick`periodic`.:\n``` bash\n$alarmtest\nalarmtest starting\n.....alarm!\n....alarm!\n.....alarm!\n......alarm!\n.....alarm!\n....alarm!\n....alarm!\n......alarm!\n.....alarm!\n...alarm!\n...$\n```\n\n### \n\n\n\n> 1.[hw3 system call](https://chestnutme.github.io/2017/04/19/hw3/),\n``` c\n//user.h\nint alarm(int ticks, void(*hander)());\n//usys.S\nSYSCALL(alarm)\n//Makefile    UPROGS:\n_alarmtest\\\n//syscall.h\n#define SYS_alarm 23\n//syscall.c\nextern int sys_alarm(void);\n//syscall.c syscalls[]\n[SYS_alarm]   sys_alarm,\n//sysproc.c\nint\n    sys_alarm(void)\n    {\n      int ticks;\n      void (*handler)();\n\n      if(argint(0, &ticks) < 0)\n        return -1;\n      if(argptr(1, (char**)&handler, 1) < 0)\n        return -1;\n      proc->alarmticks = ticks;\n      proc->alarmhandler = handler;\n      return 0;\n    }\n```\n\n\n> 2.`proc.c``proc``ticks``ticks``handler`\n``` c\n//struct proc\nint alarmticks;\nint curalarmticks;\nvoid (*alarmhander)();\n```\n\n> 3.`trap.c``handler`\n``` c\ncase T_IRQ0 + IRQ_TIMER:\n    if(cpu->id == 0){\n       acquire(&tickslock);\n       ticks++;\n\n      wakeup(&ticks);\n      release(&tickslock);\n    }\n      if(proc && (tf->cs & 3) == 3){\n        proc->curalarmtick++;\n        if(proc->alarmticks == proc->curalarmtick){  // tick\n          proc->curalarmtick = 0;\n\n          //eip\n          tf->esp -= 4;    \n          *((uint *)(tf->esp)) = tf->eip;\n          // alarmhandlereip\n          tf->eip =(uint) proc->alarmhandler;\n        }\n      }\n    lapiceoi();\n    break;\n````\n","slug":"hw5","published":1,"updated":"2017-08-26T03:38:21.602Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3h3000rs7am3x9tqhjv","content":"<h1 id=\"hw5-cpu-alarm\"><a href=\"#hw5-cpu-alarm\" class=\"headerlink\" title=\"hw5 cpu alarm\"></a>hw5 cpu alarm</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><blockquote>\n<p>hwxv6CPU,.CPU.1.<br>.1<code>alarm(interval, handler)</code>.1<code>alarm(n, fn)</code>nCPU<code>fn</code>.<code>fn</code>.</p>\n</blockquote>\n<p><code>alarmtest.c</code></p>\n<a id=\"more\"></a>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">\"types.h\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">\"stat.h\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">\"user.h\"</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">periodic</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">main(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span> *argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"number\">1</span>, <span class=\"string\">\"alarmtest starting\\n\"</span>);</span><br><span class=\"line\">  alarm(<span class=\"number\">10</span>, periodic);</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">50</span>*<span class=\"number\">500000</span>; i++)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>((i++ % <span class=\"number\">500000</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">      write(<span class=\"number\">2</span>, <span class=\"string\">\".\"</span>, <span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">periodic()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"number\">1</span>, <span class=\"string\">\"alarm!\\n\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>alarm(10, periodic)</code>, 10tick<code>periodic</code>.:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$alarmtest</span></span><br><span class=\"line\">alarmtest starting</span><br><span class=\"line\">.....alarm!</span><br><span class=\"line\">....alarm!</span><br><span class=\"line\">.....alarm!</span><br><span class=\"line\">......alarm!</span><br><span class=\"line\">.....alarm!</span><br><span class=\"line\">....alarm!</span><br><span class=\"line\">....alarm!</span><br><span class=\"line\">......alarm!</span><br><span class=\"line\">.....alarm!</span><br><span class=\"line\">...alarm!</span><br><span class=\"line\">...$</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<blockquote>\n<p>1.<a href=\"https://chestnutme.github.io/2017/04/19/hw3/\" target=\"_blank\" rel=\"noopener\">hw3 system call</a>,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//user.h</span></span><br><span class=\"line\">int alarm(int ticks, void(*hander)());</span><br><span class=\"line\"><span class=\"comment\">//usys.S</span></span><br><span class=\"line\">SYSCALL(alarm)</span><br><span class=\"line\"><span class=\"comment\">//Makefile    UPROGS:</span></span><br><span class=\"line\">_alarmtest\\</span><br><span class=\"line\"><span class=\"comment\">//syscall.h</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SYS_alarm 23</span></span><br><span class=\"line\"><span class=\"comment\">//syscall.c</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">extern</span> <span class=\"keyword\">int</span> <span class=\"title\">sys_alarm</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span>;</span><br><span class=\"line\"><span class=\"comment\">//syscall.c syscalls[]</span></span><br><span class=\"line\">[SYS_alarm]   sys_alarm,</span><br><span class=\"line\"><span class=\"comment\">//sysproc.c</span></span><br><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">    sys_alarm(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">int</span> ticks;</span><br><span class=\"line\">      <span class=\"keyword\">void</span> (*handler)();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(argint(<span class=\"number\">0</span>, &amp;ticks) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(argptr(<span class=\"number\">1</span>, (<span class=\"keyword\">char</span>**)&amp;handler, <span class=\"number\">1</span>) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">      proc-&gt;alarmticks = ticks;</span><br><span class=\"line\">      proc-&gt;alarmhandler = handler;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>2.<code>proc.c</code><code>proc</code><code>ticks</code><code>ticks</code><code>handler</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//struct proc</span></span><br><span class=\"line\"><span class=\"keyword\">int</span> alarmticks;</span><br><span class=\"line\"><span class=\"keyword\">int</span> curalarmticks;</span><br><span class=\"line\"><span class=\"keyword\">void</span> (*alarmhander)();</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>3.<code>trap.c</code><code>handler</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">case</span> T_IRQ0 + IRQ_TIMER:</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(cpu-&gt;id == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">       acquire(&amp;tickslock);</span><br><span class=\"line\">       ticks++;</span><br><span class=\"line\"></span><br><span class=\"line\">      wakeup(&amp;ticks);</span><br><span class=\"line\">      release(&amp;tickslock);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(proc &amp;&amp; (tf-&gt;cs &amp; <span class=\"number\">3</span>) == <span class=\"number\">3</span>)&#123;</span><br><span class=\"line\">        proc-&gt;curalarmtick++;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(proc-&gt;alarmticks == proc-&gt;curalarmtick)&#123;  <span class=\"comment\">// tick</span></span><br><span class=\"line\">          proc-&gt;curalarmtick = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\">//eip</span></span><br><span class=\"line\">          tf-&gt;esp -= <span class=\"number\">4</span>;    </span><br><span class=\"line\">          *((uint *)(tf-&gt;esp)) = tf-&gt;eip;</span><br><span class=\"line\">          <span class=\"comment\">// alarmhandlereip</span></span><br><span class=\"line\">          tf-&gt;eip =(uint) proc-&gt;alarmhandler;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    lapiceoi();</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">`</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<h1 id=\"hw5-cpu-alarm\"><a href=\"#hw5-cpu-alarm\" class=\"headerlink\" title=\"hw5 cpu alarm\"></a>hw5 cpu alarm</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><blockquote>\n<p>hwxv6CPU,.CPU.1.<br>.1<code>alarm(interval, handler)</code>.1<code>alarm(n, fn)</code>nCPU<code>fn</code>.<code>fn</code>.</p>\n</blockquote>\n<p><code>alarmtest.c</code></p>","more":"<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">\"types.h\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">\"stat.h\"</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">\"user.h\"</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">periodic</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">main(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span> *argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"number\">1</span>, <span class=\"string\">\"alarmtest starting\\n\"</span>);</span><br><span class=\"line\">  alarm(<span class=\"number\">10</span>, periodic);</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">50</span>*<span class=\"number\">500000</span>; i++)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>((i++ % <span class=\"number\">500000</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">      write(<span class=\"number\">2</span>, <span class=\"string\">\".\"</span>, <span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">periodic()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"number\">1</span>, <span class=\"string\">\"alarm!\\n\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>alarm(10, periodic)</code>, 10tick<code>periodic</code>.:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$alarmtest</span></span><br><span class=\"line\">alarmtest starting</span><br><span class=\"line\">.....alarm!</span><br><span class=\"line\">....alarm!</span><br><span class=\"line\">.....alarm!</span><br><span class=\"line\">......alarm!</span><br><span class=\"line\">.....alarm!</span><br><span class=\"line\">....alarm!</span><br><span class=\"line\">....alarm!</span><br><span class=\"line\">......alarm!</span><br><span class=\"line\">.....alarm!</span><br><span class=\"line\">...alarm!</span><br><span class=\"line\">...$</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<blockquote>\n<p>1.<a href=\"https://chestnutme.github.io/2017/04/19/hw3/\" target=\"_blank\" rel=\"noopener\">hw3 system call</a>,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//user.h</span></span><br><span class=\"line\">int alarm(int ticks, void(*hander)());</span><br><span class=\"line\"><span class=\"comment\">//usys.S</span></span><br><span class=\"line\">SYSCALL(alarm)</span><br><span class=\"line\"><span class=\"comment\">//Makefile    UPROGS:</span></span><br><span class=\"line\">_alarmtest\\</span><br><span class=\"line\"><span class=\"comment\">//syscall.h</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SYS_alarm 23</span></span><br><span class=\"line\"><span class=\"comment\">//syscall.c</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">extern</span> <span class=\"keyword\">int</span> <span class=\"title\">sys_alarm</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span>;</span><br><span class=\"line\"><span class=\"comment\">//syscall.c syscalls[]</span></span><br><span class=\"line\">[SYS_alarm]   sys_alarm,</span><br><span class=\"line\"><span class=\"comment\">//sysproc.c</span></span><br><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">    sys_alarm(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">int</span> ticks;</span><br><span class=\"line\">      <span class=\"keyword\">void</span> (*handler)();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(argint(<span class=\"number\">0</span>, &amp;ticks) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(argptr(<span class=\"number\">1</span>, (<span class=\"keyword\">char</span>**)&amp;handler, <span class=\"number\">1</span>) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">      proc-&gt;alarmticks = ticks;</span><br><span class=\"line\">      proc-&gt;alarmhandler = handler;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>2.<code>proc.c</code><code>proc</code><code>ticks</code><code>ticks</code><code>handler</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//struct proc</span></span><br><span class=\"line\"><span class=\"keyword\">int</span> alarmticks;</span><br><span class=\"line\"><span class=\"keyword\">int</span> curalarmticks;</span><br><span class=\"line\"><span class=\"keyword\">void</span> (*alarmhander)();</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>3.<code>trap.c</code><code>handler</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">case</span> T_IRQ0 + IRQ_TIMER:</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(cpu-&gt;id == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">       acquire(&amp;tickslock);</span><br><span class=\"line\">       ticks++;</span><br><span class=\"line\"></span><br><span class=\"line\">      wakeup(&amp;ticks);</span><br><span class=\"line\">      release(&amp;tickslock);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(proc &amp;&amp; (tf-&gt;cs &amp; <span class=\"number\">3</span>) == <span class=\"number\">3</span>)&#123;</span><br><span class=\"line\">        proc-&gt;curalarmtick++;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(proc-&gt;alarmticks == proc-&gt;curalarmtick)&#123;  <span class=\"comment\">// tick</span></span><br><span class=\"line\">          proc-&gt;curalarmtick = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\">//eip</span></span><br><span class=\"line\">          tf-&gt;esp -= <span class=\"number\">4</span>;    </span><br><span class=\"line\">          *((uint *)(tf-&gt;esp)) = tf-&gt;eip;</span><br><span class=\"line\">          <span class=\"comment\">// alarmhandlereip</span></span><br><span class=\"line\">          tf-&gt;eip =(uint) proc-&gt;alarmhandler;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    lapiceoi();</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">`</span><br></pre></td></tr></table></figure></p>\n</blockquote>"},{"title":"hw6-threads-and-locking","date":"2017-04-29T16:00:00.000Z","_content":"# hw6 threads and locking\n## \nOSCPU.OShw6Hash.\n\n## \nhw6osxv6.\n``` bash\nwget https://pdos.csail.mit.edu/6.828/2016/homework/ph.c\ngcc -g -02 ph.c -pthread\n```\n`ph.c`)\n``` c\n#include <stdlib.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <assert.h>\n#include <pthread.h>\n#include <sys/time.h>\n\n#define SOL\n#define NBUCKET 5\n#define NKEYS 100000\n\nstruct entry {\n  int key;\n  int value;\n  struct entry *next;\n};\nstruct entry *table[NBUCKET];\nint keys[NKEYS];\nint nthread = 1;\nvolatile int done;\n\n\ndouble\nnow()\n{\n struct timeval tv;\n gettimeofday(&tv, 0);\n return tv.tv_sec + tv.tv_usec / 1000000.0;\n}\n\nstatic void\nprint(void)\n{\n  int i;\n  struct entry *e;\n  for (i = 0; i < NBUCKET; i++) {\n    printf(\"%d: \", i);\n    for (e = table[i]; e != 0; e = e->next) {\n      printf(\"%d \", e->key);\n    }\n    printf(\"\\n\");\n  }\n}\n\nstatic void\ninsert(int key, int value, struct entry **p, struct entry *n)\n{\n  struct entry *e = malloc(sizeof(struct entry));\n  e->key = key;\n  e->value = value;\n  e->next = n;\n  *p = e;\n}\n\nstatic\nvoid put(int key, int value)\n{\n  int i = key % NBUCKET;\n  insert(key, value, &table[i], table[i]);\n}\n\nstatic struct entry*\nget(int key)\n{\n  struct entry *e = 0;\n  for (e = table[key % NBUCKET]; e != 0; e = e->next) {\n    if (e->key == key) break;\n  }\n  return e;\n}\n\nstatic void *\nthread(void *xa)\n{\n  long n = (long) xa;\n  int i;\n  int b = NKEYS/nthread;\n  int k = 0;\n  double t1, t0;\n\n  //  printf(\"b = %d\\n\", b);\n  t0 = now();\n  for (i = 0; i < b; i++) {\n    // printf(\"%d: put %d\\n\", n, b*n+i);\n    put(keys[b*n + i], n);\n  }\n  t1 = now();\n  printf(\"%ld: put time = %f\\n\", n, t1-t0);\n\n  // Should use pthread_barrier, but MacOS doesn't support it ...\n  __sync_fetch_and_add(&done, 1);\n  while (done < nthread) ;\n\n  t0 = now();\n  for (i = 0; i < NKEYS; i++) {\n    struct entry *e = get(keys[i]);\n    if (e == 0) k++;\n  }\n  t1 = now();\n  printf(\"%ld: get time = %f\\n\", n, t1-t0);\n  printf(\"%ld: %d keys missing\\n\", n, k);\n  return NULL;\n}\n\nint\nmain(int argc, char *argv[])\n{\n  pthread_t *tha;\n  void *value;\n  long i;\n  double t1, t0;\n\n  if (argc < 2) {\n    fprintf(stderr, \"%s: %s nthread\\n\", argv[0], argv[0]);\n    exit(-1);\n  }\n  nthread = atoi(argv[1]);\n  tha = malloc(sizeof(pthread_t) * nthread);\n  srandom(0);\n  assert(NKEYS % nthread == 0);\n  for (i = 0; i < NKEYS; i++) {\n    keys[i] = random();\n  }\n  t0 = now();\n  for(i = 0; i < nthread; i++) {\n    assert(pthread_create(&tha[i], NULL, thread, (void *) i) == 0);\n  }\n  for(i = 0; i < nthread; i++) {\n    assert(pthread_join(tha[i], &value) == 0);\n  }\n  t1 = now();\n  printf(\"completion time = %f\\n\", t1-t0);\n}\n```\n\n## \n4\n``` bash\n./a.out 2\n# 2n_threadshashputget\n```\n\n```\n1: put time = 0.007442\n0: put time = 0.007474\n1: get time = 6.559389\n1: 1 keys missing\n0: get time = 6.567974\n0: 1. keys missing\ncompletion time = 6.575672\n```\n> .`put``[NKEYS/nthread]`keyhash.`get`hash`NKEYS`..6.5.\n\n\n```\n./a.out 1\n0: put time = 0.016793\n0: get time = 5.447454\n0: 0 keys missing\ncompletion time = 5.464499\n```\n> 5.5s6.5s`get`..`put`; key.`1 keys missing`211.\n\n4\n```\n23: put time = 0.014067\n1: put time = 0.014450\n2: put time = 0.014245\n0: put time = 0.015714\n3: get time = 6.202647\n3: 45 keys missing\n0: get time = 6.211748\n0: 45 keys missing\n2: get time = 6.287174\n2: 45 keys missing\n1: get time = 6.306257\n1: 45 keys missing\ncompletion time = 6.322159\n```\n> 4.keykey.\n\n## \n### key\nkeyABbucketkey\n```\nt-A: calls insert() on bucket 1 (key = 6, 6 % NBUCKETS = 1)\n\nt-B: calls insert() on bucket 1 (key = 21, 21 % NBUCKETS = 1)\n\n...\n\nt-A: executes e->next = n\n\nt-B: executes e->next = n\n\nt-A: executes *p = e\n\nt-B: executes *p = e\n```\nB`*p = e`A.A6B\n### ****\n****`put``get`****.linux `pthread.h`\n``` c\npthread_mutex_t lock;     // declare a lock\npthread_mutex_init(&lock, NULL);   // initialize the lock\npthread_mutex_lock(&lock);  // acquire lock\npthread_mutex_unlock(&lock);  // release lock\n```\n`put``get`0.`get`hash-key`put`hash`put`bucket`put`bucket\n```\n0: put time = 0.022744\n1: put time = 0.022521\n1: get time = 6.309178\n1: 0 keys missing\n0: get time = 6.323614\n0: 0 keys missing\ncompletion time = 6.350177\n```\n`ph.c`\n``` c\n...\nint keys[NKEYS];\npthread_mutex_t bucket_locks[NBUCKET];\n...\nstatic\nvoid put(int key, int value)\n{\n  int i = key % NBUCKET;\n  pthread_mutex_lock(&bucket_locks[i]);\n  insert(key, value, &table[i], table[i]);\n  pthread_mutex_unlock(&bucket_locks[i]);\n}\n...\nint\nmain(int argc, char *argv[])\n{\n  pthread_t *tha;\n  void *value;\n  long i;\n  double t1, t0;\n\n  if (argc < 2) {\n    fprintf(stderr, \"%s: %s nthread\\n\", argv[0], argv[0]);\n    exit(-1);\n  }\n  nthread = atoi(argv[1]);\n  tha = malloc(sizeof(pthread_t) * nthread);\n  srandom(0);\n  assert(NKEYS % nthread == 0);\n  for (i = 0; i < NKEYS; i++) {\n    keys[i] = random();\n  }\n\n  //init lock for every bucket\n  for (i = 0; i < NBUCKET; i++) {\n    pthread_mutex_init(&bucket_locks[i], NULL);\n  }\n\n  t0 = now();\n  for(i = 0; i < nthread; i++) {\n    assert(pthread_create(&tha[i], NULL, thread, (void *) i) == 0);\n  }\n  for(i = 0; i < nthread; i++) {\n    assert(pthread_join(tha[i], &value) == 0);\n  }\n  t1 = now();\n  printf(\"completion time = %f\\n\", t1-t0);\n}\n```\n","source":"_posts/hw6.md","raw":"title: hw6-threads-and-locking\ndate: 2017/04/30\ntags:\n\t- os\n\t- xv6\n\n---\n# hw6 threads and locking\n## \nOSCPU.OShw6Hash.\n\n## \nhw6osxv6.\n``` bash\nwget https://pdos.csail.mit.edu/6.828/2016/homework/ph.c\ngcc -g -02 ph.c -pthread\n```\n`ph.c`)\n``` c\n#include <stdlib.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <assert.h>\n#include <pthread.h>\n#include <sys/time.h>\n\n#define SOL\n#define NBUCKET 5\n#define NKEYS 100000\n\nstruct entry {\n  int key;\n  int value;\n  struct entry *next;\n};\nstruct entry *table[NBUCKET];\nint keys[NKEYS];\nint nthread = 1;\nvolatile int done;\n\n\ndouble\nnow()\n{\n struct timeval tv;\n gettimeofday(&tv, 0);\n return tv.tv_sec + tv.tv_usec / 1000000.0;\n}\n\nstatic void\nprint(void)\n{\n  int i;\n  struct entry *e;\n  for (i = 0; i < NBUCKET; i++) {\n    printf(\"%d: \", i);\n    for (e = table[i]; e != 0; e = e->next) {\n      printf(\"%d \", e->key);\n    }\n    printf(\"\\n\");\n  }\n}\n\nstatic void\ninsert(int key, int value, struct entry **p, struct entry *n)\n{\n  struct entry *e = malloc(sizeof(struct entry));\n  e->key = key;\n  e->value = value;\n  e->next = n;\n  *p = e;\n}\n\nstatic\nvoid put(int key, int value)\n{\n  int i = key % NBUCKET;\n  insert(key, value, &table[i], table[i]);\n}\n\nstatic struct entry*\nget(int key)\n{\n  struct entry *e = 0;\n  for (e = table[key % NBUCKET]; e != 0; e = e->next) {\n    if (e->key == key) break;\n  }\n  return e;\n}\n\nstatic void *\nthread(void *xa)\n{\n  long n = (long) xa;\n  int i;\n  int b = NKEYS/nthread;\n  int k = 0;\n  double t1, t0;\n\n  //  printf(\"b = %d\\n\", b);\n  t0 = now();\n  for (i = 0; i < b; i++) {\n    // printf(\"%d: put %d\\n\", n, b*n+i);\n    put(keys[b*n + i], n);\n  }\n  t1 = now();\n  printf(\"%ld: put time = %f\\n\", n, t1-t0);\n\n  // Should use pthread_barrier, but MacOS doesn't support it ...\n  __sync_fetch_and_add(&done, 1);\n  while (done < nthread) ;\n\n  t0 = now();\n  for (i = 0; i < NKEYS; i++) {\n    struct entry *e = get(keys[i]);\n    if (e == 0) k++;\n  }\n  t1 = now();\n  printf(\"%ld: get time = %f\\n\", n, t1-t0);\n  printf(\"%ld: %d keys missing\\n\", n, k);\n  return NULL;\n}\n\nint\nmain(int argc, char *argv[])\n{\n  pthread_t *tha;\n  void *value;\n  long i;\n  double t1, t0;\n\n  if (argc < 2) {\n    fprintf(stderr, \"%s: %s nthread\\n\", argv[0], argv[0]);\n    exit(-1);\n  }\n  nthread = atoi(argv[1]);\n  tha = malloc(sizeof(pthread_t) * nthread);\n  srandom(0);\n  assert(NKEYS % nthread == 0);\n  for (i = 0; i < NKEYS; i++) {\n    keys[i] = random();\n  }\n  t0 = now();\n  for(i = 0; i < nthread; i++) {\n    assert(pthread_create(&tha[i], NULL, thread, (void *) i) == 0);\n  }\n  for(i = 0; i < nthread; i++) {\n    assert(pthread_join(tha[i], &value) == 0);\n  }\n  t1 = now();\n  printf(\"completion time = %f\\n\", t1-t0);\n}\n```\n\n## \n4\n``` bash\n./a.out 2\n# 2n_threadshashputget\n```\n\n```\n1: put time = 0.007442\n0: put time = 0.007474\n1: get time = 6.559389\n1: 1 keys missing\n0: get time = 6.567974\n0: 1. keys missing\ncompletion time = 6.575672\n```\n> .`put``[NKEYS/nthread]`keyhash.`get`hash`NKEYS`..6.5.\n\n\n```\n./a.out 1\n0: put time = 0.016793\n0: get time = 5.447454\n0: 0 keys missing\ncompletion time = 5.464499\n```\n> 5.5s6.5s`get`..`put`; key.`1 keys missing`211.\n\n4\n```\n23: put time = 0.014067\n1: put time = 0.014450\n2: put time = 0.014245\n0: put time = 0.015714\n3: get time = 6.202647\n3: 45 keys missing\n0: get time = 6.211748\n0: 45 keys missing\n2: get time = 6.287174\n2: 45 keys missing\n1: get time = 6.306257\n1: 45 keys missing\ncompletion time = 6.322159\n```\n> 4.keykey.\n\n## \n### key\nkeyABbucketkey\n```\nt-A: calls insert() on bucket 1 (key = 6, 6 % NBUCKETS = 1)\n\nt-B: calls insert() on bucket 1 (key = 21, 21 % NBUCKETS = 1)\n\n...\n\nt-A: executes e->next = n\n\nt-B: executes e->next = n\n\nt-A: executes *p = e\n\nt-B: executes *p = e\n```\nB`*p = e`A.A6B\n### ****\n****`put``get`****.linux `pthread.h`\n``` c\npthread_mutex_t lock;     // declare a lock\npthread_mutex_init(&lock, NULL);   // initialize the lock\npthread_mutex_lock(&lock);  // acquire lock\npthread_mutex_unlock(&lock);  // release lock\n```\n`put``get`0.`get`hash-key`put`hash`put`bucket`put`bucket\n```\n0: put time = 0.022744\n1: put time = 0.022521\n1: get time = 6.309178\n1: 0 keys missing\n0: get time = 6.323614\n0: 0 keys missing\ncompletion time = 6.350177\n```\n`ph.c`\n``` c\n...\nint keys[NKEYS];\npthread_mutex_t bucket_locks[NBUCKET];\n...\nstatic\nvoid put(int key, int value)\n{\n  int i = key % NBUCKET;\n  pthread_mutex_lock(&bucket_locks[i]);\n  insert(key, value, &table[i], table[i]);\n  pthread_mutex_unlock(&bucket_locks[i]);\n}\n...\nint\nmain(int argc, char *argv[])\n{\n  pthread_t *tha;\n  void *value;\n  long i;\n  double t1, t0;\n\n  if (argc < 2) {\n    fprintf(stderr, \"%s: %s nthread\\n\", argv[0], argv[0]);\n    exit(-1);\n  }\n  nthread = atoi(argv[1]);\n  tha = malloc(sizeof(pthread_t) * nthread);\n  srandom(0);\n  assert(NKEYS % nthread == 0);\n  for (i = 0; i < NKEYS; i++) {\n    keys[i] = random();\n  }\n\n  //init lock for every bucket\n  for (i = 0; i < NBUCKET; i++) {\n    pthread_mutex_init(&bucket_locks[i], NULL);\n  }\n\n  t0 = now();\n  for(i = 0; i < nthread; i++) {\n    assert(pthread_create(&tha[i], NULL, thread, (void *) i) == 0);\n  }\n  for(i = 0; i < nthread; i++) {\n    assert(pthread_join(tha[i], &value) == 0);\n  }\n  t1 = now();\n  printf(\"completion time = %f\\n\", t1-t0);\n}\n```\n","slug":"hw6","published":1,"updated":"2017-08-26T03:38:21.614Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3h4000ts7amx9wch5yh","content":"<h1 id=\"hw6-threads-and-locking\"><a href=\"#hw6-threads-and-locking\" class=\"headerlink\" title=\"hw6 threads and locking\"></a>hw6 threads and locking</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>OSCPU.OShw6Hash.</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>hw6osxv6.<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://pdos.csail.mit.edu/6.828/2016/homework/ph.c</span><br><span class=\"line\">gcc -g -02 ph.c -pthread</span><br></pre></td></tr></table></figure></p>\n<p><code>ph.c</code>)<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;pthread.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;sys/time.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SOL</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> NBUCKET 5</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> NKEYS 100000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> entry &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> key;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> value;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> entry *next;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">struct</span> entry *table[NBUCKET];</span><br><span class=\"line\"><span class=\"keyword\">int</span> keys[NKEYS];</span><br><span class=\"line\"><span class=\"keyword\">int</span> nthread = <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">volatile</span> <span class=\"keyword\">int</span> done;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">double</span></span><br><span class=\"line\">now()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> <span class=\"keyword\">struct</span> timeval tv;</span><br><span class=\"line\"> gettimeofday(&amp;tv, <span class=\"number\">0</span>);</span><br><span class=\"line\"> <span class=\"keyword\">return</span> tv.tv_sec + tv.tv_usec / <span class=\"number\">1000000.0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">print(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> entry *e;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NBUCKET; i++) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"%d: \"</span>, i);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (e = table[i]; e != <span class=\"number\">0</span>; e = e-&gt;next) &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">\"%d \"</span>, e-&gt;key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">insert(<span class=\"keyword\">int</span> key, <span class=\"keyword\">int</span> value, <span class=\"keyword\">struct</span> entry **p, <span class=\"keyword\">struct</span> entry *n)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> entry *e = <span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> entry));</span><br><span class=\"line\">  e-&gt;key = key;</span><br><span class=\"line\">  e-&gt;value = value;</span><br><span class=\"line\">  e-&gt;next = n;</span><br><span class=\"line\">  *p = e;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">put</span><span class=\"params\">(<span class=\"keyword\">int</span> key, <span class=\"keyword\">int</span> value)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> i = key % NBUCKET;</span><br><span class=\"line\">  insert(key, value, &amp;table[i], table[i]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">struct</span> entry*</span><br><span class=\"line\">get(<span class=\"keyword\">int</span> key)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> entry *e = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (e = table[key % NBUCKET]; e != <span class=\"number\">0</span>; e = e-&gt;next) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (e-&gt;key == key) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> e;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> *</span><br><span class=\"line\">thread(<span class=\"keyword\">void</span> *xa)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">long</span> n = (<span class=\"keyword\">long</span>) xa;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> b = NKEYS/nthread;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> k = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">double</span> t1, t0;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  printf(\"b = %d\\n\", b);</span></span><br><span class=\"line\">  t0 = now();</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; b; i++) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// printf(\"%d: put %d\\n\", n, b*n+i);</span></span><br><span class=\"line\">    put(keys[b*n + i], n);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  t1 = now();</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"%ld: put time = %f\\n\"</span>, n, t1-t0);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Should use pthread_barrier, but MacOS doesn't support it ...</span></span><br><span class=\"line\">  __sync_fetch_and_add(&amp;done, <span class=\"number\">1</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (done &lt; nthread) ;</span><br><span class=\"line\"></span><br><span class=\"line\">  t0 = now();</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NKEYS; i++) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> entry *e = get(keys[i]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (e == <span class=\"number\">0</span>) k++;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  t1 = now();</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"%ld: get time = %f\\n\"</span>, n, t1-t0);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"%ld: %d keys missing\\n\"</span>, n, k);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">main(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span> *argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">pthread_t</span> *tha;</span><br><span class=\"line\">  <span class=\"keyword\">void</span> *value;</span><br><span class=\"line\">  <span class=\"keyword\">long</span> i;</span><br><span class=\"line\">  <span class=\"keyword\">double</span> t1, t0;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (argc &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"%s: %s nthread\\n\"</span>, argv[<span class=\"number\">0</span>], argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  nthread = atoi(argv[<span class=\"number\">1</span>]);</span><br><span class=\"line\">  tha = <span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">pthread_t</span>) * nthread);</span><br><span class=\"line\">  srandom(<span class=\"number\">0</span>);</span><br><span class=\"line\">  assert(NKEYS % nthread == <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NKEYS; i++) &#123;</span><br><span class=\"line\">    keys[i] = random();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  t0 = now();</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt; nthread; i++) &#123;</span><br><span class=\"line\">    assert(pthread_create(&amp;tha[i], <span class=\"literal\">NULL</span>, thread, (<span class=\"keyword\">void</span> *) i) == <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt; nthread; i++) &#123;</span><br><span class=\"line\">    assert(pthread_join(tha[i], &amp;value) == <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  t1 = now();</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"completion time = %f\\n\"</span>, t1-t0);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>4<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./a.out 2</span><br><span class=\"line\"><span class=\"comment\"># 2n_threadshashputget</span></span><br></pre></td></tr></table></figure></p>\n<p><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1: put time = 0.007442</span><br><span class=\"line\">0: put time = 0.007474</span><br><span class=\"line\">1: get time = 6.559389</span><br><span class=\"line\">1: 1 keys missing</span><br><span class=\"line\">0: get time = 6.567974</span><br><span class=\"line\">0: 1. keys missing</span><br><span class=\"line\">completion time = 6.575672</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>.<code>put</code><code>[NKEYS/nthread]</code>keyhash.<code>get</code>hash<code>NKEYS</code>..6.5.</p>\n</blockquote>\n<p><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./a.out 1</span><br><span class=\"line\">0: put time = 0.016793</span><br><span class=\"line\">0: get time = 5.447454</span><br><span class=\"line\">0: 0 keys missing</span><br><span class=\"line\">completion time = 5.464499</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>5.5s6.5s<code>get</code>..<code>put</code>; key.<code>1 keys missing</code>211.</p>\n</blockquote>\n<p>4<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">23: put time = 0.014067</span><br><span class=\"line\">1: put time = 0.014450</span><br><span class=\"line\">2: put time = 0.014245</span><br><span class=\"line\">0: put time = 0.015714</span><br><span class=\"line\">3: get time = 6.202647</span><br><span class=\"line\">3: 45 keys missing</span><br><span class=\"line\">0: get time = 6.211748</span><br><span class=\"line\">0: 45 keys missing</span><br><span class=\"line\">2: get time = 6.287174</span><br><span class=\"line\">2: 45 keys missing</span><br><span class=\"line\">1: get time = 6.306257</span><br><span class=\"line\">1: 45 keys missing</span><br><span class=\"line\">completion time = 6.322159</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>4.keykey.</p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><p>keyABbucketkey<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t-A: calls insert() on bucket 1 (key = 6, 6 % NBUCKETS = 1)</span><br><span class=\"line\"></span><br><span class=\"line\">t-B: calls insert() on bucket 1 (key = 21, 21 % NBUCKETS = 1)</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">t-A: executes e-&gt;next = n</span><br><span class=\"line\"></span><br><span class=\"line\">t-B: executes e-&gt;next = n</span><br><span class=\"line\"></span><br><span class=\"line\">t-A: executes *p = e</span><br><span class=\"line\"></span><br><span class=\"line\">t-B: executes *p = e</span><br></pre></td></tr></table></figure></p>\n<p>B<code>*p = e</code>A.A6B</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h3><p><strong></strong><code>put</code><code>get</code><strong></strong>.linux <code>pthread.h</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">pthread_mutex_t</span> lock;     <span class=\"comment\">// declare a lock</span></span><br><span class=\"line\">pthread_mutex_init(&amp;lock, <span class=\"literal\">NULL</span>);   <span class=\"comment\">// initialize the lock</span></span><br><span class=\"line\">pthread_mutex_lock(&amp;lock);  <span class=\"comment\">// acquire lock</span></span><br><span class=\"line\">pthread_mutex_unlock(&amp;lock);  <span class=\"comment\">// release lock</span></span><br></pre></td></tr></table></figure></p>\n<p><code>put</code><code>get</code>0.<code>get</code>hash-key<code>put</code>hash<code>put</code>bucket<code>put</code>bucket<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0: put time = 0.022744</span><br><span class=\"line\">1: put time = 0.022521</span><br><span class=\"line\">1: get time = 6.309178</span><br><span class=\"line\">1: 0 keys missing</span><br><span class=\"line\">0: get time = 6.323614</span><br><span class=\"line\">0: 0 keys missing</span><br><span class=\"line\">completion time = 6.350177</span><br></pre></td></tr></table></figure></p>\n<p><code>ph.c</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">int</span> keys[NKEYS];</span><br><span class=\"line\"><span class=\"keyword\">pthread_mutex_t</span> bucket_locks[NBUCKET];</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">static</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">put</span><span class=\"params\">(<span class=\"keyword\">int</span> key, <span class=\"keyword\">int</span> value)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> i = key % NBUCKET;</span><br><span class=\"line\">  pthread_mutex_lock(&amp;bucket_locks[i]);</span><br><span class=\"line\">  insert(key, value, &amp;table[i], table[i]);</span><br><span class=\"line\">  pthread_mutex_unlock(&amp;bucket_locks[i]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">main(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span> *argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">pthread_t</span> *tha;</span><br><span class=\"line\">  <span class=\"keyword\">void</span> *value;</span><br><span class=\"line\">  <span class=\"keyword\">long</span> i;</span><br><span class=\"line\">  <span class=\"keyword\">double</span> t1, t0;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (argc &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"%s: %s nthread\\n\"</span>, argv[<span class=\"number\">0</span>], argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  nthread = atoi(argv[<span class=\"number\">1</span>]);</span><br><span class=\"line\">  tha = <span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">pthread_t</span>) * nthread);</span><br><span class=\"line\">  srandom(<span class=\"number\">0</span>);</span><br><span class=\"line\">  assert(NKEYS % nthread == <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NKEYS; i++) &#123;</span><br><span class=\"line\">    keys[i] = random();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//init lock for every bucket</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NBUCKET; i++) &#123;</span><br><span class=\"line\">    pthread_mutex_init(&amp;bucket_locks[i], <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  t0 = now();</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt; nthread; i++) &#123;</span><br><span class=\"line\">    assert(pthread_create(&amp;tha[i], <span class=\"literal\">NULL</span>, thread, (<span class=\"keyword\">void</span> *) i) == <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt; nthread; i++) &#123;</span><br><span class=\"line\">    assert(pthread_join(tha[i], &amp;value) == <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  t1 = now();</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"completion time = %f\\n\"</span>, t1-t0);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"hw6-threads-and-locking\"><a href=\"#hw6-threads-and-locking\" class=\"headerlink\" title=\"hw6 threads and locking\"></a>hw6 threads and locking</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>OSCPU.OShw6Hash.</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>hw6osxv6.<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://pdos.csail.mit.edu/6.828/2016/homework/ph.c</span><br><span class=\"line\">gcc -g -02 ph.c -pthread</span><br></pre></td></tr></table></figure></p>\n<p><code>ph.c</code>)<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;pthread.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;sys/time.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SOL</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> NBUCKET 5</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> NKEYS 100000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> entry &#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> key;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> value;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> entry *next;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">struct</span> entry *table[NBUCKET];</span><br><span class=\"line\"><span class=\"keyword\">int</span> keys[NKEYS];</span><br><span class=\"line\"><span class=\"keyword\">int</span> nthread = <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">volatile</span> <span class=\"keyword\">int</span> done;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">double</span></span><br><span class=\"line\">now()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> <span class=\"keyword\">struct</span> timeval tv;</span><br><span class=\"line\"> gettimeofday(&amp;tv, <span class=\"number\">0</span>);</span><br><span class=\"line\"> <span class=\"keyword\">return</span> tv.tv_sec + tv.tv_usec / <span class=\"number\">1000000.0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">print(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> entry *e;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NBUCKET; i++) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"%d: \"</span>, i);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (e = table[i]; e != <span class=\"number\">0</span>; e = e-&gt;next) &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">\"%d \"</span>, e-&gt;key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">insert(<span class=\"keyword\">int</span> key, <span class=\"keyword\">int</span> value, <span class=\"keyword\">struct</span> entry **p, <span class=\"keyword\">struct</span> entry *n)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> entry *e = <span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> entry));</span><br><span class=\"line\">  e-&gt;key = key;</span><br><span class=\"line\">  e-&gt;value = value;</span><br><span class=\"line\">  e-&gt;next = n;</span><br><span class=\"line\">  *p = e;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">put</span><span class=\"params\">(<span class=\"keyword\">int</span> key, <span class=\"keyword\">int</span> value)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> i = key % NBUCKET;</span><br><span class=\"line\">  insert(key, value, &amp;table[i], table[i]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">struct</span> entry*</span><br><span class=\"line\">get(<span class=\"keyword\">int</span> key)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">struct</span> entry *e = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (e = table[key % NBUCKET]; e != <span class=\"number\">0</span>; e = e-&gt;next) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (e-&gt;key == key) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> e;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> *</span><br><span class=\"line\">thread(<span class=\"keyword\">void</span> *xa)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">long</span> n = (<span class=\"keyword\">long</span>) xa;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> b = NKEYS/nthread;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> k = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">double</span> t1, t0;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//  printf(\"b = %d\\n\", b);</span></span><br><span class=\"line\">  t0 = now();</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; b; i++) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// printf(\"%d: put %d\\n\", n, b*n+i);</span></span><br><span class=\"line\">    put(keys[b*n + i], n);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  t1 = now();</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"%ld: put time = %f\\n\"</span>, n, t1-t0);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Should use pthread_barrier, but MacOS doesn't support it ...</span></span><br><span class=\"line\">  __sync_fetch_and_add(&amp;done, <span class=\"number\">1</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (done &lt; nthread) ;</span><br><span class=\"line\"></span><br><span class=\"line\">  t0 = now();</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NKEYS; i++) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> entry *e = get(keys[i]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (e == <span class=\"number\">0</span>) k++;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  t1 = now();</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"%ld: get time = %f\\n\"</span>, n, t1-t0);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"%ld: %d keys missing\\n\"</span>, n, k);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">main(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span> *argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">pthread_t</span> *tha;</span><br><span class=\"line\">  <span class=\"keyword\">void</span> *value;</span><br><span class=\"line\">  <span class=\"keyword\">long</span> i;</span><br><span class=\"line\">  <span class=\"keyword\">double</span> t1, t0;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (argc &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"%s: %s nthread\\n\"</span>, argv[<span class=\"number\">0</span>], argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  nthread = atoi(argv[<span class=\"number\">1</span>]);</span><br><span class=\"line\">  tha = <span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">pthread_t</span>) * nthread);</span><br><span class=\"line\">  srandom(<span class=\"number\">0</span>);</span><br><span class=\"line\">  assert(NKEYS % nthread == <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NKEYS; i++) &#123;</span><br><span class=\"line\">    keys[i] = random();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  t0 = now();</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt; nthread; i++) &#123;</span><br><span class=\"line\">    assert(pthread_create(&amp;tha[i], <span class=\"literal\">NULL</span>, thread, (<span class=\"keyword\">void</span> *) i) == <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt; nthread; i++) &#123;</span><br><span class=\"line\">    assert(pthread_join(tha[i], &amp;value) == <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  t1 = now();</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"completion time = %f\\n\"</span>, t1-t0);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>4<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./a.out 2</span><br><span class=\"line\"><span class=\"comment\"># 2n_threadshashputget</span></span><br></pre></td></tr></table></figure></p>\n<p><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1: put time = 0.007442</span><br><span class=\"line\">0: put time = 0.007474</span><br><span class=\"line\">1: get time = 6.559389</span><br><span class=\"line\">1: 1 keys missing</span><br><span class=\"line\">0: get time = 6.567974</span><br><span class=\"line\">0: 1. keys missing</span><br><span class=\"line\">completion time = 6.575672</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>.<code>put</code><code>[NKEYS/nthread]</code>keyhash.<code>get</code>hash<code>NKEYS</code>..6.5.</p>\n</blockquote>\n<p><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./a.out 1</span><br><span class=\"line\">0: put time = 0.016793</span><br><span class=\"line\">0: get time = 5.447454</span><br><span class=\"line\">0: 0 keys missing</span><br><span class=\"line\">completion time = 5.464499</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>5.5s6.5s<code>get</code>..<code>put</code>; key.<code>1 keys missing</code>211.</p>\n</blockquote>\n<p>4<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">23: put time = 0.014067</span><br><span class=\"line\">1: put time = 0.014450</span><br><span class=\"line\">2: put time = 0.014245</span><br><span class=\"line\">0: put time = 0.015714</span><br><span class=\"line\">3: get time = 6.202647</span><br><span class=\"line\">3: 45 keys missing</span><br><span class=\"line\">0: get time = 6.211748</span><br><span class=\"line\">0: 45 keys missing</span><br><span class=\"line\">2: get time = 6.287174</span><br><span class=\"line\">2: 45 keys missing</span><br><span class=\"line\">1: get time = 6.306257</span><br><span class=\"line\">1: 45 keys missing</span><br><span class=\"line\">completion time = 6.322159</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>4.keykey.</p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><p>keyABbucketkey<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t-A: calls insert() on bucket 1 (key = 6, 6 % NBUCKETS = 1)</span><br><span class=\"line\"></span><br><span class=\"line\">t-B: calls insert() on bucket 1 (key = 21, 21 % NBUCKETS = 1)</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">t-A: executes e-&gt;next = n</span><br><span class=\"line\"></span><br><span class=\"line\">t-B: executes e-&gt;next = n</span><br><span class=\"line\"></span><br><span class=\"line\">t-A: executes *p = e</span><br><span class=\"line\"></span><br><span class=\"line\">t-B: executes *p = e</span><br></pre></td></tr></table></figure></p>\n<p>B<code>*p = e</code>A.A6B</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><strong></strong></h3><p><strong></strong><code>put</code><code>get</code><strong></strong>.linux <code>pthread.h</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">pthread_mutex_t</span> lock;     <span class=\"comment\">// declare a lock</span></span><br><span class=\"line\">pthread_mutex_init(&amp;lock, <span class=\"literal\">NULL</span>);   <span class=\"comment\">// initialize the lock</span></span><br><span class=\"line\">pthread_mutex_lock(&amp;lock);  <span class=\"comment\">// acquire lock</span></span><br><span class=\"line\">pthread_mutex_unlock(&amp;lock);  <span class=\"comment\">// release lock</span></span><br></pre></td></tr></table></figure></p>\n<p><code>put</code><code>get</code>0.<code>get</code>hash-key<code>put</code>hash<code>put</code>bucket<code>put</code>bucket<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0: put time = 0.022744</span><br><span class=\"line\">1: put time = 0.022521</span><br><span class=\"line\">1: get time = 6.309178</span><br><span class=\"line\">1: 0 keys missing</span><br><span class=\"line\">0: get time = 6.323614</span><br><span class=\"line\">0: 0 keys missing</span><br><span class=\"line\">completion time = 6.350177</span><br></pre></td></tr></table></figure></p>\n<p><code>ph.c</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">int</span> keys[NKEYS];</span><br><span class=\"line\"><span class=\"keyword\">pthread_mutex_t</span> bucket_locks[NBUCKET];</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">static</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">put</span><span class=\"params\">(<span class=\"keyword\">int</span> key, <span class=\"keyword\">int</span> value)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> i = key % NBUCKET;</span><br><span class=\"line\">  pthread_mutex_lock(&amp;bucket_locks[i]);</span><br><span class=\"line\">  insert(key, value, &amp;table[i], table[i]);</span><br><span class=\"line\">  pthread_mutex_unlock(&amp;bucket_locks[i]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">main(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span> *argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">pthread_t</span> *tha;</span><br><span class=\"line\">  <span class=\"keyword\">void</span> *value;</span><br><span class=\"line\">  <span class=\"keyword\">long</span> i;</span><br><span class=\"line\">  <span class=\"keyword\">double</span> t1, t0;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (argc &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">\"%s: %s nthread\\n\"</span>, argv[<span class=\"number\">0</span>], argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  nthread = atoi(argv[<span class=\"number\">1</span>]);</span><br><span class=\"line\">  tha = <span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">pthread_t</span>) * nthread);</span><br><span class=\"line\">  srandom(<span class=\"number\">0</span>);</span><br><span class=\"line\">  assert(NKEYS % nthread == <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NKEYS; i++) &#123;</span><br><span class=\"line\">    keys[i] = random();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//init lock for every bucket</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NBUCKET; i++) &#123;</span><br><span class=\"line\">    pthread_mutex_init(&amp;bucket_locks[i], <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  t0 = now();</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt; nthread; i++) &#123;</span><br><span class=\"line\">    assert(pthread_create(&amp;tha[i], <span class=\"literal\">NULL</span>, thread, (<span class=\"keyword\">void</span> *) i) == <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt; nthread; i++) &#123;</span><br><span class=\"line\">    assert(pthread_join(tha[i], &amp;value) == <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  t1 = now();</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"completion time = %f\\n\"</span>, t1-t0);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n"},{"title":"lab0-build-env","date":"2017-04-07T16:00:00.000Z","_content":"# lab 0: \n\n### toolchain\n> os, :\n> 1. C: , : x86_64\n> 2. linux: , command line\n> 3. git: \n> 4. gcc, gdb, id: \n> 5. qemu: x86 , 2Bochs\n\n### toolchain \n> 1.linux: linux mint 18.0 serena(ubuntu)\n> 2.git: linux, github\n> ```bash\ngit -h\ngit add/commit/push/checkout\ngit remote add\n```\n> 3.gcc, gdb\n>```bash\nsudo apt-get install build-essential\nsudo apt-get install gcc-multilib\ngcc -h\ngdb -h\n```\n>> Linux6.828 \n>> ```bash\n$ objdump -i\noutput: line2 elf32-i386\n\\\n$ gcc -m32 -print-libgcc-file-name\noutput: /usr/lib/gcc/x86_64-linux-gnu/version/32/libgcc.a\n```\n\n> 4.qemu \na. :\n`sudo apt-get install libsdl1.2-dev, libtool-bin, libglib2.0-dev, libz-dev, libpixman-1-dev.`\nb.qemuxv6, mitqemu, git:\n`git clone https://github.com/geofft/qemu.git -b 6.828-2.3.0`\nc.qemu\n>```bash\ncd qemu\n./configure --disable-kvm --target-list=\"i386-softmmu x86_64-softmmu\"\nmake && make install\n```\n\n> 5.\n> a. WindowsCygwinvirtualbox + ubuntu image, linux\n\n### \n> 1. [6.828 toolchains](https://pdos.csail.mit.edu/6.828/2016/tools.html)\n> 2. [lab guide](https://pdos.csail.mit.edu/6.828/2016/labguide.html)\n> 3. [qemu manual](http://wiki.qemu.org/download/qemu-doc.html#pcsys_005fmonitor)\n> 4. [gdb manual](http://sourceware.org/gdb/current/onlinedocs/gdb/)\n","source":"_posts/lab0.md","raw":"title: lab0-build-env\ndate: 2017/04/08\ntags:\n - xv6\n - os\n\n---\n# lab 0: \n\n### toolchain\n> os, :\n> 1. C: , : x86_64\n> 2. linux: , command line\n> 3. git: \n> 4. gcc, gdb, id: \n> 5. qemu: x86 , 2Bochs\n\n### toolchain \n> 1.linux: linux mint 18.0 serena(ubuntu)\n> 2.git: linux, github\n> ```bash\ngit -h\ngit add/commit/push/checkout\ngit remote add\n```\n> 3.gcc, gdb\n>```bash\nsudo apt-get install build-essential\nsudo apt-get install gcc-multilib\ngcc -h\ngdb -h\n```\n>> Linux6.828 \n>> ```bash\n$ objdump -i\noutput: line2 elf32-i386\n\\\n$ gcc -m32 -print-libgcc-file-name\noutput: /usr/lib/gcc/x86_64-linux-gnu/version/32/libgcc.a\n```\n\n> 4.qemu \na. :\n`sudo apt-get install libsdl1.2-dev, libtool-bin, libglib2.0-dev, libz-dev, libpixman-1-dev.`\nb.qemuxv6, mitqemu, git:\n`git clone https://github.com/geofft/qemu.git -b 6.828-2.3.0`\nc.qemu\n>```bash\ncd qemu\n./configure --disable-kvm --target-list=\"i386-softmmu x86_64-softmmu\"\nmake && make install\n```\n\n> 5.\n> a. WindowsCygwinvirtualbox + ubuntu image, linux\n\n### \n> 1. [6.828 toolchains](https://pdos.csail.mit.edu/6.828/2016/tools.html)\n> 2. [lab guide](https://pdos.csail.mit.edu/6.828/2016/labguide.html)\n> 3. [qemu manual](http://wiki.qemu.org/download/qemu-doc.html#pcsys_005fmonitor)\n> 4. [gdb manual](http://sourceware.org/gdb/current/onlinedocs/gdb/)\n","slug":"lab0","published":1,"updated":"2017-08-26T03:38:21.606Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3h6000ws7am382q59wi","content":"<h1 id=\"lab-0-\"><a href=\"#lab-0-\" class=\"headerlink\" title=\"lab 0: \"></a>lab 0: </h1><h3 id=\"toolchain\"><a href=\"#toolchain\" class=\"headerlink\" title=\"toolchain\"></a>toolchain</h3><blockquote>\n<p>os, :</p>\n<ol>\n<li>C: , : x86_64</li>\n<li>linux: , command line</li>\n<li>git: </li>\n<li>gcc, gdb, id: </li>\n<li>qemu: x86 , 2Bochs</li>\n</ol>\n</blockquote>\n<h3 id=\"toolchain-\"><a href=\"#toolchain-\" class=\"headerlink\" title=\"toolchain \"></a>toolchain </h3><blockquote>\n<p>1.linux: linux mint 18.0 serena(ubuntu)<br>2.git: linux, github<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git -h</span><br><span class=\"line\">git add/commit/push/checkout</span><br><span class=\"line\">git remote add</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>3.gcc, gdb<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get install build-essential</span><br><span class=\"line\">sudo apt-get install gcc-multilib</span><br><span class=\"line\">gcc -h</span><br><span class=\"line\">gdb -h</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>Linux6.828 <br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ objdump -i</span><br><span class=\"line\">output: line2 elf32-i386</span><br><span class=\"line\">\\</span><br><span class=\"line\">$ gcc -m32 -print-libgcc-file-name</span><br><span class=\"line\">output: /usr/lib/gcc/x86_64-linux-gnu/version/32/libgcc.a</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>4.qemu <br>a. :<br><code>sudo apt-get install libsdl1.2-dev, libtool-bin, libglib2.0-dev, libz-dev, libpixman-1-dev.</code><br>b.qemuxv6, mitqemu, git:<br><code>git clone https://github.com/geofft/qemu.git -b 6.828-2.3.0</code><br>c.qemu<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> qemu</span><br><span class=\"line\">./configure --disable-kvm --target-list=<span class=\"string\">\"i386-softmmu x86_64-softmmu\"</span></span><br><span class=\"line\">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>5.<br>a. WindowsCygwinvirtualbox + ubuntu image, linux</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<ol>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/tools.html\" target=\"_blank\" rel=\"noopener\">6.828 toolchains</a></li>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/labguide.html\" target=\"_blank\" rel=\"noopener\">lab guide</a></li>\n<li><a href=\"http://wiki.qemu.org/download/qemu-doc.html#pcsys_005fmonitor\" target=\"_blank\" rel=\"noopener\">qemu manual</a></li>\n<li><a href=\"http://sourceware.org/gdb/current/onlinedocs/gdb/\" target=\"_blank\" rel=\"noopener\">gdb manual</a></li>\n</ol>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"lab-0-\"><a href=\"#lab-0-\" class=\"headerlink\" title=\"lab 0: \"></a>lab 0: </h1><h3 id=\"toolchain\"><a href=\"#toolchain\" class=\"headerlink\" title=\"toolchain\"></a>toolchain</h3><blockquote>\n<p>os, :</p>\n<ol>\n<li>C: , : x86_64</li>\n<li>linux: , command line</li>\n<li>git: </li>\n<li>gcc, gdb, id: </li>\n<li>qemu: x86 , 2Bochs</li>\n</ol>\n</blockquote>\n<h3 id=\"toolchain-\"><a href=\"#toolchain-\" class=\"headerlink\" title=\"toolchain \"></a>toolchain </h3><blockquote>\n<p>1.linux: linux mint 18.0 serena(ubuntu)<br>2.git: linux, github<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git -h</span><br><span class=\"line\">git add/commit/push/checkout</span><br><span class=\"line\">git remote add</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>3.gcc, gdb<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get install build-essential</span><br><span class=\"line\">sudo apt-get install gcc-multilib</span><br><span class=\"line\">gcc -h</span><br><span class=\"line\">gdb -h</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>Linux6.828 <br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ objdump -i</span><br><span class=\"line\">output: line2 elf32-i386</span><br><span class=\"line\">\\</span><br><span class=\"line\">$ gcc -m32 -print-libgcc-file-name</span><br><span class=\"line\">output: /usr/lib/gcc/x86_64-linux-gnu/version/32/libgcc.a</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>4.qemu <br>a. :<br><code>sudo apt-get install libsdl1.2-dev, libtool-bin, libglib2.0-dev, libz-dev, libpixman-1-dev.</code><br>b.qemuxv6, mitqemu, git:<br><code>git clone https://github.com/geofft/qemu.git -b 6.828-2.3.0</code><br>c.qemu<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> qemu</span><br><span class=\"line\">./configure --disable-kvm --target-list=<span class=\"string\">\"i386-softmmu x86_64-softmmu\"</span></span><br><span class=\"line\">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>5.<br>a. WindowsCygwinvirtualbox + ubuntu image, linux</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<ol>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/tools.html\" target=\"_blank\" rel=\"noopener\">6.828 toolchains</a></li>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/labguide.html\" target=\"_blank\" rel=\"noopener\">lab guide</a></li>\n<li><a href=\"http://wiki.qemu.org/download/qemu-doc.html#pcsys_005fmonitor\" target=\"_blank\" rel=\"noopener\">qemu manual</a></li>\n<li><a href=\"http://sourceware.org/gdb/current/onlinedocs/gdb/\" target=\"_blank\" rel=\"noopener\">gdb manual</a></li>\n</ol>\n</blockquote>\n"},{"title":"lab1-boot-pc","date":"2017-04-09T16:00:00.000Z","_content":"\n# Lab1 pc\n## lab1\n> 1.x86qemu x86pc\n2.6.828boot loader\n3.6.828JOSkernel\n\n\n## 1. \n```bash\ngit clone https://pdos.csail.mit.edu/6.828/2016/jos.git lab\ncd lab\n```\n## 2. part1 pc\n###  qemu\n> ` make qemu`\n![make qemu](./boot.png)\nJOShelpkerninfo\n![kerninfo](./kerninfo.png)\n\n<!-- more -->\n\n### PC\n```\n+------------------+  <- 0xFFFFFFFF (4GB)\n|      32-bit      |\n|  memory mapped   |\n|     devices      |\n|                  |\n/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\\n\n/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\\n|                  |\n|      Unused      |\n|                  |\n+------------------+  <- depends on amount of RAM\n|                  |\n|                  |\n| Extended Memory  |\n|                  |\n|                  |\n+------------------+  <- 0x00100000 (1MB)\n|     BIOS ROM     |\n+------------------+  <- 0x000F0000 (960KB)\n|  16-bit devices, |\n|  expansion ROMs  |\n+------------------+  <- 0x000C0000 (768KB)\n|   VGA Display    |\n+------------------+  <- 0x000A0000 (640KB)\n|                  |\n|    Low Memory    |\n|                  |\n+------------------+  <- 0x00000000\n```\n>16Intel 80881MB0x000000000x000FFFFF640KB Low memory(RAM)\n 0x000A0000  0x000FFFFF384KB 0x000F0000  0x000FFFFF 64KBBIOS.\nx864GBRAMRAM0xFFFFFFFFBIOS3232JOS256MBPC32\n\n### **BIOS**\n>  make qemu-gdb,  make gdb.\n> ```asm\n[f000:fff0] 0xffff0: ljmp 0xf000, 0xe05b\n> ```\n> GDB\nIBM PC  0x000ffff0,PC  CS = 0xf000IP = 0xfff0. jmp CS = 0xf000IP = 0xe05b\nQEMU8088BIOS CS  0xf000IP  0xfff0 = 16 *  +  PC  CS  0xf000 IP  0xfff0 \n   16 * 0xf000 + 0xfff0   # 16,4\n   = 0xf0000 + 0xfff0\n   = 0xffff0\n0xffff0  BIOS (0x100000) \nBIOSVGAPCIboot loader \n\n## Part 2: The Boot Loader\n> 512 byteBIOS0x7c000x7dffjmp CS:IP  0000:7c00 boot loader 512\n>> 1. boot loader 1MB\n2. boot loader \n\n### Boot\n>  `b *0x7c00``c``x/i` \n\n> 32\n>>`[0:7c2d] => 0x7c2d: ljmp $0x8,$0x7c32 `boot.S  `ljmp $PROT_MODE_CSEG, $protcseg` ` 0x7c32 `\n\n>  boot loader , \n>> boot loader kernel boot/main.c  \n>> ```c\n\\* call the entry point from the ELF header\n((void (*)(void)) (ELFHDR->e_entry))()\n```\n>ELF\n `objdump -x obj/kern/kernel `kernel` start address 0x0010000c` `b *0x10000c`` c`  `movw $0x1234,0x472`.\n\n>kernel\n>> kern/entry.S\n\n> 0x7c00boot sector/boot/boot.Sboot.Sobj/boot/boot.asm.GDBx/iboot.Sboot.asmGDB\nbootmainreadsect()readsect()cbootmain()for\n\n> boot.S\n```asm\nstart:\n  .code16                     # 16\n  cli                         # \n  cld                         # DFDF=0\n```\n>```asm\n  lgdt    gdtdesc\n  movl    %cr0, %eax\n  orl     $CR0_PE_ON, %eax\n  movl    %eax, %cr0\n# GDT(Global Descriptor Table)cr0$CR0_PE_ON0x1flag\n```\n>```asm\n  movl    $start, %esp\n  call bootmain\n  # bootmain\n```\n>```asm\n    7d15:    55                       push   %ebp\n    7d16:    89 e5                    mov    %esp,%ebp\n    7d18:    56                       push   %esi\n    7d19:    53                       push   %ebx\n    # , \n```\n>```asm\n    // read 1st page off disk\n    readseg((uint32_t) ELFHDR, SECTSIZE*8, 0);\n    7d1a:    6a 00                    push   $0x0\n    7d1c:    68 00 10 00 00           push   $0x1000\n    7d21:    68 00 00 01 00           push   $0x10000\n    7d26:    e8 b1 ff ff ff           call   7cdc <readseg>\n    # readseg3()\n```\n>```asm\n0x7ceb: shr $0x9,%edi \n#  offset = (offset / SECTSIZE) + 1, \n0x7cee: add %ebx,%esi \n#  end_pa = pa + count, \n0x7cf0: inc %edi \n#  offset = (offset / SECTSIZE) + 11\n0x7cf1: and $0xfffffe00,%ebx \n#  pa &= ~(SECTSIZE - 1);\n0x7cf7:    cmp    %esi,%ebx\n0x7cf9:    jae    0x7d0d\n#  while (pa < end_pa) \n```\n>```asm\n# \n7d3a:    a1 1c 00 01 00           mov    0x1001c,%eax\n7d3f:    0f b7 35 2c 00 01 00     movzwl 0x1002c,%esi\n7d46:    8d 98 00 00 01 00        lea    0x10000(%eax),%ebx\n7d4c:    c1 e6 05                 shl    $0x5,%esi\n7d4f:    01 de                    add    %ebx,%esi\n# readsegProgram Header Table\n# \n((void (*)(void)) (ELFHDR->e_entry))();\n```\n\n### \n>  boot/main.cELFJOSC(.c)(.o)binary image obj/kern/kernelELF()\nELFboot loader \nELFELFELF inc/elf.h 3\n>>.text: \n.rodata:ASCII\n.data: \n\n>.data.bssC0ELF.bss.bss\n `objdump -h obj/kern/kernel `ELF\n .text VMA()LMA()\n boot/main.c ph->p_paBIOS0x7c00 boot/Makefrag  -Ttext 0x7C00 \n\n\n## Part 3: The Kernel\n### \n> boot loader  kernel  kern/kernel.ld  0xF0100000\n 0xf0100000\n 0xf0100000 0xf0100000 () 0x00100000 (boot loader)1MBBIOSROMPC1MB\nlab256MB 0x00000000  0x0fffffff0xf0000000~0xffffffffJOS256MB\n4MB  kern/entrypgdir.c kern/entry.S  CR0_PG entry_pgdir  0xf0000000 ~ 0xf0400000  0x00000000 ~ 0x00400000 0x00000000 ~ 0x00400000  0x00000000 ~ 0x00400000\n\n### \n> Cx86?(IP)\n\n kern/entry.S \n> ```asm\n    # Clear the frame pointer register (EBP)\n    # so that once we get into debugging C code,\n    # stack backtraces will be terminated properly.\n    movl    $0x0,%ebp            # nuke frame pointer\n\n    # Set the stack pointer\n    movl    $(bootstacktop),%esp\n```\n> gdb` b *0x10000c ` entry si  `0x10002d: jmp *%eax ` `0xf010002f <relocated>: mov $0x0,%ebp` `0x10002f` `0xf010002f `\n gdb  `0xf0100034 <relocated+5>: mov $0xf0110000,%esp` %espbootstacktop0xf0110000 kern/entry.S  KSTKSIZE  inc/memlayout.h \n```c\n// Kernel stack.\n#define KSTACKTOP    KERNBASE\n#define KSTKSIZE    (8*PGSIZE)           // size of a kernel stack\n#define KSTKGAP        (8*PGSIZE)           // size of a kernel stack guard\n# PGSIZE  inc/mmu.h  4096 KSTKSIZE  32KB  info registersespebpbootstacktop0xf0110000\n```\n\n##  \n> * [boot pc](https://pdos.csail.mit.edu/6.828/2016/labs/lab1/)","source":"_posts/lab1.md","raw":"title: lab1-boot-pc\ndate: 2017/04/10\ntags:\n - xv6\n - os\n\n---\n\n# Lab1 pc\n## lab1\n> 1.x86qemu x86pc\n2.6.828boot loader\n3.6.828JOSkernel\n\n\n## 1. \n```bash\ngit clone https://pdos.csail.mit.edu/6.828/2016/jos.git lab\ncd lab\n```\n## 2. part1 pc\n###  qemu\n> ` make qemu`\n![make qemu](./boot.png)\nJOShelpkerninfo\n![kerninfo](./kerninfo.png)\n\n<!-- more -->\n\n### PC\n```\n+------------------+  <- 0xFFFFFFFF (4GB)\n|      32-bit      |\n|  memory mapped   |\n|     devices      |\n|                  |\n/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\\n\n/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\\n|                  |\n|      Unused      |\n|                  |\n+------------------+  <- depends on amount of RAM\n|                  |\n|                  |\n| Extended Memory  |\n|                  |\n|                  |\n+------------------+  <- 0x00100000 (1MB)\n|     BIOS ROM     |\n+------------------+  <- 0x000F0000 (960KB)\n|  16-bit devices, |\n|  expansion ROMs  |\n+------------------+  <- 0x000C0000 (768KB)\n|   VGA Display    |\n+------------------+  <- 0x000A0000 (640KB)\n|                  |\n|    Low Memory    |\n|                  |\n+------------------+  <- 0x00000000\n```\n>16Intel 80881MB0x000000000x000FFFFF640KB Low memory(RAM)\n 0x000A0000  0x000FFFFF384KB 0x000F0000  0x000FFFFF 64KBBIOS.\nx864GBRAMRAM0xFFFFFFFFBIOS3232JOS256MBPC32\n\n### **BIOS**\n>  make qemu-gdb,  make gdb.\n> ```asm\n[f000:fff0] 0xffff0: ljmp 0xf000, 0xe05b\n> ```\n> GDB\nIBM PC  0x000ffff0,PC  CS = 0xf000IP = 0xfff0. jmp CS = 0xf000IP = 0xe05b\nQEMU8088BIOS CS  0xf000IP  0xfff0 = 16 *  +  PC  CS  0xf000 IP  0xfff0 \n   16 * 0xf000 + 0xfff0   # 16,4\n   = 0xf0000 + 0xfff0\n   = 0xffff0\n0xffff0  BIOS (0x100000) \nBIOSVGAPCIboot loader \n\n## Part 2: The Boot Loader\n> 512 byteBIOS0x7c000x7dffjmp CS:IP  0000:7c00 boot loader 512\n>> 1. boot loader 1MB\n2. boot loader \n\n### Boot\n>  `b *0x7c00``c``x/i` \n\n> 32\n>>`[0:7c2d] => 0x7c2d: ljmp $0x8,$0x7c32 `boot.S  `ljmp $PROT_MODE_CSEG, $protcseg` ` 0x7c32 `\n\n>  boot loader , \n>> boot loader kernel boot/main.c  \n>> ```c\n\\* call the entry point from the ELF header\n((void (*)(void)) (ELFHDR->e_entry))()\n```\n>ELF\n `objdump -x obj/kern/kernel `kernel` start address 0x0010000c` `b *0x10000c`` c`  `movw $0x1234,0x472`.\n\n>kernel\n>> kern/entry.S\n\n> 0x7c00boot sector/boot/boot.Sboot.Sobj/boot/boot.asm.GDBx/iboot.Sboot.asmGDB\nbootmainreadsect()readsect()cbootmain()for\n\n> boot.S\n```asm\nstart:\n  .code16                     # 16\n  cli                         # \n  cld                         # DFDF=0\n```\n>```asm\n  lgdt    gdtdesc\n  movl    %cr0, %eax\n  orl     $CR0_PE_ON, %eax\n  movl    %eax, %cr0\n# GDT(Global Descriptor Table)cr0$CR0_PE_ON0x1flag\n```\n>```asm\n  movl    $start, %esp\n  call bootmain\n  # bootmain\n```\n>```asm\n    7d15:    55                       push   %ebp\n    7d16:    89 e5                    mov    %esp,%ebp\n    7d18:    56                       push   %esi\n    7d19:    53                       push   %ebx\n    # , \n```\n>```asm\n    // read 1st page off disk\n    readseg((uint32_t) ELFHDR, SECTSIZE*8, 0);\n    7d1a:    6a 00                    push   $0x0\n    7d1c:    68 00 10 00 00           push   $0x1000\n    7d21:    68 00 00 01 00           push   $0x10000\n    7d26:    e8 b1 ff ff ff           call   7cdc <readseg>\n    # readseg3()\n```\n>```asm\n0x7ceb: shr $0x9,%edi \n#  offset = (offset / SECTSIZE) + 1, \n0x7cee: add %ebx,%esi \n#  end_pa = pa + count, \n0x7cf0: inc %edi \n#  offset = (offset / SECTSIZE) + 11\n0x7cf1: and $0xfffffe00,%ebx \n#  pa &= ~(SECTSIZE - 1);\n0x7cf7:    cmp    %esi,%ebx\n0x7cf9:    jae    0x7d0d\n#  while (pa < end_pa) \n```\n>```asm\n# \n7d3a:    a1 1c 00 01 00           mov    0x1001c,%eax\n7d3f:    0f b7 35 2c 00 01 00     movzwl 0x1002c,%esi\n7d46:    8d 98 00 00 01 00        lea    0x10000(%eax),%ebx\n7d4c:    c1 e6 05                 shl    $0x5,%esi\n7d4f:    01 de                    add    %ebx,%esi\n# readsegProgram Header Table\n# \n((void (*)(void)) (ELFHDR->e_entry))();\n```\n\n### \n>  boot/main.cELFJOSC(.c)(.o)binary image obj/kern/kernelELF()\nELFboot loader \nELFELFELF inc/elf.h 3\n>>.text: \n.rodata:ASCII\n.data: \n\n>.data.bssC0ELF.bss.bss\n `objdump -h obj/kern/kernel `ELF\n .text VMA()LMA()\n boot/main.c ph->p_paBIOS0x7c00 boot/Makefrag  -Ttext 0x7C00 \n\n\n## Part 3: The Kernel\n### \n> boot loader  kernel  kern/kernel.ld  0xF0100000\n 0xf0100000\n 0xf0100000 0xf0100000 () 0x00100000 (boot loader)1MBBIOSROMPC1MB\nlab256MB 0x00000000  0x0fffffff0xf0000000~0xffffffffJOS256MB\n4MB  kern/entrypgdir.c kern/entry.S  CR0_PG entry_pgdir  0xf0000000 ~ 0xf0400000  0x00000000 ~ 0x00400000 0x00000000 ~ 0x00400000  0x00000000 ~ 0x00400000\n\n### \n> Cx86?(IP)\n\n kern/entry.S \n> ```asm\n    # Clear the frame pointer register (EBP)\n    # so that once we get into debugging C code,\n    # stack backtraces will be terminated properly.\n    movl    $0x0,%ebp            # nuke frame pointer\n\n    # Set the stack pointer\n    movl    $(bootstacktop),%esp\n```\n> gdb` b *0x10000c ` entry si  `0x10002d: jmp *%eax ` `0xf010002f <relocated>: mov $0x0,%ebp` `0x10002f` `0xf010002f `\n gdb  `0xf0100034 <relocated+5>: mov $0xf0110000,%esp` %espbootstacktop0xf0110000 kern/entry.S  KSTKSIZE  inc/memlayout.h \n```c\n// Kernel stack.\n#define KSTACKTOP    KERNBASE\n#define KSTKSIZE    (8*PGSIZE)           // size of a kernel stack\n#define KSTKGAP        (8*PGSIZE)           // size of a kernel stack guard\n# PGSIZE  inc/mmu.h  4096 KSTKSIZE  32KB  info registersespebpbootstacktop0xf0110000\n```\n\n##  \n> * [boot pc](https://pdos.csail.mit.edu/6.828/2016/labs/lab1/)","slug":"lab1","published":1,"updated":"2017-08-26T03:38:21.606Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3h7000ys7am07701bt1","content":"<h1 id=\"Lab1-pc\"><a href=\"#Lab1-pc\" class=\"headerlink\" title=\"Lab1 pc\"></a>Lab1 pc</h1><h2 id=\"lab1\"><a href=\"#lab1\" class=\"headerlink\" title=\"lab1\"></a>lab1</h2><blockquote>\n<p>1.x86qemu x86pc<br>2.6.828boot loader<br>3.6.828JOSkernel</p>\n</blockquote>\n<h2 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://pdos.csail.mit.edu/6.828/2016/jos.git lab</span><br><span class=\"line\"><span class=\"built_in\">cd</span> lab</span><br></pre></td></tr></table></figure>\n<h2 id=\"2-part1-pc\"><a href=\"#2-part1-pc\" class=\"headerlink\" title=\"2. part1 pc\"></a>2. part1 pc</h2><h3 id=\"-qemu\"><a href=\"#-qemu\" class=\"headerlink\" title=\" qemu\"></a> qemu</h3><blockquote>\n<p><code>make qemu</code><br><img src=\"./boot.png\" alt=\"make qemu\"><br>JOShelpkerninfo<br><img src=\"./kerninfo.png\" alt=\"kerninfo\"></p>\n</blockquote>\n<a id=\"more\"></a>\n<h3 id=\"PC\"><a href=\"#PC\" class=\"headerlink\" title=\"PC\"></a>PC</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+------------------+  &lt;- 0xFFFFFFFF (4GB)</span><br><span class=\"line\">|      32-bit      |</span><br><span class=\"line\">|  memory mapped   |</span><br><span class=\"line\">|     devices      |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\</span><br><span class=\"line\"></span><br><span class=\"line\">/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">|      Unused      |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">+------------------+  &lt;- depends on amount of RAM</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">| Extended Memory  |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">+------------------+  &lt;- 0x00100000 (1MB)</span><br><span class=\"line\">|     BIOS ROM     |</span><br><span class=\"line\">+------------------+  &lt;- 0x000F0000 (960KB)</span><br><span class=\"line\">|  16-bit devices, |</span><br><span class=\"line\">|  expansion ROMs  |</span><br><span class=\"line\">+------------------+  &lt;- 0x000C0000 (768KB)</span><br><span class=\"line\">|   VGA Display    |</span><br><span class=\"line\">+------------------+  &lt;- 0x000A0000 (640KB)</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">|    Low Memory    |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">+------------------+  &lt;- 0x00000000</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>16Intel 80881MB0x000000000x000FFFFF640KB Low memory(RAM)<br> 0x000A0000  0x000FFFFF384KB 0x000F0000  0x000FFFFF 64KBBIOS.<br>x864GBRAMRAM0xFFFFFFFFBIOS3232JOS256MBPC32</p>\n</blockquote>\n<h3 id=\"BIOS\"><a href=\"#BIOS\" class=\"headerlink\" title=\"BIOS\"></a><strong>BIOS</strong></h3><blockquote>\n<p> make qemu-gdb,  make gdb.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[f000:fff0] 0xffff0: ljmp 0xf000, 0xe05b</span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>GDB<br>IBM PC  0x000ffff0,PC  CS = 0xf000IP = 0xfff0. jmp CS = 0xf000IP = 0xe05b<br>QEMU8088BIOS CS  0xf000IP  0xfff0 = 16 <em>  +  PC  CS  0xf000 IP  0xfff0 <br>   16 </em> 0xf000 + 0xfff0   # 16,4<br>   = 0xf0000 + 0xfff0<br>   = 0xffff0<br>0xffff0  BIOS (0x100000) <br>BIOSVGAPCIboot loader </p>\n</blockquote>\n<h2 id=\"Part-2-The-Boot-Loader\"><a href=\"#Part-2-The-Boot-Loader\" class=\"headerlink\" title=\"Part 2: The Boot Loader\"></a>Part 2: The Boot Loader</h2><blockquote>\n<p>512 byteBIOS0x7c000x7dffjmp CS:IP  0000:7c00 boot loader 512</p>\n<blockquote>\n<ol>\n<li>boot loader 1MB</li>\n<li>boot loader </li>\n</ol>\n</blockquote>\n</blockquote>\n<h3 id=\"Boot\"><a href=\"#Boot\" class=\"headerlink\" title=\"Boot\"></a>Boot</h3><blockquote>\n<p> <code>b *0x7c00</code><code>c</code><code>x/i</code> </p>\n</blockquote>\n<blockquote>\n<p>32</p>\n<blockquote>\n<p><code>[0:7c2d] =&gt; 0x7c2d: ljmp $0x8,$0x7c32</code>boot.S  <code>ljmp $PROT_MODE_CSEG, $protcseg</code> <code>0x7c32</code></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p> boot loader , </p>\n<blockquote>\n<p>boot loader kernel boot/main.c <br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\* call the entry point from the ELF header</span><br><span class=\"line\">((<span class=\"keyword\">void</span> (*)(<span class=\"keyword\">void</span>)) (ELFHDR-&gt;e_entry))()</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>ELF<br> <code>objdump -x obj/kern/kernel</code>kernel<code>start address 0x0010000c</code> <code>b *0x10000c</code><code>c</code>  <code>movw $0x1234,0x472</code>.</p>\n</blockquote>\n<blockquote>\n<p>kernel</p>\n<blockquote>\n<p>kern/entry.S</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>0x7c00boot sector/boot/boot.Sboot.Sobj/boot/boot.asm.GDBx/iboot.Sboot.asmGDB<br>bootmainreadsect()readsect()cbootmain()for</p>\n</blockquote>\n<blockquote>\n<p>boot.S<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">start:</span><br><span class=\"line\">  .code16                     # 16</span><br><span class=\"line\">  cli                         # </span><br><span class=\"line\">  cld                         # DFDF=0</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  lgdt    gdtdesc</span><br><span class=\"line\">  movl    %cr0, %eax</span><br><span class=\"line\">  orl     $CR0_PE_ON, %eax</span><br><span class=\"line\">  movl    %eax, %cr0</span><br><span class=\"line\"># GDT(Global Descriptor Table)cr0$CR0_PE_ON0x1flag</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">movl    $start, %esp</span><br><span class=\"line\">call bootmain</span><br><span class=\"line\"># bootmain</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">7d15:    55                       push   %ebp</span><br><span class=\"line\">7d16:    89 e5                    mov    %esp,%ebp</span><br><span class=\"line\">7d18:    56                       push   %esi</span><br><span class=\"line\">7d19:    53                       push   %ebx</span><br><span class=\"line\"># , </span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// read 1st page off disk</span><br><span class=\"line\">readseg((uint32_t) ELFHDR, SECTSIZE*8, 0);</span><br><span class=\"line\">7d1a:    6a 00                    push   $0x0</span><br><span class=\"line\">7d1c:    68 00 10 00 00           push   $0x1000</span><br><span class=\"line\">7d21:    68 00 00 01 00           push   $0x10000</span><br><span class=\"line\">7d26:    e8 b1 ff ff ff           call   7cdc &lt;readseg&gt;</span><br><span class=\"line\"># readseg3()</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x7ceb: shr $0x9,%edi </span><br><span class=\"line\">#  offset = (offset / SECTSIZE) + 1, </span><br><span class=\"line\">0x7cee: add %ebx,%esi </span><br><span class=\"line\">#  end_pa = pa + count, </span><br><span class=\"line\">0x7cf0: inc %edi </span><br><span class=\"line\">#  offset = (offset / SECTSIZE) + 11</span><br><span class=\"line\">0x7cf1: and $0xfffffe00,%ebx </span><br><span class=\"line\">#  pa &amp;= ~(SECTSIZE - 1);</span><br><span class=\"line\">0x7cf7:    cmp    %esi,%ebx</span><br><span class=\"line\">0x7cf9:    jae    0x7d0d</span><br><span class=\"line\">#  while (pa &lt; end_pa) </span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># </span><br><span class=\"line\">7d3a:    a1 1c 00 01 00           mov    0x1001c,%eax</span><br><span class=\"line\">7d3f:    0f b7 35 2c 00 01 00     movzwl 0x1002c,%esi</span><br><span class=\"line\">7d46:    8d 98 00 00 01 00        lea    0x10000(%eax),%ebx</span><br><span class=\"line\">7d4c:    c1 e6 05                 shl    $0x5,%esi</span><br><span class=\"line\">7d4f:    01 de                    add    %ebx,%esi</span><br><span class=\"line\"># readsegProgram Header Table</span><br><span class=\"line\"># </span><br><span class=\"line\">((void (*)(void)) (ELFHDR-&gt;e_entry))();</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p> boot/main.cELFJOSC(.c)(.o)binary image obj/kern/kernelELF()<br>ELFboot loader <br>ELFELFELF inc/elf.h 3</p>\n<blockquote>\n<p>.text: <br>.rodata:ASCII<br>.data: </p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>.data.bssC0ELF.bss.bss<br> <code>objdump -h obj/kern/kernel</code>ELF<br> .text VMA()LMA()<br> boot/main.c ph-&gt;p_paBIOS0x7c00 boot/Makefrag  -Ttext 0x7C00 </p>\n</blockquote>\n<h2 id=\"Part-3-The-Kernel\"><a href=\"#Part-3-The-Kernel\" class=\"headerlink\" title=\"Part 3: The Kernel\"></a>Part 3: The Kernel</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>boot loader  kernel  kern/kernel.ld  0xF0100000<br> 0xf0100000<br> 0xf0100000 0xf0100000 () 0x00100000 (boot loader)1MBBIOSROMPC1MB<br>lab256MB 0x00000000  0x0fffffff0xf0000000~0xffffffffJOS256MB<br>4MB  kern/entrypgdir.c kern/entry.S  CR0_PG entry_pgdir  0xf0000000 ~ 0xf0400000  0x00000000 ~ 0x00400000 0x00000000 ~ 0x00400000  0x00000000 ~ 0x00400000</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>Cx86?(IP)<br><br> kern/entry.S <br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Clear the frame pointer register (EBP)</span><br><span class=\"line\"># so that once we get into debugging C code,</span><br><span class=\"line\"># stack backtraces will be terminated properly.</span><br><span class=\"line\">movl    $0x0,%ebp            # nuke frame pointer</span><br><span class=\"line\"></span><br><span class=\"line\"># Set the stack pointer</span><br><span class=\"line\">movl    $(bootstacktop),%esp</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>gdb<code>b *0x10000c</code> entry si  <code>0x10002d: jmp *%eax</code> <code>0xf010002f &lt;relocated&gt;: mov $0x0,%ebp</code> <code>0x10002f</code> <code>0xf010002f</code><br> gdb  <code>0xf0100034 &lt;relocated+5&gt;: mov $0xf0110000,%esp</code> %espbootstacktop0xf0110000 kern/entry.S  KSTKSIZE  inc/memlayout.h <br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Kernel stack.</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> KSTACKTOP    KERNBASE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> KSTKSIZE    (8*PGSIZE)           <span class=\"comment\">// size of a kernel stack</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> KSTKGAP        (8*PGSIZE)           <span class=\"comment\">// size of a kernel stack guard</span></span></span><br><span class=\"line\"># PGSIZE  inc/mmu.h  <span class=\"number\">4096</span> KSTKSIZE  <span class=\"number\">32</span>KB  info registersespebpbootstacktop<span class=\"number\">0xf0110000</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><blockquote>\n<ul>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/labs/lab1/\" target=\"_blank\" rel=\"noopener\">boot pc</a></li>\n</ul>\n</blockquote>\n","site":{"data":{}},"excerpt":"<h1 id=\"Lab1-pc\"><a href=\"#Lab1-pc\" class=\"headerlink\" title=\"Lab1 pc\"></a>Lab1 pc</h1><h2 id=\"lab1\"><a href=\"#lab1\" class=\"headerlink\" title=\"lab1\"></a>lab1</h2><blockquote>\n<p>1.x86qemu x86pc<br>2.6.828boot loader<br>3.6.828JOSkernel</p>\n</blockquote>\n<h2 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://pdos.csail.mit.edu/6.828/2016/jos.git lab</span><br><span class=\"line\"><span class=\"built_in\">cd</span> lab</span><br></pre></td></tr></table></figure>\n<h2 id=\"2-part1-pc\"><a href=\"#2-part1-pc\" class=\"headerlink\" title=\"2. part1 pc\"></a>2. part1 pc</h2><h3 id=\"-qemu\"><a href=\"#-qemu\" class=\"headerlink\" title=\" qemu\"></a> qemu</h3><blockquote>\n<p><code>make qemu</code><br><img src=\"./boot.png\" alt=\"make qemu\"><br>JOShelpkerninfo<br><img src=\"./kerninfo.png\" alt=\"kerninfo\"></p>\n</blockquote>","more":"<h3 id=\"PC\"><a href=\"#PC\" class=\"headerlink\" title=\"PC\"></a>PC</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+------------------+  &lt;- 0xFFFFFFFF (4GB)</span><br><span class=\"line\">|      32-bit      |</span><br><span class=\"line\">|  memory mapped   |</span><br><span class=\"line\">|     devices      |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\</span><br><span class=\"line\"></span><br><span class=\"line\">/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">|      Unused      |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">+------------------+  &lt;- depends on amount of RAM</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">| Extended Memory  |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">+------------------+  &lt;- 0x00100000 (1MB)</span><br><span class=\"line\">|     BIOS ROM     |</span><br><span class=\"line\">+------------------+  &lt;- 0x000F0000 (960KB)</span><br><span class=\"line\">|  16-bit devices, |</span><br><span class=\"line\">|  expansion ROMs  |</span><br><span class=\"line\">+------------------+  &lt;- 0x000C0000 (768KB)</span><br><span class=\"line\">|   VGA Display    |</span><br><span class=\"line\">+------------------+  &lt;- 0x000A0000 (640KB)</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">|    Low Memory    |</span><br><span class=\"line\">|                  |</span><br><span class=\"line\">+------------------+  &lt;- 0x00000000</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>16Intel 80881MB0x000000000x000FFFFF640KB Low memory(RAM)<br> 0x000A0000  0x000FFFFF384KB 0x000F0000  0x000FFFFF 64KBBIOS.<br>x864GBRAMRAM0xFFFFFFFFBIOS3232JOS256MBPC32</p>\n</blockquote>\n<h3 id=\"BIOS\"><a href=\"#BIOS\" class=\"headerlink\" title=\"BIOS\"></a><strong>BIOS</strong></h3><blockquote>\n<p> make qemu-gdb,  make gdb.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[f000:fff0] 0xffff0: ljmp 0xf000, 0xe05b</span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>GDB<br>IBM PC  0x000ffff0,PC  CS = 0xf000IP = 0xfff0. jmp CS = 0xf000IP = 0xe05b<br>QEMU8088BIOS CS  0xf000IP  0xfff0 = 16 <em>  +  PC  CS  0xf000 IP  0xfff0 <br>   16 </em> 0xf000 + 0xfff0   # 16,4<br>   = 0xf0000 + 0xfff0<br>   = 0xffff0<br>0xffff0  BIOS (0x100000) <br>BIOSVGAPCIboot loader </p>\n</blockquote>\n<h2 id=\"Part-2-The-Boot-Loader\"><a href=\"#Part-2-The-Boot-Loader\" class=\"headerlink\" title=\"Part 2: The Boot Loader\"></a>Part 2: The Boot Loader</h2><blockquote>\n<p>512 byteBIOS0x7c000x7dffjmp CS:IP  0000:7c00 boot loader 512</p>\n<blockquote>\n<ol>\n<li>boot loader 1MB</li>\n<li>boot loader </li>\n</ol>\n</blockquote>\n</blockquote>\n<h3 id=\"Boot\"><a href=\"#Boot\" class=\"headerlink\" title=\"Boot\"></a>Boot</h3><blockquote>\n<p> <code>b *0x7c00</code><code>c</code><code>x/i</code> </p>\n</blockquote>\n<blockquote>\n<p>32</p>\n<blockquote>\n<p><code>[0:7c2d] =&gt; 0x7c2d: ljmp $0x8,$0x7c32</code>boot.S  <code>ljmp $PROT_MODE_CSEG, $protcseg</code> <code>0x7c32</code></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p> boot loader , </p>\n<blockquote>\n<p>boot loader kernel boot/main.c <br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\* call the entry point from the ELF header</span><br><span class=\"line\">((<span class=\"keyword\">void</span> (*)(<span class=\"keyword\">void</span>)) (ELFHDR-&gt;e_entry))()</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>ELF<br> <code>objdump -x obj/kern/kernel</code>kernel<code>start address 0x0010000c</code> <code>b *0x10000c</code><code>c</code>  <code>movw $0x1234,0x472</code>.</p>\n</blockquote>\n<blockquote>\n<p>kernel</p>\n<blockquote>\n<p>kern/entry.S</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>0x7c00boot sector/boot/boot.Sboot.Sobj/boot/boot.asm.GDBx/iboot.Sboot.asmGDB<br>bootmainreadsect()readsect()cbootmain()for</p>\n</blockquote>\n<blockquote>\n<p>boot.S<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">start:</span><br><span class=\"line\">  .code16                     # 16</span><br><span class=\"line\">  cli                         # </span><br><span class=\"line\">  cld                         # DFDF=0</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  lgdt    gdtdesc</span><br><span class=\"line\">  movl    %cr0, %eax</span><br><span class=\"line\">  orl     $CR0_PE_ON, %eax</span><br><span class=\"line\">  movl    %eax, %cr0</span><br><span class=\"line\"># GDT(Global Descriptor Table)cr0$CR0_PE_ON0x1flag</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">movl    $start, %esp</span><br><span class=\"line\">call bootmain</span><br><span class=\"line\"># bootmain</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">7d15:    55                       push   %ebp</span><br><span class=\"line\">7d16:    89 e5                    mov    %esp,%ebp</span><br><span class=\"line\">7d18:    56                       push   %esi</span><br><span class=\"line\">7d19:    53                       push   %ebx</span><br><span class=\"line\"># , </span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// read 1st page off disk</span><br><span class=\"line\">readseg((uint32_t) ELFHDR, SECTSIZE*8, 0);</span><br><span class=\"line\">7d1a:    6a 00                    push   $0x0</span><br><span class=\"line\">7d1c:    68 00 10 00 00           push   $0x1000</span><br><span class=\"line\">7d21:    68 00 00 01 00           push   $0x10000</span><br><span class=\"line\">7d26:    e8 b1 ff ff ff           call   7cdc &lt;readseg&gt;</span><br><span class=\"line\"># readseg3()</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x7ceb: shr $0x9,%edi </span><br><span class=\"line\">#  offset = (offset / SECTSIZE) + 1, </span><br><span class=\"line\">0x7cee: add %ebx,%esi </span><br><span class=\"line\">#  end_pa = pa + count, </span><br><span class=\"line\">0x7cf0: inc %edi </span><br><span class=\"line\">#  offset = (offset / SECTSIZE) + 11</span><br><span class=\"line\">0x7cf1: and $0xfffffe00,%ebx </span><br><span class=\"line\">#  pa &amp;= ~(SECTSIZE - 1);</span><br><span class=\"line\">0x7cf7:    cmp    %esi,%ebx</span><br><span class=\"line\">0x7cf9:    jae    0x7d0d</span><br><span class=\"line\">#  while (pa &lt; end_pa) </span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># </span><br><span class=\"line\">7d3a:    a1 1c 00 01 00           mov    0x1001c,%eax</span><br><span class=\"line\">7d3f:    0f b7 35 2c 00 01 00     movzwl 0x1002c,%esi</span><br><span class=\"line\">7d46:    8d 98 00 00 01 00        lea    0x10000(%eax),%ebx</span><br><span class=\"line\">7d4c:    c1 e6 05                 shl    $0x5,%esi</span><br><span class=\"line\">7d4f:    01 de                    add    %ebx,%esi</span><br><span class=\"line\"># readsegProgram Header Table</span><br><span class=\"line\"># </span><br><span class=\"line\">((void (*)(void)) (ELFHDR-&gt;e_entry))();</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p> boot/main.cELFJOSC(.c)(.o)binary image obj/kern/kernelELF()<br>ELFboot loader <br>ELFELFELF inc/elf.h 3</p>\n<blockquote>\n<p>.text: <br>.rodata:ASCII<br>.data: </p>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>.data.bssC0ELF.bss.bss<br> <code>objdump -h obj/kern/kernel</code>ELF<br> .text VMA()LMA()<br> boot/main.c ph-&gt;p_paBIOS0x7c00 boot/Makefrag  -Ttext 0x7C00 </p>\n</blockquote>\n<h2 id=\"Part-3-The-Kernel\"><a href=\"#Part-3-The-Kernel\" class=\"headerlink\" title=\"Part 3: The Kernel\"></a>Part 3: The Kernel</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>boot loader  kernel  kern/kernel.ld  0xF0100000<br> 0xf0100000<br> 0xf0100000 0xf0100000 () 0x00100000 (boot loader)1MBBIOSROMPC1MB<br>lab256MB 0x00000000  0x0fffffff0xf0000000~0xffffffffJOS256MB<br>4MB  kern/entrypgdir.c kern/entry.S  CR0_PG entry_pgdir  0xf0000000 ~ 0xf0400000  0x00000000 ~ 0x00400000 0x00000000 ~ 0x00400000  0x00000000 ~ 0x00400000</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>Cx86?(IP)<br><br> kern/entry.S <br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Clear the frame pointer register (EBP)</span><br><span class=\"line\"># so that once we get into debugging C code,</span><br><span class=\"line\"># stack backtraces will be terminated properly.</span><br><span class=\"line\">movl    $0x0,%ebp            # nuke frame pointer</span><br><span class=\"line\"></span><br><span class=\"line\"># Set the stack pointer</span><br><span class=\"line\">movl    $(bootstacktop),%esp</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>gdb<code>b *0x10000c</code> entry si  <code>0x10002d: jmp *%eax</code> <code>0xf010002f &lt;relocated&gt;: mov $0x0,%ebp</code> <code>0x10002f</code> <code>0xf010002f</code><br> gdb  <code>0xf0100034 &lt;relocated+5&gt;: mov $0xf0110000,%esp</code> %espbootstacktop0xf0110000 kern/entry.S  KSTKSIZE  inc/memlayout.h <br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Kernel stack.</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> KSTACKTOP    KERNBASE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> KSTKSIZE    (8*PGSIZE)           <span class=\"comment\">// size of a kernel stack</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> KSTKGAP        (8*PGSIZE)           <span class=\"comment\">// size of a kernel stack guard</span></span></span><br><span class=\"line\"># PGSIZE  inc/mmu.h  <span class=\"number\">4096</span> KSTKSIZE  <span class=\"number\">32</span>KB  info registersespebpbootstacktop<span class=\"number\">0xf0110000</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><blockquote>\n<ul>\n<li><a href=\"https://pdos.csail.mit.edu/6.828/2016/labs/lab1/\" target=\"_blank\" rel=\"noopener\">boot pc</a></li>\n</ul>\n</blockquote>"},{"title":"lab2-memeory-management","date":"2017-04-17T16:00:00.000Z","_content":"\n# Lab2 \n## \n> * :\n> 1.  .4096,\n> 2.  x86MMU lab2JOSMMU\n\n> - lab1\n> 1. part1:  physical page management\n> 2. part2:  virtual memory\n> 3. part3:  kernel address space\n\n<!-- more -->\n\n## \n> ```bash\n cd ~/6.828/lab\n git checkout -b lab2 origin/lab2\n git merge lab1\n```\n> Lab 2 :\n```bash\ninc/memlayout.h\nkern/pmap.c\nkern/pmap.h\nkern/kclock.h\nkern/kclock.c\n```\n> `memlayout.h` `pmap.c/memlayout.h` `pmap.h``PageInfo`page`kclock.c`  `kclock.h` PCCMOS RAM`pmap.c`\n\n## Part 1Physical Page Management\n> JOS(page)MMU`PageInfo`\n\n### Exercise 1.\n>  kern/pmap.c :\n> * boot_alloc()\n> * mem_init()\n> * page_init()\n> * page_alloc()\n> * page_free()\n> * check_page_free_list()check_page_alloc().\n\n\n> `pmap.c``mem_init` `i386_detect_memory` \n  jos\n>> 1. 0x00000~0xA0000basemem\n>> 2. 0xA0000~0x100000IO hole\n>> 3. 0x100000~0xextmem\n\n> `npages`,`npages_basemem`basemem`npages_extmem`extmem\n\n> ```c\nkern_pgdir = (pde_t *) boot_alloc(PGSIZE);\nmemset(kern_pgdir, 0, PGSIZE);\n```\n> `kern_pgdir``pde_t *kern_pgdir``PGSIZE`0\n\n>  `mem_init` `boot_alloc` (page directory) `boot_alloc` `nextfree`  `nextfree` `ROUNDUP``ROUNDUP` ``/inc/types.h` npages  `npages  PGSIZE` lab1KERNBASE`nextfree`  `KERNBASE + npages  PGSIZE` \n:\n> ```c\nresult = nextfree;\nnextfree = ROUNDUP(nextfree+n, PGSIZE);\nif((uint32_t)nextfree > KERNBASE + (npages * PGSIZE)) {\n    panic(\"Out of memory!\\n\");\n}\n```\n> `mem_init()``kern_pgdir``struct PageInfo` 0`PageInfo``boot_alloc()``memset()`\n> ```c\nsize_t PageInfo_size = sizeof(struct PageInfo);\npages = (struct PageInfo *)boot_alloc(npages * PageInfo_size);\nmemset(pages, 0, npages * PageInfo_size);\n```\n\n> `page_init()``page`\n`page_init()`\n>> 1. pages\n>> 2. pages_free_list\n\n> for`npages``PageInfo``PageInfo``pp_ref``pages_free_list`0`io hole`extmem\n> ```c\nsize_t i;\npage_free_list = NULL;\n\n//num_allocextmem\nint num_alloc = ((uint32_t)boot_alloc(0) - KERNBASE) / PGSIZE;\n//num_ioholeio hole\nint num_iohole = 96;\n\nfor(i=0; i<npages; i++)\n{\n    if(i==0)\n    {\n        pages[i].pp_ref = 1;\n    }    \n    else if(i >= npages_basemem && i < npages_basemem + num_iohole + num_alloc)\n    {\n        pages[i].pp_ref = 1;\n    }\n    else\n    {\n        pages[i].pp_ref = 0;\n        pages[i].pp_link = page_free_list;\n        page_free_list = &pages[i];\n    }\n}\n```\n\n> `page_alloc()``PageInfo`\n\n>> 1. free_page_listPageInfo\n>> 2. free_page_list\n>> 3. PageInfo\n\n> \n> ```c\nstruct PageInfo *\npage_alloc(int alloc_flags)\n{\n    struct PageInfo *result;\n    if (page_free_list == NULL)\n        return NULL;\n\n      result= page_free_list;\n      page_free_list = result->pp_link;\n      result->pp_link = NULL;\n\n    if (alloc_flags & ALLOC_ZERO)\n        memset(page2kva(result), 0, PGSIZE);\n\n      return result;\n}\n```\n> `page_free()``PageInfo``page_free_list`\n\n>> 1. PageInfo\n>> 2. page_free_list\n\n> \n> ```c\nvoid page_free(struct PageInfo *pp)\n{\n    // Fill this function in\n    // Hint: You may want to panic if pp->pp_ref is nonzero or\n    // pp->pp_link is not NULL.\n      assert(pp->pp_ref == 0);\n      assert(pp->pp_link == NULL);\n\n      pp->pp_link = page_free_list;\n      page_free_list = pp;\n}\n```\n\n## Part 2: Virtual Memory\n> x86(Virtual Address)(segment selector)(segment offset)(Linear Address)(Physical Addresses)\nCboot/boot.S00xffffffff\nlab1part 30xf01000000x00100000ROM BIOS4MBJOS256MB0xf0000000\n### Exercise 2\n> (page translation)(page-based protection)\n80386\n>> * \n>> * \n\n#### \nRAMC  `boot/boot.S`(GDT)0 0xffffffff\n```\n           Selector  +--------------+         +-----------+\n          ---------->|              |         |           |\n                     | Segmentation |         |  Paging   |\nSoftware             |              |-------->|           |---------->  RAM\n            Offset   |  Mechanism   |         | Mechanism |\n          ---------->|              |         |           |\n                     +--------------+         +-----------+\n            Virtual                   Linear                Physical\n```\n\n### Exercise 3`\n> QEMU `xp PDlabQEMU monitor\n\n```bash\nqemu-system-i386 -hda obj/kern/kernel.img -monitor stdio -gdb tcp::26000 -D qemu.log\n```\n\n> QEMU monitor `info pg`  `info mem` \nMMU C JOSJOS `uintptr_t` `physaddr_t` 32JOS`0xf0000000``KADDR(pa)`\n`0xf0000000``PADDR(va)`\n\n> \n `struct PageInfo`  `pp_ref` \n\n### Exercise 4\n> `kern/pmap.c``pgdir_walk()boot_map_region()page_lookup()page_remove()page_insert()``check_page()`\n\n>  `pgdir_walk()`\n![page](http://xinqiu.me/2016/12/09/MIT-6.828-2/2.png)\n> \n>> * /PPresent1\n>> * \n\n> :\n> ```c\npte_t *\npgdir_walk(pde_t *pgdir, const void *va, int create)\n{\n    // Fill this function in\n    pde_t *pt = pgdir + PDX(va);\n    pde_t *pt_addr_v;\n\n    if (*pt & PTE_P) {\n        pt_addr_v = (pte_t *)KADDR(PTE_ADDR(*pt));\n        return pt_addr_v + PTX(va);\n    } else {\n        struct PageInfo *newpt;\n        if (create == 1 && (newpt = page_alloc(ALLOC_ZERO)) != 0) {\n            memset(page2kva(newpt), 0, PGSIZE);\n            newpt->pp_ref ++;\n            *pt = PADDR(page2kva(newpt))|PTE_U|PTE_W|PTE_P;\n            pt_addr_v = (pte_t *)KADDR(PTE_ADDR(*pt));\n            return pt_addr_v + PTX(va);\n        }\n    }\n    return NULL;\n}\n```\n\n> `boot_map_region``[va, va+size)``[pa, pa+size)``pgdir_walk`\n```c\nstatic void\nboot_map_region(pde_t *pgdir, uintptr_t va, size_t size, physaddr_t pa, int perm)\n{\n    // Fill this function in\n    int offset;\n    pte_t *pt;\n    for (offset = 0; offset < size; offset += PGSIZE) {\n        pt = pgdir_walk(pgdir, (void *)va, 1);\n        *pt = pa|perm|PTE_P;\n        pa += PGSIZE;\n        va += PGSIZE;\n    }\n}\n```\n\n> `page_lookup`va`NULL``pte_store`0`page_remove`\n> ```c\nstruct PageInfo *\npage_lookup(pde_t *pgdir, void *va, pte_t **pte_store)\n{\n    // Fill this function in\n    pte_t *pte = pgdir_walk(pgdir, va, 0);\n    if (pte_store != 0) {\n        *pte_store = pte;\n    }\n    if (pte != NULL && (*pte & PTE_P)) {\n        return pa2page(PTE_ADDR(*pte));\n    }\n    return NULL;\n}\n```\n\n> `page_remove``page_lookup``page_decref``va`0\n> ```c\nvoid\npage_remove(pde_t *pgdir, void *va)\n{\n    // Fill this function in\n    pte_t *pte;\n    struct PageInfo *page = page_lookup(pgdir, va, &pte);\n    if (page) {\n        page_decref(page);\n        *pte = 0;\n        tlb_invalidate(pgdir, va);\n    }\n}\n```\n> `page_insert` `pp`  `va`, `permission`  `PTE_P&perm` : `va`  `va` , `page_remove`  `va` , `va`  `pp`   `va`  `pp` , `va`   `pp` \n> ```c\nint\npage_insert(pde_t *pgdir, struct PageInfo *pp, void *va, int perm)\n{\n    // Fill this function in\n    pte_t *pte = pgdir_walk(pgdir, va, 1);\n    if (!pte) {\n        return -E_NO_MEM;\n    }  \n    if (*pte & PTE_P) {\n        if (PTE_ADDR(*pte) == page2pa(pp)) {\n            tlb_invalidate(pgdir, va);\n            pp->pp_ref--;\n        }\n        else {\n            page_remove(pgdir, va);\n        }\n    }\n    *pte = page2pa(pp) | perm | PTE_P;\n    pp->pp_ref++;\n    pgdir[PDX(va)] |= perm;\n    return 0;\n}\n```\n\n## Part 3: \n\n#### \n> JOS32() `inc/memlayout.h` `ULIM`256MBlab1\n\n#### \n> x86(`Permissions bits`)bug(`PTE_W`)\n`ULIM``[UTOP,ULIM)``UTOP`\n\n#### \n> `UTOP``inc/memlayout.h`\n\n#### Exercise 5\n> `mem_init()`\n> `mem_init``kern_pgdir``pages``UPAGES`\n> ```c\nboot_map_region(kern_pgdir, UPAGES, PTSIZE, PADDR(pages),PTE_U);`\n```\n> `[KSTACKTOP-KSTKSIZE, KSTACKTOP)``bootstack``[KSTACKTOP-KSTKSIZE, KSTACKTOP)` `[KSTACKTOP-PTSIZE, KSTACKTOP-KSTKSIZE)`\n> ```c\nboot_map_region(kern_pgdir, KSTACKTOP-KSTKSIZE, KSTKSIZE, PADDR(bootstack), PTE_W);\n```\n> `[KERNBASE, 2^32)``[0, 2^32 - KERNBASE)`\n> ```c\nboot_map_region(kern_pgdir, KERNBASE, (0xffffffff-KERNBASE), 0, PTE_W);\n```\n\n## \n[memory management](https://pdos.csail.mit.edu/6.828/2016/labs/lab2/)\n","source":"_posts/lab2.md","raw":"title: lab2-memeory-management\ndate: 2017/04/18\ntags:\n- xv6\n- os\n\n---\n\n# Lab2 \n## \n> * :\n> 1.  .4096,\n> 2.  x86MMU lab2JOSMMU\n\n> - lab1\n> 1. part1:  physical page management\n> 2. part2:  virtual memory\n> 3. part3:  kernel address space\n\n<!-- more -->\n\n## \n> ```bash\n cd ~/6.828/lab\n git checkout -b lab2 origin/lab2\n git merge lab1\n```\n> Lab 2 :\n```bash\ninc/memlayout.h\nkern/pmap.c\nkern/pmap.h\nkern/kclock.h\nkern/kclock.c\n```\n> `memlayout.h` `pmap.c/memlayout.h` `pmap.h``PageInfo`page`kclock.c`  `kclock.h` PCCMOS RAM`pmap.c`\n\n## Part 1Physical Page Management\n> JOS(page)MMU`PageInfo`\n\n### Exercise 1.\n>  kern/pmap.c :\n> * boot_alloc()\n> * mem_init()\n> * page_init()\n> * page_alloc()\n> * page_free()\n> * check_page_free_list()check_page_alloc().\n\n\n> `pmap.c``mem_init` `i386_detect_memory` \n  jos\n>> 1. 0x00000~0xA0000basemem\n>> 2. 0xA0000~0x100000IO hole\n>> 3. 0x100000~0xextmem\n\n> `npages`,`npages_basemem`basemem`npages_extmem`extmem\n\n> ```c\nkern_pgdir = (pde_t *) boot_alloc(PGSIZE);\nmemset(kern_pgdir, 0, PGSIZE);\n```\n> `kern_pgdir``pde_t *kern_pgdir``PGSIZE`0\n\n>  `mem_init` `boot_alloc` (page directory) `boot_alloc` `nextfree`  `nextfree` `ROUNDUP``ROUNDUP` ``/inc/types.h` npages  `npages  PGSIZE` lab1KERNBASE`nextfree`  `KERNBASE + npages  PGSIZE` \n:\n> ```c\nresult = nextfree;\nnextfree = ROUNDUP(nextfree+n, PGSIZE);\nif((uint32_t)nextfree > KERNBASE + (npages * PGSIZE)) {\n    panic(\"Out of memory!\\n\");\n}\n```\n> `mem_init()``kern_pgdir``struct PageInfo` 0`PageInfo``boot_alloc()``memset()`\n> ```c\nsize_t PageInfo_size = sizeof(struct PageInfo);\npages = (struct PageInfo *)boot_alloc(npages * PageInfo_size);\nmemset(pages, 0, npages * PageInfo_size);\n```\n\n> `page_init()``page`\n`page_init()`\n>> 1. pages\n>> 2. pages_free_list\n\n> for`npages``PageInfo``PageInfo``pp_ref``pages_free_list`0`io hole`extmem\n> ```c\nsize_t i;\npage_free_list = NULL;\n\n//num_allocextmem\nint num_alloc = ((uint32_t)boot_alloc(0) - KERNBASE) / PGSIZE;\n//num_ioholeio hole\nint num_iohole = 96;\n\nfor(i=0; i<npages; i++)\n{\n    if(i==0)\n    {\n        pages[i].pp_ref = 1;\n    }    \n    else if(i >= npages_basemem && i < npages_basemem + num_iohole + num_alloc)\n    {\n        pages[i].pp_ref = 1;\n    }\n    else\n    {\n        pages[i].pp_ref = 0;\n        pages[i].pp_link = page_free_list;\n        page_free_list = &pages[i];\n    }\n}\n```\n\n> `page_alloc()``PageInfo`\n\n>> 1. free_page_listPageInfo\n>> 2. free_page_list\n>> 3. PageInfo\n\n> \n> ```c\nstruct PageInfo *\npage_alloc(int alloc_flags)\n{\n    struct PageInfo *result;\n    if (page_free_list == NULL)\n        return NULL;\n\n      result= page_free_list;\n      page_free_list = result->pp_link;\n      result->pp_link = NULL;\n\n    if (alloc_flags & ALLOC_ZERO)\n        memset(page2kva(result), 0, PGSIZE);\n\n      return result;\n}\n```\n> `page_free()``PageInfo``page_free_list`\n\n>> 1. PageInfo\n>> 2. page_free_list\n\n> \n> ```c\nvoid page_free(struct PageInfo *pp)\n{\n    // Fill this function in\n    // Hint: You may want to panic if pp->pp_ref is nonzero or\n    // pp->pp_link is not NULL.\n      assert(pp->pp_ref == 0);\n      assert(pp->pp_link == NULL);\n\n      pp->pp_link = page_free_list;\n      page_free_list = pp;\n}\n```\n\n## Part 2: Virtual Memory\n> x86(Virtual Address)(segment selector)(segment offset)(Linear Address)(Physical Addresses)\nCboot/boot.S00xffffffff\nlab1part 30xf01000000x00100000ROM BIOS4MBJOS256MB0xf0000000\n### Exercise 2\n> (page translation)(page-based protection)\n80386\n>> * \n>> * \n\n#### \nRAMC  `boot/boot.S`(GDT)0 0xffffffff\n```\n           Selector  +--------------+         +-----------+\n          ---------->|              |         |           |\n                     | Segmentation |         |  Paging   |\nSoftware             |              |-------->|           |---------->  RAM\n            Offset   |  Mechanism   |         | Mechanism |\n          ---------->|              |         |           |\n                     +--------------+         +-----------+\n            Virtual                   Linear                Physical\n```\n\n### Exercise 3`\n> QEMU `xp PDlabQEMU monitor\n\n```bash\nqemu-system-i386 -hda obj/kern/kernel.img -monitor stdio -gdb tcp::26000 -D qemu.log\n```\n\n> QEMU monitor `info pg`  `info mem` \nMMU C JOSJOS `uintptr_t` `physaddr_t` 32JOS`0xf0000000``KADDR(pa)`\n`0xf0000000``PADDR(va)`\n\n> \n `struct PageInfo`  `pp_ref` \n\n### Exercise 4\n> `kern/pmap.c``pgdir_walk()boot_map_region()page_lookup()page_remove()page_insert()``check_page()`\n\n>  `pgdir_walk()`\n![page](http://xinqiu.me/2016/12/09/MIT-6.828-2/2.png)\n> \n>> * /PPresent1\n>> * \n\n> :\n> ```c\npte_t *\npgdir_walk(pde_t *pgdir, const void *va, int create)\n{\n    // Fill this function in\n    pde_t *pt = pgdir + PDX(va);\n    pde_t *pt_addr_v;\n\n    if (*pt & PTE_P) {\n        pt_addr_v = (pte_t *)KADDR(PTE_ADDR(*pt));\n        return pt_addr_v + PTX(va);\n    } else {\n        struct PageInfo *newpt;\n        if (create == 1 && (newpt = page_alloc(ALLOC_ZERO)) != 0) {\n            memset(page2kva(newpt), 0, PGSIZE);\n            newpt->pp_ref ++;\n            *pt = PADDR(page2kva(newpt))|PTE_U|PTE_W|PTE_P;\n            pt_addr_v = (pte_t *)KADDR(PTE_ADDR(*pt));\n            return pt_addr_v + PTX(va);\n        }\n    }\n    return NULL;\n}\n```\n\n> `boot_map_region``[va, va+size)``[pa, pa+size)``pgdir_walk`\n```c\nstatic void\nboot_map_region(pde_t *pgdir, uintptr_t va, size_t size, physaddr_t pa, int perm)\n{\n    // Fill this function in\n    int offset;\n    pte_t *pt;\n    for (offset = 0; offset < size; offset += PGSIZE) {\n        pt = pgdir_walk(pgdir, (void *)va, 1);\n        *pt = pa|perm|PTE_P;\n        pa += PGSIZE;\n        va += PGSIZE;\n    }\n}\n```\n\n> `page_lookup`va`NULL``pte_store`0`page_remove`\n> ```c\nstruct PageInfo *\npage_lookup(pde_t *pgdir, void *va, pte_t **pte_store)\n{\n    // Fill this function in\n    pte_t *pte = pgdir_walk(pgdir, va, 0);\n    if (pte_store != 0) {\n        *pte_store = pte;\n    }\n    if (pte != NULL && (*pte & PTE_P)) {\n        return pa2page(PTE_ADDR(*pte));\n    }\n    return NULL;\n}\n```\n\n> `page_remove``page_lookup``page_decref``va`0\n> ```c\nvoid\npage_remove(pde_t *pgdir, void *va)\n{\n    // Fill this function in\n    pte_t *pte;\n    struct PageInfo *page = page_lookup(pgdir, va, &pte);\n    if (page) {\n        page_decref(page);\n        *pte = 0;\n        tlb_invalidate(pgdir, va);\n    }\n}\n```\n> `page_insert` `pp`  `va`, `permission`  `PTE_P&perm` : `va`  `va` , `page_remove`  `va` , `va`  `pp`   `va`  `pp` , `va`   `pp` \n> ```c\nint\npage_insert(pde_t *pgdir, struct PageInfo *pp, void *va, int perm)\n{\n    // Fill this function in\n    pte_t *pte = pgdir_walk(pgdir, va, 1);\n    if (!pte) {\n        return -E_NO_MEM;\n    }  \n    if (*pte & PTE_P) {\n        if (PTE_ADDR(*pte) == page2pa(pp)) {\n            tlb_invalidate(pgdir, va);\n            pp->pp_ref--;\n        }\n        else {\n            page_remove(pgdir, va);\n        }\n    }\n    *pte = page2pa(pp) | perm | PTE_P;\n    pp->pp_ref++;\n    pgdir[PDX(va)] |= perm;\n    return 0;\n}\n```\n\n## Part 3: \n\n#### \n> JOS32() `inc/memlayout.h` `ULIM`256MBlab1\n\n#### \n> x86(`Permissions bits`)bug(`PTE_W`)\n`ULIM``[UTOP,ULIM)``UTOP`\n\n#### \n> `UTOP``inc/memlayout.h`\n\n#### Exercise 5\n> `mem_init()`\n> `mem_init``kern_pgdir``pages``UPAGES`\n> ```c\nboot_map_region(kern_pgdir, UPAGES, PTSIZE, PADDR(pages),PTE_U);`\n```\n> `[KSTACKTOP-KSTKSIZE, KSTACKTOP)``bootstack``[KSTACKTOP-KSTKSIZE, KSTACKTOP)` `[KSTACKTOP-PTSIZE, KSTACKTOP-KSTKSIZE)`\n> ```c\nboot_map_region(kern_pgdir, KSTACKTOP-KSTKSIZE, KSTKSIZE, PADDR(bootstack), PTE_W);\n```\n> `[KERNBASE, 2^32)``[0, 2^32 - KERNBASE)`\n> ```c\nboot_map_region(kern_pgdir, KERNBASE, (0xffffffff-KERNBASE), 0, PTE_W);\n```\n\n## \n[memory management](https://pdos.csail.mit.edu/6.828/2016/labs/lab2/)\n","slug":"lab2","published":1,"updated":"2017-08-26T03:38:21.622Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3h80011s7amhin0rjbp","content":"<h1 id=\"Lab2-\"><a href=\"#Lab2-\" class=\"headerlink\" title=\"Lab2 \"></a>Lab2 </h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><blockquote>\n<ul>\n<li>:</li>\n</ul>\n<ol>\n<li>.4096,</li>\n<li> x86MMU lab2JOSMMU</li>\n</ol>\n</blockquote>\n<blockquote>\n<ul>\n<li>lab1</li>\n</ul>\n<ol>\n<li>part1:  physical page management</li>\n<li>part2:  virtual memory</li>\n<li>part3:  kernel address space</li>\n</ol>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ~/6.828/lab</span><br><span class=\"line\">git checkout -b lab2 origin/lab2</span><br><span class=\"line\">git merge lab1</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<p>Lab 2 :<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">inc/memlayout.h</span><br><span class=\"line\">kern/pmap.c</span><br><span class=\"line\">kern/pmap.h</span><br><span class=\"line\">kern/kclock.h</span><br><span class=\"line\">kern/kclock.c</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>memlayout.h</code> <code>pmap.c/memlayout.h</code> <code>pmap.h</code><code>PageInfo</code>page<code>kclock.c</code>  <code>kclock.h</code> PCCMOS RAM<code>pmap.c</code></p>\n</blockquote>\n<h2 id=\"Part-1Physical-Page-Management\"><a href=\"#Part-1Physical-Page-Management\" class=\"headerlink\" title=\"Part 1Physical Page Management\"></a>Part 1Physical Page Management</h2><blockquote>\n<p>JOS(page)MMU<code>PageInfo</code></p>\n</blockquote>\n<h3 id=\"Exercise-1\"><a href=\"#Exercise-1\" class=\"headerlink\" title=\"Exercise 1.\"></a>Exercise 1.</h3><blockquote>\n<p> kern/pmap.c :</p>\n<ul>\n<li>boot_alloc()</li>\n<li>mem_init()</li>\n<li>page_init()</li>\n<li>page_alloc()</li>\n<li>page_free()</li>\n<li>check_page_free_list()check_page_alloc().</li>\n</ul>\n</blockquote>\n<blockquote>\n<p><code>pmap.c</code><code>mem_init</code> <code>i386_detect_memory</code> <br>  jos</p>\n<blockquote>\n<ol>\n<li>0x00000~0xA0000basemem</li>\n<li>0xA0000~0x100000IO hole</li>\n<li>0x100000~0xextmem</li>\n</ol>\n</blockquote>\n</blockquote>\n<blockquote>\n<p><code>npages</code>,<code>npages_basemem</code>basemem<code>npages_extmem</code>extmem<br><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kern_pgdir = (<span class=\"keyword\">pde_t</span> *) boot_alloc(PGSIZE);</span><br><span class=\"line\"><span class=\"built_in\">memset</span>(kern_pgdir, <span class=\"number\">0</span>, PGSIZE);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>kern_pgdir</code><code>pde_t *kern_pgdir</code><code>PGSIZE</code>0</p>\n</blockquote>\n<blockquote>\n<p> <code>mem_init</code> <code>boot_alloc</code> (page directory) <code>boot_alloc</code> <code>nextfree</code>  <code>nextfree</code> <code>ROUNDUP</code><code>ROUNDUP</code> <code></code>/inc/types.h<code>npages </code>npages  PGSIZE<code>lab1KERNBASE</code>nextfree<code></code>KERNBASE + npages  PGSIZE` <br>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">result = nextfree;</span><br><span class=\"line\">nextfree = ROUNDUP(nextfree+n, PGSIZE);</span><br><span class=\"line\"><span class=\"keyword\">if</span>((<span class=\"keyword\">uint32_t</span>)nextfree &gt; KERNBASE + (npages * PGSIZE)) &#123;</span><br><span class=\"line\">    panic(<span class=\"string\">\"Out of memory!\\n\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>mem_init()</code><code>kern_pgdir</code><code>struct PageInfo</code> 0<code>PageInfo</code><code>boot_alloc()</code><code>memset()</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">size_t</span> PageInfo_size = <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> PageInfo);</span><br><span class=\"line\">pages = (<span class=\"keyword\">struct</span> PageInfo *)boot_alloc(npages * PageInfo_size);</span><br><span class=\"line\"><span class=\"built_in\">memset</span>(pages, <span class=\"number\">0</span>, npages * PageInfo_size);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_init()</code><code>page</code><br><code>page_init()</code></p>\n<blockquote>\n<ol>\n<li>pages</li>\n<li>pages_free_list</li>\n</ol>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>for<code>npages</code><code>PageInfo</code><code>PageInfo</code><code>pp_ref</code><code>pages_free_list</code>0<code>io hole</code>extmem<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">size_t</span> i;</span><br><span class=\"line\">page_free_list = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//num_allocextmem</span></span><br><span class=\"line\"><span class=\"keyword\">int</span> num_alloc = ((<span class=\"keyword\">uint32_t</span>)boot_alloc(<span class=\"number\">0</span>) - KERNBASE) / PGSIZE;</span><br><span class=\"line\"><span class=\"comment\">//num_ioholeio hole</span></span><br><span class=\"line\"><span class=\"keyword\">int</span> num_iohole = <span class=\"number\">96</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;npages; i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(i==<span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        pages[i].pp_ref = <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;    </span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(i &gt;= npages_basemem &amp;&amp; i &lt; npages_basemem + num_iohole + num_alloc)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        pages[i].pp_ref = <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        pages[i].pp_ref = <span class=\"number\">0</span>;</span><br><span class=\"line\">        pages[i].pp_link = page_free_list;</span><br><span class=\"line\">        page_free_list = &amp;pages[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_alloc()</code><code>PageInfo</code><br></p>\n<blockquote>\n<ol>\n<li>free_page_listPageInfo</li>\n<li>free_page_list</li>\n<li>PageInfo</li>\n</ol>\n</blockquote>\n</blockquote>\n<blockquote>\n<p><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> PageInfo *</span><br><span class=\"line\">page_alloc(<span class=\"keyword\">int</span> alloc_flags)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> PageInfo *result;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (page_free_list == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      result= page_free_list;</span><br><span class=\"line\">      page_free_list = result-&gt;pp_link;</span><br><span class=\"line\">      result-&gt;pp_link = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (alloc_flags &amp; ALLOC_ZERO)</span><br><span class=\"line\">        <span class=\"built_in\">memset</span>(page2kva(result), <span class=\"number\">0</span>, PGSIZE);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_free()</code><code>PageInfo</code><code>page_free_list</code><br></p>\n<blockquote>\n<ol>\n<li>PageInfo</li>\n<li>page_free_list</li>\n</ol>\n</blockquote>\n</blockquote>\n<blockquote>\n<p><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">page_free</span><span class=\"params\">(<span class=\"keyword\">struct</span> PageInfo *pp)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"comment\">// Hint: You may want to panic if pp-&gt;pp_ref is nonzero or</span></span><br><span class=\"line\">    <span class=\"comment\">// pp-&gt;pp_link is not NULL.</span></span><br><span class=\"line\">      assert(pp-&gt;pp_ref == <span class=\"number\">0</span>);</span><br><span class=\"line\">      assert(pp-&gt;pp_link == <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">      pp-&gt;pp_link = page_free_list;</span><br><span class=\"line\">      page_free_list = pp;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"Part-2-Virtual-Memory\"><a href=\"#Part-2-Virtual-Memory\" class=\"headerlink\" title=\"Part 2: Virtual Memory\"></a>Part 2: Virtual Memory</h2><blockquote>\n<p>x86(Virtual Address)(segment selector)(segment offset)(Linear Address)(Physical Addresses)<br>Cboot/boot.S00xffffffff<br>lab1part 30xf01000000x00100000ROM BIOS4MBJOS256MB0xf0000000</p>\n</blockquote>\n<h3 id=\"Exercise-2\"><a href=\"#Exercise-2\" class=\"headerlink\" title=\"Exercise 2\"></a>Exercise 2</h3><blockquote>\n<p>(page translation)(page-based protection)<br>80386</p>\n<blockquote>\n<ul>\n<li></li>\n<li></li>\n</ul>\n</blockquote>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>RAMC  <code>boot/boot.S</code>(GDT)0 0xffffffff<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">           Selector  +--------------+         +-----------+</span><br><span class=\"line\">          ----------&gt;|              |         |           |</span><br><span class=\"line\">                     | Segmentation |         |  Paging   |</span><br><span class=\"line\">Software             |              |--------&gt;|           |----------&gt;  RAM</span><br><span class=\"line\">            Offset   |  Mechanism   |         | Mechanism |</span><br><span class=\"line\">          ----------&gt;|              |         |           |</span><br><span class=\"line\">                     +--------------+         +-----------+</span><br><span class=\"line\">            Virtual                   Linear                Physical</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Exercise-3\"><a href=\"#Exercise-3\" class=\"headerlink\" title=\"Exercise 3`\"></a>Exercise 3`</h3><blockquote>\n<p>QEMU `xp PDlabQEMU monitor<br><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">qemu-system-i386 -hda obj/kern/kernel.img -monitor stdio -gdb tcp::26000 -D qemu.log</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>QEMU monitor <code>info pg</code>  <code>info mem</code> <br>MMU C JOSJOS <code>uintptr_t</code> <code>physaddr_t</code> 32JOS<code>0xf0000000</code><code>KADDR(pa)</code><br><code>0xf0000000</code><code>PADDR(va)</code></p>\n</blockquote>\n<blockquote>\n<p><br> <code>struct PageInfo</code>  <code>pp_ref</code> </p>\n</blockquote>\n<h3 id=\"Exercise-4\"><a href=\"#Exercise-4\" class=\"headerlink\" title=\"Exercise 4\"></a>Exercise 4</h3><blockquote>\n<p><code>kern/pmap.c</code><code>pgdir_walk()boot_map_region()page_lookup()page_remove()page_insert()</code><code>check_page()</code></p>\n</blockquote>\n<blockquote>\n<p> <code>pgdir_walk()</code><br><img src=\"http://xinqiu.me/2016/12/09/MIT-6.828-2/2.png\" alt=\"page\"><br></p>\n<blockquote>\n<ul>\n<li>/PPresent1</li>\n<li></li>\n</ul>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">pte_t</span> *</span><br><span class=\"line\">pgdir_walk(<span class=\"keyword\">pde_t</span> *pgdir, <span class=\"keyword\">const</span> <span class=\"keyword\">void</span> *va, <span class=\"keyword\">int</span> create)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"keyword\">pde_t</span> *pt = pgdir + PDX(va);</span><br><span class=\"line\">    <span class=\"keyword\">pde_t</span> *pt_addr_v;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (*pt &amp; PTE_P) &#123;</span><br><span class=\"line\">        pt_addr_v = (<span class=\"keyword\">pte_t</span> *)KADDR(PTE_ADDR(*pt));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> pt_addr_v + PTX(va);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> PageInfo *newpt;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (create == <span class=\"number\">1</span> &amp;&amp; (newpt = page_alloc(ALLOC_ZERO)) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">memset</span>(page2kva(newpt), <span class=\"number\">0</span>, PGSIZE);</span><br><span class=\"line\">            newpt-&gt;pp_ref ++;</span><br><span class=\"line\">            *pt = PADDR(page2kva(newpt))|PTE_U|PTE_W|PTE_P;</span><br><span class=\"line\">            pt_addr_v = (<span class=\"keyword\">pte_t</span> *)KADDR(PTE_ADDR(*pt));</span><br><span class=\"line\">            <span class=\"keyword\">return</span> pt_addr_v + PTX(va);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>boot_map_region</code><code>[va, va+size)</code><code>[pa, pa+size)</code><code>pgdir_walk</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">boot_map_region(<span class=\"keyword\">pde_t</span> *pgdir, <span class=\"keyword\">uintptr_t</span> va, <span class=\"keyword\">size_t</span> size, <span class=\"keyword\">physaddr_t</span> pa, <span class=\"keyword\">int</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> offset;</span><br><span class=\"line\">    <span class=\"keyword\">pte_t</span> *pt;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (offset = <span class=\"number\">0</span>; offset &lt; size; offset += PGSIZE) &#123;</span><br><span class=\"line\">        pt = pgdir_walk(pgdir, (<span class=\"keyword\">void</span> *)va, <span class=\"number\">1</span>);</span><br><span class=\"line\">        *pt = pa|perm|PTE_P;</span><br><span class=\"line\">        pa += PGSIZE;</span><br><span class=\"line\">        va += PGSIZE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_lookup</code>va<code>NULL</code><code>pte_store</code>0<code>page_remove</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> PageInfo *</span><br><span class=\"line\">page_lookup(<span class=\"keyword\">pde_t</span> *pgdir, <span class=\"keyword\">void</span> *va, <span class=\"keyword\">pte_t</span> **pte_store)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"keyword\">pte_t</span> *pte = pgdir_walk(pgdir, va, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pte_store != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        *pte_store = pte;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pte != <span class=\"literal\">NULL</span> &amp;&amp; (*pte &amp; PTE_P)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> pa2page(PTE_ADDR(*pte));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_remove</code><code>page_lookup</code><code>page_decref</code><code>va</code>0<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">page_remove(<span class=\"keyword\">pde_t</span> *pgdir, <span class=\"keyword\">void</span> *va)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"keyword\">pte_t</span> *pte;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> PageInfo *page = page_lookup(pgdir, va, &amp;pte);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (page) &#123;</span><br><span class=\"line\">        page_decref(page);</span><br><span class=\"line\">        *pte = <span class=\"number\">0</span>;</span><br><span class=\"line\">        tlb_invalidate(pgdir, va);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_insert</code> <code>pp</code>  <code>va</code>, <code>permission</code>  <code>PTE_P&amp;perm</code> : <code>va</code>  <code>va</code> , <code>page_remove</code>  <code>va</code> , <code>va</code>  <code>pp</code>   <code>va</code>  <code>pp</code> , <code>va</code>   <code>pp</code> <br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">page_insert(<span class=\"keyword\">pde_t</span> *pgdir, <span class=\"keyword\">struct</span> PageInfo *pp, <span class=\"keyword\">void</span> *va, <span class=\"keyword\">int</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"keyword\">pte_t</span> *pte = pgdir_walk(pgdir, va, <span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!pte) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> -E_NO_MEM;</span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (*pte &amp; PTE_P) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (PTE_ADDR(*pte) == page2pa(pp)) &#123;</span><br><span class=\"line\">            tlb_invalidate(pgdir, va);</span><br><span class=\"line\">            pp-&gt;pp_ref--;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            page_remove(pgdir, va);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    *pte = page2pa(pp) | perm | PTE_P;</span><br><span class=\"line\">    pp-&gt;pp_ref++;</span><br><span class=\"line\">    pgdir[PDX(va)] |= perm;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"Part-3-\"><a href=\"#Part-3-\" class=\"headerlink\" title=\"Part 3: \"></a>Part 3: </h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>JOS32() <code>inc/memlayout.h</code> <code>ULIM</code>256MBlab1</p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>x86(<code>Permissions bits</code>)bug(<code>PTE_W</code>)<br><code>ULIM</code><code>[UTOP,ULIM)</code><code>UTOP</code></p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p><code>UTOP</code><code>inc/memlayout.h</code></p>\n</blockquote>\n<h4 id=\"Exercise-5\"><a href=\"#Exercise-5\" class=\"headerlink\" title=\"Exercise 5\"></a>Exercise 5</h4><blockquote>\n<p><code>mem_init()</code><br><code>mem_init</code><code>kern_pgdir</code><code>pages</code><code>UPAGES</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot_map_region(kern_pgdir, UPAGES, PTSIZE, PADDR(pages),PTE_U);`</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>[KSTACKTOP-KSTKSIZE, KSTACKTOP)</code><code>bootstack</code><code>[KSTACKTOP-KSTKSIZE, KSTACKTOP)</code> <code>[KSTACKTOP-PTSIZE, KSTACKTOP-KSTKSIZE)</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot_map_region(kern_pgdir, KSTACKTOP-KSTKSIZE, KSTKSIZE, PADDR(bootstack), PTE_W);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>[KERNBASE, 2^32)</code><code>[0, 2^32 - KERNBASE)</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot_map_region(kern_pgdir, KERNBASE, (<span class=\"number\">0xffffffff</span>-KERNBASE), <span class=\"number\">0</span>, PTE_W);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://pdos.csail.mit.edu/6.828/2016/labs/lab2/\" target=\"_blank\" rel=\"noopener\">memory management</a></p>\n","site":{"data":{}},"excerpt":"<h1 id=\"Lab2-\"><a href=\"#Lab2-\" class=\"headerlink\" title=\"Lab2 \"></a>Lab2 </h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><blockquote>\n<ul>\n<li>:</li>\n</ul>\n<ol>\n<li>.4096,</li>\n<li> x86MMU lab2JOSMMU</li>\n</ol>\n</blockquote>\n<blockquote>\n<ul>\n<li>lab1</li>\n</ul>\n<ol>\n<li>part1:  physical page management</li>\n<li>part2:  virtual memory</li>\n<li>part3:  kernel address space</li>\n</ol>\n</blockquote>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ~/6.828/lab</span><br><span class=\"line\">git checkout -b lab2 origin/lab2</span><br><span class=\"line\">git merge lab1</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<p>Lab 2 :<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">inc/memlayout.h</span><br><span class=\"line\">kern/pmap.c</span><br><span class=\"line\">kern/pmap.h</span><br><span class=\"line\">kern/kclock.h</span><br><span class=\"line\">kern/kclock.c</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>memlayout.h</code> <code>pmap.c/memlayout.h</code> <code>pmap.h</code><code>PageInfo</code>page<code>kclock.c</code>  <code>kclock.h</code> PCCMOS RAM<code>pmap.c</code></p>\n</blockquote>\n<h2 id=\"Part-1Physical-Page-Management\"><a href=\"#Part-1Physical-Page-Management\" class=\"headerlink\" title=\"Part 1Physical Page Management\"></a>Part 1Physical Page Management</h2><blockquote>\n<p>JOS(page)MMU<code>PageInfo</code></p>\n</blockquote>\n<h3 id=\"Exercise-1\"><a href=\"#Exercise-1\" class=\"headerlink\" title=\"Exercise 1.\"></a>Exercise 1.</h3><blockquote>\n<p> kern/pmap.c :</p>\n<ul>\n<li>boot_alloc()</li>\n<li>mem_init()</li>\n<li>page_init()</li>\n<li>page_alloc()</li>\n<li>page_free()</li>\n<li>check_page_free_list()check_page_alloc().</li>\n</ul>\n</blockquote>\n<blockquote>\n<p><code>pmap.c</code><code>mem_init</code> <code>i386_detect_memory</code> <br>  jos</p>\n<blockquote>\n<ol>\n<li>0x00000~0xA0000basemem</li>\n<li>0xA0000~0x100000IO hole</li>\n<li>0x100000~0xextmem</li>\n</ol>\n</blockquote>\n</blockquote>\n<blockquote>\n<p><code>npages</code>,<code>npages_basemem</code>basemem<code>npages_extmem</code>extmem<br><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kern_pgdir = (<span class=\"keyword\">pde_t</span> *) boot_alloc(PGSIZE);</span><br><span class=\"line\"><span class=\"built_in\">memset</span>(kern_pgdir, <span class=\"number\">0</span>, PGSIZE);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>kern_pgdir</code><code>pde_t *kern_pgdir</code><code>PGSIZE</code>0</p>\n</blockquote>\n<blockquote>\n<p> <code>mem_init</code> <code>boot_alloc</code> (page directory) <code>boot_alloc</code> <code>nextfree</code>  <code>nextfree</code> <code>ROUNDUP</code><code>ROUNDUP</code> <code></code>/inc/types.h<code>npages </code>npages  PGSIZE<code>lab1KERNBASE</code>nextfree<code></code>KERNBASE + npages  PGSIZE` <br>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">result = nextfree;</span><br><span class=\"line\">nextfree = ROUNDUP(nextfree+n, PGSIZE);</span><br><span class=\"line\"><span class=\"keyword\">if</span>((<span class=\"keyword\">uint32_t</span>)nextfree &gt; KERNBASE + (npages * PGSIZE)) &#123;</span><br><span class=\"line\">    panic(<span class=\"string\">\"Out of memory!\\n\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>mem_init()</code><code>kern_pgdir</code><code>struct PageInfo</code> 0<code>PageInfo</code><code>boot_alloc()</code><code>memset()</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">size_t</span> PageInfo_size = <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> PageInfo);</span><br><span class=\"line\">pages = (<span class=\"keyword\">struct</span> PageInfo *)boot_alloc(npages * PageInfo_size);</span><br><span class=\"line\"><span class=\"built_in\">memset</span>(pages, <span class=\"number\">0</span>, npages * PageInfo_size);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_init()</code><code>page</code><br><code>page_init()</code></p>\n<blockquote>\n<ol>\n<li>pages</li>\n<li>pages_free_list</li>\n</ol>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>for<code>npages</code><code>PageInfo</code><code>PageInfo</code><code>pp_ref</code><code>pages_free_list</code>0<code>io hole</code>extmem<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">size_t</span> i;</span><br><span class=\"line\">page_free_list = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//num_allocextmem</span></span><br><span class=\"line\"><span class=\"keyword\">int</span> num_alloc = ((<span class=\"keyword\">uint32_t</span>)boot_alloc(<span class=\"number\">0</span>) - KERNBASE) / PGSIZE;</span><br><span class=\"line\"><span class=\"comment\">//num_ioholeio hole</span></span><br><span class=\"line\"><span class=\"keyword\">int</span> num_iohole = <span class=\"number\">96</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;npages; i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(i==<span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        pages[i].pp_ref = <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;    </span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(i &gt;= npages_basemem &amp;&amp; i &lt; npages_basemem + num_iohole + num_alloc)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        pages[i].pp_ref = <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        pages[i].pp_ref = <span class=\"number\">0</span>;</span><br><span class=\"line\">        pages[i].pp_link = page_free_list;</span><br><span class=\"line\">        page_free_list = &amp;pages[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_alloc()</code><code>PageInfo</code><br></p>\n<blockquote>\n<ol>\n<li>free_page_listPageInfo</li>\n<li>free_page_list</li>\n<li>PageInfo</li>\n</ol>\n</blockquote>\n</blockquote>\n<blockquote>\n<p><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> PageInfo *</span><br><span class=\"line\">page_alloc(<span class=\"keyword\">int</span> alloc_flags)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> PageInfo *result;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (page_free_list == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      result= page_free_list;</span><br><span class=\"line\">      page_free_list = result-&gt;pp_link;</span><br><span class=\"line\">      result-&gt;pp_link = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (alloc_flags &amp; ALLOC_ZERO)</span><br><span class=\"line\">        <span class=\"built_in\">memset</span>(page2kva(result), <span class=\"number\">0</span>, PGSIZE);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_free()</code><code>PageInfo</code><code>page_free_list</code><br></p>\n<blockquote>\n<ol>\n<li>PageInfo</li>\n<li>page_free_list</li>\n</ol>\n</blockquote>\n</blockquote>\n<blockquote>\n<p><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">page_free</span><span class=\"params\">(<span class=\"keyword\">struct</span> PageInfo *pp)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"comment\">// Hint: You may want to panic if pp-&gt;pp_ref is nonzero or</span></span><br><span class=\"line\">    <span class=\"comment\">// pp-&gt;pp_link is not NULL.</span></span><br><span class=\"line\">      assert(pp-&gt;pp_ref == <span class=\"number\">0</span>);</span><br><span class=\"line\">      assert(pp-&gt;pp_link == <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">      pp-&gt;pp_link = page_free_list;</span><br><span class=\"line\">      page_free_list = pp;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"Part-2-Virtual-Memory\"><a href=\"#Part-2-Virtual-Memory\" class=\"headerlink\" title=\"Part 2: Virtual Memory\"></a>Part 2: Virtual Memory</h2><blockquote>\n<p>x86(Virtual Address)(segment selector)(segment offset)(Linear Address)(Physical Addresses)<br>Cboot/boot.S00xffffffff<br>lab1part 30xf01000000x00100000ROM BIOS4MBJOS256MB0xf0000000</p>\n</blockquote>\n<h3 id=\"Exercise-2\"><a href=\"#Exercise-2\" class=\"headerlink\" title=\"Exercise 2\"></a>Exercise 2</h3><blockquote>\n<p>(page translation)(page-based protection)<br>80386</p>\n<blockquote>\n<ul>\n<li></li>\n<li></li>\n</ul>\n</blockquote>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>RAMC  <code>boot/boot.S</code>(GDT)0 0xffffffff<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">           Selector  +--------------+         +-----------+</span><br><span class=\"line\">          ----------&gt;|              |         |           |</span><br><span class=\"line\">                     | Segmentation |         |  Paging   |</span><br><span class=\"line\">Software             |              |--------&gt;|           |----------&gt;  RAM</span><br><span class=\"line\">            Offset   |  Mechanism   |         | Mechanism |</span><br><span class=\"line\">          ----------&gt;|              |         |           |</span><br><span class=\"line\">                     +--------------+         +-----------+</span><br><span class=\"line\">            Virtual                   Linear                Physical</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Exercise-3\"><a href=\"#Exercise-3\" class=\"headerlink\" title=\"Exercise 3`\"></a>Exercise 3`</h3><blockquote>\n<p>QEMU `xp PDlabQEMU monitor<br><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">qemu-system-i386 -hda obj/kern/kernel.img -monitor stdio -gdb tcp::26000 -D qemu.log</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>QEMU monitor <code>info pg</code>  <code>info mem</code> <br>MMU C JOSJOS <code>uintptr_t</code> <code>physaddr_t</code> 32JOS<code>0xf0000000</code><code>KADDR(pa)</code><br><code>0xf0000000</code><code>PADDR(va)</code></p>\n</blockquote>\n<blockquote>\n<p><br> <code>struct PageInfo</code>  <code>pp_ref</code> </p>\n</blockquote>\n<h3 id=\"Exercise-4\"><a href=\"#Exercise-4\" class=\"headerlink\" title=\"Exercise 4\"></a>Exercise 4</h3><blockquote>\n<p><code>kern/pmap.c</code><code>pgdir_walk()boot_map_region()page_lookup()page_remove()page_insert()</code><code>check_page()</code></p>\n</blockquote>\n<blockquote>\n<p> <code>pgdir_walk()</code><br><img src=\"http://xinqiu.me/2016/12/09/MIT-6.828-2/2.png\" alt=\"page\"><br></p>\n<blockquote>\n<ul>\n<li>/PPresent1</li>\n<li></li>\n</ul>\n</blockquote>\n</blockquote>\n<blockquote>\n<p>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">pte_t</span> *</span><br><span class=\"line\">pgdir_walk(<span class=\"keyword\">pde_t</span> *pgdir, <span class=\"keyword\">const</span> <span class=\"keyword\">void</span> *va, <span class=\"keyword\">int</span> create)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"keyword\">pde_t</span> *pt = pgdir + PDX(va);</span><br><span class=\"line\">    <span class=\"keyword\">pde_t</span> *pt_addr_v;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (*pt &amp; PTE_P) &#123;</span><br><span class=\"line\">        pt_addr_v = (<span class=\"keyword\">pte_t</span> *)KADDR(PTE_ADDR(*pt));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> pt_addr_v + PTX(va);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> PageInfo *newpt;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (create == <span class=\"number\">1</span> &amp;&amp; (newpt = page_alloc(ALLOC_ZERO)) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">memset</span>(page2kva(newpt), <span class=\"number\">0</span>, PGSIZE);</span><br><span class=\"line\">            newpt-&gt;pp_ref ++;</span><br><span class=\"line\">            *pt = PADDR(page2kva(newpt))|PTE_U|PTE_W|PTE_P;</span><br><span class=\"line\">            pt_addr_v = (<span class=\"keyword\">pte_t</span> *)KADDR(PTE_ADDR(*pt));</span><br><span class=\"line\">            <span class=\"keyword\">return</span> pt_addr_v + PTX(va);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>boot_map_region</code><code>[va, va+size)</code><code>[pa, pa+size)</code><code>pgdir_walk</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">boot_map_region(<span class=\"keyword\">pde_t</span> *pgdir, <span class=\"keyword\">uintptr_t</span> va, <span class=\"keyword\">size_t</span> size, <span class=\"keyword\">physaddr_t</span> pa, <span class=\"keyword\">int</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> offset;</span><br><span class=\"line\">    <span class=\"keyword\">pte_t</span> *pt;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (offset = <span class=\"number\">0</span>; offset &lt; size; offset += PGSIZE) &#123;</span><br><span class=\"line\">        pt = pgdir_walk(pgdir, (<span class=\"keyword\">void</span> *)va, <span class=\"number\">1</span>);</span><br><span class=\"line\">        *pt = pa|perm|PTE_P;</span><br><span class=\"line\">        pa += PGSIZE;</span><br><span class=\"line\">        va += PGSIZE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_lookup</code>va<code>NULL</code><code>pte_store</code>0<code>page_remove</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> PageInfo *</span><br><span class=\"line\">page_lookup(<span class=\"keyword\">pde_t</span> *pgdir, <span class=\"keyword\">void</span> *va, <span class=\"keyword\">pte_t</span> **pte_store)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"keyword\">pte_t</span> *pte = pgdir_walk(pgdir, va, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pte_store != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        *pte_store = pte;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pte != <span class=\"literal\">NULL</span> &amp;&amp; (*pte &amp; PTE_P)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> pa2page(PTE_ADDR(*pte));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_remove</code><code>page_lookup</code><code>page_decref</code><code>va</code>0<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">page_remove(<span class=\"keyword\">pde_t</span> *pgdir, <span class=\"keyword\">void</span> *va)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"keyword\">pte_t</span> *pte;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> PageInfo *page = page_lookup(pgdir, va, &amp;pte);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (page) &#123;</span><br><span class=\"line\">        page_decref(page);</span><br><span class=\"line\">        *pte = <span class=\"number\">0</span>;</span><br><span class=\"line\">        tlb_invalidate(pgdir, va);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>page_insert</code> <code>pp</code>  <code>va</code>, <code>permission</code>  <code>PTE_P&amp;perm</code> : <code>va</code>  <code>va</code> , <code>page_remove</code>  <code>va</code> , <code>va</code>  <code>pp</code>   <code>va</code>  <code>pp</code> , <code>va</code>   <code>pp</code> <br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">page_insert(<span class=\"keyword\">pde_t</span> *pgdir, <span class=\"keyword\">struct</span> PageInfo *pp, <span class=\"keyword\">void</span> *va, <span class=\"keyword\">int</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Fill this function in</span></span><br><span class=\"line\">    <span class=\"keyword\">pte_t</span> *pte = pgdir_walk(pgdir, va, <span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!pte) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> -E_NO_MEM;</span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (*pte &amp; PTE_P) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (PTE_ADDR(*pte) == page2pa(pp)) &#123;</span><br><span class=\"line\">            tlb_invalidate(pgdir, va);</span><br><span class=\"line\">            pp-&gt;pp_ref--;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            page_remove(pgdir, va);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    *pte = page2pa(pp) | perm | PTE_P;</span><br><span class=\"line\">    pp-&gt;pp_ref++;</span><br><span class=\"line\">    pgdir[PDX(va)] |= perm;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"Part-3-\"><a href=\"#Part-3-\" class=\"headerlink\" title=\"Part 3: \"></a>Part 3: </h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>JOS32() <code>inc/memlayout.h</code> <code>ULIM</code>256MBlab1</p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>x86(<code>Permissions bits</code>)bug(<code>PTE_W</code>)<br><code>ULIM</code><code>[UTOP,ULIM)</code><code>UTOP</code></p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p><code>UTOP</code><code>inc/memlayout.h</code></p>\n</blockquote>\n<h4 id=\"Exercise-5\"><a href=\"#Exercise-5\" class=\"headerlink\" title=\"Exercise 5\"></a>Exercise 5</h4><blockquote>\n<p><code>mem_init()</code><br><code>mem_init</code><code>kern_pgdir</code><code>pages</code><code>UPAGES</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot_map_region(kern_pgdir, UPAGES, PTSIZE, PADDR(pages),PTE_U);`</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>[KSTACKTOP-KSTKSIZE, KSTACKTOP)</code><code>bootstack</code><code>[KSTACKTOP-KSTKSIZE, KSTACKTOP)</code> <code>[KSTACKTOP-PTSIZE, KSTACKTOP-KSTKSIZE)</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot_map_region(kern_pgdir, KSTACKTOP-KSTKSIZE, KSTKSIZE, PADDR(bootstack), PTE_W);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>[KERNBASE, 2^32)</code><code>[0, 2^32 - KERNBASE)</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot_map_region(kern_pgdir, KERNBASE, (<span class=\"number\">0xffffffff</span>-KERNBASE), <span class=\"number\">0</span>, PTE_W);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://pdos.csail.mit.edu/6.828/2016/labs/lab2/\" target=\"_blank\" rel=\"noopener\">memory management</a></p>"},{"title":"lab3-user-environment-part2","date":"2017-04-28T16:00:00.000Z","_content":"\n# Lab3  Part2\n\n## Part2 , \npart1,JOSkernel,part2,/.\n\n### \n14`T_PGFLT`,,kernel.,`CR2`.`trap.c`,`page_fault_handler()`.\n\n<!-- more -->\n\n#### 5\n\n> `trap_dispatch`, `page_fault_handler()`.,JOS`faultread,faultreadkernel,faultwrite,faultwritekernel`\n\n:\n>  `trapentry.S``TRAPHANDLER`,,`inc/trap.h``Trapframe`,`Trapframe``tf_trapno`. `trap_dispatch``Trapframe``tf` `tf_trapno`., `page_fault_handler`,\n``` c\nstatic void\ntrap_dispatch(struct Trapframe *tf)\n{\n    int32_t ret_code;\n    // Handle processor exceptions.\n    switch(tf->tf_trapno) {\n        case (T_PGFLT):\n            page_fault_handler(tf);\n            break;\n         default:\n            // Unexpected trap: The user process or the kernel has a bug.\n            print_trapframe(tf);\n            if (tf->tf_cs == GD_KT)\n                panic(\"unhandled trap in kernel\");\n            else {\n                env_destroy(curenv);\n                return;\n            }\n    }\n}\n```\n\n### \n,3`T_BRKPT`..`INT3`:`INT3`,.JOS,JOSkernel`kernel monitor`.\n\n### 6\n\n> `trap_dispatch()`,kernel. JOS `breakpoint`.\n\n\n> , (`T_BRKPT`),kernel monitor `kern/monitor.c``monitor` ,\n``` c\nstatic void\ntrap_dispatch(struct Trapframe *tf)\n{\n    int32_t ret_code;\n    // Handle processor exceptions.\n    switch(tf->tf_trapno) {\n        case (T_PGFLT):\n            page_fault_handler(tf);\n            break;\n        case (T_BRKPT):\n            monitor(tf);        \n            break;\n         default:\n            // Unexpected trap: The user process or the kernel has a bug.\n            print_trapframe(tf);\n            if (tf->tf_cs == GD_KT)\n                panic(\"unhandled trap in kernel\");\n            else {\n                env_destroy(curenv);\n                return;\n            }\n    }\n}\n```\n\n#### \n> 3. (`break point exception`),`IDT`,,,,(`general protection exception`).,\n:\n`IDT`,`DPL`3,,0,.`DPL``Descriptor Privileged Level`,,`CPL,RPL``DPL`,,.,`CPL`3,,`int 3`,,`CPL``int 3``DPL`,,`IDT``DPL`3,,,,.\n\n### \nkernel.,kernel.CPU,kernel,.,,.\nJOS,`int`,CPU.,`int $0x30`.,`int 0x30`.\n.,kernel.`%eax`,`%edx, %ecx, %ebx, %edi,  %esi`.kernel`%eax`.`lib/syscall.c`.\n\n#### 7\n:\n> `T_SYSCALL`.`kern/trapentry.S``kern/trap.c``trap_init()`,`trap_dispatch()`,`syscall()```kern/syscall.c``.`kern/syscall.c``syscall()`, `-E_INVAL`.`lib/syscall.c`,`inc/syscall.h`.\n`make run-hello``user/hello`, hello, world,.\n\n:\n> :kernel,,`sys_cputs`,,`lib/syscall.c``sys_cputs`,`sys_cputs`, `sys_cgetc`. `syscall()`,..\nkernel,.,`lib/syscall.c``syscall`.\n,,`sys_cputs`,,`int $0x30`,,`0x3`,`T_SYSCALL`,,`kern/trapentry.S`,`TRAPHANDLER_NOEC`,.\n``` c\n//kern/trapentry.S\n....\nTRAPHANDLER_NOEC(t_fperr, T_FPERR)\nTRAPHANDLER(t_align, T_ALIGN)\nTRAPHANDLER_NOEC(t_mchk, T_MCHK)\nTRAPHANDLER_NOEC(t_simderr, T_SIMDERR)\n....\nTRAPHANDLER_NOEC(t_syscall, T_SYSCALL)\n....\n```\n\n> `trap.c``t_syscall()``.`trap_init()`\n``` c\n//kern/trap.c\n....\nvoid t_fperr();\nvoid t_align();\nvoid t_mchk();\nvoid t_simderr();\n\nvoid t_syscall();\n.....\nvoid\ntrap_init(void)\n{\n    extern struct Segdesc gdt[];\n\n        .....\n    SETGATE(idt[T_ALIGN], 0, GD_KT, t_align, 0);\n    SETGATE(idt[T_MCHK], 0, GD_KT, t_mchk, 0);\n    SETGATE(idt[T_SIMDERR], 0, GD_KT, t_simderr, 0);\n\n    SETGATE(idt[T_SYSCALL], 0, GD_KT, t_syscall, 3);\n    // Per-CPU setup\n    trap_init_percpu();\n}    \n```\n\n> ,,, `_alltraps`,`trap()`,`trap()`,`trap_dispatch()`.`kern/syscall.c``syscall`,`lib/syscall.c1``syscall`,`kern/syscall.c``syscall`, `lib/syscall.c``syscall`,\n\n>`kern/syscall.c``syscall`\n``` c\nsyscall(uint32_t syscallno, uint32_t a1, uint32_t a2, uint32_t a3, uint32_t a4, uint32_t a5)\n```\n>  `lib/syscall.c``syscall`\n``` c\nsyscall(int num, int check, uint32_t a1, uint32_t a2, uint32_t a3, uint32_t a4, uint32_t a5)\n```\n> ,`kern/syscall.c``syscall`,`lib/syscall`., `kern/syscall.c`,`kern/syscall.c` `lib/syscall.c`. `sys_cputs` ,,.`sys_cputs`\n> `kern/syscall.c``sys_cputs`\n``` c\nstatic void\nsys_cputs(const char *s, size_t len)\n{\n    // Check that the user has permission to read memory [s, s+len).\n    // Destroy the environment if not:.\n\n    user_mem_assert(curenv, s, len, 0);\n    // Print the string supplied by the user.\n    cprintf(\"%.*s\", len, s);\n}\n```\n> `lib/syscall.c``sys_cputs`:\n``` c\nvoid\nsys_cputs(const char *s, size_t len)\n{\n    syscall(SYS_cputs, 0, (uint32_t)s, len, 0, 0, 0);\n}\n```\n> `lib/syscall.c`,`syscall`, `kern/syscall.c``sys_cputs`,`cprintf`,.,,kernel,`cprintf``lib/syscall.c``sys_cputs`,kernel,`sys_cputs`. `kern/syscall.c``sys_cputs``cprintf` `lib/syscall.c``syscall`.\n`kern/syscall.c``syscall()``sys_cputs`, `kern/syscall.c` ..\n\n> `syscall``syscallno`., `lib/syscall.c` `syscall`,`%eax`,`trap_dispatch``kern/syscall.c``syscall`.\n``` c\nstatic void\ntrap_dispatch(struct Trapframe *tf)\n{\n    int32_t ret_code;\n    // Handle processor exceptions.\n    switch(tf->tf_trapno) {\n        case (T_PGFLT):\n            page_fault_handler(tf);\n            break;\n        case (T_BRKPT):\n            monitor(tf);        \n            break;\n        case (T_SYSCALL):\n    //        print_trapframe(tf);\n            ret_code = syscall(\n                    tf->tf_regs.reg_eax,\n                    tf->tf_regs.reg_edx,\n                    tf->tf_regs.reg_ecx,\n                    tf->tf_regs.reg_ebx,\n                    tf->tf_regs.reg_edi,\n                    tf->tf_regs.reg_esi);\n            tf->tf_regs.reg_eax = ret_code;\n            break;\n         default:\n            // Unexpected trap: The user process or the kernel has a bug.\n            print_trapframe(tf);\n            if (tf->tf_cs == GD_KT)\n                panic(\"unhandled trap in kernel\");\n            else {\n                env_destroy(curenv);\n                return;\n            }\n    }\n}\n```\n> `kern/syscall.c`  `syscall`():\n``` c\nint32_t\nsyscall(uint32_t syscallno, uint32_t a1, uint32_t a2, uint32_t a3, uint32_t a4, uint32_t a5)\n{\n    // Call the function corresponding to the 'syscallno' parameter.\n    // Return any appropriate return value.\n\n    // panic(\"syscall not implemented\");\n\n    switch (syscallno) {\n        case (SYS_cputs):\n            sys_cputs((const char *)a1, a2);\n            return 0;\n        case (SYS_cgetc):\n            return sys_cgetc();\n        case (SYS_getenvid):\n            return sys_getenvid();\n        case (SYS_env_destroy):\n            return sys_env_destroy(a1);\n        default:\n            return -E_INVAL;\n    }\n}\n```\n\n### \n`lib/entry.S`.,,`lib/libmain.c``libmain()`.`libmain()`,`thisenv` , `Env`.\n`libmain()``umain()`.`umain()``user/hello.c`.,`hello.c` hello, world,`page fault`(),`thisenv->env_id`..`thisenv`,.\n\n### 8\n\n> ,kernel,`user/hello` hello, world,  i am environment 00001000.`user/hello``sys_env_destroy()lib/libmain.c lib/exit.c`.kernel,,kernel.\n\n\n> `env_id`, `Env`.`env_id``sys_getenvid()`.`Env`\n`lib/env.h`,`env_id``int32_t`,\n> * 310\n> * 10~3021,\n> * 0~9`Env`,`envs`.\n`env_id` 0~9 ,`Env`.\n``` c\nvoid\nlibmain(int argc, char **argv)\n{\n    // set thisenv to point at our Env structure in envs[].\n    thisenv = &envs[ENVX(sys_getenvid())];\n\n    // save the name of the program so that panic() can use it\n    if (argc > 0)\n        binaryname = argv[0];\n\n    // call user main routine\n    umain(argc, argv);\n\n    // exit gracefully\n    exit();\n}\n```\n\n### \n,.\n.,.,,,,,.,,.,.\n> .,,,,,.\n\n...,.\n1. page fault).,bug,.,.\n2. .,,.,.\n\n.,,.\n\n#### 9\n\n> `kern/trap.c`,,`trap.c``panic`.`user_mem_assert``kern/pmap.c`,`user_mem_check``kern/syscall.c`.\n,`user/buggyhello`,,`panic`,\n```\n[00001000] user_mem_check assertion failure for va 00000001\n[00001000] free env 00001000\nDestroyed the only environment - nothing more to do!\n```\n\n\n> `CS`2,`CPL`,,0,3.\n,`panic`,`page_fault_handler`\n``` c\nvoid\npage_fault_handler(struct Trapframe *tf)\n{\n    uint32_t fault_va;\n\n    // Read processor's CR2 register to find the faulting address\n    fault_va = rcr2();\n\n    // Handle kernel-mode s.\n    if(tf->tf_cs && 0x01 == 0) {\n        panic(\"page_fault in kernel mode, fault address %d\\n\", fault_va);\n    }\n\n    // We've already handled kernel-mode exceptions, so if we get here,\n    // the page fault happened in user mode.\n\n    // Destroy the environment that caused the fault.\n    cprintf(\"[%08x] user fault va %08x ip %08x\\n\",\n        curenv->env_id, fault_va, tf->tf_eip);\n    print_trapframe(tf);\n    env_destroy(curenv);\n}\n```\n> ,`kern/pmap.c``user_mem_assert()`, `user_mem_check` , `user_mem_assert()`, `user_mem_check()`. `user_mem_check``[va, va+len]``perm| PTE_P`.\n,,,`perm|PTE_P`,,`perm|PTE_P`.\n``` c\nint\nuser_mem_check(struct Env *env, const void *va, size_t len, int perm)\n{\n    char * end = NULL;\n    char * start = NULL;\n    start = ROUNDDOWN((char *)va, PGSIZE);\n    end = ROUNDUP((char *)(va + len), PGSIZE);\n    pte_t * cur = NULL;\n\n    for(; start < end; start += PGSIZE) {\n        cur = pgdir_walk(env->env_pgdir, (void *)start, 0);\n        if((int)start > ULIM || cur == NULL || ((uint32_t)(*cur) & perm) != perm) {\n              if(start == ROUNDDOWN((char *)va, PGSIZE)) {\n                    user_mem_check_addr = (uintptr_t)va;\n              }\n              else {\n                      user_mem_check_addr = (uintptr_t)start;\n              }\n              return -E_FAULT;\n        }\n    }\n\n    return 0;\n}\n```\n\n> `kern/syscall.c`,`sys_cputs` ,`[s, s+len]`,`user_mem_assert`.\n``` c\nstatic void\nsys_cputs(const char *s, size_t len)\n{\n    // Check that the user has permission to read memory [s, s+len).\n    // Destroy the environment if not:.\n\n    user_mem_assert(curenv, s, len, 0);\n    // Print the string supplied by the user.\n    cprintf(\"%.*s\", len, s);\n}\n```\n> `kern/kdebug``debuginfo_eip`,`user_mem_check``PTE_U`.\n``` c\n...\n    const struct UserStabData *usd = (const struct UserStabData *) USTABDATA;\n    // Make sure this memory is valid.\n    // Return -1 if it is not.  Hint: Call user_mem_check.\n    // LAB 3: Your code here.\n    if (user_mem_check(curenv, usd, sizeof(*usd),PTE_U) <0 )\n            return -1;\n    stabs = usd->stabs;\n    stab_end = usd->stab_end;\n    stabstr = usd->stabstr;\n    stabstr_end = usd->stabstr_end;\n    // Make sure the STABS and string table memory is valid.\n    // LAB 3: Your code here.a\n    if (user_mem_check(curenv, stabs, stab_end-stabs,PTE_U) <0 || `user_mem_check`(curenv, stabstr, stabstr_end-stabstr,PTE_U) <0)\n            return -1;\n```\n\n## \n[lab3:user environment](https://pdos.csail.mit.edu/6.828/2016/labs/lab3/)\n","source":"_posts/lab3_part2.md","raw":"title: lab3-user-environment-part2\ndate: 2017/04/29\ntags:\n- xv6\n- os\n\n---\n\n# Lab3  Part2\n\n## Part2 , \npart1,JOSkernel,part2,/.\n\n### \n14`T_PGFLT`,,kernel.,`CR2`.`trap.c`,`page_fault_handler()`.\n\n<!-- more -->\n\n#### 5\n\n> `trap_dispatch`, `page_fault_handler()`.,JOS`faultread,faultreadkernel,faultwrite,faultwritekernel`\n\n:\n>  `trapentry.S``TRAPHANDLER`,,`inc/trap.h``Trapframe`,`Trapframe``tf_trapno`. `trap_dispatch``Trapframe``tf` `tf_trapno`., `page_fault_handler`,\n``` c\nstatic void\ntrap_dispatch(struct Trapframe *tf)\n{\n    int32_t ret_code;\n    // Handle processor exceptions.\n    switch(tf->tf_trapno) {\n        case (T_PGFLT):\n            page_fault_handler(tf);\n            break;\n         default:\n            // Unexpected trap: The user process or the kernel has a bug.\n            print_trapframe(tf);\n            if (tf->tf_cs == GD_KT)\n                panic(\"unhandled trap in kernel\");\n            else {\n                env_destroy(curenv);\n                return;\n            }\n    }\n}\n```\n\n### \n,3`T_BRKPT`..`INT3`:`INT3`,.JOS,JOSkernel`kernel monitor`.\n\n### 6\n\n> `trap_dispatch()`,kernel. JOS `breakpoint`.\n\n\n> , (`T_BRKPT`),kernel monitor `kern/monitor.c``monitor` ,\n``` c\nstatic void\ntrap_dispatch(struct Trapframe *tf)\n{\n    int32_t ret_code;\n    // Handle processor exceptions.\n    switch(tf->tf_trapno) {\n        case (T_PGFLT):\n            page_fault_handler(tf);\n            break;\n        case (T_BRKPT):\n            monitor(tf);        \n            break;\n         default:\n            // Unexpected trap: The user process or the kernel has a bug.\n            print_trapframe(tf);\n            if (tf->tf_cs == GD_KT)\n                panic(\"unhandled trap in kernel\");\n            else {\n                env_destroy(curenv);\n                return;\n            }\n    }\n}\n```\n\n#### \n> 3. (`break point exception`),`IDT`,,,,(`general protection exception`).,\n:\n`IDT`,`DPL`3,,0,.`DPL``Descriptor Privileged Level`,,`CPL,RPL``DPL`,,.,`CPL`3,,`int 3`,,`CPL``int 3``DPL`,,`IDT``DPL`3,,,,.\n\n### \nkernel.,kernel.CPU,kernel,.,,.\nJOS,`int`,CPU.,`int $0x30`.,`int 0x30`.\n.,kernel.`%eax`,`%edx, %ecx, %ebx, %edi,  %esi`.kernel`%eax`.`lib/syscall.c`.\n\n#### 7\n:\n> `T_SYSCALL`.`kern/trapentry.S``kern/trap.c``trap_init()`,`trap_dispatch()`,`syscall()```kern/syscall.c``.`kern/syscall.c``syscall()`, `-E_INVAL`.`lib/syscall.c`,`inc/syscall.h`.\n`make run-hello``user/hello`, hello, world,.\n\n:\n> :kernel,,`sys_cputs`,,`lib/syscall.c``sys_cputs`,`sys_cputs`, `sys_cgetc`. `syscall()`,..\nkernel,.,`lib/syscall.c``syscall`.\n,,`sys_cputs`,,`int $0x30`,,`0x3`,`T_SYSCALL`,,`kern/trapentry.S`,`TRAPHANDLER_NOEC`,.\n``` c\n//kern/trapentry.S\n....\nTRAPHANDLER_NOEC(t_fperr, T_FPERR)\nTRAPHANDLER(t_align, T_ALIGN)\nTRAPHANDLER_NOEC(t_mchk, T_MCHK)\nTRAPHANDLER_NOEC(t_simderr, T_SIMDERR)\n....\nTRAPHANDLER_NOEC(t_syscall, T_SYSCALL)\n....\n```\n\n> `trap.c``t_syscall()``.`trap_init()`\n``` c\n//kern/trap.c\n....\nvoid t_fperr();\nvoid t_align();\nvoid t_mchk();\nvoid t_simderr();\n\nvoid t_syscall();\n.....\nvoid\ntrap_init(void)\n{\n    extern struct Segdesc gdt[];\n\n        .....\n    SETGATE(idt[T_ALIGN], 0, GD_KT, t_align, 0);\n    SETGATE(idt[T_MCHK], 0, GD_KT, t_mchk, 0);\n    SETGATE(idt[T_SIMDERR], 0, GD_KT, t_simderr, 0);\n\n    SETGATE(idt[T_SYSCALL], 0, GD_KT, t_syscall, 3);\n    // Per-CPU setup\n    trap_init_percpu();\n}    \n```\n\n> ,,, `_alltraps`,`trap()`,`trap()`,`trap_dispatch()`.`kern/syscall.c``syscall`,`lib/syscall.c1``syscall`,`kern/syscall.c``syscall`, `lib/syscall.c``syscall`,\n\n>`kern/syscall.c``syscall`\n``` c\nsyscall(uint32_t syscallno, uint32_t a1, uint32_t a2, uint32_t a3, uint32_t a4, uint32_t a5)\n```\n>  `lib/syscall.c``syscall`\n``` c\nsyscall(int num, int check, uint32_t a1, uint32_t a2, uint32_t a3, uint32_t a4, uint32_t a5)\n```\n> ,`kern/syscall.c``syscall`,`lib/syscall`., `kern/syscall.c`,`kern/syscall.c` `lib/syscall.c`. `sys_cputs` ,,.`sys_cputs`\n> `kern/syscall.c``sys_cputs`\n``` c\nstatic void\nsys_cputs(const char *s, size_t len)\n{\n    // Check that the user has permission to read memory [s, s+len).\n    // Destroy the environment if not:.\n\n    user_mem_assert(curenv, s, len, 0);\n    // Print the string supplied by the user.\n    cprintf(\"%.*s\", len, s);\n}\n```\n> `lib/syscall.c``sys_cputs`:\n``` c\nvoid\nsys_cputs(const char *s, size_t len)\n{\n    syscall(SYS_cputs, 0, (uint32_t)s, len, 0, 0, 0);\n}\n```\n> `lib/syscall.c`,`syscall`, `kern/syscall.c``sys_cputs`,`cprintf`,.,,kernel,`cprintf``lib/syscall.c``sys_cputs`,kernel,`sys_cputs`. `kern/syscall.c``sys_cputs``cprintf` `lib/syscall.c``syscall`.\n`kern/syscall.c``syscall()``sys_cputs`, `kern/syscall.c` ..\n\n> `syscall``syscallno`., `lib/syscall.c` `syscall`,`%eax`,`trap_dispatch``kern/syscall.c``syscall`.\n``` c\nstatic void\ntrap_dispatch(struct Trapframe *tf)\n{\n    int32_t ret_code;\n    // Handle processor exceptions.\n    switch(tf->tf_trapno) {\n        case (T_PGFLT):\n            page_fault_handler(tf);\n            break;\n        case (T_BRKPT):\n            monitor(tf);        \n            break;\n        case (T_SYSCALL):\n    //        print_trapframe(tf);\n            ret_code = syscall(\n                    tf->tf_regs.reg_eax,\n                    tf->tf_regs.reg_edx,\n                    tf->tf_regs.reg_ecx,\n                    tf->tf_regs.reg_ebx,\n                    tf->tf_regs.reg_edi,\n                    tf->tf_regs.reg_esi);\n            tf->tf_regs.reg_eax = ret_code;\n            break;\n         default:\n            // Unexpected trap: The user process or the kernel has a bug.\n            print_trapframe(tf);\n            if (tf->tf_cs == GD_KT)\n                panic(\"unhandled trap in kernel\");\n            else {\n                env_destroy(curenv);\n                return;\n            }\n    }\n}\n```\n> `kern/syscall.c`  `syscall`():\n``` c\nint32_t\nsyscall(uint32_t syscallno, uint32_t a1, uint32_t a2, uint32_t a3, uint32_t a4, uint32_t a5)\n{\n    // Call the function corresponding to the 'syscallno' parameter.\n    // Return any appropriate return value.\n\n    // panic(\"syscall not implemented\");\n\n    switch (syscallno) {\n        case (SYS_cputs):\n            sys_cputs((const char *)a1, a2);\n            return 0;\n        case (SYS_cgetc):\n            return sys_cgetc();\n        case (SYS_getenvid):\n            return sys_getenvid();\n        case (SYS_env_destroy):\n            return sys_env_destroy(a1);\n        default:\n            return -E_INVAL;\n    }\n}\n```\n\n### \n`lib/entry.S`.,,`lib/libmain.c``libmain()`.`libmain()`,`thisenv` , `Env`.\n`libmain()``umain()`.`umain()``user/hello.c`.,`hello.c` hello, world,`page fault`(),`thisenv->env_id`..`thisenv`,.\n\n### 8\n\n> ,kernel,`user/hello` hello, world,  i am environment 00001000.`user/hello``sys_env_destroy()lib/libmain.c lib/exit.c`.kernel,,kernel.\n\n\n> `env_id`, `Env`.`env_id``sys_getenvid()`.`Env`\n`lib/env.h`,`env_id``int32_t`,\n> * 310\n> * 10~3021,\n> * 0~9`Env`,`envs`.\n`env_id` 0~9 ,`Env`.\n``` c\nvoid\nlibmain(int argc, char **argv)\n{\n    // set thisenv to point at our Env structure in envs[].\n    thisenv = &envs[ENVX(sys_getenvid())];\n\n    // save the name of the program so that panic() can use it\n    if (argc > 0)\n        binaryname = argv[0];\n\n    // call user main routine\n    umain(argc, argv);\n\n    // exit gracefully\n    exit();\n}\n```\n\n### \n,.\n.,.,,,,,.,,.,.\n> .,,,,,.\n\n...,.\n1. page fault).,bug,.,.\n2. .,,.,.\n\n.,,.\n\n#### 9\n\n> `kern/trap.c`,,`trap.c``panic`.`user_mem_assert``kern/pmap.c`,`user_mem_check``kern/syscall.c`.\n,`user/buggyhello`,,`panic`,\n```\n[00001000] user_mem_check assertion failure for va 00000001\n[00001000] free env 00001000\nDestroyed the only environment - nothing more to do!\n```\n\n\n> `CS`2,`CPL`,,0,3.\n,`panic`,`page_fault_handler`\n``` c\nvoid\npage_fault_handler(struct Trapframe *tf)\n{\n    uint32_t fault_va;\n\n    // Read processor's CR2 register to find the faulting address\n    fault_va = rcr2();\n\n    // Handle kernel-mode s.\n    if(tf->tf_cs && 0x01 == 0) {\n        panic(\"page_fault in kernel mode, fault address %d\\n\", fault_va);\n    }\n\n    // We've already handled kernel-mode exceptions, so if we get here,\n    // the page fault happened in user mode.\n\n    // Destroy the environment that caused the fault.\n    cprintf(\"[%08x] user fault va %08x ip %08x\\n\",\n        curenv->env_id, fault_va, tf->tf_eip);\n    print_trapframe(tf);\n    env_destroy(curenv);\n}\n```\n> ,`kern/pmap.c``user_mem_assert()`, `user_mem_check` , `user_mem_assert()`, `user_mem_check()`. `user_mem_check``[va, va+len]``perm| PTE_P`.\n,,,`perm|PTE_P`,,`perm|PTE_P`.\n``` c\nint\nuser_mem_check(struct Env *env, const void *va, size_t len, int perm)\n{\n    char * end = NULL;\n    char * start = NULL;\n    start = ROUNDDOWN((char *)va, PGSIZE);\n    end = ROUNDUP((char *)(va + len), PGSIZE);\n    pte_t * cur = NULL;\n\n    for(; start < end; start += PGSIZE) {\n        cur = pgdir_walk(env->env_pgdir, (void *)start, 0);\n        if((int)start > ULIM || cur == NULL || ((uint32_t)(*cur) & perm) != perm) {\n              if(start == ROUNDDOWN((char *)va, PGSIZE)) {\n                    user_mem_check_addr = (uintptr_t)va;\n              }\n              else {\n                      user_mem_check_addr = (uintptr_t)start;\n              }\n              return -E_FAULT;\n        }\n    }\n\n    return 0;\n}\n```\n\n> `kern/syscall.c`,`sys_cputs` ,`[s, s+len]`,`user_mem_assert`.\n``` c\nstatic void\nsys_cputs(const char *s, size_t len)\n{\n    // Check that the user has permission to read memory [s, s+len).\n    // Destroy the environment if not:.\n\n    user_mem_assert(curenv, s, len, 0);\n    // Print the string supplied by the user.\n    cprintf(\"%.*s\", len, s);\n}\n```\n> `kern/kdebug``debuginfo_eip`,`user_mem_check``PTE_U`.\n``` c\n...\n    const struct UserStabData *usd = (const struct UserStabData *) USTABDATA;\n    // Make sure this memory is valid.\n    // Return -1 if it is not.  Hint: Call user_mem_check.\n    // LAB 3: Your code here.\n    if (user_mem_check(curenv, usd, sizeof(*usd),PTE_U) <0 )\n            return -1;\n    stabs = usd->stabs;\n    stab_end = usd->stab_end;\n    stabstr = usd->stabstr;\n    stabstr_end = usd->stabstr_end;\n    // Make sure the STABS and string table memory is valid.\n    // LAB 3: Your code here.a\n    if (user_mem_check(curenv, stabs, stab_end-stabs,PTE_U) <0 || `user_mem_check`(curenv, stabstr, stabstr_end-stabstr,PTE_U) <0)\n            return -1;\n```\n\n## \n[lab3:user environment](https://pdos.csail.mit.edu/6.828/2016/labs/lab3/)\n","slug":"lab3_part2","published":1,"updated":"2017-08-26T03:38:21.614Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3h90013s7am0anh7dfu","content":"<h1 id=\"Lab3--Part2\"><a href=\"#Lab3--Part2\" class=\"headerlink\" title=\"Lab3  Part2\"></a>Lab3  Part2</h1><h2 id=\"Part2--\"><a href=\"#Part2--\" class=\"headerlink\" title=\"Part2 , \"></a>Part2 , </h2><p>part1,JOSkernel,part2,/.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>14<code>T_PGFLT</code>,,kernel.,<code>CR2</code>.<code>trap.c</code>,<code>page_fault_handler()</code>.</p>\n<a id=\"more\"></a>\n<h4 id=\"5\"><a href=\"#5\" class=\"headerlink\" title=\"5\"></a>5</h4><p></p>\n<blockquote>\n<p><code>trap_dispatch</code>, <code>page_fault_handler()</code>.,JOS<code>faultread,faultreadkernel,faultwrite,faultwritekernel</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p> <code>trapentry.S</code><code>TRAPHANDLER</code>,,<code>inc/trap.h</code><code>Trapframe</code>,<code>Trapframe</code><code>tf_trapno</code>. <code>trap_dispatch</code><code>Trapframe</code><code>tf</code> <code>tf_trapno</code>., <code>page_fault_handler</code>,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">trap_dispatch(<span class=\"keyword\">struct</span> Trapframe *tf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int32_t</span> ret_code;</span><br><span class=\"line\">    <span class=\"comment\">// Handle processor exceptions.</span></span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(tf-&gt;tf_trapno) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_PGFLT):</span><br><span class=\"line\">            page_fault_handler(tf);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">         <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"comment\">// Unexpected trap: The user process or the kernel has a bug.</span></span><br><span class=\"line\">            print_trapframe(tf);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (tf-&gt;tf_cs == GD_KT)</span><br><span class=\"line\">                panic(<span class=\"string\">\"unhandled trap in kernel\"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                env_destroy(curenv);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>,3<code>T_BRKPT</code>..<code>INT3</code>:<code>INT3</code>,.JOS,JOSkernel<code>kernel monitor</code>.</p>\n<h3 id=\"6\"><a href=\"#6\" class=\"headerlink\" title=\"6\"></a>6</h3><p></p>\n<blockquote>\n<p><code>trap_dispatch()</code>,kernel. JOS <code>breakpoint</code>.</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p>, (<code>T_BRKPT</code>),kernel monitor <code>kern/monitor.c</code><code>monitor</code> ,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">trap_dispatch(<span class=\"keyword\">struct</span> Trapframe *tf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int32_t</span> ret_code;</span><br><span class=\"line\">    <span class=\"comment\">// Handle processor exceptions.</span></span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(tf-&gt;tf_trapno) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_PGFLT):</span><br><span class=\"line\">            page_fault_handler(tf);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_BRKPT):</span><br><span class=\"line\">            monitor(tf);        </span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">         <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"comment\">// Unexpected trap: The user process or the kernel has a bug.</span></span><br><span class=\"line\">            print_trapframe(tf);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (tf-&gt;tf_cs == GD_KT)</span><br><span class=\"line\">                panic(<span class=\"string\">\"unhandled trap in kernel\"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                env_destroy(curenv);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<ol start=\"3\">\n<li>(<code>break point exception</code>),<code>IDT</code>,,,,(<code>general protection exception</code>).,<br>:<br><code>IDT</code>,<code>DPL</code>3,,0,.<code>DPL</code><code>Descriptor Privileged Level</code>,,<code>CPL,RPL</code><code>DPL</code>,,.,<code>CPL</code>3,,<code>int 3</code>,,<code>CPL</code><code>int 3</code><code>DPL</code>,,<code>IDT</code><code>DPL</code>3,,,,.</li>\n</ol>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>kernel.,kernel.CPU,kernel,.,,.<br>JOS,<code>int</code>,CPU.,<code>int $0x30</code>.,<code>int 0x30</code>.<br>.,kernel.<code>%eax</code>,<code>%edx, %ecx, %ebx, %edi,  %esi</code>.kernel<code>%eax</code>.<code>lib/syscall.c</code>.</p>\n<h4 id=\"7\"><a href=\"#7\" class=\"headerlink\" title=\"7\"></a>7</h4><p>:</p>\n<blockquote>\n<p><code>T_SYSCALL</code>.<code>kern/trapentry.S</code><code>kern/trap.c</code><code>trap_init()</code>,<code>trap_dispatch()</code>,<code>syscall()</code><code>kern/syscall.c</code>.<code>kern/syscall.c</code><code>syscall()</code>, <code>-E_INVAL</code>.<code>lib/syscall.c</code>,<code>inc/syscall.h</code>.<br><code>make run-hello</code><code>user/hello</code>, hello, world,.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>:kernel,,<code>sys_cputs</code>,,<code>lib/syscall.c</code><code>sys_cputs</code>,<code>sys_cputs</code>, <code>sys_cgetc</code>. <code>syscall()</code>,..<br>kernel,.,<code>lib/syscall.c</code><code>syscall</code>.<br>,,<code>sys_cputs</code>,,<code>int $0x30</code>,,<code>0x3</code>,<code>T_SYSCALL</code>,,<code>kern/trapentry.S</code>,<code>TRAPHANDLER_NOEC</code>,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/trapentry.S</span></span><br><span class=\"line\">....</span><br><span class=\"line\">TRAPHANDLER_NOEC(t_fperr, T_FPERR)</span><br><span class=\"line\">TRAPHANDLER(t_align, T_ALIGN)</span><br><span class=\"line\">TRAPHANDLER_NOEC(t_mchk, T_MCHK)</span><br><span class=\"line\">TRAPHANDLER_NOEC(t_simderr, T_SIMDERR)</span><br><span class=\"line\">....</span><br><span class=\"line\">TRAPHANDLER_NOEC(t_syscall, T_SYSCALL)</span><br><span class=\"line\">....</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>trap.c</code><code>t_syscall()`</code>.<code>trap_init()</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/trap.c</span></span><br><span class=\"line\">....</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">t_fperr</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">t_align</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">t_mchk</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">t_simderr</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">t_syscall</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">.....</span><br><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">trap_init(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">extern</span> <span class=\"keyword\">struct</span> Segdesc gdt[];</span><br><span class=\"line\"></span><br><span class=\"line\">        .....</span><br><span class=\"line\">    SETGATE(idt[T_ALIGN], <span class=\"number\">0</span>, GD_KT, t_align, <span class=\"number\">0</span>);</span><br><span class=\"line\">    SETGATE(idt[T_MCHK], <span class=\"number\">0</span>, GD_KT, t_mchk, <span class=\"number\">0</span>);</span><br><span class=\"line\">    SETGATE(idt[T_SIMDERR], <span class=\"number\">0</span>, GD_KT, t_simderr, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    SETGATE(idt[T_SYSCALL], <span class=\"number\">0</span>, GD_KT, t_syscall, <span class=\"number\">3</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Per-CPU setup</span></span><br><span class=\"line\">    trap_init_percpu();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>,,, <code>_alltraps</code>,<code>trap()</code>,<code>trap()</code>,<code>trap_dispatch()</code>.<code>kern/syscall.c</code><code>syscall</code>,<code>lib/syscall.c1</code><code>syscall</code>,<code>kern/syscall.c</code><code>syscall</code>, <code>lib/syscall.c</code><code>syscall</code>,</p>\n</blockquote>\n<blockquote>\n<p><code>kern/syscall.c</code><code>syscall</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">syscall(<span class=\"keyword\">uint32_t</span> syscallno, <span class=\"keyword\">uint32_t</span> a1, <span class=\"keyword\">uint32_t</span> a2, <span class=\"keyword\">uint32_t</span> a3, <span class=\"keyword\">uint32_t</span> a4, <span class=\"keyword\">uint32_t</span> a5)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p> <code>lib/syscall.c</code><code>syscall</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">syscall(<span class=\"keyword\">int</span> num, <span class=\"keyword\">int</span> check, <span class=\"keyword\">uint32_t</span> a1, <span class=\"keyword\">uint32_t</span> a2, <span class=\"keyword\">uint32_t</span> a3, <span class=\"keyword\">uint32_t</span> a4, <span class=\"keyword\">uint32_t</span> a5)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>,<code>kern/syscall.c</code><code>syscall</code>,<code>lib/syscall</code>., <code>kern/syscall.c</code>,<code>kern/syscall.c</code> <code>lib/syscall.c</code>. <code>sys_cputs</code> ,,.<code>sys_cputs</code><br><code>kern/syscall.c</code><code>sys_cputs</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">sys_cputs(<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *s, <span class=\"keyword\">size_t</span> len)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Check that the user has permission to read memory [s, s+len).</span></span><br><span class=\"line\">    <span class=\"comment\">// Destroy the environment if not:.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    user_mem_assert(curenv, s, len, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Print the string supplied by the user.</span></span><br><span class=\"line\">    cprintf(<span class=\"string\">\"%.*s\"</span>, len, s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>lib/syscall.c</code><code>sys_cputs</code>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">sys_cputs(<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *s, <span class=\"keyword\">size_t</span> len)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    syscall(SYS_cputs, <span class=\"number\">0</span>, (<span class=\"keyword\">uint32_t</span>)s, len, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>lib/syscall.c</code>,<code>syscall</code>, <code>kern/syscall.c</code><code>sys_cputs</code>,<code>cprintf</code>,.,,kernel,<code>cprintf</code><code>lib/syscall.c</code><code>sys_cputs</code>,kernel,<code>sys_cputs</code>. <code>kern/syscall.c</code><code>sys_cputs</code><code>cprintf</code> <code>lib/syscall.c</code><code>syscall</code>.<br><code>kern/syscall.c</code><code>syscall()</code><code>sys_cputs</code>, <code>kern/syscall.c</code> ..</p>\n</blockquote>\n<blockquote>\n<p><code>syscall</code><code>syscallno</code>., <code>lib/syscall.c</code> <code>syscall</code>,<code>%eax</code>,<code>trap_dispatch</code><code>kern/syscall.c</code><code>syscall</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">trap_dispatch(<span class=\"keyword\">struct</span> Trapframe *tf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int32_t</span> ret_code;</span><br><span class=\"line\">    <span class=\"comment\">// Handle processor exceptions.</span></span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(tf-&gt;tf_trapno) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_PGFLT):</span><br><span class=\"line\">            page_fault_handler(tf);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_BRKPT):</span><br><span class=\"line\">            monitor(tf);        </span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_SYSCALL):</span><br><span class=\"line\">    <span class=\"comment\">//        print_trapframe(tf);</span></span><br><span class=\"line\">            ret_code = syscall(</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_eax,</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_edx,</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_ecx,</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_ebx,</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_edi,</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_esi);</span><br><span class=\"line\">            tf-&gt;tf_regs.reg_eax = ret_code;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">         <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"comment\">// Unexpected trap: The user process or the kernel has a bug.</span></span><br><span class=\"line\">            print_trapframe(tf);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (tf-&gt;tf_cs == GD_KT)</span><br><span class=\"line\">                panic(<span class=\"string\">\"unhandled trap in kernel\"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                env_destroy(curenv);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>kern/syscall.c</code>  <code>syscall</code>():<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int32_t</span></span><br><span class=\"line\">syscall(<span class=\"keyword\">uint32_t</span> syscallno, <span class=\"keyword\">uint32_t</span> a1, <span class=\"keyword\">uint32_t</span> a2, <span class=\"keyword\">uint32_t</span> a3, <span class=\"keyword\">uint32_t</span> a4, <span class=\"keyword\">uint32_t</span> a5)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Call the function corresponding to the 'syscallno' parameter.</span></span><br><span class=\"line\">    <span class=\"comment\">// Return any appropriate return value.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// panic(\"syscall not implemented\");</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (syscallno) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (SYS_cputs):</span><br><span class=\"line\">            sys_cputs((<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *)a1, a2);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (SYS_cgetc):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> sys_cgetc();</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (SYS_getenvid):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> sys_getenvid();</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (SYS_env_destroy):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> sys_env_destroy(a1);</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>lib/entry.S</code>.,,<code>lib/libmain.c</code><code>libmain()</code>.<code>libmain()</code>,<code>thisenv</code> , <code>Env</code>.<br><code>libmain()</code><code>umain()</code>.<code>umain()</code><code>user/hello.c</code>.,<code>hello.c</code> hello, world,<code>page fault</code>(),<code>thisenv-&gt;env_id</code>..<code>thisenv</code>,.</p>\n<h3 id=\"8\"><a href=\"#8\" class=\"headerlink\" title=\"8\"></a>8</h3><p></p>\n<blockquote>\n<p>,kernel,<code>user/hello</code> hello, world,  i am environment 00001000.<code>user/hello</code><code>sys_env_destroy()lib/libmain.c lib/exit.c</code>.kernel,,kernel.</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p><code>env_id</code>, <code>Env</code>.<code>env_id</code><code>sys_getenvid()</code>.<code>Env</code><br><code>lib/env.h</code>,<code>env_id</code><code>int32_t</code>,</p>\n<ul>\n<li>310</li>\n<li>10~3021,</li>\n<li>0~9<code>Env</code>,<code>envs</code>.<br><code>env_id</code> 0~9 ,<code>Env</code>.<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">libmain(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span> **argv)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// set thisenv to point at our Env structure in envs[].</span></span><br><span class=\"line\">    thisenv = &amp;envs[ENVX(sys_getenvid())];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// save the name of the program so that panic() can use it</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        binaryname = argv[<span class=\"number\">0</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// call user main routine</span></span><br><span class=\"line\">    umain(argc, argv);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// exit gracefully</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>,.<br>.,.,,,,,.,,.,.</p>\n<blockquote>\n<p>.,,,,,.</p>\n</blockquote>\n<p>...,.</p>\n<ol>\n<li>page fault).,bug,.,.</li>\n<li>.,,.,.</li>\n</ol>\n<p>.,,.</p>\n<h4 id=\"9\"><a href=\"#9\" class=\"headerlink\" title=\"9\"></a>9</h4><p></p>\n<blockquote>\n<p><code>kern/trap.c</code>,,<code>trap.c</code><code>panic</code>.<code>user_mem_assert</code><code>kern/pmap.c</code>,<code>user_mem_check</code><code>kern/syscall.c</code>.<br>,<code>user/buggyhello</code>,,<code>panic</code>,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[00001000] user_mem_check assertion failure for va 00000001</span><br><span class=\"line\">[00001000] free env 00001000</span><br><span class=\"line\">Destroyed the only environment - nothing more to do!</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p></p>\n<blockquote>\n<p><code>CS</code>2,<code>CPL</code>,,0,3.<br>,<code>panic</code>,<code>page_fault_handler</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">page_fault_handler(<span class=\"keyword\">struct</span> Trapframe *tf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> fault_va;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Read processor's CR2 register to find the faulting address</span></span><br><span class=\"line\">    fault_va = rcr2();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Handle kernel-mode s.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(tf-&gt;tf_cs &amp;&amp; <span class=\"number\">0x01</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        panic(<span class=\"string\">\"page_fault in kernel mode, fault address %d\\n\"</span>, fault_va);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// We've already handled kernel-mode exceptions, so if we get here,</span></span><br><span class=\"line\">    <span class=\"comment\">// the page fault happened in user mode.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Destroy the environment that caused the fault.</span></span><br><span class=\"line\">    cprintf(<span class=\"string\">\"[%08x] user fault va %08x ip %08x\\n\"</span>,</span><br><span class=\"line\">        curenv-&gt;env_id, fault_va, tf-&gt;tf_eip);</span><br><span class=\"line\">    print_trapframe(tf);</span><br><span class=\"line\">    env_destroy(curenv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>,<code>kern/pmap.c</code><code>user_mem_assert()</code>, <code>user_mem_check</code> , <code>user_mem_assert()</code>, <code>user_mem_check()</code>. <code>user_mem_check</code><code>[va, va+len]</code><code>perm| PTE_P</code>.<br>,,,<code>perm|PTE_P</code>,,<code>perm|PTE_P</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">user_mem_check(<span class=\"keyword\">struct</span> Env *env, <span class=\"keyword\">const</span> <span class=\"keyword\">void</span> *va, <span class=\"keyword\">size_t</span> len, <span class=\"keyword\">int</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> * end = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> * start = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    start = ROUNDDOWN((<span class=\"keyword\">char</span> *)va, PGSIZE);</span><br><span class=\"line\">    end = ROUNDUP((<span class=\"keyword\">char</span> *)(va + len), PGSIZE);</span><br><span class=\"line\">    <span class=\"keyword\">pte_t</span> * cur = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(; start &lt; end; start += PGSIZE) &#123;</span><br><span class=\"line\">        cur = pgdir_walk(env-&gt;env_pgdir, (<span class=\"keyword\">void</span> *)start, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>((<span class=\"keyword\">int</span>)start &gt; ULIM || cur == <span class=\"literal\">NULL</span> || ((<span class=\"keyword\">uint32_t</span>)(*cur) &amp; perm) != perm) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">if</span>(start == ROUNDDOWN((<span class=\"keyword\">char</span> *)va, PGSIZE)) &#123;</span><br><span class=\"line\">                    user_mem_check_addr = (<span class=\"keyword\">uintptr_t</span>)va;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">              <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                      user_mem_check_addr = (<span class=\"keyword\">uintptr_t</span>)start;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">              <span class=\"keyword\">return</span> -E_FAULT;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>kern/syscall.c</code>,<code>sys_cputs</code> ,<code>[s, s+len]</code>,<code>user_mem_assert</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">sys_cputs(<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *s, <span class=\"keyword\">size_t</span> len)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Check that the user has permission to read memory [s, s+len).</span></span><br><span class=\"line\">    <span class=\"comment\">// Destroy the environment if not:.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    user_mem_assert(curenv, s, len, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Print the string supplied by the user.</span></span><br><span class=\"line\">    cprintf(<span class=\"string\">\"%.*s\"</span>, len, s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>kern/kdebug</code><code>debuginfo_eip</code>,<code>user_mem_check</code><code>PTE_U</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">struct</span> UserStabData *usd = (<span class=\"keyword\">const</span> <span class=\"keyword\">struct</span> UserStabData *) USTABDATA;</span><br><span class=\"line\">    <span class=\"comment\">// Make sure this memory is valid.</span></span><br><span class=\"line\">    <span class=\"comment\">// Return -1 if it is not.  Hint: Call user_mem_check.</span></span><br><span class=\"line\">    <span class=\"comment\">// LAB 3: Your code here.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (user_mem_check(curenv, usd, <span class=\"keyword\">sizeof</span>(*usd),PTE_U) &lt;<span class=\"number\">0</span> )</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    stabs = usd-&gt;stabs;</span><br><span class=\"line\">    stab_end = usd-&gt;stab_end;</span><br><span class=\"line\">    stabstr = usd-&gt;stabstr;</span><br><span class=\"line\">    stabstr_end = usd-&gt;stabstr_end;</span><br><span class=\"line\">    <span class=\"comment\">// Make sure the STABS and string table memory is valid.</span></span><br><span class=\"line\">    <span class=\"comment\">// LAB 3: Your code here.a</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (user_mem_check(curenv, stabs, stab_end-stabs,PTE_U) &lt;<span class=\"number\">0</span> || `user_mem_check`(curenv, stabstr, stabstr_end-stabstr,PTE_U) &lt;<span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://pdos.csail.mit.edu/6.828/2016/labs/lab3/\" target=\"_blank\" rel=\"noopener\">lab3:user environment</a></p>\n","site":{"data":{}},"excerpt":"<h1 id=\"Lab3--Part2\"><a href=\"#Lab3--Part2\" class=\"headerlink\" title=\"Lab3  Part2\"></a>Lab3  Part2</h1><h2 id=\"Part2--\"><a href=\"#Part2--\" class=\"headerlink\" title=\"Part2 , \"></a>Part2 , </h2><p>part1,JOSkernel,part2,/.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>14<code>T_PGFLT</code>,,kernel.,<code>CR2</code>.<code>trap.c</code>,<code>page_fault_handler()</code>.</p>","more":"<h4 id=\"5\"><a href=\"#5\" class=\"headerlink\" title=\"5\"></a>5</h4><p></p>\n<blockquote>\n<p><code>trap_dispatch</code>, <code>page_fault_handler()</code>.,JOS<code>faultread,faultreadkernel,faultwrite,faultwritekernel</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p> <code>trapentry.S</code><code>TRAPHANDLER</code>,,<code>inc/trap.h</code><code>Trapframe</code>,<code>Trapframe</code><code>tf_trapno</code>. <code>trap_dispatch</code><code>Trapframe</code><code>tf</code> <code>tf_trapno</code>., <code>page_fault_handler</code>,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">trap_dispatch(<span class=\"keyword\">struct</span> Trapframe *tf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int32_t</span> ret_code;</span><br><span class=\"line\">    <span class=\"comment\">// Handle processor exceptions.</span></span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(tf-&gt;tf_trapno) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_PGFLT):</span><br><span class=\"line\">            page_fault_handler(tf);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">         <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"comment\">// Unexpected trap: The user process or the kernel has a bug.</span></span><br><span class=\"line\">            print_trapframe(tf);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (tf-&gt;tf_cs == GD_KT)</span><br><span class=\"line\">                panic(<span class=\"string\">\"unhandled trap in kernel\"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                env_destroy(curenv);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>,3<code>T_BRKPT</code>..<code>INT3</code>:<code>INT3</code>,.JOS,JOSkernel<code>kernel monitor</code>.</p>\n<h3 id=\"6\"><a href=\"#6\" class=\"headerlink\" title=\"6\"></a>6</h3><p></p>\n<blockquote>\n<p><code>trap_dispatch()</code>,kernel. JOS <code>breakpoint</code>.</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p>, (<code>T_BRKPT</code>),kernel monitor <code>kern/monitor.c</code><code>monitor</code> ,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">trap_dispatch(<span class=\"keyword\">struct</span> Trapframe *tf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int32_t</span> ret_code;</span><br><span class=\"line\">    <span class=\"comment\">// Handle processor exceptions.</span></span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(tf-&gt;tf_trapno) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_PGFLT):</span><br><span class=\"line\">            page_fault_handler(tf);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_BRKPT):</span><br><span class=\"line\">            monitor(tf);        </span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">         <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"comment\">// Unexpected trap: The user process or the kernel has a bug.</span></span><br><span class=\"line\">            print_trapframe(tf);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (tf-&gt;tf_cs == GD_KT)</span><br><span class=\"line\">                panic(<span class=\"string\">\"unhandled trap in kernel\"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                env_destroy(curenv);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<ol start=\"3\">\n<li>(<code>break point exception</code>),<code>IDT</code>,,,,(<code>general protection exception</code>).,<br>:<br><code>IDT</code>,<code>DPL</code>3,,0,.<code>DPL</code><code>Descriptor Privileged Level</code>,,<code>CPL,RPL</code><code>DPL</code>,,.,<code>CPL</code>3,,<code>int 3</code>,,<code>CPL</code><code>int 3</code><code>DPL</code>,,<code>IDT</code><code>DPL</code>3,,,,.</li>\n</ol>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>kernel.,kernel.CPU,kernel,.,,.<br>JOS,<code>int</code>,CPU.,<code>int $0x30</code>.,<code>int 0x30</code>.<br>.,kernel.<code>%eax</code>,<code>%edx, %ecx, %ebx, %edi,  %esi</code>.kernel<code>%eax</code>.<code>lib/syscall.c</code>.</p>\n<h4 id=\"7\"><a href=\"#7\" class=\"headerlink\" title=\"7\"></a>7</h4><p>:</p>\n<blockquote>\n<p><code>T_SYSCALL</code>.<code>kern/trapentry.S</code><code>kern/trap.c</code><code>trap_init()</code>,<code>trap_dispatch()</code>,<code>syscall()</code><code>kern/syscall.c</code>.<code>kern/syscall.c</code><code>syscall()</code>, <code>-E_INVAL</code>.<code>lib/syscall.c</code>,<code>inc/syscall.h</code>.<br><code>make run-hello</code><code>user/hello</code>, hello, world,.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>:kernel,,<code>sys_cputs</code>,,<code>lib/syscall.c</code><code>sys_cputs</code>,<code>sys_cputs</code>, <code>sys_cgetc</code>. <code>syscall()</code>,..<br>kernel,.,<code>lib/syscall.c</code><code>syscall</code>.<br>,,<code>sys_cputs</code>,,<code>int $0x30</code>,,<code>0x3</code>,<code>T_SYSCALL</code>,,<code>kern/trapentry.S</code>,<code>TRAPHANDLER_NOEC</code>,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/trapentry.S</span></span><br><span class=\"line\">....</span><br><span class=\"line\">TRAPHANDLER_NOEC(t_fperr, T_FPERR)</span><br><span class=\"line\">TRAPHANDLER(t_align, T_ALIGN)</span><br><span class=\"line\">TRAPHANDLER_NOEC(t_mchk, T_MCHK)</span><br><span class=\"line\">TRAPHANDLER_NOEC(t_simderr, T_SIMDERR)</span><br><span class=\"line\">....</span><br><span class=\"line\">TRAPHANDLER_NOEC(t_syscall, T_SYSCALL)</span><br><span class=\"line\">....</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>trap.c</code><code>t_syscall()`</code>.<code>trap_init()</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/trap.c</span></span><br><span class=\"line\">....</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">t_fperr</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">t_align</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">t_mchk</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">t_simderr</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">t_syscall</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">.....</span><br><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">trap_init(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">extern</span> <span class=\"keyword\">struct</span> Segdesc gdt[];</span><br><span class=\"line\"></span><br><span class=\"line\">        .....</span><br><span class=\"line\">    SETGATE(idt[T_ALIGN], <span class=\"number\">0</span>, GD_KT, t_align, <span class=\"number\">0</span>);</span><br><span class=\"line\">    SETGATE(idt[T_MCHK], <span class=\"number\">0</span>, GD_KT, t_mchk, <span class=\"number\">0</span>);</span><br><span class=\"line\">    SETGATE(idt[T_SIMDERR], <span class=\"number\">0</span>, GD_KT, t_simderr, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    SETGATE(idt[T_SYSCALL], <span class=\"number\">0</span>, GD_KT, t_syscall, <span class=\"number\">3</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Per-CPU setup</span></span><br><span class=\"line\">    trap_init_percpu();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>,,, <code>_alltraps</code>,<code>trap()</code>,<code>trap()</code>,<code>trap_dispatch()</code>.<code>kern/syscall.c</code><code>syscall</code>,<code>lib/syscall.c1</code><code>syscall</code>,<code>kern/syscall.c</code><code>syscall</code>, <code>lib/syscall.c</code><code>syscall</code>,</p>\n</blockquote>\n<blockquote>\n<p><code>kern/syscall.c</code><code>syscall</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">syscall(<span class=\"keyword\">uint32_t</span> syscallno, <span class=\"keyword\">uint32_t</span> a1, <span class=\"keyword\">uint32_t</span> a2, <span class=\"keyword\">uint32_t</span> a3, <span class=\"keyword\">uint32_t</span> a4, <span class=\"keyword\">uint32_t</span> a5)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p> <code>lib/syscall.c</code><code>syscall</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">syscall(<span class=\"keyword\">int</span> num, <span class=\"keyword\">int</span> check, <span class=\"keyword\">uint32_t</span> a1, <span class=\"keyword\">uint32_t</span> a2, <span class=\"keyword\">uint32_t</span> a3, <span class=\"keyword\">uint32_t</span> a4, <span class=\"keyword\">uint32_t</span> a5)</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>,<code>kern/syscall.c</code><code>syscall</code>,<code>lib/syscall</code>., <code>kern/syscall.c</code>,<code>kern/syscall.c</code> <code>lib/syscall.c</code>. <code>sys_cputs</code> ,,.<code>sys_cputs</code><br><code>kern/syscall.c</code><code>sys_cputs</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">sys_cputs(<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *s, <span class=\"keyword\">size_t</span> len)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Check that the user has permission to read memory [s, s+len).</span></span><br><span class=\"line\">    <span class=\"comment\">// Destroy the environment if not:.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    user_mem_assert(curenv, s, len, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Print the string supplied by the user.</span></span><br><span class=\"line\">    cprintf(<span class=\"string\">\"%.*s\"</span>, len, s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>lib/syscall.c</code><code>sys_cputs</code>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">sys_cputs(<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *s, <span class=\"keyword\">size_t</span> len)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    syscall(SYS_cputs, <span class=\"number\">0</span>, (<span class=\"keyword\">uint32_t</span>)s, len, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>lib/syscall.c</code>,<code>syscall</code>, <code>kern/syscall.c</code><code>sys_cputs</code>,<code>cprintf</code>,.,,kernel,<code>cprintf</code><code>lib/syscall.c</code><code>sys_cputs</code>,kernel,<code>sys_cputs</code>. <code>kern/syscall.c</code><code>sys_cputs</code><code>cprintf</code> <code>lib/syscall.c</code><code>syscall</code>.<br><code>kern/syscall.c</code><code>syscall()</code><code>sys_cputs</code>, <code>kern/syscall.c</code> ..</p>\n</blockquote>\n<blockquote>\n<p><code>syscall</code><code>syscallno</code>., <code>lib/syscall.c</code> <code>syscall</code>,<code>%eax</code>,<code>trap_dispatch</code><code>kern/syscall.c</code><code>syscall</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">trap_dispatch(<span class=\"keyword\">struct</span> Trapframe *tf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int32_t</span> ret_code;</span><br><span class=\"line\">    <span class=\"comment\">// Handle processor exceptions.</span></span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(tf-&gt;tf_trapno) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_PGFLT):</span><br><span class=\"line\">            page_fault_handler(tf);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_BRKPT):</span><br><span class=\"line\">            monitor(tf);        </span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (T_SYSCALL):</span><br><span class=\"line\">    <span class=\"comment\">//        print_trapframe(tf);</span></span><br><span class=\"line\">            ret_code = syscall(</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_eax,</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_edx,</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_ecx,</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_ebx,</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_edi,</span><br><span class=\"line\">                    tf-&gt;tf_regs.reg_esi);</span><br><span class=\"line\">            tf-&gt;tf_regs.reg_eax = ret_code;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">         <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"comment\">// Unexpected trap: The user process or the kernel has a bug.</span></span><br><span class=\"line\">            print_trapframe(tf);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (tf-&gt;tf_cs == GD_KT)</span><br><span class=\"line\">                panic(<span class=\"string\">\"unhandled trap in kernel\"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                env_destroy(curenv);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>kern/syscall.c</code>  <code>syscall</code>():<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int32_t</span></span><br><span class=\"line\">syscall(<span class=\"keyword\">uint32_t</span> syscallno, <span class=\"keyword\">uint32_t</span> a1, <span class=\"keyword\">uint32_t</span> a2, <span class=\"keyword\">uint32_t</span> a3, <span class=\"keyword\">uint32_t</span> a4, <span class=\"keyword\">uint32_t</span> a5)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Call the function corresponding to the 'syscallno' parameter.</span></span><br><span class=\"line\">    <span class=\"comment\">// Return any appropriate return value.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// panic(\"syscall not implemented\");</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (syscallno) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (SYS_cputs):</span><br><span class=\"line\">            sys_cputs((<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *)a1, a2);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (SYS_cgetc):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> sys_cgetc();</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (SYS_getenvid):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> sys_getenvid();</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (SYS_env_destroy):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> sys_env_destroy(a1);</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>lib/entry.S</code>.,,<code>lib/libmain.c</code><code>libmain()</code>.<code>libmain()</code>,<code>thisenv</code> , <code>Env</code>.<br><code>libmain()</code><code>umain()</code>.<code>umain()</code><code>user/hello.c</code>.,<code>hello.c</code> hello, world,<code>page fault</code>(),<code>thisenv-&gt;env_id</code>..<code>thisenv</code>,.</p>\n<h3 id=\"8\"><a href=\"#8\" class=\"headerlink\" title=\"8\"></a>8</h3><p></p>\n<blockquote>\n<p>,kernel,<code>user/hello</code> hello, world,  i am environment 00001000.<code>user/hello</code><code>sys_env_destroy()lib/libmain.c lib/exit.c</code>.kernel,,kernel.</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p><code>env_id</code>, <code>Env</code>.<code>env_id</code><code>sys_getenvid()</code>.<code>Env</code><br><code>lib/env.h</code>,<code>env_id</code><code>int32_t</code>,</p>\n<ul>\n<li>310</li>\n<li>10~3021,</li>\n<li>0~9<code>Env</code>,<code>envs</code>.<br><code>env_id</code> 0~9 ,<code>Env</code>.<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">libmain(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span> **argv)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// set thisenv to point at our Env structure in envs[].</span></span><br><span class=\"line\">    thisenv = &amp;envs[ENVX(sys_getenvid())];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// save the name of the program so that panic() can use it</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        binaryname = argv[<span class=\"number\">0</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// call user main routine</span></span><br><span class=\"line\">    umain(argc, argv);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// exit gracefully</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>,.<br>.,.,,,,,.,,.,.</p>\n<blockquote>\n<p>.,,,,,.</p>\n</blockquote>\n<p>...,.</p>\n<ol>\n<li>page fault).,bug,.,.</li>\n<li>.,,.,.</li>\n</ol>\n<p>.,,.</p>\n<h4 id=\"9\"><a href=\"#9\" class=\"headerlink\" title=\"9\"></a>9</h4><p></p>\n<blockquote>\n<p><code>kern/trap.c</code>,,<code>trap.c</code><code>panic</code>.<code>user_mem_assert</code><code>kern/pmap.c</code>,<code>user_mem_check</code><code>kern/syscall.c</code>.<br>,<code>user/buggyhello</code>,,<code>panic</code>,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[00001000] user_mem_check assertion failure for va 00000001</span><br><span class=\"line\">[00001000] free env 00001000</span><br><span class=\"line\">Destroyed the only environment - nothing more to do!</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p></p>\n<blockquote>\n<p><code>CS</code>2,<code>CPL</code>,,0,3.<br>,<code>panic</code>,<code>page_fault_handler</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">page_fault_handler(<span class=\"keyword\">struct</span> Trapframe *tf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> fault_va;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Read processor's CR2 register to find the faulting address</span></span><br><span class=\"line\">    fault_va = rcr2();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Handle kernel-mode s.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(tf-&gt;tf_cs &amp;&amp; <span class=\"number\">0x01</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        panic(<span class=\"string\">\"page_fault in kernel mode, fault address %d\\n\"</span>, fault_va);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// We've already handled kernel-mode exceptions, so if we get here,</span></span><br><span class=\"line\">    <span class=\"comment\">// the page fault happened in user mode.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Destroy the environment that caused the fault.</span></span><br><span class=\"line\">    cprintf(<span class=\"string\">\"[%08x] user fault va %08x ip %08x\\n\"</span>,</span><br><span class=\"line\">        curenv-&gt;env_id, fault_va, tf-&gt;tf_eip);</span><br><span class=\"line\">    print_trapframe(tf);</span><br><span class=\"line\">    env_destroy(curenv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>,<code>kern/pmap.c</code><code>user_mem_assert()</code>, <code>user_mem_check</code> , <code>user_mem_assert()</code>, <code>user_mem_check()</code>. <code>user_mem_check</code><code>[va, va+len]</code><code>perm| PTE_P</code>.<br>,,,<code>perm|PTE_P</code>,,<code>perm|PTE_P</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span></span><br><span class=\"line\">user_mem_check(<span class=\"keyword\">struct</span> Env *env, <span class=\"keyword\">const</span> <span class=\"keyword\">void</span> *va, <span class=\"keyword\">size_t</span> len, <span class=\"keyword\">int</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> * end = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> * start = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    start = ROUNDDOWN((<span class=\"keyword\">char</span> *)va, PGSIZE);</span><br><span class=\"line\">    end = ROUNDUP((<span class=\"keyword\">char</span> *)(va + len), PGSIZE);</span><br><span class=\"line\">    <span class=\"keyword\">pte_t</span> * cur = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(; start &lt; end; start += PGSIZE) &#123;</span><br><span class=\"line\">        cur = pgdir_walk(env-&gt;env_pgdir, (<span class=\"keyword\">void</span> *)start, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>((<span class=\"keyword\">int</span>)start &gt; ULIM || cur == <span class=\"literal\">NULL</span> || ((<span class=\"keyword\">uint32_t</span>)(*cur) &amp; perm) != perm) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">if</span>(start == ROUNDDOWN((<span class=\"keyword\">char</span> *)va, PGSIZE)) &#123;</span><br><span class=\"line\">                    user_mem_check_addr = (<span class=\"keyword\">uintptr_t</span>)va;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">              <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                      user_mem_check_addr = (<span class=\"keyword\">uintptr_t</span>)start;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">              <span class=\"keyword\">return</span> -E_FAULT;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>kern/syscall.c</code>,<code>sys_cputs</code> ,<code>[s, s+len]</code>,<code>user_mem_assert</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">sys_cputs(<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *s, <span class=\"keyword\">size_t</span> len)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Check that the user has permission to read memory [s, s+len).</span></span><br><span class=\"line\">    <span class=\"comment\">// Destroy the environment if not:.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    user_mem_assert(curenv, s, len, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Print the string supplied by the user.</span></span><br><span class=\"line\">    cprintf(<span class=\"string\">\"%.*s\"</span>, len, s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>kern/kdebug</code><code>debuginfo_eip</code>,<code>user_mem_check</code><code>PTE_U</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">struct</span> UserStabData *usd = (<span class=\"keyword\">const</span> <span class=\"keyword\">struct</span> UserStabData *) USTABDATA;</span><br><span class=\"line\">    <span class=\"comment\">// Make sure this memory is valid.</span></span><br><span class=\"line\">    <span class=\"comment\">// Return -1 if it is not.  Hint: Call user_mem_check.</span></span><br><span class=\"line\">    <span class=\"comment\">// LAB 3: Your code here.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (user_mem_check(curenv, usd, <span class=\"keyword\">sizeof</span>(*usd),PTE_U) &lt;<span class=\"number\">0</span> )</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    stabs = usd-&gt;stabs;</span><br><span class=\"line\">    stab_end = usd-&gt;stab_end;</span><br><span class=\"line\">    stabstr = usd-&gt;stabstr;</span><br><span class=\"line\">    stabstr_end = usd-&gt;stabstr_end;</span><br><span class=\"line\">    <span class=\"comment\">// Make sure the STABS and string table memory is valid.</span></span><br><span class=\"line\">    <span class=\"comment\">// LAB 3: Your code here.a</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (user_mem_check(curenv, stabs, stab_end-stabs,PTE_U) &lt;<span class=\"number\">0</span> || `user_mem_check`(curenv, stabstr, stabstr_end-stabstr,PTE_U) &lt;<span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://pdos.csail.mit.edu/6.828/2016/labs/lab3/\" target=\"_blank\" rel=\"noopener\">lab3:user environment</a></p>"},{"title":"lab3-user-environment-part1","date":"2017-04-25T16:00:00.000Z","_content":"\n# Lab3  Part1\n## \nos: (kernel)  (user)., , kernel.\nLab3.:\n> 1. .\n> 2. JOS,,,.\n> 3. JOS,.\n\nLab3:\n> part1. \n> part2. , \n\n<!-- more -->\n\n## \n\n``` bash\ngit pull\ngit checkout -b lab3 origin/Lab3\ngit merge lab2\n```\nlab3:\n``` c\ninc/\tenv.h\t      \n      trap.h\t    \n      syscall.h\t  \n      lib.h\t      \nkern/\tenv.h\t      \n      env.c\t      \n      trap.h\t    \n      trap.c\t    \n      trapentry.S\t\n      syscall.h\t  \n      syscall.c\t  \nlib/\tMakefrag\t  makefile,obj/lib/libJOS.a\n      entry.S\tA   \n      libmain.c\t  entry.S\n      syscall.c\t  \n      console.c\t  putchargetchar ,I/O\n      exit.c\t    \nuser/\t*\t          \n```\n\n## Part1 User Environment\n`inc/env.h`JOS(User Environment).,`Env`.Lab3,,.\n\n`kern/env.c`,\n``` c\nstruct Env *envs = NULL;    // Env l\nstruct Env *curenv = NULL;   //\nstatic struct Env *env_free_list;  // Env \n```\nJOS,`envs``Env`,`env`.JOS`NENV`,`envs``Env`.JOS`env_free_list``Env`,`env`.,`curenv``Env`.,,`curenv``NULL`.\n\n###  Environment Status\n`Env` inc/env.h`:\n``` c\nstruct Env {\nstruct Trapframe env_tf;      //saved registers\nstruct Env * env_link;         //next free Env\nenvid_t env_id;            //Unique environment identifier\nenvid_t env_parent_id;        //envid of this env's parent\nenum EnvType env_type;//Indicates special system environment\nunsigned env_status;   //Status of the environment\nuint32_t env_runs;         //Number of the times environment has run\npde_t \\*env_pgdir;//Kernel virtual address of page dir.\n};\n```\n:\n`env_tf`:\n`inc/trap.h`,,.,,.\n`env_link`:\n`env_free_list``Env`..\n`env_id`:\n.,,`env_id`.\n`env_parent_id`:\n`env_id`\n`env_type`:\n., `ENV_TYPE_USER`.\n`env_status`:\n,:\n`ENV_FREE`: ,`env_free_list`.\n`ENV_RUNNABLE`: ,.\n`ENV_RUNNING`: .\n`ENV_NOT_RUNNABLE`: ,,.\n`ENV_DYING`: ..\n`env_pgdir`:\n\n\n`Unix`,JOS.,`env_pgdir`.,.\n\n### \nlab2`mem_init()``pages`,.lab3`mem_init()`,`Env``envs`.\n\n#### 1:\n:\n> `mem_init()`,`envs`.`NENV``Env`.`envs`,`UENVS`.\n\n:\n> Lab2pages,`Env``envs`\n``` c\n//kern/pmap.c\n//envs\nenvs = (struct Env*)boot_alloc(NENV*sizeof(struct Env));\nmemset(envs, 0, NENV * sizeof(struct Env));\n//envs\nboot_map_region(kern_pgdir, UENVS, PTSIZE, PADDR(envs), PTE_U);\n```\n\n### \n `kern/env.c`.,.`i386_init()`,.\n\n#### 2:\n:\n> `env.c`,\n`env_init()`:\n`envs``Env`, `env_free_list`. `env_init_percpu`,,,0,3.\n`env_setup_vm()`:\n,.\n`region_alloc()`:\n\n`load_icode()`:\n`ELF`,.\n`env_create()`:\n`env_alloc``load_icode`,`ELF`\n`env_run()`:\n,.\n\n:\n> `env_init`,`envs``Env`, `env_id`0,`Env``env_free_list`, `envs`,.\n``` c\n void\nenv_init(void)\n{\n    // Set up envs array\n    int i;\n    env_free_list = NULL;\n    for (i=NENV-1; i>=0; i--){\n        envs[i].env_id = 0;\n        envs[i].env_status = ENV_FREE;\n        envs[i].env_link = env_free_list;\n        env_free_list = &envs[i];\n     }\n     // Per-CPU part of the initialization\n     env_init_percpu();\n}\n```\n> `env_setup_vm()`,,,`UVPT`,,`kern_pgdir``env_pgdir`.\n``` c\nstatic int\nenv_setup_vm(struct Env *e)\n{\n    int i;\n    struct PageInfo* p = NULL;\n\n    // Allocate a page for the page directory\n    if (!(p = page_alloc(ALLOC_ZERO)))\n        return -E_NO_MEM;\n\n     e->env_pgdir = (pde_t *)page2kva(p);\n     p->pp_ref++;\n\n     //Map the directory below UTOP.\n     for (i = 0; i < PDX(UTOP); i++)\n         e->env_pgdir[i] = 0;        \n\n     //Map the directory above UTOP\n     for (i = PDX(UTOP); i < NPDENTRIES; i++) {\n         e->env_pgdir[i] = kern_pgdir[i];\n     }\n\n     // UVPT maps the env's own page table read-only.\n     // Permissions: kernel R, user R\n     e->env_pgdir[PDX(UVPT)] = PADDR(e->env_pgdir) | PTE_P | PTE_U;\n\n     return 0;\n }\n```\n> `region_alloc()`,,,,.\n``` c\nstatic void\nregion_alloc(struct Env *e, void *va, size_t len)\n{\n    void* start = (void *)ROUNDDOWN((uint32_t)va, PGSIZE);\n    void* end = (void *)ROUNDUP((uint32_t)va+len, PGSIZE);\n    struct PageInfo *p = NULL;\n    void* i;\n    int r;\n\n    for(i = start; i < end; i += PGSIZE){\n        p = page_alloc(0);\n        if(p == NULL)\n           panic(\" region alloc failed: allocation failed.\\n\");\n\n        r = page_insert(e->env_pgdir, p, i, PTE_W | PTE_U);\n        if(r != 0)\n            panic(\"region alloc failed.\\n\");\n    }\n}\n```\n>`load_icode()`,CPU.`ELF`,`ELF`.\n``` c\nstatic void\nload_icode(struct Env *e, uint8_t *binary)\n{\n\n    struct Elf* header = (struct Elf*)binary;\n\n    if (header->e_magic != ELF_MAGIC)\n        panic(\"load_icode failed: The binary we load is not elf.\\n\");\n\n    if (header->e_entry == 0)\n        panic(\"load_icode failed: The elf file can't be excuterd.\\n\");\n\n   e->env_tf.tf_eip = header->e_entry;\n\n   lcr3(PADDR(e->env_pgdir));   //load user pgdir\n\n   struct Proghdr *ph, *eph;\n   ph = (struct Proghdr* )((uint8_t *)header + header->e_phoff);\n   eph = ph + header->e_phnum;\n    for(; ph < eph; ph++) {\n        if(ph->p_type == ELF_PROG_LOAD) {\n            if(ph->p_memsz - ph->p_filesz < 0)\n                panic(\"load icode failed : p_memsz < p_filesz.\\n\");\n\n           region_alloc(e, (void *)ph->p_va, ph->p_memsz);\n            memmove((void *)ph->p_va, binary + ph->p_offset, ph->p_filesz);\n            memset((void *)(ph->p_va + ph->p_filesz), 0, ph->p_memsz - ph->p_filesz);\n        }\n     }\n}\n```\n> `env_create``env_alloc``load_icode`,`ELF`\n``` c\nvoid\nenv_create(uint8_t *binary, enum EnvType type)\n{\n    struct Env *e;\n    int rc;\n    if ((rc = env_alloc(&e, 0)) != 0)\n          panic(\"env_create failed: env_alloc failed.\\n\");\n\n     load_icode(e, binary);\n     e->env_type = type;\n }\n```\n> `env_run`\n``` c\nvoid\nenv_run(struct Env *e)\n{\n\n    if(curenv != NULL && curenv->env_status == ENV_RUNNING)\n        curenv->env_status = ENV_RUNNABLE;\n\n    curenv = e;\n    curenv->env_status = ENV_RUNNING;\n    curenv->env_runs++;\n    lcr3(PADDR(curenv->env_pgdir));\n\n    env_pop_tf(&curenv->env_tf);\n\n    panic(\"env_run not yet implemented\");\n}\n```\n\n,\n``` c\n* start (kern/entry.S)\n* i386_init (kern/init.c)\ncons_init\nmem_init\nenv_init\ntrap_init \nenv_create\nenv_run\nenv_pop_tf\n```\n,`QEMU`,,`hello`,`int`.,,JOS.CPU,,,,,,,triple fault.,CPU,.\n\n\n### \n,`int $0x30`,,.,.X86.\n\n### \n(Exception)(Interrupts),CPU.Intel,CPU,IO.CPU,.\n\n,CPU/.CPU,.X86,\n> 1. ** The Interrupt Descriptor Table**\nCPU,,.\nX86256,.0255.//,.CPU,,.`IDT`,CPU:\n>> * `EIP`,.\n>> * `CS`,.\n\n> 2. ** The Task State Segment**\nCPU/CPU,`EIP``CS`.,.,.\n,x86CPU,,. TSS.CPU`SS,ESP,EFLAGS,CS,EIP`.`CS,EIP`,`ESP,SS`.JOS0,CPU`TSS``ESP0,SS0`,.\n\n### /\nX86CPU031.,14.31,int,.\n\npart1JOS,0~31.part2JOS48,.Lab4JOS,.\n\n:\n> CPU,,0.\n```\n         +--------------------+ KSTACKTOP             \n         | 0x00000 | old SS   |     \" - 4\n         |      old ESP       |     \" - 8\n         |     old EFLAGS     |     \" - 12\n         | 0x00000 | old CS   |     \" - 16\n         |      old EIP       |     \" - 20 <---- ESP\n         +--------------------+\n```\n> ,CPU:\n> 1. CPU,`TSS``SS0,ESP0`,`GD_KD``KSTACKTOP`.\n> 2. CPU,`KSTACKTOP`\n> 3. ,0,CPU`IDT`0,`CS:EIP`0.\n> 4. ,.\n\n> ,,,(error code).,.,\n```\n                     +--------------------+ KSTACKTOP             \n                     | 0x00000 | old SS   |     \" - 4\n                     |      old ESP       |     \" - 8\n                     |     old EFLAGS     |     \" - 12\n                     | 0x00000 | old CS   |     \" - 16\n                     |      old EIP       |     \" - 20\n                     |     error code     |     \" - 24 <---- ESP\n                     +--------------------+             \n```\n\n### /\nCPU.CPU,,,.CPU,CPU.,.\nCPU,,`SS,ESP`.:\n```\n                     +--------------------+ <---- old ESP\n                     |     old EFLAGS     |     \" - 4\n                     | 0x00000 | old CS   |     \" - 8\n                     |      old EIP       |     \" - 12\n                     +--------------------+\n```\n: CPU,,,,CPU,.\n\n### IDT\n, IDT,JOS.Lab30~31.`inc/trap.hkern/trap.h`.\n\n```\nIDT                   trapentry.S         trap.c\n\n+----------------+                        \n|   &handler1    |---------> handler1:          trap (struct Trapframe *tf)\n|                |             // do stuff      {\n|                |             call trap          // handle the exception/interrupt\n|                |             // ...           }\n+----------------+\n|   &handler2    |--------> handler2:\n|                |            // do stuff\n|                |            call trap\n|                |            // ...\n+----------------+\n .\n .\n .\n+----------------+\n|   &handlerX    |--------> handlerX:\n|                |             // do stuff\n|                |             call trap\n|                |             // ...\n+----------------+\n```\n\n/,`trapentry.S`.`trap_init()``IDT`. `Trapframe`,`trap()`,`trap()`/,.\n\n> 1. `trap_init()``IDT`.\n> 2. ,,CPU,,,\n> 3. ,.\n> 4. .\n> 5. ,,,.\n\n#### 4\n\n> `trapentry.S``trap.c`,.`trapentry.S``inc/trap.h``trap`, `trap_init()``IDT`,`trapentry.S`.\n`_alltraps`:\n> 1. ,`Trapframe`\n> 2. `GD_KD``%ds, %es`\n> 3. `%esp`,`Trapframe``trap()``.\n> 4. `trap`\n\n> `trapentry.S`,`TRAPHANDLER`,`TRAPHANDLER_NOEC`.name,,./,,,(error code).,,.\n``` c\n#define TRAPHANDLER(name, num)                        \\\n        .globl name;            /* define global symbol for 'name' */   \\\n        .type name, @function;  /* symbol type is function */           \\\n        .align 2;               /* align function definition */         \\\n        name:                   /* function starts here */              \\\n        pushl $(num);                                                   \\\n        jmp _alltraps\n/* Use TRAPHANDLER_NOEC for traps where the CPU doesn't push an error code.\n * It pushes a 0 in place of the error code, so the trap frame has the same\n * format in either case.\n */\n#define TRAPHANDLER_NOEC(name, num)                                     \\\n        .globl name;                                                    \\\n        .type name, @function;                                          \\\n        .align 2;                                                       \\\n        name:                                                           \\\n        pushl $0;                                                       \\\n        pushl $(num);                                                   \\\n        jmp _alltraps\n\n.text\n\n/*\n * Lab 3: Your code here for generating entry points for the different traps.\n */\nTRAPHANDLER_NOEC(divide_entry, T_DIVIDE);\nTRAPHANDLER_NOEC(debug_entry, T_DEBUG);\nTRAPHANDLER_NOEC(nmi_entry, T_NMI);\nTRAPHANDLER_NOEC(brkpt_entry, T_BRKPT);\nTRAPHANDLER_NOEC(oflow_entry, T_OFLOW);\nTRAPHANDLER_NOEC(bound_entry, T_BOUND);\nTRAPHANDLER_NOEC(illop_entry, T_ILLOP);\nTRAPHANDLER_NOEC(device_entry, T_DEVICE);\nTRAPHANDLER(dblflt_entry, T_DBLFLT);\nTRAPHANDLER(tss_entry, T_TSS);\nTRAPHANDLER(segnp_entry, T_SEGNP);\nTRAPHANDLER(stack_entry, T_STACK);\nTRAPHANDLER(gpflt_entry, T_GPFLT);\nTRAPHANDLER(pgflt_entry, T_PGFLT);\nTRAPHANDLER_NOEC(fperr_entry, T_FPERR);\nTRAPHANDLER(align_entry, T_ALIGN);\nTRAPHANDLER_NOEC(mchk_entry, T_MCHK);\nTRAPHANDLER_NOEC(simderr_entry, T_SIMDERR);\nTRAPHANDLER_NOEC(syscall_entry, T_SYSCALL);\n```\n> `_alltraps`,`trap.`c`trap`,,`Trapframe``tf`.\n``` c\n_alltraps:\n        pushl %ds\n        pushl %es\n        pushal\n\n        movl $GD_KD, %eax\n        movl %eax, %ds\n        movl %eax, %es\n\n        push %esp\n        call trap\n```\n> `trap.c``trap_init`,`IDT`,`SETGATE`,\n``` c\n//gate:IDTindex\n//istrap:\n//sel:\n//off:\n//dpl:.\n#define SETGATE(gate, istrap, sel, off, dpl)\n```\n> `trap_init`\n``` c\nvoid\ntrap_init(void)\n{\n        extern struct Segdesc gdt[];\n\n        SETGATE(idt[T_DIVIDE], 0, GD_KT, divide_entry, 0);\n        SETGATE(idt[T_DEBUG], 0, GD_KT, debug_entry, 0);\n        SETGATE(idt[T_NMI], 0, GD_KT, nmi_entry, 0);\n        SETGATE(idt[T_BRKPT], 0, GD_KT, brkpt_entry, 3);\n        SETGATE(idt[T_OFLOW], 0, GD_KT, oflow_entry, 0);\n        SETGATE(idt[T_BOUND], 0, GD_KT, bound_entry, 0);\n        SETGATE(idt[T_ILLOP], 0, GD_KT, illop_entry, 0);\n        SETGATE(idt[T_DEVICE], 0, GD_KT, device_entry, 0);\n        SETGATE(idt[T_DBLFLT], 0, GD_KT, dblflt_entry, 0);\n        SETGATE(idt[T_TSS], 0, GD_KT, tss_entry, 0);\n        SETGATE(idt[T_SEGNP], 0, GD_KT, segnp_entry, 0);\n        SETGATE(idt[T_STACK], 0, GD_KT, stack_entry, 0);\n        SETGATE(idt[T_GPFLT], 0, GD_KT, gpflt_entry, 0);\n        SETGATE(idt[T_PGFLT], 0, GD_KT, pgflt_entry, 0);\n        SETGATE(idt[T_FPERR], 0, GD_KT, fperr_entry, 0);\n        SETGATE(idt[T_ALIGN], 0, GD_KT, align_entry, 0);\n        SETGATE(idt[T_MCHK], 0, GD_KT, mchk_entry, 0);\n        SETGATE(idt[T_SIMDERR], 0, GD_KT, simderr_entry, 0);\n        SETGATE(idt[T_SYSCALL], 0, GD_KT, syscall_entry, 3);\n\n        trap_init_percpu();\n}\n```\n\n### \n1. /?/,?\n:\n,/,,.IO,.\n\n2. ,13,`int $14`.13?`int $14`14,?\n\n,3,`INT`,0.30,`General Protection Exception`,`trap 13\n","source":"_posts/lab3_part1.md","raw":"title: lab3-user-environment-part1\ndate: 2017/04/26\ntags:\n- xv6\n- os\n\n---\n\n# Lab3  Part1\n## \nos: (kernel)  (user)., , kernel.\nLab3.:\n> 1. .\n> 2. JOS,,,.\n> 3. JOS,.\n\nLab3:\n> part1. \n> part2. , \n\n<!-- more -->\n\n## \n\n``` bash\ngit pull\ngit checkout -b lab3 origin/Lab3\ngit merge lab2\n```\nlab3:\n``` c\ninc/\tenv.h\t      \n      trap.h\t    \n      syscall.h\t  \n      lib.h\t      \nkern/\tenv.h\t      \n      env.c\t      \n      trap.h\t    \n      trap.c\t    \n      trapentry.S\t\n      syscall.h\t  \n      syscall.c\t  \nlib/\tMakefrag\t  makefile,obj/lib/libJOS.a\n      entry.S\tA   \n      libmain.c\t  entry.S\n      syscall.c\t  \n      console.c\t  putchargetchar ,I/O\n      exit.c\t    \nuser/\t*\t          \n```\n\n## Part1 User Environment\n`inc/env.h`JOS(User Environment).,`Env`.Lab3,,.\n\n`kern/env.c`,\n``` c\nstruct Env *envs = NULL;    // Env l\nstruct Env *curenv = NULL;   //\nstatic struct Env *env_free_list;  // Env \n```\nJOS,`envs``Env`,`env`.JOS`NENV`,`envs``Env`.JOS`env_free_list``Env`,`env`.,`curenv``Env`.,,`curenv``NULL`.\n\n###  Environment Status\n`Env` inc/env.h`:\n``` c\nstruct Env {\nstruct Trapframe env_tf;      //saved registers\nstruct Env * env_link;         //next free Env\nenvid_t env_id;            //Unique environment identifier\nenvid_t env_parent_id;        //envid of this env's parent\nenum EnvType env_type;//Indicates special system environment\nunsigned env_status;   //Status of the environment\nuint32_t env_runs;         //Number of the times environment has run\npde_t \\*env_pgdir;//Kernel virtual address of page dir.\n};\n```\n:\n`env_tf`:\n`inc/trap.h`,,.,,.\n`env_link`:\n`env_free_list``Env`..\n`env_id`:\n.,,`env_id`.\n`env_parent_id`:\n`env_id`\n`env_type`:\n., `ENV_TYPE_USER`.\n`env_status`:\n,:\n`ENV_FREE`: ,`env_free_list`.\n`ENV_RUNNABLE`: ,.\n`ENV_RUNNING`: .\n`ENV_NOT_RUNNABLE`: ,,.\n`ENV_DYING`: ..\n`env_pgdir`:\n\n\n`Unix`,JOS.,`env_pgdir`.,.\n\n### \nlab2`mem_init()``pages`,.lab3`mem_init()`,`Env``envs`.\n\n#### 1:\n:\n> `mem_init()`,`envs`.`NENV``Env`.`envs`,`UENVS`.\n\n:\n> Lab2pages,`Env``envs`\n``` c\n//kern/pmap.c\n//envs\nenvs = (struct Env*)boot_alloc(NENV*sizeof(struct Env));\nmemset(envs, 0, NENV * sizeof(struct Env));\n//envs\nboot_map_region(kern_pgdir, UENVS, PTSIZE, PADDR(envs), PTE_U);\n```\n\n### \n `kern/env.c`.,.`i386_init()`,.\n\n#### 2:\n:\n> `env.c`,\n`env_init()`:\n`envs``Env`, `env_free_list`. `env_init_percpu`,,,0,3.\n`env_setup_vm()`:\n,.\n`region_alloc()`:\n\n`load_icode()`:\n`ELF`,.\n`env_create()`:\n`env_alloc``load_icode`,`ELF`\n`env_run()`:\n,.\n\n:\n> `env_init`,`envs``Env`, `env_id`0,`Env``env_free_list`, `envs`,.\n``` c\n void\nenv_init(void)\n{\n    // Set up envs array\n    int i;\n    env_free_list = NULL;\n    for (i=NENV-1; i>=0; i--){\n        envs[i].env_id = 0;\n        envs[i].env_status = ENV_FREE;\n        envs[i].env_link = env_free_list;\n        env_free_list = &envs[i];\n     }\n     // Per-CPU part of the initialization\n     env_init_percpu();\n}\n```\n> `env_setup_vm()`,,,`UVPT`,,`kern_pgdir``env_pgdir`.\n``` c\nstatic int\nenv_setup_vm(struct Env *e)\n{\n    int i;\n    struct PageInfo* p = NULL;\n\n    // Allocate a page for the page directory\n    if (!(p = page_alloc(ALLOC_ZERO)))\n        return -E_NO_MEM;\n\n     e->env_pgdir = (pde_t *)page2kva(p);\n     p->pp_ref++;\n\n     //Map the directory below UTOP.\n     for (i = 0; i < PDX(UTOP); i++)\n         e->env_pgdir[i] = 0;        \n\n     //Map the directory above UTOP\n     for (i = PDX(UTOP); i < NPDENTRIES; i++) {\n         e->env_pgdir[i] = kern_pgdir[i];\n     }\n\n     // UVPT maps the env's own page table read-only.\n     // Permissions: kernel R, user R\n     e->env_pgdir[PDX(UVPT)] = PADDR(e->env_pgdir) | PTE_P | PTE_U;\n\n     return 0;\n }\n```\n> `region_alloc()`,,,,.\n``` c\nstatic void\nregion_alloc(struct Env *e, void *va, size_t len)\n{\n    void* start = (void *)ROUNDDOWN((uint32_t)va, PGSIZE);\n    void* end = (void *)ROUNDUP((uint32_t)va+len, PGSIZE);\n    struct PageInfo *p = NULL;\n    void* i;\n    int r;\n\n    for(i = start; i < end; i += PGSIZE){\n        p = page_alloc(0);\n        if(p == NULL)\n           panic(\" region alloc failed: allocation failed.\\n\");\n\n        r = page_insert(e->env_pgdir, p, i, PTE_W | PTE_U);\n        if(r != 0)\n            panic(\"region alloc failed.\\n\");\n    }\n}\n```\n>`load_icode()`,CPU.`ELF`,`ELF`.\n``` c\nstatic void\nload_icode(struct Env *e, uint8_t *binary)\n{\n\n    struct Elf* header = (struct Elf*)binary;\n\n    if (header->e_magic != ELF_MAGIC)\n        panic(\"load_icode failed: The binary we load is not elf.\\n\");\n\n    if (header->e_entry == 0)\n        panic(\"load_icode failed: The elf file can't be excuterd.\\n\");\n\n   e->env_tf.tf_eip = header->e_entry;\n\n   lcr3(PADDR(e->env_pgdir));   //load user pgdir\n\n   struct Proghdr *ph, *eph;\n   ph = (struct Proghdr* )((uint8_t *)header + header->e_phoff);\n   eph = ph + header->e_phnum;\n    for(; ph < eph; ph++) {\n        if(ph->p_type == ELF_PROG_LOAD) {\n            if(ph->p_memsz - ph->p_filesz < 0)\n                panic(\"load icode failed : p_memsz < p_filesz.\\n\");\n\n           region_alloc(e, (void *)ph->p_va, ph->p_memsz);\n            memmove((void *)ph->p_va, binary + ph->p_offset, ph->p_filesz);\n            memset((void *)(ph->p_va + ph->p_filesz), 0, ph->p_memsz - ph->p_filesz);\n        }\n     }\n}\n```\n> `env_create``env_alloc``load_icode`,`ELF`\n``` c\nvoid\nenv_create(uint8_t *binary, enum EnvType type)\n{\n    struct Env *e;\n    int rc;\n    if ((rc = env_alloc(&e, 0)) != 0)\n          panic(\"env_create failed: env_alloc failed.\\n\");\n\n     load_icode(e, binary);\n     e->env_type = type;\n }\n```\n> `env_run`\n``` c\nvoid\nenv_run(struct Env *e)\n{\n\n    if(curenv != NULL && curenv->env_status == ENV_RUNNING)\n        curenv->env_status = ENV_RUNNABLE;\n\n    curenv = e;\n    curenv->env_status = ENV_RUNNING;\n    curenv->env_runs++;\n    lcr3(PADDR(curenv->env_pgdir));\n\n    env_pop_tf(&curenv->env_tf);\n\n    panic(\"env_run not yet implemented\");\n}\n```\n\n,\n``` c\n* start (kern/entry.S)\n* i386_init (kern/init.c)\ncons_init\nmem_init\nenv_init\ntrap_init \nenv_create\nenv_run\nenv_pop_tf\n```\n,`QEMU`,,`hello`,`int`.,,JOS.CPU,,,,,,,triple fault.,CPU,.\n\n\n### \n,`int $0x30`,,.,.X86.\n\n### \n(Exception)(Interrupts),CPU.Intel,CPU,IO.CPU,.\n\n,CPU/.CPU,.X86,\n> 1. ** The Interrupt Descriptor Table**\nCPU,,.\nX86256,.0255.//,.CPU,,.`IDT`,CPU:\n>> * `EIP`,.\n>> * `CS`,.\n\n> 2. ** The Task State Segment**\nCPU/CPU,`EIP``CS`.,.,.\n,x86CPU,,. TSS.CPU`SS,ESP,EFLAGS,CS,EIP`.`CS,EIP`,`ESP,SS`.JOS0,CPU`TSS``ESP0,SS0`,.\n\n### /\nX86CPU031.,14.31,int,.\n\npart1JOS,0~31.part2JOS48,.Lab4JOS,.\n\n:\n> CPU,,0.\n```\n         +--------------------+ KSTACKTOP             \n         | 0x00000 | old SS   |     \" - 4\n         |      old ESP       |     \" - 8\n         |     old EFLAGS     |     \" - 12\n         | 0x00000 | old CS   |     \" - 16\n         |      old EIP       |     \" - 20 <---- ESP\n         +--------------------+\n```\n> ,CPU:\n> 1. CPU,`TSS``SS0,ESP0`,`GD_KD``KSTACKTOP`.\n> 2. CPU,`KSTACKTOP`\n> 3. ,0,CPU`IDT`0,`CS:EIP`0.\n> 4. ,.\n\n> ,,,(error code).,.,\n```\n                     +--------------------+ KSTACKTOP             \n                     | 0x00000 | old SS   |     \" - 4\n                     |      old ESP       |     \" - 8\n                     |     old EFLAGS     |     \" - 12\n                     | 0x00000 | old CS   |     \" - 16\n                     |      old EIP       |     \" - 20\n                     |     error code     |     \" - 24 <---- ESP\n                     +--------------------+             \n```\n\n### /\nCPU.CPU,,,.CPU,CPU.,.\nCPU,,`SS,ESP`.:\n```\n                     +--------------------+ <---- old ESP\n                     |     old EFLAGS     |     \" - 4\n                     | 0x00000 | old CS   |     \" - 8\n                     |      old EIP       |     \" - 12\n                     +--------------------+\n```\n: CPU,,,,CPU,.\n\n### IDT\n, IDT,JOS.Lab30~31.`inc/trap.hkern/trap.h`.\n\n```\nIDT                   trapentry.S         trap.c\n\n+----------------+                        \n|   &handler1    |---------> handler1:          trap (struct Trapframe *tf)\n|                |             // do stuff      {\n|                |             call trap          // handle the exception/interrupt\n|                |             // ...           }\n+----------------+\n|   &handler2    |--------> handler2:\n|                |            // do stuff\n|                |            call trap\n|                |            // ...\n+----------------+\n .\n .\n .\n+----------------+\n|   &handlerX    |--------> handlerX:\n|                |             // do stuff\n|                |             call trap\n|                |             // ...\n+----------------+\n```\n\n/,`trapentry.S`.`trap_init()``IDT`. `Trapframe`,`trap()`,`trap()`/,.\n\n> 1. `trap_init()``IDT`.\n> 2. ,,CPU,,,\n> 3. ,.\n> 4. .\n> 5. ,,,.\n\n#### 4\n\n> `trapentry.S``trap.c`,.`trapentry.S``inc/trap.h``trap`, `trap_init()``IDT`,`trapentry.S`.\n`_alltraps`:\n> 1. ,`Trapframe`\n> 2. `GD_KD``%ds, %es`\n> 3. `%esp`,`Trapframe``trap()``.\n> 4. `trap`\n\n> `trapentry.S`,`TRAPHANDLER`,`TRAPHANDLER_NOEC`.name,,./,,,(error code).,,.\n``` c\n#define TRAPHANDLER(name, num)                        \\\n        .globl name;            /* define global symbol for 'name' */   \\\n        .type name, @function;  /* symbol type is function */           \\\n        .align 2;               /* align function definition */         \\\n        name:                   /* function starts here */              \\\n        pushl $(num);                                                   \\\n        jmp _alltraps\n/* Use TRAPHANDLER_NOEC for traps where the CPU doesn't push an error code.\n * It pushes a 0 in place of the error code, so the trap frame has the same\n * format in either case.\n */\n#define TRAPHANDLER_NOEC(name, num)                                     \\\n        .globl name;                                                    \\\n        .type name, @function;                                          \\\n        .align 2;                                                       \\\n        name:                                                           \\\n        pushl $0;                                                       \\\n        pushl $(num);                                                   \\\n        jmp _alltraps\n\n.text\n\n/*\n * Lab 3: Your code here for generating entry points for the different traps.\n */\nTRAPHANDLER_NOEC(divide_entry, T_DIVIDE);\nTRAPHANDLER_NOEC(debug_entry, T_DEBUG);\nTRAPHANDLER_NOEC(nmi_entry, T_NMI);\nTRAPHANDLER_NOEC(brkpt_entry, T_BRKPT);\nTRAPHANDLER_NOEC(oflow_entry, T_OFLOW);\nTRAPHANDLER_NOEC(bound_entry, T_BOUND);\nTRAPHANDLER_NOEC(illop_entry, T_ILLOP);\nTRAPHANDLER_NOEC(device_entry, T_DEVICE);\nTRAPHANDLER(dblflt_entry, T_DBLFLT);\nTRAPHANDLER(tss_entry, T_TSS);\nTRAPHANDLER(segnp_entry, T_SEGNP);\nTRAPHANDLER(stack_entry, T_STACK);\nTRAPHANDLER(gpflt_entry, T_GPFLT);\nTRAPHANDLER(pgflt_entry, T_PGFLT);\nTRAPHANDLER_NOEC(fperr_entry, T_FPERR);\nTRAPHANDLER(align_entry, T_ALIGN);\nTRAPHANDLER_NOEC(mchk_entry, T_MCHK);\nTRAPHANDLER_NOEC(simderr_entry, T_SIMDERR);\nTRAPHANDLER_NOEC(syscall_entry, T_SYSCALL);\n```\n> `_alltraps`,`trap.`c`trap`,,`Trapframe``tf`.\n``` c\n_alltraps:\n        pushl %ds\n        pushl %es\n        pushal\n\n        movl $GD_KD, %eax\n        movl %eax, %ds\n        movl %eax, %es\n\n        push %esp\n        call trap\n```\n> `trap.c``trap_init`,`IDT`,`SETGATE`,\n``` c\n//gate:IDTindex\n//istrap:\n//sel:\n//off:\n//dpl:.\n#define SETGATE(gate, istrap, sel, off, dpl)\n```\n> `trap_init`\n``` c\nvoid\ntrap_init(void)\n{\n        extern struct Segdesc gdt[];\n\n        SETGATE(idt[T_DIVIDE], 0, GD_KT, divide_entry, 0);\n        SETGATE(idt[T_DEBUG], 0, GD_KT, debug_entry, 0);\n        SETGATE(idt[T_NMI], 0, GD_KT, nmi_entry, 0);\n        SETGATE(idt[T_BRKPT], 0, GD_KT, brkpt_entry, 3);\n        SETGATE(idt[T_OFLOW], 0, GD_KT, oflow_entry, 0);\n        SETGATE(idt[T_BOUND], 0, GD_KT, bound_entry, 0);\n        SETGATE(idt[T_ILLOP], 0, GD_KT, illop_entry, 0);\n        SETGATE(idt[T_DEVICE], 0, GD_KT, device_entry, 0);\n        SETGATE(idt[T_DBLFLT], 0, GD_KT, dblflt_entry, 0);\n        SETGATE(idt[T_TSS], 0, GD_KT, tss_entry, 0);\n        SETGATE(idt[T_SEGNP], 0, GD_KT, segnp_entry, 0);\n        SETGATE(idt[T_STACK], 0, GD_KT, stack_entry, 0);\n        SETGATE(idt[T_GPFLT], 0, GD_KT, gpflt_entry, 0);\n        SETGATE(idt[T_PGFLT], 0, GD_KT, pgflt_entry, 0);\n        SETGATE(idt[T_FPERR], 0, GD_KT, fperr_entry, 0);\n        SETGATE(idt[T_ALIGN], 0, GD_KT, align_entry, 0);\n        SETGATE(idt[T_MCHK], 0, GD_KT, mchk_entry, 0);\n        SETGATE(idt[T_SIMDERR], 0, GD_KT, simderr_entry, 0);\n        SETGATE(idt[T_SYSCALL], 0, GD_KT, syscall_entry, 3);\n\n        trap_init_percpu();\n}\n```\n\n### \n1. /?/,?\n:\n,/,,.IO,.\n\n2. ,13,`int $14`.13?`int $14`14,?\n\n,3,`INT`,0.30,`General Protection Exception`,`trap 13\n","slug":"lab3_part1","published":1,"updated":"2017-08-26T03:38:21.610Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3ha0016s7am1il0xxat","content":"<h1 id=\"Lab3--Part1\"><a href=\"#Lab3--Part1\" class=\"headerlink\" title=\"Lab3  Part1\"></a>Lab3  Part1</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>os: (kernel)  (user)., , kernel.<br>Lab3.:</p>\n<blockquote>\n<ol>\n<li>.</li>\n<li>JOS,,,.</li>\n<li>JOS,.</li>\n</ol>\n</blockquote>\n<p>Lab3:</p>\n<blockquote>\n<p>part1. <br>part2. , </p>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git pull</span><br><span class=\"line\">git checkout -b lab3 origin/Lab3</span><br><span class=\"line\">git merge lab2</span><br></pre></td></tr></table></figure></p>\n<p>lab3:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">inc/\tenv.h\t      </span><br><span class=\"line\">      trap.h\t    </span><br><span class=\"line\">      syscall.h\t  </span><br><span class=\"line\">      lib.h\t      </span><br><span class=\"line\">kern/\tenv.h\t      </span><br><span class=\"line\">      env.c\t      </span><br><span class=\"line\">      trap.h\t    </span><br><span class=\"line\">      trap.c\t    </span><br><span class=\"line\">      trapentry.S\t</span><br><span class=\"line\">      syscall.h\t  </span><br><span class=\"line\">      syscall.c\t  </span><br><span class=\"line\">lib/\tMakefrag\t  makefile,obj/lib/libJOS.a</span><br><span class=\"line\">      entry.S\tA   </span><br><span class=\"line\">      libmain.c\t  entry.S</span><br><span class=\"line\">      syscall.c\t  </span><br><span class=\"line\">      console.c\t  <span class=\"built_in\">putchar</span>getchar ,I/O</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>.c\t    </span><br><span class=\"line\">user/\t*\t          </span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Part1-User-Environment\"><a href=\"#Part1-User-Environment\" class=\"headerlink\" title=\"Part1 User Environment\"></a>Part1 User Environment</h2><p><code>inc/env.h</code>JOS(User Environment).,<code>Env</code>.Lab3,,.</p>\n<p><code>kern/env.c</code>,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> Env *envs = <span class=\"literal\">NULL</span>;    <span class=\"comment\">// Env l</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> Env *curenv = <span class=\"literal\">NULL</span>;   <span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">struct</span> Env *env_free_list;  <span class=\"comment\">// Env </span></span><br></pre></td></tr></table></figure></p>\n<p>JOS,<code>envs</code><code>Env</code>,<code>env</code>.JOS<code>NENV</code>,<code>envs</code><code>Env</code>.JOS<code>env_free_list</code><code>Env</code>,<code>env</code>.,<code>curenv</code><code>Env</code>.,,<code>curenv</code><code>NULL</code>.</p>\n<h3 id=\"-Environment-Status\"><a href=\"#-Environment-Status\" class=\"headerlink\" title=\" Environment Status\"></a> Environment Status</h3><p><code>Env</code> inc/env.h`:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> Env &#123;</span><br><span class=\"line\"><span class=\"keyword\">struct</span> Trapframe env_tf;      <span class=\"comment\">//saved registers</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> Env * env_link;         <span class=\"comment\">//next free Env</span></span><br><span class=\"line\"><span class=\"keyword\">envid_t</span> env_id;            <span class=\"comment\">//Unique environment identifier</span></span><br><span class=\"line\"><span class=\"keyword\">envid_t</span> env_parent_id;        <span class=\"comment\">//envid of this env's parent</span></span><br><span class=\"line\"><span class=\"keyword\">enum</span> EnvType env_type;<span class=\"comment\">//Indicates special system environment</span></span><br><span class=\"line\"><span class=\"keyword\">unsigned</span> env_status;   <span class=\"comment\">//Status of the environment</span></span><br><span class=\"line\"><span class=\"keyword\">uint32_t</span> env_runs;         <span class=\"comment\">//Number of the times environment has run</span></span><br><span class=\"line\"><span class=\"keyword\">pde_t</span> \\*env_pgdir;<span class=\"comment\">//Kernel virtual address of page dir.</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n<p>:<br><code>env_tf</code>:<br><code>inc/trap.h</code>,,.,,.<br><code>env_link</code>:<br><code>env_free_list</code><code>Env</code>..<br><code>env_id</code>:<br>.,,<code>env_id</code>.<br><code>env_parent_id</code>:<br><code>env_id</code><br><code>env_type</code>:<br>., <code>ENV_TYPE_USER</code>.<br><code>env_status</code>:<br>,:<br><code>ENV_FREE</code>: ,<code>env_free_list</code>.<br><code>ENV_RUNNABLE</code>: ,.<br><code>ENV_RUNNING</code>: .<br><code>ENV_NOT_RUNNABLE</code>: ,,.<br><code>ENV_DYING</code>: ..<br><code>env_pgdir</code>:<br></p>\n<p><code>Unix</code>,JOS.,<code>env_pgdir</code>.,.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>lab2<code>mem_init()</code><code>pages</code>,.lab3<code>mem_init()</code>,<code>Env</code><code>envs</code>.</p>\n<h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1:\"></a>1:</h4><p>:</p>\n<blockquote>\n<p><code>mem_init()</code>,<code>envs</code>.<code>NENV</code><code>Env</code>.<code>envs</code>,<code>UENVS</code>.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>Lab2pages,<code>Env</code><code>envs</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/pmap.c</span></span><br><span class=\"line\"><span class=\"comment\">//envs</span></span><br><span class=\"line\">envs = (<span class=\"keyword\">struct</span> Env*)boot_alloc(NENV*<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Env));</span><br><span class=\"line\"><span class=\"built_in\">memset</span>(envs, <span class=\"number\">0</span>, NENV * <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Env));</span><br><span class=\"line\"><span class=\"comment\">//envs</span></span><br><span class=\"line\">boot_map_region(kern_pgdir, UENVS, PTSIZE, PADDR(envs), PTE_U);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> <code>kern/env.c</code>.,.<code>i386_init()</code>,.</p>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2:\"></a>2:</h4><p>:</p>\n<blockquote>\n<p><code>env.c</code>,<br><code>env_init()</code>:<br><code>envs</code><code>Env</code>, <code>env_free_list</code>. <code>env_init_percpu</code>,,,0,3.<br><code>env_setup_vm()</code>:<br>,.<br><code>region_alloc()</code>:<br><br><code>load_icode()</code>:<br><code>ELF</code>,.<br><code>env_create()</code>:<br><code>env_alloc</code><code>load_icode</code>,<code>ELF</code><br><code>env_run()</code>:<br>,.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>env_init</code>,<code>envs</code><code>Env</code>, <code>env_id</code>0,<code>Env</code><code>env_free_list</code>, <code>envs</code>,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"keyword\">void</span></span><br><span class=\"line\">env_init(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Set up envs array</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">    env_free_list = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i=NENV<span class=\"number\">-1</span>; i&gt;=<span class=\"number\">0</span>; i--)&#123;</span><br><span class=\"line\">        envs[i].env_id = <span class=\"number\">0</span>;</span><br><span class=\"line\">        envs[i].env_status = ENV_FREE;</span><br><span class=\"line\">        envs[i].env_link = env_free_list;</span><br><span class=\"line\">        env_free_list = &amp;envs[i];</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"comment\">// Per-CPU part of the initialization</span></span><br><span class=\"line\">     env_init_percpu();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>env_setup_vm()</code>,,,<code>UVPT</code>,,<code>kern_pgdir</code><code>env_pgdir</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">env_setup_vm(<span class=\"keyword\">struct</span> Env *e)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> PageInfo* p = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Allocate a page for the page directory</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(p = page_alloc(ALLOC_ZERO)))</span><br><span class=\"line\">        <span class=\"keyword\">return</span> -E_NO_MEM;</span><br><span class=\"line\"></span><br><span class=\"line\">     e-&gt;env_pgdir = (<span class=\"keyword\">pde_t</span> *)page2kva(p);</span><br><span class=\"line\">     p-&gt;pp_ref++;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"comment\">//Map the directory below UTOP.</span></span><br><span class=\"line\">     <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; PDX(UTOP); i++)</span><br><span class=\"line\">         e-&gt;env_pgdir[i] = <span class=\"number\">0</span>;        </span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"comment\">//Map the directory above UTOP</span></span><br><span class=\"line\">     <span class=\"keyword\">for</span> (i = PDX(UTOP); i &lt; NPDENTRIES; i++) &#123;</span><br><span class=\"line\">         e-&gt;env_pgdir[i] = kern_pgdir[i];</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"comment\">// UVPT maps the env's own page table read-only.</span></span><br><span class=\"line\">     <span class=\"comment\">// Permissions: kernel R, user R</span></span><br><span class=\"line\">     e-&gt;env_pgdir[PDX(UVPT)] = PADDR(e-&gt;env_pgdir) | PTE_P | PTE_U;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>region_alloc()</code>,,,,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">region_alloc(<span class=\"keyword\">struct</span> Env *e, <span class=\"keyword\">void</span> *va, <span class=\"keyword\">size_t</span> len)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">void</span>* start = (<span class=\"keyword\">void</span> *)ROUNDDOWN((<span class=\"keyword\">uint32_t</span>)va, PGSIZE);</span><br><span class=\"line\">    <span class=\"keyword\">void</span>* end = (<span class=\"keyword\">void</span> *)ROUNDUP((<span class=\"keyword\">uint32_t</span>)va+len, PGSIZE);</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> PageInfo *p = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">void</span>* i;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> r;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i = start; i &lt; end; i += PGSIZE)&#123;</span><br><span class=\"line\">        p = page_alloc(<span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(p == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">           panic(<span class=\"string\">\" region alloc failed: allocation failed.\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        r = page_insert(e-&gt;env_pgdir, p, i, PTE_W | PTE_U);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(r != <span class=\"number\">0</span>)</span><br><span class=\"line\">            panic(<span class=\"string\">\"region alloc failed.\\n\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>load_icode()</code>,CPU.<code>ELF</code>,<code>ELF</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">load_icode(<span class=\"keyword\">struct</span> Env *e, <span class=\"keyword\">uint8_t</span> *binary)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">struct</span> Elf* header = (<span class=\"keyword\">struct</span> Elf*)binary;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (header-&gt;e_magic != ELF_MAGIC)</span><br><span class=\"line\">        panic(<span class=\"string\">\"load_icode failed: The binary we load is not elf.\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (header-&gt;e_entry == <span class=\"number\">0</span>)</span><br><span class=\"line\">        panic(<span class=\"string\">\"load_icode failed: The elf file can't be excuterd.\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">   e-&gt;env_tf.tf_eip = header-&gt;e_entry;</span><br><span class=\"line\"></span><br><span class=\"line\">   lcr3(PADDR(e-&gt;env_pgdir));   <span class=\"comment\">//load user pgdir</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">struct</span> Proghdr *ph, *eph;</span><br><span class=\"line\">   ph = (<span class=\"keyword\">struct</span> Proghdr* )((<span class=\"keyword\">uint8_t</span> *)header + header-&gt;e_phoff);</span><br><span class=\"line\">   eph = ph + header-&gt;e_phnum;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(; ph &lt; eph; ph++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(ph-&gt;p_type == ELF_PROG_LOAD) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(ph-&gt;p_memsz - ph-&gt;p_filesz &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"load icode failed : p_memsz &lt; p_filesz.\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">           region_alloc(e, (<span class=\"keyword\">void</span> *)ph-&gt;p_va, ph-&gt;p_memsz);</span><br><span class=\"line\">            memmove((<span class=\"keyword\">void</span> *)ph-&gt;p_va, binary + ph-&gt;p_offset, ph-&gt;p_filesz);</span><br><span class=\"line\">            <span class=\"built_in\">memset</span>((<span class=\"keyword\">void</span> *)(ph-&gt;p_va + ph-&gt;p_filesz), <span class=\"number\">0</span>, ph-&gt;p_memsz - ph-&gt;p_filesz);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>env_create</code><code>env_alloc</code><code>load_icode</code>,<code>ELF</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">env_create(<span class=\"keyword\">uint8_t</span> *binary, <span class=\"keyword\">enum</span> EnvType type)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> Env *e;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> rc;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((rc = env_alloc(&amp;e, <span class=\"number\">0</span>)) != <span class=\"number\">0</span>)</span><br><span class=\"line\">          panic(<span class=\"string\">\"env_create failed: env_alloc failed.\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">     load_icode(e, binary);</span><br><span class=\"line\">     e-&gt;env_type = type;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>env_run</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">env_run(<span class=\"keyword\">struct</span> Env *e)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(curenv != <span class=\"literal\">NULL</span> &amp;&amp; curenv-&gt;env_status == ENV_RUNNING)</span><br><span class=\"line\">        curenv-&gt;env_status = ENV_RUNNABLE;</span><br><span class=\"line\"></span><br><span class=\"line\">    curenv = e;</span><br><span class=\"line\">    curenv-&gt;env_status = ENV_RUNNING;</span><br><span class=\"line\">    curenv-&gt;env_runs++;</span><br><span class=\"line\">    lcr3(PADDR(curenv-&gt;env_pgdir));</span><br><span class=\"line\"></span><br><span class=\"line\">    env_pop_tf(&amp;curenv-&gt;env_tf);</span><br><span class=\"line\"></span><br><span class=\"line\">    panic(<span class=\"string\">\"env_run not yet implemented\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* start (kern/entry.S)</span><br><span class=\"line\">* i386_init (kern/init.c)</span><br><span class=\"line\">cons_init</span><br><span class=\"line\">mem_init</span><br><span class=\"line\">env_init</span><br><span class=\"line\">trap_init </span><br><span class=\"line\">env_create</span><br><span class=\"line\">env_run</span><br><span class=\"line\">env_pop_tf</span><br></pre></td></tr></table></figure></p>\n<p>,<code>QEMU</code>,,<code>hello</code>,<code>int</code>.,,JOS.CPU,,,,,,,triple fault.,CPU,.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>,<code>int $0x30</code>,,.,.X86.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Exception)(Interrupts),CPU.Intel,CPU,IO.CPU,.</p>\n<p>,CPU/.CPU,.X86,</p>\n<blockquote>\n<ol>\n<li><strong> The Interrupt Descriptor Table</strong><br>CPU,,.<br>X86256,.0255.//,.CPU,,.<code>IDT</code>,CPU:<blockquote>\n<ul>\n<li><code>EIP</code>,.</li>\n<li><code>CS</code>,.</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li><strong> The Task State Segment</strong><br>CPU/CPU,<code>EIP</code><code>CS</code>.,.,.<br>,x86CPU,,. TSS.CPU<code>SS,ESP,EFLAGS,CS,EIP</code>.<code>CS,EIP</code>,<code>ESP,SS</code>.JOS0,CPU<code>TSS</code><code>ESP0,SS0</code>,.</li>\n</ol>\n</blockquote>\n<h3 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"/\"></a>/</h3><p>X86CPU031.,14.31,int,.</p>\n<p>part1JOS,0~31.part2JOS48,.Lab4JOS,.</p>\n<p>:</p>\n<blockquote>\n<p>CPU,,0.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+--------------------+ KSTACKTOP             </span><br><span class=\"line\">| 0x00000 | old SS   |     &quot; - 4</span><br><span class=\"line\">|      old ESP       |     &quot; - 8</span><br><span class=\"line\">|     old EFLAGS     |     &quot; - 12</span><br><span class=\"line\">| 0x00000 | old CS   |     &quot; - 16</span><br><span class=\"line\">|      old EIP       |     &quot; - 20 &lt;---- ESP</span><br><span class=\"line\">+--------------------+</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>,CPU:</p>\n<ol>\n<li>CPU,<code>TSS</code><code>SS0,ESP0</code>,<code>GD_KD</code><code>KSTACKTOP</code>.</li>\n<li>CPU,<code>KSTACKTOP</code></li>\n<li>,0,CPU<code>IDT</code>0,<code>CS:EIP</code>0.</li>\n<li>,.</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>,,,(error code).,.,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+--------------------+ KSTACKTOP             </span><br><span class=\"line\">| 0x00000 | old SS   |     &quot; - 4</span><br><span class=\"line\">|      old ESP       |     &quot; - 8</span><br><span class=\"line\">|     old EFLAGS     |     &quot; - 12</span><br><span class=\"line\">| 0x00000 | old CS   |     &quot; - 16</span><br><span class=\"line\">|      old EIP       |     &quot; - 20</span><br><span class=\"line\">|     error code     |     &quot; - 24 &lt;---- ESP</span><br><span class=\"line\">+--------------------+</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"/\"></a>/</h3><p>CPU.CPU,,,.CPU,CPU.,.<br>CPU,,<code>SS,ESP</code>.:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+--------------------+ &lt;---- old ESP</span><br><span class=\"line\">|     old EFLAGS     |     &quot; - 4</span><br><span class=\"line\">| 0x00000 | old CS   |     &quot; - 8</span><br><span class=\"line\">|      old EIP       |     &quot; - 12</span><br><span class=\"line\">+--------------------+</span><br></pre></td></tr></table></figure></p>\n<p>: CPU,,,,CPU,.</p>\n<h3 id=\"IDT\"><a href=\"#IDT\" class=\"headerlink\" title=\"IDT\"></a>IDT</h3><p>, IDT,JOS.Lab30~31.<code>inc/trap.hkern/trap.h</code>.<br><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IDT                   trapentry.S         trap.c</span><br><span class=\"line\"></span><br><span class=\"line\">+----------------+                        </span><br><span class=\"line\">|   &amp;handler1    |---------&gt; handler1:          trap (struct Trapframe *tf)</span><br><span class=\"line\">|                |             // do stuff      &#123;</span><br><span class=\"line\">|                |             call trap          // handle the exception/interrupt</span><br><span class=\"line\">|                |             // ...           &#125;</span><br><span class=\"line\">+----------------+</span><br><span class=\"line\">|   &amp;handler2    |--------&gt; handler2:</span><br><span class=\"line\">|                |            // do stuff</span><br><span class=\"line\">|                |            call trap</span><br><span class=\"line\">|                |            // ...</span><br><span class=\"line\">+----------------+</span><br><span class=\"line\"> .</span><br><span class=\"line\"> .</span><br><span class=\"line\"> .</span><br><span class=\"line\">+----------------+</span><br><span class=\"line\">|   &amp;handlerX    |--------&gt; handlerX:</span><br><span class=\"line\">|                |             // do stuff</span><br><span class=\"line\">|                |             call trap</span><br><span class=\"line\">|                |             // ...</span><br><span class=\"line\">+----------------+</span><br></pre></td></tr></table></figure></p>\n<p>/,<code>trapentry.S</code>.<code>trap_init()</code><code>IDT</code>. <code>Trapframe</code>,<code>trap()</code>,<code>trap()</code>/,.<br></p>\n<blockquote>\n<ol>\n<li><code>trap_init()</code><code>IDT</code>.</li>\n<li>,,CPU,,,</li>\n<li>,.</li>\n<li>.</li>\n<li>,,,.</li>\n</ol>\n</blockquote>\n<h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><p></p>\n<blockquote>\n<p><code>trapentry.S</code><code>trap.c</code>,.<code>trapentry.S</code><code>inc/trap.h</code><code>trap</code>, <code>trap_init()</code><code>IDT</code>,<code>trapentry.S</code>.<br><code>_alltraps</code>:</p>\n<ol>\n<li>,<code>Trapframe</code></li>\n<li><code>GD_KD</code><code>%ds, %es</code></li>\n<li><code>%esp</code>,<code>Trapframe</code><code>trap()`</code>.</li>\n<li><code>trap</code><br><br><code>trapentry.S</code>,<code>TRAPHANDLER</code>,<code>TRAPHANDLER_NOEC</code>.name,,./,,,(error code).,,.<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TRAPHANDLER(name, num)                        \\</span></span><br><span class=\"line\">        .globl name;            <span class=\"comment\">/* define global symbol for 'name' */</span>   \\</span><br><span class=\"line\">        .type name, @function;  <span class=\"comment\">/* symbol type is function */</span>           \\</span><br><span class=\"line\">        .align <span class=\"number\">2</span>;               <span class=\"comment\">/* align function definition */</span>         \\</span><br><span class=\"line\">        name:                   <span class=\"comment\">/* function starts here */</span>              \\</span><br><span class=\"line\">        pushl $(num);                                                   \\</span><br><span class=\"line\">        jmp _alltraps</span><br><span class=\"line\"><span class=\"comment\">/* Use TRAPHANDLER_NOEC for traps where the CPU doesn't push an error code.</span></span><br><span class=\"line\"><span class=\"comment\"> * It pushes a 0 in place of the error code, so the trap frame has the same</span></span><br><span class=\"line\"><span class=\"comment\"> * format in either case.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TRAPHANDLER_NOEC(name, num)                                     \\</span></span><br><span class=\"line\">        .globl name;                                                    \\</span><br><span class=\"line\">        .type name, @function;                                          \\</span><br><span class=\"line\">        .align <span class=\"number\">2</span>;                                                       \\</span><br><span class=\"line\">        name:                                                           \\</span><br><span class=\"line\">        pushl $<span class=\"number\">0</span>;                                                       \\</span><br><span class=\"line\">        pushl $(num);                                                   \\</span><br><span class=\"line\">        jmp _alltraps</span><br><span class=\"line\"></span><br><span class=\"line\">.text</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Lab 3: Your code here for generating entry points for the different traps.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">TRAPHANDLER_NOEC(divide_entry, T_DIVIDE);</span><br><span class=\"line\">TRAPHANDLER_NOEC(debug_entry, T_DEBUG);</span><br><span class=\"line\">TRAPHANDLER_NOEC(nmi_entry, T_NMI);</span><br><span class=\"line\">TRAPHANDLER_NOEC(brkpt_entry, T_BRKPT);</span><br><span class=\"line\">TRAPHANDLER_NOEC(oflow_entry, T_OFLOW);</span><br><span class=\"line\">TRAPHANDLER_NOEC(bound_entry, T_BOUND);</span><br><span class=\"line\">TRAPHANDLER_NOEC(illop_entry, T_ILLOP);</span><br><span class=\"line\">TRAPHANDLER_NOEC(device_entry, T_DEVICE);</span><br><span class=\"line\">TRAPHANDLER(dblflt_entry, T_DBLFLT);</span><br><span class=\"line\">TRAPHANDLER(tss_entry, T_TSS);</span><br><span class=\"line\">TRAPHANDLER(segnp_entry, T_SEGNP);</span><br><span class=\"line\">TRAPHANDLER(stack_entry, T_STACK);</span><br><span class=\"line\">TRAPHANDLER(gpflt_entry, T_GPFLT);</span><br><span class=\"line\">TRAPHANDLER(pgflt_entry, T_PGFLT);</span><br><span class=\"line\">TRAPHANDLER_NOEC(fperr_entry, T_FPERR);</span><br><span class=\"line\">TRAPHANDLER(align_entry, T_ALIGN);</span><br><span class=\"line\">TRAPHANDLER_NOEC(mchk_entry, T_MCHK);</span><br><span class=\"line\">TRAPHANDLER_NOEC(simderr_entry, T_SIMDERR);</span><br><span class=\"line\">TRAPHANDLER_NOEC(syscall_entry, T_SYSCALL);</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<p><code>_alltraps</code>,<code>trap.</code>c<code>trap</code>,,<code>Trapframe</code><code>tf</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_alltraps:</span><br><span class=\"line\">        pushl %ds</span><br><span class=\"line\">        pushl %es</span><br><span class=\"line\">        pushal</span><br><span class=\"line\"></span><br><span class=\"line\">        movl $GD_KD, %eax</span><br><span class=\"line\">        movl %eax, %ds</span><br><span class=\"line\">        movl %eax, %es</span><br><span class=\"line\"></span><br><span class=\"line\">        push %esp</span><br><span class=\"line\">        call trap</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>trap.c</code><code>trap_init</code>,<code>IDT</code>,<code>SETGATE</code>,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//gate:IDTindex</span></span><br><span class=\"line\"><span class=\"comment\">//istrap:</span></span><br><span class=\"line\"><span class=\"comment\">//sel:</span></span><br><span class=\"line\"><span class=\"comment\">//off:</span></span><br><span class=\"line\"><span class=\"comment\">//dpl:.</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SETGATE(gate, istrap, sel, off, dpl)</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>trap_init</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">trap_init(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">extern</span> <span class=\"keyword\">struct</span> Segdesc gdt[];</span><br><span class=\"line\"></span><br><span class=\"line\">        SETGATE(idt[T_DIVIDE], <span class=\"number\">0</span>, GD_KT, divide_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_DEBUG], <span class=\"number\">0</span>, GD_KT, debug_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_NMI], <span class=\"number\">0</span>, GD_KT, nmi_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_BRKPT], <span class=\"number\">0</span>, GD_KT, brkpt_entry, <span class=\"number\">3</span>);</span><br><span class=\"line\">        SETGATE(idt[T_OFLOW], <span class=\"number\">0</span>, GD_KT, oflow_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_BOUND], <span class=\"number\">0</span>, GD_KT, bound_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_ILLOP], <span class=\"number\">0</span>, GD_KT, illop_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_DEVICE], <span class=\"number\">0</span>, GD_KT, device_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_DBLFLT], <span class=\"number\">0</span>, GD_KT, dblflt_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_TSS], <span class=\"number\">0</span>, GD_KT, tss_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_SEGNP], <span class=\"number\">0</span>, GD_KT, segnp_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_STACK], <span class=\"number\">0</span>, GD_KT, stack_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_GPFLT], <span class=\"number\">0</span>, GD_KT, gpflt_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_PGFLT], <span class=\"number\">0</span>, GD_KT, pgflt_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_FPERR], <span class=\"number\">0</span>, GD_KT, fperr_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_ALIGN], <span class=\"number\">0</span>, GD_KT, align_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_MCHK], <span class=\"number\">0</span>, GD_KT, mchk_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_SIMDERR], <span class=\"number\">0</span>, GD_KT, simderr_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_SYSCALL], <span class=\"number\">0</span>, GD_KT, syscall_entry, <span class=\"number\">3</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        trap_init_percpu();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li><p>/?/,?<br>:<br>,/,,.IO,.</p>\n</li>\n<li><p>,13,<code>int $14</code>.13?<code>int $14</code>14,?<br><br>,3,<code>INT</code>,0.30,<code>General Protection Exception</code>,`trap 13</p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"<h1 id=\"Lab3--Part1\"><a href=\"#Lab3--Part1\" class=\"headerlink\" title=\"Lab3  Part1\"></a>Lab3  Part1</h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>os: (kernel)  (user)., , kernel.<br>Lab3.:</p>\n<blockquote>\n<ol>\n<li>.</li>\n<li>JOS,,,.</li>\n<li>JOS,.</li>\n</ol>\n</blockquote>\n<p>Lab3:</p>\n<blockquote>\n<p>part1. <br>part2. , </p>\n</blockquote>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git pull</span><br><span class=\"line\">git checkout -b lab3 origin/Lab3</span><br><span class=\"line\">git merge lab2</span><br></pre></td></tr></table></figure></p>\n<p>lab3:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">inc/\tenv.h\t      </span><br><span class=\"line\">      trap.h\t    </span><br><span class=\"line\">      syscall.h\t  </span><br><span class=\"line\">      lib.h\t      </span><br><span class=\"line\">kern/\tenv.h\t      </span><br><span class=\"line\">      env.c\t      </span><br><span class=\"line\">      trap.h\t    </span><br><span class=\"line\">      trap.c\t    </span><br><span class=\"line\">      trapentry.S\t</span><br><span class=\"line\">      syscall.h\t  </span><br><span class=\"line\">      syscall.c\t  </span><br><span class=\"line\">lib/\tMakefrag\t  makefile,obj/lib/libJOS.a</span><br><span class=\"line\">      entry.S\tA   </span><br><span class=\"line\">      libmain.c\t  entry.S</span><br><span class=\"line\">      syscall.c\t  </span><br><span class=\"line\">      console.c\t  <span class=\"built_in\">putchar</span>getchar ,I/O</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>.c\t    </span><br><span class=\"line\">user/\t*\t          </span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Part1-User-Environment\"><a href=\"#Part1-User-Environment\" class=\"headerlink\" title=\"Part1 User Environment\"></a>Part1 User Environment</h2><p><code>inc/env.h</code>JOS(User Environment).,<code>Env</code>.Lab3,,.</p>\n<p><code>kern/env.c</code>,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> Env *envs = <span class=\"literal\">NULL</span>;    <span class=\"comment\">// Env l</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> Env *curenv = <span class=\"literal\">NULL</span>;   <span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">struct</span> Env *env_free_list;  <span class=\"comment\">// Env </span></span><br></pre></td></tr></table></figure></p>\n<p>JOS,<code>envs</code><code>Env</code>,<code>env</code>.JOS<code>NENV</code>,<code>envs</code><code>Env</code>.JOS<code>env_free_list</code><code>Env</code>,<code>env</code>.,<code>curenv</code><code>Env</code>.,,<code>curenv</code><code>NULL</code>.</p>\n<h3 id=\"-Environment-Status\"><a href=\"#-Environment-Status\" class=\"headerlink\" title=\" Environment Status\"></a> Environment Status</h3><p><code>Env</code> inc/env.h`:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> Env &#123;</span><br><span class=\"line\"><span class=\"keyword\">struct</span> Trapframe env_tf;      <span class=\"comment\">//saved registers</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> Env * env_link;         <span class=\"comment\">//next free Env</span></span><br><span class=\"line\"><span class=\"keyword\">envid_t</span> env_id;            <span class=\"comment\">//Unique environment identifier</span></span><br><span class=\"line\"><span class=\"keyword\">envid_t</span> env_parent_id;        <span class=\"comment\">//envid of this env's parent</span></span><br><span class=\"line\"><span class=\"keyword\">enum</span> EnvType env_type;<span class=\"comment\">//Indicates special system environment</span></span><br><span class=\"line\"><span class=\"keyword\">unsigned</span> env_status;   <span class=\"comment\">//Status of the environment</span></span><br><span class=\"line\"><span class=\"keyword\">uint32_t</span> env_runs;         <span class=\"comment\">//Number of the times environment has run</span></span><br><span class=\"line\"><span class=\"keyword\">pde_t</span> \\*env_pgdir;<span class=\"comment\">//Kernel virtual address of page dir.</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n<p>:<br><code>env_tf</code>:<br><code>inc/trap.h</code>,,.,,.<br><code>env_link</code>:<br><code>env_free_list</code><code>Env</code>..<br><code>env_id</code>:<br>.,,<code>env_id</code>.<br><code>env_parent_id</code>:<br><code>env_id</code><br><code>env_type</code>:<br>., <code>ENV_TYPE_USER</code>.<br><code>env_status</code>:<br>,:<br><code>ENV_FREE</code>: ,<code>env_free_list</code>.<br><code>ENV_RUNNABLE</code>: ,.<br><code>ENV_RUNNING</code>: .<br><code>ENV_NOT_RUNNABLE</code>: ,,.<br><code>ENV_DYING</code>: ..<br><code>env_pgdir</code>:<br></p>\n<p><code>Unix</code>,JOS.,<code>env_pgdir</code>.,.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>lab2<code>mem_init()</code><code>pages</code>,.lab3<code>mem_init()</code>,<code>Env</code><code>envs</code>.</p>\n<h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1:\"></a>1:</h4><p>:</p>\n<blockquote>\n<p><code>mem_init()</code>,<code>envs</code>.<code>NENV</code><code>Env</code>.<code>envs</code>,<code>UENVS</code>.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>Lab2pages,<code>Env</code><code>envs</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/pmap.c</span></span><br><span class=\"line\"><span class=\"comment\">//envs</span></span><br><span class=\"line\">envs = (<span class=\"keyword\">struct</span> Env*)boot_alloc(NENV*<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Env));</span><br><span class=\"line\"><span class=\"built_in\">memset</span>(envs, <span class=\"number\">0</span>, NENV * <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Env));</span><br><span class=\"line\"><span class=\"comment\">//envs</span></span><br><span class=\"line\">boot_map_region(kern_pgdir, UENVS, PTSIZE, PADDR(envs), PTE_U);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> <code>kern/env.c</code>.,.<code>i386_init()</code>,.</p>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2:\"></a>2:</h4><p>:</p>\n<blockquote>\n<p><code>env.c</code>,<br><code>env_init()</code>:<br><code>envs</code><code>Env</code>, <code>env_free_list</code>. <code>env_init_percpu</code>,,,0,3.<br><code>env_setup_vm()</code>:<br>,.<br><code>region_alloc()</code>:<br><br><code>load_icode()</code>:<br><code>ELF</code>,.<br><code>env_create()</code>:<br><code>env_alloc</code><code>load_icode</code>,<code>ELF</code><br><code>env_run()</code>:<br>,.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>env_init</code>,<code>envs</code><code>Env</code>, <code>env_id</code>0,<code>Env</code><code>env_free_list</code>, <code>envs</code>,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"keyword\">void</span></span><br><span class=\"line\">env_init(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Set up envs array</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">    env_free_list = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i=NENV<span class=\"number\">-1</span>; i&gt;=<span class=\"number\">0</span>; i--)&#123;</span><br><span class=\"line\">        envs[i].env_id = <span class=\"number\">0</span>;</span><br><span class=\"line\">        envs[i].env_status = ENV_FREE;</span><br><span class=\"line\">        envs[i].env_link = env_free_list;</span><br><span class=\"line\">        env_free_list = &amp;envs[i];</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"comment\">// Per-CPU part of the initialization</span></span><br><span class=\"line\">     env_init_percpu();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>env_setup_vm()</code>,,,<code>UVPT</code>,,<code>kern_pgdir</code><code>env_pgdir</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">env_setup_vm(<span class=\"keyword\">struct</span> Env *e)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> PageInfo* p = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Allocate a page for the page directory</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(p = page_alloc(ALLOC_ZERO)))</span><br><span class=\"line\">        <span class=\"keyword\">return</span> -E_NO_MEM;</span><br><span class=\"line\"></span><br><span class=\"line\">     e-&gt;env_pgdir = (<span class=\"keyword\">pde_t</span> *)page2kva(p);</span><br><span class=\"line\">     p-&gt;pp_ref++;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"comment\">//Map the directory below UTOP.</span></span><br><span class=\"line\">     <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; PDX(UTOP); i++)</span><br><span class=\"line\">         e-&gt;env_pgdir[i] = <span class=\"number\">0</span>;        </span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"comment\">//Map the directory above UTOP</span></span><br><span class=\"line\">     <span class=\"keyword\">for</span> (i = PDX(UTOP); i &lt; NPDENTRIES; i++) &#123;</span><br><span class=\"line\">         e-&gt;env_pgdir[i] = kern_pgdir[i];</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"comment\">// UVPT maps the env's own page table read-only.</span></span><br><span class=\"line\">     <span class=\"comment\">// Permissions: kernel R, user R</span></span><br><span class=\"line\">     e-&gt;env_pgdir[PDX(UVPT)] = PADDR(e-&gt;env_pgdir) | PTE_P | PTE_U;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>region_alloc()</code>,,,,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">region_alloc(<span class=\"keyword\">struct</span> Env *e, <span class=\"keyword\">void</span> *va, <span class=\"keyword\">size_t</span> len)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">void</span>* start = (<span class=\"keyword\">void</span> *)ROUNDDOWN((<span class=\"keyword\">uint32_t</span>)va, PGSIZE);</span><br><span class=\"line\">    <span class=\"keyword\">void</span>* end = (<span class=\"keyword\">void</span> *)ROUNDUP((<span class=\"keyword\">uint32_t</span>)va+len, PGSIZE);</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> PageInfo *p = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">void</span>* i;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> r;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i = start; i &lt; end; i += PGSIZE)&#123;</span><br><span class=\"line\">        p = page_alloc(<span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(p == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">           panic(<span class=\"string\">\" region alloc failed: allocation failed.\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        r = page_insert(e-&gt;env_pgdir, p, i, PTE_W | PTE_U);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(r != <span class=\"number\">0</span>)</span><br><span class=\"line\">            panic(<span class=\"string\">\"region alloc failed.\\n\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>load_icode()</code>,CPU.<code>ELF</code>,<code>ELF</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">load_icode(<span class=\"keyword\">struct</span> Env *e, <span class=\"keyword\">uint8_t</span> *binary)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">struct</span> Elf* header = (<span class=\"keyword\">struct</span> Elf*)binary;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (header-&gt;e_magic != ELF_MAGIC)</span><br><span class=\"line\">        panic(<span class=\"string\">\"load_icode failed: The binary we load is not elf.\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (header-&gt;e_entry == <span class=\"number\">0</span>)</span><br><span class=\"line\">        panic(<span class=\"string\">\"load_icode failed: The elf file can't be excuterd.\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">   e-&gt;env_tf.tf_eip = header-&gt;e_entry;</span><br><span class=\"line\"></span><br><span class=\"line\">   lcr3(PADDR(e-&gt;env_pgdir));   <span class=\"comment\">//load user pgdir</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">struct</span> Proghdr *ph, *eph;</span><br><span class=\"line\">   ph = (<span class=\"keyword\">struct</span> Proghdr* )((<span class=\"keyword\">uint8_t</span> *)header + header-&gt;e_phoff);</span><br><span class=\"line\">   eph = ph + header-&gt;e_phnum;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(; ph &lt; eph; ph++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(ph-&gt;p_type == ELF_PROG_LOAD) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(ph-&gt;p_memsz - ph-&gt;p_filesz &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"load icode failed : p_memsz &lt; p_filesz.\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">           region_alloc(e, (<span class=\"keyword\">void</span> *)ph-&gt;p_va, ph-&gt;p_memsz);</span><br><span class=\"line\">            memmove((<span class=\"keyword\">void</span> *)ph-&gt;p_va, binary + ph-&gt;p_offset, ph-&gt;p_filesz);</span><br><span class=\"line\">            <span class=\"built_in\">memset</span>((<span class=\"keyword\">void</span> *)(ph-&gt;p_va + ph-&gt;p_filesz), <span class=\"number\">0</span>, ph-&gt;p_memsz - ph-&gt;p_filesz);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>env_create</code><code>env_alloc</code><code>load_icode</code>,<code>ELF</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">env_create(<span class=\"keyword\">uint8_t</span> *binary, <span class=\"keyword\">enum</span> EnvType type)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> Env *e;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> rc;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((rc = env_alloc(&amp;e, <span class=\"number\">0</span>)) != <span class=\"number\">0</span>)</span><br><span class=\"line\">          panic(<span class=\"string\">\"env_create failed: env_alloc failed.\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">     load_icode(e, binary);</span><br><span class=\"line\">     e-&gt;env_type = type;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>env_run</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">env_run(<span class=\"keyword\">struct</span> Env *e)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(curenv != <span class=\"literal\">NULL</span> &amp;&amp; curenv-&gt;env_status == ENV_RUNNING)</span><br><span class=\"line\">        curenv-&gt;env_status = ENV_RUNNABLE;</span><br><span class=\"line\"></span><br><span class=\"line\">    curenv = e;</span><br><span class=\"line\">    curenv-&gt;env_status = ENV_RUNNING;</span><br><span class=\"line\">    curenv-&gt;env_runs++;</span><br><span class=\"line\">    lcr3(PADDR(curenv-&gt;env_pgdir));</span><br><span class=\"line\"></span><br><span class=\"line\">    env_pop_tf(&amp;curenv-&gt;env_tf);</span><br><span class=\"line\"></span><br><span class=\"line\">    panic(<span class=\"string\">\"env_run not yet implemented\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* start (kern/entry.S)</span><br><span class=\"line\">* i386_init (kern/init.c)</span><br><span class=\"line\">cons_init</span><br><span class=\"line\">mem_init</span><br><span class=\"line\">env_init</span><br><span class=\"line\">trap_init </span><br><span class=\"line\">env_create</span><br><span class=\"line\">env_run</span><br><span class=\"line\">env_pop_tf</span><br></pre></td></tr></table></figure></p>\n<p>,<code>QEMU</code>,,<code>hello</code>,<code>int</code>.,,JOS.CPU,,,,,,,triple fault.,CPU,.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>,<code>int $0x30</code>,,.,.X86.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Exception)(Interrupts),CPU.Intel,CPU,IO.CPU,.</p>\n<p>,CPU/.CPU,.X86,</p>\n<blockquote>\n<ol>\n<li><strong> The Interrupt Descriptor Table</strong><br>CPU,,.<br>X86256,.0255.//,.CPU,,.<code>IDT</code>,CPU:<blockquote>\n<ul>\n<li><code>EIP</code>,.</li>\n<li><code>CS</code>,.</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li><strong> The Task State Segment</strong><br>CPU/CPU,<code>EIP</code><code>CS</code>.,.,.<br>,x86CPU,,. TSS.CPU<code>SS,ESP,EFLAGS,CS,EIP</code>.<code>CS,EIP</code>,<code>ESP,SS</code>.JOS0,CPU<code>TSS</code><code>ESP0,SS0</code>,.</li>\n</ol>\n</blockquote>\n<h3 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"/\"></a>/</h3><p>X86CPU031.,14.31,int,.</p>\n<p>part1JOS,0~31.part2JOS48,.Lab4JOS,.</p>\n<p>:</p>\n<blockquote>\n<p>CPU,,0.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+--------------------+ KSTACKTOP             </span><br><span class=\"line\">| 0x00000 | old SS   |     &quot; - 4</span><br><span class=\"line\">|      old ESP       |     &quot; - 8</span><br><span class=\"line\">|     old EFLAGS     |     &quot; - 12</span><br><span class=\"line\">| 0x00000 | old CS   |     &quot; - 16</span><br><span class=\"line\">|      old EIP       |     &quot; - 20 &lt;---- ESP</span><br><span class=\"line\">+--------------------+</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p>,CPU:</p>\n<ol>\n<li>CPU,<code>TSS</code><code>SS0,ESP0</code>,<code>GD_KD</code><code>KSTACKTOP</code>.</li>\n<li>CPU,<code>KSTACKTOP</code></li>\n<li>,0,CPU<code>IDT</code>0,<code>CS:EIP</code>0.</li>\n<li>,.</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>,,,(error code).,.,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+--------------------+ KSTACKTOP             </span><br><span class=\"line\">| 0x00000 | old SS   |     &quot; - 4</span><br><span class=\"line\">|      old ESP       |     &quot; - 8</span><br><span class=\"line\">|     old EFLAGS     |     &quot; - 12</span><br><span class=\"line\">| 0x00000 | old CS   |     &quot; - 16</span><br><span class=\"line\">|      old EIP       |     &quot; - 20</span><br><span class=\"line\">|     error code     |     &quot; - 24 &lt;---- ESP</span><br><span class=\"line\">+--------------------+</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"/\"></a>/</h3><p>CPU.CPU,,,.CPU,CPU.,.<br>CPU,,<code>SS,ESP</code>.:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+--------------------+ &lt;---- old ESP</span><br><span class=\"line\">|     old EFLAGS     |     &quot; - 4</span><br><span class=\"line\">| 0x00000 | old CS   |     &quot; - 8</span><br><span class=\"line\">|      old EIP       |     &quot; - 12</span><br><span class=\"line\">+--------------------+</span><br></pre></td></tr></table></figure></p>\n<p>: CPU,,,,CPU,.</p>\n<h3 id=\"IDT\"><a href=\"#IDT\" class=\"headerlink\" title=\"IDT\"></a>IDT</h3><p>, IDT,JOS.Lab30~31.<code>inc/trap.hkern/trap.h</code>.<br><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IDT                   trapentry.S         trap.c</span><br><span class=\"line\"></span><br><span class=\"line\">+----------------+                        </span><br><span class=\"line\">|   &amp;handler1    |---------&gt; handler1:          trap (struct Trapframe *tf)</span><br><span class=\"line\">|                |             // do stuff      &#123;</span><br><span class=\"line\">|                |             call trap          // handle the exception/interrupt</span><br><span class=\"line\">|                |             // ...           &#125;</span><br><span class=\"line\">+----------------+</span><br><span class=\"line\">|   &amp;handler2    |--------&gt; handler2:</span><br><span class=\"line\">|                |            // do stuff</span><br><span class=\"line\">|                |            call trap</span><br><span class=\"line\">|                |            // ...</span><br><span class=\"line\">+----------------+</span><br><span class=\"line\"> .</span><br><span class=\"line\"> .</span><br><span class=\"line\"> .</span><br><span class=\"line\">+----------------+</span><br><span class=\"line\">|   &amp;handlerX    |--------&gt; handlerX:</span><br><span class=\"line\">|                |             // do stuff</span><br><span class=\"line\">|                |             call trap</span><br><span class=\"line\">|                |             // ...</span><br><span class=\"line\">+----------------+</span><br></pre></td></tr></table></figure></p>\n<p>/,<code>trapentry.S</code>.<code>trap_init()</code><code>IDT</code>. <code>Trapframe</code>,<code>trap()</code>,<code>trap()</code>/,.<br></p>\n<blockquote>\n<ol>\n<li><code>trap_init()</code><code>IDT</code>.</li>\n<li>,,CPU,,,</li>\n<li>,.</li>\n<li>.</li>\n<li>,,,.</li>\n</ol>\n</blockquote>\n<h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><p></p>\n<blockquote>\n<p><code>trapentry.S</code><code>trap.c</code>,.<code>trapentry.S</code><code>inc/trap.h</code><code>trap</code>, <code>trap_init()</code><code>IDT</code>,<code>trapentry.S</code>.<br><code>_alltraps</code>:</p>\n<ol>\n<li>,<code>Trapframe</code></li>\n<li><code>GD_KD</code><code>%ds, %es</code></li>\n<li><code>%esp</code>,<code>Trapframe</code><code>trap()`</code>.</li>\n<li><code>trap</code><br><br><code>trapentry.S</code>,<code>TRAPHANDLER</code>,<code>TRAPHANDLER_NOEC</code>.name,,./,,,(error code).,,.<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TRAPHANDLER(name, num)                        \\</span></span><br><span class=\"line\">        .globl name;            <span class=\"comment\">/* define global symbol for 'name' */</span>   \\</span><br><span class=\"line\">        .type name, @function;  <span class=\"comment\">/* symbol type is function */</span>           \\</span><br><span class=\"line\">        .align <span class=\"number\">2</span>;               <span class=\"comment\">/* align function definition */</span>         \\</span><br><span class=\"line\">        name:                   <span class=\"comment\">/* function starts here */</span>              \\</span><br><span class=\"line\">        pushl $(num);                                                   \\</span><br><span class=\"line\">        jmp _alltraps</span><br><span class=\"line\"><span class=\"comment\">/* Use TRAPHANDLER_NOEC for traps where the CPU doesn't push an error code.</span></span><br><span class=\"line\"><span class=\"comment\"> * It pushes a 0 in place of the error code, so the trap frame has the same</span></span><br><span class=\"line\"><span class=\"comment\"> * format in either case.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TRAPHANDLER_NOEC(name, num)                                     \\</span></span><br><span class=\"line\">        .globl name;                                                    \\</span><br><span class=\"line\">        .type name, @function;                                          \\</span><br><span class=\"line\">        .align <span class=\"number\">2</span>;                                                       \\</span><br><span class=\"line\">        name:                                                           \\</span><br><span class=\"line\">        pushl $<span class=\"number\">0</span>;                                                       \\</span><br><span class=\"line\">        pushl $(num);                                                   \\</span><br><span class=\"line\">        jmp _alltraps</span><br><span class=\"line\"></span><br><span class=\"line\">.text</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Lab 3: Your code here for generating entry points for the different traps.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">TRAPHANDLER_NOEC(divide_entry, T_DIVIDE);</span><br><span class=\"line\">TRAPHANDLER_NOEC(debug_entry, T_DEBUG);</span><br><span class=\"line\">TRAPHANDLER_NOEC(nmi_entry, T_NMI);</span><br><span class=\"line\">TRAPHANDLER_NOEC(brkpt_entry, T_BRKPT);</span><br><span class=\"line\">TRAPHANDLER_NOEC(oflow_entry, T_OFLOW);</span><br><span class=\"line\">TRAPHANDLER_NOEC(bound_entry, T_BOUND);</span><br><span class=\"line\">TRAPHANDLER_NOEC(illop_entry, T_ILLOP);</span><br><span class=\"line\">TRAPHANDLER_NOEC(device_entry, T_DEVICE);</span><br><span class=\"line\">TRAPHANDLER(dblflt_entry, T_DBLFLT);</span><br><span class=\"line\">TRAPHANDLER(tss_entry, T_TSS);</span><br><span class=\"line\">TRAPHANDLER(segnp_entry, T_SEGNP);</span><br><span class=\"line\">TRAPHANDLER(stack_entry, T_STACK);</span><br><span class=\"line\">TRAPHANDLER(gpflt_entry, T_GPFLT);</span><br><span class=\"line\">TRAPHANDLER(pgflt_entry, T_PGFLT);</span><br><span class=\"line\">TRAPHANDLER_NOEC(fperr_entry, T_FPERR);</span><br><span class=\"line\">TRAPHANDLER(align_entry, T_ALIGN);</span><br><span class=\"line\">TRAPHANDLER_NOEC(mchk_entry, T_MCHK);</span><br><span class=\"line\">TRAPHANDLER_NOEC(simderr_entry, T_SIMDERR);</span><br><span class=\"line\">TRAPHANDLER_NOEC(syscall_entry, T_SYSCALL);</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<p><code>_alltraps</code>,<code>trap.</code>c<code>trap</code>,,<code>Trapframe</code><code>tf</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_alltraps:</span><br><span class=\"line\">        pushl %ds</span><br><span class=\"line\">        pushl %es</span><br><span class=\"line\">        pushal</span><br><span class=\"line\"></span><br><span class=\"line\">        movl $GD_KD, %eax</span><br><span class=\"line\">        movl %eax, %ds</span><br><span class=\"line\">        movl %eax, %es</span><br><span class=\"line\"></span><br><span class=\"line\">        push %esp</span><br><span class=\"line\">        call trap</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>trap.c</code><code>trap_init</code>,<code>IDT</code>,<code>SETGATE</code>,<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//gate:IDTindex</span></span><br><span class=\"line\"><span class=\"comment\">//istrap:</span></span><br><span class=\"line\"><span class=\"comment\">//sel:</span></span><br><span class=\"line\"><span class=\"comment\">//off:</span></span><br><span class=\"line\"><span class=\"comment\">//dpl:.</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SETGATE(gate, istrap, sel, off, dpl)</span></span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>trap_init</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">trap_init(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">extern</span> <span class=\"keyword\">struct</span> Segdesc gdt[];</span><br><span class=\"line\"></span><br><span class=\"line\">        SETGATE(idt[T_DIVIDE], <span class=\"number\">0</span>, GD_KT, divide_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_DEBUG], <span class=\"number\">0</span>, GD_KT, debug_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_NMI], <span class=\"number\">0</span>, GD_KT, nmi_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_BRKPT], <span class=\"number\">0</span>, GD_KT, brkpt_entry, <span class=\"number\">3</span>);</span><br><span class=\"line\">        SETGATE(idt[T_OFLOW], <span class=\"number\">0</span>, GD_KT, oflow_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_BOUND], <span class=\"number\">0</span>, GD_KT, bound_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_ILLOP], <span class=\"number\">0</span>, GD_KT, illop_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_DEVICE], <span class=\"number\">0</span>, GD_KT, device_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_DBLFLT], <span class=\"number\">0</span>, GD_KT, dblflt_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_TSS], <span class=\"number\">0</span>, GD_KT, tss_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_SEGNP], <span class=\"number\">0</span>, GD_KT, segnp_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_STACK], <span class=\"number\">0</span>, GD_KT, stack_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_GPFLT], <span class=\"number\">0</span>, GD_KT, gpflt_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_PGFLT], <span class=\"number\">0</span>, GD_KT, pgflt_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_FPERR], <span class=\"number\">0</span>, GD_KT, fperr_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_ALIGN], <span class=\"number\">0</span>, GD_KT, align_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_MCHK], <span class=\"number\">0</span>, GD_KT, mchk_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_SIMDERR], <span class=\"number\">0</span>, GD_KT, simderr_entry, <span class=\"number\">0</span>);</span><br><span class=\"line\">        SETGATE(idt[T_SYSCALL], <span class=\"number\">0</span>, GD_KT, syscall_entry, <span class=\"number\">3</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        trap_init_percpu();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li><p>/?/,?<br>:<br>,/,,.IO,.</p>\n</li>\n<li><p>,13,<code>int $14</code>.13?<code>int $14</code>14,?<br><br>,3,<code>INT</code>,0.30,<code>General Protection Exception</code>,`trap 13</p>\n</li>\n</ol>"},{"title":"lab4-Preemptive Multitasking","date":"2017-05-03T16:00:00.000Z","_content":"# Lab4 \n## \nLab4\n* part1: JOS//\n* part2Unix`fork`\n* part3(IPC)\n\n## \n\n``` bash\ngit pull\ngit chekout -b lab4 origin/lab4\ngit merge Lab3\n```\nLab4 \n```\nkern/cpu.h\t\nkern/mpconfig.c\t\nkern/lapic.c\tAPIC\nkern/mpentry.S\tCPU\nkern/spinlock.h\t\nkern/spinlock.c\t\nkern/sched.c\t\n```\n\n<!-- more -->\n\n## part1 \nLab4 part1JOSJOSCPUpart3CPU\n\n### \nJOS(SMP)`SMP`CPUSMPCPU2(`BSP`)(`AP`)BIOSBSP\nSMPCPU1`Local APICLAPIC`LAPICCPUpart1LAPIC(`/kern/lapic.c`)\n* LAPIC(APIC ID)CPU(`cpunum()`).\n* BSPSTARTUP(`IPI`) APsCPU(`lapic_startup()`).\n* part3LAPIC(`apic_init()`).\n\nI/O(MMIO)LAPICMMIOIO`load/store`1`IO hole``0xA0000`(VGA)LAPIChole`0xFE000000`(4GB32MB)(`0xF0000000`0x0256MB)JOS4MB`MMIOBASE`\n\n#### 1\n\n> `kern/pmap.c``mmio_map_region``lapic_init`(`kern/lapic.c`)\n\n\n> `lapic_init``mmio_map_region`\n``` c\n// lapicaddr is the physical address of the LAPIC's 4K MMIO\n// region.  Map it in to virtual memory so we can access it.\nlapic = mmio_map_region(lapicaddr, 4096);\n```\n> `kern/pmap.c``boot_map_region``[pa,pa+size)``[base,base+size)``size``PGSIZE`DRAMcache\n``` c\n//kern/pmap.c\nvoid *\nmmio_map_region(physaddr_t pa, size_t size)\n{\n    static uintptr_t base = MMIOBASE;\n    void *ret = (void *)base;\n\n    size = ROUNDUP(size, PGSIZE);\n    if (base + size > MMIOLIM || base + size < base)\n                panic(\"mmio_map_region: reservation overflow\\n\");\n\n    boot_map_region(kern_pgdir, base, size, pa, PTE_P | PTE_PCD | PTE_PWT);\n    base += size;\n\n    return ret;\n}\n```\n\n### (Application Processor)\nAPBSPCPUCPUsAPIC IDLAPICMMIO`kern/mpconfig``mp_init()`BIOS`MP`\n`boot_aps(kern/init.c)`APAPBSP`boot_aps`AP(`kern/mpentry.S`)BSPAP`0x7000(MPENTRY_PADDR)`\n`boot_aps``STARTUPIPI`()APLAPICAP`kern/mpentry.S``boot/boot.S`APCsetup`mp_main``kern/init.c`)`boot_aps()`AP `CPU_STARTED``cpu_status`flag`struct CpuInfo`\n\nlabi386 `init`BSPlab2`mem_init`lab3`env_init``trap_init`lab4`mp_init``lapic_init``boot_aps`CPU\n``` c\n// lab2 memory management initialization functions\nmem_init();\n\n// lab3 user environment initialization functions\nenv_init();\ntrap_init();\n\n// lab4 multiprocessor initialization functions\nmp_init();\nlapic_init();\n\n// lab4 multitasking initialization functions\npic_init();\n\n// Acquire the bit kernel lock before waiting AP\nlock_kernel();\n\n// starting non-boot APs\nboot_aps();\n```\nmp_initmpconfigMP CPU\n``` c\nvoid\nmp_init(void)\n{\n    struct mp *mp;\n    struct mpconf *conf;\n    struct mpproc *proc;\n    uint8_t *p;\n    unsigned int i;\n\n    bootcpu = &cpus[0];\n    if ((conf = mpconfig(&mp)) == 0)\n        return;\n    ismp = 1;\n    lapicaddr = conf->lapicaddr;\n\n    for (p = conf->entries, i = 0; i < conf->entry; i++) {\n        switch (*p) {\n\t\t    case MPPROC:\n        proc = (struct mpproc *)p;\n\t\t\t  if (proc->flags & MPPROC_BOOT)\n\t\t\t\t    bootcpu = &cpus[ncpu];\n\t\t\t  if (ncpu < NCPU) {\n\t\t\t\t    cpus[ncpu].cpu_id = ncpu;\n\t\t\t\t    ncpu++;\n\t\t\t  } else {\n            cprintf(\"SMP: too many CPUs, CPU %d disabled\\n\",\n            proc->apicid);\n\t\t\t  }\n        p += sizeof(struct mpproc);\n        continue;\n        case MPBUS:\n        case MPIOAPIC:\n        case MPIOINTR:\n        case MPLINTR:\n        p += 8;\n        continue;\n        default:\n            cprintf(\"mpinit: unknown config type %x\\n\", *p);\n        ismp = 0;\n        i = conf->entry;\n\t      }\n\t }\n```\n`mp_init``lapic_init``mem_init`CPUCPU\n`boot_aps`lab3`mpentry_start``mpentry_end``MPENTRY_PADDR``lapic_startap`AP\n``` c\n// Start the non-boot (AP) processors.\nstatic void\nboot_aps(void)\n{\n    extern unsigned char mpentry_start[], mpentry_end[];\n  \tvoid *code;\n  \tstruct CpuInfo *c;\n\n  \t// Write entry code to unused memory at MPENTRY_PADDR\n  \tcode = KADDR(MPENTRY_PADDR);\n  \tmemmove(code, mpentry_start, mpentry_end - mpentry_start);\n\n  \t// Boot each AP one at a time\n  \tfor (c = cpus; c < cpus + ncpu; c++) {\n  \t\tif (c == cpus + cpunum())  // We've started already.\n  \t\t\tcontinue;\n\n  \t\t// Tell mpentry.S what stack to use\n  \t\tmpentry_kstack = percpu_kstacks[c - cpus] + KSTKSIZE;\n  \t\t// Start the CPU at mpentry_start\n  \t\tlapic_startap(c->cpu_id, PADDR(code));\n  \t\t// Wait for the CPU to finish some basic setup in mp_main()\n  \t\twhile(c->cpu_status != CPU_STARTED)\n  \t\t\t;\n  \t}\n}\n```\n\n#### 2\n\n> `page_init`(`kern/page.c`)`MPENTRY_PADDR`,AP\n\n\n> `boot_aps``MPENTRY_PADDR``kern/mpentry.S``boot.S``mpentry.S``mp_main``MPENTRY_PADDR``page_init`\n``` c\n//kern/pmap.c\nvoid page_init(void)\n{\n    ......\n    for (i = 0; i < npages; i++) {\n        ......\n        else if (i == MPENTRY_PADDR / PGSIEZ)\n            continue;\n        ......\n    }\n}\n```\n\n### 1\n\n> `kern/mpentry.S``boot/boot.S``kern/mpentry.S``KERNBASE``MPBOOTPHYS``kern/mpentry.Sboot/boot.Skern/mpentry.S\n\n\n>\n```\n#define MPBOOTPHYS(s) ((s) - mpentry_start + MPENTRY_PADDR))))\n// MPBOOTPHYS is to calculate symobl address relative to MPENTRY_PADDR. The ASM is executed in the load address above KERNBASE, but JOS need to run mp_main at 0x7000 address! Of course 0x7000s page is reserved at pmap.c.\n```\n> AP3G`MPBOOTPHYS``boot.S``mpentry.S`CPU\n\n### CPU\nCPU `kern / cpu.h`CPU`struct CpuInfo`CPU `cpunum()`CPUID`cpus`\nCPU\n* \nCPU`percpu_kstacks[NCPU][KSTKSIZE]``NCPU`\n* TSSTSS\nCPUTSSCPUCPU i`TSS cpus[i].cpu_ts`GDTTSS`gdt[(GD_TSS0 >> 3) + i]``ts``kern / trap.c`\n* CPU\nCPU`curenv``cpus[cpunum()].cpu_env``thiscpu->cpu_env`CPUCPU\n* CPU\nCPU`lcr3() ltr()lgdt()lidt()`CPU`env_init_percpu()``trap_init_percpu()`\n\n#### 3\n\n> `mem_init_mp``KSTACKTOP`CPU\n\n\n> CPU\n```\nKERNBASE ----> +-------------------------+ 0xf0000000\nKSTACKTOP      |   CPU0's Kernel Stack   | RW/-- KSTKSIZE\n               |-------------------------|\n               |   Invalid Memory(*)     | --/-- KSTKGAP\n               +-------------------------+\n               |    CPU1's Kernel STACK  | RW/-- KSTKSIZE\n               |-------------------------|\n               |   Invalid Memory(*)     | --/-- KSTKGAP\n               +-------------------------+\n               .             .           .\n               .             .           .\n\n```\n`KSTKSIZE``KSTKGAP`\n``` c\n//kern/pmap.c\nstatic void\nmem_init_mp(void)\n{\n    int i;\n    uintptr_t kstacktop_i;\n\n    for (i = 0; i < NCPU; i++) {\n        kstacktop_i = KSTACKTOP - i * (KSTKGAP + KSTKSIZE);\n        boot_map_region(kern_pgdir,\n                        kstacktop_i - KSTKSIZE,\n                        ROUNDUP(KSTKSIZE, PGSIZE),\n                        PADDR(&percpu_kstacks[i]),\n                        PTE_W | PTE_P);\n        }\n}\n```\n\n#### 4\n\n> `trap_init_percpu`BSPTSSTSSLab3CPU\n\n\n> CPU`ts``thiscpu``CpuInfo``cpunum``TSS`\n``` c\nvoid\ntrap_init_percpu(void)\n{\n    thiscpu->cpu_ts.ts_esp0 = KSTACKTOP - cpunum() * (KSTKGAP + KSTKSIZE);\n    thiscpu->cpu_ts.ts_ss0 = GD_KD;\n\n    // Initialize the TSS slot of the gdt.\n    gdt[(GD_TSS0 >> 3) + cpunum()] = SEG16(STS_T32A, (uint32_t) (&thiscpu->cpu_ts), sizeof(struct Taskstate) - 1, 0);\n    gdt[(GD_TSS0 >> 3) + cpunum()].sd_s = 0;\n\n    // Load the TSS selector (like other segment selectors, the\n    // bottom three bits are special; we leave them 0)\n    ltr(GD_TSS0 + sizeof(struct Segdesc) * cpunum());\n\n    // Load the IDT\n    lidt(&idt_pd);\n}\n```\n\n### \n`mp_main`APAPCPU1big kernel lock)1CPU\n`kern/spinlock.h``lock_kernel``unlock_kernel`\n* BSPCPUBSP\n* `mp_main`CPU\n* `trap``CPUCPU\n* `env_run`lab3\n\n\n> i386_init>BSP>boot_ap>(BSPcpuidlemp_main)>BSPsched_yield>env_run>AP1>sched_yield>>AP2>sched_yield>..\n\n#### 5\n\n> \n\n\n``` c\n//i386_init\nlock_kernel();\nboot_aps();\n\n//mp_main\nlock_kernel();\nsched_yield();\n\n//trap\nif ((tf->tf_cs & 3) == 3) {\n    lock_kernel();\n    assert(curenv);\n    ......\n}\n\n//env_run\nlcr3(PADDR(curenv->env_pgdir));\nunlock_kernel();\nenv_pop_tf(&(curenv->env_tf));\n```\n\n### 2\n\n> 1CPUCPU1\n\n:\n> 1CPU\n\n### 1\n:\n> JOS\n\n\n> :JOS\n\n### (Round-Robin Scheduling)\nJOS`round-robin`\n`sched_yield`CPUCPU\n\n#### 6\n:\n> `sched_yield`\n\n:\n> .`kern/syscall.c`,\n```\nvoid\nsched_yield(void)\n{\n        uint32_t i, j, start;\n        struct Env *runenv;\n\n        idle = thiscpu->cpu_env;\n        start = (idle != NULL) ? ENVX(idle->env_id) : 0;\n        runenv = NULL;\n\n        for (i = 0; i < NENV; i++) {\n                j = (start + i) % NENV;\n                if (envs[j].env_status == ENV_RUNNABLE) {\n                        if (runenv == NULL || envs[j].env_priority < runenv->env_priority)\n                                runenv = &envs[j];\n                }\n        }\n        if ((idle && idle->env_status == ENV_RUNNING) && (runenv == NULL || idle->env_priority < runenv->env_priority)){\n                env_run(idle);\n                return;\n        }\n        if (runenv) {\n                env_run(runenv);\n                return;\n        }\n        // sched_halt never returns\n        sched_halt();\n}\n```\n\n#### 3\n:\n> `lcr3()`CPUe`curenv`\n\n:\n> `UTOP``UVPT``curenv`\n\n#### 4\n:\n> \n\n:\n> `trapframe`\n\n#### 2\n:\n> \n\n\n> :1`sched_yield`\n> 1. `inc/env.h``Env`1`int env_priority`\n> 2. `kern/env.c``env_alloc``ENV_PRIOR_DEFAULT`\n``` c\n//inc/env.h\n#define ENV_PRIOR_SUPER 0\n#define ENV_PRIOR_HIGH 10\n#define ENV_PRIOR_NORMAL 100\n#define ENV_PRIOR_LOW 1000\n```\n> 3. `kern/sched.c``sched_yield`\n``` c\n//kern/sched.c  sched_yield()\n        idle = thiscpu->cpu_env;\n        start = (idle != NULL) ? ENVX(idle->env_id) : 0;\n        runenv = NULL;\n\n        for (i = 0; i < NENV; i++) {\n                j = (start + i) % NENV;\n                if (envs[j].env_status == ENV_RUNNABLE) {\n                        if (runenv == NULL || envs[j].env_priority < runenv->env_priority)\n                                runenv = &envs[j];\n                }\n        }\n        if ((idle && idle->env_status == ENV_RUNNING) && (runenv == NULL || idle->env_priority < runenv->env_priority)){\n                env_run(idle);\n                return;\n        }\n        if (runenv) {\n                env_run(runenv);\n                return;\n        }\n```\n> 4. 1`sys_env_set_priority(envid, priority)`\n``` c\nstatic int\nsys_env_set_priority(envid_t envid, int priority)\n{\n        int ret;\n        struct Env *env;\n\n        if ((ret = envid2env(envid, &env, 1)) < 0)\n                return ret;\n        env->env_priority = priority;\n        return 0;\n}\n```\n\n#### 3\n:\n> JOSx86(FPU)MMXSSEEnv \n\n:\n> \n> 1. `inc/trap.h``Trapframe``char tf_fpus[512]```uint32_t tf_padding0[3]``\n> 2. `kern/trapentry.S``_alltraps``fpu`\n```c\n_alltraps:\n        pushl %ds\n        pushl %es\n        pushal\n\n        // save FPU\n        subl $524, %esp\n        fxsave (%esp)\n\n        movl $GD_KD, %eax\n        movl %eax, %ds\n        movl %eax, %es\n\n        push %esp\n        call trap\n```\n> 3. `kern/env.c``env_pop_tf``fpu`\n``` c\n __asm __volatile(\"movl %0,%%esp\\n\"\n                \"\\tfxrstor (%%esp)\\n\"\n                \"\\taddl $524,%%esp\\n\"\n                \"\\tpopal\\n\"\n                \"\\tpopl %%es\\n\"\n                \"\\tpopl %%ds\\n\"\n                \"\\taddl $0x8,%%esp\\n\" /* skip tf_trapno and tf_errcode */\n                \"\\tiret\"\n                : : \"g\" (tf) : \"memory\");\n```\n\n### \nJOS\nUnix`fork`IDforkIDfork0\nUnix,1JOSUnixfork\nfork`user/dumbfork.c``dumbfork()`\n\n### 7\n:\n> `ker/syscall.c`\n\n:\n> `sys_exofork`1ID0eax00\n``` c\nstatic envid_t\nsys_exofork(void)\n{\n        int ret;\n        struct Env *env;\n\n        if ((ret = env_alloc(&env, sys_getenvid())) < 0)\n                return ret;\n        env->env_status = ENV_NOT_RUNNABLE;\n        env->env_tf = curenv->env_tf;\n        env->env_tf.tf_regs.reg_eax = 0;\n        return env->env_id;\n}\n```\n`sys_env_set_status``ENV_RUNNABLE``ENV_NOT_RUNNABLE`\n``` c\nstatic int\nsys_env_set_status(envid_t envid, int status)\n{\nimplemented\");\n        int ret;\n        struct Env *env;\n\n        if (status != ENV_RUNNABLE && status != ENV_RUNNING)\n                return -E_INVAL;\n        if ((ret = envid2env(envid, &env, 1)) < 0)\n                return ret;\n        env->env_status = status;\n        return 0;\n}\n```\n`env_page_alloc`1\n``` c\nstatic int\nsys_page_alloc(envid_t envid, void *va, int perm)\n{\n        struct Env *env;\n        struct PageInfo *pp;\n\n        if (envid2env(envid, &env, 1) < 0)\n                return -E_BAD_ENV;\n        if ((uintptr_t)va >= UTOP || PGOFF(va))\n                return -E_INVAL;\n        if ((perm & PTE_U) == 0 || (perm & PTE_P) == 0)\n                return -E_INVAL;\n        if ((perm & ~(PTE_U | PTE_P | PTE_W | PTE_AVAIL)) != 0)\n                return -E_INVAL;\n        if ((pp = page_alloc(ALLOC_ZERO)) == NULL)\n                return -E_NO_MEM;\n        if (page_insert(env->env_pgdir, pp, va, perm) < 0) {\n                page_free(pp);\n                return -E_NO_MEM;\n        }\n        return 0;\n}\n```\ns`ys_page_unmap`1\n```\nstatic int\nsys_page_unmap(envid_t envid, void *va)\n{\n        struct Env *env;\n\n        if (envid2env(envid, &env, 1) < 0)\n                return -E_BAD_ENV;\n        if ((uintptr_t)va >= UTOP || PGOFF(va))\n                return -E_INVAL;\n\n        page_remove(env->env_pgdir, va);\n        return 0;\n}\n```\n`usr/umbfork.c`111020\n``` c\nvoid\numain(int argc, char **argv)\n{\n        envid_t who;\n        int i;\n\n        // fork a child process\n        who = dumbfork();\n\n        // print a message and yield to the other a few times\n        for (i = 0; i < (who ? 10 : 20); i++) {\n                cprintf(\"%d: I am the %s!\\n\", i, who ? \"parent\" : \"child\");\n                sys_yield();\n        }\n}\n```\n","source":"_posts/lab4.md","raw":"title: lab4-Preemptive Multitasking\ndate: 2017/05/04\ntags:\n- xv6\n- os\n\n---\n# Lab4 \n## \nLab4\n* part1: JOS//\n* part2Unix`fork`\n* part3(IPC)\n\n## \n\n``` bash\ngit pull\ngit chekout -b lab4 origin/lab4\ngit merge Lab3\n```\nLab4 \n```\nkern/cpu.h\t\nkern/mpconfig.c\t\nkern/lapic.c\tAPIC\nkern/mpentry.S\tCPU\nkern/spinlock.h\t\nkern/spinlock.c\t\nkern/sched.c\t\n```\n\n<!-- more -->\n\n## part1 \nLab4 part1JOSJOSCPUpart3CPU\n\n### \nJOS(SMP)`SMP`CPUSMPCPU2(`BSP`)(`AP`)BIOSBSP\nSMPCPU1`Local APICLAPIC`LAPICCPUpart1LAPIC(`/kern/lapic.c`)\n* LAPIC(APIC ID)CPU(`cpunum()`).\n* BSPSTARTUP(`IPI`) APsCPU(`lapic_startup()`).\n* part3LAPIC(`apic_init()`).\n\nI/O(MMIO)LAPICMMIOIO`load/store`1`IO hole``0xA0000`(VGA)LAPIChole`0xFE000000`(4GB32MB)(`0xF0000000`0x0256MB)JOS4MB`MMIOBASE`\n\n#### 1\n\n> `kern/pmap.c``mmio_map_region``lapic_init`(`kern/lapic.c`)\n\n\n> `lapic_init``mmio_map_region`\n``` c\n// lapicaddr is the physical address of the LAPIC's 4K MMIO\n// region.  Map it in to virtual memory so we can access it.\nlapic = mmio_map_region(lapicaddr, 4096);\n```\n> `kern/pmap.c``boot_map_region``[pa,pa+size)``[base,base+size)``size``PGSIZE`DRAMcache\n``` c\n//kern/pmap.c\nvoid *\nmmio_map_region(physaddr_t pa, size_t size)\n{\n    static uintptr_t base = MMIOBASE;\n    void *ret = (void *)base;\n\n    size = ROUNDUP(size, PGSIZE);\n    if (base + size > MMIOLIM || base + size < base)\n                panic(\"mmio_map_region: reservation overflow\\n\");\n\n    boot_map_region(kern_pgdir, base, size, pa, PTE_P | PTE_PCD | PTE_PWT);\n    base += size;\n\n    return ret;\n}\n```\n\n### (Application Processor)\nAPBSPCPUCPUsAPIC IDLAPICMMIO`kern/mpconfig``mp_init()`BIOS`MP`\n`boot_aps(kern/init.c)`APAPBSP`boot_aps`AP(`kern/mpentry.S`)BSPAP`0x7000(MPENTRY_PADDR)`\n`boot_aps``STARTUPIPI`()APLAPICAP`kern/mpentry.S``boot/boot.S`APCsetup`mp_main``kern/init.c`)`boot_aps()`AP `CPU_STARTED``cpu_status`flag`struct CpuInfo`\n\nlabi386 `init`BSPlab2`mem_init`lab3`env_init``trap_init`lab4`mp_init``lapic_init``boot_aps`CPU\n``` c\n// lab2 memory management initialization functions\nmem_init();\n\n// lab3 user environment initialization functions\nenv_init();\ntrap_init();\n\n// lab4 multiprocessor initialization functions\nmp_init();\nlapic_init();\n\n// lab4 multitasking initialization functions\npic_init();\n\n// Acquire the bit kernel lock before waiting AP\nlock_kernel();\n\n// starting non-boot APs\nboot_aps();\n```\nmp_initmpconfigMP CPU\n``` c\nvoid\nmp_init(void)\n{\n    struct mp *mp;\n    struct mpconf *conf;\n    struct mpproc *proc;\n    uint8_t *p;\n    unsigned int i;\n\n    bootcpu = &cpus[0];\n    if ((conf = mpconfig(&mp)) == 0)\n        return;\n    ismp = 1;\n    lapicaddr = conf->lapicaddr;\n\n    for (p = conf->entries, i = 0; i < conf->entry; i++) {\n        switch (*p) {\n\t\t    case MPPROC:\n        proc = (struct mpproc *)p;\n\t\t\t  if (proc->flags & MPPROC_BOOT)\n\t\t\t\t    bootcpu = &cpus[ncpu];\n\t\t\t  if (ncpu < NCPU) {\n\t\t\t\t    cpus[ncpu].cpu_id = ncpu;\n\t\t\t\t    ncpu++;\n\t\t\t  } else {\n            cprintf(\"SMP: too many CPUs, CPU %d disabled\\n\",\n            proc->apicid);\n\t\t\t  }\n        p += sizeof(struct mpproc);\n        continue;\n        case MPBUS:\n        case MPIOAPIC:\n        case MPIOINTR:\n        case MPLINTR:\n        p += 8;\n        continue;\n        default:\n            cprintf(\"mpinit: unknown config type %x\\n\", *p);\n        ismp = 0;\n        i = conf->entry;\n\t      }\n\t }\n```\n`mp_init``lapic_init``mem_init`CPUCPU\n`boot_aps`lab3`mpentry_start``mpentry_end``MPENTRY_PADDR``lapic_startap`AP\n``` c\n// Start the non-boot (AP) processors.\nstatic void\nboot_aps(void)\n{\n    extern unsigned char mpentry_start[], mpentry_end[];\n  \tvoid *code;\n  \tstruct CpuInfo *c;\n\n  \t// Write entry code to unused memory at MPENTRY_PADDR\n  \tcode = KADDR(MPENTRY_PADDR);\n  \tmemmove(code, mpentry_start, mpentry_end - mpentry_start);\n\n  \t// Boot each AP one at a time\n  \tfor (c = cpus; c < cpus + ncpu; c++) {\n  \t\tif (c == cpus + cpunum())  // We've started already.\n  \t\t\tcontinue;\n\n  \t\t// Tell mpentry.S what stack to use\n  \t\tmpentry_kstack = percpu_kstacks[c - cpus] + KSTKSIZE;\n  \t\t// Start the CPU at mpentry_start\n  \t\tlapic_startap(c->cpu_id, PADDR(code));\n  \t\t// Wait for the CPU to finish some basic setup in mp_main()\n  \t\twhile(c->cpu_status != CPU_STARTED)\n  \t\t\t;\n  \t}\n}\n```\n\n#### 2\n\n> `page_init`(`kern/page.c`)`MPENTRY_PADDR`,AP\n\n\n> `boot_aps``MPENTRY_PADDR``kern/mpentry.S``boot.S``mpentry.S``mp_main``MPENTRY_PADDR``page_init`\n``` c\n//kern/pmap.c\nvoid page_init(void)\n{\n    ......\n    for (i = 0; i < npages; i++) {\n        ......\n        else if (i == MPENTRY_PADDR / PGSIEZ)\n            continue;\n        ......\n    }\n}\n```\n\n### 1\n\n> `kern/mpentry.S``boot/boot.S``kern/mpentry.S``KERNBASE``MPBOOTPHYS``kern/mpentry.Sboot/boot.Skern/mpentry.S\n\n\n>\n```\n#define MPBOOTPHYS(s) ((s) - mpentry_start + MPENTRY_PADDR))))\n// MPBOOTPHYS is to calculate symobl address relative to MPENTRY_PADDR. The ASM is executed in the load address above KERNBASE, but JOS need to run mp_main at 0x7000 address! Of course 0x7000s page is reserved at pmap.c.\n```\n> AP3G`MPBOOTPHYS``boot.S``mpentry.S`CPU\n\n### CPU\nCPU `kern / cpu.h`CPU`struct CpuInfo`CPU `cpunum()`CPUID`cpus`\nCPU\n* \nCPU`percpu_kstacks[NCPU][KSTKSIZE]``NCPU`\n* TSSTSS\nCPUTSSCPUCPU i`TSS cpus[i].cpu_ts`GDTTSS`gdt[(GD_TSS0 >> 3) + i]``ts``kern / trap.c`\n* CPU\nCPU`curenv``cpus[cpunum()].cpu_env``thiscpu->cpu_env`CPUCPU\n* CPU\nCPU`lcr3() ltr()lgdt()lidt()`CPU`env_init_percpu()``trap_init_percpu()`\n\n#### 3\n\n> `mem_init_mp``KSTACKTOP`CPU\n\n\n> CPU\n```\nKERNBASE ----> +-------------------------+ 0xf0000000\nKSTACKTOP      |   CPU0's Kernel Stack   | RW/-- KSTKSIZE\n               |-------------------------|\n               |   Invalid Memory(*)     | --/-- KSTKGAP\n               +-------------------------+\n               |    CPU1's Kernel STACK  | RW/-- KSTKSIZE\n               |-------------------------|\n               |   Invalid Memory(*)     | --/-- KSTKGAP\n               +-------------------------+\n               .             .           .\n               .             .           .\n\n```\n`KSTKSIZE``KSTKGAP`\n``` c\n//kern/pmap.c\nstatic void\nmem_init_mp(void)\n{\n    int i;\n    uintptr_t kstacktop_i;\n\n    for (i = 0; i < NCPU; i++) {\n        kstacktop_i = KSTACKTOP - i * (KSTKGAP + KSTKSIZE);\n        boot_map_region(kern_pgdir,\n                        kstacktop_i - KSTKSIZE,\n                        ROUNDUP(KSTKSIZE, PGSIZE),\n                        PADDR(&percpu_kstacks[i]),\n                        PTE_W | PTE_P);\n        }\n}\n```\n\n#### 4\n\n> `trap_init_percpu`BSPTSSTSSLab3CPU\n\n\n> CPU`ts``thiscpu``CpuInfo``cpunum``TSS`\n``` c\nvoid\ntrap_init_percpu(void)\n{\n    thiscpu->cpu_ts.ts_esp0 = KSTACKTOP - cpunum() * (KSTKGAP + KSTKSIZE);\n    thiscpu->cpu_ts.ts_ss0 = GD_KD;\n\n    // Initialize the TSS slot of the gdt.\n    gdt[(GD_TSS0 >> 3) + cpunum()] = SEG16(STS_T32A, (uint32_t) (&thiscpu->cpu_ts), sizeof(struct Taskstate) - 1, 0);\n    gdt[(GD_TSS0 >> 3) + cpunum()].sd_s = 0;\n\n    // Load the TSS selector (like other segment selectors, the\n    // bottom three bits are special; we leave them 0)\n    ltr(GD_TSS0 + sizeof(struct Segdesc) * cpunum());\n\n    // Load the IDT\n    lidt(&idt_pd);\n}\n```\n\n### \n`mp_main`APAPCPU1big kernel lock)1CPU\n`kern/spinlock.h``lock_kernel``unlock_kernel`\n* BSPCPUBSP\n* `mp_main`CPU\n* `trap``CPUCPU\n* `env_run`lab3\n\n\n> i386_init>BSP>boot_ap>(BSPcpuidlemp_main)>BSPsched_yield>env_run>AP1>sched_yield>>AP2>sched_yield>..\n\n#### 5\n\n> \n\n\n``` c\n//i386_init\nlock_kernel();\nboot_aps();\n\n//mp_main\nlock_kernel();\nsched_yield();\n\n//trap\nif ((tf->tf_cs & 3) == 3) {\n    lock_kernel();\n    assert(curenv);\n    ......\n}\n\n//env_run\nlcr3(PADDR(curenv->env_pgdir));\nunlock_kernel();\nenv_pop_tf(&(curenv->env_tf));\n```\n\n### 2\n\n> 1CPUCPU1\n\n:\n> 1CPU\n\n### 1\n:\n> JOS\n\n\n> :JOS\n\n### (Round-Robin Scheduling)\nJOS`round-robin`\n`sched_yield`CPUCPU\n\n#### 6\n:\n> `sched_yield`\n\n:\n> .`kern/syscall.c`,\n```\nvoid\nsched_yield(void)\n{\n        uint32_t i, j, start;\n        struct Env *runenv;\n\n        idle = thiscpu->cpu_env;\n        start = (idle != NULL) ? ENVX(idle->env_id) : 0;\n        runenv = NULL;\n\n        for (i = 0; i < NENV; i++) {\n                j = (start + i) % NENV;\n                if (envs[j].env_status == ENV_RUNNABLE) {\n                        if (runenv == NULL || envs[j].env_priority < runenv->env_priority)\n                                runenv = &envs[j];\n                }\n        }\n        if ((idle && idle->env_status == ENV_RUNNING) && (runenv == NULL || idle->env_priority < runenv->env_priority)){\n                env_run(idle);\n                return;\n        }\n        if (runenv) {\n                env_run(runenv);\n                return;\n        }\n        // sched_halt never returns\n        sched_halt();\n}\n```\n\n#### 3\n:\n> `lcr3()`CPUe`curenv`\n\n:\n> `UTOP``UVPT``curenv`\n\n#### 4\n:\n> \n\n:\n> `trapframe`\n\n#### 2\n:\n> \n\n\n> :1`sched_yield`\n> 1. `inc/env.h``Env`1`int env_priority`\n> 2. `kern/env.c``env_alloc``ENV_PRIOR_DEFAULT`\n``` c\n//inc/env.h\n#define ENV_PRIOR_SUPER 0\n#define ENV_PRIOR_HIGH 10\n#define ENV_PRIOR_NORMAL 100\n#define ENV_PRIOR_LOW 1000\n```\n> 3. `kern/sched.c``sched_yield`\n``` c\n//kern/sched.c  sched_yield()\n        idle = thiscpu->cpu_env;\n        start = (idle != NULL) ? ENVX(idle->env_id) : 0;\n        runenv = NULL;\n\n        for (i = 0; i < NENV; i++) {\n                j = (start + i) % NENV;\n                if (envs[j].env_status == ENV_RUNNABLE) {\n                        if (runenv == NULL || envs[j].env_priority < runenv->env_priority)\n                                runenv = &envs[j];\n                }\n        }\n        if ((idle && idle->env_status == ENV_RUNNING) && (runenv == NULL || idle->env_priority < runenv->env_priority)){\n                env_run(idle);\n                return;\n        }\n        if (runenv) {\n                env_run(runenv);\n                return;\n        }\n```\n> 4. 1`sys_env_set_priority(envid, priority)`\n``` c\nstatic int\nsys_env_set_priority(envid_t envid, int priority)\n{\n        int ret;\n        struct Env *env;\n\n        if ((ret = envid2env(envid, &env, 1)) < 0)\n                return ret;\n        env->env_priority = priority;\n        return 0;\n}\n```\n\n#### 3\n:\n> JOSx86(FPU)MMXSSEEnv \n\n:\n> \n> 1. `inc/trap.h``Trapframe``char tf_fpus[512]```uint32_t tf_padding0[3]``\n> 2. `kern/trapentry.S``_alltraps``fpu`\n```c\n_alltraps:\n        pushl %ds\n        pushl %es\n        pushal\n\n        // save FPU\n        subl $524, %esp\n        fxsave (%esp)\n\n        movl $GD_KD, %eax\n        movl %eax, %ds\n        movl %eax, %es\n\n        push %esp\n        call trap\n```\n> 3. `kern/env.c``env_pop_tf``fpu`\n``` c\n __asm __volatile(\"movl %0,%%esp\\n\"\n                \"\\tfxrstor (%%esp)\\n\"\n                \"\\taddl $524,%%esp\\n\"\n                \"\\tpopal\\n\"\n                \"\\tpopl %%es\\n\"\n                \"\\tpopl %%ds\\n\"\n                \"\\taddl $0x8,%%esp\\n\" /* skip tf_trapno and tf_errcode */\n                \"\\tiret\"\n                : : \"g\" (tf) : \"memory\");\n```\n\n### \nJOS\nUnix`fork`IDforkIDfork0\nUnix,1JOSUnixfork\nfork`user/dumbfork.c``dumbfork()`\n\n### 7\n:\n> `ker/syscall.c`\n\n:\n> `sys_exofork`1ID0eax00\n``` c\nstatic envid_t\nsys_exofork(void)\n{\n        int ret;\n        struct Env *env;\n\n        if ((ret = env_alloc(&env, sys_getenvid())) < 0)\n                return ret;\n        env->env_status = ENV_NOT_RUNNABLE;\n        env->env_tf = curenv->env_tf;\n        env->env_tf.tf_regs.reg_eax = 0;\n        return env->env_id;\n}\n```\n`sys_env_set_status``ENV_RUNNABLE``ENV_NOT_RUNNABLE`\n``` c\nstatic int\nsys_env_set_status(envid_t envid, int status)\n{\nimplemented\");\n        int ret;\n        struct Env *env;\n\n        if (status != ENV_RUNNABLE && status != ENV_RUNNING)\n                return -E_INVAL;\n        if ((ret = envid2env(envid, &env, 1)) < 0)\n                return ret;\n        env->env_status = status;\n        return 0;\n}\n```\n`env_page_alloc`1\n``` c\nstatic int\nsys_page_alloc(envid_t envid, void *va, int perm)\n{\n        struct Env *env;\n        struct PageInfo *pp;\n\n        if (envid2env(envid, &env, 1) < 0)\n                return -E_BAD_ENV;\n        if ((uintptr_t)va >= UTOP || PGOFF(va))\n                return -E_INVAL;\n        if ((perm & PTE_U) == 0 || (perm & PTE_P) == 0)\n                return -E_INVAL;\n        if ((perm & ~(PTE_U | PTE_P | PTE_W | PTE_AVAIL)) != 0)\n                return -E_INVAL;\n        if ((pp = page_alloc(ALLOC_ZERO)) == NULL)\n                return -E_NO_MEM;\n        if (page_insert(env->env_pgdir, pp, va, perm) < 0) {\n                page_free(pp);\n                return -E_NO_MEM;\n        }\n        return 0;\n}\n```\ns`ys_page_unmap`1\n```\nstatic int\nsys_page_unmap(envid_t envid, void *va)\n{\n        struct Env *env;\n\n        if (envid2env(envid, &env, 1) < 0)\n                return -E_BAD_ENV;\n        if ((uintptr_t)va >= UTOP || PGOFF(va))\n                return -E_INVAL;\n\n        page_remove(env->env_pgdir, va);\n        return 0;\n}\n```\n`usr/umbfork.c`111020\n``` c\nvoid\numain(int argc, char **argv)\n{\n        envid_t who;\n        int i;\n\n        // fork a child process\n        who = dumbfork();\n\n        // print a message and yield to the other a few times\n        for (i = 0; i < (who ? 10 : 20); i++) {\n                cprintf(\"%d: I am the %s!\\n\", i, who ? \"parent\" : \"child\");\n                sys_yield();\n        }\n}\n```\n","slug":"lab4","published":1,"updated":"2017-08-26T03:38:21.602Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3hc0018s7amhxbbmqn5","content":"<h1 id=\"Lab4-\"><a href=\"#Lab4-\" class=\"headerlink\" title=\"Lab4 \"></a>Lab4 </h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Lab4</p>\n<ul>\n<li>part1: JOS//</li>\n<li>part2Unix<code>fork</code></li>\n<li>part3(IPC)</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git pull</span><br><span class=\"line\">git chekout -b lab4 origin/lab4</span><br><span class=\"line\">git merge Lab3</span><br></pre></td></tr></table></figure></p>\n<p>Lab4 <br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kern/cpu.h\t</span><br><span class=\"line\">kern/mpconfig.c\t</span><br><span class=\"line\">kern/lapic.c\tAPIC</span><br><span class=\"line\">kern/mpentry.S\tCPU</span><br><span class=\"line\">kern/spinlock.h\t</span><br><span class=\"line\">kern/spinlock.c\t</span><br><span class=\"line\">kern/sched.c\t</span><br></pre></td></tr></table></figure></p>\n<a id=\"more\"></a>\n<h2 id=\"part1-\"><a href=\"#part1-\" class=\"headerlink\" title=\"part1 \"></a>part1 </h2><p>Lab4 part1JOSJOSCPUpart3CPU</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>JOS(SMP)<code>SMP</code>CPUSMPCPU2(<code>BSP</code>)(<code>AP</code>)BIOSBSP<br>SMPCPU1<code>Local APICLAPIC</code>LAPICCPUpart1LAPIC(<code>/kern/lapic.c</code>)</p>\n<ul>\n<li>LAPIC(APIC ID)CPU(<code>cpunum()</code>).</li>\n<li>BSPSTARTUP(<code>IPI</code>) APsCPU(<code>lapic_startup()</code>).</li>\n<li>part3LAPIC(<code>apic_init()</code>).</li>\n</ul>\n<p>I/O(MMIO)LAPICMMIOIO<code>load/store</code>1<code>IO hole</code><code>0xA0000</code>(VGA)LAPIChole<code>0xFE000000</code>(4GB32MB)(<code>0xF0000000</code>0x0256MB)JOS4MB<code>MMIOBASE</code></p>\n<h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h4><p></p>\n<blockquote>\n<p><code>kern/pmap.c</code><code>mmio_map_region</code><code>lapic_init</code>(<code>kern/lapic.c</code>)</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p><code>lapic_init</code><code>mmio_map_region</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lapicaddr is the physical address of the LAPIC's 4K MMIO</span></span><br><span class=\"line\"><span class=\"comment\">// region.  Map it in to virtual memory so we can access it.</span></span><br><span class=\"line\">lapic = mmio_map_region(lapicaddr, <span class=\"number\">4096</span>);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>kern/pmap.c</code><code>boot_map_region</code><code>[pa,pa+size)</code><code>[base,base+size)</code><code>size</code><code>PGSIZE</code>DRAMcache<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/pmap.c</span></span><br><span class=\"line\"><span class=\"keyword\">void</span> *</span><br><span class=\"line\">mmio_map_region(<span class=\"keyword\">physaddr_t</span> pa, <span class=\"keyword\">size_t</span> size)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">uintptr_t</span> base = MMIOBASE;</span><br><span class=\"line\">    <span class=\"keyword\">void</span> *ret = (<span class=\"keyword\">void</span> *)base;</span><br><span class=\"line\"></span><br><span class=\"line\">    size = ROUNDUP(size, PGSIZE);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (base + size &gt; MMIOLIM || base + size &lt; base)</span><br><span class=\"line\">                panic(<span class=\"string\">\"mmio_map_region: reservation overflow\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    boot_map_region(kern_pgdir, base, size, pa, PTE_P | PTE_PCD | PTE_PWT);</span><br><span class=\"line\">    base += size;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"-Application-Processor\"><a href=\"#-Application-Processor\" class=\"headerlink\" title=\"(Application Processor)\"></a>(Application Processor)</h3><p>APBSPCPUCPUsAPIC IDLAPICMMIO<code>kern/mpconfig</code><code>mp_init()</code>BIOS<code>MP</code><br><code>boot_aps(kern/init.c)</code>APAPBSP<code>boot_aps</code>AP(<code>kern/mpentry.S</code>)BSPAP<code>0x7000(MPENTRY_PADDR)</code><br><code>boot_aps</code><code>STARTUPIPI</code>()APLAPICAP<code>kern/mpentry.S</code><code>boot/boot.S</code>APCsetup<code>mp_main</code><code>kern/init.c</code>)<code>boot_aps()</code>AP <code>CPU_STARTED</code><code>cpu_status</code>flag<code>struct CpuInfo</code></p>\n<p>labi386 <code>init</code>BSPlab2<code>mem_init</code>lab3<code>env_init</code><code>trap_init</code>lab4<code>mp_init</code><code>lapic_init</code><code>boot_aps</code>CPU<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lab2 memory management initialization functions</span></span><br><span class=\"line\">mem_init();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// lab3 user environment initialization functions</span></span><br><span class=\"line\">env_init();</span><br><span class=\"line\">trap_init();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// lab4 multiprocessor initialization functions</span></span><br><span class=\"line\">mp_init();</span><br><span class=\"line\">lapic_init();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// lab4 multitasking initialization functions</span></span><br><span class=\"line\">pic_init();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Acquire the bit kernel lock before waiting AP</span></span><br><span class=\"line\">lock_kernel();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// starting non-boot APs</span></span><br><span class=\"line\">boot_aps();</span><br></pre></td></tr></table></figure></p>\n<p>mp_initmpconfigMP CPU<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">mp_init(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> mp *mp;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> mpconf *conf;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> mpproc *proc;</span><br><span class=\"line\">    <span class=\"keyword\">uint8_t</span> *p;</span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> i;</span><br><span class=\"line\"></span><br><span class=\"line\">    bootcpu = &amp;cpus[<span class=\"number\">0</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((conf = mpconfig(&amp;mp)) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    ismp = <span class=\"number\">1</span>;</span><br><span class=\"line\">    lapicaddr = conf-&gt;lapicaddr;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (p = conf-&gt;entries, i = <span class=\"number\">0</span>; i &lt; conf-&gt;entry; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (*p) &#123;</span><br><span class=\"line\">\t\t    <span class=\"keyword\">case</span> MPPROC:</span><br><span class=\"line\">        proc = (<span class=\"keyword\">struct</span> mpproc *)p;</span><br><span class=\"line\">\t\t\t  <span class=\"keyword\">if</span> (proc-&gt;flags &amp; MPPROC_BOOT)</span><br><span class=\"line\">\t\t\t\t    bootcpu = &amp;cpus[ncpu];</span><br><span class=\"line\">\t\t\t  <span class=\"keyword\">if</span> (ncpu &lt; NCPU) &#123;</span><br><span class=\"line\">\t\t\t\t    cpus[ncpu].cpu_id = ncpu;</span><br><span class=\"line\">\t\t\t\t    ncpu++;</span><br><span class=\"line\">\t\t\t  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            cprintf(<span class=\"string\">\"SMP: too many CPUs, CPU %d disabled\\n\"</span>,</span><br><span class=\"line\">            proc-&gt;apicid);</span><br><span class=\"line\">\t\t\t  &#125;</span><br><span class=\"line\">        p += <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> mpproc);</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> MPBUS:</span><br><span class=\"line\">        <span class=\"keyword\">case</span> MPIOAPIC:</span><br><span class=\"line\">        <span class=\"keyword\">case</span> MPIOINTR:</span><br><span class=\"line\">        <span class=\"keyword\">case</span> MPLINTR:</span><br><span class=\"line\">        p += <span class=\"number\">8</span>;</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            cprintf(<span class=\"string\">\"mpinit: unknown config type %x\\n\"</span>, *p);</span><br><span class=\"line\">        ismp = <span class=\"number\">0</span>;</span><br><span class=\"line\">        i = conf-&gt;entry;</span><br><span class=\"line\">\t      &#125;</span><br><span class=\"line\">\t &#125;</span><br></pre></td></tr></table></figure></p>\n<p><code>mp_init</code><code>lapic_init</code><code>mem_init</code>CPUCPU<br><code>boot_aps</code>lab3<code>mpentry_start</code><code>mpentry_end</code><code>MPENTRY_PADDR</code><code>lapic_startap</code>AP<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Start the non-boot (AP) processors.</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">boot_aps(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">extern</span> <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> mpentry_start[], mpentry_end[];</span><br><span class=\"line\">  \t<span class=\"keyword\">void</span> *code;</span><br><span class=\"line\">  \t<span class=\"keyword\">struct</span> CpuInfo *c;</span><br><span class=\"line\"></span><br><span class=\"line\">  \t<span class=\"comment\">// Write entry code to unused memory at MPENTRY_PADDR</span></span><br><span class=\"line\">  \tcode = KADDR(MPENTRY_PADDR);</span><br><span class=\"line\">  \tmemmove(code, mpentry_start, mpentry_end - mpentry_start);</span><br><span class=\"line\"></span><br><span class=\"line\">  \t<span class=\"comment\">// Boot each AP one at a time</span></span><br><span class=\"line\">  \t<span class=\"keyword\">for</span> (c = cpus; c &lt; cpus + ncpu; c++) &#123;</span><br><span class=\"line\">  \t\t<span class=\"keyword\">if</span> (c == cpus + cpunum())  <span class=\"comment\">// We've started already.</span></span><br><span class=\"line\">  \t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  \t\t<span class=\"comment\">// Tell mpentry.S what stack to use</span></span><br><span class=\"line\">  \t\tmpentry_kstack = percpu_kstacks[c - cpus] + KSTKSIZE;</span><br><span class=\"line\">  \t\t<span class=\"comment\">// Start the CPU at mpentry_start</span></span><br><span class=\"line\">  \t\tlapic_startap(c-&gt;cpu_id, PADDR(code));</span><br><span class=\"line\">  \t\t<span class=\"comment\">// Wait for the CPU to finish some basic setup in mp_main()</span></span><br><span class=\"line\">  \t\t<span class=\"keyword\">while</span>(c-&gt;cpu_status != CPU_STARTED)</span><br><span class=\"line\">  \t\t\t;</span><br><span class=\"line\">  \t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><p></p>\n<blockquote>\n<p><code>page_init</code>(<code>kern/page.c</code>)<code>MPENTRY_PADDR</code>,AP</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p><code>boot_aps</code><code>MPENTRY_PADDR</code><code>kern/mpentry.S</code><code>boot.S</code><code>mpentry.S</code><code>mp_main</code><code>MPENTRY_PADDR</code><code>page_init</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/pmap.c</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">page_init</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    ......</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; npages; i++) &#123;</span><br><span class=\"line\">        ......</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (i == MPENTRY_PADDR / PGSIEZ)</span><br><span class=\"line\">            <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        ......</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h3><p></p>\n<blockquote>\n<p><code>kern/mpentry.S</code><code>boot/boot.S</code><code>kern/mpentry.S</code><code>KERNBASE</code><code>MPBOOTPHYS`</code>kern/mpentry.Sboot/boot.Skern/mpentry.S</p>\n</blockquote>\n<p></p>\n<blockquote>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define MPBOOTPHYS(s) ((s) - mpentry_start + MPENTRY_PADDR))))</span><br><span class=\"line\">// MPBOOTPHYS is to calculate symobl address relative to MPENTRY_PADDR. The ASM is executed in the load address above KERNBASE, but JOS need to run mp_main at 0x7000 address! Of course 0x7000s page is reserved at pmap.c.</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>AP3G<code>MPBOOTPHYS</code><code>boot.S</code><code>mpentry.S</code>CPU</p>\n</blockquote>\n<h3 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a>CPU</h3><p>CPU <code>kern / cpu.h</code>CPU<code>struct CpuInfo</code>CPU <code>cpunum()</code>CPUID<code>cpus</code><br>CPU</p>\n<ul>\n<li><br>CPU<code>percpu_kstacks[NCPU][KSTKSIZE]</code><code>NCPU</code></li>\n<li>TSSTSS<br>CPUTSSCPUCPU i<code>TSS cpus[i].cpu_ts</code>GDTTSS<code>gdt[(GD_TSS0 &gt;&gt; 3) + i]</code><code>ts</code><code>kern / trap.c</code></li>\n<li>CPU<br>CPU<code>curenv</code><code>cpus[cpunum()].cpu_env</code><code>thiscpu-&gt;cpu_env</code>CPUCPU</li>\n<li>CPU<br>CPU<code>lcr3() ltr()lgdt()lidt()</code>CPU<code>env_init_percpu()</code><code>trap_init_percpu()</code></li>\n</ul>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><p></p>\n<blockquote>\n<p><code>mem_init_mp</code><code>KSTACKTOP</code>CPU</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p>CPU<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KERNBASE ----&gt; +-------------------------+ 0xf0000000</span><br><span class=\"line\">KSTACKTOP      |   CPU0&apos;s Kernel Stack   | RW/-- KSTKSIZE</span><br><span class=\"line\">               |-------------------------|</span><br><span class=\"line\">               |   Invalid Memory(*)     | --/-- KSTKGAP</span><br><span class=\"line\">               +-------------------------+</span><br><span class=\"line\">               |    CPU1&apos;s Kernel STACK  | RW/-- KSTKSIZE</span><br><span class=\"line\">               |-------------------------|</span><br><span class=\"line\">               |   Invalid Memory(*)     | --/-- KSTKGAP</span><br><span class=\"line\">               +-------------------------+</span><br><span class=\"line\">               .             .           .</span><br><span class=\"line\">               .             .           .</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p><code>KSTKSIZE</code><code>KSTKGAP</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/pmap.c</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">mem_init_mp(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">    <span class=\"keyword\">uintptr_t</span> kstacktop_i;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NCPU; i++) &#123;</span><br><span class=\"line\">        kstacktop_i = KSTACKTOP - i * (KSTKGAP + KSTKSIZE);</span><br><span class=\"line\">        boot_map_region(kern_pgdir,</span><br><span class=\"line\">                        kstacktop_i - KSTKSIZE,</span><br><span class=\"line\">                        ROUNDUP(KSTKSIZE, PGSIZE),</span><br><span class=\"line\">                        PADDR(&amp;percpu_kstacks[i]),</span><br><span class=\"line\">                        PTE_W | PTE_P);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><p></p>\n<blockquote>\n<p><code>trap_init_percpu</code>BSPTSSTSSLab3CPU</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p>CPU<code>ts</code><code>thiscpu</code><code>CpuInfo</code><code>cpunum</code><code>TSS</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">trap_init_percpu(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    thiscpu-&gt;cpu_ts.ts_esp0 = KSTACKTOP - cpunum() * (KSTKGAP + KSTKSIZE);</span><br><span class=\"line\">    thiscpu-&gt;cpu_ts.ts_ss0 = GD_KD;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Initialize the TSS slot of the gdt.</span></span><br><span class=\"line\">    gdt[(GD_TSS0 &gt;&gt; <span class=\"number\">3</span>) + cpunum()] = SEG16(STS_T32A, (<span class=\"keyword\">uint32_t</span>) (&amp;thiscpu-&gt;cpu_ts), <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Taskstate) - <span class=\"number\">1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    gdt[(GD_TSS0 &gt;&gt; <span class=\"number\">3</span>) + cpunum()].sd_s = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Load the TSS selector (like other segment selectors, the</span></span><br><span class=\"line\">    <span class=\"comment\">// bottom three bits are special; we leave them 0)</span></span><br><span class=\"line\">    ltr(GD_TSS0 + <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Segdesc) * cpunum());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Load the IDT</span></span><br><span class=\"line\">    lidt(&amp;idt_pd);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>mp_main</code>APAPCPU1big kernel lock)1CPU<br><code>kern/spinlock.h</code><code>lock_kernel</code><code>unlock_kernel</code></p>\n<ul>\n<li>BSPCPUBSP</li>\n<li><code>mp_main</code>CPU</li>\n<li><code>trap`</code>CPUCPU</li>\n<li><code>env_run</code>lab3</li>\n</ul>\n<p></p>\n<blockquote>\n<p>i386_init&gt;BSP&gt;boot_ap&gt;(BSPcpuidlemp_main)&gt;BSPsched_yield&gt;env_run&gt;AP1&gt;sched_yield&gt;&gt;AP2&gt;sched_yield&gt;..</p>\n</blockquote>\n<h4 id=\"5\"><a href=\"#5\" class=\"headerlink\" title=\"5\"></a>5</h4><p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<p><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//i386_init</span></span><br><span class=\"line\">lock_kernel();</span><br><span class=\"line\">boot_aps();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//mp_main</span></span><br><span class=\"line\">lock_kernel();</span><br><span class=\"line\">sched_yield();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//trap</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> ((tf-&gt;tf_cs &amp; <span class=\"number\">3</span>) == <span class=\"number\">3</span>) &#123;</span><br><span class=\"line\">    lock_kernel();</span><br><span class=\"line\">    assert(curenv);</span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//env_run</span></span><br><span class=\"line\">lcr3(PADDR(curenv-&gt;env_pgdir));</span><br><span class=\"line\">unlock_kernel();</span><br><span class=\"line\">env_pop_tf(&amp;(curenv-&gt;env_tf));</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h3><p></p>\n<blockquote>\n<p>1CPUCPU1</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>1CPU</p>\n</blockquote>\n<h3 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h3><p>:</p>\n<blockquote>\n<p>JOS</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p>:JOS\n</p>\n</blockquote>\n<h3 id=\"-Round-Robin-Scheduling\"><a href=\"#-Round-Robin-Scheduling\" class=\"headerlink\" title=\"(Round-Robin Scheduling)\"></a>(Round-Robin Scheduling)</h3><p>JOS<code>round-robin</code><br><code>sched_yield</code>CPUCPU</p>\n<h4 id=\"6\"><a href=\"#6\" class=\"headerlink\" title=\"6\"></a>6</h4><p>:</p>\n<blockquote>\n<p><code>sched_yield</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>.<code>kern/syscall.c</code>,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void</span><br><span class=\"line\">sched_yield(void)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        uint32_t i, j, start;</span><br><span class=\"line\">        struct Env *runenv;</span><br><span class=\"line\"></span><br><span class=\"line\">        idle = thiscpu-&gt;cpu_env;</span><br><span class=\"line\">        start = (idle != NULL) ? ENVX(idle-&gt;env_id) : 0;</span><br><span class=\"line\">        runenv = NULL;</span><br><span class=\"line\"></span><br><span class=\"line\">        for (i = 0; i &lt; NENV; i++) &#123;</span><br><span class=\"line\">                j = (start + i) % NENV;</span><br><span class=\"line\">                if (envs[j].env_status == ENV_RUNNABLE) &#123;</span><br><span class=\"line\">                        if (runenv == NULL || envs[j].env_priority &lt; runenv-&gt;env_priority)</span><br><span class=\"line\">                                runenv = &amp;envs[j];</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if ((idle &amp;&amp; idle-&gt;env_status == ENV_RUNNING) &amp;&amp; (runenv == NULL || idle-&gt;env_priority &lt; runenv-&gt;env_priority))&#123;</span><br><span class=\"line\">                env_run(idle);</span><br><span class=\"line\">                return;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if (runenv) &#123;</span><br><span class=\"line\">                env_run(runenv);</span><br><span class=\"line\">                return;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // sched_halt never returns</span><br><span class=\"line\">        sched_halt();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p></p>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><p>:</p>\n<blockquote>\n<p><code>lcr3()</code>CPUe<code>curenv</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>UTOP</code><code>UVPT</code><code>curenv</code></p>\n</blockquote>\n<h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><p>:</p>\n<blockquote>\n<p></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>trapframe</code></p>\n</blockquote>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><p>:</p>\n<blockquote>\n<p></p>\n</blockquote>\n<p></p>\n<blockquote>\n<p>:1<code>sched_yield</code></p>\n<ol>\n<li><code>inc/env.h</code><code>Env</code>1<code>int env_priority</code></li>\n<li><code>kern/env.c</code><code>env_alloc</code><code>ENV_PRIOR_DEFAULT</code><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//inc/env.h</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> ENV_PRIOR_SUPER 0</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> ENV_PRIOR_HIGH 10</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> ENV_PRIOR_NORMAL 100</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> ENV_PRIOR_LOW 1000</span></span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"3\">\n<li><code>kern/sched.c</code><code>sched_yield</code><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/sched.c  sched_yield()</span></span><br><span class=\"line\">        idle = thiscpu-&gt;cpu_env;</span><br><span class=\"line\">        start = (idle != <span class=\"literal\">NULL</span>) ? ENVX(idle-&gt;env_id) : <span class=\"number\">0</span>;</span><br><span class=\"line\">        runenv = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NENV; i++) &#123;</span><br><span class=\"line\">                j = (start + i) % NENV;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (envs[j].env_status == ENV_RUNNABLE) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (runenv == <span class=\"literal\">NULL</span> || envs[j].env_priority &lt; runenv-&gt;env_priority)</span><br><span class=\"line\">                                runenv = &amp;envs[j];</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((idle &amp;&amp; idle-&gt;env_status == ENV_RUNNING) &amp;&amp; (runenv == <span class=\"literal\">NULL</span> || idle-&gt;env_priority &lt; runenv-&gt;env_priority))&#123;</span><br><span class=\"line\">                env_run(idle);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (runenv) &#123;</span><br><span class=\"line\">                env_run(runenv);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"4\">\n<li>1<code>sys_env_set_priority(envid, priority)</code><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_env_set_priority(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">int</span> priority)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> ret;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((ret = envid2env(envid, &amp;env, <span class=\"number\">1</span>)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">        env-&gt;env_priority = priority;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><p>:</p>\n<blockquote>\n<p>JOSx86(FPU)MMXSSEEnv </p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p></p>\n<ol>\n<li><code>inc/trap.h</code><code>Trapframe</code><code>char tf_fpus[512]`</code><code>uint32_t tf_padding0[3]`</code></li>\n<li><code>kern/trapentry.S</code><code>_alltraps</code><code>fpu</code><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_alltraps:</span><br><span class=\"line\">        pushl %ds</span><br><span class=\"line\">        pushl %es</span><br><span class=\"line\">        pushal</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// save FPU</span></span><br><span class=\"line\">        subl $<span class=\"number\">524</span>, %esp</span><br><span class=\"line\">        fxsave (%esp)</span><br><span class=\"line\"></span><br><span class=\"line\">        movl $GD_KD, %eax</span><br><span class=\"line\">        movl %eax, %ds</span><br><span class=\"line\">        movl %eax, %es</span><br><span class=\"line\"></span><br><span class=\"line\">        push %esp</span><br><span class=\"line\">        call trap</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"3\">\n<li><code>kern/env.c</code><code>env_pop_tf</code><code>fpu</code><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__asm __volatile(<span class=\"string\">\"movl %0,%%esp\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\tfxrstor (%%esp)\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\taddl $524,%%esp\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\tpopal\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\tpopl %%es\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\tpopl %%ds\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\taddl $0x8,%%esp\\n\"</span> <span class=\"comment\">/* skip tf_trapno and tf_errcode */</span></span><br><span class=\"line\">               <span class=\"string\">\"\\tiret\"</span></span><br><span class=\"line\">               : : <span class=\"string\">\"g\"</span> (tf) : <span class=\"string\">\"memory\"</span>);</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>JOS<br>Unix<code>fork</code>IDforkIDfork0<br>Unix,1JOSUnixfork<br>fork<code>user/dumbfork.c</code><code>dumbfork()</code></p>\n<h3 id=\"7\"><a href=\"#7\" class=\"headerlink\" title=\"7\"></a>7</h3><p>:</p>\n<blockquote>\n<p><code>ker/syscall.c</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>sys_exofork</code>1ID0eax00<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">envid_t</span></span><br><span class=\"line\">sys_exofork(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> ret;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((ret = env_alloc(&amp;env, sys_getenvid())) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">        env-&gt;env_status = ENV_NOT_RUNNABLE;</span><br><span class=\"line\">        env-&gt;env_tf = curenv-&gt;env_tf;</span><br><span class=\"line\">        env-&gt;env_tf.tf_regs.reg_eax = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> env-&gt;env_id;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p><code>sys_env_set_status</code><code>ENV_RUNNABLE</code><code>ENV_NOT_RUNNABLE</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_env_set_status(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">int</span> status)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">implemented<span class=\"string\">\");</span></span><br><span class=\"line\"><span class=\"string\">        int ret;</span></span><br><span class=\"line\"><span class=\"string\">        struct Env *env;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">        if (status != ENV_RUNNABLE &amp;&amp; status != ENV_RUNNING)</span></span><br><span class=\"line\"><span class=\"string\">                return -E_INVAL;</span></span><br><span class=\"line\"><span class=\"string\">        if ((ret = envid2env(envid, &amp;env, 1)) &lt; 0)</span></span><br><span class=\"line\"><span class=\"string\">                return ret;</span></span><br><span class=\"line\"><span class=\"string\">        env-&gt;env_status = status;</span></span><br><span class=\"line\"><span class=\"string\">        return 0;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p><code>env_page_alloc</code>1<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_page_alloc(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">void</span> *va, <span class=\"keyword\">int</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> PageInfo *pp;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (envid2env(envid, &amp;env, <span class=\"number\">1</span>) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_BAD_ENV;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((<span class=\"keyword\">uintptr_t</span>)va &gt;= UTOP || PGOFF(va))</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((perm &amp; PTE_U) == <span class=\"number\">0</span> || (perm &amp; PTE_P) == <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((perm &amp; ~(PTE_U | PTE_P | PTE_W | PTE_AVAIL)) != <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((pp = page_alloc(ALLOC_ZERO)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_NO_MEM;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (page_insert(env-&gt;env_pgdir, pp, va, perm) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                page_free(pp);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_NO_MEM;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>s<code>ys_page_unmap</code>1<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">static int</span><br><span class=\"line\">sys_page_unmap(envid_t envid, void *va)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        struct Env *env;</span><br><span class=\"line\"></span><br><span class=\"line\">        if (envid2env(envid, &amp;env, 1) &lt; 0)</span><br><span class=\"line\">                return -E_BAD_ENV;</span><br><span class=\"line\">        if ((uintptr_t)va &gt;= UTOP || PGOFF(va))</span><br><span class=\"line\">                return -E_INVAL;</span><br><span class=\"line\"></span><br><span class=\"line\">        page_remove(env-&gt;env_pgdir, va);</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><code>usr/umbfork.c</code>111020<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">umain(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span> **argv)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">envid_t</span> who;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> i;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// fork a child process</span></span><br><span class=\"line\">        who = dumbfork();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// print a message and yield to the other a few times</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; (who ? <span class=\"number\">10</span> : <span class=\"number\">20</span>); i++) &#123;</span><br><span class=\"line\">                cprintf(<span class=\"string\">\"%d: I am the %s!\\n\"</span>, i, who ? <span class=\"string\">\"parent\"</span> : <span class=\"string\">\"child\"</span>);</span><br><span class=\"line\">                sys_yield();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"<h1 id=\"Lab4-\"><a href=\"#Lab4-\" class=\"headerlink\" title=\"Lab4 \"></a>Lab4 </h1><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Lab4</p>\n<ul>\n<li>part1: JOS//</li>\n<li>part2Unix<code>fork</code></li>\n<li>part3(IPC)</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git pull</span><br><span class=\"line\">git chekout -b lab4 origin/lab4</span><br><span class=\"line\">git merge Lab3</span><br></pre></td></tr></table></figure></p>\n<p>Lab4 <br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kern/cpu.h\t</span><br><span class=\"line\">kern/mpconfig.c\t</span><br><span class=\"line\">kern/lapic.c\tAPIC</span><br><span class=\"line\">kern/mpentry.S\tCPU</span><br><span class=\"line\">kern/spinlock.h\t</span><br><span class=\"line\">kern/spinlock.c\t</span><br><span class=\"line\">kern/sched.c\t</span><br></pre></td></tr></table></figure></p>","more":"<h2 id=\"part1-\"><a href=\"#part1-\" class=\"headerlink\" title=\"part1 \"></a>part1 </h2><p>Lab4 part1JOSJOSCPUpart3CPU</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>JOS(SMP)<code>SMP</code>CPUSMPCPU2(<code>BSP</code>)(<code>AP</code>)BIOSBSP<br>SMPCPU1<code>Local APICLAPIC</code>LAPICCPUpart1LAPIC(<code>/kern/lapic.c</code>)</p>\n<ul>\n<li>LAPIC(APIC ID)CPU(<code>cpunum()</code>).</li>\n<li>BSPSTARTUP(<code>IPI</code>) APsCPU(<code>lapic_startup()</code>).</li>\n<li>part3LAPIC(<code>apic_init()</code>).</li>\n</ul>\n<p>I/O(MMIO)LAPICMMIOIO<code>load/store</code>1<code>IO hole</code><code>0xA0000</code>(VGA)LAPIChole<code>0xFE000000</code>(4GB32MB)(<code>0xF0000000</code>0x0256MB)JOS4MB<code>MMIOBASE</code></p>\n<h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h4><p></p>\n<blockquote>\n<p><code>kern/pmap.c</code><code>mmio_map_region</code><code>lapic_init</code>(<code>kern/lapic.c</code>)</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p><code>lapic_init</code><code>mmio_map_region</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lapicaddr is the physical address of the LAPIC's 4K MMIO</span></span><br><span class=\"line\"><span class=\"comment\">// region.  Map it in to virtual memory so we can access it.</span></span><br><span class=\"line\">lapic = mmio_map_region(lapicaddr, <span class=\"number\">4096</span>);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<blockquote>\n<p><code>kern/pmap.c</code><code>boot_map_region</code><code>[pa,pa+size)</code><code>[base,base+size)</code><code>size</code><code>PGSIZE</code>DRAMcache<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/pmap.c</span></span><br><span class=\"line\"><span class=\"keyword\">void</span> *</span><br><span class=\"line\">mmio_map_region(<span class=\"keyword\">physaddr_t</span> pa, <span class=\"keyword\">size_t</span> size)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">uintptr_t</span> base = MMIOBASE;</span><br><span class=\"line\">    <span class=\"keyword\">void</span> *ret = (<span class=\"keyword\">void</span> *)base;</span><br><span class=\"line\"></span><br><span class=\"line\">    size = ROUNDUP(size, PGSIZE);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (base + size &gt; MMIOLIM || base + size &lt; base)</span><br><span class=\"line\">                panic(<span class=\"string\">\"mmio_map_region: reservation overflow\\n\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    boot_map_region(kern_pgdir, base, size, pa, PTE_P | PTE_PCD | PTE_PWT);</span><br><span class=\"line\">    base += size;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"-Application-Processor\"><a href=\"#-Application-Processor\" class=\"headerlink\" title=\"(Application Processor)\"></a>(Application Processor)</h3><p>APBSPCPUCPUsAPIC IDLAPICMMIO<code>kern/mpconfig</code><code>mp_init()</code>BIOS<code>MP</code><br><code>boot_aps(kern/init.c)</code>APAPBSP<code>boot_aps</code>AP(<code>kern/mpentry.S</code>)BSPAP<code>0x7000(MPENTRY_PADDR)</code><br><code>boot_aps</code><code>STARTUPIPI</code>()APLAPICAP<code>kern/mpentry.S</code><code>boot/boot.S</code>APCsetup<code>mp_main</code><code>kern/init.c</code>)<code>boot_aps()</code>AP <code>CPU_STARTED</code><code>cpu_status</code>flag<code>struct CpuInfo</code></p>\n<p>labi386 <code>init</code>BSPlab2<code>mem_init</code>lab3<code>env_init</code><code>trap_init</code>lab4<code>mp_init</code><code>lapic_init</code><code>boot_aps</code>CPU<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// lab2 memory management initialization functions</span></span><br><span class=\"line\">mem_init();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// lab3 user environment initialization functions</span></span><br><span class=\"line\">env_init();</span><br><span class=\"line\">trap_init();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// lab4 multiprocessor initialization functions</span></span><br><span class=\"line\">mp_init();</span><br><span class=\"line\">lapic_init();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// lab4 multitasking initialization functions</span></span><br><span class=\"line\">pic_init();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Acquire the bit kernel lock before waiting AP</span></span><br><span class=\"line\">lock_kernel();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// starting non-boot APs</span></span><br><span class=\"line\">boot_aps();</span><br></pre></td></tr></table></figure></p>\n<p>mp_initmpconfigMP CPU<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">mp_init(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> mp *mp;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> mpconf *conf;</span><br><span class=\"line\">    <span class=\"keyword\">struct</span> mpproc *proc;</span><br><span class=\"line\">    <span class=\"keyword\">uint8_t</span> *p;</span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> i;</span><br><span class=\"line\"></span><br><span class=\"line\">    bootcpu = &amp;cpus[<span class=\"number\">0</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((conf = mpconfig(&amp;mp)) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    ismp = <span class=\"number\">1</span>;</span><br><span class=\"line\">    lapicaddr = conf-&gt;lapicaddr;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (p = conf-&gt;entries, i = <span class=\"number\">0</span>; i &lt; conf-&gt;entry; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (*p) &#123;</span><br><span class=\"line\">\t\t    <span class=\"keyword\">case</span> MPPROC:</span><br><span class=\"line\">        proc = (<span class=\"keyword\">struct</span> mpproc *)p;</span><br><span class=\"line\">\t\t\t  <span class=\"keyword\">if</span> (proc-&gt;flags &amp; MPPROC_BOOT)</span><br><span class=\"line\">\t\t\t\t    bootcpu = &amp;cpus[ncpu];</span><br><span class=\"line\">\t\t\t  <span class=\"keyword\">if</span> (ncpu &lt; NCPU) &#123;</span><br><span class=\"line\">\t\t\t\t    cpus[ncpu].cpu_id = ncpu;</span><br><span class=\"line\">\t\t\t\t    ncpu++;</span><br><span class=\"line\">\t\t\t  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            cprintf(<span class=\"string\">\"SMP: too many CPUs, CPU %d disabled\\n\"</span>,</span><br><span class=\"line\">            proc-&gt;apicid);</span><br><span class=\"line\">\t\t\t  &#125;</span><br><span class=\"line\">        p += <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> mpproc);</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> MPBUS:</span><br><span class=\"line\">        <span class=\"keyword\">case</span> MPIOAPIC:</span><br><span class=\"line\">        <span class=\"keyword\">case</span> MPIOINTR:</span><br><span class=\"line\">        <span class=\"keyword\">case</span> MPLINTR:</span><br><span class=\"line\">        p += <span class=\"number\">8</span>;</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            cprintf(<span class=\"string\">\"mpinit: unknown config type %x\\n\"</span>, *p);</span><br><span class=\"line\">        ismp = <span class=\"number\">0</span>;</span><br><span class=\"line\">        i = conf-&gt;entry;</span><br><span class=\"line\">\t      &#125;</span><br><span class=\"line\">\t &#125;</span><br></pre></td></tr></table></figure></p>\n<p><code>mp_init</code><code>lapic_init</code><code>mem_init</code>CPUCPU<br><code>boot_aps</code>lab3<code>mpentry_start</code><code>mpentry_end</code><code>MPENTRY_PADDR</code><code>lapic_startap</code>AP<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Start the non-boot (AP) processors.</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">boot_aps(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">extern</span> <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> mpentry_start[], mpentry_end[];</span><br><span class=\"line\">  \t<span class=\"keyword\">void</span> *code;</span><br><span class=\"line\">  \t<span class=\"keyword\">struct</span> CpuInfo *c;</span><br><span class=\"line\"></span><br><span class=\"line\">  \t<span class=\"comment\">// Write entry code to unused memory at MPENTRY_PADDR</span></span><br><span class=\"line\">  \tcode = KADDR(MPENTRY_PADDR);</span><br><span class=\"line\">  \tmemmove(code, mpentry_start, mpentry_end - mpentry_start);</span><br><span class=\"line\"></span><br><span class=\"line\">  \t<span class=\"comment\">// Boot each AP one at a time</span></span><br><span class=\"line\">  \t<span class=\"keyword\">for</span> (c = cpus; c &lt; cpus + ncpu; c++) &#123;</span><br><span class=\"line\">  \t\t<span class=\"keyword\">if</span> (c == cpus + cpunum())  <span class=\"comment\">// We've started already.</span></span><br><span class=\"line\">  \t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  \t\t<span class=\"comment\">// Tell mpentry.S what stack to use</span></span><br><span class=\"line\">  \t\tmpentry_kstack = percpu_kstacks[c - cpus] + KSTKSIZE;</span><br><span class=\"line\">  \t\t<span class=\"comment\">// Start the CPU at mpentry_start</span></span><br><span class=\"line\">  \t\tlapic_startap(c-&gt;cpu_id, PADDR(code));</span><br><span class=\"line\">  \t\t<span class=\"comment\">// Wait for the CPU to finish some basic setup in mp_main()</span></span><br><span class=\"line\">  \t\t<span class=\"keyword\">while</span>(c-&gt;cpu_status != CPU_STARTED)</span><br><span class=\"line\">  \t\t\t;</span><br><span class=\"line\">  \t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><p></p>\n<blockquote>\n<p><code>page_init</code>(<code>kern/page.c</code>)<code>MPENTRY_PADDR</code>,AP</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p><code>boot_aps</code><code>MPENTRY_PADDR</code><code>kern/mpentry.S</code><code>boot.S</code><code>mpentry.S</code><code>mp_main</code><code>MPENTRY_PADDR</code><code>page_init</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/pmap.c</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">page_init</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    ......</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; npages; i++) &#123;</span><br><span class=\"line\">        ......</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (i == MPENTRY_PADDR / PGSIEZ)</span><br><span class=\"line\">            <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        ......</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h3><p></p>\n<blockquote>\n<p><code>kern/mpentry.S</code><code>boot/boot.S</code><code>kern/mpentry.S</code><code>KERNBASE</code><code>MPBOOTPHYS`</code>kern/mpentry.Sboot/boot.Skern/mpentry.S</p>\n</blockquote>\n<p></p>\n<blockquote>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define MPBOOTPHYS(s) ((s) - mpentry_start + MPENTRY_PADDR))))</span><br><span class=\"line\">// MPBOOTPHYS is to calculate symobl address relative to MPENTRY_PADDR. The ASM is executed in the load address above KERNBASE, but JOS need to run mp_main at 0x7000 address! Of course 0x7000s page is reserved at pmap.c.</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>AP3G<code>MPBOOTPHYS</code><code>boot.S</code><code>mpentry.S</code>CPU</p>\n</blockquote>\n<h3 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a>CPU</h3><p>CPU <code>kern / cpu.h</code>CPU<code>struct CpuInfo</code>CPU <code>cpunum()</code>CPUID<code>cpus</code><br>CPU</p>\n<ul>\n<li><br>CPU<code>percpu_kstacks[NCPU][KSTKSIZE]</code><code>NCPU</code></li>\n<li>TSSTSS<br>CPUTSSCPUCPU i<code>TSS cpus[i].cpu_ts</code>GDTTSS<code>gdt[(GD_TSS0 &gt;&gt; 3) + i]</code><code>ts</code><code>kern / trap.c</code></li>\n<li>CPU<br>CPU<code>curenv</code><code>cpus[cpunum()].cpu_env</code><code>thiscpu-&gt;cpu_env</code>CPUCPU</li>\n<li>CPU<br>CPU<code>lcr3() ltr()lgdt()lidt()</code>CPU<code>env_init_percpu()</code><code>trap_init_percpu()</code></li>\n</ul>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><p></p>\n<blockquote>\n<p><code>mem_init_mp</code><code>KSTACKTOP</code>CPU</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p>CPU<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KERNBASE ----&gt; +-------------------------+ 0xf0000000</span><br><span class=\"line\">KSTACKTOP      |   CPU0&apos;s Kernel Stack   | RW/-- KSTKSIZE</span><br><span class=\"line\">               |-------------------------|</span><br><span class=\"line\">               |   Invalid Memory(*)     | --/-- KSTKGAP</span><br><span class=\"line\">               +-------------------------+</span><br><span class=\"line\">               |    CPU1&apos;s Kernel STACK  | RW/-- KSTKSIZE</span><br><span class=\"line\">               |-------------------------|</span><br><span class=\"line\">               |   Invalid Memory(*)     | --/-- KSTKGAP</span><br><span class=\"line\">               +-------------------------+</span><br><span class=\"line\">               .             .           .</span><br><span class=\"line\">               .             .           .</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p><code>KSTKSIZE</code><code>KSTKGAP</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/pmap.c</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">mem_init_mp(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> i;</span><br><span class=\"line\">    <span class=\"keyword\">uintptr_t</span> kstacktop_i;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NCPU; i++) &#123;</span><br><span class=\"line\">        kstacktop_i = KSTACKTOP - i * (KSTKGAP + KSTKSIZE);</span><br><span class=\"line\">        boot_map_region(kern_pgdir,</span><br><span class=\"line\">                        kstacktop_i - KSTKSIZE,</span><br><span class=\"line\">                        ROUNDUP(KSTKSIZE, PGSIZE),</span><br><span class=\"line\">                        PADDR(&amp;percpu_kstacks[i]),</span><br><span class=\"line\">                        PTE_W | PTE_P);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><p></p>\n<blockquote>\n<p><code>trap_init_percpu</code>BSPTSSTSSLab3CPU</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p>CPU<code>ts</code><code>thiscpu</code><code>CpuInfo</code><code>cpunum</code><code>TSS</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">trap_init_percpu(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    thiscpu-&gt;cpu_ts.ts_esp0 = KSTACKTOP - cpunum() * (KSTKGAP + KSTKSIZE);</span><br><span class=\"line\">    thiscpu-&gt;cpu_ts.ts_ss0 = GD_KD;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Initialize the TSS slot of the gdt.</span></span><br><span class=\"line\">    gdt[(GD_TSS0 &gt;&gt; <span class=\"number\">3</span>) + cpunum()] = SEG16(STS_T32A, (<span class=\"keyword\">uint32_t</span>) (&amp;thiscpu-&gt;cpu_ts), <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Taskstate) - <span class=\"number\">1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    gdt[(GD_TSS0 &gt;&gt; <span class=\"number\">3</span>) + cpunum()].sd_s = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Load the TSS selector (like other segment selectors, the</span></span><br><span class=\"line\">    <span class=\"comment\">// bottom three bits are special; we leave them 0)</span></span><br><span class=\"line\">    ltr(GD_TSS0 + <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Segdesc) * cpunum());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Load the IDT</span></span><br><span class=\"line\">    lidt(&amp;idt_pd);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>mp_main</code>APAPCPU1big kernel lock)1CPU<br><code>kern/spinlock.h</code><code>lock_kernel</code><code>unlock_kernel</code></p>\n<ul>\n<li>BSPCPUBSP</li>\n<li><code>mp_main</code>CPU</li>\n<li><code>trap`</code>CPUCPU</li>\n<li><code>env_run</code>lab3</li>\n</ul>\n<p></p>\n<blockquote>\n<p>i386_init&gt;BSP&gt;boot_ap&gt;(BSPcpuidlemp_main)&gt;BSPsched_yield&gt;env_run&gt;AP1&gt;sched_yield&gt;&gt;AP2&gt;sched_yield&gt;..</p>\n</blockquote>\n<h4 id=\"5\"><a href=\"#5\" class=\"headerlink\" title=\"5\"></a>5</h4><p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<p><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//i386_init</span></span><br><span class=\"line\">lock_kernel();</span><br><span class=\"line\">boot_aps();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//mp_main</span></span><br><span class=\"line\">lock_kernel();</span><br><span class=\"line\">sched_yield();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//trap</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> ((tf-&gt;tf_cs &amp; <span class=\"number\">3</span>) == <span class=\"number\">3</span>) &#123;</span><br><span class=\"line\">    lock_kernel();</span><br><span class=\"line\">    assert(curenv);</span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//env_run</span></span><br><span class=\"line\">lcr3(PADDR(curenv-&gt;env_pgdir));</span><br><span class=\"line\">unlock_kernel();</span><br><span class=\"line\">env_pop_tf(&amp;(curenv-&gt;env_tf));</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h3><p></p>\n<blockquote>\n<p>1CPUCPU1</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>1CPU</p>\n</blockquote>\n<h3 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h3><p>:</p>\n<blockquote>\n<p>JOS</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p>:JOS\n</p>\n</blockquote>\n<h3 id=\"-Round-Robin-Scheduling\"><a href=\"#-Round-Robin-Scheduling\" class=\"headerlink\" title=\"(Round-Robin Scheduling)\"></a>(Round-Robin Scheduling)</h3><p>JOS<code>round-robin</code><br><code>sched_yield</code>CPUCPU</p>\n<h4 id=\"6\"><a href=\"#6\" class=\"headerlink\" title=\"6\"></a>6</h4><p>:</p>\n<blockquote>\n<p><code>sched_yield</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>.<code>kern/syscall.c</code>,<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void</span><br><span class=\"line\">sched_yield(void)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        uint32_t i, j, start;</span><br><span class=\"line\">        struct Env *runenv;</span><br><span class=\"line\"></span><br><span class=\"line\">        idle = thiscpu-&gt;cpu_env;</span><br><span class=\"line\">        start = (idle != NULL) ? ENVX(idle-&gt;env_id) : 0;</span><br><span class=\"line\">        runenv = NULL;</span><br><span class=\"line\"></span><br><span class=\"line\">        for (i = 0; i &lt; NENV; i++) &#123;</span><br><span class=\"line\">                j = (start + i) % NENV;</span><br><span class=\"line\">                if (envs[j].env_status == ENV_RUNNABLE) &#123;</span><br><span class=\"line\">                        if (runenv == NULL || envs[j].env_priority &lt; runenv-&gt;env_priority)</span><br><span class=\"line\">                                runenv = &amp;envs[j];</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if ((idle &amp;&amp; idle-&gt;env_status == ENV_RUNNING) &amp;&amp; (runenv == NULL || idle-&gt;env_priority &lt; runenv-&gt;env_priority))&#123;</span><br><span class=\"line\">                env_run(idle);</span><br><span class=\"line\">                return;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if (runenv) &#123;</span><br><span class=\"line\">                env_run(runenv);</span><br><span class=\"line\">                return;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // sched_halt never returns</span><br><span class=\"line\">        sched_halt();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p></p>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><p>:</p>\n<blockquote>\n<p><code>lcr3()</code>CPUe<code>curenv</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>UTOP</code><code>UVPT</code><code>curenv</code></p>\n</blockquote>\n<h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><p>:</p>\n<blockquote>\n<p></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>trapframe</code></p>\n</blockquote>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><p>:</p>\n<blockquote>\n<p></p>\n</blockquote>\n<p></p>\n<blockquote>\n<p>:1<code>sched_yield</code></p>\n<ol>\n<li><code>inc/env.h</code><code>Env</code>1<code>int env_priority</code></li>\n<li><code>kern/env.c</code><code>env_alloc</code><code>ENV_PRIOR_DEFAULT</code><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//inc/env.h</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> ENV_PRIOR_SUPER 0</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> ENV_PRIOR_HIGH 10</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> ENV_PRIOR_NORMAL 100</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> ENV_PRIOR_LOW 1000</span></span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"3\">\n<li><code>kern/sched.c</code><code>sched_yield</code><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//kern/sched.c  sched_yield()</span></span><br><span class=\"line\">        idle = thiscpu-&gt;cpu_env;</span><br><span class=\"line\">        start = (idle != <span class=\"literal\">NULL</span>) ? ENVX(idle-&gt;env_id) : <span class=\"number\">0</span>;</span><br><span class=\"line\">        runenv = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; NENV; i++) &#123;</span><br><span class=\"line\">                j = (start + i) % NENV;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (envs[j].env_status == ENV_RUNNABLE) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (runenv == <span class=\"literal\">NULL</span> || envs[j].env_priority &lt; runenv-&gt;env_priority)</span><br><span class=\"line\">                                runenv = &amp;envs[j];</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((idle &amp;&amp; idle-&gt;env_status == ENV_RUNNING) &amp;&amp; (runenv == <span class=\"literal\">NULL</span> || idle-&gt;env_priority &lt; runenv-&gt;env_priority))&#123;</span><br><span class=\"line\">                env_run(idle);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (runenv) &#123;</span><br><span class=\"line\">                env_run(runenv);</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"4\">\n<li>1<code>sys_env_set_priority(envid, priority)</code><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_env_set_priority(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">int</span> priority)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> ret;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((ret = envid2env(envid, &amp;env, <span class=\"number\">1</span>)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">        env-&gt;env_priority = priority;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><p>:</p>\n<blockquote>\n<p>JOSx86(FPU)MMXSSEEnv </p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p></p>\n<ol>\n<li><code>inc/trap.h</code><code>Trapframe</code><code>char tf_fpus[512]`</code><code>uint32_t tf_padding0[3]`</code></li>\n<li><code>kern/trapentry.S</code><code>_alltraps</code><code>fpu</code><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_alltraps:</span><br><span class=\"line\">        pushl %ds</span><br><span class=\"line\">        pushl %es</span><br><span class=\"line\">        pushal</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// save FPU</span></span><br><span class=\"line\">        subl $<span class=\"number\">524</span>, %esp</span><br><span class=\"line\">        fxsave (%esp)</span><br><span class=\"line\"></span><br><span class=\"line\">        movl $GD_KD, %eax</span><br><span class=\"line\">        movl %eax, %ds</span><br><span class=\"line\">        movl %eax, %es</span><br><span class=\"line\"></span><br><span class=\"line\">        push %esp</span><br><span class=\"line\">        call trap</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"3\">\n<li><code>kern/env.c</code><code>env_pop_tf</code><code>fpu</code><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__asm __volatile(<span class=\"string\">\"movl %0,%%esp\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\tfxrstor (%%esp)\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\taddl $524,%%esp\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\tpopal\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\tpopl %%es\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\tpopl %%ds\\n\"</span></span><br><span class=\"line\">               <span class=\"string\">\"\\taddl $0x8,%%esp\\n\"</span> <span class=\"comment\">/* skip tf_trapno and tf_errcode */</span></span><br><span class=\"line\">               <span class=\"string\">\"\\tiret\"</span></span><br><span class=\"line\">               : : <span class=\"string\">\"g\"</span> (tf) : <span class=\"string\">\"memory\"</span>);</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>JOS<br>Unix<code>fork</code>IDforkIDfork0<br>Unix,1JOSUnixfork<br>fork<code>user/dumbfork.c</code><code>dumbfork()</code></p>\n<h3 id=\"7\"><a href=\"#7\" class=\"headerlink\" title=\"7\"></a>7</h3><p>:</p>\n<blockquote>\n<p><code>ker/syscall.c</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>sys_exofork</code>1ID0eax00<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">envid_t</span></span><br><span class=\"line\">sys_exofork(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> ret;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((ret = env_alloc(&amp;env, sys_getenvid())) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">        env-&gt;env_status = ENV_NOT_RUNNABLE;</span><br><span class=\"line\">        env-&gt;env_tf = curenv-&gt;env_tf;</span><br><span class=\"line\">        env-&gt;env_tf.tf_regs.reg_eax = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> env-&gt;env_id;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p><code>sys_env_set_status</code><code>ENV_RUNNABLE</code><code>ENV_NOT_RUNNABLE</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_env_set_status(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">int</span> status)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">implemented<span class=\"string\">\");</span></span><br><span class=\"line\"><span class=\"string\">        int ret;</span></span><br><span class=\"line\"><span class=\"string\">        struct Env *env;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">        if (status != ENV_RUNNABLE &amp;&amp; status != ENV_RUNNING)</span></span><br><span class=\"line\"><span class=\"string\">                return -E_INVAL;</span></span><br><span class=\"line\"><span class=\"string\">        if ((ret = envid2env(envid, &amp;env, 1)) &lt; 0)</span></span><br><span class=\"line\"><span class=\"string\">                return ret;</span></span><br><span class=\"line\"><span class=\"string\">        env-&gt;env_status = status;</span></span><br><span class=\"line\"><span class=\"string\">        return 0;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p><code>env_page_alloc</code>1<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_page_alloc(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">void</span> *va, <span class=\"keyword\">int</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> PageInfo *pp;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (envid2env(envid, &amp;env, <span class=\"number\">1</span>) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_BAD_ENV;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((<span class=\"keyword\">uintptr_t</span>)va &gt;= UTOP || PGOFF(va))</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((perm &amp; PTE_U) == <span class=\"number\">0</span> || (perm &amp; PTE_P) == <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((perm &amp; ~(PTE_U | PTE_P | PTE_W | PTE_AVAIL)) != <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((pp = page_alloc(ALLOC_ZERO)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_NO_MEM;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (page_insert(env-&gt;env_pgdir, pp, va, perm) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                page_free(pp);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_NO_MEM;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>s<code>ys_page_unmap</code>1<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">static int</span><br><span class=\"line\">sys_page_unmap(envid_t envid, void *va)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        struct Env *env;</span><br><span class=\"line\"></span><br><span class=\"line\">        if (envid2env(envid, &amp;env, 1) &lt; 0)</span><br><span class=\"line\">                return -E_BAD_ENV;</span><br><span class=\"line\">        if ((uintptr_t)va &gt;= UTOP || PGOFF(va))</span><br><span class=\"line\">                return -E_INVAL;</span><br><span class=\"line\"></span><br><span class=\"line\">        page_remove(env-&gt;env_pgdir, va);</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><code>usr/umbfork.c</code>111020<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">umain(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span> **argv)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">envid_t</span> who;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> i;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// fork a child process</span></span><br><span class=\"line\">        who = dumbfork();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// print a message and yield to the other a few times</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; (who ? <span class=\"number\">10</span> : <span class=\"number\">20</span>); i++) &#123;</span><br><span class=\"line\">                cprintf(<span class=\"string\">\"%d: I am the %s!\\n\"</span>, i, who ? <span class=\"string\">\"parent\"</span> : <span class=\"string\">\"child\"</span>);</span><br><span class=\"line\">                sys_yield();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>"},{"title":"lab4-Preemptive Multitasking part23","date":"2017-05-12T16:00:00.000Z","_content":"# Lab4 \n## Part2  copy-on-write fork\n,Unixfork().fork().\nxv6 Unix `fork()`,`dumbfork()`.`fork()`.\n,`fork()``exec()`, ., shell.,,`exec()`.\n\n,Unix,****,.**(copy-on-fork)**.,`fork()`,,,.,.,Unix,/.,.`fork()``exec()``exec()`,.\n\npart2, Unix `fork()`,,.,`fork()`:`fork()``dumbfork()`,.\n\n### \n`fork()`,..\n:,.,Unix,,,Unix.,.BSS,0,.\n.Unix,,bug.,.\n<!-- more -->\n\n#### \n,JOS`entrypoint`.`sys_env_set_pgfault_upcall`.`Env``env_pgfault_upcall`.\n\n#### 8\n:\n> `sys_env_set_pgfault_upcall`.:,ID,\n\n:\n> :\n``` c\nstatic int\nsys_env_set_pgfault_upcall(envid_t envid, void *func)\n{\n        struct Env *env;\n\n        if (envid2env(envid, &env, 1) < 0)\n                return -E_BAD_ENV;\n        env->env_pgfault_upcall = func;\n        return 0;\n}\n```\n\n#### /\n,,`ESP``USTACKTOP`,`USTACKTOP-PGSIZE USTACKTOP-1`.,. .,,,.\n\n*  [KSTACKTOP, KSTACKTOP-KSTKSIZE]\n*  [UXSTACKTOP, UXSTACKTOP - PGSIZE]\n*  [USTACKTOP, UTEXT]\n\n,,CPU,`kern/trap.c``trap_init_percpu()`.\n``` c\nvoid\ntrap_init_percpu(void)\n{\n        // Setup a TSS so that we get the right stack\n        // when we trap to the kernel.\n        thiscpu->cpu_ts.ts_esp0 = KSTACKTOP - cpunum() * (KSTKGAP + KSTKSIZE);\n        thiscpu->cpu_ts.ts_ss0 = GD_KD;\n\n        // Initialize the TSS slot of the gdt.\n        gdt[(GD_TSS0 >> 3) + cpunum()] = SEG16(STS_T32A, (uint32_t) (&thiscpu->cpu_ts),\n                                        sizeof(struct Taskstate) - 1, 0);\n        gdt[(GD_TSS0 >> 3) + cpunum()].sd_s = 0;\n\n        // Load the TSS selector (like other segment selectors, the\n        // bottom three bits are special; we leave them 0)\n        ltr(GD_TSS0 + sizeof(struct Segdesc) * cpunum());\n\n        // Load the IDT\n        lidt(&idt_pd);\n}\n```\n,.\n> ,,`trap`,,`page_fault_handler()`.`page fault`(,`panic`),`UTrapframe`.,,.,.\n\n#### \n,,,,.,,,,`eip`,..,,.\n`inc / trap.h``struct Trapframe``struct UTrapframe`\n``` c\nstruct UTrapframe {\n        /* information about the fault */\n        uint32_t utf_fault_va;  /* va for T_PGFLT, 0 otherwise */\n        uint32_t utf_err;\n        /* trap-time return state */\n        struct PushRegs utf_regs;\n        uintptr_t utf_eip;\n        uint32_t utf_eflags;\n        /* the trap-time stack to return to */\n        uintptr_t utf_esp;\n} __attribute__((packed));\n```\n`Trapframe`,`utf_fault_va`,,`es,ds,ss`.,,,,.,`Trapframe`,`UTrapframe`.\n,,\n**>>**\n,\n**>>**\n\n#### 9\n:\n> `kern/trap.c``page_fault_handler`, .\n\n:\n> ,4,,.`UTrapframe`,`tf`.,,.,,.\n``` c\nvoid\npage_fault_handler(struct Trapframe *tf)\n{\n        uint32_t fault_va;\n\n        // Read processor's CR2 register to find the faulting address\n        fault_va = rcr2();\n\n        // Handle kernel-mode page faults.\n        if (tf->tf_cs == GD_KT)\n                panic(\"page_fault in kernel mode, fault address: %d\\n\", fault_va);\n\n        struct UTrapframe *utf;\n\n        if (curenv->env_pgfault_upcall) {\n                if (UXSTACKTOP - PGSIZE <= tf->tf_esp && tf->tf_esp <= UXSTACKTOP - 1)\n                        utf = (struct UTrapframe *)(tf->tf_esp - sizeof(struct UTrapframe) - 4);\n                else\n                        utf = (struct UTrapframe *)(UXSTACKTOP - sizeof(struct UTrapframe));\n                user_mem_assert(curenv, (void *)utf, sizeof(struct UTrapframe), PTE_U | PTE_W);\n\n                utf->utf_fault_va = fault_va;\n                utf->utf_err = tf->tf_trapno;\n                utf->utf_eip = tf->tf_eip;\n                utf->utf_eflags = tf->tf_eflags;\n                utf->utf_esp = tf->tf_esp;\n                utf->utf_regs = tf->tf_regs;\n                tf->tf_eip = (uint32_t)curenv->env_pgfault_upcall;\n                tf->tf_esp = (uint32_t)utf;\n                env_run(curenv);\n        }\n\n        // Destroy the environment that caused the fault.\n        cprintf(\"[%08x] user fault va %08x ip %08x\\n\",\n                curenv->env_id, fault_va, tf->tf_eip);\n        print_trapframe(tf);\n        env_destroy(curenv);\n}\n```\n\n#### \n,,,`sys_env_set_pgfault_upcall()`.\n\n#### 10\n:\n> `lib/pfentry.S``_pgfault_upcall`.\n\n:\n> `_pgfault_upcall`,,,`UTrapframe`,,.:\n`_pgfault_handler`,\n![UStack1](/images/lab4/UStack1.png)\n`trap-time esp`14,. `trap-time esp`4,.,`esp-4`4. `trap-time eip`4,.\n![UStack2](/images/lab4/UStack2.png)\nEFLAG,\n![UStack3](/images/lab4/UStack3.png)\n`pop esp`,`ret`.\n``` c\n.text\n.globl _pgfault_upcall\n_pgfault_upcall:\n        // Call the C page fault handler.\n        pushl %esp                      // function argument: pointer to UTF\n        movl _pgfault_handler, %eax\n        call *%eax\n        addl $4, %esp                   // pop function argument\n\n        movl 48(%esp), %ebp\n        subl $4, %ebp\n        movl %ebp, 48(%esp)\n        movl 40(%esp), %eax\n        movl %eax, (%ebp)\n\n        // Restore the trap-time registers.  After you do this, you can no longer modify any general-purpose registers.\n        addl $8, %esp\n        popal\n\n        // Restore eflags from the stack.  After you do this, you can\n        // no longer use arithmetic operations or anything else that\n        // modifies eflags.\n        addl $4, %esp\n        popfl\n\n        // Switch back to the adjusted trap-time stack.\n\n        popl %esp\n\n        // Return to re-execute the instruction that faulted.\n        ret\n```\n\n#### 11\n:\n> `lib / pgfault.c``set_pgfault_handler()`,C.\n\n:\n> ,,.\n``` c\nvoid\nset_pgfault_handler(void (*handler)(struct UTrapframe *utf))\n{\n        int r;\n\n        if (_pgfault_handler == 0) {\n                // First time through!\n                if ((r = sys_page_alloc(thisenv->env_id, (void *)(UXSTACKTOP - PGSIZE), PTE_P | PTE_W | PTE_U)) < 0)\n                        panic(\"set_pgfault_handler: %e\", r);\n                sys_env_set_pgfault_upcall(thisenv->env_id, _pgfault_upcall);\n\n        }\n\n        // Save handler pointer for assembly to call.\n        _pgfault_handler = handler;\n}\n```\n\n###  fork\n`copy-on-write fork`.\n`dumbfork()`,`fork()`,.,.,COW(copy-on-write).,,,page fault,COW,,.\n\n#### 12\n:\n> `lib/fork.c``fork,duppagepgfault`.\n\n:\n> .`set_pgfault_handler()`,,`sys_env_set_pgfault_upcall`.\n`sys_exofork`,`ENV_NOT_RUNNABLE`.,`PTE_P`.,,.copy-on-write,fork,.\n\n> 1. ,(UXSTACKTOP-PGSIZE).\n> 2. PFTEMP,.\n> 3. ,,.\n> 4. PFTEMP.\n> 5. \n\n:\n`pgfault``page fault`.\n``` c\nstatic void\npgfault(struct UTrapframe *utf)\n{\n        int r;\n        void *addr = (void *) utf->utf_fault_va;\n        uint32_t err = utf->utf_err;\n\n        if ((err & FEC_WR) == 0 || (uvpt[PGNUM(addr)] & PTE_COW) == 0)\n                panic(\"pgfault: it's not writable or attempt to access a non-cow page!\");\n        // Allocate a new page, map it at a temporary location (PFTEMP),\n        // copy the data from the old page to the new page, then move the new\n        // page to the old page's address.\n\n        envid_t envid = sys_getenvid();\n        if ((r = sys_page_alloc(envid, (void *)PFTEMP, PTE_P | PTE_W | PTE_U)) < 0)\n                panic(\"pgfault: page allocation failed %e\", r);\n\n        addr = ROUNDDOWN(addr, PGSIZE);\n        memmove(PFTEMP, addr, PGSIZE);\n        if ((r = sys_page_unmap(envid, addr)) < 0)\n                panic(\"pgfault: page unmap failed %e\", r);\n        if ((r = sys_page_map(envid, PFTEMP, envid, addr, PTE_P | PTE_W |PTE_U)) < 0)\n                panic(\"pgfault: page map failed %e\", r);\n        if ((r = sys_page_unmap(envid, PFTEMP)) < 0)\n                panic(\"pgfault: page unmap failed %e\", r);\n}\n```\n`pgfault()`,`panic`.`PFTEMP`,`page fault`.`addr`,`addr``PFTEMP`,`PFTEMP`.\n`duppage`,COW,pn`envid`pn,COW.\n``` c\nstatic int\nduppage(envid_t envid, unsigned pn)\n{\n        int r;\n\n        void *addr;\n        pte_t pte;\n        int perm;\n\n        addr = (void *)((uint32_t)pn * PGSIZE);\n        pte = uvpt[pn];\n        perm = PTE_P | PTE_U;\n        if ((pte & PTE_W) || (pte & PTE_COW))\n                perm |= PTE_COW;\n        if ((r = sys_page_map(thisenv->env_id, addr, envid, addr, perm)) < 0) {\n                panic(\"duppage: page remapping failed %e\", r);\n                return r;\n        }\n        if (perm & PTE_COW) {\n                if ((r = sys_page_map(thisenv->env_id, addr, thisenv->env_id, addr, perm)) < 0) {\n                        panic(\"duppage: page remapping failed %e\", r);\n                        return r;\n                }\n        }\n\n        return 0;\n}\n```\nfork,,`UTEXTUXSTACKTOP`,,`env_alloc`.\n``` c\nenvid_t\nfork(void)\n{\n        uint32_t addr;\n        int i, j, pn, r;\n        extern void _pgfault_upcall(void);\n        if ((envid = sys_exofork()) < 0) {\n                panic(\"sys_exofork failed: %e\", envid);\n                return envid;\n        }\n        if (envid == 0) {\n                thisenv = &envs[ENVX(sys_getenvid())];\n                return 0;\n        }\n\n        for (i = PDX(UTEXT); i < PDX(UXSTACKTOP); i++) {\n                if (uvpd[i] & PTE_P) {\n                        for (j = 0; j < NPTENTRIES; j++) {\n                                pn = PGNUM(PGADDR(i, j, 0));\n                                if (pn == PGNUM(UXSTACKTOP - PGSIZE))\n                                        break;\n                                if (uvpt[pn] & PTE_P)\n                                        duppage(envid, pn);\n                        }\n                }\n\n        }\n\n        if ((r = sys_page_alloc(envid, (void *)(UXSTACKTOP - PGSIZE), PTE_P | PTE_U | PTE_W)) < 0) {\n                panic(\"fork: page alloc failed %e\", r);\n                return r;\n        }\n        if ((r = sys_page_map(envid, (void *)(UXSTACKTOP - PGSIZE), thisenv->env_id, PFTEMP, PTE_P | PTE_U | PTE_W)) < 0) {\n                panic(\"fork: page map failed %e\", r);\n                return r;\n        }\n        memmove((void *)(UXSTACKTOP - PGSIZE), PFTEMP, PGSIZE);\n        if ((r = sys_page_unmap(thisenv->env_id, PFTEMP)) < 0) {\n                panic(\"fork: page unmap failed %e\", r);\n                return r;\n        }\n        sys_env_set_pgfault_upcall(envid, _pgfault_upcall);\n        if ((r = sys_env_set_status(envid, ENV_RUNNABLE)) < 0) {\n                panic(\"fork: set child env status failed %e\", r);\n                return r;\n        }\n\n        return envid;\n}\n```\n\n## Part3 \nLab4\n\n### \nCPUCPUBootloaderJOS\n\n#### \nIRQ16IRQ015.IRQIDT, `picirq.c``pic_init`IRQ 0-15IDT`[IRQ_OFFSET,IRQ_OFFSET+15]`.\n`inc / trap.h` `IRQ_OFFSET`32.IDT32-47IRQ 0-15IRQ 0.`IDT[IRQ_OFFSET + 0]``IDT[32]``IRQ_OFFSET`,.\nJOSxv6 Unixxv6`FL_IF%eflags``inc/mmu.h`1`%eflags``FL_IF`Lab1`bootloaded`.\n\n#### 12\n:\n> `kern/trapentry.S``kern/trap.c``IDTIRQs0-15``env_alloc`\n\n:\n> `kern/trapentry.S``IRQ0-15`\n``` c\nTRAPHANDLER(irq0_entry, IRQ_OFFSET + 0, 0, 0);\nTRAPHANDLER(irq1_entry, IRQ_OFFSET + 1, 0, 0);\nTRAPHANDLER(irq2_entry, IRQ_OFFSET + 2, 0, 0);\nTRAPHANDLER(irq3_entry, IRQ_OFFSET + 3, 0, 0);\nTRAPHANDLER(irq4_entry, IRQ_OFFSET + 4, 0, 0);\nTRAPHANDLER(irq5_entry, IRQ_OFFSET + 5, 0, 0);\nTRAPHANDLER(irq6_entry, IRQ_OFFSET + 6, 0, 0);\nTRAPHANDLER(irq7_entry, IRQ_OFFSET + 7, 0, 0);\nTRAPHANDLER(irq8_entry, IRQ_OFFSET + 8, 0, 0);\nTRAPHANDLER(irq9_entry, IRQ_OFFSET + 9, 0, 0);\nTRAPHANDLER(irq10_entry, IRQ_OFFSET + 10, 0, 0);\nTRAPHANDLER(irq11_entry, IRQ_OFFSET + 11, 0, 0);\nTRAPHANDLER(irq12_entry, IRQ_OFFSET + 12, 0, 0);\nTRAPHANDLER(irq13_entry, IRQ_OFFSET + 13, 0, 0);\nTRAPHANDLER(irq14_entry, IRQ_OFFSET + 14, 0, 0);\nTRAPHANDLER(irq15_entry, IRQ_OFFSET + 15, 0, 0);\n```\nIDT`trap_init`\n`env_alloc`\n``` c\n        // kern/env_alloc.c\n        // Also clear the IPC receiving flag.\n        e->env_ipc_recving = 0;\n\n        // Set FL_IF so that user environments run with interrupts enabled\n        e->env_tf.tf_eflags |= FL_IF;\n\n        // commit the allocation\n        env_free_list = e->env_link;\n        *newenv_store = e;\n```\n\n#### \n`trap_dispatch`\n\n#### 14\n:\n> `trap_dispatch`h`sched_yield`\n\n:\n> \n```\n// kern/trap.c\n\n// Handle clock interrupts. Don't forget to acknowledge the\n// interrupt using lapic_eoi() before calling the scheduler!\nif (tf->tf_trapno == IRQ_OFFSET + IRQ_TIMER) {\n                lapic_eoi();\n                sched_yield();\n                return;\n }\n```\n\n#### (IPC)\nIPCJOSIPC`recv``send`JOS32\n\n#### IPC\nJOSIPC`Env`\n``` c\nstruct Env {\n        struct Trapframe env_tf;        // Saved registers\n        struct Env *env_link;           // Next free Env\n        envid_t env_id;                 // Unique environment identifier\n        envid_t env_parent_id;          // env_id of this env's parent\n        enum EnvType env_type;          // Indicates special system environments\n        unsigned env_status;            // Status of the environment\n        uint32_t env_runs;              // Number of times environment has run\n        int env_cpunum;                 // The CPU that the env is running on\n\n        // Address space\n        pde_t *env_pgdir;               // Kernel virtual address of page dir\n\n        // Exception handling\n        void *env_pgfault_upcall;       // Page fault upcall entry point\n\n        // Lab 4 IPC\n        bool env_ipc_recving;           // Env is blocked receiving\n        void *env_ipc_dstva;            // VA at which to map received page\n        uint32_t env_ipc_value;         // Data value sent to us\n        envid_t env_ipc_from;           // envid of the sender\n        int env_ipc_perm;               // Perm of page mapping received\n};\n```\n5\n* env_ipc_recving\nenv_ipc_recv10\n* env_ipc_dstva\n<=UTOP\n* env_ipc_value\n\n* env_ipc_from\nenvid\n* env_ipc_perm\n\n\n#### 15\n:\n> `kern/syscall.c``sys_ipc_recvsys_ipc_try_send``ipc_recvipc_send`\n\n:\n> `sys_ipc_recv`CPU`ENV_NOT_RUNNABLE`\n``` c\nstatic int\nsys_ipc_recv(void *dstva)\n{\n        if (dstva < (void *)UTOP && PGOFF(dstva))\n                return -E_INVAL;\n        curenv->env_ipc_recving = true;\n        curenv->env_ipc_dstva = dstva;\n        curenv->env_status = ENV_NOT_RUNNABLE;\n        curenv->env_ipc_from = 0;\n        sched_yield();\n        return 0;\n}\n```\n`sys_ipc_try_send``srcva``UTOP``srcva``env_ipc_recving`0\n``` c\nstatic int\nsys_ipc_try_send(envid_t envid, uint32_t value, void *srcva, unsigned perm)\n{\n        int r;\n        pte_t *pte;\n        struct PageInfo *pp;\n        struct Env *env;\n\n        if ((r = envid2env(envid, &env, 0)) < 0)\n                return -E_BAD_ENV;\n        if (env->env_ipc_recving != true || env->env_ipc_from != 0)\n                return -E_IPC_NOT_RECV;\n        if (srcva < (void *)UTOP && PGOFF(srcva))\n                return -E_INVAL;\n        if (srcva < (void *)UTOP) {\n                if ((perm & PTE_P) == 0 || (perm & PTE_U) == 0)\n                        return -E_INVAL;\n                if ((perm & ~(PTE_P | PTE_U | PTE_W | PTE_AVAIL)) != 0)\n                        return -E_INVAL;\n        }\n        if (srcva < (void *)UTOP && (pp = page_lookup(curenv->env_pgdir, srcva, &pte)) == NULL)\n                return -E_INVAL;\n        if (srcva < (void *)UTOP && (perm & PTE_W) != 0 && (*pte & PTE_W) == 0)\n                return -E_INVAL;\n        if (srcva < (void *)UTOP && env->env_ipc_dstva != 0) {\n                if ((r = page_insert(env->env_pgdir, pp, env->env_ipc_dstva, perm)) < 0)\n                        return -E_NO_MEM;\n                env->env_ipc_perm = perm;\n        }\n\n        env->env_ipc_from = curenv->env_id;\n        env->env_ipc_recving = false;\n        env->env_ipc_value = value;\n        env->env_status = ENV_RUNNABLE;\n        env->env_tf.tf_regs.reg_eax = 0;\n        return 0;\n}\n```\n\n2\n``` c\nint32_t\nipc_recv(envid_t *from_env_store, void *pg, int *perm_store)\n{\n        int r;\n\n        if (pg == NULL)\n                r = sys_ipc_recv((void *)UTOP);\n        else\n                r = sys_ipc_recv(pg);\n        if (from_env_store != NULL)\n                *from_env_store = r < 0 ? 0 : thisenv->env_ipc_from;\n        if (perm_store != NULL)\n                *perm_store = r < 0 ? 0 : thisenv->env_ipc_perm;\n        if (r < 0)\n                return r;\n        else\n                return thisenv->env_ipc_value;\n}\n\nvoid\nipc_send(envid_t to_env, uint32_t val, void *pg, int perm)\n{\n        int r;\n        void *dstpg;\n\n        dstpg = pg != NULL ? pg : (void *)UTOP;\n        while((r = sys_ipc_try_send(to_env, val, dstpg, perm)) < 0) {\n                if (r != -E_IPC_NOT_RECV)\n                        panic(\"ipc_send: send message error %e\", r);\n                sys_yield();\n        }\n}\n```\n","source":"_posts/lab4_part23.md","raw":"title: lab4-Preemptive Multitasking part23\ndate: 2017/05/13\ntags:\n- xv6\n- os\n\n---\n# Lab4 \n## Part2  copy-on-write fork\n,Unixfork().fork().\nxv6 Unix `fork()`,`dumbfork()`.`fork()`.\n,`fork()``exec()`, ., shell.,,`exec()`.\n\n,Unix,****,.**(copy-on-fork)**.,`fork()`,,,.,.,Unix,/.,.`fork()``exec()``exec()`,.\n\npart2, Unix `fork()`,,.,`fork()`:`fork()``dumbfork()`,.\n\n### \n`fork()`,..\n:,.,Unix,,,Unix.,.BSS,0,.\n.Unix,,bug.,.\n<!-- more -->\n\n#### \n,JOS`entrypoint`.`sys_env_set_pgfault_upcall`.`Env``env_pgfault_upcall`.\n\n#### 8\n:\n> `sys_env_set_pgfault_upcall`.:,ID,\n\n:\n> :\n``` c\nstatic int\nsys_env_set_pgfault_upcall(envid_t envid, void *func)\n{\n        struct Env *env;\n\n        if (envid2env(envid, &env, 1) < 0)\n                return -E_BAD_ENV;\n        env->env_pgfault_upcall = func;\n        return 0;\n}\n```\n\n#### /\n,,`ESP``USTACKTOP`,`USTACKTOP-PGSIZE USTACKTOP-1`.,. .,,,.\n\n*  [KSTACKTOP, KSTACKTOP-KSTKSIZE]\n*  [UXSTACKTOP, UXSTACKTOP - PGSIZE]\n*  [USTACKTOP, UTEXT]\n\n,,CPU,`kern/trap.c``trap_init_percpu()`.\n``` c\nvoid\ntrap_init_percpu(void)\n{\n        // Setup a TSS so that we get the right stack\n        // when we trap to the kernel.\n        thiscpu->cpu_ts.ts_esp0 = KSTACKTOP - cpunum() * (KSTKGAP + KSTKSIZE);\n        thiscpu->cpu_ts.ts_ss0 = GD_KD;\n\n        // Initialize the TSS slot of the gdt.\n        gdt[(GD_TSS0 >> 3) + cpunum()] = SEG16(STS_T32A, (uint32_t) (&thiscpu->cpu_ts),\n                                        sizeof(struct Taskstate) - 1, 0);\n        gdt[(GD_TSS0 >> 3) + cpunum()].sd_s = 0;\n\n        // Load the TSS selector (like other segment selectors, the\n        // bottom three bits are special; we leave them 0)\n        ltr(GD_TSS0 + sizeof(struct Segdesc) * cpunum());\n\n        // Load the IDT\n        lidt(&idt_pd);\n}\n```\n,.\n> ,,`trap`,,`page_fault_handler()`.`page fault`(,`panic`),`UTrapframe`.,,.,.\n\n#### \n,,,,.,,,,`eip`,..,,.\n`inc / trap.h``struct Trapframe``struct UTrapframe`\n``` c\nstruct UTrapframe {\n        /* information about the fault */\n        uint32_t utf_fault_va;  /* va for T_PGFLT, 0 otherwise */\n        uint32_t utf_err;\n        /* trap-time return state */\n        struct PushRegs utf_regs;\n        uintptr_t utf_eip;\n        uint32_t utf_eflags;\n        /* the trap-time stack to return to */\n        uintptr_t utf_esp;\n} __attribute__((packed));\n```\n`Trapframe`,`utf_fault_va`,,`es,ds,ss`.,,,,.,`Trapframe`,`UTrapframe`.\n,,\n**>>**\n,\n**>>**\n\n#### 9\n:\n> `kern/trap.c``page_fault_handler`, .\n\n:\n> ,4,,.`UTrapframe`,`tf`.,,.,,.\n``` c\nvoid\npage_fault_handler(struct Trapframe *tf)\n{\n        uint32_t fault_va;\n\n        // Read processor's CR2 register to find the faulting address\n        fault_va = rcr2();\n\n        // Handle kernel-mode page faults.\n        if (tf->tf_cs == GD_KT)\n                panic(\"page_fault in kernel mode, fault address: %d\\n\", fault_va);\n\n        struct UTrapframe *utf;\n\n        if (curenv->env_pgfault_upcall) {\n                if (UXSTACKTOP - PGSIZE <= tf->tf_esp && tf->tf_esp <= UXSTACKTOP - 1)\n                        utf = (struct UTrapframe *)(tf->tf_esp - sizeof(struct UTrapframe) - 4);\n                else\n                        utf = (struct UTrapframe *)(UXSTACKTOP - sizeof(struct UTrapframe));\n                user_mem_assert(curenv, (void *)utf, sizeof(struct UTrapframe), PTE_U | PTE_W);\n\n                utf->utf_fault_va = fault_va;\n                utf->utf_err = tf->tf_trapno;\n                utf->utf_eip = tf->tf_eip;\n                utf->utf_eflags = tf->tf_eflags;\n                utf->utf_esp = tf->tf_esp;\n                utf->utf_regs = tf->tf_regs;\n                tf->tf_eip = (uint32_t)curenv->env_pgfault_upcall;\n                tf->tf_esp = (uint32_t)utf;\n                env_run(curenv);\n        }\n\n        // Destroy the environment that caused the fault.\n        cprintf(\"[%08x] user fault va %08x ip %08x\\n\",\n                curenv->env_id, fault_va, tf->tf_eip);\n        print_trapframe(tf);\n        env_destroy(curenv);\n}\n```\n\n#### \n,,,`sys_env_set_pgfault_upcall()`.\n\n#### 10\n:\n> `lib/pfentry.S``_pgfault_upcall`.\n\n:\n> `_pgfault_upcall`,,,`UTrapframe`,,.:\n`_pgfault_handler`,\n![UStack1](/images/lab4/UStack1.png)\n`trap-time esp`14,. `trap-time esp`4,.,`esp-4`4. `trap-time eip`4,.\n![UStack2](/images/lab4/UStack2.png)\nEFLAG,\n![UStack3](/images/lab4/UStack3.png)\n`pop esp`,`ret`.\n``` c\n.text\n.globl _pgfault_upcall\n_pgfault_upcall:\n        // Call the C page fault handler.\n        pushl %esp                      // function argument: pointer to UTF\n        movl _pgfault_handler, %eax\n        call *%eax\n        addl $4, %esp                   // pop function argument\n\n        movl 48(%esp), %ebp\n        subl $4, %ebp\n        movl %ebp, 48(%esp)\n        movl 40(%esp), %eax\n        movl %eax, (%ebp)\n\n        // Restore the trap-time registers.  After you do this, you can no longer modify any general-purpose registers.\n        addl $8, %esp\n        popal\n\n        // Restore eflags from the stack.  After you do this, you can\n        // no longer use arithmetic operations or anything else that\n        // modifies eflags.\n        addl $4, %esp\n        popfl\n\n        // Switch back to the adjusted trap-time stack.\n\n        popl %esp\n\n        // Return to re-execute the instruction that faulted.\n        ret\n```\n\n#### 11\n:\n> `lib / pgfault.c``set_pgfault_handler()`,C.\n\n:\n> ,,.\n``` c\nvoid\nset_pgfault_handler(void (*handler)(struct UTrapframe *utf))\n{\n        int r;\n\n        if (_pgfault_handler == 0) {\n                // First time through!\n                if ((r = sys_page_alloc(thisenv->env_id, (void *)(UXSTACKTOP - PGSIZE), PTE_P | PTE_W | PTE_U)) < 0)\n                        panic(\"set_pgfault_handler: %e\", r);\n                sys_env_set_pgfault_upcall(thisenv->env_id, _pgfault_upcall);\n\n        }\n\n        // Save handler pointer for assembly to call.\n        _pgfault_handler = handler;\n}\n```\n\n###  fork\n`copy-on-write fork`.\n`dumbfork()`,`fork()`,.,.,COW(copy-on-write).,,,page fault,COW,,.\n\n#### 12\n:\n> `lib/fork.c``fork,duppagepgfault`.\n\n:\n> .`set_pgfault_handler()`,,`sys_env_set_pgfault_upcall`.\n`sys_exofork`,`ENV_NOT_RUNNABLE`.,`PTE_P`.,,.copy-on-write,fork,.\n\n> 1. ,(UXSTACKTOP-PGSIZE).\n> 2. PFTEMP,.\n> 3. ,,.\n> 4. PFTEMP.\n> 5. \n\n:\n`pgfault``page fault`.\n``` c\nstatic void\npgfault(struct UTrapframe *utf)\n{\n        int r;\n        void *addr = (void *) utf->utf_fault_va;\n        uint32_t err = utf->utf_err;\n\n        if ((err & FEC_WR) == 0 || (uvpt[PGNUM(addr)] & PTE_COW) == 0)\n                panic(\"pgfault: it's not writable or attempt to access a non-cow page!\");\n        // Allocate a new page, map it at a temporary location (PFTEMP),\n        // copy the data from the old page to the new page, then move the new\n        // page to the old page's address.\n\n        envid_t envid = sys_getenvid();\n        if ((r = sys_page_alloc(envid, (void *)PFTEMP, PTE_P | PTE_W | PTE_U)) < 0)\n                panic(\"pgfault: page allocation failed %e\", r);\n\n        addr = ROUNDDOWN(addr, PGSIZE);\n        memmove(PFTEMP, addr, PGSIZE);\n        if ((r = sys_page_unmap(envid, addr)) < 0)\n                panic(\"pgfault: page unmap failed %e\", r);\n        if ((r = sys_page_map(envid, PFTEMP, envid, addr, PTE_P | PTE_W |PTE_U)) < 0)\n                panic(\"pgfault: page map failed %e\", r);\n        if ((r = sys_page_unmap(envid, PFTEMP)) < 0)\n                panic(\"pgfault: page unmap failed %e\", r);\n}\n```\n`pgfault()`,`panic`.`PFTEMP`,`page fault`.`addr`,`addr``PFTEMP`,`PFTEMP`.\n`duppage`,COW,pn`envid`pn,COW.\n``` c\nstatic int\nduppage(envid_t envid, unsigned pn)\n{\n        int r;\n\n        void *addr;\n        pte_t pte;\n        int perm;\n\n        addr = (void *)((uint32_t)pn * PGSIZE);\n        pte = uvpt[pn];\n        perm = PTE_P | PTE_U;\n        if ((pte & PTE_W) || (pte & PTE_COW))\n                perm |= PTE_COW;\n        if ((r = sys_page_map(thisenv->env_id, addr, envid, addr, perm)) < 0) {\n                panic(\"duppage: page remapping failed %e\", r);\n                return r;\n        }\n        if (perm & PTE_COW) {\n                if ((r = sys_page_map(thisenv->env_id, addr, thisenv->env_id, addr, perm)) < 0) {\n                        panic(\"duppage: page remapping failed %e\", r);\n                        return r;\n                }\n        }\n\n        return 0;\n}\n```\nfork,,`UTEXTUXSTACKTOP`,,`env_alloc`.\n``` c\nenvid_t\nfork(void)\n{\n        uint32_t addr;\n        int i, j, pn, r;\n        extern void _pgfault_upcall(void);\n        if ((envid = sys_exofork()) < 0) {\n                panic(\"sys_exofork failed: %e\", envid);\n                return envid;\n        }\n        if (envid == 0) {\n                thisenv = &envs[ENVX(sys_getenvid())];\n                return 0;\n        }\n\n        for (i = PDX(UTEXT); i < PDX(UXSTACKTOP); i++) {\n                if (uvpd[i] & PTE_P) {\n                        for (j = 0; j < NPTENTRIES; j++) {\n                                pn = PGNUM(PGADDR(i, j, 0));\n                                if (pn == PGNUM(UXSTACKTOP - PGSIZE))\n                                        break;\n                                if (uvpt[pn] & PTE_P)\n                                        duppage(envid, pn);\n                        }\n                }\n\n        }\n\n        if ((r = sys_page_alloc(envid, (void *)(UXSTACKTOP - PGSIZE), PTE_P | PTE_U | PTE_W)) < 0) {\n                panic(\"fork: page alloc failed %e\", r);\n                return r;\n        }\n        if ((r = sys_page_map(envid, (void *)(UXSTACKTOP - PGSIZE), thisenv->env_id, PFTEMP, PTE_P | PTE_U | PTE_W)) < 0) {\n                panic(\"fork: page map failed %e\", r);\n                return r;\n        }\n        memmove((void *)(UXSTACKTOP - PGSIZE), PFTEMP, PGSIZE);\n        if ((r = sys_page_unmap(thisenv->env_id, PFTEMP)) < 0) {\n                panic(\"fork: page unmap failed %e\", r);\n                return r;\n        }\n        sys_env_set_pgfault_upcall(envid, _pgfault_upcall);\n        if ((r = sys_env_set_status(envid, ENV_RUNNABLE)) < 0) {\n                panic(\"fork: set child env status failed %e\", r);\n                return r;\n        }\n\n        return envid;\n}\n```\n\n## Part3 \nLab4\n\n### \nCPUCPUBootloaderJOS\n\n#### \nIRQ16IRQ015.IRQIDT, `picirq.c``pic_init`IRQ 0-15IDT`[IRQ_OFFSET,IRQ_OFFSET+15]`.\n`inc / trap.h` `IRQ_OFFSET`32.IDT32-47IRQ 0-15IRQ 0.`IDT[IRQ_OFFSET + 0]``IDT[32]``IRQ_OFFSET`,.\nJOSxv6 Unixxv6`FL_IF%eflags``inc/mmu.h`1`%eflags``FL_IF`Lab1`bootloaded`.\n\n#### 12\n:\n> `kern/trapentry.S``kern/trap.c``IDTIRQs0-15``env_alloc`\n\n:\n> `kern/trapentry.S``IRQ0-15`\n``` c\nTRAPHANDLER(irq0_entry, IRQ_OFFSET + 0, 0, 0);\nTRAPHANDLER(irq1_entry, IRQ_OFFSET + 1, 0, 0);\nTRAPHANDLER(irq2_entry, IRQ_OFFSET + 2, 0, 0);\nTRAPHANDLER(irq3_entry, IRQ_OFFSET + 3, 0, 0);\nTRAPHANDLER(irq4_entry, IRQ_OFFSET + 4, 0, 0);\nTRAPHANDLER(irq5_entry, IRQ_OFFSET + 5, 0, 0);\nTRAPHANDLER(irq6_entry, IRQ_OFFSET + 6, 0, 0);\nTRAPHANDLER(irq7_entry, IRQ_OFFSET + 7, 0, 0);\nTRAPHANDLER(irq8_entry, IRQ_OFFSET + 8, 0, 0);\nTRAPHANDLER(irq9_entry, IRQ_OFFSET + 9, 0, 0);\nTRAPHANDLER(irq10_entry, IRQ_OFFSET + 10, 0, 0);\nTRAPHANDLER(irq11_entry, IRQ_OFFSET + 11, 0, 0);\nTRAPHANDLER(irq12_entry, IRQ_OFFSET + 12, 0, 0);\nTRAPHANDLER(irq13_entry, IRQ_OFFSET + 13, 0, 0);\nTRAPHANDLER(irq14_entry, IRQ_OFFSET + 14, 0, 0);\nTRAPHANDLER(irq15_entry, IRQ_OFFSET + 15, 0, 0);\n```\nIDT`trap_init`\n`env_alloc`\n``` c\n        // kern/env_alloc.c\n        // Also clear the IPC receiving flag.\n        e->env_ipc_recving = 0;\n\n        // Set FL_IF so that user environments run with interrupts enabled\n        e->env_tf.tf_eflags |= FL_IF;\n\n        // commit the allocation\n        env_free_list = e->env_link;\n        *newenv_store = e;\n```\n\n#### \n`trap_dispatch`\n\n#### 14\n:\n> `trap_dispatch`h`sched_yield`\n\n:\n> \n```\n// kern/trap.c\n\n// Handle clock interrupts. Don't forget to acknowledge the\n// interrupt using lapic_eoi() before calling the scheduler!\nif (tf->tf_trapno == IRQ_OFFSET + IRQ_TIMER) {\n                lapic_eoi();\n                sched_yield();\n                return;\n }\n```\n\n#### (IPC)\nIPCJOSIPC`recv``send`JOS32\n\n#### IPC\nJOSIPC`Env`\n``` c\nstruct Env {\n        struct Trapframe env_tf;        // Saved registers\n        struct Env *env_link;           // Next free Env\n        envid_t env_id;                 // Unique environment identifier\n        envid_t env_parent_id;          // env_id of this env's parent\n        enum EnvType env_type;          // Indicates special system environments\n        unsigned env_status;            // Status of the environment\n        uint32_t env_runs;              // Number of times environment has run\n        int env_cpunum;                 // The CPU that the env is running on\n\n        // Address space\n        pde_t *env_pgdir;               // Kernel virtual address of page dir\n\n        // Exception handling\n        void *env_pgfault_upcall;       // Page fault upcall entry point\n\n        // Lab 4 IPC\n        bool env_ipc_recving;           // Env is blocked receiving\n        void *env_ipc_dstva;            // VA at which to map received page\n        uint32_t env_ipc_value;         // Data value sent to us\n        envid_t env_ipc_from;           // envid of the sender\n        int env_ipc_perm;               // Perm of page mapping received\n};\n```\n5\n* env_ipc_recving\nenv_ipc_recv10\n* env_ipc_dstva\n<=UTOP\n* env_ipc_value\n\n* env_ipc_from\nenvid\n* env_ipc_perm\n\n\n#### 15\n:\n> `kern/syscall.c``sys_ipc_recvsys_ipc_try_send``ipc_recvipc_send`\n\n:\n> `sys_ipc_recv`CPU`ENV_NOT_RUNNABLE`\n``` c\nstatic int\nsys_ipc_recv(void *dstva)\n{\n        if (dstva < (void *)UTOP && PGOFF(dstva))\n                return -E_INVAL;\n        curenv->env_ipc_recving = true;\n        curenv->env_ipc_dstva = dstva;\n        curenv->env_status = ENV_NOT_RUNNABLE;\n        curenv->env_ipc_from = 0;\n        sched_yield();\n        return 0;\n}\n```\n`sys_ipc_try_send``srcva``UTOP``srcva``env_ipc_recving`0\n``` c\nstatic int\nsys_ipc_try_send(envid_t envid, uint32_t value, void *srcva, unsigned perm)\n{\n        int r;\n        pte_t *pte;\n        struct PageInfo *pp;\n        struct Env *env;\n\n        if ((r = envid2env(envid, &env, 0)) < 0)\n                return -E_BAD_ENV;\n        if (env->env_ipc_recving != true || env->env_ipc_from != 0)\n                return -E_IPC_NOT_RECV;\n        if (srcva < (void *)UTOP && PGOFF(srcva))\n                return -E_INVAL;\n        if (srcva < (void *)UTOP) {\n                if ((perm & PTE_P) == 0 || (perm & PTE_U) == 0)\n                        return -E_INVAL;\n                if ((perm & ~(PTE_P | PTE_U | PTE_W | PTE_AVAIL)) != 0)\n                        return -E_INVAL;\n        }\n        if (srcva < (void *)UTOP && (pp = page_lookup(curenv->env_pgdir, srcva, &pte)) == NULL)\n                return -E_INVAL;\n        if (srcva < (void *)UTOP && (perm & PTE_W) != 0 && (*pte & PTE_W) == 0)\n                return -E_INVAL;\n        if (srcva < (void *)UTOP && env->env_ipc_dstva != 0) {\n                if ((r = page_insert(env->env_pgdir, pp, env->env_ipc_dstva, perm)) < 0)\n                        return -E_NO_MEM;\n                env->env_ipc_perm = perm;\n        }\n\n        env->env_ipc_from = curenv->env_id;\n        env->env_ipc_recving = false;\n        env->env_ipc_value = value;\n        env->env_status = ENV_RUNNABLE;\n        env->env_tf.tf_regs.reg_eax = 0;\n        return 0;\n}\n```\n\n2\n``` c\nint32_t\nipc_recv(envid_t *from_env_store, void *pg, int *perm_store)\n{\n        int r;\n\n        if (pg == NULL)\n                r = sys_ipc_recv((void *)UTOP);\n        else\n                r = sys_ipc_recv(pg);\n        if (from_env_store != NULL)\n                *from_env_store = r < 0 ? 0 : thisenv->env_ipc_from;\n        if (perm_store != NULL)\n                *perm_store = r < 0 ? 0 : thisenv->env_ipc_perm;\n        if (r < 0)\n                return r;\n        else\n                return thisenv->env_ipc_value;\n}\n\nvoid\nipc_send(envid_t to_env, uint32_t val, void *pg, int perm)\n{\n        int r;\n        void *dstpg;\n\n        dstpg = pg != NULL ? pg : (void *)UTOP;\n        while((r = sys_ipc_try_send(to_env, val, dstpg, perm)) < 0) {\n                if (r != -E_IPC_NOT_RECV)\n                        panic(\"ipc_send: send message error %e\", r);\n                sys_yield();\n        }\n}\n```\n","slug":"lab4_part23","published":1,"updated":"2017-08-26T03:38:21.606Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjhutb3he001ds7amyfupt465","content":"<h1 id=\"Lab4-\"><a href=\"#Lab4-\" class=\"headerlink\" title=\"Lab4 \"></a>Lab4 </h1><h2 id=\"Part2--copy-on-write-fork\"><a href=\"#Part2--copy-on-write-fork\" class=\"headerlink\" title=\"Part2  copy-on-write fork\"></a>Part2  copy-on-write fork</h2><p>,Unixfork().fork().<br>xv6 Unix <code>fork()</code>,<code>dumbfork()</code>.<code>fork()</code>.<br>,<code>fork()</code><code>exec()</code>, ., shell.,,<code>exec()</code>.</p>\n<p>,Unix,<strong></strong>,.<strong>(copy-on-fork)</strong>.,<code>fork()</code>,,,.,.,Unix,/.,.<code>fork()</code><code>exec()</code><code>exec()</code>,.</p>\n<p>part2, Unix <code>fork()</code>,,.,<code>fork()</code>:<code>fork()</code><code>dumbfork()</code>,.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>fork()</code>,..<br>:,.,Unix,,,Unix.,.BSS,0,.<br>.Unix,,bug.,.<br><a id=\"more\"></a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>,JOS<code>entrypoint</code>.<code>sys_env_set_pgfault_upcall</code>.<code>Env</code><code>env_pgfault_upcall</code>.</p>\n<h4 id=\"8\"><a href=\"#8\" class=\"headerlink\" title=\"8\"></a>8</h4><p>:</p>\n<blockquote>\n<p><code>sys_env_set_pgfault_upcall</code>.:,ID,</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_env_set_pgfault_upcall(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">void</span> *func)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (envid2env(envid, &amp;env, <span class=\"number\">1</span>) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_BAD_ENV;</span><br><span class=\"line\">        env-&gt;env_pgfault_upcall = func;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"/\"></a>/</h4><p>,,<code>ESP</code><code>USTACKTOP</code>,<code>USTACKTOP-PGSIZE USTACKTOP-1</code>.,. .,,,.<br></p>\n<ul>\n<li> [KSTACKTOP, KSTACKTOP-KSTKSIZE]</li>\n<li> [UXSTACKTOP, UXSTACKTOP - PGSIZE]</li>\n<li> [USTACKTOP, UTEXT]</li>\n</ul>\n<p>,,CPU,<code>kern/trap.c</code><code>trap_init_percpu()</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">trap_init_percpu(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"comment\">// Setup a TSS so that we get the right stack</span></span><br><span class=\"line\">        <span class=\"comment\">// when we trap to the kernel.</span></span><br><span class=\"line\">        thiscpu-&gt;cpu_ts.ts_esp0 = KSTACKTOP - cpunum() * (KSTKGAP + KSTKSIZE);</span><br><span class=\"line\">        thiscpu-&gt;cpu_ts.ts_ss0 = GD_KD;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Initialize the TSS slot of the gdt.</span></span><br><span class=\"line\">        gdt[(GD_TSS0 &gt;&gt; <span class=\"number\">3</span>) + cpunum()] = SEG16(STS_T32A, (<span class=\"keyword\">uint32_t</span>) (&amp;thiscpu-&gt;cpu_ts),</span><br><span class=\"line\">                                        <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Taskstate) - <span class=\"number\">1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">        gdt[(GD_TSS0 &gt;&gt; <span class=\"number\">3</span>) + cpunum()].sd_s = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Load the TSS selector (like other segment selectors, the</span></span><br><span class=\"line\">        <span class=\"comment\">// bottom three bits are special; we leave them 0)</span></span><br><span class=\"line\">        ltr(GD_TSS0 + <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Segdesc) * cpunum());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Load the IDT</span></span><br><span class=\"line\">        lidt(&amp;idt_pd);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>,.</p>\n<blockquote>\n<p>,,<code>trap</code>,,<code>page_fault_handler()</code>.<code>page fault</code>(,<code>panic</code>),<code>UTrapframe</code>.,,.,.</p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>,,,,.,,,,<code>eip</code>,..,,.<br><code>inc / trap.h</code><code>struct Trapframe</code><code>struct UTrapframe</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> UTrapframe &#123;</span><br><span class=\"line\">        <span class=\"comment\">/* information about the fault */</span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> utf_fault_va;  <span class=\"comment\">/* va for T_PGFLT, 0 otherwise */</span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> utf_err;</span><br><span class=\"line\">        <span class=\"comment\">/* trap-time return state */</span></span><br><span class=\"line\">        <span class=\"keyword\">struct</span> PushRegs utf_regs;</span><br><span class=\"line\">        <span class=\"keyword\">uintptr_t</span> utf_eip;</span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> utf_eflags;</span><br><span class=\"line\">        <span class=\"comment\">/* the trap-time stack to return to */</span></span><br><span class=\"line\">        <span class=\"keyword\">uintptr_t</span> utf_esp;</span><br><span class=\"line\">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure></p>\n<p><code>Trapframe</code>,<code>utf_fault_va</code>,,<code>es,ds,ss</code>.,,,,.,<code>Trapframe</code>,<code>UTrapframe</code>.<br>,,<br><strong>&gt;&gt;</strong><br>,<br><strong>&gt;&gt;</strong></p>\n<h4 id=\"9\"><a href=\"#9\" class=\"headerlink\" title=\"9\"></a>9</h4><p>:</p>\n<blockquote>\n<p><code>kern/trap.c</code><code>page_fault_handler</code>, .</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>,4,,.<code>UTrapframe</code>,<code>tf</code>.,,.,,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">page_fault_handler(<span class=\"keyword\">struct</span> Trapframe *tf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> fault_va;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Read processor's CR2 register to find the faulting address</span></span><br><span class=\"line\">        fault_va = rcr2();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Handle kernel-mode page faults.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (tf-&gt;tf_cs == GD_KT)</span><br><span class=\"line\">                panic(<span class=\"string\">\"page_fault in kernel mode, fault address: %d\\n\"</span>, fault_va);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">struct</span> UTrapframe *utf;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (curenv-&gt;env_pgfault_upcall) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (UXSTACKTOP - PGSIZE &lt;= tf-&gt;tf_esp &amp;&amp; tf-&gt;tf_esp &lt;= UXSTACKTOP - <span class=\"number\">1</span>)</span><br><span class=\"line\">                        utf = (<span class=\"keyword\">struct</span> UTrapframe *)(tf-&gt;tf_esp - <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> UTrapframe) - <span class=\"number\">4</span>);</span><br><span class=\"line\">                <span class=\"keyword\">else</span></span><br><span class=\"line\">                        utf = (<span class=\"keyword\">struct</span> UTrapframe *)(UXSTACKTOP - <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> UTrapframe));</span><br><span class=\"line\">                user_mem_assert(curenv, (<span class=\"keyword\">void</span> *)utf, <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> UTrapframe), PTE_U | PTE_W);</span><br><span class=\"line\"></span><br><span class=\"line\">                utf-&gt;utf_fault_va = fault_va;</span><br><span class=\"line\">                utf-&gt;utf_err = tf-&gt;tf_trapno;</span><br><span class=\"line\">                utf-&gt;utf_eip = tf-&gt;tf_eip;</span><br><span class=\"line\">                utf-&gt;utf_eflags = tf-&gt;tf_eflags;</span><br><span class=\"line\">                utf-&gt;utf_esp = tf-&gt;tf_esp;</span><br><span class=\"line\">                utf-&gt;utf_regs = tf-&gt;tf_regs;</span><br><span class=\"line\">                tf-&gt;tf_eip = (<span class=\"keyword\">uint32_t</span>)curenv-&gt;env_pgfault_upcall;</span><br><span class=\"line\">                tf-&gt;tf_esp = (<span class=\"keyword\">uint32_t</span>)utf;</span><br><span class=\"line\">                env_run(curenv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Destroy the environment that caused the fault.</span></span><br><span class=\"line\">        cprintf(<span class=\"string\">\"[%08x] user fault va %08x ip %08x\\n\"</span>,</span><br><span class=\"line\">                curenv-&gt;env_id, fault_va, tf-&gt;tf_eip);</span><br><span class=\"line\">        print_trapframe(tf);</span><br><span class=\"line\">        env_destroy(curenv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>,,,<code>sys_env_set_pgfault_upcall()</code>.</p>\n<h4 id=\"10\"><a href=\"#10\" class=\"headerlink\" title=\"10\"></a>10</h4><p>:</p>\n<blockquote>\n<p><code>lib/pfentry.S</code><code>_pgfault_upcall</code>.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>_pgfault_upcall</code>,,,<code>UTrapframe</code>,,.:<br><code>_pgfault_handler</code>,<br><img src=\"/images/lab4/UStack1.png\" alt=\"UStack1\"><br><code>trap-time esp</code>14,. <code>trap-time esp</code>4,.,<code>esp-4</code>4. <code>trap-time eip</code>4,.<br><img src=\"/images/lab4/UStack2.png\" alt=\"UStack2\"><br>EFLAG,<br><img src=\"/images/lab4/UStack3.png\" alt=\"UStack3\"><br><code>pop esp</code>,<code>ret</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text</span><br><span class=\"line\">.globl _pgfault_upcall</span><br><span class=\"line\">_pgfault_upcall:</span><br><span class=\"line\">        <span class=\"comment\">// Call the C page fault handler.</span></span><br><span class=\"line\">        pushl %esp                      <span class=\"comment\">// function argument: pointer to UTF</span></span><br><span class=\"line\">        movl _pgfault_handler, %eax</span><br><span class=\"line\">        call *%eax</span><br><span class=\"line\">        addl $<span class=\"number\">4</span>, %esp                   <span class=\"comment\">// pop function argument</span></span><br><span class=\"line\"></span><br><span class=\"line\">        movl <span class=\"number\">48</span>(%esp), %ebp</span><br><span class=\"line\">        subl $<span class=\"number\">4</span>, %ebp</span><br><span class=\"line\">        movl %ebp, <span class=\"number\">48</span>(%esp)</span><br><span class=\"line\">        movl <span class=\"number\">40</span>(%esp), %eax</span><br><span class=\"line\">        movl %eax, (%ebp)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Restore the trap-time registers.  After you do this, you can no longer modify any general-purpose registers.</span></span><br><span class=\"line\">        addl $<span class=\"number\">8</span>, %esp</span><br><span class=\"line\">        popal</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Restore eflags from the stack.  After you do this, you can</span></span><br><span class=\"line\">        <span class=\"comment\">// no longer use arithmetic operations or anything else that</span></span><br><span class=\"line\">        <span class=\"comment\">// modifies eflags.</span></span><br><span class=\"line\">        addl $<span class=\"number\">4</span>, %esp</span><br><span class=\"line\">        popfl</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Switch back to the adjusted trap-time stack.</span></span><br><span class=\"line\"></span><br><span class=\"line\">        popl %esp</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Return to re-execute the instruction that faulted.</span></span><br><span class=\"line\">        ret</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"11\"><a href=\"#11\" class=\"headerlink\" title=\"11\"></a>11</h4><p>:</p>\n<blockquote>\n<p><code>lib / pgfault.c</code><code>set_pgfault_handler()</code>,C.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>,,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">set_pgfault_handler(<span class=\"keyword\">void</span> (*handler)(<span class=\"keyword\">struct</span> UTrapframe *utf))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (_pgfault_handler == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// First time through!</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((r = sys_page_alloc(thisenv-&gt;env_id, (<span class=\"keyword\">void</span> *)(UXSTACKTOP - PGSIZE), PTE_P | PTE_W | PTE_U)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                        panic(<span class=\"string\">\"set_pgfault_handler: %e\"</span>, r);</span><br><span class=\"line\">                sys_env_set_pgfault_upcall(thisenv-&gt;env_id, _pgfault_upcall);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Save handler pointer for assembly to call.</span></span><br><span class=\"line\">        _pgfault_handler = handler;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"-fork\"><a href=\"#-fork\" class=\"headerlink\" title=\" fork\"></a> fork</h3><p><code>copy-on-write fork</code>.<br><code>dumbfork()</code>,<code>fork()</code>,.,.,COW(copy-on-write).,,,page fault,COW,,.</p>\n<h4 id=\"12\"><a href=\"#12\" class=\"headerlink\" title=\"12\"></a>12</h4><p>:</p>\n<blockquote>\n<p><code>lib/fork.c</code><code>fork,duppagepgfault</code>.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>.<code>set_pgfault_handler()</code>,,<code>sys_env_set_pgfault_upcall</code>.<br><code>sys_exofork</code>,<code>ENV_NOT_RUNNABLE</code>.,<code>PTE_P</code>.,,.copy-on-write,fork,.<br></p>\n<ol>\n<li>,(UXSTACKTOP-PGSIZE).</li>\n<li>PFTEMP,.</li>\n<li>,,.</li>\n<li>PFTEMP.</li>\n<li></li>\n</ol>\n</blockquote>\n<p>:<br><code>pgfault</code><code>page fault</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">pgfault(<span class=\"keyword\">struct</span> UTrapframe *utf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\">        <span class=\"keyword\">void</span> *addr = (<span class=\"keyword\">void</span> *) utf-&gt;utf_fault_va;</span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> err = utf-&gt;utf_err;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((err &amp; FEC_WR) == <span class=\"number\">0</span> || (uvpt[PGNUM(addr)] &amp; PTE_COW) == <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"pgfault: it's not writable or attempt to access a non-cow page!\"</span>);</span><br><span class=\"line\">        <span class=\"comment\">// Allocate a new page, map it at a temporary location (PFTEMP),</span></span><br><span class=\"line\">        <span class=\"comment\">// copy the data from the old page to the new page, then move the new</span></span><br><span class=\"line\">        <span class=\"comment\">// page to the old page's address.</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">envid_t</span> envid = sys_getenvid();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_alloc(envid, (<span class=\"keyword\">void</span> *)PFTEMP, PTE_P | PTE_W | PTE_U)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"pgfault: page allocation failed %e\"</span>, r);</span><br><span class=\"line\"></span><br><span class=\"line\">        addr = ROUNDDOWN(addr, PGSIZE);</span><br><span class=\"line\">        memmove(PFTEMP, addr, PGSIZE);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_unmap(envid, addr)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"pgfault: page unmap failed %e\"</span>, r);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_map(envid, PFTEMP, envid, addr, PTE_P | PTE_W |PTE_U)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"pgfault: page map failed %e\"</span>, r);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_unmap(envid, PFTEMP)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"pgfault: page unmap failed %e\"</span>, r);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><code>pgfault()</code>,<code>panic</code>.<code>PFTEMP</code>,<code>page fault</code>.<code>addr</code>,<code>addr</code><code>PFTEMP</code>,<code>PFTEMP</code>.<br><code>duppage</code>,COW,pn<code>envid</code>pn,COW.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">duppage(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">unsigned</span> pn)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">void</span> *addr;</span><br><span class=\"line\">        <span class=\"keyword\">pte_t</span> pte;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> perm;</span><br><span class=\"line\"></span><br><span class=\"line\">        addr = (<span class=\"keyword\">void</span> *)((<span class=\"keyword\">uint32_t</span>)pn * PGSIZE);</span><br><span class=\"line\">        pte = uvpt[pn];</span><br><span class=\"line\">        perm = PTE_P | PTE_U;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((pte &amp; PTE_W) || (pte &amp; PTE_COW))</span><br><span class=\"line\">                perm |= PTE_COW;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_map(thisenv-&gt;env_id, addr, envid, addr, perm)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"duppage: page remapping failed %e\"</span>, r);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (perm &amp; PTE_COW) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((r = sys_page_map(thisenv-&gt;env_id, addr, thisenv-&gt;env_id, addr, perm)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                        panic(<span class=\"string\">\"duppage: page remapping failed %e\"</span>, r);</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>fork,,<code>UTEXTUXSTACKTOP</code>,,<code>env_alloc</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">envid_t</span></span><br><span class=\"line\">fork(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> addr;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> i, j, pn, r;</span><br><span class=\"line\">        <span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> _pgfault_upcall(<span class=\"keyword\">void</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((envid = sys_exofork()) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"sys_exofork failed: %e\"</span>, envid);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> envid;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (envid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                thisenv = &amp;envs[ENVX(sys_getenvid())];</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (i = PDX(UTEXT); i &lt; PDX(UXSTACKTOP); i++) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (uvpd[i] &amp; PTE_P) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">for</span> (j = <span class=\"number\">0</span>; j &lt; NPTENTRIES; j++) &#123;</span><br><span class=\"line\">                                pn = PGNUM(PGADDR(i, j, <span class=\"number\">0</span>));</span><br><span class=\"line\">                                <span class=\"keyword\">if</span> (pn == PGNUM(UXSTACKTOP - PGSIZE))</span><br><span class=\"line\">                                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                                <span class=\"keyword\">if</span> (uvpt[pn] &amp; PTE_P)</span><br><span class=\"line\">                                        duppage(envid, pn);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_alloc(envid, (<span class=\"keyword\">void</span> *)(UXSTACKTOP - PGSIZE), PTE_P | PTE_U | PTE_W)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"fork: page alloc failed %e\"</span>, r);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_map(envid, (<span class=\"keyword\">void</span> *)(UXSTACKTOP - PGSIZE), thisenv-&gt;env_id, PFTEMP, PTE_P | PTE_U | PTE_W)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"fork: page map failed %e\"</span>, r);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        memmove((<span class=\"keyword\">void</span> *)(UXSTACKTOP - PGSIZE), PFTEMP, PGSIZE);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_unmap(thisenv-&gt;env_id, PFTEMP)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"fork: page unmap failed %e\"</span>, r);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        sys_env_set_pgfault_upcall(envid, _pgfault_upcall);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_env_set_status(envid, ENV_RUNNABLE)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"fork: set child env status failed %e\"</span>, r);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> envid;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Part3-\"><a href=\"#Part3-\" class=\"headerlink\" title=\"Part3 \"></a>Part3 </h2><p>Lab4</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>CPUCPUBootloaderJOS</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>IRQ16IRQ015.IRQIDT, <code>picirq.c</code><code>pic_init</code>IRQ 0-15IDT<code>[IRQ_OFFSET,IRQ_OFFSET+15]</code>.<br><code>inc / trap.h</code> <code>IRQ_OFFSET</code>32.IDT32-47IRQ 0-15IRQ 0.<code>IDT[IRQ_OFFSET + 0]</code><code>IDT[32]</code><code>IRQ_OFFSET</code>,.<br>JOSxv6 Unixxv6<code>FL_IF%eflags</code><code>inc/mmu.h</code>1<code>%eflags</code><code>FL_IF</code>Lab1<code>bootloaded</code>.</p>\n<h4 id=\"12-1\"><a href=\"#12-1\" class=\"headerlink\" title=\"12\"></a>12</h4><p>:</p>\n<blockquote>\n<p><code>kern/trapentry.S</code><code>kern/trap.c</code><code>IDTIRQs0-15</code><code>env_alloc</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>kern/trapentry.S</code><code>IRQ0-15</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TRAPHANDLER(irq0_entry, IRQ_OFFSET + <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq1_entry, IRQ_OFFSET + <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq2_entry, IRQ_OFFSET + <span class=\"number\">2</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq3_entry, IRQ_OFFSET + <span class=\"number\">3</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq4_entry, IRQ_OFFSET + <span class=\"number\">4</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq5_entry, IRQ_OFFSET + <span class=\"number\">5</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq6_entry, IRQ_OFFSET + <span class=\"number\">6</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq7_entry, IRQ_OFFSET + <span class=\"number\">7</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq8_entry, IRQ_OFFSET + <span class=\"number\">8</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq9_entry, IRQ_OFFSET + <span class=\"number\">9</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq10_entry, IRQ_OFFSET + <span class=\"number\">10</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq11_entry, IRQ_OFFSET + <span class=\"number\">11</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq12_entry, IRQ_OFFSET + <span class=\"number\">12</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq13_entry, IRQ_OFFSET + <span class=\"number\">13</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq14_entry, IRQ_OFFSET + <span class=\"number\">14</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq15_entry, IRQ_OFFSET + <span class=\"number\">15</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>IDT<code>trap_init</code><br><code>env_alloc</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// kern/env_alloc.c</span></span><br><span class=\"line\"><span class=\"comment\">// Also clear the IPC receiving flag.</span></span><br><span class=\"line\">e-&gt;env_ipc_recving = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Set FL_IF so that user environments run with interrupts enabled</span></span><br><span class=\"line\">e-&gt;env_tf.tf_eflags |= FL_IF;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// commit the allocation</span></span><br><span class=\"line\">env_free_list = e-&gt;env_link;</span><br><span class=\"line\">*newenv_store = e;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code>trap_dispatch</code></p>\n<h4 id=\"14\"><a href=\"#14\" class=\"headerlink\" title=\"14\"></a>14</h4><p>:</p>\n<blockquote>\n<p><code>trap_dispatch</code>h<code>sched_yield</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// kern/trap.c</span><br><span class=\"line\"></span><br><span class=\"line\">// Handle clock interrupts. Don&apos;t forget to acknowledge the</span><br><span class=\"line\">// interrupt using lapic_eoi() before calling the scheduler!</span><br><span class=\"line\">if (tf-&gt;tf_trapno == IRQ_OFFSET + IRQ_TIMER) &#123;</span><br><span class=\"line\">                lapic_eoi();</span><br><span class=\"line\">                sched_yield();</span><br><span class=\"line\">                return;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"-IPC\"><a href=\"#-IPC\" class=\"headerlink\" title=\"(IPC)\"></a>(IPC)</h4><p>IPCJOSIPC<code>recv</code><code>send</code>JOS32\n</p>\n<h4 id=\"IPC\"><a href=\"#IPC\" class=\"headerlink\" title=\"IPC\"></a>IPC</h4><p>JOSIPC<code>Env</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> Env &#123;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Trapframe env_tf;        <span class=\"comment\">// Saved registers</span></span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env_link;           <span class=\"comment\">// Next free Env</span></span><br><span class=\"line\">        <span class=\"keyword\">envid_t</span> env_id;                 <span class=\"comment\">// Unique environment identifier</span></span><br><span class=\"line\">        <span class=\"keyword\">envid_t</span> env_parent_id;          <span class=\"comment\">// env_id of this env's parent</span></span><br><span class=\"line\">        <span class=\"keyword\">enum</span> EnvType env_type;          <span class=\"comment\">// Indicates special system environments</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> env_status;            <span class=\"comment\">// Status of the environment</span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> env_runs;              <span class=\"comment\">// Number of times environment has run</span></span><br><span class=\"line\">        <span class=\"keyword\">int</span> env_cpunum;                 <span class=\"comment\">// The CPU that the env is running on</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Address space</span></span><br><span class=\"line\">        <span class=\"keyword\">pde_t</span> *env_pgdir;               <span class=\"comment\">// Kernel virtual address of page dir</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Exception handling</span></span><br><span class=\"line\">        <span class=\"keyword\">void</span> *env_pgfault_upcall;       <span class=\"comment\">// Page fault upcall entry point</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Lab 4 IPC</span></span><br><span class=\"line\">        <span class=\"keyword\">bool</span> env_ipc_recving;           <span class=\"comment\">// Env is blocked receiving</span></span><br><span class=\"line\">        <span class=\"keyword\">void</span> *env_ipc_dstva;            <span class=\"comment\">// VA at which to map received page</span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> env_ipc_value;         <span class=\"comment\">// Data value sent to us</span></span><br><span class=\"line\">        <span class=\"keyword\">envid_t</span> env_ipc_from;           <span class=\"comment\">// envid of the sender</span></span><br><span class=\"line\">        <span class=\"keyword\">int</span> env_ipc_perm;               <span class=\"comment\">// Perm of page mapping received</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n<p>5</p>\n<ul>\n<li>env_ipc_recving<br>env_ipc_recv10</li>\n<li>env_ipc_dstva<br>&lt;=UTOP</li>\n<li>env_ipc_value<br></li>\n<li>env_ipc_from<br>envid</li>\n<li>env_ipc_perm<br></li>\n</ul>\n<h4 id=\"15\"><a href=\"#15\" class=\"headerlink\" title=\"15\"></a>15</h4><p>:</p>\n<blockquote>\n<p><code>kern/syscall.c</code><code>sys_ipc_recvsys_ipc_try_send</code><code>ipc_recvipc_send</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>sys_ipc_recv</code>CPU<code>ENV_NOT_RUNNABLE</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_ipc_recv(<span class=\"keyword\">void</span> *dstva)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (dstva &lt; (<span class=\"keyword\">void</span> *)UTOP &amp;&amp; PGOFF(dstva))</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        curenv-&gt;env_ipc_recving = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        curenv-&gt;env_ipc_dstva = dstva;</span><br><span class=\"line\">        curenv-&gt;env_status = ENV_NOT_RUNNABLE;</span><br><span class=\"line\">        curenv-&gt;env_ipc_from = <span class=\"number\">0</span>;</span><br><span class=\"line\">        sched_yield();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p><code>sys_ipc_try_send</code><code>srcva</code><code>UTOP</code><code>srcva</code><code>env_ipc_recving</code>0<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_ipc_try_send(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">uint32_t</span> value, <span class=\"keyword\">void</span> *srcva, <span class=\"keyword\">unsigned</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\">        <span class=\"keyword\">pte_t</span> *pte;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> PageInfo *pp;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = envid2env(envid, &amp;env, <span class=\"number\">0</span>)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_BAD_ENV;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (env-&gt;env_ipc_recving != <span class=\"literal\">true</span> || env-&gt;env_ipc_from != <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_IPC_NOT_RECV;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (srcva &lt; (<span class=\"keyword\">void</span> *)UTOP &amp;&amp; PGOFF(srcva))</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (srcva &lt; (<span class=\"keyword\">void</span> *)UTOP) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((perm &amp; PTE_P) == <span class=\"number\">0</span> || (perm &amp; PTE_U) == <span class=\"number\">0</span>)</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((perm &amp; ~(PTE_P | PTE_U | PTE_W | PTE_AVAIL)) != <span class=\"number\">0</span>)</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (srcva &lt; (<span class=\"keyword\">void</span> *)UTOP &amp;&amp; (pp = page_lookup(curenv-&gt;env_pgdir, srcva, &amp;pte)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (srcva &lt; (<span class=\"keyword\">void</span> *)UTOP &amp;&amp; (perm &amp; PTE_W) != <span class=\"number\">0</span> &amp;&amp; (*pte &amp; PTE_W) == <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (srcva &lt; (<span class=\"keyword\">void</span> *)UTOP &amp;&amp; env-&gt;env_ipc_dstva != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((r = page_insert(env-&gt;env_pgdir, pp, env-&gt;env_ipc_dstva, perm)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> -E_NO_MEM;</span><br><span class=\"line\">                env-&gt;env_ipc_perm = perm;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        env-&gt;env_ipc_from = curenv-&gt;env_id;</span><br><span class=\"line\">        env-&gt;env_ipc_recving = <span class=\"literal\">false</span>;</span><br><span class=\"line\">        env-&gt;env_ipc_value = value;</span><br><span class=\"line\">        env-&gt;env_status = ENV_RUNNABLE;</span><br><span class=\"line\">        env-&gt;env_tf.tf_regs.reg_eax = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br>2<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int32_t</span></span><br><span class=\"line\">ipc_recv(<span class=\"keyword\">envid_t</span> *from_env_store, <span class=\"keyword\">void</span> *pg, <span class=\"keyword\">int</span> *perm_store)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (pg == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                r = sys_ipc_recv((<span class=\"keyword\">void</span> *)UTOP);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">                r = sys_ipc_recv(pg);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (from_env_store != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                *from_env_store = r &lt; <span class=\"number\">0</span> ? <span class=\"number\">0</span> : thisenv-&gt;env_ipc_from;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (perm_store != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                *perm_store = r &lt; <span class=\"number\">0</span> ? <span class=\"number\">0</span> : thisenv-&gt;env_ipc_perm;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span> thisenv-&gt;env_ipc_value;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">ipc_send(<span class=\"keyword\">envid_t</span> to_env, <span class=\"keyword\">uint32_t</span> val, <span class=\"keyword\">void</span> *pg, <span class=\"keyword\">int</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\">        <span class=\"keyword\">void</span> *dstpg;</span><br><span class=\"line\"></span><br><span class=\"line\">        dstpg = pg != <span class=\"literal\">NULL</span> ? pg : (<span class=\"keyword\">void</span> *)UTOP;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>((r = sys_ipc_try_send(to_env, val, dstpg, perm)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (r != -E_IPC_NOT_RECV)</span><br><span class=\"line\">                        panic(<span class=\"string\">\"ipc_send: send message error %e\"</span>, r);</span><br><span class=\"line\">                sys_yield();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"<h1 id=\"Lab4-\"><a href=\"#Lab4-\" class=\"headerlink\" title=\"Lab4 \"></a>Lab4 </h1><h2 id=\"Part2--copy-on-write-fork\"><a href=\"#Part2--copy-on-write-fork\" class=\"headerlink\" title=\"Part2  copy-on-write fork\"></a>Part2  copy-on-write fork</h2><p>,Unixfork().fork().<br>xv6 Unix <code>fork()</code>,<code>dumbfork()</code>.<code>fork()</code>.<br>,<code>fork()</code><code>exec()</code>, ., shell.,,<code>exec()</code>.</p>\n<p>,Unix,<strong></strong>,.<strong>(copy-on-fork)</strong>.,<code>fork()</code>,,,.,.,Unix,/.,.<code>fork()</code><code>exec()</code><code>exec()</code>,.</p>\n<p>part2, Unix <code>fork()</code>,,.,<code>fork()</code>:<code>fork()</code><code>dumbfork()</code>,.</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>fork()</code>,..<br>:,.,Unix,,,Unix.,.BSS,0,.<br>.Unix,,bug.,.<br>","more":"</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>,JOS<code>entrypoint</code>.<code>sys_env_set_pgfault_upcall</code>.<code>Env</code><code>env_pgfault_upcall</code>.</p>\n<h4 id=\"8\"><a href=\"#8\" class=\"headerlink\" title=\"8\"></a>8</h4><p>:</p>\n<blockquote>\n<p><code>sys_env_set_pgfault_upcall</code>.:,ID,</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>:<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_env_set_pgfault_upcall(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">void</span> *func)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (envid2env(envid, &amp;env, <span class=\"number\">1</span>) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_BAD_ENV;</span><br><span class=\"line\">        env-&gt;env_pgfault_upcall = func;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"/\"></a>/</h4><p>,,<code>ESP</code><code>USTACKTOP</code>,<code>USTACKTOP-PGSIZE USTACKTOP-1</code>.,. .,,,.<br></p>\n<ul>\n<li> [KSTACKTOP, KSTACKTOP-KSTKSIZE]</li>\n<li> [UXSTACKTOP, UXSTACKTOP - PGSIZE]</li>\n<li> [USTACKTOP, UTEXT]</li>\n</ul>\n<p>,,CPU,<code>kern/trap.c</code><code>trap_init_percpu()</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">trap_init_percpu(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"comment\">// Setup a TSS so that we get the right stack</span></span><br><span class=\"line\">        <span class=\"comment\">// when we trap to the kernel.</span></span><br><span class=\"line\">        thiscpu-&gt;cpu_ts.ts_esp0 = KSTACKTOP - cpunum() * (KSTKGAP + KSTKSIZE);</span><br><span class=\"line\">        thiscpu-&gt;cpu_ts.ts_ss0 = GD_KD;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Initialize the TSS slot of the gdt.</span></span><br><span class=\"line\">        gdt[(GD_TSS0 &gt;&gt; <span class=\"number\">3</span>) + cpunum()] = SEG16(STS_T32A, (<span class=\"keyword\">uint32_t</span>) (&amp;thiscpu-&gt;cpu_ts),</span><br><span class=\"line\">                                        <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Taskstate) - <span class=\"number\">1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">        gdt[(GD_TSS0 &gt;&gt; <span class=\"number\">3</span>) + cpunum()].sd_s = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Load the TSS selector (like other segment selectors, the</span></span><br><span class=\"line\">        <span class=\"comment\">// bottom three bits are special; we leave them 0)</span></span><br><span class=\"line\">        ltr(GD_TSS0 + <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> Segdesc) * cpunum());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Load the IDT</span></span><br><span class=\"line\">        lidt(&amp;idt_pd);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>,.</p>\n<blockquote>\n<p>,,<code>trap</code>,,<code>page_fault_handler()</code>.<code>page fault</code>(,<code>panic</code>),<code>UTrapframe</code>.,,.,.</p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>,,,,.,,,,<code>eip</code>,..,,.<br><code>inc / trap.h</code><code>struct Trapframe</code><code>struct UTrapframe</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> UTrapframe &#123;</span><br><span class=\"line\">        <span class=\"comment\">/* information about the fault */</span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> utf_fault_va;  <span class=\"comment\">/* va for T_PGFLT, 0 otherwise */</span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> utf_err;</span><br><span class=\"line\">        <span class=\"comment\">/* trap-time return state */</span></span><br><span class=\"line\">        <span class=\"keyword\">struct</span> PushRegs utf_regs;</span><br><span class=\"line\">        <span class=\"keyword\">uintptr_t</span> utf_eip;</span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> utf_eflags;</span><br><span class=\"line\">        <span class=\"comment\">/* the trap-time stack to return to */</span></span><br><span class=\"line\">        <span class=\"keyword\">uintptr_t</span> utf_esp;</span><br><span class=\"line\">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure></p>\n<p><code>Trapframe</code>,<code>utf_fault_va</code>,,<code>es,ds,ss</code>.,,,,.,<code>Trapframe</code>,<code>UTrapframe</code>.<br>,,<br><strong>&gt;&gt;</strong><br>,<br><strong>&gt;&gt;</strong></p>\n<h4 id=\"9\"><a href=\"#9\" class=\"headerlink\" title=\"9\"></a>9</h4><p>:</p>\n<blockquote>\n<p><code>kern/trap.c</code><code>page_fault_handler</code>, .</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>,4,,.<code>UTrapframe</code>,<code>tf</code>.,,.,,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">page_fault_handler(<span class=\"keyword\">struct</span> Trapframe *tf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> fault_va;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Read processor's CR2 register to find the faulting address</span></span><br><span class=\"line\">        fault_va = rcr2();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Handle kernel-mode page faults.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (tf-&gt;tf_cs == GD_KT)</span><br><span class=\"line\">                panic(<span class=\"string\">\"page_fault in kernel mode, fault address: %d\\n\"</span>, fault_va);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">struct</span> UTrapframe *utf;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (curenv-&gt;env_pgfault_upcall) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (UXSTACKTOP - PGSIZE &lt;= tf-&gt;tf_esp &amp;&amp; tf-&gt;tf_esp &lt;= UXSTACKTOP - <span class=\"number\">1</span>)</span><br><span class=\"line\">                        utf = (<span class=\"keyword\">struct</span> UTrapframe *)(tf-&gt;tf_esp - <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> UTrapframe) - <span class=\"number\">4</span>);</span><br><span class=\"line\">                <span class=\"keyword\">else</span></span><br><span class=\"line\">                        utf = (<span class=\"keyword\">struct</span> UTrapframe *)(UXSTACKTOP - <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> UTrapframe));</span><br><span class=\"line\">                user_mem_assert(curenv, (<span class=\"keyword\">void</span> *)utf, <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> UTrapframe), PTE_U | PTE_W);</span><br><span class=\"line\"></span><br><span class=\"line\">                utf-&gt;utf_fault_va = fault_va;</span><br><span class=\"line\">                utf-&gt;utf_err = tf-&gt;tf_trapno;</span><br><span class=\"line\">                utf-&gt;utf_eip = tf-&gt;tf_eip;</span><br><span class=\"line\">                utf-&gt;utf_eflags = tf-&gt;tf_eflags;</span><br><span class=\"line\">                utf-&gt;utf_esp = tf-&gt;tf_esp;</span><br><span class=\"line\">                utf-&gt;utf_regs = tf-&gt;tf_regs;</span><br><span class=\"line\">                tf-&gt;tf_eip = (<span class=\"keyword\">uint32_t</span>)curenv-&gt;env_pgfault_upcall;</span><br><span class=\"line\">                tf-&gt;tf_esp = (<span class=\"keyword\">uint32_t</span>)utf;</span><br><span class=\"line\">                env_run(curenv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Destroy the environment that caused the fault.</span></span><br><span class=\"line\">        cprintf(<span class=\"string\">\"[%08x] user fault va %08x ip %08x\\n\"</span>,</span><br><span class=\"line\">                curenv-&gt;env_id, fault_va, tf-&gt;tf_eip);</span><br><span class=\"line\">        print_trapframe(tf);</span><br><span class=\"line\">        env_destroy(curenv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>,,,<code>sys_env_set_pgfault_upcall()</code>.</p>\n<h4 id=\"10\"><a href=\"#10\" class=\"headerlink\" title=\"10\"></a>10</h4><p>:</p>\n<blockquote>\n<p><code>lib/pfentry.S</code><code>_pgfault_upcall</code>.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>_pgfault_upcall</code>,,,<code>UTrapframe</code>,,.:<br><code>_pgfault_handler</code>,<br><img src=\"/images/lab4/UStack1.png\" alt=\"UStack1\"><br><code>trap-time esp</code>14,. <code>trap-time esp</code>4,.,<code>esp-4</code>4. <code>trap-time eip</code>4,.<br><img src=\"/images/lab4/UStack2.png\" alt=\"UStack2\"><br>EFLAG,<br><img src=\"/images/lab4/UStack3.png\" alt=\"UStack3\"><br><code>pop esp</code>,<code>ret</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text</span><br><span class=\"line\">.globl _pgfault_upcall</span><br><span class=\"line\">_pgfault_upcall:</span><br><span class=\"line\">        <span class=\"comment\">// Call the C page fault handler.</span></span><br><span class=\"line\">        pushl %esp                      <span class=\"comment\">// function argument: pointer to UTF</span></span><br><span class=\"line\">        movl _pgfault_handler, %eax</span><br><span class=\"line\">        call *%eax</span><br><span class=\"line\">        addl $<span class=\"number\">4</span>, %esp                   <span class=\"comment\">// pop function argument</span></span><br><span class=\"line\"></span><br><span class=\"line\">        movl <span class=\"number\">48</span>(%esp), %ebp</span><br><span class=\"line\">        subl $<span class=\"number\">4</span>, %ebp</span><br><span class=\"line\">        movl %ebp, <span class=\"number\">48</span>(%esp)</span><br><span class=\"line\">        movl <span class=\"number\">40</span>(%esp), %eax</span><br><span class=\"line\">        movl %eax, (%ebp)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Restore the trap-time registers.  After you do this, you can no longer modify any general-purpose registers.</span></span><br><span class=\"line\">        addl $<span class=\"number\">8</span>, %esp</span><br><span class=\"line\">        popal</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Restore eflags from the stack.  After you do this, you can</span></span><br><span class=\"line\">        <span class=\"comment\">// no longer use arithmetic operations or anything else that</span></span><br><span class=\"line\">        <span class=\"comment\">// modifies eflags.</span></span><br><span class=\"line\">        addl $<span class=\"number\">4</span>, %esp</span><br><span class=\"line\">        popfl</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Switch back to the adjusted trap-time stack.</span></span><br><span class=\"line\"></span><br><span class=\"line\">        popl %esp</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Return to re-execute the instruction that faulted.</span></span><br><span class=\"line\">        ret</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"11\"><a href=\"#11\" class=\"headerlink\" title=\"11\"></a>11</h4><p>:</p>\n<blockquote>\n<p><code>lib / pgfault.c</code><code>set_pgfault_handler()</code>,C.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>,,.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">set_pgfault_handler(<span class=\"keyword\">void</span> (*handler)(<span class=\"keyword\">struct</span> UTrapframe *utf))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (_pgfault_handler == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// First time through!</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((r = sys_page_alloc(thisenv-&gt;env_id, (<span class=\"keyword\">void</span> *)(UXSTACKTOP - PGSIZE), PTE_P | PTE_W | PTE_U)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                        panic(<span class=\"string\">\"set_pgfault_handler: %e\"</span>, r);</span><br><span class=\"line\">                sys_env_set_pgfault_upcall(thisenv-&gt;env_id, _pgfault_upcall);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Save handler pointer for assembly to call.</span></span><br><span class=\"line\">        _pgfault_handler = handler;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h3 id=\"-fork\"><a href=\"#-fork\" class=\"headerlink\" title=\" fork\"></a> fork</h3><p><code>copy-on-write fork</code>.<br><code>dumbfork()</code>,<code>fork()</code>,.,.,COW(copy-on-write).,,,page fault,COW,,.</p>\n<h4 id=\"12\"><a href=\"#12\" class=\"headerlink\" title=\"12\"></a>12</h4><p>:</p>\n<blockquote>\n<p><code>lib/fork.c</code><code>fork,duppagepgfault</code>.</p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p>.<code>set_pgfault_handler()</code>,,<code>sys_env_set_pgfault_upcall</code>.<br><code>sys_exofork</code>,<code>ENV_NOT_RUNNABLE</code>.,<code>PTE_P</code>.,,.copy-on-write,fork,.<br></p>\n<ol>\n<li>,(UXSTACKTOP-PGSIZE).</li>\n<li>PFTEMP,.</li>\n<li>,,.</li>\n<li>PFTEMP.</li>\n<li></li>\n</ol>\n</blockquote>\n<p>:<br><code>pgfault</code><code>page fault</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span></span><br><span class=\"line\">pgfault(<span class=\"keyword\">struct</span> UTrapframe *utf)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\">        <span class=\"keyword\">void</span> *addr = (<span class=\"keyword\">void</span> *) utf-&gt;utf_fault_va;</span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> err = utf-&gt;utf_err;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((err &amp; FEC_WR) == <span class=\"number\">0</span> || (uvpt[PGNUM(addr)] &amp; PTE_COW) == <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"pgfault: it's not writable or attempt to access a non-cow page!\"</span>);</span><br><span class=\"line\">        <span class=\"comment\">// Allocate a new page, map it at a temporary location (PFTEMP),</span></span><br><span class=\"line\">        <span class=\"comment\">// copy the data from the old page to the new page, then move the new</span></span><br><span class=\"line\">        <span class=\"comment\">// page to the old page's address.</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">envid_t</span> envid = sys_getenvid();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_alloc(envid, (<span class=\"keyword\">void</span> *)PFTEMP, PTE_P | PTE_W | PTE_U)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"pgfault: page allocation failed %e\"</span>, r);</span><br><span class=\"line\"></span><br><span class=\"line\">        addr = ROUNDDOWN(addr, PGSIZE);</span><br><span class=\"line\">        memmove(PFTEMP, addr, PGSIZE);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_unmap(envid, addr)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"pgfault: page unmap failed %e\"</span>, r);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_map(envid, PFTEMP, envid, addr, PTE_P | PTE_W |PTE_U)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"pgfault: page map failed %e\"</span>, r);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_unmap(envid, PFTEMP)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                panic(<span class=\"string\">\"pgfault: page unmap failed %e\"</span>, r);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><code>pgfault()</code>,<code>panic</code>.<code>PFTEMP</code>,<code>page fault</code>.<code>addr</code>,<code>addr</code><code>PFTEMP</code>,<code>PFTEMP</code>.<br><code>duppage</code>,COW,pn<code>envid</code>pn,COW.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">duppage(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">unsigned</span> pn)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">void</span> *addr;</span><br><span class=\"line\">        <span class=\"keyword\">pte_t</span> pte;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> perm;</span><br><span class=\"line\"></span><br><span class=\"line\">        addr = (<span class=\"keyword\">void</span> *)((<span class=\"keyword\">uint32_t</span>)pn * PGSIZE);</span><br><span class=\"line\">        pte = uvpt[pn];</span><br><span class=\"line\">        perm = PTE_P | PTE_U;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((pte &amp; PTE_W) || (pte &amp; PTE_COW))</span><br><span class=\"line\">                perm |= PTE_COW;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_map(thisenv-&gt;env_id, addr, envid, addr, perm)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"duppage: page remapping failed %e\"</span>, r);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (perm &amp; PTE_COW) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((r = sys_page_map(thisenv-&gt;env_id, addr, thisenv-&gt;env_id, addr, perm)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                        panic(<span class=\"string\">\"duppage: page remapping failed %e\"</span>, r);</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>fork,,<code>UTEXTUXSTACKTOP</code>,,<code>env_alloc</code>.<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">envid_t</span></span><br><span class=\"line\">fork(<span class=\"keyword\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> addr;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> i, j, pn, r;</span><br><span class=\"line\">        <span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> _pgfault_upcall(<span class=\"keyword\">void</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((envid = sys_exofork()) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"sys_exofork failed: %e\"</span>, envid);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> envid;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (envid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                thisenv = &amp;envs[ENVX(sys_getenvid())];</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (i = PDX(UTEXT); i &lt; PDX(UXSTACKTOP); i++) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (uvpd[i] &amp; PTE_P) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">for</span> (j = <span class=\"number\">0</span>; j &lt; NPTENTRIES; j++) &#123;</span><br><span class=\"line\">                                pn = PGNUM(PGADDR(i, j, <span class=\"number\">0</span>));</span><br><span class=\"line\">                                <span class=\"keyword\">if</span> (pn == PGNUM(UXSTACKTOP - PGSIZE))</span><br><span class=\"line\">                                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                                <span class=\"keyword\">if</span> (uvpt[pn] &amp; PTE_P)</span><br><span class=\"line\">                                        duppage(envid, pn);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_alloc(envid, (<span class=\"keyword\">void</span> *)(UXSTACKTOP - PGSIZE), PTE_P | PTE_U | PTE_W)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"fork: page alloc failed %e\"</span>, r);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_map(envid, (<span class=\"keyword\">void</span> *)(UXSTACKTOP - PGSIZE), thisenv-&gt;env_id, PFTEMP, PTE_P | PTE_U | PTE_W)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"fork: page map failed %e\"</span>, r);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        memmove((<span class=\"keyword\">void</span> *)(UXSTACKTOP - PGSIZE), PFTEMP, PGSIZE);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_page_unmap(thisenv-&gt;env_id, PFTEMP)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"fork: page unmap failed %e\"</span>, r);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        sys_env_set_pgfault_upcall(envid, _pgfault_upcall);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = sys_env_set_status(envid, ENV_RUNNABLE)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                panic(<span class=\"string\">\"fork: set child env status failed %e\"</span>, r);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> envid;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Part3-\"><a href=\"#Part3-\" class=\"headerlink\" title=\"Part3 \"></a>Part3 </h2><p>Lab4</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>CPUCPUBootloaderJOS</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>IRQ16IRQ015.IRQIDT, <code>picirq.c</code><code>pic_init</code>IRQ 0-15IDT<code>[IRQ_OFFSET,IRQ_OFFSET+15]</code>.<br><code>inc / trap.h</code> <code>IRQ_OFFSET</code>32.IDT32-47IRQ 0-15IRQ 0.<code>IDT[IRQ_OFFSET + 0]</code><code>IDT[32]</code><code>IRQ_OFFSET</code>,.<br>JOSxv6 Unixxv6<code>FL_IF%eflags</code><code>inc/mmu.h</code>1<code>%eflags</code><code>FL_IF</code>Lab1<code>bootloaded</code>.</p>\n<h4 id=\"12-1\"><a href=\"#12-1\" class=\"headerlink\" title=\"12\"></a>12</h4><p>:</p>\n<blockquote>\n<p><code>kern/trapentry.S</code><code>kern/trap.c</code><code>IDTIRQs0-15</code><code>env_alloc</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>kern/trapentry.S</code><code>IRQ0-15</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TRAPHANDLER(irq0_entry, IRQ_OFFSET + <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq1_entry, IRQ_OFFSET + <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq2_entry, IRQ_OFFSET + <span class=\"number\">2</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq3_entry, IRQ_OFFSET + <span class=\"number\">3</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq4_entry, IRQ_OFFSET + <span class=\"number\">4</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq5_entry, IRQ_OFFSET + <span class=\"number\">5</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq6_entry, IRQ_OFFSET + <span class=\"number\">6</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq7_entry, IRQ_OFFSET + <span class=\"number\">7</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq8_entry, IRQ_OFFSET + <span class=\"number\">8</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq9_entry, IRQ_OFFSET + <span class=\"number\">9</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq10_entry, IRQ_OFFSET + <span class=\"number\">10</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq11_entry, IRQ_OFFSET + <span class=\"number\">11</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq12_entry, IRQ_OFFSET + <span class=\"number\">12</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq13_entry, IRQ_OFFSET + <span class=\"number\">13</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq14_entry, IRQ_OFFSET + <span class=\"number\">14</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">TRAPHANDLER(irq15_entry, IRQ_OFFSET + <span class=\"number\">15</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p>IDT<code>trap_init</code><br><code>env_alloc</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// kern/env_alloc.c</span></span><br><span class=\"line\"><span class=\"comment\">// Also clear the IPC receiving flag.</span></span><br><span class=\"line\">e-&gt;env_ipc_recving = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Set FL_IF so that user environments run with interrupts enabled</span></span><br><span class=\"line\">e-&gt;env_tf.tf_eflags |= FL_IF;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// commit the allocation</span></span><br><span class=\"line\">env_free_list = e-&gt;env_link;</span><br><span class=\"line\">*newenv_store = e;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code>trap_dispatch</code></p>\n<h4 id=\"14\"><a href=\"#14\" class=\"headerlink\" title=\"14\"></a>14</h4><p>:</p>\n<blockquote>\n<p><code>trap_dispatch</code>h<code>sched_yield</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// kern/trap.c</span><br><span class=\"line\"></span><br><span class=\"line\">// Handle clock interrupts. Don&apos;t forget to acknowledge the</span><br><span class=\"line\">// interrupt using lapic_eoi() before calling the scheduler!</span><br><span class=\"line\">if (tf-&gt;tf_trapno == IRQ_OFFSET + IRQ_TIMER) &#123;</span><br><span class=\"line\">                lapic_eoi();</span><br><span class=\"line\">                sched_yield();</span><br><span class=\"line\">                return;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<h4 id=\"-IPC\"><a href=\"#-IPC\" class=\"headerlink\" title=\"(IPC)\"></a>(IPC)</h4><p>IPCJOSIPC<code>recv</code><code>send</code>JOS32\n</p>\n<h4 id=\"IPC\"><a href=\"#IPC\" class=\"headerlink\" title=\"IPC\"></a>IPC</h4><p>JOSIPC<code>Env</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> Env &#123;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Trapframe env_tf;        <span class=\"comment\">// Saved registers</span></span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env_link;           <span class=\"comment\">// Next free Env</span></span><br><span class=\"line\">        <span class=\"keyword\">envid_t</span> env_id;                 <span class=\"comment\">// Unique environment identifier</span></span><br><span class=\"line\">        <span class=\"keyword\">envid_t</span> env_parent_id;          <span class=\"comment\">// env_id of this env's parent</span></span><br><span class=\"line\">        <span class=\"keyword\">enum</span> EnvType env_type;          <span class=\"comment\">// Indicates special system environments</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> env_status;            <span class=\"comment\">// Status of the environment</span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> env_runs;              <span class=\"comment\">// Number of times environment has run</span></span><br><span class=\"line\">        <span class=\"keyword\">int</span> env_cpunum;                 <span class=\"comment\">// The CPU that the env is running on</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Address space</span></span><br><span class=\"line\">        <span class=\"keyword\">pde_t</span> *env_pgdir;               <span class=\"comment\">// Kernel virtual address of page dir</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Exception handling</span></span><br><span class=\"line\">        <span class=\"keyword\">void</span> *env_pgfault_upcall;       <span class=\"comment\">// Page fault upcall entry point</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Lab 4 IPC</span></span><br><span class=\"line\">        <span class=\"keyword\">bool</span> env_ipc_recving;           <span class=\"comment\">// Env is blocked receiving</span></span><br><span class=\"line\">        <span class=\"keyword\">void</span> *env_ipc_dstva;            <span class=\"comment\">// VA at which to map received page</span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> env_ipc_value;         <span class=\"comment\">// Data value sent to us</span></span><br><span class=\"line\">        <span class=\"keyword\">envid_t</span> env_ipc_from;           <span class=\"comment\">// envid of the sender</span></span><br><span class=\"line\">        <span class=\"keyword\">int</span> env_ipc_perm;               <span class=\"comment\">// Perm of page mapping received</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n<p>5</p>\n<ul>\n<li>env_ipc_recving<br>env_ipc_recv10</li>\n<li>env_ipc_dstva<br>&lt;=UTOP</li>\n<li>env_ipc_value<br></li>\n<li>env_ipc_from<br>envid</li>\n<li>env_ipc_perm<br></li>\n</ul>\n<h4 id=\"15\"><a href=\"#15\" class=\"headerlink\" title=\"15\"></a>15</h4><p>:</p>\n<blockquote>\n<p><code>kern/syscall.c</code><code>sys_ipc_recvsys_ipc_try_send</code><code>ipc_recvipc_send</code></p>\n</blockquote>\n<p>:</p>\n<blockquote>\n<p><code>sys_ipc_recv</code>CPU<code>ENV_NOT_RUNNABLE</code><br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_ipc_recv(<span class=\"keyword\">void</span> *dstva)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (dstva &lt; (<span class=\"keyword\">void</span> *)UTOP &amp;&amp; PGOFF(dstva))</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        curenv-&gt;env_ipc_recving = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        curenv-&gt;env_ipc_dstva = dstva;</span><br><span class=\"line\">        curenv-&gt;env_status = ENV_NOT_RUNNABLE;</span><br><span class=\"line\">        curenv-&gt;env_ipc_from = <span class=\"number\">0</span>;</span><br><span class=\"line\">        sched_yield();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n</blockquote>\n<p><code>sys_ipc_try_send</code><code>srcva</code><code>UTOP</code><code>srcva</code><code>env_ipc_recving</code>0<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span></span><br><span class=\"line\">sys_ipc_try_send(<span class=\"keyword\">envid_t</span> envid, <span class=\"keyword\">uint32_t</span> value, <span class=\"keyword\">void</span> *srcva, <span class=\"keyword\">unsigned</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\">        <span class=\"keyword\">pte_t</span> *pte;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> PageInfo *pp;</span><br><span class=\"line\">        <span class=\"keyword\">struct</span> Env *env;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((r = envid2env(envid, &amp;env, <span class=\"number\">0</span>)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_BAD_ENV;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (env-&gt;env_ipc_recving != <span class=\"literal\">true</span> || env-&gt;env_ipc_from != <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_IPC_NOT_RECV;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (srcva &lt; (<span class=\"keyword\">void</span> *)UTOP &amp;&amp; PGOFF(srcva))</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (srcva &lt; (<span class=\"keyword\">void</span> *)UTOP) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((perm &amp; PTE_P) == <span class=\"number\">0</span> || (perm &amp; PTE_U) == <span class=\"number\">0</span>)</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((perm &amp; ~(PTE_P | PTE_U | PTE_W | PTE_AVAIL)) != <span class=\"number\">0</span>)</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (srcva &lt; (<span class=\"keyword\">void</span> *)UTOP &amp;&amp; (pp = page_lookup(curenv-&gt;env_pgdir, srcva, &amp;pte)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (srcva &lt; (<span class=\"keyword\">void</span> *)UTOP &amp;&amp; (perm &amp; PTE_W) != <span class=\"number\">0</span> &amp;&amp; (*pte &amp; PTE_W) == <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> -E_INVAL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (srcva &lt; (<span class=\"keyword\">void</span> *)UTOP &amp;&amp; env-&gt;env_ipc_dstva != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((r = page_insert(env-&gt;env_pgdir, pp, env-&gt;env_ipc_dstva, perm)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> -E_NO_MEM;</span><br><span class=\"line\">                env-&gt;env_ipc_perm = perm;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        env-&gt;env_ipc_from = curenv-&gt;env_id;</span><br><span class=\"line\">        env-&gt;env_ipc_recving = <span class=\"literal\">false</span>;</span><br><span class=\"line\">        env-&gt;env_ipc_value = value;</span><br><span class=\"line\">        env-&gt;env_status = ENV_RUNNABLE;</span><br><span class=\"line\">        env-&gt;env_tf.tf_regs.reg_eax = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br>2<br><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int32_t</span></span><br><span class=\"line\">ipc_recv(<span class=\"keyword\">envid_t</span> *from_env_store, <span class=\"keyword\">void</span> *pg, <span class=\"keyword\">int</span> *perm_store)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (pg == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                r = sys_ipc_recv((<span class=\"keyword\">void</span> *)UTOP);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">                r = sys_ipc_recv(pg);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (from_env_store != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                *from_env_store = r &lt; <span class=\"number\">0</span> ? <span class=\"number\">0</span> : thisenv-&gt;env_ipc_from;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (perm_store != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                *perm_store = r &lt; <span class=\"number\">0</span> ? <span class=\"number\">0</span> : thisenv-&gt;env_ipc_perm;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (r &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> r;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span> thisenv-&gt;env_ipc_value;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">void</span></span><br><span class=\"line\">ipc_send(<span class=\"keyword\">envid_t</span> to_env, <span class=\"keyword\">uint32_t</span> val, <span class=\"keyword\">void</span> *pg, <span class=\"keyword\">int</span> perm)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> r;</span><br><span class=\"line\">        <span class=\"keyword\">void</span> *dstpg;</span><br><span class=\"line\"></span><br><span class=\"line\">        dstpg = pg != <span class=\"literal\">NULL</span> ? pg : (<span class=\"keyword\">void</span> *)UTOP;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>((r = sys_ipc_try_send(to_env, val, dstpg, perm)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (r != -E_IPC_NOT_RECV)</span><br><span class=\"line\">                        panic(<span class=\"string\">\"ipc_send: send message error %e\"</span>, r);</span><br><span class=\"line\">                sys_yield();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>"},{"title":"go internal - memory model","date":"2018-05-30T16:00:00.000Z","update":"2018/05/31","_content":"## what is memory model\nFrom Wiki[3], the memory model is defined as follows:\n> In computing, a memory model describes the interactions of threads through memory and their shared use of the data.\n\nThe context is **multi-thread**, which is sth about concurrency/synchronization.\n\nAt the time when a computer only has one core/cpu, memory is owned by the single thread, in which instructions has a well-defined order. As time goes by, we have multi-cpus/multi-cores-one-cpu allowing us to executing more than one thread at the same time.The problem is that we only have one memory, and the set of threads are always cooperating with each other to cope with a whole task instead of being independent.They need communication(known as **IPC: inter-process communicaiton**), which have two methods:\n* share memory\n* message passing\n\nThe latter is used in the network/distributed system, we will leave it aside.The formmer defines a n-to-1 model, which we need to deal with the logic of the program - the execution order of threads happening at the same time.That's when we need the memory model:\n\n<!-- more -->\n\n## memory model .vs. memory layout\nNotice that memory model is different from the notion of memory layout.\nThe memory layout defines when a program is running, how the parts of the process is laid in the memory. 2 examples:\nC memory layout[7]\n![C memory layout](/images/imgs/memoryLayoutC.jpg)\n\nJava memory architecture[8]\n![Jave mem arc](/images/imgs/javaMemArc.png)\n\n\n## golang memory:\n\n### atomic operation\n* a instruction can't be partitioned in mechine-level, which is the smallest element of a program.\n* The atomic operation is low-level concepts, which means most statements we code in high-level language is not atomic.Don't take is for granted. eg: `a += 1` will be decomposed as `load a;a+1;store a`\n* a atomic operation is not a instantaneous operation, it lasts for a while. As a result, we can regard it as a operation with a start point and a end point, which need some time to complete. \n\n\n### happens before\n> happens before\n> a partial order on the execution of memory operations in a Go program, to specify the requirements of reads and writes, we define happens before, .\n>  If event e1 happens before event e2, then we say that e2 happens after e1.\n>   Also, if e1 does not happen before e2 and does not happen after e2, then we say that e1 and e2 happen concurrently\n\n* single goroutine\n*Within a single goroutine, the happens-before order is the order expressed by the program.*\n\n* multi goroutine/concurrency\n> memory visibility\nA read r of a variable v is allowed to observe a write w to v if both of the following hold:\n\t* r does not happen before w.\n\t* There is no other write w' to v that happens after w but before r.\nTo guarantee that a read r of a variable v observes a particular write w to v, ensure that w is the only write r is allowed to observe. That is, r is guaranteed to observe w if both of the following hold:\n\t* w happens before r.\n\t* Any other write to the shared variable v either happens before w or after r.\nThis pair of conditions is stronger than the first pair; it requires that there are no other writes happening concurrently with w or r.\n\n *When multiple goroutines access a shared variable v, they must use synchronization events to establish happens-before conditions that ensure reads observe the desired writes.*\n \n2 point need notice:\n* The initialization of variable v with the zero value for v's type behaves as a write in the memory model.\n* Reads and writes of values larger than a single machine word behave as multiple machine-word-sized operations in an unspecified order.\n \n \n \n### synchronization\n \n \n#### `init()`\n*If a package p imports package q, the completion of q's init functions **happens before** the start of any of p's.*\n\n#### goroutine creation\n*The `go` statement that starts a new goroutine **happens before** the goroutine's execution begins.*\n\n#### goroutine destruction\n*The exit of a goroutine is not guaranteed to happen before any event in the program.*\n\n\n#### channel\n4 rules\n* *A send on a channel **happens before** the corresponding receive from that channel completes.*\n* *The closing of a channel **happens before** a receive that returns a zero value because the channel is closed.*\n* *A receive from an unbuffered channel **happens before** the send on that channel completes.*\n* *The kth receive on a channel with capacity C **happens before** the k+Cth send from that channel completes.*\n\n\nsynced goroutine: `a = \"hello, world\"` - `<-c`-`print(a)`\n```go\nvar c = make(chan int, 10)\nvar a string\n\nfunc f() {\n\ta = \"hello, world\"\n\tc <- 0\n}\n\nfunc main() {\n\tgo f()\n\t<-c\n\tprint(a)\n}\n```\n\nbufferd channel implements a semphone:\n```go\nvar limit = make(chan int, 3)\n\nfunc main() {\n\tfor _, w := range work {\n\t\tgo func(w func()) {\n\t\t\tlimit <- 1\n\t\t\tw()\n\t\t\t<-limit\n\t\t}(w)\n\t}\n\tselect{}\n}\n```\n\n#### lock\n* *For any sync.Mutex or sync.RWMutex variable l and n < m, call n of l.Unlock() **happens before** call m of l.Lock() returns.*\n\n* *For any call to l.RLock on a sync.RWMutex variable l, there is an n such that the l.RLock happens (returns) after call n to l.Unlock and the matching l.RUnlock **happens before** call n+1 to l.Lock.*\n\n\n#### once\n*A single call of f() from once.Do(f) **happens (returns) before** any call of once.Do(f) returns.*\n\n\n### incorrect sync\nAll following error can be seen as incorrect implicit sync, don't take for granted. The solution is: **explict synchronizaion**.\n\n#### Error1: 2 goroutine without sync has no happen-before relation\nthe program may print 2 1 or 2 0 \n```go\nvar a, b int\n\nfunc f() {\n\ta = 1\n\tb = 2\n}\n\nfunc g() {\n\tprint(b)\n\tprint(a)\n}\n\nfunc main() {\n\tgo f()\n\tg()\n}\n```\n\n#### Error2: double-checking locking make no happens before relation \nmay print nothing\n```go\nvar a string\nvar done bool\n\nfunc setup() {\n\ta = \"hello, world\"\n\tdone = true\n}\n\nfunc doprint() {\n\tif !done {\n\t\tonce.Do(setup)\n\t}\n\tprint(a)\n}\n\nfunc twoprint() {\n\tgo doprint()\n\tgo doprint()\n}\n```\n\n#### Error3: waiting for a value make no happen before relation\nmay print nothing or infinite loop\n```go\nvar a string\nvar done bool\n\nfunc setup() {\n\ta = \"hello, world\"\n\tdone = true\n}\n\nfunc main() {\n\tgo setup()\n\tfor !done {\n\t}\n\tprint(a)\n}\n```\n\n\n## Digression\nIt's in 1978 that 2 papers having a enourmous impact on concurrent/distributed system published. One is **< Time, clocks, and the ordering of events in a distributed system >** written by Leslie Lamport - father of Paxos and Latex, laying the foundation for analysis of dissys. Another is **< Communicating sequential processes>** by CAR Hoare - the creator of `quicksort`, CSP plays a huge role in concurrent system, which also is the theory idea behind goroutine and channel.What a year!\n\n## refer\n* 1.[golang : memory model](https://golang.org/ref/mem)\n* 2.[go](https://studygolang.com/articles/01176)\n* 3.[wiki: memory barrier](https://en.wikipedia.org/wiki/Memory_barrier)\n* 4.[wiki: memory model](https://www.quora.com/What-is-a-memory-model-in-C)\n* 5.[quora: what is memory model in C](https://www.quora.com/What-is-a-memory-model-in-C)\n* 6.[lec: memory model](https://www.cs.princeton.edu/courses/archive/fall10/cos597C/docs/memory-models.pdf)\n*  7.[Memory Layout of C Programs](https://www.geeksforgeeks.org/memory-layout-of-c-program/)\n*  8.[Memory Architecture Of JVM(Runtime Data Areas)](https://hackthejava.wordpress.com/2015/01/09/memory-architecture-by-jvmruntime-data-areas/)\n","source":"_posts/go internal: memory model.md","raw":"---\ntitle: go internal - memory model\ntags: go\ndate: 2018/05/31\nupdate: 2018/05/31\n---\n## what is memory model\nFrom Wiki[3], the memory model is defined as follows:\n> In computing, a memory model describes the interactions of threads through memory and their shared use of the data.\n\nThe context is **multi-thread**, which is sth about concurrency/synchronization.\n\nAt the time when a computer only has one core/cpu, memory is owned by the single thread, in which instructions has a well-defined order. As time goes by, we have multi-cpus/multi-cores-one-cpu allowing us to executing more than one thread at the same time.The problem is that we only have one memory, and the set of threads are always cooperating with each other to cope with a whole task instead of being independent.They need communication(known as **IPC: inter-process communicaiton**), which have two methods:\n* share memory\n* message passing\n\nThe latter is used in the network/distributed system, we will leave it aside.The formmer defines a n-to-1 model, which we need to deal with the logic of the program - the execution order of threads happening at the same time.That's when we need the memory model:\n\n<!-- more -->\n\n## memory model .vs. memory layout\nNotice that memory model is different from the notion of memory layout.\nThe memory layout defines when a program is running, how the parts of the process is laid in the memory. 2 examples:\nC memory layout[7]\n![C memory layout](/images/imgs/memoryLayoutC.jpg)\n\nJava memory architecture[8]\n![Jave mem arc](/images/imgs/javaMemArc.png)\n\n\n## golang memory:\n\n### atomic operation\n* a instruction can't be partitioned in mechine-level, which is the smallest element of a program.\n* The atomic operation is low-level concepts, which means most statements we code in high-level language is not atomic.Don't take is for granted. eg: `a += 1` will be decomposed as `load a;a+1;store a`\n* a atomic operation is not a instantaneous operation, it lasts for a while. As a result, we can regard it as a operation with a start point and a end point, which need some time to complete. \n\n\n### happens before\n> happens before\n> a partial order on the execution of memory operations in a Go program, to specify the requirements of reads and writes, we define happens before, .\n>  If event e1 happens before event e2, then we say that e2 happens after e1.\n>   Also, if e1 does not happen before e2 and does not happen after e2, then we say that e1 and e2 happen concurrently\n\n* single goroutine\n*Within a single goroutine, the happens-before order is the order expressed by the program.*\n\n* multi goroutine/concurrency\n> memory visibility\nA read r of a variable v is allowed to observe a write w to v if both of the following hold:\n\t* r does not happen before w.\n\t* There is no other write w' to v that happens after w but before r.\nTo guarantee that a read r of a variable v observes a particular write w to v, ensure that w is the only write r is allowed to observe. That is, r is guaranteed to observe w if both of the following hold:\n\t* w happens before r.\n\t* Any other write to the shared variable v either happens before w or after r.\nThis pair of conditions is stronger than the first pair; it requires that there are no other writes happening concurrently with w or r.\n\n *When multiple goroutines access a shared variable v, they must use synchronization events to establish happens-before conditions that ensure reads observe the desired writes.*\n \n2 point need notice:\n* The initialization of variable v with the zero value for v's type behaves as a write in the memory model.\n* Reads and writes of values larger than a single machine word behave as multiple machine-word-sized operations in an unspecified order.\n \n \n \n### synchronization\n \n \n#### `init()`\n*If a package p imports package q, the completion of q's init functions **happens before** the start of any of p's.*\n\n#### goroutine creation\n*The `go` statement that starts a new goroutine **happens before** the goroutine's execution begins.*\n\n#### goroutine destruction\n*The exit of a goroutine is not guaranteed to happen before any event in the program.*\n\n\n#### channel\n4 rules\n* *A send on a channel **happens before** the corresponding receive from that channel completes.*\n* *The closing of a channel **happens before** a receive that returns a zero value because the channel is closed.*\n* *A receive from an unbuffered channel **happens before** the send on that channel completes.*\n* *The kth receive on a channel with capacity C **happens before** the k+Cth send from that channel completes.*\n\n\nsynced goroutine: `a = \"hello, world\"` - `<-c`-`print(a)`\n```go\nvar c = make(chan int, 10)\nvar a string\n\nfunc f() {\n\ta = \"hello, world\"\n\tc <- 0\n}\n\nfunc main() {\n\tgo f()\n\t<-c\n\tprint(a)\n}\n```\n\nbufferd channel implements a semphone:\n```go\nvar limit = make(chan int, 3)\n\nfunc main() {\n\tfor _, w := range work {\n\t\tgo func(w func()) {\n\t\t\tlimit <- 1\n\t\t\tw()\n\t\t\t<-limit\n\t\t}(w)\n\t}\n\tselect{}\n}\n```\n\n#### lock\n* *For any sync.Mutex or sync.RWMutex variable l and n < m, call n of l.Unlock() **happens before** call m of l.Lock() returns.*\n\n* *For any call to l.RLock on a sync.RWMutex variable l, there is an n such that the l.RLock happens (returns) after call n to l.Unlock and the matching l.RUnlock **happens before** call n+1 to l.Lock.*\n\n\n#### once\n*A single call of f() from once.Do(f) **happens (returns) before** any call of once.Do(f) returns.*\n\n\n### incorrect sync\nAll following error can be seen as incorrect implicit sync, don't take for granted. The solution is: **explict synchronizaion**.\n\n#### Error1: 2 goroutine without sync has no happen-before relation\nthe program may print 2 1 or 2 0 \n```go\nvar a, b int\n\nfunc f() {\n\ta = 1\n\tb = 2\n}\n\nfunc g() {\n\tprint(b)\n\tprint(a)\n}\n\nfunc main() {\n\tgo f()\n\tg()\n}\n```\n\n#### Error2: double-checking locking make no happens before relation \nmay print nothing\n```go\nvar a string\nvar done bool\n\nfunc setup() {\n\ta = \"hello, world\"\n\tdone = true\n}\n\nfunc doprint() {\n\tif !done {\n\t\tonce.Do(setup)\n\t}\n\tprint(a)\n}\n\nfunc twoprint() {\n\tgo doprint()\n\tgo doprint()\n}\n```\n\n#### Error3: waiting for a value make no happen before relation\nmay print nothing or infinite loop\n```go\nvar a string\nvar done bool\n\nfunc setup() {\n\ta = \"hello, world\"\n\tdone = true\n}\n\nfunc main() {\n\tgo setup()\n\tfor !done {\n\t}\n\tprint(a)\n}\n```\n\n\n## Digression\nIt's in 1978 that 2 papers having a enourmous impact on concurrent/distributed system published. One is **< Time, clocks, and the ordering of events in a distributed system >** written by Leslie Lamport - father of Paxos and Latex, laying the foundation for analysis of dissys. Another is **< Communicating sequential processes>** by CAR Hoare - the creator of `quicksort`, CSP plays a huge role in concurrent system, which also is the theory idea behind goroutine and channel.What a year!\n\n## refer\n* 1.[golang : memory model](https://golang.org/ref/mem)\n* 2.[go](https://studygolang.com/articles/01176)\n* 3.[wiki: memory barrier](https://en.wikipedia.org/wiki/Memory_barrier)\n* 4.[wiki: memory model](https://www.quora.com/What-is-a-memory-model-in-C)\n* 5.[quora: what is memory model in C](https://www.quora.com/What-is-a-memory-model-in-C)\n* 6.[lec: memory model](https://www.cs.princeton.edu/courses/archive/fall10/cos597C/docs/memory-models.pdf)\n*  7.[Memory Layout of C Programs](https://www.geeksforgeeks.org/memory-layout-of-c-program/)\n*  8.[Memory Architecture Of JVM(Runtime Data Areas)](https://hackthejava.wordpress.com/2015/01/09/memory-architecture-by-jvmruntime-data-areas/)\n","slug":"go internal: memory model","published":1,"updated":"2018-05-31T17:35:04.875Z","_id":"cjhutcwzw0000utam71opk03u","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"what-is-memory-model\"><a href=\"#what-is-memory-model\" class=\"headerlink\" title=\"what is memory model\"></a>what is memory model</h2><p>From Wiki[3], the memory model is defined as follows:</p>\n<blockquote>\n<p>In computing, a memory model describes the interactions of threads through memory and their shared use of the data.</p>\n</blockquote>\n<p>The context is <strong>multi-thread</strong>, which is sth about concurrency/synchronization.</p>\n<p>At the time when a computer only has one core/cpu, memory is owned by the single thread, in which instructions has a well-defined order. As time goes by, we have multi-cpus/multi-cores-one-cpu allowing us to executing more than one thread at the same time.The problem is that we only have one memory, and the set of threads are always cooperating with each other to cope with a whole task instead of being independent.They need communication(known as <strong>IPC: inter-process communicaiton</strong>), which have two methods:</p>\n<ul>\n<li>share memory</li>\n<li>message passing</li>\n</ul>\n<p>The latter is used in the network/distributed system, we will leave it aside.The formmer defines a n-to-1 model, which we need to deal with the logic of the program - the execution order of threads happening at the same time.Thats when we need the memory model:</p>\n<a id=\"more\"></a>\n<h2 id=\"memory-model-vs-memory-layout\"><a href=\"#memory-model-vs-memory-layout\" class=\"headerlink\" title=\"memory model .vs. memory layout\"></a>memory model .vs. memory layout</h2><p>Notice that memory model is different from the notion of memory layout.<br>The memory layout defines when a program is running, how the parts of the process is laid in the memory. 2 examples:<br>C memory layout[7]<br><img src=\"/images/imgs/memoryLayoutC.jpg\" alt=\"C memory layout\"></p>\n<p>Java memory architecture[8]<br><img src=\"/images/imgs/javaMemArc.png\" alt=\"Jave mem arc\"></p>\n<h2 id=\"golang-memory\"><a href=\"#golang-memory\" class=\"headerlink\" title=\"golang memory:\"></a>golang memory:</h2><h3 id=\"atomic-operation\"><a href=\"#atomic-operation\" class=\"headerlink\" title=\"atomic operation\"></a>atomic operation</h3><ul>\n<li>a instruction cant be partitioned in mechine-level, which is the smallest element of a program.</li>\n<li>The atomic operation is low-level concepts, which means most statements we code in high-level language is not atomic.Dont take is for granted. eg: <code>a += 1</code> will be decomposed as <code>load a;a+1;store a</code></li>\n<li>a atomic operation is not a instantaneous operation, it lasts for a while. As a result, we can regard it as a operation with a start point and a end point, which need some time to complete. </li>\n</ul>\n<h3 id=\"happens-before\"><a href=\"#happens-before\" class=\"headerlink\" title=\"happens before\"></a>happens before</h3><blockquote>\n<p>happens before<br>a partial order on the execution of memory operations in a Go program, to specify the requirements of reads and writes, we define happens before, .<br> If event e1 happens before event e2, then we say that e2 happens after e1.<br>  Also, if e1 does not happen before e2 and does not happen after e2, then we say that e1 and e2 happen concurrently</p>\n</blockquote>\n<ul>\n<li><p>single goroutine<br><em>Within a single goroutine, the happens-before order is the order expressed by the program.</em></p>\n</li>\n<li><p>multi goroutine/concurrency</p>\n<blockquote>\n<p>memory visibility<br>A read r of a variable v is allowed to observe a write w to v if both of the following hold:</p>\n<ul>\n<li>r does not happen before w.</li>\n<li>There is no other write w to v that happens after w but before r.<br>To guarantee that a read r of a variable v observes a particular write w to v, ensure that w is the only write r is allowed to observe. That is, r is guaranteed to observe w if both of the following hold:</li>\n<li>w happens before r.</li>\n<li>Any other write to the shared variable v either happens before w or after r.<br>This pair of conditions is stronger than the first pair; it requires that there are no other writes happening concurrently with w or r.</li>\n</ul>\n</blockquote>\n<p><em>When multiple goroutines access a shared variable v, they must use synchronization events to establish happens-before conditions that ensure reads observe the desired writes.</em></p>\n</li>\n</ul>\n<p>2 point need notice:</p>\n<ul>\n<li>The initialization of variable v with the zero value for vs type behaves as a write in the memory model.</li>\n<li>Reads and writes of values larger than a single machine word behave as multiple machine-word-sized operations in an unspecified order.</li>\n</ul>\n<h3 id=\"synchronization\"><a href=\"#synchronization\" class=\"headerlink\" title=\"synchronization\"></a>synchronization</h3><h4 id=\"init\"><a href=\"#init\" class=\"headerlink\" title=\"init()\"></a><code>init()</code></h4><p><em>If a package p imports package q, the completion of qs init functions <strong>happens before</strong> the start of any of ps.</em></p>\n<h4 id=\"goroutine-creation\"><a href=\"#goroutine-creation\" class=\"headerlink\" title=\"goroutine creation\"></a>goroutine creation</h4><p><em>The <code>go</code> statement that starts a new goroutine <strong>happens before</strong> the goroutines execution begins.</em></p>\n<h4 id=\"goroutine-destruction\"><a href=\"#goroutine-destruction\" class=\"headerlink\" title=\"goroutine destruction\"></a>goroutine destruction</h4><p><em>The exit of a goroutine is not guaranteed to happen before any event in the program.</em></p>\n<h4 id=\"channel\"><a href=\"#channel\" class=\"headerlink\" title=\"channel\"></a>channel</h4><p>4 rules</p>\n<ul>\n<li><em>A send on a channel <strong>happens before</strong> the corresponding receive from that channel completes.</em></li>\n<li><em>The closing of a channel <strong>happens before</strong> a receive that returns a zero value because the channel is closed.</em></li>\n<li><em>A receive from an unbuffered channel <strong>happens before</strong> the send on that channel completes.</em></li>\n<li><em>The kth receive on a channel with capacity C <strong>happens before</strong> the k+Cth send from that channel completes.</em></li>\n</ul>\n<p>synced goroutine: <code>a = &quot;hello, world&quot;</code> - <code>&lt;-c</code>-<code>print(a)</code><br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> c = <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">10</span>)</span><br><span class=\"line\"><span class=\"keyword\">var</span> a <span class=\"keyword\">string</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">f</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ta = <span class=\"string\">\"hello, world\"</span></span><br><span class=\"line\">\tc &lt;- <span class=\"number\">0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> f()</span><br><span class=\"line\">\t&lt;-c</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(a)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>bufferd channel implements a semphone:<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> limit = <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, w := <span class=\"keyword\">range</span> work &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(w <span class=\"keyword\">func</span>()</span>)</span> &#123;</span><br><span class=\"line\">\t\t\tlimit &lt;- <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\tw()</span><br><span class=\"line\">\t\t\t&lt;-limit</span><br><span class=\"line\">\t\t&#125;(w)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">select</span>&#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"lock\"><a href=\"#lock\" class=\"headerlink\" title=\"lock\"></a>lock</h4><ul>\n<li><p><em>For any sync.Mutex or sync.RWMutex variable l and n &lt; m, call n of l.Unlock() <strong>happens before</strong> call m of l.Lock() returns.</em></p>\n</li>\n<li><p><em>For any call to l.RLock on a sync.RWMutex variable l, there is an n such that the l.RLock happens (returns) after call n to l.Unlock and the matching l.RUnlock <strong>happens before</strong> call n+1 to l.Lock.</em></p>\n</li>\n</ul>\n<h4 id=\"once\"><a href=\"#once\" class=\"headerlink\" title=\"once\"></a>once</h4><p><em>A single call of f() from once.Do(f) <strong>happens (returns) before</strong> any call of once.Do(f) returns.</em></p>\n<h3 id=\"incorrect-sync\"><a href=\"#incorrect-sync\" class=\"headerlink\" title=\"incorrect sync\"></a>incorrect sync</h3><p>All following error can be seen as incorrect implicit sync, dont take for granted. The solution is: <strong>explict synchronizaion</strong>.</p>\n<h4 id=\"Error1-2-goroutine-without-sync-has-no-happen-before-relation\"><a href=\"#Error1-2-goroutine-without-sync-has-no-happen-before-relation\" class=\"headerlink\" title=\"Error1: 2 goroutine without sync has no happen-before relation\"></a>Error1: 2 goroutine without sync has no happen-before relation</h4><p>the program may print 2 1 or 2 0<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> a, b <span class=\"keyword\">int</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">f</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ta = <span class=\"number\">1</span></span><br><span class=\"line\">\tb = <span class=\"number\">2</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">g</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(b)</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(a)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> f()</span><br><span class=\"line\">\tg()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"Error2-double-checking-locking-make-no-happens-before-relation\"><a href=\"#Error2-double-checking-locking-make-no-happens-before-relation\" class=\"headerlink\" title=\"Error2: double-checking locking make no happens before relation\"></a>Error2: double-checking locking make no happens before relation</h4><p>may print nothing<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> a <span class=\"keyword\">string</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> done <span class=\"keyword\">bool</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">setup</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ta = <span class=\"string\">\"hello, world\"</span></span><br><span class=\"line\">\tdone = <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">doprint</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !done &#123;</span><br><span class=\"line\">\t\tonce.Do(setup)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(a)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">twoprint</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> doprint()</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> doprint()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"Error3-waiting-for-a-value-make-no-happen-before-relation\"><a href=\"#Error3-waiting-for-a-value-make-no-happen-before-relation\" class=\"headerlink\" title=\"Error3: waiting for a value make no happen before relation\"></a>Error3: waiting for a value make no happen before relation</h4><p>may print nothing or infinite loop<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> a <span class=\"keyword\">string</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> done <span class=\"keyword\">bool</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">setup</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ta = <span class=\"string\">\"hello, world\"</span></span><br><span class=\"line\">\tdone = <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> setup()</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> !done &#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(a)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Digression\"><a href=\"#Digression\" class=\"headerlink\" title=\"Digression\"></a>Digression</h2><p>Its in 1978 that 2 papers having a enourmous impact on concurrent/distributed system published. One is <strong>&lt; Time, clocks, and the ordering of events in a distributed system &gt;</strong> written by Leslie Lamport - father of Paxos and Latex, laying the foundation for analysis of dissys. Another is <strong>&lt; Communicating sequential processes&gt;</strong> by CAR Hoare - the creator of <code>quicksort</code>, CSP plays a huge role in concurrent system, which also is the theory idea behind goroutine and channel.What a year!</p>\n<h2 id=\"refer\"><a href=\"#refer\" class=\"headerlink\" title=\"refer\"></a>refer</h2><ul>\n<li>1.<a href=\"https://golang.org/ref/mem\" target=\"_blank\" rel=\"noopener\">golang : memory model</a></li>\n<li>2.<a href=\"https://studygolang.com/articles/01176\" target=\"_blank\" rel=\"noopener\">go</a></li>\n<li>3.<a href=\"https://en.wikipedia.org/wiki/Memory_barrier\" target=\"_blank\" rel=\"noopener\">wiki: memory barrier</a></li>\n<li>4.<a href=\"https://www.quora.com/What-is-a-memory-model-in-C\" target=\"_blank\" rel=\"noopener\">wiki: memory model</a></li>\n<li>5.<a href=\"https://www.quora.com/What-is-a-memory-model-in-C\" target=\"_blank\" rel=\"noopener\">quora: what is memory model in C</a></li>\n<li>6.<a href=\"https://www.cs.princeton.edu/courses/archive/fall10/cos597C/docs/memory-models.pdf\" target=\"_blank\" rel=\"noopener\">lec: memory model</a></li>\n<li>7.<a href=\"https://www.geeksforgeeks.org/memory-layout-of-c-program/\" target=\"_blank\" rel=\"noopener\">Memory Layout of C Programs</a></li>\n<li>8.<a href=\"https://hackthejava.wordpress.com/2015/01/09/memory-architecture-by-jvmruntime-data-areas/\" target=\"_blank\" rel=\"noopener\">Memory Architecture Of JVM(Runtime Data Areas)</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h2 id=\"what-is-memory-model\"><a href=\"#what-is-memory-model\" class=\"headerlink\" title=\"what is memory model\"></a>what is memory model</h2><p>From Wiki[3], the memory model is defined as follows:</p>\n<blockquote>\n<p>In computing, a memory model describes the interactions of threads through memory and their shared use of the data.</p>\n</blockquote>\n<p>The context is <strong>multi-thread</strong>, which is sth about concurrency/synchronization.</p>\n<p>At the time when a computer only has one core/cpu, memory is owned by the single thread, in which instructions has a well-defined order. As time goes by, we have multi-cpus/multi-cores-one-cpu allowing us to executing more than one thread at the same time.The problem is that we only have one memory, and the set of threads are always cooperating with each other to cope with a whole task instead of being independent.They need communication(known as <strong>IPC: inter-process communicaiton</strong>), which have two methods:</p>\n<ul>\n<li>share memory</li>\n<li>message passing</li>\n</ul>\n<p>The latter is used in the network/distributed system, we will leave it aside.The formmer defines a n-to-1 model, which we need to deal with the logic of the program - the execution order of threads happening at the same time.Thats when we need the memory model:</p>","more":"<h2 id=\"memory-model-vs-memory-layout\"><a href=\"#memory-model-vs-memory-layout\" class=\"headerlink\" title=\"memory model .vs. memory layout\"></a>memory model .vs. memory layout</h2><p>Notice that memory model is different from the notion of memory layout.<br>The memory layout defines when a program is running, how the parts of the process is laid in the memory. 2 examples:<br>C memory layout[7]<br><img src=\"/images/imgs/memoryLayoutC.jpg\" alt=\"C memory layout\"></p>\n<p>Java memory architecture[8]<br><img src=\"/images/imgs/javaMemArc.png\" alt=\"Jave mem arc\"></p>\n<h2 id=\"golang-memory\"><a href=\"#golang-memory\" class=\"headerlink\" title=\"golang memory:\"></a>golang memory:</h2><h3 id=\"atomic-operation\"><a href=\"#atomic-operation\" class=\"headerlink\" title=\"atomic operation\"></a>atomic operation</h3><ul>\n<li>a instruction cant be partitioned in mechine-level, which is the smallest element of a program.</li>\n<li>The atomic operation is low-level concepts, which means most statements we code in high-level language is not atomic.Dont take is for granted. eg: <code>a += 1</code> will be decomposed as <code>load a;a+1;store a</code></li>\n<li>a atomic operation is not a instantaneous operation, it lasts for a while. As a result, we can regard it as a operation with a start point and a end point, which need some time to complete. </li>\n</ul>\n<h3 id=\"happens-before\"><a href=\"#happens-before\" class=\"headerlink\" title=\"happens before\"></a>happens before</h3><blockquote>\n<p>happens before<br>a partial order on the execution of memory operations in a Go program, to specify the requirements of reads and writes, we define happens before, .<br> If event e1 happens before event e2, then we say that e2 happens after e1.<br>  Also, if e1 does not happen before e2 and does not happen after e2, then we say that e1 and e2 happen concurrently</p>\n</blockquote>\n<ul>\n<li><p>single goroutine<br><em>Within a single goroutine, the happens-before order is the order expressed by the program.</em></p>\n</li>\n<li><p>multi goroutine/concurrency</p>\n<blockquote>\n<p>memory visibility<br>A read r of a variable v is allowed to observe a write w to v if both of the following hold:</p>\n<ul>\n<li>r does not happen before w.</li>\n<li>There is no other write w to v that happens after w but before r.<br>To guarantee that a read r of a variable v observes a particular write w to v, ensure that w is the only write r is allowed to observe. That is, r is guaranteed to observe w if both of the following hold:</li>\n<li>w happens before r.</li>\n<li>Any other write to the shared variable v either happens before w or after r.<br>This pair of conditions is stronger than the first pair; it requires that there are no other writes happening concurrently with w or r.</li>\n</ul>\n</blockquote>\n<p><em>When multiple goroutines access a shared variable v, they must use synchronization events to establish happens-before conditions that ensure reads observe the desired writes.</em></p>\n</li>\n</ul>\n<p>2 point need notice:</p>\n<ul>\n<li>The initialization of variable v with the zero value for vs type behaves as a write in the memory model.</li>\n<li>Reads and writes of values larger than a single machine word behave as multiple machine-word-sized operations in an unspecified order.</li>\n</ul>\n<h3 id=\"synchronization\"><a href=\"#synchronization\" class=\"headerlink\" title=\"synchronization\"></a>synchronization</h3><h4 id=\"init\"><a href=\"#init\" class=\"headerlink\" title=\"init()\"></a><code>init()</code></h4><p><em>If a package p imports package q, the completion of qs init functions <strong>happens before</strong> the start of any of ps.</em></p>\n<h4 id=\"goroutine-creation\"><a href=\"#goroutine-creation\" class=\"headerlink\" title=\"goroutine creation\"></a>goroutine creation</h4><p><em>The <code>go</code> statement that starts a new goroutine <strong>happens before</strong> the goroutines execution begins.</em></p>\n<h4 id=\"goroutine-destruction\"><a href=\"#goroutine-destruction\" class=\"headerlink\" title=\"goroutine destruction\"></a>goroutine destruction</h4><p><em>The exit of a goroutine is not guaranteed to happen before any event in the program.</em></p>\n<h4 id=\"channel\"><a href=\"#channel\" class=\"headerlink\" title=\"channel\"></a>channel</h4><p>4 rules</p>\n<ul>\n<li><em>A send on a channel <strong>happens before</strong> the corresponding receive from that channel completes.</em></li>\n<li><em>The closing of a channel <strong>happens before</strong> a receive that returns a zero value because the channel is closed.</em></li>\n<li><em>A receive from an unbuffered channel <strong>happens before</strong> the send on that channel completes.</em></li>\n<li><em>The kth receive on a channel with capacity C <strong>happens before</strong> the k+Cth send from that channel completes.</em></li>\n</ul>\n<p>synced goroutine: <code>a = &quot;hello, world&quot;</code> - <code>&lt;-c</code>-<code>print(a)</code><br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> c = <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">10</span>)</span><br><span class=\"line\"><span class=\"keyword\">var</span> a <span class=\"keyword\">string</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">f</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ta = <span class=\"string\">\"hello, world\"</span></span><br><span class=\"line\">\tc &lt;- <span class=\"number\">0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> f()</span><br><span class=\"line\">\t&lt;-c</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(a)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>bufferd channel implements a semphone:<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> limit = <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, w := <span class=\"keyword\">range</span> work &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(w <span class=\"keyword\">func</span>()</span>)</span> &#123;</span><br><span class=\"line\">\t\t\tlimit &lt;- <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\tw()</span><br><span class=\"line\">\t\t\t&lt;-limit</span><br><span class=\"line\">\t\t&#125;(w)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">select</span>&#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"lock\"><a href=\"#lock\" class=\"headerlink\" title=\"lock\"></a>lock</h4><ul>\n<li><p><em>For any sync.Mutex or sync.RWMutex variable l and n &lt; m, call n of l.Unlock() <strong>happens before</strong> call m of l.Lock() returns.</em></p>\n</li>\n<li><p><em>For any call to l.RLock on a sync.RWMutex variable l, there is an n such that the l.RLock happens (returns) after call n to l.Unlock and the matching l.RUnlock <strong>happens before</strong> call n+1 to l.Lock.</em></p>\n</li>\n</ul>\n<h4 id=\"once\"><a href=\"#once\" class=\"headerlink\" title=\"once\"></a>once</h4><p><em>A single call of f() from once.Do(f) <strong>happens (returns) before</strong> any call of once.Do(f) returns.</em></p>\n<h3 id=\"incorrect-sync\"><a href=\"#incorrect-sync\" class=\"headerlink\" title=\"incorrect sync\"></a>incorrect sync</h3><p>All following error can be seen as incorrect implicit sync, dont take for granted. The solution is: <strong>explict synchronizaion</strong>.</p>\n<h4 id=\"Error1-2-goroutine-without-sync-has-no-happen-before-relation\"><a href=\"#Error1-2-goroutine-without-sync-has-no-happen-before-relation\" class=\"headerlink\" title=\"Error1: 2 goroutine without sync has no happen-before relation\"></a>Error1: 2 goroutine without sync has no happen-before relation</h4><p>the program may print 2 1 or 2 0<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> a, b <span class=\"keyword\">int</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">f</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ta = <span class=\"number\">1</span></span><br><span class=\"line\">\tb = <span class=\"number\">2</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">g</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(b)</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(a)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> f()</span><br><span class=\"line\">\tg()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"Error2-double-checking-locking-make-no-happens-before-relation\"><a href=\"#Error2-double-checking-locking-make-no-happens-before-relation\" class=\"headerlink\" title=\"Error2: double-checking locking make no happens before relation\"></a>Error2: double-checking locking make no happens before relation</h4><p>may print nothing<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> a <span class=\"keyword\">string</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> done <span class=\"keyword\">bool</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">setup</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ta = <span class=\"string\">\"hello, world\"</span></span><br><span class=\"line\">\tdone = <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">doprint</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !done &#123;</span><br><span class=\"line\">\t\tonce.Do(setup)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(a)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">twoprint</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> doprint()</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> doprint()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"Error3-waiting-for-a-value-make-no-happen-before-relation\"><a href=\"#Error3-waiting-for-a-value-make-no-happen-before-relation\" class=\"headerlink\" title=\"Error3: waiting for a value make no happen before relation\"></a>Error3: waiting for a value make no happen before relation</h4><p>may print nothing or infinite loop<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> a <span class=\"keyword\">string</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> done <span class=\"keyword\">bool</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">setup</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\ta = <span class=\"string\">\"hello, world\"</span></span><br><span class=\"line\">\tdone = <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> setup()</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> !done &#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(a)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Digression\"><a href=\"#Digression\" class=\"headerlink\" title=\"Digression\"></a>Digression</h2><p>Its in 1978 that 2 papers having a enourmous impact on concurrent/distributed system published. One is <strong>&lt; Time, clocks, and the ordering of events in a distributed system &gt;</strong> written by Leslie Lamport - father of Paxos and Latex, laying the foundation for analysis of dissys. Another is <strong>&lt; Communicating sequential processes&gt;</strong> by CAR Hoare - the creator of <code>quicksort</code>, CSP plays a huge role in concurrent system, which also is the theory idea behind goroutine and channel.What a year!</p>\n<h2 id=\"refer\"><a href=\"#refer\" class=\"headerlink\" title=\"refer\"></a>refer</h2><ul>\n<li>1.<a href=\"https://golang.org/ref/mem\" target=\"_blank\" rel=\"noopener\">golang : memory model</a></li>\n<li>2.<a href=\"https://studygolang.com/articles/01176\" target=\"_blank\" rel=\"noopener\">go</a></li>\n<li>3.<a href=\"https://en.wikipedia.org/wiki/Memory_barrier\" target=\"_blank\" rel=\"noopener\">wiki: memory barrier</a></li>\n<li>4.<a href=\"https://www.quora.com/What-is-a-memory-model-in-C\" target=\"_blank\" rel=\"noopener\">wiki: memory model</a></li>\n<li>5.<a href=\"https://www.quora.com/What-is-a-memory-model-in-C\" target=\"_blank\" rel=\"noopener\">quora: what is memory model in C</a></li>\n<li>6.<a href=\"https://www.cs.princeton.edu/courses/archive/fall10/cos597C/docs/memory-models.pdf\" target=\"_blank\" rel=\"noopener\">lec: memory model</a></li>\n<li>7.<a href=\"https://www.geeksforgeeks.org/memory-layout-of-c-program/\" target=\"_blank\" rel=\"noopener\">Memory Layout of C Programs</a></li>\n<li>8.<a href=\"https://hackthejava.wordpress.com/2015/01/09/memory-architecture-by-jvmruntime-data-areas/\" target=\"_blank\" rel=\"noopener\">Memory Architecture Of JVM(Runtime Data Areas)</a></li>\n</ul>"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"cjhutb3g90001s7ambo7063nd","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3gr000es7amtxfcis6t"},{"post_id":"cjhutb3g90001s7ambo7063nd","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3gs000gs7am9cegz9jy"},{"post_id":"cjhutb3gt000is7amr6ciwv2h","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3gz000ks7amfbkbrnze"},{"post_id":"cjhutb3gt000is7amr6ciwv2h","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3h2000ns7amumwxcn10"},{"post_id":"cjhutb3gg0003s7amg71wi1f9","tag_id":"cjhutb3gq000cs7amx2l008sj","_id":"cjhutb3h3000ps7amec8zgnzf"},{"post_id":"cjhutb3gg0003s7amg71wi1f9","tag_id":"cjhutb3gs000hs7amhgkravdh","_id":"cjhutb3h4000ss7ama2gtyz5z"},{"post_id":"cjhutb3gu000js7amu5khzr0d","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3h5000us7amhhbx8xwk"},{"post_id":"cjhutb3gu000js7amu5khzr0d","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3h7000xs7amdovcvo65"},{"post_id":"cjhutb3gz000ms7am464mi479","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3h8000zs7amuo6jn9xs"},{"post_id":"cjhutb3gz000ms7am464mi479","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3h90012s7amvpl2xql2"},{"post_id":"cjhutb3h2000os7amc7lrw3f3","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3ha0014s7ambjbieknd"},{"post_id":"cjhutb3h2000os7amc7lrw3f3","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3hc0017s7amrq0qasmd"},{"post_id":"cjhutb3h3000rs7am3x9tqhjv","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3hd0019s7amzgzivbmm"},{"post_id":"cjhutb3h3000rs7am3x9tqhjv","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3he001cs7am1e4enfch"},{"post_id":"cjhutb3gm0006s7amwot9aejt","tag_id":"cjhutb3gq000cs7amx2l008sj","_id":"cjhutb3hg001es7amxi480s83"},{"post_id":"cjhutb3gm0006s7amwot9aejt","tag_id":"cjhutb3gs000hs7amhgkravdh","_id":"cjhutb3hh001gs7amw4fuoep6"},{"post_id":"cjhutb3h4000ts7amx9wch5yh","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3hh001hs7amganpax7k"},{"post_id":"cjhutb3h4000ts7amx9wch5yh","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3hi001js7am0uxga047"},{"post_id":"cjhutb3h6000ws7am382q59wi","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3hi001ks7am0414bh0i"},{"post_id":"cjhutb3h6000ws7am382q59wi","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3hj001ms7amttncwa1a"},{"post_id":"cjhutb3h7000ys7am07701bt1","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3hj001ns7am4md2sogw"},{"post_id":"cjhutb3h7000ys7am07701bt1","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3hk001ps7amgqhcngvv"},{"post_id":"cjhutb3h80011s7amhin0rjbp","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3hk001qs7am3no082qp"},{"post_id":"cjhutb3h80011s7amhin0rjbp","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3hl001ss7am2iauw17n"},{"post_id":"cjhutb3gn0007s7ambw0cp1r4","tag_id":"cjhutb3gq000cs7amx2l008sj","_id":"cjhutb3hl001ts7am2hgfox3o"},{"post_id":"cjhutb3gn0007s7ambw0cp1r4","tag_id":"cjhutb3gs000hs7amhgkravdh","_id":"cjhutb3hm001vs7amxqe6g37k"},{"post_id":"cjhutb3h90013s7am0anh7dfu","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3hn001ws7am0y1aiija"},{"post_id":"cjhutb3h90013s7am0anh7dfu","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3hn001xs7amd1yoxqiv"},{"post_id":"cjhutb3ha0016s7am1il0xxat","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3ho001ys7amqyz50jo3"},{"post_id":"cjhutb3ha0016s7am1il0xxat","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3ho001zs7amqqvlik47"},{"post_id":"cjhutb3hc0018s7amhxbbmqn5","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3ho0020s7amn3he8rdr"},{"post_id":"cjhutb3hc0018s7amhxbbmqn5","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3ho0021s7amj5uxap61"},{"post_id":"cjhutb3go0008s7amscg7le0v","tag_id":"cjhutb3gq000cs7amx2l008sj","_id":"cjhutb3ho0022s7amtfqkvpy5"},{"post_id":"cjhutb3go0008s7amscg7le0v","tag_id":"cjhutb3gs000hs7amhgkravdh","_id":"cjhutb3hp0023s7amarmxyea3"},{"post_id":"cjhutb3he001ds7amyfupt465","tag_id":"cjhutb3go0009s7am6r0j1u3q","_id":"cjhutb3hp0024s7am1vkjrx1t"},{"post_id":"cjhutb3he001ds7amyfupt465","tag_id":"cjhutb3gk0005s7am0srhpzhx","_id":"cjhutb3hp0025s7am7dhyzhig"},{"post_id":"cjhutb3gp000bs7amd9ul8d0t","tag_id":"cjhutb3gq000cs7amx2l008sj","_id":"cjhutb3hp0027s7am4mutezaj"},{"post_id":"cjhutb3gp000bs7amd9ul8d0t","tag_id":"cjhutb3gs000hs7amhgkravdh","_id":"cjhutb3hq0028s7amkfahqzx5"},{"post_id":"cjhutb3gr000ds7amv35zy1ii","tag_id":"cjhutb3gq000cs7amx2l008sj","_id":"cjhutb3hq0029s7amrm2tw5zh"},{"post_id":"cjhutb3gr000ds7amv35zy1ii","tag_id":"cjhutb3gs000hs7amhgkravdh","_id":"cjhutb3hq002as7amvtso8ni6"},{"post_id":"cjhutb3gr000fs7amp3dn9ht0","tag_id":"cjhutb3hk001rs7am3rxv37cp","_id":"cjhutb3hr002bs7ammo8ou6ue"},{"post_id":"cjhutcwzw0000utam71opk03u","tag_id":"cjhutcx090001utamfvghk7ck","_id":"cjhutcx0e0002utam44wedffn"}],"Tag":[{"name":"os","_id":"cjhutb3gk0005s7am0srhpzhx"},{"name":"xv6","_id":"cjhutb3go0009s7am6r0j1u3q"},{"name":"algorithm","_id":"cjhutb3gq000cs7amx2l008sj"},{"name":"data_structure","_id":"cjhutb3gs000hs7amhgkravdh"},{"name":"-Linux","_id":"cjhutb3hg001fs7amzatug0h7"},{"name":"CS","_id":"cjhutb3hk001rs7am3rxv37cp"},{"name":"misc","_id":"cjhutb3hl001us7amep3hersv"},{"name":"go","_id":"cjhutcx090001utamfvghk7ck"}]}}